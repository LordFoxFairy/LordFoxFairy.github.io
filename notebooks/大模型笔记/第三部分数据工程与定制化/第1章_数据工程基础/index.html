<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第1章：数据炼金术 - 从垃圾到黄金的数据工程 (Data Alchemy for Fine-tuning)# “Garbage In, Garbage Out (GIGO)” - 这是数据科学的铁律
“Data is the new oil, but if you don’t refine it, you’re just burning crude.” - Andrew Ng
欢迎来到数据炼金术的世界!本章将带你从 Petabytes 的原始矿石 中提炼出 Kilobytes 的精华黄金。在微调阶段,数据质量比数量更重要 - 精心提纯的 10K 高质量数据集,往往比 100K 未经处理的"垃圾"更有效(如 Alpaca、Phi-3 的成功)。
我们将学习如何成为一名合格的"数据炼金术师",掌握 过滤、蒸馏、提纯 的核心技术,构建属于你自己的高质量微调数据集。
数据炼金术 Pipeline 全景图# 让我们先看看从原始数据到精炼数据集的完整旅程:
┌─────────────────────────────────────────────────────────────────────────┐ │ DATA ALCHEMY PIPELINE │ │ (数据炼金术流水线) │ └─────────────────────────────────────────────────────────────────────────┘ Petabytes Kilobytes (原始矿石) (精炼黄金) │ │ ├──> [1. 粗筛] ────────────────> Gigabytes │ │ · 去除明显垃圾 │ │ · 基础格式化 │ │ │ ├──> [2. 质量过滤] ────────────> Megabytes │ │ · 长度/完整性检查 │ │ · 毒性检测 │ │ · PII 脱敏 │ │ │ ├──> [3. 去重提纯] ────────────> Hundreds of KB │ │ · MinHash 去重 │ │ · 近似重复检测 │ │ ⚡ FLOPs 节省: 去重后训练成本 ↓ 3-5x! │ │ │ ├──> [4. 蒸馏升华] ────────────> Tens of KB │ │ · Self-Instruct (知识蒸馏) │ │ · Evol-Instruct (复杂度提升) │ │ · GPT-4 → 小模型的能力迁移 │ │ │ └──> [5. 最终提纯] ────────────> ✨ Pure Gold ✨ │ · 人工抽检 │ · A/B 测试验证 │ · 数据分布平衡 │ 输出: 10K-50K 条高纯度数据 → 足以训练一个强大的专属模型!核心逻辑:每一个阶段都在剔除"杂质",提升"纯度":
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第1章 数据工程基础"><meta property="og:description" content='第1章：数据炼金术 - 从垃圾到黄金的数据工程 (Data Alchemy for Fine-tuning)# “Garbage In, Garbage Out (GIGO)” - 这是数据科学的铁律
“Data is the new oil, but if you don’t refine it, you’re just burning crude.” - Andrew Ng
欢迎来到数据炼金术的世界!本章将带你从 Petabytes 的原始矿石 中提炼出 Kilobytes 的精华黄金。在微调阶段,数据质量比数量更重要 - 精心提纯的 10K 高质量数据集,往往比 100K 未经处理的"垃圾"更有效(如 Alpaca、Phi-3 的成功)。
我们将学习如何成为一名合格的"数据炼金术师",掌握 过滤、蒸馏、提纯 的核心技术,构建属于你自己的高质量微调数据集。
数据炼金术 Pipeline 全景图# 让我们先看看从原始数据到精炼数据集的完整旅程:
┌─────────────────────────────────────────────────────────────────────────┐ │ DATA ALCHEMY PIPELINE │ │ (数据炼金术流水线) │ └─────────────────────────────────────────────────────────────────────────┘ Petabytes Kilobytes (原始矿石) (精炼黄金) │ │ ├──> [1. 粗筛] ────────────────> Gigabytes │ │ · 去除明显垃圾 │ │ · 基础格式化 │ │ │ ├──> [2. 质量过滤] ────────────> Megabytes │ │ · 长度/完整性检查 │ │ · 毒性检测 │ │ · PII 脱敏 │ │ │ ├──> [3. 去重提纯] ────────────> Hundreds of KB │ │ · MinHash 去重 │ │ · 近似重复检测 │ │ ⚡ FLOPs 节省: 去重后训练成本 ↓ 3-5x! │ │ │ ├──> [4. 蒸馏升华] ────────────> Tens of KB │ │ · Self-Instruct (知识蒸馏) │ │ · Evol-Instruct (复杂度提升) │ │ · GPT-4 → 小模型的能力迁移 │ │ │ └──> [5. 最终提纯] ────────────> ✨ Pure Gold ✨ │ · 人工抽检 │ · A/B 测试验证 │ · 数据分布平衡 │ 输出: 10K-50K 条高纯度数据 → 足以训练一个强大的专属模型!核心逻辑:每一个阶段都在剔除"杂质",提升"纯度":'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第1章 数据工程基础"><meta itemprop=description content='第1章：数据炼金术 - 从垃圾到黄金的数据工程 (Data Alchemy for Fine-tuning)# “Garbage In, Garbage Out (GIGO)” - 这是数据科学的铁律
“Data is the new oil, but if you don’t refine it, you’re just burning crude.” - Andrew Ng
欢迎来到数据炼金术的世界!本章将带你从 Petabytes 的原始矿石 中提炼出 Kilobytes 的精华黄金。在微调阶段,数据质量比数量更重要 - 精心提纯的 10K 高质量数据集,往往比 100K 未经处理的"垃圾"更有效(如 Alpaca、Phi-3 的成功)。
我们将学习如何成为一名合格的"数据炼金术师",掌握 过滤、蒸馏、提纯 的核心技术,构建属于你自己的高质量微调数据集。
数据炼金术 Pipeline 全景图# 让我们先看看从原始数据到精炼数据集的完整旅程:
┌─────────────────────────────────────────────────────────────────────────┐ │ DATA ALCHEMY PIPELINE │ │ (数据炼金术流水线) │ └─────────────────────────────────────────────────────────────────────────┘ Petabytes Kilobytes (原始矿石) (精炼黄金) │ │ ├──> [1. 粗筛] ────────────────> Gigabytes │ │ · 去除明显垃圾 │ │ · 基础格式化 │ │ │ ├──> [2. 质量过滤] ────────────> Megabytes │ │ · 长度/完整性检查 │ │ · 毒性检测 │ │ · PII 脱敏 │ │ │ ├──> [3. 去重提纯] ────────────> Hundreds of KB │ │ · MinHash 去重 │ │ · 近似重复检测 │ │ ⚡ FLOPs 节省: 去重后训练成本 ↓ 3-5x! │ │ │ ├──> [4. 蒸馏升华] ────────────> Tens of KB │ │ · Self-Instruct (知识蒸馏) │ │ · Evol-Instruct (复杂度提升) │ │ · GPT-4 → 小模型的能力迁移 │ │ │ └──> [5. 最终提纯] ────────────> ✨ Pure Gold ✨ │ · 人工抽检 │ · A/B 测试验证 │ · 数据分布平衡 │ 输出: 10K-50K 条高纯度数据 → 足以训练一个强大的专属模型!核心逻辑:每一个阶段都在剔除"杂质",提升"纯度":'><meta itemprop=wordCount content="5264"><title>第1章 数据工程基础 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle checked>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle checked>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/ class=active>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第1章 数据工程基础</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#数据炼金术-pipeline-全景图>数据炼金术 Pipeline 全景图</a></li><li><a href=#本章前置说明微调数据-vs-预训练数据>本章前置说明：微调数据 vs 预训练数据</a></li><li><a href=#目录>目录</a></li><li><a href=#一data-centric-ai数据为王的时代>一、Data-Centric AI：数据为王的时代</a><ul><li><a href=#1-model-centric-vs-data-centric>1. Model-Centric vs Data-Centric</a></li><li><a href=#2-微调数据的三大要素>2. 微调数据的三大要素</a></li><li><a href=#3-数据质量的黄金定律>3. 数据质量的黄金定律</a></li></ul></li><li><a href=#二sft-数据格式详解>二、SFT 数据格式详解</a><ul><li><a href=#1-alpaca-格式指令式数据>1. Alpaca 格式：指令式数据</a></li><li><a href=#2-sharegpt-格式多轮对话数据>2. ShareGPT 格式：多轮对话数据</a></li><li><a href=#3-格式转换实战>3. 格式转换实战</a></li></ul></li><li><a href=#三self-instruct用-gpt-4-生成微调数据>三、Self-Instruct：用 GPT-4 生成微调数据</a><ul><li><a href=#1-self-instruct-原理知识蒸馏的艺术>1. Self-Instruct 原理：知识蒸馏的艺术</a></li><li><a href=#2-代码实战生成高质量指令数据>2. 代码实战：生成高质量指令数据</a></li><li><a href=#3-evol-instruct让指令进化>3. Evol-Instruct：让指令进化</a></li><li><a href=#4-代码实战指令复杂度提升>4. 代码实战：指令复杂度提升</a></li></ul></li><li><a href=#四数据清洗与质量过滤>四、数据清洗与质量过滤</a><ul><li><a href=#1-基于规则的质量过滤>1. 基于规则的质量过滤</a></li><li><a href=#2-毒性检测>2. 毒性检测</a></li><li><a href=#3-pii-识别与脱敏>3. PII 识别与脱敏</a></li><li><a href=#4-代码实战完整的质量过滤器>4. 代码实战：完整的质量过滤器</a></li><li><a href=#5-合成数据实战使用-llm-生成指令>5. 合成数据实战：使用 LLM 生成指令</a><ul><li><a href=#51-为什么选择合成数据>5.1 为什么选择合成数据？</a></li><li><a href=#52-完整的合成数据生成流程>5.2 完整的合成数据生成流程</a></li><li><a href=#53-成本估算与优化>5.3 成本估算与优化</a></li><li><a href=#54-实战建议>5.4 实战建议</a></li></ul></li></ul></li><li><a href=#五小规模数据去重>五、小规模数据去重</a><ul><li><a href=#1-为什么微调数据需要去重scalability-的关键>1. 为什么微调数据需要去重：Scalability 的关键</a></li><li><a href=#2-minhash-去重原理文档指纹识别技术>2. MinHash 去重原理：文档"指纹识别"技术</a></li><li><a href=#3-代码实战minhash-简单实现>3. 代码实战：MinHash 简单实现</a></li></ul></li><li><a href=#六数据增强技术>六、数据增强技术</a><ul><li><a href=#1-回译back-translation>1. 回译（Back-translation）</a></li><li><a href=#2-同义词替换>2. 同义词替换</a></li><li><a href=#3-代码实战数据增强工具>3. 代码实战：数据增强工具</a></li></ul></li><li><a href=#七sft-数据集构建实战>七、SFT 数据集构建实战</a><ul><li><a href=#1-完整-pipeline从原始文本到-alpaca-格式>1. 完整 Pipeline：从原始文本到 Alpaca 格式</a></li><li><a href=#2-代码实战端到端数据构建>2. 代码实战：端到端数据构建</a></li></ul></li><li><a href=#八特定任务的数据构造实战>八、特定任务的数据构造实战</a><ul><li><a href=#1-案例一情感分析-classification>1. 案例一：情感分析 (Classification)</a></li><li><a href=#2-案例二代码生成-coding>2. 案例二：代码生成 (Coding)</a></li><li><a href=#3-案例三数学推理-mathcot>3. 案例三：数学推理 (Math/CoT)</a></li></ul></li><li><a href=#九本章小结>九、本章小结</a></li><li><a href=#参考资源>参考资源</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第1章数据炼金术---从垃圾到黄金的数据工程-data-alchemy-for-fine-tuning>第1章：数据炼金术 - 从垃圾到黄金的数据工程 (Data Alchemy for Fine-tuning)<a class=anchor href=#%e7%ac%ac1%e7%ab%a0%e6%95%b0%e6%8d%ae%e7%82%bc%e9%87%91%e6%9c%af---%e4%bb%8e%e5%9e%83%e5%9c%be%e5%88%b0%e9%bb%84%e9%87%91%e7%9a%84%e6%95%b0%e6%8d%ae%e5%b7%a5%e7%a8%8b-data-alchemy-for-fine-tuning>#</a></h1><blockquote class=book-hint><p><strong>&ldquo;Garbage In, Garbage Out (GIGO)&rdquo; - 这是数据科学的铁律</strong></p><p>&ldquo;Data is the new oil, but if you don&rsquo;t refine it, you&rsquo;re just burning crude.&rdquo; - Andrew Ng</p><p>欢迎来到数据炼金术的世界!本章将带你从 <strong>Petabytes 的原始矿石</strong> 中提炼出 <strong>Kilobytes 的精华黄金</strong>。在微调阶段,数据质量比数量更重要 - 精心提纯的 10K 高质量数据集,往往比 100K 未经处理的"垃圾"更有效(如 Alpaca、Phi-3 的成功)。</p><p>我们将学习如何成为一名合格的"数据炼金术师",掌握 <strong>过滤、蒸馏、提纯</strong> 的核心技术,构建属于你自己的高质量微调数据集。</p></blockquote><h2 id=数据炼金术-pipeline-全景图>数据炼金术 Pipeline 全景图<a class=anchor href=#%e6%95%b0%e6%8d%ae%e7%82%bc%e9%87%91%e6%9c%af-pipeline-%e5%85%a8%e6%99%af%e5%9b%be>#</a></h2><p>让我们先看看从原始数据到精炼数据集的完整旅程:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                   DATA ALCHEMY PIPELINE                                 │
</span></span><span class=line><span class=cl>│                   (数据炼金术流水线)                                      │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   Petabytes                                              Kilobytes
</span></span><span class=line><span class=cl>   (原始矿石)                                              (精炼黄金)
</span></span><span class=line><span class=cl>       │                                                       │
</span></span><span class=line><span class=cl>       ├──&gt; [1. 粗筛] ────────────────&gt; Gigabytes            │
</span></span><span class=line><span class=cl>       │    · 去除明显垃圾                                    │
</span></span><span class=line><span class=cl>       │    · 基础格式化                                      │
</span></span><span class=line><span class=cl>       │                                                       │
</span></span><span class=line><span class=cl>       ├──&gt; [2. 质量过滤] ────────────&gt; Megabytes            │
</span></span><span class=line><span class=cl>       │    · 长度/完整性检查                                 │
</span></span><span class=line><span class=cl>       │    · 毒性检测                                        │
</span></span><span class=line><span class=cl>       │    · PII 脱敏                                        │
</span></span><span class=line><span class=cl>       │                                                       │
</span></span><span class=line><span class=cl>       ├──&gt; [3. 去重提纯] ────────────&gt; Hundreds of KB       │
</span></span><span class=line><span class=cl>       │    · MinHash 去重                                    │
</span></span><span class=line><span class=cl>       │    · 近似重复检测                                    │
</span></span><span class=line><span class=cl>       │    ⚡ FLOPs 节省: 去重后训练成本 ↓ 3-5x!            │
</span></span><span class=line><span class=cl>       │                                                       │
</span></span><span class=line><span class=cl>       ├──&gt; [4. 蒸馏升华] ────────────&gt; Tens of KB           │
</span></span><span class=line><span class=cl>       │    · Self-Instruct (知识蒸馏)                       │
</span></span><span class=line><span class=cl>       │    · Evol-Instruct (复杂度提升)                     │
</span></span><span class=line><span class=cl>       │    · GPT-4 → 小模型的能力迁移                       │
</span></span><span class=line><span class=cl>       │                                                       │
</span></span><span class=line><span class=cl>       └──&gt; [5. 最终提纯] ────────────&gt; ✨ Pure Gold ✨      │
</span></span><span class=line><span class=cl>            · 人工抽检                                         │
</span></span><span class=line><span class=cl>            · A/B 测试验证                                    │
</span></span><span class=line><span class=cl>            · 数据分布平衡                                    │
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>输出: 10K-50K 条高纯度数据 → 足以训练一个强大的专属模型!</span></span></code></pre></div><p><strong>核心逻辑</strong>:每一个阶段都在剔除"杂质",提升"纯度":</p><ul><li><strong>粗筛</strong>: 去除不可用数据 (格式错误、乱码)</li><li><strong>质量过滤</strong>: 去除低质量数据 (太短、有毒、不完整)</li><li><strong>去重</strong>: 去除冗余数据 (完全重复、高度相似)</li><li><strong>蒸馏</strong>: 从大模型提取知识 (GPT-4 的智慧 → 你的模型)</li><li><strong>提纯</strong>: 最终质检 (人工审核 + 数据平衡)</li></ul><hr><h2 id=本章前置说明微调数据-vs-预训练数据>本章前置说明：微调数据 vs 预训练数据<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%89%8d%e7%bd%ae%e8%af%b4%e6%98%8e%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae-vs-%e9%a2%84%e8%ae%ad%e7%bb%83%e6%95%b0%e6%8d%ae>#</a></h2><p>本章聚焦**微调阶段（SFT）<strong>的数据工程，它与</strong>预训练阶段（Pretraining）**有本质区别。如果不清楚两者的定位，很容易混淆处理方法。</p><table><thead><tr><th style=text-align:left>维度</th><th style=text-align:left>预训练数据（详见 Part 2 第3章）</th><th style=text-align:left>微调数据（本章重点）</th></tr></thead><tbody><tr><td style=text-align:left><strong>数据量级</strong></td><td style=text-align:left><strong>PB级</strong> (Trillions of tokens)</td><td style=text-align:left><strong>MB级</strong> (10K - 100K samples)</td></tr><tr><td style=text-align:left><strong>数据来源</strong></td><td style=text-align:left>网页爬取 (CommonCrawl)、书籍、代码</td><td style=text-align:left><strong>合成数据 (Self-Instruct)</strong>、人工标注</td></tr><tr><td style=text-align:left><strong>核心目标</strong></td><td style=text-align:left>注入<strong>世界知识</strong>和语言能力</td><td style=text-align:left>注入<strong>指令遵循能力</strong>和特定任务技能</td></tr><tr><td style=text-align:left><strong>清洗重点</strong></td><td style=text-align:left>大规模去重、过滤垃圾广告</td><td style=text-align:left><strong>极高精度的去噪</strong>、风格统一、逻辑校验</td></tr><tr><td style=text-align:left><strong>容错率</strong></td><td style=text-align:left>可容忍 5-10% 的噪声</td><td style=text-align:left><strong>零容忍</strong>，一条错误数据可能毁掉微调效果</td></tr></tbody></table><blockquote class=book-hint><p><strong>关键提醒</strong>：如果您主要关心如何清洗海量的预训练语料（如训练一个基座模型），请移步 [第二部分第3章：预训练的奥秘]。本章的方法专门为 <strong>构建高质量指令微调数据集</strong> 设计。</p></blockquote><hr><h2 id=目录>目录<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><ul><li><a href=#%e4%b8%80data-centric-ai%e6%95%b0%e6%8d%ae%e4%b8%ba%e7%8e%8b%e7%9a%84%e6%97%b6%e4%bb%a3>一、Data-Centric AI：数据为王的时代</a><ul><li><a href=#1-model-centric-vs-data-centric>1. Model-Centric vs Data-Centric</a></li><li><a href=#2-%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae%e7%9a%84%e4%b8%89%e5%a4%a7%e8%a6%81%e7%b4%a0>2. 微调数据的三大要素</a></li><li><a href=#3-%e6%95%b0%e6%8d%ae%e8%b4%a8%e9%87%8f%e7%9a%84%e9%bb%84%e9%87%91%e5%ae%9a%e5%be%8b>3. 数据质量的黄金定律</a></li></ul></li><li><a href=#%e4%ba%8csft-%e6%95%b0%e6%8d%ae%e6%a0%bc%e5%bc%8f%e8%af%a6%e8%a7%a3>二、SFT 数据格式详解</a><ul><li><a href=#1-alpaca-%e6%a0%bc%e5%bc%8f%e6%8c%87%e4%bb%a4%e5%bc%8f%e6%95%b0%e6%8d%ae>1. Alpaca 格式：指令式数据</a></li><li><a href=#2-sharegpt-%e6%a0%bc%e5%bc%8f%e5%a4%9a%e8%bd%ae%e5%af%b9%e8%af%9d%e6%95%b0%e6%8d%ae>2. ShareGPT 格式：多轮对话数据</a></li><li><a href=#3-%e6%a0%bc%e5%bc%8f%e8%bd%ac%e6%8d%a2%e5%ae%9e%e6%88%98>3. 格式转换实战</a></li></ul></li><li><a href=#%e4%b8%89self-instruct%e7%94%a8-gpt-4-%e7%94%9f%e6%88%90%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae>三、Self-Instruct：用 GPT-4 生成微调数据</a><ul><li><a href=#1-self-instruct-%e5%8e%9f%e7%90%86>1. Self-Instruct 原理</a></li><li><a href=#2-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e7%94%9f%e6%88%90%e9%ab%98%e8%b4%a8%e9%87%8f%e6%8c%87%e4%bb%a4%e6%95%b0%e6%8d%ae>2. 代码实战：生成高质量指令数据</a></li><li><a href=#3-evol-instruct%e8%ae%a9%e6%8c%87%e4%bb%a4%e8%bf%9b%e5%8c%96>3. Evol-Instruct：让指令进化</a></li><li><a href=#4-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e6%8c%87%e4%bb%a4%e5%a4%8d%e6%9d%82%e5%ba%a6%e6%8f%90%e5%8d%87>4. 代码实战：指令复杂度提升</a></li></ul></li><li><a href=#%e5%9b%9b%e6%95%b0%e6%8d%ae%e6%b8%85%e6%b4%97%e4%b8%8e%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4>四、数据清洗与质量过滤</a><ul><li><a href=#1-%e5%9f%ba%e4%ba%8e%e8%a7%84%e5%88%99%e7%9a%84%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4>1. 基于规则的质量过滤</a></li><li><a href=#2-%e6%af%92%e6%80%a7%e6%a3%80%e6%b5%8b>2. 毒性检测</a></li><li><a href=#3-pii-%e8%af%86%e5%88%ab%e4%b8%8e%e8%84%b1%e6%95%8f>3. PII 识别与脱敏</a></li><li><a href=#4-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e5%ae%8c%e6%95%b4%e7%9a%84%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4%e5%99%a8>4. 代码实战：完整的质量过滤器</a></li><li><a href=#5-%e5%90%88%e6%88%90%e6%95%b0%e6%8d%ae%e5%ae%9e%e6%88%98%e4%bd%bf%e7%94%a8-llm-%e7%94%9f%e6%88%90%e6%8c%87%e4%bb%a4>5. 合成数据实战：使用 LLM 生成指令</a></li></ul></li><li><a href=#%e4%ba%94%e5%b0%8f%e8%a7%84%e6%a8%a1%e6%95%b0%e6%8d%ae%e5%8e%bb%e9%87%8d>五、小规模数据去重</a><ul><li><a href=#1-%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae%e9%9c%80%e8%a6%81%e5%8e%bb%e9%87%8d>1. 为什么微调数据需要去重</a></li><li><a href=#2-minhash-%e5%8e%bb%e9%87%8d%e5%8e%9f%e7%90%86>2. MinHash 去重原理</a></li><li><a href=#3-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98minhash-%e7%ae%80%e5%8d%95%e5%ae%9e%e7%8e%b0>3. 代码实战：MinHash 简单实现</a></li></ul></li><li><a href=#%e5%85%ad%e6%95%b0%e6%8d%ae%e5%a2%9e%e5%bc%ba%e6%8a%80%e6%9c%af>六、数据增强技术</a><ul><li><a href=#1-%e5%9b%9e%e8%af%91back-translation>1. 回译（Back-translation）</a></li><li><a href=#2-%e5%90%8c%e4%b9%89%e8%af%8d%e6%9b%bf%e6%8d%a2>2. 同义词替换</a></li><li><a href=#3-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e6%95%b0%e6%8d%ae%e5%a2%9e%e5%bc%ba%e5%b7%a5%e5%85%b7>3. 代码实战：数据增强工具</a></li></ul></li><li><a href=#%e4%b8%83sft-%e6%95%b0%e6%8d%ae%e9%9b%86%e6%9e%84%e5%bb%ba%e5%ae%9e%e6%88%98>七、SFT 数据集构建实战</a><ul><li><a href=#1-%e5%ae%8c%e6%95%b4-pipeline%e4%bb%8e%e5%8e%9f%e5%a7%8b%e6%96%87%e6%9c%ac%e5%88%b0-alpaca-%e6%a0%bc%e5%bc%8f>1. 完整 Pipeline：从原始文本到 Alpaca 格式</a></li><li><a href=#2-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e7%ab%af%e5%88%b0%e7%ab%af%e6%95%b0%e6%8d%ae%e6%9e%84%e5%bb%ba>2. 代码实战：端到端数据构建</a></li></ul></li><li><a href=#%e5%85%ab%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>八、本章小结</a></li><li><a href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>参考资源</a></li></ul><hr><h2 id=一data-centric-ai数据为王的时代>一、Data-Centric AI：数据为王的时代<a class=anchor href=#%e4%b8%80data-centric-ai%e6%95%b0%e6%8d%ae%e4%b8%ba%e7%8e%8b%e7%9a%84%e6%97%b6%e4%bb%a3>#</a></h2><h3 id=1-model-centric-vs-data-centric>1. Model-Centric vs Data-Centric<a class=anchor href=#1-model-centric-vs-data-centric>#</a></h3><p><strong>传统 Model-Centric AI</strong>（以模型为中心）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>固定数据集 → 不断改进模型架构 → 追求更高性能</span></span></code></pre></div><p><strong>Data-Centric AI</strong>（以数据为中心）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>固定模型架构 → 不断改进数据质量 → 追求更高性能</span></span></code></pre></div><p><strong>Andrew Ng 的实验</strong>：在制造业缺陷检测任务中，通过优化数据标注（而非改进模型），准确率从 76% 提升到 93%。</p><p><strong>在 LLM 微调中的体现</strong>：</p><ul><li>Phi-3-mini (3.8B)：使用 3.3T tokens 的高质量"教科书式"数据，性能超越 Llama-2-13B</li><li>Alpaca (7B)：仅用 52K 条 GPT-3.5-turbo 生成的数据，达到接近 GPT-3.5 的指令遵循能力</li><li>WizardLM：通过 Evol-Instruct 提升数据复杂度，7B 模型超越 GPT-3.5 在部分任务</li></ul><h3 id=2-微调数据的三大要素>2. 微调数据的三大要素<a class=anchor href=#2-%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae%e7%9a%84%e4%b8%89%e5%a4%a7%e8%a6%81%e7%b4%a0>#</a></h3><p><strong>直觉理解</strong>：微调数据就像给模型定制的"教科书"，需要满足三个核心要素。</p><p>$$
\text{Effective SFT Data} = f(\text{Quality}, \text{Diversity}, \text{Complexity})
$$</p><p><strong>1. 质量（Quality）</strong></p><ul><li><strong>准确性</strong>：答案必须正确，错误数据会导致模型"学坏"</li><li><strong>流畅性</strong>：语言自然、逻辑清晰</li><li><strong>完整性</strong>：回答需要完整解决问题</li></ul><p><strong>2. 多样性（Diversity）</strong></p><ul><li><strong>任务多样性</strong>：覆盖问答、摘要、推理、代码、翻译等不同任务</li><li><strong>领域多样性</strong>：科技、文学、历史、医疗等不同领域</li><li><strong>风格多样性</strong>：正式、随意、技术、科普等不同风格</li></ul><p><strong>3. 复杂度（Complexity）</strong></p><ul><li><strong>简单任务</strong>：单步推理，直接检索知识</li><li><strong>中等任务</strong>：多步推理，需要综合信息</li><li><strong>复杂任务</strong>：深度推理、创造性思考、代码调试</li></ul><p><strong>数据配比建议</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>简单任务 : 中等任务 : 复杂任务 = 3 : 5 : 2</span></span></code></pre></div><h3 id=3-数据质量的黄金定律>3. 数据质量的黄金定律<a class=anchor href=#3-%e6%95%b0%e6%8d%ae%e8%b4%a8%e9%87%8f%e7%9a%84%e9%bb%84%e9%87%91%e5%ae%9a%e5%be%8b>#</a></h3><p><strong>定律 1：少而精 > 多而杂</strong></p><ul><li>10K 高质量数据 > 100K 低质量数据</li><li>Alpaca 用 52K 数据达到 text-davinci-003 的 90% 能力</li></ul><p><strong>定律 2：复杂度阶梯</strong></p><ul><li>数据应该包含不同难度层级，让模型逐步提升能力</li><li>WizardLM 的 Evol-Instruct 通过多轮进化提升指令复杂度</li></ul><p><strong>定律 3：负样本清除</strong></p><ul><li>一条有毒/错误的数据会毁掉 100 条正确数据的效果</li><li>必须严格过滤低质量、有害、错误的数据</li></ul><p><strong>定律 4：分布平衡</strong></p><ul><li>避免某一类任务占比过高（如 70% 都是问答）</li><li>使用 topic modeling 或聚类分析数据分布</li></ul><hr><h2 id=二sft-数据格式详解>二、SFT 数据格式详解<a class=anchor href=#%e4%ba%8csft-%e6%95%b0%e6%8d%ae%e6%a0%bc%e5%bc%8f%e8%af%a6%e8%a7%a3>#</a></h2><h3 id=1-alpaca-格式指令式数据>1. Alpaca 格式：指令式数据<a class=anchor href=#1-alpaca-%e6%a0%bc%e5%bc%8f%e6%8c%87%e4%bb%a4%e5%bc%8f%e6%95%b0%e6%8d%ae>#</a></h3><p><strong>Alpaca 格式</strong>是 Stanford 提出的标准指令数据格式，包含三个字段：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;指令描述（必填）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;额外输入（可选）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;期望输出（必填）&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>字段说明</strong>：</p><ul><li><strong>instruction</strong>：告诉模型要做什么（如"总结下面的文章"）</li><li><strong>input</strong>：提供上下文信息（如具体的文章内容）</li><li><strong>output</strong>：标准答案（模型应该生成的内容）</li></ul><p><strong>示例 1：无 input 的任务</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是量子计算&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;量子计算是利用量子力学原理（如叠加态和纠缠）进行计算的技术。与传统计算机使用比特不同，量子计算机使用量子比特（qubit），能够在特定问题上实现指数级加速，如密码破解和药物设计。&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>示例 2：有 input 的任务</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;将下面的句子翻译成法语&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;The weather is beautiful today.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Le temps est magnifique aujourd&#39;hui.&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>模型实际看到的格式</strong>（训练时拼接）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>### Instruction:
</span></span><span class=line><span class=cl>将下面的句子翻译成法语
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>### Input:
</span></span><span class=line><span class=cl>The weather is beautiful today.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>### Response:
</span></span><span class=line><span class=cl>Le temps est magnifique aujourd&#39;hui.</span></span></code></pre></div><h3 id=2-sharegpt-格式多轮对话数据>2. ShareGPT 格式：多轮对话数据<a class=anchor href=#2-sharegpt-%e6%a0%bc%e5%bc%8f%e5%a4%9a%e8%bd%ae%e5%af%b9%e8%af%9d%e6%95%b0%e6%8d%ae>#</a></h3><p><strong>ShareGPT 格式</strong>用于存储多轮对话，适合训练聊天机器人。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;conversations&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span> <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;用户消息1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span> <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;助手回复1&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span> <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;用户消息2&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span> <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;助手回复2&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;conversations&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是机器学习？&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;机器学习是人工智能的一个分支，通过算法让计算机从数据中学习规律，而无需明确编程。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;能举个例子吗？&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;当然。比如垃圾邮件过滤：系统通过学习大量垃圾邮件和正常邮件的特征，自动识别新邮件是否为垃圾邮件。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>训练时的处理</strong>：</p><ul><li>只计算 <code>gpt</code> 角色的 loss（不计算 <code>human</code> 的 loss）</li><li>使用特殊 token 分隔多轮对话（如 <code>&lt;|im_start|></code>, <code>&lt;|im_end|></code>）</li></ul><h3 id=3-格式转换实战>3. 格式转换实战<a class=anchor href=#3-%e6%a0%bc%e5%bc%8f%e8%bd%ac%e6%8d%a2%e5%ae%9e%e6%88%98>#</a></h3><p><strong>场景</strong>：将 ShareGPT 格式转换为 Alpaca 格式</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>数据格式转换工具
</span></span></span><span class=line><span class=cl><span class=s2>功能：ShareGPT -&gt; Alpaca 格式转换
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sharegpt_to_alpaca</span><span class=p>(</span><span class=n>sharegpt_data</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    将 ShareGPT 格式转换为 Alpaca 格式
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参数：
</span></span></span><span class=line><span class=cl><span class=s2>        sharegpt_data: ShareGPT 格式数据
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    返回：
</span></span></span><span class=line><span class=cl><span class=s2>        List[Dict]: Alpaca 格式数据列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conversations</span> <span class=o>=</span> <span class=n>sharegpt_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;conversations&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=n>alpaca_samples</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 遍历对话，每个 human-gpt 对转换为一条 Alpaca 数据</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>conversations</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>conversations</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s2>&#34;from&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;human&#34;</span> <span class=ow>and</span>
</span></span><span class=line><span class=cl>            <span class=n>conversations</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=s2>&#34;from&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;gpt&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>alpaca_sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=n>conversations</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s2>&#34;value&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>conversations</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>][</span><span class=s2>&#34;value&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>alpaca_samples</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>alpaca_sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>alpaca_samples</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>sharegpt_example</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;conversations&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是 Transformer？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;Transformer 是一种基于注意力机制的神经网络架构...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;human&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;它有什么优势？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;from&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt&#34;</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=s2>&#34;主要优势包括：1) 并行计算能力强 2) 能捕获长距离依赖...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alpaca_data</span> <span class=o>=</span> <span class=n>sharegpt_to_alpaca</span><span class=p>(</span><span class=n>sharegpt_example</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>alpaca_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span></span></span></code></pre></div><p><strong>输出</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是 Transformer？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;Transformer 是一种基于注意力机制的神经网络架构...&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;它有什么优势？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;主要优势包括：1) 并行计算能力强 2) 能捕获长距离依赖...&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><hr><h2 id=三self-instruct用-gpt-4-生成微调数据>三、Self-Instruct：用 GPT-4 生成微调数据<a class=anchor href=#%e4%b8%89self-instruct%e7%94%a8-gpt-4-%e7%94%9f%e6%88%90%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae>#</a></h2><h3 id=1-self-instruct-原理知识蒸馏的艺术>1. Self-Instruct 原理：知识蒸馏的艺术<a class=anchor href=#1-self-instruct-%e5%8e%9f%e7%90%86%e7%9f%a5%e8%af%86%e8%92%b8%e9%a6%8f%e7%9a%84%e8%89%ba%e6%9c%af>#</a></h3><p><strong>核心思想</strong>：利用强大的 LLM（如 GPT-4）生成指令-回答对，训练较弱的模型。这是 <strong>Alpaca</strong> 的核心技术。</p><p><strong>本质上，Self-Instruct 是一种"知识蒸馏"(Knowledge Distillation)过程</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              KNOWLEDGE DISTILLATION PIPELINE                    │
</span></span><span class=line><span class=cl>│                     (知识蒸馏流水线)                              │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    Teacher Model                         Student Model
</span></span><span class=line><span class=cl>    (GPT-4, 1.7T)                        (Your Model, 7B)
</span></span><span class=line><span class=cl>         │                                      │
</span></span><span class=line><span class=cl>         │  [能力:强大但昂贵]                    │  [目标:高效且专属]
</span></span><span class=line><span class=cl>         │                                      │
</span></span><span class=line><span class=cl>         ├──&gt; 生成高质量                         │
</span></span><span class=line><span class=cl>         │    指令-回答对                         │
</span></span><span class=line><span class=cl>         │    (蒸馏过程)                         │
</span></span><span class=line><span class=cl>         │         │                             │
</span></span><span class=line><span class=cl>         │         ├────────────────────&gt; [迁移知识]
</span></span><span class=line><span class=cl>         │         │                             │
</span></span><span class=line><span class=cl>         │         └────&gt; 52K 精华样本 ──────&gt; [SFT训练]
</span></span><span class=line><span class=cl>         │                                      │
</span></span><span class=line><span class=cl>         │                                      ↓
</span></span><span class=line><span class=cl>         │                           Student 获得 Teacher 的
</span></span><span class=line><span class=cl>         │                           90% 能力，但只有 0.4% 的大小!
</span></span><span class=line><span class=cl>         │
</span></span><span class=line><span class=cl>         └──&gt; 成本对比:
</span></span><span class=line><span class=cl>              推理成本: GPT-4 ($0.03/1K tokens) 
</span></span><span class=line><span class=cl>              vs 自托管 7B ($0.0001/1K tokens)
</span></span><span class=line><span class=cl>              = 300x 节省!</span></span></code></pre></div><p><strong>为什么称之为"蒸馏"?</strong></p><ul><li><strong>Teacher 模型</strong>(GPT-4)就像"原液"，浓缩了海量知识</li><li><strong>Distillation</strong>(蒸馏)过程提取精华，去除冗余</li><li><strong>Student 模型</strong>得到"蒸馏液"，保留核心能力但更轻量</li></ul><p><strong>蒸馏的三大优势</strong>:</p><ol><li><strong>成本降低</strong>: 推理成本降低 100-300倍</li><li><strong>速度提升</strong>: 小模型推理速度快 10-50倍</li><li><strong>可控性强</strong>: 可以针对特定领域定制</li></ol><p><strong>流程</strong>：</p><p>$$
\begin{aligned}
&\text{1. 种子池} \quad S = {\text{seed}<em>1, \ldots, \text{seed}<em>n} \
&\text{2. 生成指令} \quad I</em>{\text{new}} = \text{LLM}(S</em>{\text{sample}}) \
&\text{3. 生成回答} \quad O_{\text{new}} = \text{LLM}(I_{\text{new}}) \
&\text{4. 质量过滤} \quad \text{if } Q(I_{\text{new}}, O_{\text{new}}) > \theta \text{ then Keep} \
&\text{5. 加入种子池} \quad S \leftarrow S \cup {I_{\text{new}}}
\end{aligned}
$$</p><p><strong>关键步骤详解</strong>：</p><p><strong>Step 1：种子池构建</strong></p><ul><li>人工编写 175 条高质量指令（覆盖不同任务类型）</li><li>包含：问答、推理、创作、摘要、翻译、代码等</li></ul><p><strong>Step 2：指令生成</strong></p><ul><li>从种子池随机采样 6-8 条指令</li><li>让 LLM 生成与种子相似但不重复的新指令</li></ul><p><strong>Step 3：回答生成</strong></p><ul><li>使用 GPT-4 生成高质量回答</li><li>使用 Input-first 或 Output-first 策略</li></ul><p><strong>Step 4：质量过滤</strong></p><ul><li>检查指令是否与种子池过于相似（去重）</li><li>检查回答是否完整、正确</li><li>过滤有害、低质量的数据</li></ul><h3 id=2-代码实战生成高质量指令数据>2. 代码实战：生成高质量指令数据<a class=anchor href=#2-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e7%94%9f%e6%88%90%e9%ab%98%e8%b4%a8%e9%87%8f%e6%8c%87%e4%bb%a4%e6%95%b0%e6%8d%ae>#</a></h3><p><strong>完整的 Self-Instruct 实现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Self-Instruct 数据生成器
</span></span></span><span class=line><span class=cl><span class=s2>功能：使用 GPT-4 生成高质量的 SFT 数据
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install openai
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SelfInstructGenerator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化生成器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load_seed_tasks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>seed_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载种子任务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>seed_file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_instruction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_samples</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>6</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成新指令
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            num_samples: 从种子池采样的数量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            新生成的指令
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 随机采样种子任务</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>        <span class=n>sampled</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>num_samples</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构造 prompt</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are an AI assistant specialized in creating diverse instructions for training language models.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Below are some example instructions:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>task</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>sampled</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>prompt</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>task</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>+=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Generate a NEW instruction that is different from the examples above. The instruction should:
</span></span></span><span class=line><span class=cl><span class=s2>1. Be clear and specific
</span></span></span><span class=line><span class=cl><span class=s2>2. Cover a different task type or domain
</span></span></span><span class=line><span class=cl><span class=s2>3. Be solvable by a language model
</span></span></span><span class=line><span class=cl><span class=s2>4. Not require visual input or real-time information
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>New Instruction:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用 GPT-4 生成</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>new_instruction</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new_instruction</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>input_text</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        为指令生成回答
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            instruction: 指令
</span></span></span><span class=line><span class=cl><span class=s2>            input_text: 额外输入（可选）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            生成的回答
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>input_text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>instruction</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Input: </span><span class=si>{</span><span class=n>input_text</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Response:&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>instruction</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Response:&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1000</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_similar</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>new_instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.7</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检查新指令是否与种子池过于相似（简单版本）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        实际应该使用 Embedding 计算相似度
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>new_words</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>new_instruction</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>seed</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>seed_words</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>seed</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=c1># Jaccard 相似度</span>
</span></span><span class=line><span class=cl>            <span class=n>intersection</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>new_words</span> <span class=o>&amp;</span> <span class=n>seed_words</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>union</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>new_words</span> <span class=o>|</span> <span class=n>seed_words</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>similarity</span> <span class=o>=</span> <span class=n>intersection</span> <span class=o>/</span> <span class=n>union</span> <span class=k>if</span> <span class=n>union</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>similarity</span> <span class=o>&gt;</span> <span class=n>threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_samples</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>output_file</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;sft_data.jsonl&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        生成完整的 SFT 数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            num_samples: 生成数据条数
</span></span></span><span class=line><span class=cl><span class=s2>            output_file: 输出文件路径
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            生成的数据集
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_samples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成第 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>num_samples</span><span class=si>}</span><span class=s2> 条数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 1. 生成指令</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>instruction</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_instruction</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 2. 去重检查</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_similar</span><span class=p>(</span><span class=n>instruction</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  跳过（与种子池相似）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 3. 生成回答</span>
</span></span><span class=line><span class=cl>                <span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_response</span><span class=p>(</span><span class=n>instruction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 4. 构造数据样本</span>
</span></span><span class=line><span class=cl>                <span class=n>sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=n>instruction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>dataset</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 5. 加入种子池（动态增长）</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>seed_tasks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  成功生成：</span><span class=si>{</span><span class=n>instruction</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  生成失败：</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存数据集</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>数据集已保存至 </span><span class=si>{</span><span class=n>output_file</span><span class=si>}</span><span class=s2>，共 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>dataset</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 准备种子任务</span>
</span></span><span class=line><span class=cl>    <span class=n>seed_tasks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是机器学习&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;写一首关于春天的诗&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;将以下句子翻译成英语&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;今天天气很好&#34;</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;编写一个 Python 函数来计算斐波那契数列&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;总结以下文章的主要观点&#34;</span><span class=p>,</span> <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 保存种子任务</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;seed_tasks.json&#34;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>seed_tasks</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 创建生成器</span>
</span></span><span class=line><span class=cl>    <span class=n>generator</span> <span class=o>=</span> <span class=n>SelfInstructGenerator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>generator</span><span class=o>.</span><span class=n>load_seed_tasks</span><span class=p>(</span><span class=s2>&#34;seed_tasks.json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 生成数据集</span>
</span></span><span class=line><span class=cl>    <span class=c1># dataset = generator.generate_dataset(num_samples=10, output_file=&#34;my_sft_data.jsonl&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 查看生成的数据</span>
</span></span><span class=line><span class=cl>    <span class=c1># with open(&#34;my_sft_data.jsonl&#34;, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     for line in f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         sample = json.loads(line)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;指令: {sample[&#39;instruction&#39;]}&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;回答: {sample[&#39;output&#39;][:100]}...\n&#34;)</span></span></span></code></pre></div><p><strong>实战建议</strong>：</p><ol><li><strong>种子池质量至关重要</strong>：初始 175 条种子应覆盖各类任务</li><li><strong>动态采样</strong>：随着生成，将新指令加入种子池，提升多样性</li><li><strong>批量生成</strong>：使用 GPT-4 成本较高，建议批量生成并缓存</li><li><strong>人工审核</strong>：生成后应抽样检查，过滤低质量数据</li></ol><h3 id=3-evol-instruct让指令进化>3. Evol-Instruct：让指令进化<a class=anchor href=#3-evol-instruct%e8%ae%a9%e6%8c%87%e4%bb%a4%e8%bf%9b%e5%8c%96>#</a></h3><p><strong>核心思想</strong>：通过多轮"进化"，将简单指令逐步变复杂，提升模型推理能力。这是 <strong>WizardLM</strong> 的核心技术。</p><p><strong>进化策略</strong>：</p><table><thead><tr><th style=text-align:left>策略</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left><strong>增加约束</strong></td><td style=text-align:left>添加字数、格式、风格限制</td><td style=text-align:left>&ldquo;解释量子计算&rdquo; → &ldquo;用不超过100字解释量子计算&rdquo;</td></tr><tr><td style=text-align:left><strong>加深推理</strong></td><td style=text-align:left>要求多步推理、因果分析</td><td style=text-align:left>&ldquo;什么是通货膨胀&rdquo; → &ldquo;分析通货膨胀的根本原因及其对经济的多层次影响&rdquo;</td></tr><tr><td style=text-align:left><strong>具体化</strong></td><td style=text-align:left>将抽象概念具体化</td><td style=text-align:left>&ldquo;如何提高效率&rdquo; → &ldquo;如何在远程办公中提高团队协作效率&rdquo;</td></tr><tr><td style=text-align:left><strong>增加推理步骤</strong></td><td style=text-align:left>要求展示推理过程</td><td style=text-align:left>&ldquo;计算 25 × 17&rdquo; → &ldquo;逐步展示 25 × 17 的计算过程&rdquo;</td></tr><tr><td style=text-align:left><strong>复杂化输入</strong></td><td style=text-align:left>增加输入信息的复杂度</td><td style=text-align:left>&ldquo;总结文章&rdquo; → &ldquo;总结包含矛盾观点的多篇文章&rdquo;</td></tr></tbody></table><p><strong>进化流程</strong>：</p><p>$$
\begin{aligned}
&amp;I_0 \quad \text{(原始指令)} \
&\downarrow \text{进化策略1} \
&amp;I_1 \quad \text{(第1次进化)} \
&\downarrow \text{进化策略2} \
&amp;I_2 \quad \text{(第2次进化)} \
&\downarrow \ldots \
&amp;I_n \quad \text{(最终复杂指令)}
\end{aligned}
$$</p><h3 id=4-代码实战指令复杂度提升>4. 代码实战：指令复杂度提升<a class=anchor href=#4-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e6%8c%87%e4%bb%a4%e5%a4%8d%e6%9d%82%e5%ba%a6%e6%8f%90%e5%8d%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Evol-Instruct 实现
</span></span></span><span class=line><span class=cl><span class=s2>功能：将简单指令进化为复杂指令
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EvolInstructor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 定义进化策略模板</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>evolution_prompts</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;add_constraints&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;Please rewrite the following instruction by adding specific constraints (e.g., word limit, format requirement, target audience).
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Original Instruction: </span><span class=si>{instruction}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Evolved Instruction:&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;deepen&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;Please rewrite the following instruction to make it require deeper reasoning or multi-step thinking.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Original Instruction: </span><span class=si>{instruction}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Evolved Instruction:&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;concretize&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;Please rewrite the following instruction to make it more specific and concrete, adding real-world context.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Original Instruction: </span><span class=si>{instruction}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Evolved Instruction:&#34;&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;increase_reasoning&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;&#34;Please rewrite the following instruction to require the model to show step-by-step reasoning.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Original Instruction: </span><span class=si>{instruction}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Evolved Instruction:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>evolve_instruction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;add_constraints&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        使用指定策略进化指令
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            instruction: 原始指令
</span></span></span><span class=line><span class=cl><span class=s2>            strategy: 进化策略 (add_constraints, deepen, concretize, increase_reasoning)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            进化后的指令
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>evolution_prompts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown strategy: </span><span class=si>{</span><span class=n>strategy</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>evolution_prompts</span><span class=p>[</span><span class=n>strategy</span><span class=p>]</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>instruction</span><span class=o>=</span><span class=n>instruction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>300</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>evolved</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>evolved</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>multi_round_evolution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>depth</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        多轮进化
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            instruction: 原始指令
</span></span></span><span class=line><span class=cl><span class=s2>            depth: 进化轮数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            每轮进化后的指令列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>current</span> <span class=o>=</span> <span class=n>instruction</span>
</span></span><span class=line><span class=cl>        <span class=n>evolution_history</span> <span class=o>=</span> <span class=p>[</span><span class=n>instruction</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>strategies</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>evolution_prompts</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>depth</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>strategies</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>current</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>evolve_instruction</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>strategy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>evolution_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Round </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>strategy</span><span class=si>}</span><span class=s2>): </span><span class=si>{</span><span class=n>current</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>evolution_history</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>evolver</span> <span class=o>=</span> <span class=n>EvolInstructor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 简单指令</span>
</span></span><span class=line><span class=cl>    <span class=n>simple_instruction</span> <span class=o>=</span> <span class=s2>&#34;写一个 Python 函数来排序列表&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;原始指令:&#34;</span><span class=p>,</span> <span class=n>simple_instruction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>50</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 单策略进化</span>
</span></span><span class=line><span class=cl>    <span class=n>evolved</span> <span class=o>=</span> <span class=n>evolver</span><span class=o>.</span><span class=n>evolve_instruction</span><span class=p>(</span><span class=n>simple_instruction</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;add_constraints&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;增加约束后:&#34;</span><span class=p>,</span> <span class=n>evolved</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>evolved</span> <span class=o>=</span> <span class=n>evolver</span><span class=o>.</span><span class=n>evolve_instruction</span><span class=p>(</span><span class=n>simple_instruction</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;increase_reasoning&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;增加推理步骤后:&#34;</span><span class=p>,</span> <span class=n>evolved</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 多轮进化</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;多轮进化:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>50</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># history = evolver.multi_round_evolution(simple_instruction, depth=2)</span></span></span></code></pre></div><p><strong>输出示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>原始指令: 写一个 Python 函数来排序列表
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>增加约束后: 写一个 Python 函数来排序列表，要求使用快速排序算法，函数应包含详细注释，并处理空列表和单元素列表的边界情况。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>增加推理步骤后: 写一个 Python 函数来排序列表，并详细说明你选择的排序算法的工作原理，包括时间复杂度分析和适用场景。</span></span></code></pre></div><hr><h2 id=四数据清洗与质量过滤>四、数据清洗与质量过滤<a class=anchor href=#%e5%9b%9b%e6%95%b0%e6%8d%ae%e6%b8%85%e6%b4%97%e4%b8%8e%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4>#</a></h2><h3 id=1-基于规则的质量过滤>1. 基于规则的质量过滤<a class=anchor href=#1-%e5%9f%ba%e4%ba%8e%e8%a7%84%e5%88%99%e7%9a%84%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4>#</a></h3><p><strong>核心思想</strong>：使用启发式规则快速过滤明显的低质量数据。</p><p><strong>关键过滤规则</strong>：</p><p><strong>规则 1：长度过滤</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_by_length</span><span class=p>(</span><span class=n>sample</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;过滤过短或过长的回答&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>word_count</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 回答太短（&lt; 10 词）或太长（&gt; 2000 词）</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>10</span> <span class=o>&lt;=</span> <span class=n>word_count</span> <span class=o>&lt;=</span> <span class=mi>2000</span></span></span></code></pre></div><p><strong>规则 2：重复内容检测</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_repetition</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_repeat</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检测重复行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>lines</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>line_counts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>line</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>line_counts</span><span class=p>[</span><span class=n>line</span><span class=p>]</span> <span class=o>=</span> <span class=n>line_counts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>line_counts</span><span class=p>[</span><span class=n>line</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>max_repeat</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span></span></span></code></pre></div><p><strong>规则 3：完整性检测</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_incomplete</span><span class=p>(</span><span class=n>output</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检测回答是否完整&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 回答不应该突然截断</span>
</span></span><span class=line><span class=cl>    <span class=n>incomplete_patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;[未完成]&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;（未完待续）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;the rest is&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;to be continued&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output_lower</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>incomplete_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>output_lower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span></span></span></code></pre></div><p><strong>规则 4：拒绝回答检测</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>filter_refusal</span><span class=p>(</span><span class=n>output</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检测模型是否拒绝回答&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>refusal_patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;i cannot&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;i&#39;m unable to&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;i can&#39;t&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;as an ai&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;i don&#39;t have access&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;i&#39;m not able to&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output_lower</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>refusal_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>output_lower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span></span></span></code></pre></div><h3 id=2-毒性检测>2. 毒性检测<a class=anchor href=#2-%e6%af%92%e6%80%a7%e6%a3%80%e6%b5%8b>#</a></h3><p><strong>工具</strong>：使用 <code>detoxify</code> 库进行毒性检测</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>毒性内容过滤
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install detoxify
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detoxify</span> <span class=kn>import</span> <span class=n>Detoxify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToxicityFilter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>Detoxify</span><span class=p>(</span><span class=s1>&#39;original&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span> <span class=o>=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_toxic</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检测文本是否有毒&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查任何一个维度的毒性</span>
</span></span><span class=line><span class=cl>        <span class=n>toxic_categories</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;toxicity&#39;</span><span class=p>,</span> <span class=s1>&#39;severe_toxicity&#39;</span><span class=p>,</span> <span class=s1>&#39;obscene&#39;</span><span class=p>,</span> <span class=s1>&#39;threat&#39;</span><span class=p>,</span> <span class=s1>&#39;insult&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>category</span> <span class=ow>in</span> <span class=n>toxic_categories</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>scores</span><span class=p>[</span><span class=n>category</span><span class=p>]</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;过滤数据集中的有毒数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检查指令和输出是否有毒</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_toxic</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>])</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_toxic</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=n>filtered</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>filtered</span></span></span></code></pre></div><h3 id=3-pii-识别与脱敏>3. PII 识别与脱敏<a class=anchor href=#3-pii-%e8%af%86%e5%88%ab%e4%b8%8e%e8%84%b1%e6%95%8f>#</a></h3><p><strong>工具</strong>：使用 <code>presidio</code> 库进行 PII 检测</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>PII 脱敏
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install presidio-analyzer presidio-anonymizer
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>presidio_analyzer</span> <span class=kn>import</span> <span class=n>AnalyzerEngine</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>presidio_anonymizer</span> <span class=kn>import</span> <span class=n>AnonymizerEngine</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>presidio_anonymizer.entities</span> <span class=kn>import</span> <span class=n>OperatorConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PIIScrubber</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>analyzer</span> <span class=o>=</span> <span class=n>AnalyzerEngine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>anonymizer</span> <span class=o>=</span> <span class=n>AnonymizerEngine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>scrub</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;脱敏 PII 信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检测 PII</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>analyzer</span><span class=o>.</span><span class=n>analyze</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=o>=</span><span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>entities</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;PHONE_NUMBER&#34;</span><span class=p>,</span> <span class=s2>&#34;EMAIL_ADDRESS&#34;</span><span class=p>,</span> <span class=s2>&#34;PERSON&#34;</span><span class=p>,</span> <span class=s2>&#34;LOCATION&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>language</span><span class=o>=</span><span class=s1>&#39;en&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 替换为占位符</span>
</span></span><span class=line><span class=cl>        <span class=n>anonymized</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>anonymizer</span><span class=o>.</span><span class=n>anonymize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span><span class=o>=</span><span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>analyzer_results</span><span class=o>=</span><span class=n>results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>operators</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;PHONE_NUMBER&#34;</span><span class=p>:</span> <span class=n>OperatorConfig</span><span class=p>(</span><span class=s2>&#34;replace&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;new_value&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;PHONE&gt;&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;EMAIL_ADDRESS&#34;</span><span class=p>:</span> <span class=n>OperatorConfig</span><span class=p>(</span><span class=s2>&#34;replace&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;new_value&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;EMAIL&gt;&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;PERSON&#34;</span><span class=p>:</span> <span class=n>OperatorConfig</span><span class=p>(</span><span class=s2>&#34;replace&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;new_value&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;NAME&gt;&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;LOCATION&#34;</span><span class=p>:</span> <span class=n>OperatorConfig</span><span class=p>(</span><span class=s2>&#34;replace&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;new_value&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;LOCATION&gt;&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>anonymized</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>scrub_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量脱敏数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>scrubbed</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>scrubbed_sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>scrubbed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>scrubbed_sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>scrubbed</span></span></span></code></pre></div><h3 id=4-代码实战完整的质量过滤器>4. 代码实战：完整的质量过滤器<a class=anchor href=#4-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e5%ae%8c%e6%95%b4%e7%9a%84%e8%b4%a8%e9%87%8f%e8%bf%87%e6%bb%a4%e5%99%a8>#</a></h3><p><strong>整合所有过滤器</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>综合质量过滤器
</span></span></span><span class=line><span class=cl><span class=s2>功能：整合所有质量检查规则
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QualityFilter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>enable_toxicity</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>enable_pii</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_toxicity</span> <span class=o>=</span> <span class=n>enable_toxicity</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_pii</span> <span class=o>=</span> <span class=n>enable_pii</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>enable_toxicity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>toxicity_filter</span> <span class=o>=</span> <span class=n>ToxicityFilter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>enable_pii</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>pii_scrubber</span> <span class=o>=</span> <span class=n>PIIScrubber</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_length</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sample</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;长度检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>output_words</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>10</span> <span class=o>&lt;=</span> <span class=n>output_words</span> <span class=o>&lt;=</span> <span class=mi>2000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_repetition</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;重复检测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lines</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>line_counts</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>lines</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>line</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>line_counts</span><span class=p>[</span><span class=n>line</span><span class=p>]</span> <span class=o>=</span> <span class=n>line_counts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>line_counts</span><span class=p>[</span><span class=n>line</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_completeness</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;完整性检测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>incomplete_patterns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;...&#34;</span><span class=p>,</span> <span class=s2>&#34;[未完成]&#34;</span><span class=p>,</span> <span class=s2>&#34;to be continued&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>output_lower</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>incomplete_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>output_lower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_refusal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;拒绝回答检测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>refusal_patterns</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;i cannot&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#39;m unable to&#34;</span><span class=p>,</span> <span class=s2>&#34;as an ai&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>output_lower</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>refusal_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>output_lower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter_sample</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sample</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>bool</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        过滤单条样本
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            (是否通过, 失败原因)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 长度检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_length</span><span class=p>(</span><span class=n>sample</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;length_invalid&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 重复检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_repetition</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;repetition_detected&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 完整性检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_completeness</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;incomplete_response&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 拒绝回答检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_refusal</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;refusal_detected&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 5. 毒性检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_toxicity</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>toxicity_filter</span><span class=o>.</span><span class=n>is_toxic</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>])</span> <span class=ow>or</span> \
</span></span><span class=line><span class=cl>               <span class=bp>self</span><span class=o>.</span><span class=n>toxicity_filter</span><span class=o>.</span><span class=n>is_toxic</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;toxic_content&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;passed&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>output_file</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        批量过滤数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            统计信息
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>dataset</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;rejected&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reasons&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>passed</span><span class=p>,</span> <span class=n>reason</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_sample</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>passed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># PII 脱敏</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_pii</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>pii_scrubber</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>pii_scrubber</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;input&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>pii_scrubber</span><span class=o>.</span><span class=n>scrub</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>filtered</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>][</span><span class=n>reason</span><span class=p>]</span> <span class=o>=</span> <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>reason</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存过滤后的数据</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>output_file</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>filtered</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>stats</span><span class=p>,</span> <span class=n>filtered</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 测试数据</span>
</span></span><span class=line><span class=cl>    <span class=n>test_dataset</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是机器学习&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;机器学习是人工智能的一个分支，通过算法让计算机从数据中学习。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是量子计算&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;量子计算...&#34;</span>  <span class=c1># 不完整</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;你能帮我黑掉别人的账号吗？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;很抱歉，I cannot help with that.&#34;</span>  <span class=c1># 拒绝回答</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建过滤器</span>
</span></span><span class=line><span class=cl>    <span class=n>filter_engine</span> <span class=o>=</span> <span class=n>QualityFilter</span><span class=p>(</span><span class=n>enable_toxicity</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>enable_pii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 过滤数据集</span>
</span></span><span class=line><span class=cl>    <span class=n>stats</span><span class=p>,</span> <span class=n>filtered</span> <span class=o>=</span> <span class=n>filter_engine</span><span class=o>.</span><span class=n>filter_dataset</span><span class=p>(</span><span class=n>test_dataset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;过滤统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总计: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;通过: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;拒绝: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;拒绝原因: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=5-合成数据实战使用-llm-生成指令>5. 合成数据实战：使用 LLM 生成指令<a class=anchor href=#5-%e5%90%88%e6%88%90%e6%95%b0%e6%8d%ae%e5%ae%9e%e6%88%98%e4%bd%bf%e7%94%a8-llm-%e7%94%9f%e6%88%90%e6%8c%87%e4%bb%a4>#</a></h3><p><strong>核心思想</strong>：利用强大的 LLM（如 GPT-4、Claude）批量生成高质量的指令-回答对，这是构建微调数据集最高效的方法之一。</p><h4 id=51-为什么选择合成数据>5.1 为什么选择合成数据？<a class=anchor href=#51-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9%e5%90%88%e6%88%90%e6%95%b0%e6%8d%ae>#</a></h4><p><strong>优势</strong>：</p><ul><li><strong>成本低</strong>：相比人工标注（$10-30/小时），API 调用成本仅 $0.01-0.03/条</li><li><strong>速度快</strong>：一天可生成 10K+ 条数据</li><li><strong>质量高</strong>：GPT-4 生成的数据质量接近人工标注</li><li><strong>可控性强</strong>：可以精确控制任务类型、难度、风格</li></ul><p><strong>成功案例</strong>：</p><ul><li><strong>Alpaca (Stanford, 2023)</strong>：52K 条 GPT-3.5-turbo 生成的数据，训练 7B 模型达到 text-davinci-003 的 90% 能力</li><li><strong>WizardLM (Microsoft, 2023)</strong>：通过 Evol-Instruct 生成复杂指令，7B 模型超越 ChatGPT 在部分任务</li><li><strong>Phi-3 (Microsoft, 2024)</strong>：3.8B 模型使用合成数据，性能超越 Llama-2-13B</li></ul><h4 id=52-完整的合成数据生成流程>5.2 完整的合成数据生成流程<a class=anchor href=#52-%e5%ae%8c%e6%95%b4%e7%9a%84%e5%90%88%e6%88%90%e6%95%b0%e6%8d%ae%e7%94%9f%e6%88%90%e6%b5%81%e7%a8%8b>#</a></h4><p><strong>Step 1: 设计种子指令池</strong></p><p>种子指令应覆盖多种任务类型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>构建多样化的种子指令池
</span></span></span><span class=line><span class=cl><span class=s2>覆盖：问答、推理、创作、代码、翻译、摘要等
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>seed_instructions</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 问答类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;qa&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是量子纠缠&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;qa&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;为什么天空是蓝色的&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 推理类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;reasoning&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;如果所有A都是B，所有B都是C，那么A和C的关系是什么&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;reasoning&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;分析通货膨胀对普通家庭的影响&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 创作类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;creative&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;写一首关于秋天的诗&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;creative&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;创作一个科幻小说的开头&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 代码类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;编写一个Python函数来计算斐波那契数列&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;实现一个二分查找算法&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 5. 翻译类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;translation&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;将以下句子翻译成英语：今天天气很好&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;translation&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;把这段中文翻译成法语&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 6. 摘要类</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;summarization&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;总结以下文章的主要观点&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;task_type&#34;</span><span class=p>:</span> <span class=s2>&#34;summarization&#34;</span><span class=p>,</span> <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;用三句话概括这段新闻&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p><strong>Step 2: 批量生成指令-回答对</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>使用 OpenAI API 批量生成合成数据
</span></span></span><span class=line><span class=cl><span class=s2>包含错误处理、速率限制、质量检查
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tqdm</span> <span class=kn>import</span> <span class=n>tqdm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SyntheticDataGenerator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;gpt-4&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化合成数据生成器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            api_key: OpenAI API Key
</span></span></span><span class=line><span class=cl><span class=s2>            model: 使用的模型（gpt-4, gpt-3.5-turbo）
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>model</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>generated_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failed_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 成本配置（参考价格，单位：$/1M tokens）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>10.0</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>30.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4-turbo&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>10.0</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>30.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>1.5</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>2.5</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>10.0</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.6</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>estimate_cost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_samples</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_instruction_tokens</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_output_tokens</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        估算生成数据集的成本
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            num_samples: 要生成的样本数量
</span></span></span><span class=line><span class=cl><span class=s2>            avg_instruction_tokens: 平均指令长度（tokens）
</span></span></span><span class=line><span class=cl><span class=s2>            avg_output_tokens: 平均输出长度（tokens）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            成本估算详情
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取模型定价</span>
</span></span><span class=line><span class=cl>        <span class=n>model_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>model_key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 默认使用 gpt-4 定价</span>
</span></span><span class=line><span class=cl>            <span class=n>model_key</span> <span class=o>=</span> <span class=s2>&#34;gpt-4&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pricing</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span><span class=p>[</span><span class=n>model_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算总 token 数</span>
</span></span><span class=line><span class=cl>        <span class=c1># 输入：system prompt (~100 tokens) + 指令 prompt (~200 tokens) + 指令内容</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens_per_sample</span> <span class=o>=</span> <span class=mi>300</span> <span class=o>+</span> <span class=n>avg_instruction_tokens</span>
</span></span><span class=line><span class=cl>        <span class=n>total_input_tokens</span> <span class=o>=</span> <span class=n>num_samples</span> <span class=o>*</span> <span class=n>input_tokens_per_sample</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 输出：生成的回答</span>
</span></span><span class=line><span class=cl>        <span class=n>total_output_tokens</span> <span class=o>=</span> <span class=n>num_samples</span> <span class=o>*</span> <span class=n>avg_output_tokens</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算成本</span>
</span></span><span class=line><span class=cl>        <span class=n>input_cost</span> <span class=o>=</span> <span class=p>(</span><span class=n>total_input_tokens</span> <span class=o>/</span> <span class=mi>1_000_000</span><span class=p>)</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>output_cost</span> <span class=o>=</span> <span class=p>(</span><span class=n>total_output_tokens</span> <span class=o>/</span> <span class=mi>1_000_000</span><span class=p>)</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>total_cost</span> <span class=o>=</span> <span class=n>input_cost</span> <span class=o>+</span> <span class=n>output_cost</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 估算时间（假设每个请求平均 2 秒）</span>
</span></span><span class=line><span class=cl>        <span class=n>estimated_time_minutes</span> <span class=o>=</span> <span class=p>(</span><span class=n>num_samples</span> <span class=o>*</span> <span class=mi>2</span><span class=p>)</span> <span class=o>/</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;num_samples&#34;</span><span class=p>:</span> <span class=n>num_samples</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_input_tokens&#34;</span><span class=p>:</span> <span class=n>total_input_tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_output_tokens&#34;</span><span class=p>:</span> <span class=n>total_output_tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_tokens&#34;</span><span class=p>:</span> <span class=n>total_input_tokens</span> <span class=o>+</span> <span class=n>total_output_tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input_cost&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>input_cost</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output_cost&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>output_cost</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_cost&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>total_cost</span><span class=p>,</span> <span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cost_per_sample&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>total_cost</span> <span class=o>/</span> <span class=n>num_samples</span><span class=p>,</span> <span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;estimated_time_minutes&#34;</span><span class=p>:</span> <span class=nb>round</span><span class=p>(</span><span class=n>estimated_time_minutes</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pricing_input&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;$</span><span class=si>{</span><span class=n>pricing</span><span class=p>[</span><span class=s1>&#39;input&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/1M tokens&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pricing_output&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;$</span><span class=si>{</span><span class=n>pricing</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/1M tokens&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_qa_pair</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        为单个指令生成高质量回答
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            instruction: 指令
</span></span></span><span class=line><span class=cl><span class=s2>            context: 额外上下文（可选）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            {&#34;instruction&#34;: ..., &#34;input&#34;: ..., &#34;output&#34;: ...}
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 构造 prompt</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;请为以下指令提供一个高质量、详细的回答。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>指令：</span><span class=si>{</span><span class=n>instruction</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：</span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 回答要准确、完整
</span></span></span><span class=line><span class=cl><span class=s2>2. 语言要流畅、自然
</span></span></span><span class=line><span class=cl><span class=s2>3. 包含必要的解释和示例
</span></span></span><span class=line><span class=cl><span class=s2>4. 避免生成有害、偏见或错误的内容
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;请为以下指令提供一个高质量、详细的回答。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>指令：</span><span class=si>{</span><span class=n>instruction</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 回答要准确、完整
</span></span></span><span class=line><span class=cl><span class=s2>2. 语言要流畅、自然
</span></span></span><span class=line><span class=cl><span class=s2>3. 包含必要的解释和示例
</span></span></span><span class=line><span class=cl><span class=s2>4. 避免生成有害、偏见或错误的内容
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;你是一个乐于助人的AI助手，擅长回答各类问题。&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>top_p</span><span class=o>=</span><span class=mf>0.9</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>output</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 构造 Alpaca 格式</span>
</span></span><span class=line><span class=cl>            <span class=n>qa_pair</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=n>instruction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>generated_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>qa_pair</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>failed_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>batch_generate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>instructions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>output_file</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;synthetic_data.jsonl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>delay</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        批量生成数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            instructions: 指令列表
</span></span></span><span class=line><span class=cl><span class=s2>            output_file: 输出文件路径
</span></span></span><span class=line><span class=cl><span class=s2>            batch_size: 批处理大小
</span></span></span><span class=line><span class=cl><span class=s2>            delay: 请求间隔（秒），避免速率限制
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            生成的数据集
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;开始生成 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>instructions</span><span class=p>)</span><span class=si>}</span><span class=s2> 条数据...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;模型: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;批处理大小: </span><span class=si>{</span><span class=n>batch_size</span><span class=si>}</span><span class=s2>, 请求间隔: </span><span class=si>{</span><span class=n>delay</span><span class=si>}</span><span class=s2>秒</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用进度条</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>tqdm</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>instructions</span><span class=p>),</span> <span class=n>batch_size</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span> <span class=o>=</span> <span class=n>instructions</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>batch_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>instruction</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>qa_pair</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_qa_pair</span><span class=p>(</span><span class=n>instruction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>qa_pair</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>dataset</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>qa_pair</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=c1># 实时保存（避免长时间运行后丢失数据）</span>
</span></span><span class=line><span class=cl>                    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>qa_pair</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 速率限制</span>
</span></span><span class=line><span class=cl>                <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 打印统计信息</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>生成完成！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成功: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>generated_count</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;失败: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>failed_count</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成功率: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>generated_count</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>instructions</span><span class=p>)</span> <span class=o>*</span> <span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;数据已保存至: </span><span class=si>{</span><span class=n>output_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>dataset</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 准备指令列表</span>
</span></span><span class=line><span class=cl>    <span class=n>instructions</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;解释什么是深度学习&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;写一个Python函数来判断一个数是否为质数&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;分析气候变化对农业的影响&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;创作一个关于友谊的短篇故事&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;总结《三体》第一部的主要情节&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># ... 更多指令</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 创建生成器</span>
</span></span><span class=line><span class=cl>    <span class=n>generator</span> <span class=o>=</span> <span class=n>SyntheticDataGenerator</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 估算成本（在生成前）</span>
</span></span><span class=line><span class=cl>    <span class=n>cost_estimate</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>estimate_cost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>num_samples</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>instructions</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_instruction_tokens</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>avg_output_tokens</span><span class=o>=</span><span class=mi>500</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>📊 成本估算:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  模型: </span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  样本数: </span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;num_samples&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  总 tokens: </span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;total_tokens&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  输入成本: $</span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;input_cost&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  输出成本: $</span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;output_cost&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  总成本: $</span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;total_cost&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  每条成本: $</span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;cost_per_sample&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  预计耗时: </span><span class=si>{</span><span class=n>cost_estimate</span><span class=p>[</span><span class=s1>&#39;estimated_time_minutes&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 分钟</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 批量生成</span>
</span></span><span class=line><span class=cl>    <span class=c1># dataset = generator.batch_generate(</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     instructions=instructions,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     output_file=&#34;my_synthetic_data.jsonl&#34;,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     batch_size=5,</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     delay=1.0</span>
</span></span><span class=line><span class=cl>    <span class=c1># )</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 查看生成的数据</span>
</span></span><span class=line><span class=cl>    <span class=c1># with open(&#34;my_synthetic_data.jsonl&#34;, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     for line in f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         sample = json.loads(line)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;指令: {sample[&#39;instruction&#39;]}&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;回答: {sample[&#39;output&#39;][:100]}...\n&#34;)</span></span></span></code></pre></div><p><strong>Step 3: 质量控制与后处理</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>合成数据的质量控制
</span></span></span><span class=line><span class=cl><span class=s2>包含：长度过滤、重复检测、毒性检测
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SyntheticDataQualityControl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>min_output_length</span> <span class=o>=</span> <span class=mi>50</span>  <span class=c1># 最短回答长度（字符）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_output_length</span> <span class=o>=</span> <span class=mi>2000</span>  <span class=c1># 最长回答长度</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_quality</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>sample</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>bool</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检查单条样本的质量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            (是否通过, 失败原因)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 长度检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>min_output_length</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;output_too_short&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_output_length</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;output_too_long&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 检查是否包含拒绝回答的模式</span>
</span></span><span class=line><span class=cl>        <span class=n>refusal_patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;i cannot&#34;</span><span class=p>,</span> <span class=s2>&#34;i can&#39;t&#34;</span><span class=p>,</span> <span class=s2>&#34;i&#39;m unable to&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;as an ai&#34;</span><span class=p>,</span> <span class=s2>&#34;i don&#39;t have access&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;抱歉&#34;</span><span class=p>,</span> <span class=s2>&#34;对不起，我无法&#34;</span><span class=p>,</span> <span class=s2>&#34;我不能&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>output_lower</span> <span class=o>=</span> <span class=n>output</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>refusal_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>output_lower</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;refusal_detected&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 检查是否过于简短</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>output</span><span class=o>.</span><span class=n>split</span><span class=p>())</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=s2>&#34;too_few_words&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;passed&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>filter_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>output_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        批量过滤数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            统计信息
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>filtered</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;rejected&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reasons&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>input_file</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=n>sample</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>passed</span><span class=p>,</span> <span class=n>reason</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_quality</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>passed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>filtered</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>][</span><span class=n>reason</span><span class=p>]</span> <span class=o>=</span> <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>reason</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存过滤后的数据</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>filtered</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>质量过滤完成！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总计: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;通过: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;拒绝: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;rejected&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;通过率: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;拒绝原因: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;reasons&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=c1># qc = SyntheticDataQualityControl()</span>
</span></span><span class=line><span class=cl><span class=c1># stats = qc.filter_dataset(&#34;my_synthetic_data.jsonl&#34;, &#34;filtered_data.jsonl&#34;)</span></span></span></code></pre></div><h4 id=53-成本估算与优化>5.3 成本估算与优化<a class=anchor href=#53-%e6%88%90%e6%9c%ac%e4%bc%b0%e7%ae%97%e4%b8%8e%e4%bc%98%e5%8c%96>#</a></h4><p><strong>成本估算表</strong>：</p><table><thead><tr><th style=text-align:left>模型</th><th style=text-align:center>输入价格</th><th style=text-align:center>输出价格</th><th style=text-align:center>每条数据成本</th><th style=text-align:center>10K数据总成本</th></tr></thead><tbody><tr><td style=text-align:left><strong>GPT-4</strong></td><td style=text-align:center>$10/1M tokens</td><td style=text-align:center>$30/1M tokens</td><td style=text-align:center>~$0.03</td><td style=text-align:center><strong>$300</strong></td></tr><tr><td style=text-align:left><strong>GPT-3.5-turbo</strong></td><td style=text-align:center>$0.5/1M tokens</td><td style=text-align:center>$1.5/1M tokens</td><td style=text-align:center>~$0.002</td><td style=text-align:center><strong>$20</strong></td></tr><tr><td style=text-align:left><strong>Claude 3 Sonnet</strong></td><td style=text-align:center>$3/1M tokens</td><td style=text-align:center>$15/1M tokens</td><td style=text-align:center>~$0.015</td><td style=text-align:center><strong>$150</strong></td></tr></tbody></table><p><strong>使用 <code>estimate_cost()</code> 方法进行精确预估</strong>：</p><p>上面的 <code>SyntheticDataGenerator</code> 类已内置 <code>estimate_cost()</code> 方法，可以在生成前精确计算成本。</p><p><strong>使用示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建生成器</span>
</span></span><span class=line><span class=cl><span class=n>generator</span> <span class=o>=</span> <span class=n>SyntheticDataGenerator</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 估算生成 10K 条数据的成本</span>
</span></span><span class=line><span class=cl><span class=n>cost_info</span> <span class=o>=</span> <span class=n>generator</span><span class=o>.</span><span class=n>estimate_cost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>num_samples</span><span class=o>=</span><span class=mi>10000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_instruction_tokens</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>   <span class=c1># 平均指令长度</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_output_tokens</span><span class=o>=</span><span class=mi>500</span>        <span class=c1># 平均回答长度</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;模型: </span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;样本数: </span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;num_samples&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总 tokens: </span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;total_tokens&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>,</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总成本: $</span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;total_cost&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;每条成本: $</span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;cost_per_sample&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;预计耗时: </span><span class=si>{</span><span class=n>cost_info</span><span class=p>[</span><span class=s1>&#39;estimated_time_minutes&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 分钟&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>输出示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>模型: gpt-4
</span></span><span class=line><span class=cl>样本数: 10,000
</span></span><span class=line><span class=cl>总 tokens: 8,500,000
</span></span><span class=line><span class=cl>总成本: $185.0
</span></span><span class=line><span class=cl>每条成本: $0.0185
</span></span><span class=line><span class=cl>预计耗时: 333.3 分钟</span></span></code></pre></div><p><strong>不同模型的成本对比</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 对比不同模型的成本</span>
</span></span><span class=line><span class=cl><span class=n>models</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>,</span> <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>num_samples</span> <span class=o>=</span> <span class=mi>10000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>📊 成本对比（10K 条数据）:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=s1>&#39;模型&#39;</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;总成本&#39;</span><span class=si>:</span><span class=s2>&gt;10</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;每条成本&#39;</span><span class=si>:</span><span class=s2>&gt;12</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=s1>&#39;预计耗时&#39;</span><span class=si>:</span><span class=s2>&gt;12</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>model</span> <span class=ow>in</span> <span class=n>models</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>gen</span> <span class=o>=</span> <span class=n>SyntheticDataGenerator</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cost</span> <span class=o>=</span> <span class=n>gen</span><span class=o>.</span><span class=n>estimate_cost</span><span class=p>(</span><span class=n>num_samples</span><span class=o>=</span><span class=n>num_samples</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>model</span><span class=si>:</span><span class=s2>&lt;20</span><span class=si>}</span><span class=s2> $</span><span class=si>{</span><span class=n>cost</span><span class=p>[</span><span class=s1>&#39;total_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;9.2f</span><span class=si>}</span><span class=s2> $</span><span class=si>{</span><span class=n>cost</span><span class=p>[</span><span class=s1>&#39;cost_per_sample&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;11.4f</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>cost</span><span class=p>[</span><span class=s1>&#39;estimated_time_minutes&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>&gt;9.1f</span><span class=si>}</span><span class=s2>分钟&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>输出示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>📊 成本对比（10K 条数据）:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>模型                    总成本        每条成本          预计耗时
</span></span><span class=line><span class=cl>------------------------------------------------------------
</span></span><span class=line><span class=cl>gpt-4                  $185.00      $0.0185       333.3分钟
</span></span><span class=line><span class=cl>gpt-3.5-turbo           $9.25      $0.0009       333.3分钟
</span></span><span class=line><span class=cl>gpt-4o-mini             $3.88      $0.0004       333.3分钟</span></span></code></pre></div><p><strong>优化策略</strong>：</p><ol><li><p><strong>分层使用模型</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 简单任务用 GPT-3.5-turbo</span>
</span></span><span class=line><span class=cl><span class=c1># 复杂任务用 GPT-4</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_model</span><span class=p>(</span><span class=n>instruction</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>complex_keywords</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;分析&#34;</span><span class=p>,</span> <span class=s2>&#34;推理&#34;</span><span class=p>,</span> <span class=s2>&#34;论证&#34;</span><span class=p>,</span> <span class=s2>&#34;代码&#34;</span><span class=p>,</span> <span class=s2>&#34;算法&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>instruction</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>complex_keywords</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;gpt-4&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;gpt-3.5-turbo&#34;</span></span></span></code></pre></div></li><li><p><strong>批量请求</strong>：使用 OpenAI 的 Batch API，价格减半</p></li><li><p><strong>缓存中间结果</strong>：避免重复生成相同类型的数据</p></li></ol><h4 id=54-实战建议>5.4 实战建议<a class=anchor href=#54-%e5%ae%9e%e6%88%98%e5%bb%ba%e8%ae%ae>#</a></h4><p><strong>数据量建议</strong>：</p><ul><li><strong>小规模任务</strong>（客服、FAQ）：1K - 5K 条</li><li><strong>中等任务</strong>（通用对话）：10K - 50K 条</li><li><strong>大规模任务</strong>（多领域）：50K - 500K 条</li></ul><p><strong>质量保证</strong>：</p><ol><li><strong>人工抽样</strong>：每生成 1000 条，抽查 50-100 条</li><li><strong>A/B 测试</strong>：用少量数据训练，对比人工标注数据的效果</li><li><strong>多样性检查</strong>：使用聚类分析，确保数据覆盖不同主题</li></ol><p><strong>常见陷阱</strong>：</p><ul><li>❌ 种子指令过于单一，导致生成数据缺乏多样性</li><li>❌ 不做质量过滤，直接使用所有生成数据</li><li>❌ 全部使用 GPT-4，成本过高</li><li>✅ 结合人工标注 + 合成数据，取长补短</li></ul><hr><h2 id=五小规模数据去重>五、小规模数据去重<a class=anchor href=#%e4%ba%94%e5%b0%8f%e8%a7%84%e6%a8%a1%e6%95%b0%e6%8d%ae%e5%8e%bb%e9%87%8d>#</a></h2><h3 id=1-为什么微调数据需要去重scalability-的关键>1. 为什么微调数据需要去重：Scalability 的关键<a class=anchor href=#1-%e4%b8%ba%e4%bb%80%e4%b9%88%e5%be%ae%e8%b0%83%e6%95%b0%e6%8d%ae%e9%9c%80%e8%a6%81%e5%8e%bb%e9%87%8dscalability-%e7%9a%84%e5%85%b3%e9%94%ae>#</a></h3><p><strong>问题</strong>：重复数据会导致四大问题</p><p><strong>问题 1：过拟合</strong></p><ul><li>模型死记硬背重复样本，泛化能力下降</li><li>在验证集上表现好，实际应用效果差</li></ul><p><strong>问题 2：训练偏差</strong></p><ul><li>重复样本占比过高，模型偏向这些样本</li><li>例如：如果 30% 的数据都是"解释 XXX"，模型会倾向于生成解释类回答</li></ul><p><strong>问题 3：计算浪费</strong> ⚡ <strong>这是最严重的问题!</strong></p><ul><li>重复数据不提供新信息，却消耗同样的计算资源</li><li>去重后可用更少的 FLOPs 达到同等效果</li></ul><p><strong>问题 4：内存浪费</strong></p><ul><li>重复数据占用存储和显存，限制batch size</li></ul><p><strong>去重对 Scalability 的巨大影响</strong></p><p>根据 Lee et al. (2022) 的论文 <a href=https://arxiv.org/abs/2107.06499>&ldquo;Deduplicating Training Data Makes Language Models Better&rdquo;</a>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│        DEDUPLICATION → MASSIVE EFFICIENCY GAINS                 │
</span></span><span class=line><span class=cl>│              (去重 → 效率爆炸式提升)                             │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>实验设置:
</span></span><span class=line><span class=cl>- 模型: GPT-3 规模(175B)
</span></span><span class=line><span class=cl>- 数据集: C4 (750GB)
</span></span><span class=line><span class=cl>- 去重比例: 移除 ~25% 的近似重复数据
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>结果对比:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                  训练前                 去重后
</span></span><span class=line><span class=cl>                  ─────                 ──────
</span></span><span class=line><span class=cl>数据量:           750GB                 560GB (-25%)
</span></span><span class=line><span class=cl>训练时间:         1000 GPU-days         750 GPU-days (-25%)
</span></span><span class=line><span class=cl>FLOPs:            2e23                  1.5e23 (-25%)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>性能:             Perplexity: 15.2      Perplexity: 14.8 (↑2.6%)
</span></span><span class=line><span class=cl>                  ↑ 更少的数据 → 更好的效果!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>关键发现:
</span></span><span class=line><span class=cl>✅ 去重后，只需 75% 的 FLOPs 就能达到更好的效果
</span></span><span class=line><span class=cl>✅ 等效性能下，训练成本降低 3-5x
</span></span><span class=line><span class=cl>✅ 下游任务准确率平均提升 1-3%</span></span></code></pre></div><p><strong>为什么去重后效果反而更好?</strong></p><p>原因1: <strong>信息密度提升</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>去重前: 100K样本，30%重复 → 有效信息只有70K
</span></span><span class=line><span class=cl>去重后: 70K样本，0%重复 → 有效信息就是70K
</span></span><span class=line><span class=cl>信息密度: 70% → 100%</span></span></code></pre></div><p>原因2: <strong>梯度更新质量提升</strong></p><ul><li>重复样本导致梯度被同一信息主导</li><li>去重后每个batch包含更多样化的信息</li><li>模型学习更均衡，泛化能力更强</li></ul><p><strong>去重策略</strong>：</p><ul><li><strong>精确去重</strong>：移除完全相同的样本（基于哈希）</li><li><strong>模糊去重</strong>：移除高度相似的样本（基于 MinHash）</li></ul><p><strong>实践建议</strong>:</p><ul><li><strong>小规模数据</strong>(&lt; 10K): 精确去重即可，成本可忽略</li><li><strong>中等规模</strong>(10K-100K): 使用 MinHash，去重率通常 15-30%</li><li><strong>大规模数据</strong>(> 100K): 必须去重，否则训练效率极低</li></ul><h3 id=2-minhash-去重原理文档指纹识别技术>2. MinHash 去重原理：文档"指纹识别"技术<a class=anchor href=#2-minhash-%e5%8e%bb%e9%87%8d%e5%8e%9f%e7%90%86%e6%96%87%e6%a1%a3%e6%8c%87%e7%ba%b9%e8%af%86%e5%88%ab%e6%8a%80%e6%9c%af>#</a></h3><p><strong>核心思想</strong>：MinHash 为每个文档生成固定长度的"签名"(指纹)，使得相似文档的签名也相似。</p><p><strong>形象化理解：文档指纹化</strong></p><p>想象你要识别海量文档中的重复内容。直接逐字比较太慢了！MinHash 就像给每个文档"按指纹":</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>原始文档 A:                          MinHash 签名:
</span></span><span class=line><span class=cl>&#34;机器学习是人工智能的分支...&#34;         [0x3F, 0xA2, 0x1B, ...]
</span></span><span class=line><span class=cl>│                                    │
</span></span><span class=line><span class=cl>├─&gt; Shingling (切词)                 │  只需比较短签名
</span></span><span class=line><span class=cl>│   {&#34;机器&#34;, &#34;学习&#34;, &#34;是人&#34;, ...}      │  (128维) 而非
</span></span><span class=line><span class=cl>│                                    │  完整文档!
</span></span><span class=line><span class=cl>├─&gt; Hash 映射                        │
</span></span><span class=line><span class=cl>│   {h1(机器)=0x3F, ...}             │
</span></span><span class=line><span class=cl>│                                    │
</span></span><span class=line><span class=cl>└─&gt; 取最小值 ──────────────────────&gt; [指纹]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>文档 B (高度相似):                    MinHash 签名:
</span></span><span class=line><span class=cl>&#34;机器学习是AI的一个分支...&#34;           [0x3F, 0xA2, 0x1C, ...]
</span></span><span class=line><span class=cl>                                    ↑ 非常接近!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>文档 C (完全不同):                    MinHash 签名:
</span></span><span class=line><span class=cl>&#34;今天天气很好...&#34;                    [0x8D, 0x5F, 0xC2, ...]
</span></span><span class=line><span class=cl>                                    ↑ 完全不同!</span></span></code></pre></div><p><strong>MinHash 签名的神奇性质</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>如果两个文档相似度为 80%，
</span></span><span class=line><span class=cl>那么它们的 MinHash 签名有 80% 的位相同！
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Jaccard相似度(A,B) = MinHash签名相似度(A,B)</span></span></code></pre></div><p>这使得我们可以：</p><ol><li><strong>快速过滤</strong>: 只比较签名(128维)，不比较全文(数千维)</li><li><strong>近似准确</strong>: 相似度估计误差 &lt; 5%</li><li><strong>可扩展</strong>: 可处理数百万文档</li></ol><p><strong>数学原理</strong>：</p><p>给定两个文档 $A$ 和 $B$，它们的 Jaccard 相似度定义为：</p><p>$$
J(A, B) = \frac{|A \cap B|}{|A \cup B|}
$$</p><p>MinHash 的核心性质：</p><p>$$
P(\text{MinHash}(A)_i = \text{MinHash}(B)_i) = J(A, B)
$$</p><p>即：MinHash 签名的某一位相同的概率，等于 Jaccard 相似度。</p><p><strong>算法步骤</strong>：</p><ol><li><p><strong>Shingling</strong>：将文档转换为 n-gram 集合</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 示例：3-gram</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;the quick brown&#34;</span> <span class=err>→</span> <span class=p>{</span><span class=s2>&#34;the&#34;</span><span class=p>,</span> <span class=s2>&#34;he &#34;</span><span class=p>,</span> <span class=s2>&#34;e q&#34;</span><span class=p>,</span> <span class=s2>&#34; qu&#34;</span><span class=p>,</span> <span class=s2>&#34;qui&#34;</span><span class=p>,</span> <span class=s2>&#34;uic&#34;</span><span class=p>,</span> <span class=s2>&#34;ick&#34;</span><span class=p>,</span> <span class=o>...</span><span class=p>}</span></span></span></code></pre></div></li><li><p><strong>MinHash 签名</strong>：使用 $k$ 个哈希函数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sig</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>hash_i</span><span class=p>(</span><span class=n>shingle</span><span class=p>)</span> <span class=k>for</span> <span class=n>shingle</span> <span class=ow>in</span> <span class=n>shingles</span><span class=p>)</span></span></span></code></pre></div></li><li><p><strong>相似度估计</strong>：
$$
\hat{J}(A, B) = \frac{1}{k} \sum_{i=1}^k \mathbb{1}[\text{sig}_A[i] = \text{sig}_B[i]]
$$</p></li></ol><h3 id=3-代码实战minhash-简单实现>3. 代码实战：MinHash 简单实现<a class=anchor href=#3-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98minhash-%e7%ae%80%e5%8d%95%e5%ae%9e%e7%8e%b0>#</a></h3><p><strong>适用于小规模微调数据（&lt; 100K）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>MinHash 去重（简化版）
</span></span></span><span class=line><span class=cl><span class=s2>功能：小规模数据集的模糊去重
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install datasketch
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datasketch</span> <span class=kn>import</span> <span class=n>MinHash</span><span class=p>,</span> <span class=n>MinHashLSH</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Set</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SimpleDeduplicator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.8</span><span class=p>,</span> <span class=n>num_perm</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>128</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化去重器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            threshold: 相似度阈值（0.8 表示 80% 相似即视为重复）
</span></span></span><span class=line><span class=cl><span class=s2>            num_perm: MinHash 签名长度
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>threshold</span> <span class=o>=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>num_perm</span> <span class=o>=</span> <span class=n>num_perm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_tokenize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;分词（简单版：按空格分词）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>set</span><span class=p>(</span><span class=n>text</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>split</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_compute_minhash</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>MinHash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算 MinHash 签名&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>m</span> <span class=o>=</span> <span class=n>MinHash</span><span class=p>(</span><span class=n>num_perm</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>num_perm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tokenize</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>tokens</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>token</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deduplicate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        去重数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            dataset: Alpaca 格式数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            去重后的数据集
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>lsh</span> <span class=o>=</span> <span class=n>MinHashLSH</span><span class=p>(</span><span class=n>threshold</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>threshold</span><span class=p>,</span> <span class=n>num_perm</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>num_perm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>unique_data</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>seen_indices</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第一轮：建立 LSH 索引</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;建立 LSH 索引...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>minhashes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>sample</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 拼接 instruction 和 output 作为去重依据</span>
</span></span><span class=line><span class=cl>            <span class=n>combined_text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>mh</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_compute_minhash</span><span class=p>(</span><span class=n>combined_text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>minhashes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第二轮：查找重复</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;查找重复样本...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>mh</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>minhashes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>seen_indices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>doc_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;doc_</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 查询相似文档</span>
</span></span><span class=line><span class=cl>            <span class=n>candidates</span> <span class=o>=</span> <span class=n>lsh</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>mh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>candidates</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 第一次见到该文档</span>
</span></span><span class=line><span class=cl>                <span class=n>lsh</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=n>doc_id</span><span class=p>,</span> <span class=n>mh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>unique_data</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dataset</span><span class=p>[</span><span class=n>idx</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 已有相似文档，跳过</span>
</span></span><span class=line><span class=cl>                <span class=n>seen_indices</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>unique_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 测试数据（包含重复）</span>
</span></span><span class=line><span class=cl>    <span class=n>test_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是机器学习&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;机器学习是人工智能的分支，通过算法从数据中学习。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释机器学习是什么&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;机器学习是 AI 的一个分支，让计算机从数据中学习。&#34;</span>  <span class=c1># 高度相似</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是深度学习&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;深度学习是机器学习的子集，使用多层神经网络。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;解释什么是机器学习&#34;</span><span class=p>,</span>  <span class=c1># 完全重复</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;机器学习是人工智能的分支,通过算法从数据中学习。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 去重</span>
</span></span><span class=line><span class=cl>    <span class=n>deduper</span> <span class=o>=</span> <span class=n>SimpleDeduplicator</span><span class=p>(</span><span class=n>threshold</span><span class=o>=</span><span class=mf>0.8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>unique_data</span> <span class=o>=</span> <span class=n>deduper</span><span class=o>.</span><span class=n>deduplicate</span><span class=p>(</span><span class=n>test_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>原始数据: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>test_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;去重后: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>unique_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;移除: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>test_data</span><span class=p>)</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>unique_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条重复</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;去重后的数据:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>sample</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>unique_data</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>性能建议</strong>：</p><ul><li>对于 &lt; 10K 数据：直接两两比较即可</li><li>对于 10K - 100K 数据：使用 MinHash + LSH</li><li>对于 > 100K 数据：参考 [Part 7 第6章] 的大规模去重方案</li></ul><hr><h2 id=六数据增强技术>六、数据增强技术<a class=anchor href=#%e5%85%ad%e6%95%b0%e6%8d%ae%e5%a2%9e%e5%bc%ba%e6%8a%80%e6%9c%af>#</a></h2><h3 id=1-回译back-translation>1. 回译（Back-translation）<a class=anchor href=#1-%e5%9b%9e%e8%af%91back-translation>#</a></h3><p><strong>核心思想</strong>：将文本翻译成另一种语言，再翻译回来，得到语义相同但表述不同的数据。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>回译数据增强
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install googletrans==4.0.0-rc1
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>googletrans</span> <span class=kn>import</span> <span class=n>Translator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BackTranslator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>translator</span> <span class=o>=</span> <span class=n>Translator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>augment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>intermediate_lang</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;fr&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        回译增强
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            text: 原始文本
</span></span></span><span class=line><span class=cl><span class=s2>            intermediate_lang: 中间语言（fr=法语, de=德语, es=西班牙语）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            回译后的文本
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 英语 -&gt; 中间语言</span>
</span></span><span class=line><span class=cl>        <span class=n>translated</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>translator</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>dest</span><span class=o>=</span><span class=n>intermediate_lang</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 中间语言 -&gt; 英语</span>
</span></span><span class=line><span class=cl>        <span class=n>back_translated</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>translator</span><span class=o>.</span><span class=n>translate</span><span class=p>(</span><span class=n>translated</span><span class=o>.</span><span class=n>text</span><span class=p>,</span> <span class=n>dest</span><span class=o>=</span><span class=s1>&#39;en&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>back_translated</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=c1># translator = BackTranslator()</span>
</span></span><span class=line><span class=cl><span class=c1># original = &#34;Machine learning is a subset of artificial intelligence.&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># augmented = translator.augment(original, intermediate_lang=&#39;fr&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1># print(f&#34;原始: {original}&#34;)</span>
</span></span><span class=line><span class=cl><span class=c1># print(f&#34;增强: {augmented}&#34;)</span></span></span></code></pre></div><h3 id=2-同义词替换>2. 同义词替换<a class=anchor href=#2-%e5%90%8c%e4%b9%89%e8%af%8d%e6%9b%bf%e6%8d%a2>#</a></h3><p><strong>核心思想</strong>：随机替换文本中的词汇为同义词。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>同义词替换
</span></span></span><span class=line><span class=cl><span class=s2>依赖：pip install nltk
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>nltk</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>nltk.corpus</span> <span class=kn>import</span> <span class=n>wordnet</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 下载 WordNet</span>
</span></span><span class=line><span class=cl><span class=c1># nltk.download(&#39;wordnet&#39;)</span>
</span></span><span class=line><span class=cl><span class=c1># nltk.download(&#39;omw-1.4&#39;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SynonymReplacer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>replace_ratio</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            replace_ratio: 替换比例（0.1 表示替换 10% 的词）
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>replace_ratio</span> <span class=o>=</span> <span class=n>replace_ratio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_synonyms</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>word</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取同义词&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>synonyms</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>syn</span> <span class=ow>in</span> <span class=n>wordnet</span><span class=o>.</span><span class=n>synsets</span><span class=p>(</span><span class=n>word</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>lemma</span> <span class=ow>in</span> <span class=n>syn</span><span class=o>.</span><span class=n>lemmas</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>synonym</span> <span class=o>=</span> <span class=n>lemma</span><span class=o>.</span><span class=n>name</span><span class=p>()</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;_&#39;</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>synonym</span> <span class=o>!=</span> <span class=n>word</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>synonyms</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>synonym</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>synonyms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>augment</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;同义词替换增强&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>num_replace</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>words</span><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>replace_ratio</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 随机选择要替换的位置</span>
</span></span><span class=line><span class=cl>        <span class=n>replace_indices</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>sample</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>words</span><span class=p>)),</span> <span class=nb>min</span><span class=p>(</span><span class=n>num_replace</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>words</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>idx</span> <span class=ow>in</span> <span class=n>replace_indices</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>word</span> <span class=o>=</span> <span class=n>words</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>synonyms</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_synonyms</span><span class=p>(</span><span class=n>word</span><span class=o>.</span><span class=n>lower</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>synonyms</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>words</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>synonyms</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>words</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=c1># replacer = SynonymReplacer(replace_ratio=0.2)</span>
</span></span><span class=line><span class=cl><span class=c1># original = &#34;Machine learning is a powerful technique for data analysis.&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># augmented = replacer.augment(original)</span>
</span></span><span class=line><span class=cl><span class=c1># print(f&#34;原始: {original}&#34;)</span>
</span></span><span class=line><span class=cl><span class=c1># print(f&#34;增强: {augmented}&#34;)</span></span></span></code></pre></div><h3 id=3-代码实战数据增强工具>3. 代码实战：数据增强工具<a class=anchor href=#3-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e6%95%b0%e6%8d%ae%e5%a2%9e%e5%bc%ba%e5%b7%a5%e5%85%b7>#</a></h3><p><strong>整合多种增强策略</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>综合数据增强工具
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataAugmenter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>back_translator</span> <span class=o>=</span> <span class=n>BackTranslator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>synonym_replacer</span> <span class=o>=</span> <span class=n>SynonymReplacer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>augment_dataset</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>dataset</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>target_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        扩充数据集到目标大小
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            dataset: 原始数据集
</span></span></span><span class=line><span class=cl><span class=s2>            target_size: 目标数据集大小
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            扩充后的数据集
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>augmented</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span>  <span class=c1># 复制原始数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>augmented</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>target_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 随机选择一条样本</span>
</span></span><span class=line><span class=cl>            <span class=n>sample</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span><span class=n>dataset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 随机选择增强策略</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=s1>&#39;back_translation&#39;</span><span class=p>,</span> <span class=s1>&#39;synonym&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=s1>&#39;back_translation&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>aug_instruction</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>back_translator</span><span class=o>.</span><span class=n>augment</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>aug_instruction</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>synonym_replacer</span><span class=o>.</span><span class=n>augment</span><span class=p>(</span><span class=n>sample</span><span class=p>[</span><span class=s1>&#39;instruction&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 创建增强样本</span>
</span></span><span class=line><span class=cl>                <span class=n>aug_sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=n>aug_instruction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=n>sample</span><span class=p>[</span><span class=s1>&#39;input&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>sample</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>]</span>  <span class=c1># 输出保持不变</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>augmented</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>aug_sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>  <span class=c1># 增强失败，跳过</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>augmented</span><span class=p>[:</span><span class=n>target_size</span><span class=p>]</span></span></span></code></pre></div><p><strong>注意事项</strong>：</p><ol><li>数据增强不应改变语义</li><li>增强后的数据质量可能下降，需要人工抽查</li><li>对于代码生成任务，不建议使用同义词替换</li></ol><hr><h2 id=七sft-数据集构建实战>七、SFT 数据集构建实战<a class=anchor href=#%e4%b8%83sft-%e6%95%b0%e6%8d%ae%e9%9b%86%e6%9e%84%e5%bb%ba%e5%ae%9e%e6%88%98>#</a></h2><h3 id=1-完整-pipeline从原始文本到-alpaca-格式>1. 完整 Pipeline：从原始文本到 Alpaca 格式<a class=anchor href=#1-%e5%ae%8c%e6%95%b4-pipeline%e4%bb%8e%e5%8e%9f%e5%a7%8b%e6%96%87%e6%9c%ac%e5%88%b0-alpaca-%e6%a0%bc%e5%bc%8f>#</a></h3><p><strong>场景</strong>：将一批技术文档转换为问答对，用于微调模型。</p><p><strong>Pipeline</strong>：</p><p>$$
\begin{aligned}
&\text{原始文档} \
&\downarrow \text{1. 文档分块} \
&\text{文档段落} \
&\downarrow \text{2. 生成问答对（GPT-4）} \
&\text{(Question, Answer) 对} \
&\downarrow \text{3. 格式化为 Alpaca} \
&\text{Alpaca 数据集} \
&\downarrow \text{4. 质量过滤} \
&\text{高质量数据集} \
&\downarrow \text{5. 去重} \
&\text{最终数据集}
\end{aligned}
$$</p><h3 id=2-代码实战端到端数据构建>2. 代码实战：端到端数据构建<a class=anchor href=#2-%e4%bb%a3%e7%a0%81%e5%ae%9e%e6%88%98%e7%ab%af%e5%88%b0%e7%ab%af%e6%95%b0%e6%8d%ae%e6%9e%84%e5%bb%ba>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>端到端 SFT 数据构建 Pipeline
</span></span></span><span class=line><span class=cl><span class=s2>功能：从原始文档到 Alpaca 格式的完整流程
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SFTDatasetBuilder</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>api_key</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>api_key</span> <span class=ow>or</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>quality_filter</span> <span class=o>=</span> <span class=n>QualityFilter</span><span class=p>(</span><span class=n>enable_toxicity</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>enable_pii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>deduplicator</span> <span class=o>=</span> <span class=n>SimpleDeduplicator</span><span class=p>(</span><span class=n>threshold</span><span class=o>=</span><span class=mf>0.85</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chunk_document</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>document</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        文档分块
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            document: 原始文档
</span></span></span><span class=line><span class=cl><span class=s2>            chunk_size: 每块的词数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            文档段落列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>words</span> <span class=o>=</span> <span class=n>document</span><span class=o>.</span><span class=n>split</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>words</span><span class=p>),</span> <span class=n>chunk_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk</span> <span class=o>=</span> <span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>words</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>chunk_size</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>chunks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>chunk</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>chunks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_qa_from_chunk</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>chunk</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>num_qa</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        从文档段落生成问答对
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            chunk: 文档段落
</span></span></span><span class=line><span class=cl><span class=s2>            num_qa: 生成问答对的数量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            问答对列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Based on the following text, generate </span><span class=si>{</span><span class=n>num_qa</span><span class=si>}</span><span class=s2> diverse question-answer pairs. The questions should cover different aspects and difficulty levels.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Text:
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>chunk</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Generate </span><span class=si>{</span><span class=n>num_qa</span><span class=si>}</span><span class=s2> Q&amp;A pairs in JSON format:
</span></span></span><span class=line><span class=cl><span class=s2>[
</span></span></span><span class=line><span class=cl><span class=s2>  </span><span class=se>{{</span><span class=s2>&#34;question&#34;: &#34;...&#34;, &#34;answer&#34;: &#34;...&#34;</span><span class=se>}}</span><span class=s2>,
</span></span></span><span class=line><span class=cl><span class=s2>  ...
</span></span></span><span class=line><span class=cl><span class=s2>]
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>JSON:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>messages</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>                <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1500</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 解析 JSON</span>
</span></span><span class=line><span class=cl>            <span class=n>qa_pairs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>qa_pairs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;生成失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>convert_to_alpaca</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>qa_pairs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        转换为 Alpaca 格式
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            qa_pairs: 问答对列表 [{&#34;question&#34;: &#34;...&#34;, &#34;answer&#34;: &#34;...&#34;}]
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        返回：
</span></span></span><span class=line><span class=cl><span class=s2>            Alpaca 格式数据
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alpaca_data</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>qa</span> <span class=ow>in</span> <span class=n>qa_pairs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>sample</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;instruction&#34;</span><span class=p>:</span> <span class=n>qa</span><span class=p>[</span><span class=s1>&#39;question&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>qa</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>alpaca_data</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>alpaca_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_from_document</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>document</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>output_file</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;sft_dataset.jsonl&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        从单个文档构建数据集
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        参数：
</span></span></span><span class=line><span class=cl><span class=s2>            document: 原始文档
</span></span></span><span class=line><span class=cl><span class=s2>            output_file: 输出文件路径
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Step 1: 文档分块...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>chunk_document</span><span class=p>(</span><span class=n>document</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  共 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> 个段落&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Step 2: 生成问答对...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_qa_pairs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>chunks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  处理段落 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>)</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>qa_pairs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_qa_from_chunk</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>num_qa</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>all_qa_pairs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>qa_pairs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  共生成 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>all_qa_pairs</span><span class=p>)</span><span class=si>}</span><span class=s2> 对问答&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Step 3: 转换为 Alpaca 格式...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>alpaca_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_to_alpaca</span><span class=p>(</span><span class=n>all_qa_pairs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Step 4: 质量过滤...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span><span class=p>,</span> <span class=n>filtered_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quality_filter</span><span class=o>.</span><span class=n>filter_dataset</span><span class=p>(</span><span class=n>alpaca_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  通过: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;passed&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Step 5: 去重...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>final_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>deduplicator</span><span class=o>.</span><span class=n>deduplicate</span><span class=p>(</span><span class=n>filtered_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  最终数据: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>final_data</span><span class=p>)</span><span class=si>}</span><span class=s2> 条&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_file</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>sample</span> <span class=ow>in</span> <span class=n>final_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>sample</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>数据集已保存至 </span><span class=si>{</span><span class=n>output_file</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>final_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 示例文档</span>
</span></span><span class=line><span class=cl>    <span class=n>sample_document</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Transformer 是一种革命性的神经网络架构,由 Google 在 2017 年提出。
</span></span></span><span class=line><span class=cl><span class=s2>    它完全基于注意力机制,摒弃了传统的循环神经网络(RNN)和卷积神经网络(CNN)。
</span></span></span><span class=line><span class=cl><span class=s2>    Transformer 的核心创新在于 Self-Attention 机制,使得模型能够并行处理序列中的所有位置,
</span></span></span><span class=line><span class=cl><span class=s2>    大大提升了训练效率。这一架构后来成为 BERT、GPT 等大语言模型的基础。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Transformer 包含编码器(Encoder)和解码器(Decoder)两个主要组件。
</span></span></span><span class=line><span class=cl><span class=s2>    编码器负责理解输入序列,而解码器负责生成输出序列。
</span></span></span><span class=line><span class=cl><span class=s2>    每个编码器层包含 Multi-Head Self-Attention 和 Feed-Forward Network 两个子层。
</span></span></span><span class=line><span class=cl><span class=s2>    通过堆叠多层编码器和解码器,Transformer 能够学习复杂的语言模式。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    自 2017 年以来,Transformer 已经主导了自然语言处理领域,并扩展到计算机视觉、
</span></span></span><span class=line><span class=cl><span class=s2>    语音识别等多个领域。它的成功证明了注意力机制的强大能力,
</span></span></span><span class=line><span class=cl><span class=s2>    也为后续的模型创新奠定了基础。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建数据集</span>
</span></span><span class=line><span class=cl>    <span class=n>builder</span> <span class=o>=</span> <span class=n>SFTDatasetBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># dataset = builder.build_from_document(sample_document, output_file=&#34;transformer_sft.jsonl&#34;)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 查看生成的数据</span>
</span></span><span class=line><span class=cl>    <span class=c1># with open(&#34;transformer_sft.jsonl&#34;, &#39;r&#39;, encoding=&#39;utf-8&#39;) as f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#     for line in f:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         sample = json.loads(line)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;\n指令: {sample[&#39;instruction&#39;]}&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#         print(f&#34;回答: {sample[&#39;output&#39;][:100]}...&#34;)</span></span></span></code></pre></div><p><strong>输出示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Step 1: 文档分块...
</span></span><span class=line><span class=cl>  共 1 个段落
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step 2: 生成问答对...
</span></span><span class=line><span class=cl>  处理段落 1/1...
</span></span><span class=line><span class=cl>  共生成 2 对问答
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step 3: 转换为 Alpaca 格式...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step 4: 质量过滤...
</span></span><span class=line><span class=cl>  通过: 2/2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Step 5: 去重...
</span></span><span class=line><span class=cl>  最终数据: 2 条
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>数据集已保存至 transformer_sft.jsonl</span></span></code></pre></div><p><strong>实战建议</strong>：</p><ol><li><strong>起步阶段</strong>：先构建 1K 高质量数据，快速验证效果</li><li><strong>扩展阶段</strong>：逐步扩展到 10K - 50K，持续评估质量</li><li><strong>平衡策略</strong>：确保任务类型多样性（问答、推理、代码、翻译）</li><li><strong>人工审核</strong>：定期抽样检查生成数据的质量</li></ol><hr><h2 id=八特定任务的数据构造实战>八、特定任务的数据构造实战<a class=anchor href=#%e5%85%ab%e7%89%b9%e5%ae%9a%e4%bb%bb%e5%8a%a1%e7%9a%84%e6%95%b0%e6%8d%ae%e6%9e%84%e9%80%a0%e5%ae%9e%e6%88%98>#</a></h2><p>通用指令数据是基础，但为了让模型在特定领域表现出色，你需要构造专用的技能数据。</p><h3 id=1-案例一情感分析-classification>1. 案例一：情感分析 (Classification)<a class=anchor href=#1-%e6%a1%88%e4%be%8b%e4%b8%80%e6%83%85%e6%84%9f%e5%88%86%e6%9e%90-classification>#</a></h3><p><strong>目标</strong>：输入一段文本，输出情感标签（Positive/Negative/Neutral）。</p><p><strong>数据构造技巧</strong>：</p><ul><li><strong>标签平衡</strong>：确保各类别样本数量大致相等。</li><li><strong>难度分层</strong>：<ul><li>L1 (简单): &ldquo;我喜欢这部电影&rdquo; -> Positive</li><li>L2 (隐晦): &ldquo;这电影让我看了三次表&rdquo; -> Negative</li><li>L3 (混合): &ldquo;特效虽然一般，但剧情真的很抓人&rdquo; -> Positive</li></ul></li></ul><p><strong>构造 Prompt 示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;Generate 5 diverse sentiment analysis examples.
</span></span></span><span class=line><span class=cl><span class=s2>Format: JSON
</span></span></span><span class=line><span class=cl><span class=s2>Requirements:
</span></span></span><span class=line><span class=cl><span class=s2>1. Cover distinct domains (product review, financial news, social media)
</span></span></span><span class=line><span class=cl><span class=s2>2. Include mixed sentiments (but clear overall label)
</span></span></span><span class=line><span class=cl><span class=s2>3. Output format: {&#34;text&#34;: &#34;...&#34;, &#34;label&#34;: &#34;Positive/Negative&#34;}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><h3 id=2-案例二代码生成-coding>2. 案例二：代码生成 (Coding)<a class=anchor href=#2-%e6%a1%88%e4%be%8b%e4%ba%8c%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90-coding>#</a></h3><p><strong>目标</strong>：输入需求，输出Python代码。</p><p><strong>数据构造技巧</strong>：</p><ul><li><strong>包含测试用例</strong>：这是DeepSeek-Coder-V2的核心策略。让模型学会"写代码 + 写单测"。</li><li><strong>依赖库说明</strong>：明确指定使用的库。</li></ul><p><strong>样本示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;编写一个Python函数计算移动平均值&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;```python\ndef moving_average(data, window_size):\n    # ...code...\n    return averages\n\n# Test Case\nassert moving_average([1,2,3], 2) == [1.5, 2.5]\n```&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=3-案例三数学推理-mathcot>3. 案例三：数学推理 (Math/CoT)<a class=anchor href=#3-%e6%a1%88%e4%be%8b%e4%b8%89%e6%95%b0%e5%ad%a6%e6%8e%a8%e7%90%86-mathcot>#</a></h3><p><strong>目标</strong>：解决数学应用题。</p><p><strong>数据构造技巧</strong>：</p><ul><li><strong>Chain-of-Thought (CoT)</strong>：必须要求模型输出思考过程，而不是直接给答案。</li><li><strong>过程验证</strong>：如果可能，用Python代码验证计算结果。</li></ul><p><strong>样本示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;instruction&#34;</span><span class=p>:</span> <span class=s2>&#34;小明有5个苹果，给了小红2个，又买来3个，现在有几个？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;output&#34;</span><span class=p>:</span> <span class=s2>&#34;思考过程：\n1. 初始状态：5个苹果\n2. 给出2个：5 - 2 = 3个\n3. 买入3个：3 + 3 = 6个\n\n答案：6个&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><hr><h2 id=九本章小结>九、本章小结<a class=anchor href=#%e4%b9%9d%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><p><strong>核心要点</strong>：</p><ol><li><p><strong>Data-Centric AI 理念</strong>：在微调阶段，数据质量 > 数据量</p><ul><li>10K 高质量数据 > 100K 低质量数据</li><li>Phi-3、Alpaca 的成功都证明了这一点</li></ul></li><li><p><strong>数据格式标准化</strong>：</p><ul><li><strong>Alpaca 格式</strong>：适合单轮指令任务</li><li><strong>ShareGPT 格式</strong>：适合多轮对话</li></ul></li><li><p><strong>Self-Instruct 是核心技术</strong>：</p><ul><li>用 GPT-4 生成高质量的指令-回答对</li><li>Evol-Instruct 通过多轮进化提升数据复杂度</li></ul></li><li><p><strong>质量过滤必不可少</strong>：</p><ul><li>基于规则的过滤：长度、重复、完整性</li><li>毒性检测：使用 detoxify</li><li>PII 脱敏：使用 presidio</li></ul></li><li><p><strong>小规模去重</strong>：</p><ul><li>MinHash + LSH 适用于 10K - 100K 数据</li><li>大规模去重详见 [Part 7 第6章]</li></ul></li><li><p><strong>完整 Pipeline</strong>：
原始文档 → 分块 → 生成问答 → 格式化 → 质量过滤 → 去重 → 最终数据集</p></li></ol><p><strong>下一步</strong>：</p><ul><li>有了高质量数据后，下一章将学习如何使用这些数据进行微调（详见 <a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章_微调你的专属模型</a>）</li></ul><hr><h2 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h2><p><strong>论文</strong>：</p><ul><li><strong>Self-Instruct</strong>: <a href=https://arxiv.org/abs/2212.10560>Aligning Language Models with Self-Generated Instructions</a> (Stanford, 2023)</li><li><strong>Alpaca</strong>: <a href=https://github.com/tatsu-lab/stanford_alpaca>Stanford Alpaca: An Instruction-following LLaMA Model</a></li><li><strong>WizardLM</strong>: <a href=https://arxiv.org/abs/2304.12244>WizardLM: Empowering Large Language Models to Follow Complex Instructions</a></li><li><strong>Phi-3</strong>: <a href=https://arxiv.org/abs/2404.14219>Phi-3 Technical Report</a> (Microsoft, 2024)</li></ul><p><strong>工具库</strong>：</p><ul><li><strong>OpenAI API</strong>: <a href=https://platform.openai.com/docs>https://platform.openai.com/docs</a></li><li><strong>datasketch</strong>: <a href=https://github.com/ekzhu/datasketch>https://github.com/ekzhu/datasketch</a> (MinHash 去重)</li><li><strong>detoxify</strong>: <a href=https://github.com/unitaryai/detoxify>https://github.com/unitaryai/detoxify</a> (毒性检测)</li><li><strong>presidio</strong>: <a href=https://github.com/microsoft/presidio>https://github.com/microsoft/presidio</a> (PII 脱敏)</li></ul><p><strong>数据集</strong>：</p><ul><li><strong>Alpaca-52K</strong>: <a href=https://github.com/tatsu-lab/stanford_alpaca/blob/main/alpaca_data.json>https://github.com/tatsu-lab/stanford_alpaca/blob/main/alpaca_data.json</a></li><li><strong>ShareGPT</strong>: <a href=https://huggingface.co/datasets/anon8231489123/ShareGPT_Vicuna_unfiltered>https://huggingface.co/datasets/anon8231489123/ShareGPT_Vicuna_unfiltered</a></li><li><strong>WizardLM Dataset</strong>: <a href=https://huggingface.co/datasets/WizardLM/WizardLM_evol_instruct_V2_196k>https://huggingface.co/datasets/WizardLM/WizardLM_evol_instruct_V2_196k</a></li></ul><blockquote class=book-hint><p>下一章：<a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章_微调你的专属模型</a> 将详细讲解 LoRA、QLoRA 等高效微调技术。</p></blockquote></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第3章 预训练的奥秘：从数据到智能</span>
</a></span><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/ class="flex align-center"><span>第2章 微调你的专属模型</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#数据炼金术-pipeline-全景图>数据炼金术 Pipeline 全景图</a></li><li><a href=#本章前置说明微调数据-vs-预训练数据>本章前置说明：微调数据 vs 预训练数据</a></li><li><a href=#目录>目录</a></li><li><a href=#一data-centric-ai数据为王的时代>一、Data-Centric AI：数据为王的时代</a><ul><li><a href=#1-model-centric-vs-data-centric>1. Model-Centric vs Data-Centric</a></li><li><a href=#2-微调数据的三大要素>2. 微调数据的三大要素</a></li><li><a href=#3-数据质量的黄金定律>3. 数据质量的黄金定律</a></li></ul></li><li><a href=#二sft-数据格式详解>二、SFT 数据格式详解</a><ul><li><a href=#1-alpaca-格式指令式数据>1. Alpaca 格式：指令式数据</a></li><li><a href=#2-sharegpt-格式多轮对话数据>2. ShareGPT 格式：多轮对话数据</a></li><li><a href=#3-格式转换实战>3. 格式转换实战</a></li></ul></li><li><a href=#三self-instruct用-gpt-4-生成微调数据>三、Self-Instruct：用 GPT-4 生成微调数据</a><ul><li><a href=#1-self-instruct-原理知识蒸馏的艺术>1. Self-Instruct 原理：知识蒸馏的艺术</a></li><li><a href=#2-代码实战生成高质量指令数据>2. 代码实战：生成高质量指令数据</a></li><li><a href=#3-evol-instruct让指令进化>3. Evol-Instruct：让指令进化</a></li><li><a href=#4-代码实战指令复杂度提升>4. 代码实战：指令复杂度提升</a></li></ul></li><li><a href=#四数据清洗与质量过滤>四、数据清洗与质量过滤</a><ul><li><a href=#1-基于规则的质量过滤>1. 基于规则的质量过滤</a></li><li><a href=#2-毒性检测>2. 毒性检测</a></li><li><a href=#3-pii-识别与脱敏>3. PII 识别与脱敏</a></li><li><a href=#4-代码实战完整的质量过滤器>4. 代码实战：完整的质量过滤器</a></li><li><a href=#5-合成数据实战使用-llm-生成指令>5. 合成数据实战：使用 LLM 生成指令</a><ul><li><a href=#51-为什么选择合成数据>5.1 为什么选择合成数据？</a></li><li><a href=#52-完整的合成数据生成流程>5.2 完整的合成数据生成流程</a></li><li><a href=#53-成本估算与优化>5.3 成本估算与优化</a></li><li><a href=#54-实战建议>5.4 实战建议</a></li></ul></li></ul></li><li><a href=#五小规模数据去重>五、小规模数据去重</a><ul><li><a href=#1-为什么微调数据需要去重scalability-的关键>1. 为什么微调数据需要去重：Scalability 的关键</a></li><li><a href=#2-minhash-去重原理文档指纹识别技术>2. MinHash 去重原理：文档"指纹识别"技术</a></li><li><a href=#3-代码实战minhash-简单实现>3. 代码实战：MinHash 简单实现</a></li></ul></li><li><a href=#六数据增强技术>六、数据增强技术</a><ul><li><a href=#1-回译back-translation>1. 回译（Back-translation）</a></li><li><a href=#2-同义词替换>2. 同义词替换</a></li><li><a href=#3-代码实战数据增强工具>3. 代码实战：数据增强工具</a></li></ul></li><li><a href=#七sft-数据集构建实战>七、SFT 数据集构建实战</a><ul><li><a href=#1-完整-pipeline从原始文本到-alpaca-格式>1. 完整 Pipeline：从原始文本到 Alpaca 格式</a></li><li><a href=#2-代码实战端到端数据构建>2. 代码实战：端到端数据构建</a></li></ul></li><li><a href=#八特定任务的数据构造实战>八、特定任务的数据构造实战</a><ul><li><a href=#1-案例一情感分析-classification>1. 案例一：情感分析 (Classification)</a></li><li><a href=#2-案例二代码生成-coding>2. 案例二：代码生成 (Coding)</a></li><li><a href=#3-案例三数学推理-mathcot>3. 案例三：数学推理 (Math/CoT)</a></li></ul></li><li><a href=#九本章小结>九、本章小结</a></li><li><a href=#参考资源>参考资源</a></li></ul></nav></div></aside></main></body></html>