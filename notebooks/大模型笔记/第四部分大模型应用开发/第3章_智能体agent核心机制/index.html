<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第3章:智能体(Agent)核心机制# “The future of AI is not just about better models, but about better systems.” - Andrew Ng
智能体(Agent)将 LLM 从"大脑"变成了"双手",让 AI 具备了与世界交互的能力。
本章导读# 本章专注于 Agent 设计模式与工程实现,是构建自主智能系统的核心技术。我们将深入探讨:
ReAct/Plan-and-Solve 等规划模式的代码实现 Tool Use / Function Calling 的 JSON Schema 定义与解析 MCP (Model Context Protocol) 协议标准与实战 LangGraph 的 StateGraph 编程范式 Memory 系统的短期/长期记忆设计 Multi-Agent 协作模式 (Supervisor/Hierarchical) 边界说明 (参考 chapter-boundaries.md):
✅ 本章包含: Agent 架构设计、工具调用、MCP 协议、多智能体协作、Memory 机制 ❌ 不包含: CoT 数学原理 (→ Part 7 Ch3)、推理时搜索/MCTS (→ Part 7 Ch4)、强化学习训练 Agent (→ Part 7 Ch4) 目录# 一、从 Prompt Engineering 到 Agentic Workflow 二、规划 (Planning):ReAct 与 Plan-and-Solve 三、工具使用 (Tool Use) 与 Function Calling 四、MCP (Model Context Protocol) 革命 五、记忆系统 (Memory) 设计 六、LangGraph:状态机编程范式 6.1 StateGraph 核心概念 6.2 实战:基于 LangGraph 的 ReAct Agent 6.3 条件边与循环控制 6.4 持久化 (Persistence): Multi-turn 对话的基础 6.5 Human-in-the-loop: 敏感操作的审批机制 七、多智能体协作 (Multi-Agent) 八、Output Parser:结构化输出解析 九、本章小结 一、从 Prompt Engineering 到 Agentic Workflow# Andrew Ng 最近提出一个重要观点:与其追求更强的模型 (GPT-5),不如优化 Agent 工作流 (Agentic Workflow)。 GPT-3.5 + 良好的工作流,往往能超越零样本的 GPT-4。
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第3章 智能体（Agent）核心机制"><meta property="og:description" content='第3章:智能体(Agent)核心机制# “The future of AI is not just about better models, but about better systems.” - Andrew Ng
智能体(Agent)将 LLM 从"大脑"变成了"双手",让 AI 具备了与世界交互的能力。
本章导读# 本章专注于 Agent 设计模式与工程实现,是构建自主智能系统的核心技术。我们将深入探讨:
ReAct/Plan-and-Solve 等规划模式的代码实现 Tool Use / Function Calling 的 JSON Schema 定义与解析 MCP (Model Context Protocol) 协议标准与实战 LangGraph 的 StateGraph 编程范式 Memory 系统的短期/长期记忆设计 Multi-Agent 协作模式 (Supervisor/Hierarchical) 边界说明 (参考 chapter-boundaries.md):
✅ 本章包含: Agent 架构设计、工具调用、MCP 协议、多智能体协作、Memory 机制 ❌ 不包含: CoT 数学原理 (→ Part 7 Ch3)、推理时搜索/MCTS (→ Part 7 Ch4)、强化学习训练 Agent (→ Part 7 Ch4) 目录# 一、从 Prompt Engineering 到 Agentic Workflow 二、规划 (Planning):ReAct 与 Plan-and-Solve 三、工具使用 (Tool Use) 与 Function Calling 四、MCP (Model Context Protocol) 革命 五、记忆系统 (Memory) 设计 六、LangGraph:状态机编程范式 6.1 StateGraph 核心概念 6.2 实战:基于 LangGraph 的 ReAct Agent 6.3 条件边与循环控制 6.4 持久化 (Persistence): Multi-turn 对话的基础 6.5 Human-in-the-loop: 敏感操作的审批机制 七、多智能体协作 (Multi-Agent) 八、Output Parser:结构化输出解析 九、本章小结 一、从 Prompt Engineering 到 Agentic Workflow# Andrew Ng 最近提出一个重要观点:与其追求更强的模型 (GPT-5),不如优化 Agent 工作流 (Agentic Workflow)。 GPT-3.5 + 良好的工作流,往往能超越零样本的 GPT-4。'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第3章 智能体（Agent）核心机制"><meta itemprop=description content='第3章:智能体(Agent)核心机制# “The future of AI is not just about better models, but about better systems.” - Andrew Ng
智能体(Agent)将 LLM 从"大脑"变成了"双手",让 AI 具备了与世界交互的能力。
本章导读# 本章专注于 Agent 设计模式与工程实现,是构建自主智能系统的核心技术。我们将深入探讨:
ReAct/Plan-and-Solve 等规划模式的代码实现 Tool Use / Function Calling 的 JSON Schema 定义与解析 MCP (Model Context Protocol) 协议标准与实战 LangGraph 的 StateGraph 编程范式 Memory 系统的短期/长期记忆设计 Multi-Agent 协作模式 (Supervisor/Hierarchical) 边界说明 (参考 chapter-boundaries.md):
✅ 本章包含: Agent 架构设计、工具调用、MCP 协议、多智能体协作、Memory 机制 ❌ 不包含: CoT 数学原理 (→ Part 7 Ch3)、推理时搜索/MCTS (→ Part 7 Ch4)、强化学习训练 Agent (→ Part 7 Ch4) 目录# 一、从 Prompt Engineering 到 Agentic Workflow 二、规划 (Planning):ReAct 与 Plan-and-Solve 三、工具使用 (Tool Use) 与 Function Calling 四、MCP (Model Context Protocol) 革命 五、记忆系统 (Memory) 设计 六、LangGraph:状态机编程范式 6.1 StateGraph 核心概念 6.2 实战:基于 LangGraph 的 ReAct Agent 6.3 条件边与循环控制 6.4 持久化 (Persistence): Multi-turn 对话的基础 6.5 Human-in-the-loop: 敏感操作的审批机制 七、多智能体协作 (Multi-Agent) 八、Output Parser:结构化输出解析 九、本章小结 一、从 Prompt Engineering 到 Agentic Workflow# Andrew Ng 最近提出一个重要观点:与其追求更强的模型 (GPT-5),不如优化 Agent 工作流 (Agentic Workflow)。 GPT-3.5 + 良好的工作流,往往能超越零样本的 GPT-4。'><meta itemprop=wordCount content="5127"><title>第3章 智能体（Agent）核心机制 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle checked>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle checked>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/ class=active>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第3章 智能体（Agent）核心机制</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#本章导读>本章导读</a></li><li><a href=#目录>目录</a></li><li><a href=#一从-prompt-engineering-到-agentic-workflow>一、从 Prompt Engineering 到 Agentic Workflow</a><ul><li><a href=#1-什么是-agentic-workflow>1. 什么是 Agentic Workflow?</a></li><li><a href=#2-四种核心设计模式>2. 四种核心设计模式</a></li></ul></li><li><a href=#二规划-planningreact-与-plan-and-solve>二、规划 (Planning):ReAct 与 Plan-and-Solve</a><ul><li><a href=#1-react-模式代码实现>1. ReAct 模式:代码实现</a><ul><li><a href=#1-prompt-模板>(1) Prompt 模板</a></li><li><a href=#2-完整实现-python-伪代码>(2) 完整实现 (Python 伪代码)</a></li></ul></li><li><a href=#2-plan-and-solve结构化规划>2. Plan-and-Solve:结构化规划</a><ul><li><a href=#1-prompt-模板-1>(1) Prompt 模板</a></li><li><a href=#2-实现>(2) 实现</a></li></ul></li><li><a href=#3-reflection自我反思机制>3. Reflection:自我反思机制</a><ul><li><a href=#1-reflexion-架构>(1) Reflexion 架构</a></li><li><a href=#2-output-parser-实现>(2) Output Parser 实现</a></li></ul></li></ul></li><li><a href=#三工具使用-tool-use-与-function-calling>三、工具使用 (Tool Use) 与 Function Calling</a><ul><li><a href=#1-json-schema-定义标准>1. JSON Schema 定义标准</a><ul><li><a href=#1-标准格式>(1) 标准格式</a></li><li><a href=#2-使用-pydantic-简化定义>(2) 使用 Pydantic 简化定义</a></li></ul></li><li><a href=#2-function-calling-协议详解>2. Function Calling 协议详解</a><ul><li><a href=#1-完整调用流程>(1) 完整调用流程</a></li></ul></li><li><a href=#3-工具调用完整流程实现>3. 工具调用完整流程实现</a><ul><li><a href=#1-langchain-实现>(1) LangChain 实现</a></li></ul></li></ul></li><li><a href=#四mcp-model-context-protocol-革命>四、MCP (Model Context Protocol) 革命</a><ul><li><a href=#1-mcp-协议标准>1. MCP 协议标准</a></li><li><a href=#2-实战实现一个-mcp-server>2. 实战:实现一个 MCP Server</a><ul><li><a href=#1-安装依赖>(1) 安装依赖</a></li><li><a href=#2-服务端代码>(2) 服务端代码</a></li><li><a href=#3-配置文件-用于-claude-desktop>(3) 配置文件 (用于 Claude Desktop)</a></li></ul></li><li><a href=#3-mcp-client-集成>3. MCP Client 集成</a><ul><li><a href=#1-在代码中连接-mcp-server>(1) 在代码中连接 MCP Server</a></li></ul></li></ul></li><li><a href=#五记忆系统-memory-设计>五、记忆系统 (Memory) 设计</a><ul><li><a href=#1-记忆类型短期与长期>1. 记忆类型:短期与长期</a></li><li><a href=#2-memory-架构设计>2. Memory 架构设计</a><ul><li><a href=#1-简单-memory会话级存储>(1) 简单 Memory:会话级存储</a></li><li><a href=#2-摘要记忆压缩历史>(2) 摘要记忆:压缩历史</a></li><li><a href=#3-向量记忆语义检索>(3) 向量记忆:语义检索</a></li></ul></li><li><a href=#3-memgpt虚拟内存管理>3. MemGPT:虚拟内存管理</a></li><li><a href=#4-实战实现可持久化的-memory>4. 实战:实现可持久化的 Memory</a></li></ul></li><li><a href=#六langgraph状态机编程范式>六、LangGraph:状态机编程范式</a><ul><li><a href=#1-stategraph-核心概念>1. StateGraph 核心概念</a></li><li><a href=#2-实战基于-langgraph-的-react-agent>2. 实战:基于 LangGraph 的 ReAct Agent</a></li><li><a href=#3-条件边与循环控制>3. 条件边与循环控制</a><ul><li><a href=#1-复杂条件路由>(1) 复杂条件路由</a></li><li><a href=#2-循环控制与最大步数>(2) 循环控制与最大步数</a></li><li><a href=#3-条件边深度实践-错误处理与重试机制>(3) 条件边深度实践: 错误处理与重试机制</a></li></ul></li><li><a href=#4-持久化-persistence-multi-turn-对话的基础>4. 持久化 (Persistence): Multi-turn 对话的基础</a><ul><li><a href=#1-使用-memorysaver-内存级持久化>(1) 使用 MemorySaver (内存级持久化)</a></li><li><a href=#2-使用-sqlitesaver-磁盘级持久化>(2) 使用 SqliteSaver (磁盘级持久化)</a></li><li><a href=#3-查看和管理历史状态>(3) 查看和管理历史状态</a></li><li><a href=#4-完整的多轮对话示例>(4) 完整的多轮对话示例</a></li></ul></li><li><a href=#5-human-in-the-loop-敏感操作的审批机制>5. Human-in-the-loop: 敏感操作的审批机制</a><ul><li><a href=#1-使用-interrupt_before-暂停执行>(1) 使用 interrupt_before 暂停执行</a></li><li><a href=#2-更优雅的审批流程-分离审批节点>(2) 更优雅的审批流程: 分离审批节点</a></li></ul></li></ul></li><li><a href=#七多智能体协作-multi-agent>七、多智能体协作 (Multi-Agent)</a><ul><li><a href=#1-为什么需要多-agent>1. 为什么需要多 Agent?</a></li><li><a href=#2-supervisor-模式实现>2. Supervisor 模式实现</a></li><li><a href=#3-hierarchical-agent-架构>3. Hierarchical Agent 架构</a></li><li><a href=#4-metagpt-与-autogen-简介>4. MetaGPT 与 AutoGen 简介</a><ul><li><a href=#1-metagpt-sop-驱动>(1) MetaGPT: SOP 驱动</a></li><li><a href=#2-autogen-对话编程>(2) AutoGen: 对话编程</a></li></ul></li></ul></li><li><a href=#八output-parser结构化输出解析>八、Output Parser:结构化输出解析</a><ul><li><a href=#1-pydantic-模型定义>1. Pydantic 模型定义</a></li></ul></li><li><a href=#九本章小结>九、本章小结</a><ul><li><a href=#核心要点>核心要点</a></li><li><a href=#技术栈总结>技术栈总结</a></li><li><a href=#下一步学习>下一步学习</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第3章智能体agent核心机制>第3章:智能体(Agent)核心机制<a class=anchor href=#%e7%ac%ac3%e7%ab%a0%e6%99%ba%e8%83%bd%e4%bd%93agent%e6%a0%b8%e5%bf%83%e6%9c%ba%e5%88%b6>#</a></h1><blockquote class=book-hint><p>&ldquo;The future of AI is not just about better models, but about better systems.&rdquo; - Andrew Ng</p><p>智能体(Agent)将 LLM 从"大脑"变成了"双手",让 AI 具备了与世界交互的能力。</p></blockquote><hr><h2 id=本章导读>本章导读<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%af%bc%e8%af%bb>#</a></h2><p>本章专注于 <strong>Agent 设计模式与工程实现</strong>,是构建自主智能系统的核心技术。我们将深入探讨:</p><ul><li><strong>ReAct/Plan-and-Solve</strong> 等规划模式的代码实现</li><li><strong>Tool Use / Function Calling</strong> 的 JSON Schema 定义与解析</li><li><strong>MCP (Model Context Protocol)</strong> 协议标准与实战</li><li><strong>LangGraph</strong> 的 StateGraph 编程范式</li><li><strong>Memory 系统</strong>的短期/长期记忆设计</li><li><strong>Multi-Agent</strong> 协作模式 (Supervisor/Hierarchical)</li></ul><p><strong>边界说明</strong> (参考 chapter-boundaries.md):</p><ul><li>✅ <strong>本章包含</strong>: Agent 架构设计、工具调用、MCP 协议、多智能体协作、Memory 机制</li><li>❌ <strong>不包含</strong>: CoT 数学原理 (→ Part 7 Ch3)、推理时搜索/MCTS (→ Part 7 Ch4)、强化学习训练 Agent (→ Part 7 Ch4)</li></ul><hr><h2 id=目录>目录<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><ul><li><a href=#%e4%b8%80%e4%bb%8e-prompt-engineering-%e5%88%b0-agentic-workflow>一、从 Prompt Engineering 到 Agentic Workflow</a></li><li><a href=#%e4%ba%8c%e8%a7%84%e5%88%92-planningreact-%e4%b8%8e-plan-and-solve>二、规划 (Planning):ReAct 与 Plan-and-Solve</a></li><li><a href=#%e4%b8%89%e5%b7%a5%e5%85%b7%e4%bd%bf%e7%94%a8-tool-use-%e4%b8%8e-function-calling>三、工具使用 (Tool Use) 与 Function Calling</a></li><li><a href=#%e5%9b%9bmcp-model-context-protocol-%e9%9d%a9%e5%91%bd>四、MCP (Model Context Protocol) 革命</a></li><li><a href=#%e4%ba%94%e8%ae%b0%e5%bf%86%e7%b3%bb%e7%bb%9f-memory-%e8%ae%be%e8%ae%a1>五、记忆系统 (Memory) 设计</a></li><li><a href=#%e5%85%adlanggraph%e7%8a%b6%e6%80%81%e6%9c%ba%e7%bc%96%e7%a8%8b%e8%8c%83%e5%bc%8f>六、LangGraph:状态机编程范式</a><ul><li>6.1 StateGraph 核心概念</li><li>6.2 实战:基于 LangGraph 的 ReAct Agent</li><li>6.3 条件边与循环控制</li><li>6.4 持久化 (Persistence): Multi-turn 对话的基础</li><li>6.5 Human-in-the-loop: 敏感操作的审批机制</li></ul></li><li><a href=#%e4%b8%83%e5%a4%9a%e6%99%ba%e8%83%bd%e4%bd%93%e5%8d%8f%e4%bd%9c-multi-agent>七、多智能体协作 (Multi-Agent)</a></li><li><a href=#%e5%85%aboutput-parser%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%ba%e8%a7%a3%e6%9e%90>八、Output Parser:结构化输出解析</a></li><li><a href=#%e4%b9%9d%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>九、本章小结</a></li></ul><hr><h2 id=一从-prompt-engineering-到-agentic-workflow>一、从 Prompt Engineering 到 Agentic Workflow<a class=anchor href=#%e4%b8%80%e4%bb%8e-prompt-engineering-%e5%88%b0-agentic-workflow>#</a></h2><p>Andrew Ng 最近提出一个重要观点:<strong>与其追求更强的模型 (GPT-5),不如优化 Agent 工作流 (Agentic Workflow)</strong>。
GPT-3.5 + 良好的工作流,往往能超越零样本的 GPT-4。</p><h3 id=1-什么是-agentic-workflow>1. 什么是 Agentic Workflow?<a class=anchor href=#1-%e4%bb%80%e4%b9%88%e6%98%af-agentic-workflow>#</a></h3><p><strong>对比理解</strong>:</p><ul><li><strong>Zero-Shot</strong>: 就像让一个人"一口气"写完一篇论文,不许查资料,不许修改</li><li><strong>Agentic Workflow</strong>: 让 LLM 进行<strong>迭代处理</strong> - 列提纲 → 查资料 → 写初稿 → 自我修改 → 定稿</li></ul><p><strong>核心差异</strong>: 允许 LLM 进行多轮迭代,每一步都可以反思和纠错。</p><h3 id=2-四种核心设计模式>2. 四种核心设计模式<a class=anchor href=#2-%e5%9b%9b%e7%a7%8d%e6%a0%b8%e5%bf%83%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f>#</a></h3><table><thead><tr><th>模式</th><th>核心思想</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Reflection</strong></td><td>让模型检查自己的输出</td><td>代码审查、论文润色</td></tr><tr><td><strong>Tool Use</strong></td><td>模型知道何时求助外部工具</td><td>计算器、搜索引擎、数据库查询</td></tr><tr><td><strong>Planning</strong></td><td>先拆解步骤,再逐一执行</td><td>复杂任务分解</td></tr><tr><td><strong>Multi-Agent</strong></td><td>不同角色协作完成任务</td><td>软件开发团队模拟</td></tr></tbody></table><hr><h2 id=二规划-planningreact-与-plan-and-solve>二、规划 (Planning):ReAct 与 Plan-and-Solve<a class=anchor href=#%e4%ba%8c%e8%a7%84%e5%88%92-planningreact-%e4%b8%8e-plan-and-solve>#</a></h2><h3 id=1-react-模式代码实现>1. ReAct 模式:代码实现<a class=anchor href=#1-react-%e6%a8%a1%e5%bc%8f%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0>#</a></h3><p>ReAct (Reason + Act) 是最经典的 Agent 模式,由 Yao et al. (2022) 提出。</p><p><strong>核心思想</strong>: Thought (思考) → Action (行动) → Observation (观察) 循环。</p><h4 id=1-prompt-模板>(1) Prompt 模板<a class=anchor href=#1-prompt-%e6%a8%a1%e6%9d%bf>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>REACT_PROMPT_TEMPLATE</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个问题求解助手。请按照以下格式回答:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Question: </span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 我需要思考如何解决这个问题
</span></span></span><span class=line><span class=cl><span class=s2>Action: [工具名称][参数]
</span></span></span><span class=line><span class=cl><span class=s2>Observation: [工具返回结果]
</span></span></span><span class=line><span class=cl><span class=s2>... (重复 Thought/Action/Observation 可多次)
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 我现在知道最终答案了
</span></span></span><span class=line><span class=cl><span class=s2>Final Answer: [最终答案]
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>可用工具:
</span></span></span><span class=line><span class=cl><span class=s2>- Search[query]: 搜索互联网
</span></span></span><span class=line><span class=cl><span class=s2>- Calculator[expression]: 计算数学表达式
</span></span></span><span class=line><span class=cl><span class=s2>- WikiLookup[term]: 查询维基百科
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>示例:
</span></span></span><span class=line><span class=cl><span class=s2>Question: 埃菲尔铁塔的高度是多少?它比上海中心大厦高多少?
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 我需要先查询埃菲尔铁塔的高度
</span></span></span><span class=line><span class=cl><span class=s2>Action: WikiLookup[埃菲尔铁塔]
</span></span></span><span class=line><span class=cl><span class=s2>Observation: 埃菲尔铁塔高 324 米
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 现在我需要查上海中心大厦的高度
</span></span></span><span class=line><span class=cl><span class=s2>Action: WikiLookup[上海中心大厦]
</span></span></span><span class=line><span class=cl><span class=s2>Observation: 上海中心大厦高 632 米
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 我需要计算差值
</span></span></span><span class=line><span class=cl><span class=s2>Action: Calculator[632 - 324]
</span></span></span><span class=line><span class=cl><span class=s2>Observation: 308
</span></span></span><span class=line><span class=cl><span class=s2>Thought: 我现在知道答案了
</span></span></span><span class=line><span class=cl><span class=s2>Final Answer: 埃菲尔铁塔高 324 米,比上海中心大厦矮 308 米。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>现在开始:
</span></span></span><span class=line><span class=cl><span class=s2>Question: </span><span class=si>{question}</span><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><h4 id=2-完整实现-python-伪代码>(2) 完整实现 (Python 伪代码)<a class=anchor href=#2-%e5%ae%8c%e6%95%b4%e5%ae%9e%e7%8e%b0-python-%e4%bc%aa%e4%bb%a3%e7%a0%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Callable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ReActAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>tools</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Callable</span><span class=p>],</span> <span class=n>max_steps</span><span class=o>=</span><span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>tools</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_steps</span> <span class=o>=</span> <span class=n>max_steps</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=n>REACT_PROMPT_TEMPLATE</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>question</span><span class=o>=</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>scratchpad</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>  <span class=c1># 记录思考过程</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>max_steps</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 1. LLM 生成下一步思考</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span> <span class=o>+</span> <span class=n>scratchpad</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>scratchpad</span> <span class=o>+=</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 2. 解析 Action</span>
</span></span><span class=line><span class=cl>            <span class=n>action_match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;Action: (\w+)\[(.*?)\]&#39;</span><span class=p>,</span> <span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;Final Answer:&#34;</span> <span class=ow>in</span> <span class=n>response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 找到最终答案,结束循环</span>
</span></span><span class=line><span class=cl>                <span class=n>answer</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;Final Answer:&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>answer</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>action_match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>tool_name</span> <span class=o>=</span> <span class=n>action_match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>tool_input</span> <span class=o>=</span> <span class=n>action_match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 3. 执行工具</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>tool_name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>observation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>[</span><span class=n>tool_name</span><span class=p>](</span><span class=n>tool_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>observation</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Error: Tool </span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2> not found&#34;</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=c1># 4. 添加 Observation 到 scratchpad</span>
</span></span><span class=line><span class=cl>                <span class=n>scratchpad</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Observation</span><span class=p>:</span> <span class=p>{</span><span class=n>observation</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>scratchpad</span> <span class=o>+=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>No</span> <span class=n>valid</span> <span class=n>action</span> <span class=n>found</span><span class=o>.</span> <span class=n>Please</span> <span class=k>try</span> <span class=n>again</span><span class=o>.</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Max steps reached. No answer found.&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例工具</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculator</span><span class=p>(</span><span class=n>expr</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>expr</span><span class=p>))</span>  <span class=c1># 生产环境请用 ast.literal_eval!</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟搜索</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Mock search result for &#39;</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>ReActAgent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>your_llm_instance</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;Calculator&#34;</span><span class=p>:</span> <span class=n>calculator</span><span class=p>,</span> <span class=s2>&#34;Search&#34;</span><span class=p>:</span> <span class=n>search</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=s2>&#34;如果我有 3 个苹果,买了 7 个橙子,一共多少水果?&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>局限性分析</strong>:</p><ul><li>短视: 只看下一步,缺乏全局观</li><li>死循环风险: 容易在两个步骤之间反复横跳</li><li>Token 消耗大: 每一步都要把整个 History 喂给模型</li></ul><h3 id=2-plan-and-solve结构化规划>2. Plan-and-Solve:结构化规划<a class=anchor href=#2-plan-and-solve%e7%bb%93%e6%9e%84%e5%8c%96%e8%a7%84%e5%88%92>#</a></h3><p><strong>核心思想</strong>: 先生成完整计划,再逐一执行,避免 ReAct 的短视问题。</p><h4 id=1-prompt-模板-1>(1) Prompt 模板<a class=anchor href=#1-prompt-%e6%a8%a1%e6%9d%bf-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>PLAN_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;请为以下任务生成详细的执行计划:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>任务: </span><span class=si>{task}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>可用工具:
</span></span></span><span class=line><span class=cl><span class=si>{tools_description}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请以 JSON 格式输出计划:
</span></span></span><span class=line><span class=cl><span class=s2>{{
</span></span></span><span class=line><span class=cl><span class=s2>  &#34;steps&#34;: [
</span></span></span><span class=line><span class=cl><span class=s2>    {{&#34;step&#34;: 1, &#34;action&#34;: &#34;tool_name&#34;, &#34;args&#34;: {{&#34;arg1&#34;: &#34;value&#34;}}, &#34;reason&#34;: &#34;原因&#34;}},
</span></span></span><span class=line><span class=cl><span class=s2>    {{&#34;step&#34;: 2, &#34;action&#34;: &#34;tool_name&#34;, &#34;args&#34;: {{&#34;arg1&#34;: &#34;value&#34;}}, &#34;reason&#34;: &#34;原因&#34;}}
</span></span></span><span class=line><span class=cl><span class=s2>  ]
</span></span></span><span class=line><span class=cl><span class=s2>}}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><h4 id=2-实现>(2) 实现<a class=anchor href=#2-%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PlanStep</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>step</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>action</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>args</span><span class=p>:</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Plan</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>PlanStep</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PlanAndSolveAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>tools</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Callable</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>tools</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 生成计划</span>
</span></span><span class=line><span class=cl>        <span class=n>plan_response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>PLAN_PROMPT</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>task</span><span class=o>=</span><span class=n>task</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tools_description</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_get_tools_description</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 解析计划</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>plan_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>plan_response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>plan</span> <span class=o>=</span> <span class=n>Plan</span><span class=p>(</span><span class=o>**</span><span class=n>plan_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Failed to parse plan: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. 执行计划</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=n>plan</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Step </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>step</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>step</span><span class=o>.</span><span class=n>reason</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>tool_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>[</span><span class=n>step</span><span class=o>.</span><span class=n>action</span><span class=p>](</span><span class=o>**</span><span class=n>step</span><span class=o>.</span><span class=n>args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>tool_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 4. 综合结果</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_synthesize_results</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_tools_description</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=o>-</span> <span class=p>{</span><span class=n>name</span><span class=p>}:</span> <span class=p>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__doc__</span><span class=p>}</span><span class=s2>&#34; for name, func in self.tools.items()])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_synthesize_results</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 让 LLM 综合结果</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Execution</span> <span class=n>results</span><span class=p>:</span> <span class=p>{</span><span class=n>results</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Please</span> <span class=n>provide</span> <span class=n>final</span> <span class=n>answer</span><span class=p>:</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span></span></span></code></pre></div><h3 id=3-reflection自我反思机制>3. Reflection:自我反思机制<a class=anchor href=#3-reflection%e8%87%aa%e6%88%91%e5%8f%8d%e6%80%9d%e6%9c%ba%e5%88%b6>#</a></h3><p>Reflection 让 Agent 具备"自我纠错"能力,核心是引入 <strong>Evaluator</strong> 和 <strong>Self-Reflection</strong> 步骤。</p><h4 id=1-reflexion-架构>(1) Reflexion 架构<a class=anchor href=#1-reflexion-%e6%9e%b6%e6%9e%84>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ReflexionAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>tools</span><span class=p>,</span> <span class=n>max_trials</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>tools</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_trials</span> <span class=o>=</span> <span class=n>max_trials</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>memory</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 存储反思经验</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>trial</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>max_trials</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>===</span> <span class=n>Trial</span> <span class=p>{</span><span class=n>trial</span> <span class=o>+</span> <span class=mi>1</span><span class=p>}</span> <span class=o>===</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 1. 尝试执行任务 (带上之前的经验)</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_build_context</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_attempt_task</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 2. 评估结果</span>
</span></span><span class=line><span class=cl>            <span class=n>is_success</span><span class=p>,</span> <span class=n>feedback</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_evaluate</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>is_success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 3. 失败则进行反思</span>
</span></span><span class=line><span class=cl>            <span class=n>reflection</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_reflect</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>result</span><span class=p>,</span> <span class=n>feedback</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>reflection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Reflection: </span><span class=si>{</span><span class=n>reflection</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Failed after </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>max_trials</span><span class=si>}</span><span class=s2> trials&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_build_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>lessons</span> <span class=o>=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=o>-</span> <span class=p>{</span><span class=n>r</span><span class=p>}</span><span class=s2>&#34; for r in self.memory])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Previous failures and lessons learned:
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>lessons</span> <span class=k>if</span> <span class=n>lessons</span> <span class=k>else</span> <span class=s2>&#34;None&#34;</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Please try to solve the task while avoiding previous mistakes.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_attempt_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 ReAct 或其他方式执行</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_evaluate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>bool</span><span class=p>,</span> <span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;评估结果是否成功&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>eval_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Is this result correct and complete? Answer with:
</span></span></span><span class=line><span class=cl><span class=s2>- SUCCESS: if correct
</span></span></span><span class=line><span class=cl><span class=s2>- FAILURE: reason why it failed&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>eval_response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>eval_prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;SUCCESS&#34;</span> <span class=ow>in</span> <span class=n>eval_response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span><span class=p>,</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span><span class=p>,</span> <span class=n>eval_response</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_reflect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>feedback</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成反思&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>reflect_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;You failed at the following task:
</span></span></span><span class=line><span class=cl><span class=s2>Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Your result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Feedback: </span><span class=si>{</span><span class=n>feedback</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Please analyze what went wrong and provide a lesson for next time.
</span></span></span><span class=line><span class=cl><span class=s2>Focus on:
</span></span></span><span class=line><span class=cl><span class=s2>1. What assumption was incorrect?
</span></span></span><span class=line><span class=cl><span class=s2>2. What should you do differently next time?
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Reflection:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>reflect_prompt</span><span class=p>)</span></span></span></code></pre></div><h4 id=2-output-parser-实现>(2) Output Parser 实现<a class=anchor href=#2-output-parser-%e5%ae%9e%e7%8e%b0>#</a></h4><p>为了确保 LLM 输出符合预期格式,我们需要 <strong>结构化解析器</strong>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.output_parsers</span> <span class=kn>import</span> <span class=n>PydanticOutputParser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>validator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ReflectionOutput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;SUCCESS or FAILURE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;Reason for success/failure&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>lesson</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Lesson learned if failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;status&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_status</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;SUCCESS&#34;</span><span class=p>,</span> <span class=s2>&#34;FAILURE&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Status must be SUCCESS or FAILURE&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 Parser</span>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>PydanticOutputParser</span><span class=p>(</span><span class=n>pydantic_object</span><span class=o>=</span><span class=n>ReflectionOutput</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>format_instructions</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>get_format_instructions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在 Prompt 中加入格式说明</span>
</span></span><span class=line><span class=cl><span class=n>eval_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>format_instructions</span><span class=si>}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解析输出</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>parsed</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>llm_output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>parsed</span><span class=o>.</span><span class=n>status</span><span class=p>,</span> <span class=n>parsed</span><span class=o>.</span><span class=n>reason</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Parsing failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=三工具使用-tool-use-与-function-calling>三、工具使用 (Tool Use) 与 Function Calling<a class=anchor href=#%e4%b8%89%e5%b7%a5%e5%85%b7%e4%bd%bf%e7%94%a8-tool-use-%e4%b8%8e-function-calling>#</a></h2><h3 id=1-json-schema-定义标准>1. JSON Schema 定义标准<a class=anchor href=#1-json-schema-%e5%ae%9a%e4%b9%89%e6%a0%87%e5%87%86>#</a></h3><p>OpenAI 的 Function Calling 使用 <strong>JSON Schema</strong> 定义工具接口。</p><h4 id=1-标准格式>(1) 标准格式<a class=anchor href=#1-%e6%a0%87%e5%87%86%e6%a0%bc%e5%bc%8f>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;function&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;function&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get_weather&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;获取指定城市的当前天气&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;parameters&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;city&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;城市名称,例如: Beijing, Shanghai&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;unit&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;enum&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;celsius&#34;</span><span class=p>,</span> <span class=s2>&#34;fahrenheit&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;温度单位&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;city&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;additionalProperties&#34;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;function&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;function&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;search_web&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;在互联网上搜索信息&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;parameters&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;搜索关键词&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;max_results&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;integer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;返回结果数量&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;default&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;minimum&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;maximum&#34;</span><span class=p>:</span> <span class=mi>20</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><h4 id=2-使用-pydantic-简化定义>(2) 使用 Pydantic 简化定义<a class=anchor href=#2-%e4%bd%bf%e7%94%a8-pydantic-%e7%ae%80%e5%8c%96%e5%ae%9a%e4%b9%89>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GetWeatherInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>city</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;城市名称,例如: Beijing, Shanghai&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>unit</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=s2>&#34;celsius&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;温度单位&#34;</span><span class=p>,</span> <span class=n>enum</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;celsius&#34;</span><span class=p>,</span> <span class=s2>&#34;fahrenheit&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchWebInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;搜索关键词&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;返回结果数量&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自动生成 JSON Schema</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic.json_schema</span> <span class=kn>import</span> <span class=n>JsonSchemaValue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>pydantic_to_openai_schema</span><span class=p>(</span><span class=n>model</span><span class=p>:</span> <span class=nb>type</span><span class=p>[</span><span class=n>BaseModel</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>schema</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>model_json_schema</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;function&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;function&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=n>model</span><span class=o>.</span><span class=vm>__doc__</span> <span class=ow>or</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;parameters&#34;</span><span class=p>:</span> <span class=n>schema</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>pydantic_to_openai_schema</span><span class=p>(</span><span class=n>GetWeatherInput</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>pydantic_to_openai_schema</span><span class=p>(</span><span class=n>SearchWebInput</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><h3 id=2-function-calling-协议详解>2. Function Calling 协议详解<a class=anchor href=#2-function-calling-%e5%8d%8f%e8%ae%ae%e8%af%a6%e8%a7%a3>#</a></h3><h4 id=1-完整调用流程>(1) 完整调用流程<a class=anchor href=#1-%e5%ae%8c%e6%95%b4%e8%b0%83%e7%94%a8%e6%b5%81%e7%a8%8b>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>openai</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_weather</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>unit</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;celsius&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟天气 API</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;city&#34;</span><span class=p>:</span> <span class=n>city</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;temperature&#34;</span><span class=p>:</span> <span class=mi>25</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;unit&#34;</span><span class=p>:</span> <span class=n>unit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;condition&#34;</span><span class=p>:</span> <span class=s2>&#34;sunny&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_web</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟搜索 API</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;results&#34;</span><span class=p>:</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;Result </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2> for </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_results</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 工具映射</span>
</span></span><span class=line><span class=cl><span class=n>available_functions</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;get_weather&#34;</span><span class=p>:</span> <span class=n>get_weather</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;search_web&#34;</span><span class=p>:</span> <span class=n>search_web</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一轮: 让模型决定调用什么工具</span>
</span></span><span class=line><span class=cl><span class=n>messages</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;北京今天天气怎么样?&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=o>=</span><span class=n>messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_choice</span><span class=o>=</span><span class=s2>&#34;auto&#34;</span>  <span class=c1># 让模型自动决定</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查是否要调用工具</span>
</span></span><span class=line><span class=cl><span class=n>response_message</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span>
</span></span><span class=line><span class=cl><span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>response_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>response_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 第二轮: 执行工具并返回结果</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>response_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>function_name</span> <span class=o>=</span> <span class=n>tool_call</span><span class=o>.</span><span class=n>function</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=n>function_args</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>tool_call</span><span class=o>.</span><span class=n>function</span><span class=o>.</span><span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Calling </span><span class=si>{</span><span class=n>function_name</span><span class=si>}</span><span class=s2> with </span><span class=si>{</span><span class=n>function_args</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 执行工具</span>
</span></span><span class=line><span class=cl>        <span class=n>function_response</span> <span class=o>=</span> <span class=n>available_functions</span><span class=p>[</span><span class=n>function_name</span><span class=p>](</span><span class=o>**</span><span class=n>function_args</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加工具结果到对话</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;tool&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;tool_call_id&#34;</span><span class=p>:</span> <span class=n>tool_call</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>function_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>function_response</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 第三轮: 让模型综合工具结果给出最终答案</span>
</span></span><span class=line><span class=cl>    <span class=n>final_response</span> <span class=o>=</span> <span class=n>openai</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>=</span><span class=n>messages</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>final_response</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>message</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><h3 id=3-工具调用完整流程实现>3. 工具调用完整流程实现<a class=anchor href=#3-%e5%b7%a5%e5%85%b7%e8%b0%83%e7%94%a8%e5%ae%8c%e6%95%b4%e6%b5%81%e7%a8%8b%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=1-langchain-实现>(1) LangChain 实现<a class=anchor href=#1-langchain-%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_openai_functions_agent</span><span class=p>,</span> <span class=n>AgentExecutor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span><span class=p>,</span> <span class=n>MessagesPlaceholder</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculator</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算数学表达式,例如: 3 * (2 + 5)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>)</span>  <span class=c1># 生产环境使用 ast.literal_eval</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Result: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_current_time</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取当前时间&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s2>&#34;%Y-%m-</span><span class=si>%d</span><span class=s2> %H:%M:%S&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 Agent</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>calculator</span><span class=p>,</span> <span class=n>get_current_time</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_messages</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=s2>&#34;你是一个智能助手,可以使用工具来帮助用户。&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;human&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>{input}</span><span class=s2>&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>MessagesPlaceholder</span><span class=p>(</span><span class=n>variable_name</span><span class=o>=</span><span class=s2>&#34;agent_scratchpad&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_openai_functions_agent</span><span class=p>(</span><span class=n>llm</span><span class=p>,</span> <span class=n>tools</span><span class=p>,</span> <span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>agent_executor</span> <span class=o>=</span> <span class=n>AgentExecutor</span><span class=p>(</span><span class=n>agent</span><span class=o>=</span><span class=n>agent</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent_executor</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=s2>&#34;现在几点?计算 (3 + 5) * 2 的结果&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>])</span></span></span></code></pre></div><hr><h2 id=四mcp-model-context-protocol-革命>四、MCP (Model Context Protocol) 革命<a class=anchor href=#%e5%9b%9bmcp-model-context-protocol-%e9%9d%a9%e5%91%bd>#</a></h2><h3 id=1-mcp-协议标准>1. MCP 协议标准<a class=anchor href=#1-mcp-%e5%8d%8f%e8%ae%ae%e6%a0%87%e5%87%86>#</a></h3><p>2024年底,Anthropic 推出了 <strong>MCP (Model Context Protocol)</strong>,这是一个开放标准,旨在统一 <strong>AI 模型</strong> 与 <strong>数据源/工具</strong> 之间的连接。</p><p><strong>核心价值</strong>:</p><ul><li>类似于 USB 协议: 一次编写,处处运行</li><li>数据源和工具可以无缝接入任何支持 MCP 的 LLM</li><li>避免为每个 LLM 单独开发插件</li></ul><p><strong>架构</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────┐
</span></span><span class=line><span class=cl>│  MCP Client     │  (Claude Desktop, Cursor, VS Code)
</span></span><span class=line><span class=cl>│  (LLM App)      │
</span></span><span class=line><span class=cl>└────────┬────────┘
</span></span><span class=line><span class=cl>         │ MCP Protocol
</span></span><span class=line><span class=cl>         │
</span></span><span class=line><span class=cl>┌────────┴────────┐
</span></span><span class=line><span class=cl>│  MCP Server     │  (Google Drive, Slack, Postgres, File System)
</span></span><span class=line><span class=cl>│  (Tool/Data)    │
</span></span><span class=line><span class=cl>└─────────────────┘</span></span></code></pre></div><p><strong>核心概念</strong>:</p><ul><li><strong>Resources</strong>: 数据源 (文件、数据库记录、API 端点)</li><li><strong>Tools</strong>: 可执行的函数</li><li><strong>Prompts</strong>: 预定义的提示词模板</li></ul><h3 id=2-实战实现一个-mcp-server>2. 实战:实现一个 MCP Server<a class=anchor href=#2-%e5%ae%9e%e6%88%98%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aa-mcp-server>#</a></h3><p>我们用 Python <code>mcp</code> 库写一个文件系统 MCP Server。</p><h4 id=1-安装依赖>(1) 安装依赖<a class=anchor href=#1-%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install mcp</span></span></code></pre></div><h4 id=2-服务端代码>(2) 服务端代码<a class=anchor href=#2-%e6%9c%8d%e5%8a%a1%e7%ab%af%e4%bb%a3%e7%a0%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># file_system_mcp_server.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.fastmcp</span> <span class=kn>import</span> <span class=n>FastMCP</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 MCP Server</span>
</span></span><span class=line><span class=cl><span class=n>mcp</span> <span class=o>=</span> <span class=n>FastMCP</span><span class=p>(</span><span class=s2>&#34;FileSystemServer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@mcp.tool</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_file</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    读取文件内容
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        path: 文件路径
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        文件内容或错误信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;File content (</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span><span class=si>}</span><span class=s2> chars):</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>content</span><span class=p>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error reading file: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@mcp.tool</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_file</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    写入文件
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        path: 文件路径
</span></span></span><span class=line><span class=cl><span class=s2>        content: 要写入的内容
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        成功或错误信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>dirname</span><span class=p>(</span><span class=n>path</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Successfully wrote </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span><span class=si>}</span><span class=s2> chars to </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error writing file: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@mcp.tool</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_directory</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;.&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    列出目录内容
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        path: 目录路径 (默认为当前目录)
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        文件列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>listdir</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;📄 </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>isfile</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=n>item</span><span class=p>))</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;📁 </span><span class=si>{</span><span class=n>item</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>items</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Directory &#39;</span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>&#39; contains </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>items</span><span class=p>)</span><span class=si>}</span><span class=s2> items:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34; + &#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join(files)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error listing directory: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@mcp.resource</span><span class=p>(</span><span class=s2>&#34;file://</span><span class=si>{path}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_file_resource</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    提供文件作为资源
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行 Server</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Starting File System MCP Server...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mcp</span><span class=o>.</span><span class=n>run</span><span class=p>()</span></span></span></code></pre></div><h4 id=3-配置文件-用于-claude-desktop>(3) 配置文件 (用于 Claude Desktop)<a class=anchor href=#3-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6-%e7%94%a8%e4%ba%8e-claude-desktop>#</a></h4><p>在 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code> 中添加:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;mcpServers&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;filesystem&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;command&#34;</span><span class=p>:</span> <span class=s2>&#34;python3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;args&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;/path/to/file_system_mcp_server.py&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=3-mcp-client-集成>3. MCP Client 集成<a class=anchor href=#3-mcp-client-%e9%9b%86%e6%88%90>#</a></h3><h4 id=1-在代码中连接-mcp-server>(1) 在代码中连接 MCP Server<a class=anchor href=#1-%e5%9c%a8%e4%bb%a3%e7%a0%81%e4%b8%ad%e8%bf%9e%e6%8e%a5-mcp-server>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>ClientSession</span><span class=p>,</span> <span class=n>StdioServerParameters</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.client.stdio</span> <span class=kn>import</span> <span class=n>stdio_client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>use_mcp_server</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 连接到 MCP Server</span>
</span></span><span class=line><span class=cl>    <span class=n>server_params</span> <span class=o>=</span> <span class=n>StdioServerParameters</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>command</span><span class=o>=</span><span class=s2>&#34;python3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>args</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;file_system_mcp_server.py&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>stdio_client</span><span class=p>(</span><span class=n>server_params</span><span class=p>)</span> <span class=k>as</span> <span class=p>(</span><span class=n>read</span><span class=p>,</span> <span class=n>write</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=n>ClientSession</span><span class=p>(</span><span class=n>read</span><span class=p>,</span> <span class=n>write</span><span class=p>)</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 初始化</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>initialize</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 列出可用工具</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>list_tools</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Available tools:&#34;</span><span class=p>,</span> <span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>name</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>tools</span><span class=o>.</span><span class=n>tools</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 调用工具</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=s2>&#34;list_directory&#34;</span><span class=p>,</span> <span class=p>{</span><span class=s2>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;.&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 读取资源</span>
</span></span><span class=line><span class=cl>            <span class=n>resources</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>list_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>resources</span><span class=o>.</span><span class=n>resources</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>resources</span><span class=o>.</span><span class=n>resources</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>content</span><span class=o>.</span><span class=n>contents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>use_mcp_server</span><span class=p>())</span></span></span></code></pre></div><hr><h2 id=五记忆系统-memory-设计>五、记忆系统 (Memory) 设计<a class=anchor href=#%e4%ba%94%e8%ae%b0%e5%bf%86%e7%b3%bb%e7%bb%9f-memory-%e8%ae%be%e8%ae%a1>#</a></h2><h3 id=1-记忆类型短期与长期>1. 记忆类型:短期与长期<a class=anchor href=#1-%e8%ae%b0%e5%bf%86%e7%b1%bb%e5%9e%8b%e7%9f%ad%e6%9c%9f%e4%b8%8e%e9%95%bf%e6%9c%9f>#</a></h3><p><strong>人类记忆体系</strong>:</p><ul><li><strong>感官记忆</strong> (Sensory Memory): 毫秒级,瞬间消失</li><li><strong>短期记忆</strong> (Short-term / Working Memory): 秒到分钟级,容量有限 (约 7±2 chunks)</li><li><strong>长期记忆</strong> (Long-term Memory):<ul><li><strong>陈述性记忆</strong> (Declarative): 事实和事件<ul><li><strong>语义记忆</strong>: 世界知识 (巴黎是法国的首都)</li><li><strong>情景记忆</strong>: 个人经历 (我上周去了巴黎)</li></ul></li><li><strong>程序性记忆</strong> (Procedural): 技能 (如何骑自行车)</li></ul></li></ul><p><strong>Agent 记忆映射</strong>:</p><table><thead><tr><th>人类记忆</th><th>Agent 实现</th><th>技术方案</th></tr></thead><tbody><tr><td>短期记忆</td><td>Context Window</td><td>直接存储在 Prompt 中 (最近几轮对话)</td></tr><tr><td>语义记忆</td><td>World Knowledge</td><td>模型预训练权重 + RAG 知识库</td></tr><tr><td>情景记忆</td><td>Experience Buffer</td><td>向量数据库 (存储过往交互)</td></tr><tr><td>程序性记忆</td><td>Skill Library</td><td>微调权重 + Tool Definitions</td></tr></tbody></table><h3 id=2-memory-架构设计>2. Memory 架构设计<a class=anchor href=#2-memory-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h3><h4 id=1-简单-memory会话级存储>(1) 简单 Memory:会话级存储<a class=anchor href=#1-%e7%ae%80%e5%8d%95-memory%e4%bc%9a%e8%af%9d%e7%ba%a7%e5%ad%98%e5%82%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationBufferMemory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SimpleMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_turns</span><span class=o>=</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_turns</span> <span class=o>=</span> <span class=n>max_turns</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=n>role</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>content</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=c1># 保持窗口大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_turns</span> <span class=o>*</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=bp>self</span><span class=o>.</span><span class=n>max_turns</span> <span class=o>*</span> <span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_history</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;role&#39;</span><span class=p>]}:</span> <span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]}</span><span class=s2>&#34; for m in self.messages])</span></span></span></code></pre></div><h4 id=2-摘要记忆压缩历史>(2) 摘要记忆:压缩历史<a class=anchor href=#2-%e6%91%98%e8%a6%81%e8%ae%b0%e5%bf%86%e5%8e%8b%e7%bc%a9%e5%8e%86%e5%8f%b2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.memory</span> <span class=kn>import</span> <span class=n>ConversationSummaryMemory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SummaryMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>max_token_limit</span><span class=o>=</span><span class=mi>2000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>summary</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_token_limit</span> <span class=o>=</span> <span class=n>max_token_limit</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=n>role</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>content</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否需要压缩</span>
</span></span><span class=line><span class=cl>        <span class=n>total_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_estimate_tokens</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>total_tokens</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_token_limit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_compress_history</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_estimate_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简单估算: 1 token ≈ 4 chars</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>summary</span> <span class=o>+</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([m[&#39;content&#39;] for m in self.messages])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=o>//</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_compress_history</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;压缩历史为摘要&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>history_text</span> <span class=o>=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;role&#39;</span><span class=p>]}:</span> <span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]}</span><span class=s2>&#34; for m in self.messages])</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Please summarize the following conversation history concisely:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>history_text</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Summary:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>new_summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 更新</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>summary</span> <span class=o>=</span> <span class=n>new_summary</span> <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>summary</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>summary</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>new_summary</span><span class=p>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>messages</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 清空已压缩的消息</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_context</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>recent</span> <span class=o>=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;role&#39;</span><span class=p>]}:</span> <span class=p>{</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]}</span><span class=s2>&#34; for m in self.messages])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>summary</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Previous summary:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=bp>self</span><span class=o>.</span><span class=n>summary</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Recent</span> <span class=n>messages</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>recent</span><span class=p>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>recent</span></span></span></code></pre></div><h4 id=3-向量记忆语义检索>(3) 向量记忆:语义检索<a class=anchor href=#3-%e5%90%91%e9%87%8f%e8%ae%b0%e5%bf%86%e8%af%ad%e4%b9%89%e6%a3%80%e7%b4%a2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.vectorstores</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.embeddings</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.schema</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>VectorMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>collection_name</span><span class=o>=</span><span class=s2>&#34;agent_memory&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>collection_name</span><span class=o>=</span><span class=n>collection_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embedding_function</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_experience</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>metadata</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加经验到长期记忆&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>doc</span> <span class=o>=</span> <span class=n>Document</span><span class=p>(</span><span class=n>page_content</span><span class=o>=</span><span class=n>content</span><span class=p>,</span> <span class=n>metadata</span><span class=o>=</span><span class=n>metadata</span> <span class=ow>or</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>add_documents</span><span class=p>([</span><span class=n>doc</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>retrieve_relevant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检索相关经验&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_context_for_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;为当前查询构建记忆上下文&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_memories</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retrieve_relevant</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>relevant_memories</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Relevant past experiences:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34; + &#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;- </span><span class=si>{</span><span class=n>mem</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>mem</span> <span class=ow>in</span> <span class=n>relevant_memories</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span></span></span></code></pre></div><h3 id=3-memgpt虚拟内存管理>3. MemGPT:虚拟内存管理<a class=anchor href=#3-memgpt%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86>#</a></h3><p>MemGPT (Packer et al., 2023) 提出了类似操作系统的<strong>虚拟内存管理</strong>机制。</p><p><strong>核心概念</strong>:</p><ul><li><strong>Main Context</strong> (主上下文): 相当于 RAM,存放当前活跃信息</li><li><strong>Archival Memory</strong> (归档记忆): 相当于 Disk,存放历史信息</li><li><strong>Recall Memory</strong> (召回记忆): 核心工作记忆</li></ul><p><strong>架构图</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────┐
</span></span><span class=line><span class=cl>│  Main Context (Limited Size)   │
</span></span><span class=line><span class=cl>│  ┌─────────────────────────┐   │
</span></span><span class=line><span class=cl>│  │ System Prompt           │   │
</span></span><span class=line><span class=cl>│  │ Recent Messages         │   │
</span></span><span class=line><span class=cl>│  │ Recalled Memories       │   │
</span></span><span class=line><span class=cl>│  └─────────────────────────┘   │
</span></span><span class=line><span class=cl>└──────────┬──────────────────────┘
</span></span><span class=line><span class=cl>           │
</span></span><span class=line><span class=cl>           │ memory_insert() / memory_search()
</span></span><span class=line><span class=cl>           │
</span></span><span class=line><span class=cl>┌──────────▼──────────────────────┐
</span></span><span class=line><span class=cl>│  Archival Memory (Unlimited)   │
</span></span><span class=line><span class=cl>│  (Vector Database)              │
</span></span><span class=line><span class=cl>│  - Past conversations           │
</span></span><span class=line><span class=cl>│  - Knowledge snippets           │
</span></span><span class=line><span class=cl>│  - Reflections                  │
</span></span><span class=line><span class=cl>└─────────────────────────────────┘</span></span></code></pre></div><p><strong>实现示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemGPTAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>vector_memory</span><span class=p>:</span> <span class=n>VectorMemory</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_memory</span> <span class=o>=</span> <span class=n>vector_memory</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>main_context</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_context_size</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 定义记忆管理工具</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;archival_memory_insert&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>archival_memory_insert</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;archival_memory_search&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>archival_memory_search</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;core_memory_append&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>core_memory_append</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;core_memory_replace&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>core_memory_replace</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>archival_memory_insert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将信息存入长期记忆&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_memory</span><span class=o>.</span><span class=n>add_experience</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Inserted into archival memory: </span><span class=si>{</span><span class=n>content</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>archival_memory_search</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;搜索长期记忆&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_memory</span><span class=o>.</span><span class=n>retrieve_relevant</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join(results)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>core_memory_append</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加到核心工作记忆&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果超出大小,触发归档</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_context_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>archived</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>archival_memory_insert</span><span class=p>(</span><span class=n>archived</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Archived old memory, added new: </span><span class=si>{</span><span class=n>content</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Added to core memory: </span><span class=si>{</span><span class=n>content</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>core_memory_replace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>old</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>new</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;替换核心记忆内容&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>idx</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=o>.</span><span class=n>index</span><span class=p>(</span><span class=n>old</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>new</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Replaced memory successfully&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;Old memory not found&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 搜索相关长期记忆</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_memories</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_memory</span><span class=o>.</span><span class=n>get_context_for_query</span><span class=p>(</span><span class=n>user_input</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 构建 Prompt</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Core memory:
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=nb>chr</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>main_context</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>relevant_memories</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>User: </span><span class=si>{</span><span class=n>user_input</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>You can use the following tools to manage your memory:
</span></span></span><span class=line><span class=cl><span class=s2>- archival_memory_insert(content): Save information for long-term
</span></span></span><span class=line><span class=cl><span class=s2>- archival_memory_search(query): Search past experiences
</span></span></span><span class=line><span class=cl><span class=s2>- core_memory_append(content): Add to working memory
</span></span></span><span class=line><span class=cl><span class=s2>- core_memory_replace(old, new): Update working memory
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Response:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. LLM 生成响应</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 4. 解析并执行工具调用 (简化版,实际需要更完善的解析)</span>
</span></span><span class=line><span class=cl>        <span class=c1># ... tool execution logic ...</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span></span></span></code></pre></div><h3 id=4-实战实现可持久化的-memory>4. 实战:实现可持久化的 Memory<a class=anchor href=#4-%e5%ae%9e%e6%88%98%e5%ae%9e%e7%8e%b0%e5%8f%af%e6%8c%81%e4%b9%85%e5%8c%96%e7%9a%84-memory>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PersistentMemory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>storage_dir</span><span class=o>=</span><span class=s2>&#34;./memory_store&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>session_id</span> <span class=o>=</span> <span class=n>session_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>storage_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>storage_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>storage_dir</span><span class=o>.</span><span class=n>mkdir</span><span class=p>(</span><span class=n>exist_ok</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span> <span class=o>=</span> <span class=p>[]</span>  <span class=c1># 短期记忆</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span> <span class=o>=</span> <span class=p>[]</span>   <span class=c1># 长期记忆</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_interaction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_msg</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>assistant_msg</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加交互记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>interaction</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>user_msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;assistant&#34;</span><span class=p>:</span> <span class=n>assistant_msg</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>interaction</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持短期记忆窗口大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>short_term</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 将最旧的移到长期记忆</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>short_term</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>include_long_term</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取记忆上下文&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;Recent conversation:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;User: </span><span class=si>{</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=n>Assistant</span><span class=p>:</span> <span class=p>{</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;assistant&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>include_long_term</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span> <span class=o>+=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Earlier</span> <span class=ow>in</span> <span class=n>this</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span><span class=p>[</span><span class=o>-</span><span class=mi>3</span><span class=p>:]:</span>  <span class=c1># 只取最近 3 条</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;User: </span><span class=si>{</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;user&#39;</span><span class=p>]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=n>Assistant</span><span class=p>:</span> <span class=p>{</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;assistant&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保存到磁盘&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;session_id&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>session_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;short_term&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;long_term&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;last_updated&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>file_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>storage_dir</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>session_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s2>&#34;w&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;从磁盘加载&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>file_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>storage_dir</span> <span class=o>/</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>session_id</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>file_path</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;short_term&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;long_term&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clear</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;清除记忆&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>short_term</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>long_term</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>save</span><span class=p>()</span></span></span></code></pre></div><hr><h2 id=六langgraph状态机编程范式>六、LangGraph:状态机编程范式<a class=anchor href=#%e5%85%adlanggraph%e7%8a%b6%e6%80%81%e6%9c%ba%e7%bc%96%e7%a8%8b%e8%8c%83%e5%bc%8f>#</a></h2><p>LangGraph 是当前构建 Agent 的核心框架,由 LangChain 团队开发。</p><h3 id=1-stategraph-核心概念>1. StateGraph 核心概念<a class=anchor href=#1-stategraph-%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5>#</a></h3><p><strong>核心思想</strong>: Agent 工作流是一个<strong>有向图</strong> (Directed Graph),其中:</p><ul><li><strong>节点 (Node)</strong>: 执行特定操作 (调用 LLM、执行工具、处理数据)</li><li><strong>边 (Edge)</strong>: 控制流转 (固定边、条件边)</li><li><strong>状态 (State)</strong>: 在节点间传递的数据</li></ul><p><strong>架构图</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>START → Agent → should_continue? ─Yes→ Tools → Agent
</span></span><span class=line><span class=cl>                       │
</span></span><span class=line><span class=cl>                       No
</span></span><span class=line><span class=cl>                       ↓
</span></span><span class=line><span class=cl>                      END</span></span></code></pre></div><h3 id=2-实战基于-langgraph-的-react-agent>2. 实战:基于 LangGraph 的 ReAct Agent<a class=anchor href=#2-%e5%ae%9e%e6%88%98%e5%9f%ba%e4%ba%8e-langgraph-%e7%9a%84-react-agent>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>TypedDict</span><span class=p>,</span> <span class=n>Annotated</span><span class=p>,</span> <span class=n>Sequence</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>BaseMessage</span><span class=p>,</span> <span class=n>HumanMessage</span><span class=p>,</span> <span class=n>AIMessage</span><span class=p>,</span> <span class=n>ToolMessage</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.graph</span> <span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>ToolExecutor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 定义状态</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>],</span> <span class=s2>&#34;对话历史&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>next_action</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># &#34;continue&#34; or &#34;end&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 定义工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculator</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算数学表达式,例如: 3 * (2 + 5)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;计算结果: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;计算错误: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_weather</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取城市天气 (模拟)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2> 的天气: 晴天,温度 25°C&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>calculator</span><span class=p>,</span> <span class=n>get_weather</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>tool_executor</span> <span class=o>=</span> <span class=n>ToolExecutor</span><span class=p>(</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建 LLM (支持 function calling)</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>llm_with_tools</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>bind_tools</span><span class=p>(</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 定义节点函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>call_agent</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent 决策节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>llm_with_tools</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>response</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_tools</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工具执行节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 执行所有工具调用</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>tool_executor</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>tool_call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>tool_call_id</span><span class=o>=</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>tool_results</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 定义条件边</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_continue</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;判断是否继续&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 如果 LLM 调用了工具,则继续</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>last_message</span><span class=p>,</span> <span class=s2>&#34;tool_calls&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;continue&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 构建图</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>AgentState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加节点</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>,</span> <span class=n>call_agent</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;tools&#34;</span><span class=p>,</span> <span class=n>execute_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加边</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 条件边: agent → continue → tools 或 agent → end</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>should_continue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;continue&#34;</span><span class=p>:</span> <span class=s2>&#34;tools&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;end&#34;</span><span class=p>:</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 固定边: tools → agent (形成循环)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;tools&#34;</span><span class=p>,</span> <span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 编译</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 运行</span>
</span></span><span class=line><span class=cl><span class=n>initial_state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;北京天气如何?计算 (3 + 5) * 2 的结果&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>output</span> <span class=ow>in</span> <span class=n>app</span><span class=o>.</span><span class=n>stream</span><span class=p>(</span><span class=n>initial_state</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>output</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Output from node &#39;</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>&#39;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>---</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;)</span></span></span></code></pre></div><h3 id=3-条件边与循环控制>3. 条件边与循环控制<a class=anchor href=#3-%e6%9d%a1%e4%bb%b6%e8%be%b9%e4%b8%8e%e5%be%aa%e7%8e%af%e6%8e%a7%e5%88%b6>#</a></h3><h4 id=1-复杂条件路由>(1) 复杂条件路由<a class=anchor href=#1-%e5%a4%8d%e6%9d%82%e6%9d%a1%e4%bb%b6%e8%b7%af%e7%94%b1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>route_query</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;根据查询类型路由到不同处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;天气&#34;</span> <span class=ow>in</span> <span class=n>last_message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;weather_handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>any</span><span class=p>(</span><span class=n>op</span> <span class=ow>in</span> <span class=n>last_message</span> <span class=k>for</span> <span class=n>op</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;+&#34;</span><span class=p>,</span> <span class=s2>&#34;-&#34;</span><span class=p>,</span> <span class=s2>&#34;*&#34;</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;math_handler&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;general_handler&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;classifier&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>route_query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;weather_handler&#34;</span><span class=p>:</span> <span class=s2>&#34;weather_node&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;math_handler&#34;</span><span class=p>:</span> <span class=s2>&#34;math_node&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;general_handler&#34;</span><span class=p>:</span> <span class=s2>&#34;general_node&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=2-循环控制与最大步数>(2) 循环控制与最大步数<a class=anchor href=#2-%e5%be%aa%e7%8e%af%e6%8e%a7%e5%88%b6%e4%b8%8e%e6%9c%80%e5%a4%a7%e6%ad%a5%e6%95%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentStateWithCounter</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>],</span> <span class=s2>&#34;对话历史&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>iteration</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_continue_with_limit</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentStateWithCounter</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带最大步数限制的循环控制&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>MAX_ITERATIONS</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;iteration&#34;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>MAX_ITERATIONS</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;max_iterations_reached&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>last_message</span><span class=p>,</span> <span class=s2>&#34;tool_calls&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;continue&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>increment_counter</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>AgentStateWithCounter</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;增加计数器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;iteration&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;iteration&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在工具节点中增加计数</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;tools&#34;</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>state</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>**</span><span class=n>execute_tools</span><span class=p>(</span><span class=n>state</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=o>**</span><span class=n>increment_counter</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div><h4 id=3-条件边深度实践-错误处理与重试机制>(3) 条件边深度实践: 错误处理与重试机制<a class=anchor href=#3-%e6%9d%a1%e4%bb%b6%e8%be%b9%e6%b7%b1%e5%ba%a6%e5%ae%9e%e8%b7%b5-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e4%b8%8e%e9%87%8d%e8%af%95%e6%9c%ba%e5%88%b6>#</a></h4><p>生产级 Agent 必须处理工具执行失败的情况。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Literal</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RobustAgentState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>],</span> <span class=s2>&#34;对话历史&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>last_error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_continue_robust</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>RobustAgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;continue&#34;</span><span class=p>,</span> <span class=s2>&#34;retry&#34;</span><span class=p>,</span> <span class=s2>&#34;fail&#34;</span><span class=p>,</span> <span class=s2>&#34;end&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生产级条件判断:
</span></span></span><span class=line><span class=cl><span class=s2>    - 检查是否有工具调用
</span></span></span><span class=line><span class=cl><span class=s2>    - 检查是否有错误需要重试
</span></span></span><span class=line><span class=cl><span class=s2>    - 检查重试次数是否超限
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>MAX_RETRIES</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 检查是否有错误</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;last_error&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;retry_count&#34;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>MAX_RETRIES</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;fail&#34;</span>  <span class=c1># 超过重试次数,直接失败</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;retry&#34;</span>  <span class=c1># 需要重试</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 检查是否需要调用工具</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>last_message</span><span class=p>,</span> <span class=s2>&#34;tool_calls&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;continue&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 正常结束</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_tools_with_error_handling</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>RobustAgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工具执行节点 - 带错误处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tool_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>error_occurred</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>error_msg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 执行工具</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>tool_executor</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>tool_call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>tool_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>content</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>tool_call_id</span><span class=o>=</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 捕获错误</span>
</span></span><span class=line><span class=cl>            <span class=n>error_occurred</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=n>error_msg</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>tool_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>content</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>tool_call_id</span><span class=o>=</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>tool_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;last_error&#34;</span><span class=p>:</span> <span class=n>error_msg</span> <span class=k>if</span> <span class=n>error_occurred</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;retry_count&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;retry_count&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span> <span class=k>if</span> <span class=n>error_occurred</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>handle_failure</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>RobustAgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;失败处理节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>error_message</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;抱歉,在尝试 </span><span class=si>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;retry_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 次后仍然失败。错误: </span><span class=si>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;last_error&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>error_message</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建带错误处理的工作流</span>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>RobustAgentState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>,</span> <span class=n>call_agent</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;tools&#34;</span><span class=p>,</span> <span class=n>execute_tools_with_error_handling</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;failure_handler&#34;</span><span class=p>,</span> <span class=n>handle_failure</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复杂条件边</span>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>should_continue_robust</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;continue&#34;</span><span class=p>:</span> <span class=s2>&#34;tools&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;retry&#34;</span><span class=p>:</span> <span class=s2>&#34;agent&#34;</span><span class=p>,</span>      <span class=c1># 重新让 LLM 生成方案</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;fail&#34;</span><span class=p>:</span> <span class=s2>&#34;failure_handler&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;end&#34;</span><span class=p>:</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;tools&#34;</span><span class=p>,</span> <span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_robust</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;failure_handler&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app_robust</span> <span class=o>=</span> <span class=n>workflow_robust</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span></span></span></code></pre></div><h3 id=4-持久化-persistence-multi-turn-对话的基础>4. 持久化 (Persistence): Multi-turn 对话的基础<a class=anchor href=#4-%e6%8c%81%e4%b9%85%e5%8c%96-persistence-multi-turn-%e5%af%b9%e8%af%9d%e7%9a%84%e5%9f%ba%e7%a1%80>#</a></h3><p><strong>核心问题</strong>: 默认情况下,LangGraph 的状态是"无状态"的,每次调用都是全新开始。
对于聊天机器人、长期助手等场景,我们需要<strong>跨会话保存状态</strong>。</p><h4 id=1-使用-memorysaver-内存级持久化>(1) 使用 MemorySaver (内存级持久化)<a class=anchor href=#1-%e4%bd%bf%e7%94%a8-memorysaver-%e5%86%85%e5%ad%98%e7%ba%a7%e6%8c%81%e4%b9%85%e5%8c%96>#</a></h4><p>适用于开发/测试环境,进程重启后数据会丢失。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.memory</span> <span class=kn>import</span> <span class=n>MemorySaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.graph</span> <span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义状态</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ChatState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>],</span> <span class=s2>&#34;对话历史&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>user_info</span><span class=p>:</span> <span class=nb>dict</span>  <span class=c1># 存储用户信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义节点</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>chatbot_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>ChatState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;聊天机器人节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建系统提示 (包含用户信息)</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;你是一个友好的助手。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_info&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>用户信息</span><span class=p>:</span> <span class=p>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;user_info&#39;</span><span class=p>]}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=p>[</span><span class=n>SystemMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>system_prompt</span><span class=p>)]</span> <span class=o>+</span> <span class=nb>list</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>response</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_user_info</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>ChatState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从对话中提取并更新用户信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_user_message</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>HumanMessage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>last_user_message</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 简单的信息提取 (生产环境应该用 NER 或 LLM)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_info</span> <span class=o>=</span> <span class=n>state</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_info&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;我叫&#34;</span> <span class=ow>in</span> <span class=n>last_user_message</span> <span class=ow>or</span> <span class=s2>&#34;My name is&#34;</span> <span class=ow>in</span> <span class=n>last_user_message</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 提取名字 (简化版)</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>        <span class=n>name_match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;我叫(.*?)[,。!]&#39;</span><span class=p>,</span> <span class=n>last_user_message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name_match</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_info</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>name_match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;user_info&#34;</span><span class=p>:</span> <span class=n>user_info</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建工作流</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>ChatState</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;extract_info&#34;</span><span class=p>,</span> <span class=n>extract_user_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;chatbot&#34;</span><span class=p>,</span> <span class=n>chatbot_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;extract_info&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;extract_info&#34;</span><span class=p>,</span> <span class=s2>&#34;chatbot&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;chatbot&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 关键: 添加 Checkpointer</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>MemorySaver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>checkpointer</span><span class=o>=</span><span class=n>memory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一轮对话</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user_123&#34;</span><span class=p>}}</span>  <span class=c1># 会话 ID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response1</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;你好,我叫张三&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Bot:&#34;</span><span class=p>,</span> <span class=n>response1</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二轮对话 (使用相同的 thread_id)</span>
</span></span><span class=line><span class=cl><span class=n>response2</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;我叫什么名字?&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Bot:&#34;</span><span class=p>,</span> <span class=n>response2</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: &#34;你叫张三&#34; (记住了之前的对话)</span></span></span></code></pre></div><p><strong>关键点</strong>:</p><ul><li><code>checkpointer=memory</code>: 启用状态持久化</li><li><code>thread_id</code>: 用于区分不同用户/会话的唯一标识符</li><li>每次调用 <code>app.invoke()</code> 时传入相同的 <code>config</code>,即可恢复之前的状态</li></ul><h4 id=2-使用-sqlitesaver-磁盘级持久化>(2) 使用 SqliteSaver (磁盘级持久化)<a class=anchor href=#2-%e4%bd%bf%e7%94%a8-sqlitesaver-%e7%a3%81%e7%9b%98%e7%ba%a7%e6%8c%81%e4%b9%85%e5%8c%96>#</a></h4><p>生产环境推荐,数据持久化到 SQLite 数据库。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.sqlite</span> <span class=kn>import</span> <span class=n>SqliteSaver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 SQLite Checkpointer</span>
</span></span><span class=line><span class=cl><span class=n>db_path</span> <span class=o>=</span> <span class=s2>&#34;./checkpoints.db&#34;</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=n>db_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建应用 (其他代码同上)</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>checkpointer</span><span class=o>=</span><span class=n>memory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用方式完全相同</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user_456&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;记住这个数字: 42&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 即使进程重启,数据仍然保留</span>
</span></span><span class=line><span class=cl><span class=c1># 重新创建 app</span>
</span></span><span class=line><span class=cl><span class=n>memory_new</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=n>db_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app_new</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>checkpointer</span><span class=o>=</span><span class=n>memory_new</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response2</span> <span class=o>=</span> <span class=n>app_new</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;我之前让你记住的数字是什么?&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response2</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>  <span class=c1># 输出: &#34;42&#34;</span></span></span></code></pre></div><h4 id=3-查看和管理历史状态>(3) 查看和管理历史状态<a class=anchor href=#3-%e6%9f%a5%e7%9c%8b%e5%92%8c%e7%ae%a1%e7%90%86%e5%8e%86%e5%8f%b2%e7%8a%b6%e6%80%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 获取所有 checkpoint (状态快照)</span>
</span></span><span class=line><span class=cl><span class=n>checkpoints</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>app</span><span class=o>.</span><span class=n>get_state_history</span><span class=p>(</span><span class=n>config</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Total checkpoints: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>checkpoints</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>checkpoint</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>checkpoints</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Checkpoint</span> <span class=p>{</span><span class=n>i</span><span class=p>}:</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  Messages: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>checkpoint</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  Config: </span><span class=si>{</span><span class=n>checkpoint</span><span class=o>.</span><span class=n>config</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 回滚到特定状态</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>checkpoints</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>previous_state</span> <span class=o>=</span> <span class=n>checkpoints</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>previous_state</span><span class=o>.</span><span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>previous_state</span><span class=o>.</span><span class=n>values</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;回滚成功!&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=4-完整的多轮对话示例>(4) 完整的多轮对话示例<a class=anchor href=#4-%e5%ae%8c%e6%95%b4%e7%9a%84%e5%a4%9a%e8%bd%ae%e5%af%b9%e8%af%9d%e7%a4%ba%e4%be%8b>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.sqlite</span> <span class=kn>import</span> <span class=n>SqliteSaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span><span class=p>,</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建持久化应用</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=s2>&#34;./chat_history.db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>checkpointer</span><span class=o>=</span><span class=n>memory</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>chat_session</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模拟多轮对话&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;=== Chat Session: </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2> ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第 1 轮</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>User</span><span class=p>:</span> <span class=n>你好</span><span class=p>,</span><span class=n>我叫李四</span><span class=p>,</span><span class=n>住在北京</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>r1</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;你好,我叫李四,住在北京&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Bot: </span><span class=si>{</span><span class=n>r1</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第 2 轮</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>User</span><span class=p>:</span> <span class=n>我住在哪里</span><span class=err>?</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>r2</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;我住在哪里?&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Bot: </span><span class=si>{</span><span class=n>r2</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第 3 轮</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>User</span><span class=p>:</span> <span class=n>我的名字是什么</span><span class=err>?</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>r3</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;我的名字是什么?&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Bot: </span><span class=si>{</span><span class=n>r3</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行</span>
</span></span><span class=line><span class=cl><span class=n>chat_session</span><span class=p>(</span><span class=s2>&#34;user_001&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 模拟进程重启</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>===</span> <span class=n>进程重启</span> <span class=o>===</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>memory_new</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=s2>&#34;./chat_history.db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app_new</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span><span class=n>checkpointer</span><span class=o>=</span><span class=n>memory_new</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 继续对话</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user_001&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;User: 我们之前聊过什么?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>r4</span> <span class=o>=</span> <span class=n>app_new</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;我们之前聊过什么?&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Bot: </span><span class=si>{</span><span class=n>r4</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=5-human-in-the-loop-敏感操作的审批机制>5. Human-in-the-loop: 敏感操作的审批机制<a class=anchor href=#5-human-in-the-loop-%e6%95%8f%e6%84%9f%e6%93%8d%e4%bd%9c%e7%9a%84%e5%ae%a1%e6%89%b9%e6%9c%ba%e5%88%b6>#</a></h3><p>在执行危险操作 (删除文件、发送邮件、支付等) 前,Agent 应该暂停并等待人类审批。</p><h4 id=1-使用-interrupt_before-暂停执行>(1) 使用 interrupt_before 暂停执行<a class=anchor href=#1-%e4%bd%bf%e7%94%a8-interrupt_before-%e6%9a%82%e5%81%9c%e6%89%a7%e8%a1%8c>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.memory</span> <span class=kn>import</span> <span class=n>MemorySaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.graph</span> <span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义危险工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>delete_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;删除文件 (危险操作)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;File </span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2> deleted successfully&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error deleting file: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>read_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;读取文件 (安全操作)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error reading file: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>delete_file</span><span class=p>,</span> <span class=n>read_file</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义状态</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SafeAgentState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Sequence</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>],</span> <span class=s2>&#34;对话历史&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>pending_approval</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>  <span class=c1># 等待审批的操作</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义节点</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>agent_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent 决策节点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>llm_with_tools</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>bind_tools</span><span class=p>(</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>llm_with_tools</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>response</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_if_dangerous</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查是否是危险操作&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>last_message</span><span class=p>,</span> <span class=s2>&#34;tool_calls&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=ow>not</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;safe&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查是否调用了危险工具</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;delete_file&#34;</span><span class=p>,</span> <span class=s2>&#34;send_email&#34;</span><span class=p>,</span> <span class=s2>&#34;make_payment&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;dangerous&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;safe&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_safe_tools</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;执行安全工具&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tool_executor</span> <span class=o>=</span> <span class=n>ToolExecutor</span><span class=p>(</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>tool_executor</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>tool_call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>tool_call_id</span><span class=o>=</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>tool_results</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_approval</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;请求人类审批&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_message</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 提取待审批的操作</span>
</span></span><span class=line><span class=cl>    <span class=n>dangerous_ops</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>last_message</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>dangerous_ops</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;Tool: </span><span class=si>{</span><span class=n>tool_call</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, Args: </span><span class=si>{</span><span class=n>tool_call</span><span class=p>[</span><span class=s1>&#39;args&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>approval_msg</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;⚠️ 检测到危险操作,需要审批:</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;.join(dangerous_ops)}</span>
</span></span><span class=line><span class=cl><span class=n>请输入</span> <span class=s1>&#39;approve&#39;</span> <span class=n>批准或</span> <span class=s1>&#39;reject&#39;</span> <span class=n>拒绝</span><span class=err>。</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>approval_msg</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;pending_approval&#34;</span><span class=p>:</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join(dangerous_ops)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建工作流</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>SafeAgentState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>,</span> <span class=n>agent_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;check_danger&#34;</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>s</span><span class=p>:</span> <span class=n>s</span><span class=p>)</span>  <span class=c1># 空节点,仅用于条件判断</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;request_approval&#34;</span><span class=p>,</span> <span class=n>request_approval</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span> <span class=n>execute_safe_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 条件边: agent → check_danger</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>,</span> <span class=s2>&#34;check_danger&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;check_danger&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>check_if_dangerous</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;safe&#34;</span><span class=p>:</span> <span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dangerous&#34;</span><span class=p>:</span> <span class=s2>&#34;request_approval&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;request_approval&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>  <span class=c1># 暂停,等待人类输入</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译 - 关键: interrupt_before</span>
</span></span><span class=line><span class=cl><span class=n>memory</span> <span class=o>=</span> <span class=n>MemorySaver</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>interrupt_before</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;execute_tools&#34;</span><span class=p>]</span>  <span class=c1># 在执行工具前暂停</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;session_001&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 1 步: 用户请求删除文件</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== Step 1: User Request ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>result1</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;请删除文件 /tmp/test.txt&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Status: </span><span class=si>{</span><span class=n>result1</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: &#34;检测到危险操作,需要审批...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 2 步: 查看当前状态</span>
</span></span><span class=line><span class=cl><span class=n>current_state</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>get_state</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Pending</span> <span class=n>approval</span><span class=p>:</span> <span class=p>{</span><span class=n>current_state</span><span class=o>.</span><span class=n>values</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;pending_approval&#39;</span><span class=p>)}</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Next node: </span><span class=si>{</span><span class=n>current_state</span><span class=o>.</span><span class=n>next</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>  <span class=c1># 应该是 [&#39;execute_tools&#39;]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 3 步: 人类审批</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>===</span> <span class=n>Step</span> <span class=mi>2</span><span class=p>:</span> <span class=n>Human</span> <span class=n>Approval</span> <span class=o>===</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl><span class=n>user_decision</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Type &#39;approve&#39; or &#39;reject&#39;: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>user_decision</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&#34;approve&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 继续执行 (resume)</span>
</span></span><span class=line><span class=cl>    <span class=n>result2</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>  <span class=c1># None 表示继续执行</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Result: </span><span class=si>{</span><span class=n>result2</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 拒绝 - 手动结束</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Operation rejected by user&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>update_state</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;操作已被用户拒绝&#34;</span><span class=p>)]}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><p><strong>工作流程</strong>:</p><ol><li>Agent 决定调用 <code>delete_file</code></li><li>工作流在 <code>execute_tools</code> 前暂停 (<code>interrupt_before</code>)</li><li>返回给用户,显示待审批的操作</li><li>人类输入 &ldquo;approve&rdquo;</li><li>调用 <code>app.invoke(None, config)</code> 继续执行</li></ol><h4 id=2-更优雅的审批流程-分离审批节点>(2) 更优雅的审批流程: 分离审批节点<a class=anchor href=#2-%e6%9b%b4%e4%bc%98%e9%9b%85%e7%9a%84%e5%ae%a1%e6%89%b9%e6%b5%81%e7%a8%8b-%e5%88%86%e7%a6%bb%e5%ae%a1%e6%89%b9%e8%8a%82%e7%82%b9>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>approval_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    审批节点 - 从 state 中读取人类输入
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 查找最后一条人类消息</span>
</span></span><span class=line><span class=cl>    <span class=n>last_human_msg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>messages</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>HumanMessage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>last_human_msg</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>last_human_msg</span> <span class=o>==</span> <span class=s2>&#34;approve&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;pending_approval&#34;</span><span class=p>:</span> <span class=kc>None</span><span class=p>}</span>  <span class=c1># 清除审批状态</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 拒绝</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;操作已被拒绝&#34;</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pending_approval&#34;</span><span class=p>:</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>should_execute_after_approval</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>SafeAgentState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查审批结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_human_msg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=nb>reversed</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>HumanMessage</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>last_human_msg</span> <span class=o>=</span> <span class=n>msg</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>last_human_msg</span> <span class=o>==</span> <span class=s2>&#34;approve&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;execute&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;reject&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建工作流 (改进版)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>SafeAgentState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>,</span> <span class=n>agent_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;request_approval&#34;</span><span class=p>,</span> <span class=n>request_approval</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;approval_gate&#34;</span><span class=p>,</span> <span class=n>approval_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span> <span class=n>execute_safe_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>check_if_dangerous</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;safe&#34;</span><span class=p>:</span> <span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;dangerous&#34;</span><span class=p>:</span> <span class=s2>&#34;request_approval&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;request_approval&#34;</span><span class=p>,</span> <span class=s2>&#34;approval_gate&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;approval_gate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>should_execute_after_approval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;execute&#34;</span><span class=p>:</span> <span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;reject&#34;</span><span class=p>:</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow_v2</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;execute_tools&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译 - 在 approval_gate 前暂停</span>
</span></span><span class=line><span class=cl><span class=n>app_v2</span> <span class=o>=</span> <span class=n>workflow_v2</span><span class=o>.</span><span class=n>compile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>MemorySaver</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>interrupt_before</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;approval_gate&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;session_002&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 1 步: 请求删除</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>app_v2</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;删除 /tmp/test.txt&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 2 步: 人类输入审批决策</span>
</span></span><span class=line><span class=cl><span class=n>result2</span> <span class=o>=</span> <span class=n>app_v2</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;approve&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result2</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=七多智能体协作-multi-agent>七、多智能体协作 (Multi-Agent)<a class=anchor href=#%e4%b8%83%e5%a4%9a%e6%99%ba%e8%83%bd%e4%bd%93%e5%8d%8f%e4%bd%9c-multi-agent>#</a></h2><h3 id=1-为什么需要多-agent>1. 为什么需要多 Agent?<a class=anchor href=#1-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%a4%9a-agent>#</a></h3><p><strong>单 Agent 的局限</strong>:</p><ul><li>容易产生角色混乱 (既要写代码又要测试)</li><li>难以同时精通多个领域</li><li>缺乏"批判性思维" (自己不容易发现自己的错误)</li></ul><p><strong>多 Agent 的优势</strong>:</p><ul><li><strong>专业化</strong>: 每个 Agent 专注一个角色</li><li><strong>对抗性</strong>: 不同 Agent 可以互相审查</li><li><strong>并行处理</strong>: 多个 Agent 同时工作</li></ul><h3 id=2-supervisor-模式实现>2. Supervisor 模式实现<a class=anchor href=#2-supervisor-%e6%a8%a1%e5%bc%8f%e5%ae%9e%e7%8e%b0>#</a></h3><p>Supervisor 模式: 一个主管 Agent 协调多个工作 Agent。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>SystemMessage</span><span class=p>,</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.graph</span> <span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 定义角色 Prompt</span>
</span></span><span class=line><span class=cl><span class=n>SUPERVISOR_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是项目经理,负责协调团队完成任务。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>团队成员:
</span></span></span><span class=line><span class=cl><span class=s2>- researcher: 负责信息搜索和研究
</span></span></span><span class=line><span class=cl><span class=s2>- coder: 负责编写代码
</span></span></span><span class=line><span class=cl><span class=s2>- reviewer: 负责代码审查
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>根据用户需求,决定下一步应该由谁来处理。
</span></span></span><span class=line><span class=cl><span class=s2>如果任务完成,回复 &#34;FINISH&#34;。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>当前任务: </span><span class=si>{task}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>工作历史: </span><span class=si>{history}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请输出 JSON 格式:
</span></span></span><span class=line><span class=cl><span class=s2>{{&#34;next_worker&#34;: &#34;researcher|coder|reviewer|FINISH&#34;, &#34;instruction&#34;: &#34;具体指令&#34;}}
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>RESEARCHER_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;你是一名研究员,负责搜索信息和分析需求。&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CODER_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;你是一名工程师,负责根据需求编写高质量代码。&#34;</span>
</span></span><span class=line><span class=cl><span class=n>REVIEWER_PROMPT</span> <span class=o>=</span> <span class=s2>&#34;你是一名代码审查员,负责检查代码质量和正确性。&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 定义状态</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TeamState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>task</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>history</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>dict</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>next_worker</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>current_result</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 定义工作节点</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>supervisor_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>TeamState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Supervisor</span> <span class=ow>is</span> <span class=n>deciding</span><span class=o>...</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>history_text</span> <span class=o>=</span> <span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;.join([f&#34;</span><span class=p>{</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;worker&#39;</span><span class=p>]}:</span> <span class=p>{</span><span class=n>h</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]}</span><span class=s2>&#34; for h in state[&#34;</span><span class=n>history</span><span class=s2>&#34;]])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=n>SUPERVISOR_PROMPT</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>task</span><span class=o>=</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;task&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>history</span><span class=o>=</span><span class=n>history_text</span> <span class=ow>or</span> <span class=s2>&#34;None&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 解析 JSON (简化版)</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>decision</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;next_worker&#34;</span><span class=p>:</span> <span class=n>decision</span><span class=p>[</span><span class=s2>&#34;next_worker&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=n>decision</span><span class=p>[</span><span class=s2>&#34;instruction&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;next_worker&#34;</span><span class=p>:</span> <span class=s2>&#34;FINISH&#34;</span><span class=p>,</span> <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=s2>&#34;Error parsing decision&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>researcher_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>TeamState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Researcher</span> <span class=ow>is</span> <span class=n>working</span><span class=o>...</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>RESEARCHER_PROMPT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Task</span><span class=p>:</span> <span class=p>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_result&#39;</span><span class=p>]}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;history&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;history&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[{</span><span class=s2>&#34;worker&#34;</span><span class=p>:</span> <span class=s2>&#34;researcher&#34;</span><span class=p>,</span> <span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>coder_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>TeamState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Coder</span> <span class=ow>is</span> <span class=n>working</span><span class=o>...</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>CODER_PROMPT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Task</span><span class=p>:</span> <span class=p>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_result&#39;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=n>Context</span><span class=p>:</span> <span class=p>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;history&#39;</span><span class=p>]}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;history&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;history&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[{</span><span class=s2>&#34;worker&#34;</span><span class=p>:</span> <span class=s2>&#34;coder&#34;</span><span class=p>,</span> <span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reviewer_node</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>TeamState</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Reviewer</span> <span class=ow>is</span> <span class=n>working</span><span class=o>...</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>REVIEWER_PROMPT</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Code</span> <span class=n>to</span> <span class=n>review</span><span class=p>:</span> <span class=p>{</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;current_result&#39;</span><span class=p>]}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;history&#34;</span><span class=p>:</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;history&#34;</span><span class=p>]</span> <span class=o>+</span> <span class=p>[{</span><span class=s2>&#34;worker&#34;</span><span class=p>:</span> <span class=s2>&#34;reviewer&#34;</span><span class=p>,</span> <span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 构建图</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>TeamState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;supervisor&#34;</span><span class=p>,</span> <span class=n>supervisor_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;researcher&#34;</span><span class=p>,</span> <span class=n>researcher_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;coder&#34;</span><span class=p>,</span> <span class=n>coder_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;reviewer&#34;</span><span class=p>,</span> <span class=n>reviewer_node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置入口</span>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;supervisor&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 条件边: supervisor 根据决策路由</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>route_next</span><span class=p>(</span><span class=n>state</span><span class=p>:</span> <span class=n>TeamState</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>next_worker</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;next_worker&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>next_worker</span> <span class=o>==</span> <span class=s2>&#34;FINISH&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;end&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>next_worker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;supervisor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>route_next</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;researcher&#34;</span><span class=p>:</span> <span class=s2>&#34;researcher&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;coder&#34;</span><span class=p>:</span> <span class=s2>&#34;coder&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;reviewer&#34;</span><span class=p>:</span> <span class=s2>&#34;reviewer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;end&#34;</span><span class=p>:</span> <span class=n>END</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 所有工作节点完成后回到 supervisor</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;researcher&#34;</span><span class=p>,</span> <span class=s2>&#34;coder&#34;</span><span class=p>,</span> <span class=s2>&#34;reviewer&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=s2>&#34;supervisor&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编译</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;task&#34;</span><span class=p>:</span> <span class=s2>&#34;写一个 Python 函数计算斐波那契数列&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;history&#34;</span><span class=p>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;next_worker&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;current_result&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>===</span> <span class=n>Final</span> <span class=n>Result</span> <span class=o>===</span><span class=s2>&#34;)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;current_result&#34;</span><span class=p>])</span></span></span></code></pre></div><h3 id=3-hierarchical-agent-架构>3. Hierarchical Agent 架构<a class=anchor href=#3-hierarchical-agent-%e6%9e%b6%e6%9e%84>#</a></h3><p>分层架构: 高层 Agent 负责战略,底层 Agent 负责执行。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 高层 Agent: 任务分解</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HighLevelAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decompose_task</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;将复杂任务分解为子任务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;请将以下任务分解为可执行的子任务:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Task: </span><span class=si>{</span><span class=n>task</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>输出 JSON 格式:
</span></span></span><span class=line><span class=cl><span class=se>{{</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  &#34;subtasks&#34;: [
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=se>{{</span><span class=s2>&#34;id&#34;: 1, &#34;description&#34;: &#34;...&#34;, &#34;assigned_to&#34;: &#34;worker_type&#34;</span><span class=se>}}</span><span class=s2>,
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=se>{{</span><span class=s2>&#34;id&#34;: 2, &#34;description&#34;: &#34;...&#34;, &#34;assigned_to&#34;: &#34;worker_type&#34;</span><span class=se>}}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  ]
</span></span></span><span class=line><span class=cl><span class=se>}}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)[</span><span class=s2>&#34;subtasks&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 底层 Agent: 执行具体任务</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LowLevelAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>,</span> <span class=n>role</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>role</span> <span class=o>=</span> <span class=n>role</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>subtask</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;You are a </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>role</span><span class=si>}</span><span class=s2>.
</span></span></span><span class=line><span class=cl><span class=s2>Execute this subtask: </span><span class=si>{</span><span class=n>subtask</span><span class=p>[</span><span class=s1>&#39;description&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Output:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>([</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>prompt</span><span class=p>)])</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 协调器</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HierarchicalSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>high_level</span> <span class=o>=</span> <span class=n>HighLevelAgent</span><span class=p>(</span><span class=n>llm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>workers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;researcher&#34;</span><span class=p>:</span> <span class=n>LowLevelAgent</span><span class=p>(</span><span class=n>llm</span><span class=p>,</span> <span class=s2>&#34;researcher&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;coder&#34;</span><span class=p>:</span> <span class=n>LowLevelAgent</span><span class=p>(</span><span class=n>llm</span><span class=p>,</span> <span class=s2>&#34;coder&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;tester&#34;</span><span class=p>:</span> <span class=n>LowLevelAgent</span><span class=p>(</span><span class=n>llm</span><span class=p>,</span> <span class=s2>&#34;tester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 高层分解任务</span>
</span></span><span class=line><span class=cl>        <span class=n>subtasks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>high_level</span><span class=o>.</span><span class=n>decompose_task</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 分配并执行</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>subtask</span> <span class=ow>in</span> <span class=n>subtasks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>worker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>workers</span><span class=p>[</span><span class=n>subtask</span><span class=p>[</span><span class=s2>&#34;assigned_to&#34;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>worker</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>subtask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span><span class=s2>&#34;subtask&#34;</span><span class=p>:</span> <span class=n>subtask</span><span class=p>,</span> <span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;task&#34;</span><span class=p>:</span> <span class=n>task</span><span class=p>,</span> <span class=s2>&#34;subtasks&#34;</span><span class=p>:</span> <span class=n>results</span><span class=p>}</span></span></span></code></pre></div><h3 id=4-metagpt-与-autogen-简介>4. MetaGPT 与 AutoGen 简介<a class=anchor href=#4-metagpt-%e4%b8%8e-autogen-%e7%ae%80%e4%bb%8b>#</a></h3><h4 id=1-metagpt-sop-驱动>(1) MetaGPT: SOP 驱动<a class=anchor href=#1-metagpt-sop-%e9%a9%b1%e5%8a%a8>#</a></h4><p>MetaGPT 的核心是<strong>标准化文档输出</strong>:</p><ul><li>ProductManager 输出 PRD (Product Requirement Document)</li><li>Architect 输出 System Design</li><li>Engineer 输出 Code</li><li>QA Engineer 输出 Test Report</li></ul><p>每个 Agent 的输出都有严格的格式约束,减少误差累积。</p><h4 id=2-autogen-对话编程>(2) AutoGen: 对话编程<a class=anchor href=#2-autogen-%e5%af%b9%e8%af%9d%e7%bc%96%e7%a8%8b>#</a></h4><p>AutoGen 更灵活,核心是<strong>会话</strong> (Conversation):</p><ul><li>定义多个 Agent,每个有自己的 System Prompt</li><li>将它们放入 GroupChat</li><li>让它们自己对话,直到达成共识或完成任务</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># AutoGen 示例 (简化)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>autogen</span> <span class=kn>import</span> <span class=n>AssistantAgent</span><span class=p>,</span> <span class=n>UserProxyAgent</span><span class=p>,</span> <span class=n>GroupChat</span><span class=p>,</span> <span class=n>GroupChatManager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm_config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=s2>&#34;api_key&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义 Agent</span>
</span></span><span class=line><span class=cl><span class=n>user_proxy</span> <span class=o>=</span> <span class=n>UserProxyAgent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;User&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>human_input_mode</span><span class=o>=</span><span class=s2>&#34;NEVER&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>code_execution_config</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;work_dir&#34;</span><span class=p>:</span> <span class=s2>&#34;coding&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>coder</span> <span class=o>=</span> <span class=n>AssistantAgent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;Coder&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_message</span><span class=o>=</span><span class=s2>&#34;你是一名工程师,负责编写代码。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>llm_config</span><span class=o>=</span><span class=n>llm_config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>reviewer</span> <span class=o>=</span> <span class=n>AssistantAgent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;Reviewer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_message</span><span class=o>=</span><span class=s2>&#34;你是一名代码审查员,负责检查代码质量。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>llm_config</span><span class=o>=</span><span class=n>llm_config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建群聊</span>
</span></span><span class=line><span class=cl><span class=n>groupchat</span> <span class=o>=</span> <span class=n>GroupChat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>agents</span><span class=o>=</span><span class=p>[</span><span class=n>user_proxy</span><span class=p>,</span> <span class=n>coder</span><span class=p>,</span> <span class=n>reviewer</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>max_round</span><span class=o>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>manager</span> <span class=o>=</span> <span class=n>GroupChatManager</span><span class=p>(</span><span class=n>groupchat</span><span class=o>=</span><span class=n>groupchat</span><span class=p>,</span> <span class=n>llm_config</span><span class=o>=</span><span class=n>llm_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动对话</span>
</span></span><span class=line><span class=cl><span class=n>user_proxy</span><span class=o>.</span><span class=n>initiate_chat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>manager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=o>=</span><span class=s2>&#34;请写一个快速排序算法的 Python 实现,并进行代码审查。&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h2 id=八output-parser结构化输出解析>八、Output Parser:结构化输出解析<a class=anchor href=#%e5%85%aboutput-parser%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%ba%e8%a7%a3%e6%9e%90>#</a></h2><h3 id=1-pydantic-模型定义>1. Pydantic 模型定义<a class=anchor href=#1-pydantic-%e6%a8%a1%e5%9e%8b%e5%ae%9a%e4%b9%89>#</a></h3><p>使用 Pydantic 强制 LLM 输出符合预期格式。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>validator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodeReviewResult</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;代码审查结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>overall_score</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;总体评分 (0-100)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>issues</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;发现的问题列表&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>suggestions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;改进建议&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>approved</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;是否通过审查&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;overall_score&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>score_determines_approval</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>values</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span> <span class=o>&lt;</span> <span class=mi>60</span> <span class=ow>and</span> <span class=n>values</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;approved&#39;</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Score &lt; 60 but marked as approved&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TaskPlan</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;任务规划&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>goal</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;任务目标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>steps</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>dict</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;执行步骤&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>estimated_time</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;预计耗时 (分钟)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>dependencies</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;依赖项&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.output_parsers</span> <span class=kn>import</span> <span class=n>PydanticOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>PydanticOutputParser</span><span class=p>(</span><span class=n>pydantic_object</span><span class=o>=</span><span class=n>CodeReviewResult</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;请审查以下代码:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>```python
</span></span></span><span class=line><span class=cl><span class=s2>def add(a, b):
</span></span></span><span class=line><span class=cl><span class=s2>    return a + b</span></span></span></code></pre></div><p>{parser.get_format_instructions()}
"""</p><p>response = llm.invoke(prompt)
result = parser.parse(response)</p><p>print(f"Score: {result.overall_score}")
print(f"Approved: {result.approved}")</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>
</span></span><span class=line><span class=cl>### 2. 自修复解析器
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>当 LLM 输出格式错误时,自动尝试修复。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>```python
</span></span><span class=line><span class=cl>from langchain.output_parsers import OutputFixingParser
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>base_parser = PydanticOutputParser(pydantic_object=CodeReviewResult)
</span></span><span class=line><span class=cl>fixing_parser = OutputFixingParser.from_llm(parser=base_parser, llm=llm)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 即使 LLM 输出格式有误,也会尝试修复
</span></span><span class=line><span class=cl>try:
</span></span><span class=line><span class=cl>    result = fixing_parser.parse(llm_output)
</span></span><span class=line><span class=cl>except Exception as e:
</span></span><span class=line><span class=cl>    print(f&#34;Even fixing failed: {e}&#34;)</span></span></code></pre></div><hr><h2 id=九本章小结>九、本章小结<a class=anchor href=#%e4%b9%9d%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><h3 id=核心要点>核心要点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9>#</a></h3><ol><li><strong>Workflow > Model</strong>: 优秀的工作流可以让弱模型表现得像强模型</li><li><strong>ReAct vs Plan-and-Solve</strong>:<ul><li>ReAct 适合简单任务,灵活但短视</li><li>Plan-and-Solve 适合复杂任务,需要全局规划</li></ul></li><li><strong>Memory 是长期对话的关键</strong>:<ul><li>短期记忆: Context Window</li><li>长期记忆: Vector Database + MemGPT 虚拟内存</li></ul></li><li><strong>MCP 是工具集成的未来</strong>: 一次编写,处处运行</li><li><strong>LangGraph 是当前最佳 Agent 框架</strong>: StateGraph 提供清晰的控制流</li><li><strong>Multi-Agent 是处理复杂任务的必经之路</strong>: Supervisor 模式简单有效</li><li><strong>生产级 Agent 三要素</strong> (本章重点补充):<ul><li><strong>Conditional Edges (条件边)</strong>: 实现复杂的决策逻辑,包括错误处理、重试机制</li><li><strong>Persistence (持久化)</strong>: MemorySaver/SqliteSaver 实现跨会话状态保存,是 Multi-turn 对话的基础</li><li><strong>Human-in-the-loop</strong>: interrupt_before 机制让 Agent 在执行敏感操作前暂停,等待人类审批</li></ul></li></ol><h3 id=技术栈总结>技术栈总结<a class=anchor href=#%e6%8a%80%e6%9c%af%e6%a0%88%e6%80%bb%e7%bb%93>#</a></h3><table><thead><tr><th>组件</th><th>推荐技术</th><th>适用场景</th></tr></thead><tbody><tr><td>Agent 框架</td><td>LangGraph</td><td>复杂工作流,需要精确控制</td></tr><tr><td>条件边</td><td>Conditional Edges + Error Handling</td><td>生产级决策逻辑,错误处理与重试</td></tr><tr><td>持久化</td><td>SqliteSaver (生产) / MemorySaver (开发)</td><td>多轮对话,会话管理,状态恢复</td></tr><tr><td>Human-in-the-loop</td><td>interrupt_before / interrupt_after</td><td>敏感操作审批,人类介入决策</td></tr><tr><td>工具集成</td><td>MCP Protocol</td><td>统一工具接口</td></tr><tr><td>Memory</td><td>Vector DB + MemGPT</td><td>长期对话,知识管理</td></tr><tr><td>Output Parsing</td><td>Pydantic + LangChain Parsers</td><td>结构化输出</td></tr><tr><td>Multi-Agent</td><td>Supervisor Pattern</td><td>分工协作</td></tr></tbody></table><h3 id=下一步学习>下一步学习<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5%e5%ad%a6%e4%b9%a0>#</a></h3><ul><li><strong>Part 7 Chapter 3</strong>: CoT 的数学本质与推理增强技术</li><li><strong>Part 7 Chapter 4</strong>: 推理模型 (o1/R1) 的训练与实现</li><li><strong>Part 5 Chapter 1-3</strong>: LangChain/LangGraph 生态深入</li></ul><hr><p><strong>下一章预告</strong>: 第4章 - 多模态大模型原理</p><p>在下一章中,我们将给 Agent 装上"眼睛"和"耳朵",探讨 LLaVA、GPT-4V 背后的视觉编码原理,以及如何构建多模态 Agent。</p></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第2章 检索增强生成（RAG）原理</span>
</a></span><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/ class="flex align-center"><span>第4章 多模态大模型原理</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#本章导读>本章导读</a></li><li><a href=#目录>目录</a></li><li><a href=#一从-prompt-engineering-到-agentic-workflow>一、从 Prompt Engineering 到 Agentic Workflow</a><ul><li><a href=#1-什么是-agentic-workflow>1. 什么是 Agentic Workflow?</a></li><li><a href=#2-四种核心设计模式>2. 四种核心设计模式</a></li></ul></li><li><a href=#二规划-planningreact-与-plan-and-solve>二、规划 (Planning):ReAct 与 Plan-and-Solve</a><ul><li><a href=#1-react-模式代码实现>1. ReAct 模式:代码实现</a><ul><li><a href=#1-prompt-模板>(1) Prompt 模板</a></li><li><a href=#2-完整实现-python-伪代码>(2) 完整实现 (Python 伪代码)</a></li></ul></li><li><a href=#2-plan-and-solve结构化规划>2. Plan-and-Solve:结构化规划</a><ul><li><a href=#1-prompt-模板-1>(1) Prompt 模板</a></li><li><a href=#2-实现>(2) 实现</a></li></ul></li><li><a href=#3-reflection自我反思机制>3. Reflection:自我反思机制</a><ul><li><a href=#1-reflexion-架构>(1) Reflexion 架构</a></li><li><a href=#2-output-parser-实现>(2) Output Parser 实现</a></li></ul></li></ul></li><li><a href=#三工具使用-tool-use-与-function-calling>三、工具使用 (Tool Use) 与 Function Calling</a><ul><li><a href=#1-json-schema-定义标准>1. JSON Schema 定义标准</a><ul><li><a href=#1-标准格式>(1) 标准格式</a></li><li><a href=#2-使用-pydantic-简化定义>(2) 使用 Pydantic 简化定义</a></li></ul></li><li><a href=#2-function-calling-协议详解>2. Function Calling 协议详解</a><ul><li><a href=#1-完整调用流程>(1) 完整调用流程</a></li></ul></li><li><a href=#3-工具调用完整流程实现>3. 工具调用完整流程实现</a><ul><li><a href=#1-langchain-实现>(1) LangChain 实现</a></li></ul></li></ul></li><li><a href=#四mcp-model-context-protocol-革命>四、MCP (Model Context Protocol) 革命</a><ul><li><a href=#1-mcp-协议标准>1. MCP 协议标准</a></li><li><a href=#2-实战实现一个-mcp-server>2. 实战:实现一个 MCP Server</a><ul><li><a href=#1-安装依赖>(1) 安装依赖</a></li><li><a href=#2-服务端代码>(2) 服务端代码</a></li><li><a href=#3-配置文件-用于-claude-desktop>(3) 配置文件 (用于 Claude Desktop)</a></li></ul></li><li><a href=#3-mcp-client-集成>3. MCP Client 集成</a><ul><li><a href=#1-在代码中连接-mcp-server>(1) 在代码中连接 MCP Server</a></li></ul></li></ul></li><li><a href=#五记忆系统-memory-设计>五、记忆系统 (Memory) 设计</a><ul><li><a href=#1-记忆类型短期与长期>1. 记忆类型:短期与长期</a></li><li><a href=#2-memory-架构设计>2. Memory 架构设计</a><ul><li><a href=#1-简单-memory会话级存储>(1) 简单 Memory:会话级存储</a></li><li><a href=#2-摘要记忆压缩历史>(2) 摘要记忆:压缩历史</a></li><li><a href=#3-向量记忆语义检索>(3) 向量记忆:语义检索</a></li></ul></li><li><a href=#3-memgpt虚拟内存管理>3. MemGPT:虚拟内存管理</a></li><li><a href=#4-实战实现可持久化的-memory>4. 实战:实现可持久化的 Memory</a></li></ul></li><li><a href=#六langgraph状态机编程范式>六、LangGraph:状态机编程范式</a><ul><li><a href=#1-stategraph-核心概念>1. StateGraph 核心概念</a></li><li><a href=#2-实战基于-langgraph-的-react-agent>2. 实战:基于 LangGraph 的 ReAct Agent</a></li><li><a href=#3-条件边与循环控制>3. 条件边与循环控制</a><ul><li><a href=#1-复杂条件路由>(1) 复杂条件路由</a></li><li><a href=#2-循环控制与最大步数>(2) 循环控制与最大步数</a></li><li><a href=#3-条件边深度实践-错误处理与重试机制>(3) 条件边深度实践: 错误处理与重试机制</a></li></ul></li><li><a href=#4-持久化-persistence-multi-turn-对话的基础>4. 持久化 (Persistence): Multi-turn 对话的基础</a><ul><li><a href=#1-使用-memorysaver-内存级持久化>(1) 使用 MemorySaver (内存级持久化)</a></li><li><a href=#2-使用-sqlitesaver-磁盘级持久化>(2) 使用 SqliteSaver (磁盘级持久化)</a></li><li><a href=#3-查看和管理历史状态>(3) 查看和管理历史状态</a></li><li><a href=#4-完整的多轮对话示例>(4) 完整的多轮对话示例</a></li></ul></li><li><a href=#5-human-in-the-loop-敏感操作的审批机制>5. Human-in-the-loop: 敏感操作的审批机制</a><ul><li><a href=#1-使用-interrupt_before-暂停执行>(1) 使用 interrupt_before 暂停执行</a></li><li><a href=#2-更优雅的审批流程-分离审批节点>(2) 更优雅的审批流程: 分离审批节点</a></li></ul></li></ul></li><li><a href=#七多智能体协作-multi-agent>七、多智能体协作 (Multi-Agent)</a><ul><li><a href=#1-为什么需要多-agent>1. 为什么需要多 Agent?</a></li><li><a href=#2-supervisor-模式实现>2. Supervisor 模式实现</a></li><li><a href=#3-hierarchical-agent-架构>3. Hierarchical Agent 架构</a></li><li><a href=#4-metagpt-与-autogen-简介>4. MetaGPT 与 AutoGen 简介</a><ul><li><a href=#1-metagpt-sop-驱动>(1) MetaGPT: SOP 驱动</a></li><li><a href=#2-autogen-对话编程>(2) AutoGen: 对话编程</a></li></ul></li></ul></li><li><a href=#八output-parser结构化输出解析>八、Output Parser:结构化输出解析</a><ul><li><a href=#1-pydantic-模型定义>1. Pydantic 模型定义</a></li></ul></li><li><a href=#九本章小结>九、本章小结</a><ul><li><a href=#核心要点>核心要点</a></li><li><a href=#技术栈总结>技术栈总结</a></li><li><a href=#下一步学习>下一步学习</a></li></ul></li></ul></nav></div></aside></main></body></html>