<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="第4章：DeepSpeed分布式训练# 本章定位：突破单卡显存瓶颈。学习编写 ds_config.json，掌握 ZeRO 系列优化器，并对比 PyTorch 原生 FSDP。
目录# 1. 为什么需要 DeepSpeed？ 2. 核心：ds_config.json 配置实战 3. ZeRO-3与Offload实战 4. 混合精度训练 5. 多节点训练 (Multi-Node) 本章小结 1. 为什么需要 DeepSpeed？# 当模型参数量超过显存限制（例如在 24G 显存上训练 13B 模型）时，普通的 DDP (Distributed Data Parallel) 就无能为力了。DeepSpeed 的核心武器是 ZeRO (Zero Redundancy Optimizer)，它将模型状态切分到不同的 GPU 上。
ZeRO 三阶段（简单记忆版）# ZeRO-1: 切分优化器状态 (Optimizer States)。显存节省 4 倍。 ZeRO-2: 切分优化器状态 + 梯度 (Gradients)。显存节省 8 倍。 ZeRO-3: 切分优化器状态 + 梯度 + 模型参数 (Parameters)。显存节省与 GPU 数量成正比 (线性扩展)。 Model States 详解：显存的三大占用来源# 在训练过程中，GPU 显存主要被以下三类数据占用（称为 Model States）：
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第4章 DeepSpeed分布式训练"><meta property="og:description" content="第4章：DeepSpeed分布式训练# 本章定位：突破单卡显存瓶颈。学习编写 ds_config.json，掌握 ZeRO 系列优化器，并对比 PyTorch 原生 FSDP。
目录# 1. 为什么需要 DeepSpeed？ 2. 核心：ds_config.json 配置实战 3. ZeRO-3与Offload实战 4. 混合精度训练 5. 多节点训练 (Multi-Node) 本章小结 1. 为什么需要 DeepSpeed？# 当模型参数量超过显存限制（例如在 24G 显存上训练 13B 模型）时，普通的 DDP (Distributed Data Parallel) 就无能为力了。DeepSpeed 的核心武器是 ZeRO (Zero Redundancy Optimizer)，它将模型状态切分到不同的 GPU 上。
ZeRO 三阶段（简单记忆版）# ZeRO-1: 切分优化器状态 (Optimizer States)。显存节省 4 倍。 ZeRO-2: 切分优化器状态 + 梯度 (Gradients)。显存节省 8 倍。 ZeRO-3: 切分优化器状态 + 梯度 + 模型参数 (Parameters)。显存节省与 GPU 数量成正比 (线性扩展)。 Model States 详解：显存的三大占用来源# 在训练过程中，GPU 显存主要被以下三类数据占用（称为 Model States）："><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第4章 DeepSpeed分布式训练"><meta itemprop=description content="第4章：DeepSpeed分布式训练# 本章定位：突破单卡显存瓶颈。学习编写 ds_config.json，掌握 ZeRO 系列优化器，并对比 PyTorch 原生 FSDP。
目录# 1. 为什么需要 DeepSpeed？ 2. 核心：ds_config.json 配置实战 3. ZeRO-3与Offload实战 4. 混合精度训练 5. 多节点训练 (Multi-Node) 本章小结 1. 为什么需要 DeepSpeed？# 当模型参数量超过显存限制（例如在 24G 显存上训练 13B 模型）时，普通的 DDP (Distributed Data Parallel) 就无能为力了。DeepSpeed 的核心武器是 ZeRO (Zero Redundancy Optimizer)，它将模型状态切分到不同的 GPU 上。
ZeRO 三阶段（简单记忆版）# ZeRO-1: 切分优化器状态 (Optimizer States)。显存节省 4 倍。 ZeRO-2: 切分优化器状态 + 梯度 (Gradients)。显存节省 8 倍。 ZeRO-3: 切分优化器状态 + 梯度 + 模型参数 (Parameters)。显存节省与 GPU 数量成正比 (线性扩展)。 Model States 详解：显存的三大占用来源# 在训练过程中，GPU 显存主要被以下三类数据占用（称为 Model States）："><meta itemprop=wordCount content="816"><title>第4章 DeepSpeed分布式训练 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle checked>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle checked>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/ class=active>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第4章 DeepSpeed分布式训练</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#目录>目录</a></li><li><a href=#1-为什么需要-deepspeed>1. 为什么需要 DeepSpeed？</a><ul><li><a href=#zero-三阶段简单记忆版>ZeRO 三阶段（简单记忆版）</a></li><li><a href=#model-states-详解显存的三大占用来源>Model States 详解：显存的三大占用来源</a></li><li><a href=#zero-如何切分这些状态>ZeRO 如何切分这些状态？</a></li><li><a href=#zero-3--offload-的终极优化>ZeRO-3 + Offload 的终极优化</a></li></ul></li><li><a href=#2-核心ds_configjson-配置实战>2. 核心：ds_config.json 配置实战</a><ul><li><a href=#21-zero-2-配置推荐用于大多数显存足够的微调>2.1 ZeRO-2 配置（推荐用于大多数显存足够的微调）</a></li><li><a href=#22-zero-3-offload-配置穷人救星>2.2 ZeRO-3 Offload 配置（穷人救星）</a></li></ul></li><li><a href=#3-代码集成>3. 代码集成</a></li><li><a href=#4-深度对比deepspeed-vs-fsdp>4. 深度对比：DeepSpeed vs FSDP</a><ul><li><a href=#41-选型指南>4.1 选型指南</a></li><li><a href=#42-fsdp-在-accelerate-中的配置>4.2 FSDP 在 Accelerate 中的配置</a></li></ul></li><li><a href=#5-多节点训练-multi-node>5. 多节点训练 (Multi-Node)</a><ul><li><a href=#51-deepspeed-hostfile-模式推荐>5.1 DeepSpeed Hostfile 模式（推荐）</a></li><li><a href=#52-accelerate-多机模式>5.2 Accelerate 多机模式</a></li></ul></li><li><a href=#6-本章小结>6. 本章小结</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第4章deepspeed分布式训练>第4章：DeepSpeed分布式训练<a class=anchor href=#%e7%ac%ac4%e7%ab%a0deepspeed%e5%88%86%e5%b8%83%e5%bc%8f%e8%ae%ad%e7%bb%83>#</a></h1><blockquote class=book-hint><p><strong>本章定位</strong>：突破单卡显存瓶颈。学习编写 <code>ds_config.json</code>，掌握 ZeRO 系列优化器，并对比 PyTorch 原生 FSDP。</p></blockquote><hr><h2 id=目录>目录<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><ul><li><a href=#1-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-deepspeed>1. 为什么需要 DeepSpeed？</a></li><li><a href=#2-%e6%a0%b8%e5%bf%83ds_configjson-%e9%85%8d%e7%bd%ae%e5%ae%9e%e6%88%98>2. 核心：ds_config.json 配置实战</a></li><li><a href=#3-zero-3%e4%b8%8eoffload%e5%ae%9e%e6%88%98>3. ZeRO-3与Offload实战</a></li><li><a href=#4-%e6%b7%b7%e5%90%88%e7%b2%be%e5%ba%a6%e8%ae%ad%e7%bb%83>4. 混合精度训练</a></li><li><a href=#5-%e5%a4%9a%e8%8a%82%e7%82%b9%e8%ae%ad%e7%bb%83-multi-node>5. 多节点训练 (Multi-Node)</a></li><li><a href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>本章小结</a></li></ul><hr><h2 id=1-为什么需要-deepspeed>1. 为什么需要 DeepSpeed？<a class=anchor href=#1-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-deepspeed>#</a></h2><p>当模型参数量超过显存限制（例如在 24G 显存上训练 13B 模型）时，普通的 DDP (Distributed Data Parallel) 就无能为力了。DeepSpeed 的核心武器是 <strong>ZeRO (Zero Redundancy Optimizer)</strong>，它将模型状态切分到不同的 GPU 上。</p><h3 id=zero-三阶段简单记忆版>ZeRO 三阶段（简单记忆版）<a class=anchor href=#zero-%e4%b8%89%e9%98%b6%e6%ae%b5%e7%ae%80%e5%8d%95%e8%ae%b0%e5%bf%86%e7%89%88>#</a></h3><ul><li><strong>ZeRO-1</strong>: 切分<strong>优化器状态</strong> (Optimizer States)。显存节省 4 倍。</li><li><strong>ZeRO-2</strong>: 切分<strong>优化器状态 + 梯度</strong> (Gradients)。显存节省 8 倍。</li><li><strong>ZeRO-3</strong>: 切分<strong>优化器状态 + 梯度 + 模型参数</strong> (Parameters)。显存节省与 GPU 数量成正比 (线性扩展)。</li></ul><h3 id=model-states-详解显存的三大占用来源>Model States 详解：显存的三大占用来源<a class=anchor href=#model-states-%e8%af%a6%e8%a7%a3%e6%98%be%e5%ad%98%e7%9a%84%e4%b8%89%e5%a4%a7%e5%8d%a0%e7%94%a8%e6%9d%a5%e6%ba%90>#</a></h3><p>在训练过程中，GPU 显存主要被以下三类数据占用（称为 <strong>Model States</strong>）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              单卡训练的显存占用（以7B模型为例）                  │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ 1. 模型参数 (Parameters)                    ~14GB (FP16)    │
</span></span><span class=line><span class=cl>│    - W: 权重矩阵                                             │
</span></span><span class=line><span class=cl>│    - 占用: 2 bytes × 7B = 14GB                              │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ 2. 梯度 (Gradients)                         ~14GB (FP16)    │
</span></span><span class=line><span class=cl>│    - dW: 反向传播计算的梯度                                   │
</span></span><span class=line><span class=cl>│    - 占用: 2 bytes × 7B = 14GB                              │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ 3. 优化器状态 (Optimizer States)            ~28GB (FP32)    │
</span></span><span class=line><span class=cl>│    - Adam优化器需要维护：                                     │
</span></span><span class=line><span class=cl>│      • m: 一阶动量 (Momentum)                                │
</span></span><span class=line><span class=cl>│      • v: 二阶动量 (Variance)                                │
</span></span><span class=line><span class=cl>│    - 占用: (4+4) bytes × 7B = 56GB                          │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ 总计: 14 + 14 + 56 = 84GB                                   │
</span></span><span class=line><span class=cl>│ → 单张24GB显卡无法训练！                                      │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘</span></span></code></pre></div><h3 id=zero-如何切分这些状态>ZeRO 如何切分这些状态？<a class=anchor href=#zero-%e5%a6%82%e4%bd%95%e5%88%87%e5%88%86%e8%bf%99%e4%ba%9b%e7%8a%b6%e6%80%81>#</a></h3><p><strong>传统 DDP (Data Parallel)</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GPU 0: [Parameters] [Gradients] [Optimizer States]  → 84GB
</span></span><span class=line><span class=cl>GPU 1: [Parameters] [Gradients] [Optimizer States]  → 84GB
</span></span><span class=line><span class=cl>GPU 2: [Parameters] [Gradients] [Optimizer States]  → 84GB
</span></span><span class=line><span class=cl>GPU 3: [Parameters] [Gradients] [Optimizer States]  → 84GB
</span></span><span class=line><span class=cl>------------------------------------------------------
</span></span><span class=line><span class=cl>总显存占用: 84GB × 4 = 336GB（完全冗余！）</span></span></code></pre></div><p><strong>ZeRO-1</strong>（切分优化器状态）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GPU 0: [Parameters] [Gradients] [Optimizer States 1/4]  → 42GB
</span></span><span class=line><span class=cl>GPU 1: [Parameters] [Gradients] [Optimizer States 2/4]  → 42GB
</span></span><span class=line><span class=cl>GPU 2: [Parameters] [Gradients] [Optimizer States 3/4]  → 42GB
</span></span><span class=line><span class=cl>GPU 3: [Parameters] [Gradients] [Optimizer States 4/4]  → 42GB
</span></span><span class=line><span class=cl>-----------------------------------------------------------------
</span></span><span class=line><span class=cl>每卡显存: 14 + 14 + 14 = 42GB（节省50%）</span></span></code></pre></div><p><strong>ZeRO-2</strong>（切分优化器状态 + 梯度）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GPU 0: [Parameters] [Gradients 1/4] [Optimizer States 1/4]  → 28GB
</span></span><span class=line><span class=cl>GPU 1: [Parameters] [Gradients 2/4] [Optimizer States 2/4]  → 28GB
</span></span><span class=line><span class=cl>GPU 2: [Parameters] [Gradients 3/4] [Optimizer States 3/4]  → 28GB
</span></span><span class=line><span class=cl>GPU 3: [Parameters] [Gradients 4/4] [Optimizer States 4/4]  → 28GB
</span></span><span class=line><span class=cl>------------------------------------------------------------------------
</span></span><span class=line><span class=cl>每卡显存: 14 + 3.5 + 14 = 31.5GB（节省62%）</span></span></code></pre></div><p><strong>ZeRO-3</strong>（切分所有状态）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>GPU 0: [Parameters 1/4] [Gradients 1/4] [Optimizer States 1/4]  → 21GB
</span></span><span class=line><span class=cl>GPU 1: [Parameters 2/4] [Gradients 2/4] [Optimizer States 2/4]  → 21GB
</span></span><span class=line><span class=cl>GPU 2: [Parameters 3/4] [Gradients 3/4] [Optimizer States 3/4]  → 21GB
</span></span><span class=line><span class=cl>GPU 3: [Parameters 4/4] [Gradients 4/4] [Optimizer States 4/4]  → 21GB
</span></span><span class=line><span class=cl>--------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>每卡显存: 3.5 + 3.5 + 14 = 21GB（节省75%）</span></span></code></pre></div><h3 id=zero-3--offload-的终极优化>ZeRO-3 + Offload 的终极优化<a class=anchor href=#zero-3--offload-%e7%9a%84%e7%bb%88%e6%9e%81%e4%bc%98%e5%8c%96>#</a></h3><p>当显存仍然不够时，可以将部分状态卸载到 CPU 内存：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                  GPU 显存 (24GB)                        │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  • Parameters (分片): 3.5GB                             │
</span></span><span class=line><span class=cl>│  • Gradients (分片): 3.5GB                              │
</span></span><span class=line><span class=cl>│  • Activations: ~10GB                                   │
</span></span><span class=line><span class=cl>│  • 临时缓冲区: ~5GB                                      │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  总计: ~22GB ✓ 可以跑了！                                │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>                    ↕ (通过PCIe传输)
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│               CPU 内存 (256GB+)                          │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  • Optimizer States (分片): 14GB                        │
</span></span><span class=line><span class=cl>│  • Parameters (冷备份): 3.5GB (可选)                    │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────┘</span></span></code></pre></div><p><strong>关键策略</strong>：</p><ol><li><strong>前向传播时</strong>：从 CPU 加载当前层的参数到 GPU</li><li><strong>反向传播时</strong>：计算梯度后，立即将参数卸载回 CPU</li><li><strong>优化器更新</strong>：在 CPU 上完成，更新后再传回 GPU</li></ol><p><strong>代价</strong>：</p><ul><li>训练速度降低 30-50%（受限于 PCIe 带宽）</li><li>CPU 内存需求增加（推荐 256GB+）</li></ul><hr><h2 id=2-核心ds_configjson-配置实战>2. 核心：ds_config.json 配置实战<a class=anchor href=#2-%e6%a0%b8%e5%bf%83ds_configjson-%e9%85%8d%e7%bd%ae%e5%ae%9e%e6%88%98>#</a></h2><p>DeepSpeed 不需要修改太多代码，主要是通过配置文件来控制。</p><h3 id=21-zero-2-配置推荐用于大多数显存足够的微调>2.1 ZeRO-2 配置（推荐用于大多数显存足够的微调）<a class=anchor href=#21-zero-2-%e9%85%8d%e7%bd%ae%e6%8e%a8%e8%8d%90%e7%94%a8%e4%ba%8e%e5%a4%a7%e5%a4%9a%e6%95%b0%e6%98%be%e5%ad%98%e8%b6%b3%e5%a4%9f%e7%9a%84%e5%be%ae%e8%b0%83>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;train_batch_size&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;gradient_accumulation_steps&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;steps_per_print&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;gradient_clipping&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;fp16&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;enabled&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;loss_scale&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;initial_scale_power&#34;</span><span class=p>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;zero_optimization&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;allgather_partitions&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;allgather_bucket_size&#34;</span><span class=p>:</span> <span class=mf>2e8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;reduce_scatter&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;reduce_bucket_size&#34;</span><span class=p>:</span> <span class=mf>2e8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;overlap_comm&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>  <span class=c1>// 通信与计算重叠，加速训练
</span></span></span><span class=line><span class=cl>    <span class=nt>&#34;contiguous_gradients&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;optimizer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;AdamW&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;lr&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;weight_decay&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=22-zero-3-offload-配置穷人救星>2.2 ZeRO-3 Offload 配置（穷人救星）<a class=anchor href=#22-zero-3-offload-%e9%85%8d%e7%bd%ae%e7%a9%b7%e4%ba%ba%e6%95%91%e6%98%9f>#</a></h3><p>如果你显存非常小（如单卡 3090 跑 70B 模型），必须使用 ZeRO-3 <strong>Offload</strong>，将优化器状态和参数卸载到 CPU 内存。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;zero_optimization&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;offload_optimizer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu&#34;</span><span class=p>,</span>     <span class=c1>// 关键：卸载优化器到 CPU
</span></span></span><span class=line><span class=cl>      <span class=nt>&#34;pin_memory&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;offload_param&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;device&#34;</span><span class=p>:</span> <span class=s2>&#34;cpu&#34;</span><span class=p>,</span>     <span class=c1>// 关键：卸载参数到 CPU (可选，速度更慢但显存更省)
</span></span></span><span class=line><span class=cl>      <span class=nt>&#34;pin_memory&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;overlap_comm&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;contiguous_gradients&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage3_max_live_parameters&#34;</span><span class=p>:</span> <span class=mf>1e9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage3_max_reuse_distance&#34;</span><span class=p>:</span> <span class=mf>1e9</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage3_prefetch_bucket_size&#34;</span><span class=p>:</span> <span class=mf>1e7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;stage3_param_persistence_threshold&#34;</span><span class=p>:</span> <span class=mf>1e5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;reduce_bucket_size&#34;</span><span class=p>:</span> <span class=mf>1e7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;sub_group_size&#34;</span><span class=p>:</span> <span class=mf>1e9</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;fp16&#34;</span><span class=p>:</span> <span class=p>{</span> <span class=nt>&#34;enabled&#34;</span><span class=p>:</span> <span class=kc>true</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;train_batch_size&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;gradient_accumulation_steps&#34;</span><span class=p>:</span> <span class=s2>&#34;auto&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><hr><h2 id=3-代码集成>3. 代码集成<a class=anchor href=#3-%e4%bb%a3%e7%a0%81%e9%9b%86%e6%88%90>#</a></h2><p>在 Hugging Face <code>Trainer</code> 中使用 DeepSpeed 非常简单，不需要修改 Python 代码逻辑，甚至不需要显式 import deepspeed。</p><p><strong>方式 1：通过 TrainingArguments 传入</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>TrainingArguments</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>args</span> <span class=o>=</span> <span class=n>TrainingArguments</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>output_dir</span><span class=o>=</span><span class=s2>&#34;./res&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>deepspeed</span><span class=o>=</span><span class=s2>&#34;./ds_config_zero2.json&#34;</span><span class=p>,</span> <span class=c1># 直接指定配置文件路径</span>
</span></span><span class=line><span class=cl>    <span class=n>per_device_train_batch_size</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 其他参数</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>方式 2：通过 Accelerate CLI 启动</strong></p><p>不修改代码，只在启动时指定：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>accelerate launch --use_deepspeed --zero_stage <span class=m>2</span> train.py</span></span></code></pre></div><hr><h2 id=4-深度对比deepspeed-vs-fsdp>4. 深度对比：DeepSpeed vs FSDP<a class=anchor href=#4-%e6%b7%b1%e5%ba%a6%e5%af%b9%e6%af%94deepspeed-vs-fsdp>#</a></h2><p>PyTorch 原生的 <strong>FSDP (Fully Sharded Data Parallel)</strong> 已经变得非常成熟。</p><h3 id=41-选型指南>4.1 选型指南<a class=anchor href=#41-%e9%80%89%e5%9e%8b%e6%8c%87%e5%8d%97>#</a></h3><ul><li><strong>DeepSpeed ZeRO-3</strong>:<ul><li><strong>优势</strong>: 生态更好（HF 集成度高），Offload 策略更激进（能在极小显存跑极大模型）。</li><li><strong>劣势</strong>: 依赖多，环境配置偶尔有坑。</li></ul></li><li><strong>PyTorch FSDP</strong>:<ul><li><strong>优势</strong>: PyTorch 原生，无额外依赖，对 Llama 等结构支持越来越好。</li><li><strong>劣势</strong>: Offload 能力稍弱于 DeepSpeed。</li></ul></li></ul><h3 id=42-fsdp-在-accelerate-中的配置>4.2 FSDP 在 Accelerate 中的配置<a class=anchor href=#42-fsdp-%e5%9c%a8-accelerate-%e4%b8%ad%e7%9a%84%e9%85%8d%e7%bd%ae>#</a></h3><p>无需写 json 文件，只需 <code>accelerate config</code> 时选择 FSDP。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ accelerate config
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl><span class=c1># Do you want to use FSDP? [yes/NO]: yes</span>
</span></span><span class=line><span class=cl><span class=c1># FSDP Sharding Strategy? [FULL_SHARD] (等同于 ZeRO-3)</span>
</span></span><span class=line><span class=cl><span class=c1># FSDP Offload? [true/false]</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span></span></span></code></pre></div><p>代码中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 无需任何修改！</span>
</span></span><span class=line><span class=cl><span class=c1># Accelerate 会自动接管</span></span></span></code></pre></div><hr><h2 id=5-多节点训练-multi-node>5. 多节点训练 (Multi-Node)<a class=anchor href=#5-%e5%a4%9a%e8%8a%82%e7%82%b9%e8%ae%ad%e7%bb%83-multi-node>#</a></h2><p>当单机 8 卡也无法满足需求时（如微调 Llama-3-70B），我们需要跨机器并行。</p><h3 id=51-deepspeed-hostfile-模式推荐>5.1 DeepSpeed Hostfile 模式（推荐）<a class=anchor href=#51-deepspeed-hostfile-%e6%a8%a1%e5%bc%8f%e6%8e%a8%e8%8d%90>#</a></h3><p>这是最简单的方式，无需复杂的 <code>torchrun</code> 参数。</p><p><strong>Step 1: 准备 Hostfile</strong>
创建 <code>/job/hostfile</code>，列出所有机器的 IP 和 GPU 数量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>192.168.1.100 slots=8
</span></span><span class=line><span class=cl>192.168.1.101 slots=8</span></span></code></pre></div><p><strong>Step 2: 启动命令</strong>
在 Master 节点（第一台机器）运行：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deepspeed --hostfile /job/hostfile <span class=se>\
</span></span></span><span class=line><span class=cl>    --master_port <span class=m>29500</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    train.py --deepspeed ds_config.json</span></span></code></pre></div><p><strong>Step 3: SSH 免密互信 (关键)</strong>
确保 Master 节点能通过 SSH 免密登录到 Worker 节点，否则 DeepSpeed 无法启动远程进程。</p><h3 id=52-accelerate-多机模式>5.2 Accelerate 多机模式<a class=anchor href=#52-accelerate-%e5%a4%9a%e6%9c%ba%e6%a8%a1%e5%bc%8f>#</a></h3><p>如果使用 HF Trainer，推荐用 <code>accelerate config</code> 生成配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>compute_environment</span><span class=p>:</span><span class=w> </span><span class=l>LOCAL_MACHINE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>distributed_type</span><span class=p>:</span><span class=w> </span><span class=l>DEEPSPEED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>machine_rank</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>  </span><span class=c># 在不同机器上设为 0, 1...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>main_process_ip</span><span class=p>:</span><span class=w> </span><span class=m>192.168.1.100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>main_process_port</span><span class=p>:</span><span class=w> </span><span class=m>29500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>num_machines</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>num_processes</span><span class=p>:</span><span class=w> </span><span class=m>16</span></span></span></code></pre></div><hr><h2 id=6-本章小结>6. 本章小结<a class=anchor href=#6-%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><ol><li><strong>ZeRO-2</strong>: 目前性价比最高的选择。适合多卡微调。</li><li><strong>ZeRO-3</strong>: 大模型（>13B）全量微调必备。如果爆显存，开启 <code>offload_optimizer: cpu</code>。</li><li><strong>ZeRO-Offload</strong>: 利用 CPU 内存换取 GPU 显存空间，用时间换空间。</li><li><strong>FSDP</strong>: PyTorch 原生替代方案，值得尝试。</li></ol><p><strong>避坑指南</strong>：</p><ul><li>使用 DeepSpeed 时，<code>train_batch_size</code> 在 json 里设为 <code>"auto"</code>，让 Hugging Face 的 arguments 来控制，避免冲突。</li><li>开启 ZeRO-3 后，模型保存速度会变慢（需要从各 GPU 收集参数），请耐心等待。</li></ul></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第3章 TRL与强化学习实战</span>
</a></span><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/ class="flex align-center"><span>第5章 端到端LLM项目实战</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#目录>目录</a></li><li><a href=#1-为什么需要-deepspeed>1. 为什么需要 DeepSpeed？</a><ul><li><a href=#zero-三阶段简单记忆版>ZeRO 三阶段（简单记忆版）</a></li><li><a href=#model-states-详解显存的三大占用来源>Model States 详解：显存的三大占用来源</a></li><li><a href=#zero-如何切分这些状态>ZeRO 如何切分这些状态？</a></li><li><a href=#zero-3--offload-的终极优化>ZeRO-3 + Offload 的终极优化</a></li></ul></li><li><a href=#2-核心ds_configjson-配置实战>2. 核心：ds_config.json 配置实战</a><ul><li><a href=#21-zero-2-配置推荐用于大多数显存足够的微调>2.1 ZeRO-2 配置（推荐用于大多数显存足够的微调）</a></li><li><a href=#22-zero-3-offload-配置穷人救星>2.2 ZeRO-3 Offload 配置（穷人救星）</a></li></ul></li><li><a href=#3-代码集成>3. 代码集成</a></li><li><a href=#4-深度对比deepspeed-vs-fsdp>4. 深度对比：DeepSpeed vs FSDP</a><ul><li><a href=#41-选型指南>4.1 选型指南</a></li><li><a href=#42-fsdp-在-accelerate-中的配置>4.2 FSDP 在 Accelerate 中的配置</a></li></ul></li><li><a href=#5-多节点训练-multi-node>5. 多节点训练 (Multi-Node)</a><ul><li><a href=#51-deepspeed-hostfile-模式推荐>5.1 DeepSpeed Hostfile 模式（推荐）</a></li><li><a href=#52-accelerate-多机模式>5.2 Accelerate 多机模式</a></li></ul></li><li><a href=#6-本章小结>6. 本章小结</a></li></ul></nav></div></aside></main></body></html>