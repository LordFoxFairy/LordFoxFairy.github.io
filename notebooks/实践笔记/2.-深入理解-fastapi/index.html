<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='深入理解 FastAPI# 现代Python高性能API框架的完整指南
目录# 1. FastAPI概述与核心特性 2. 异步编程原理 3. Pydantic数据验证 4. 依赖注入系统 5. 中间件与生命周期 6. 认证与安全 7. 数据库集成 8. 后台任务与WebSocket 9. 测试策略 10. 生产部署与性能优化 1. FastAPI概述与核心特性# 1.1 什么是FastAPI# FastAPI是一个现代、高性能的Python Web框架，专门用于构建API。它诞生于2018年，由Sebastián Ramírez创建，目标是解决Python Web开发中长期存在的几个痛点：
传统框架的问题：
Flask：简单灵活，但缺乏数据验证、类型提示支持，需要大量第三方库 Django REST Framework：功能强大但过于重量级，学习曲线陡峭 性能瓶颈：传统同步框架在高并发场景下表现不佳 FastAPI的解决方案：
FastAPI站在巨人的肩膀上，它不是从零开始，而是巧妙地组合了两个优秀的库：
Starlette：提供Web框架的核心能力（路由、中间件、WebSocket等） Pydantic：提供数据验证和序列化能力 这种设计哲学意味着FastAPI本身的代码量很小，但功能极其强大。当你使用FastAPI时，实际上是在使用这两个经过生产验证的成熟库。
核心优势：
特性 说明 对比传统框架 极高性能 与NodeJS、Go相当 比Flask快10-100倍 开发效率 开发速度提升200-300% 自动文档、自动验证 减少Bug 类型提示减少约40%的人为错误 编译时发现问题 标准化 基于OpenAPI和JSON Schema 无需手写API文档 学习曲线 只需了解Python类型注解 无需学习DSL 1.2 安装与环境配置# FastAPI提供了多种安装方式，根据你的需求选择：
# 方式1：标准安装（推荐，包含所有常用依赖） # 包含：uvicorn、httpx、jinja2、python-multipart等 pip install "fastapi[standard]" # 方式2：最小安装（只有核心功能） # 适合：对依赖有严格控制的环境 pip install fastapi # 方式3：单独安装ASGI服务器 # 如果你选择了最小安装，需要单独安装服务器 pip install uvicorn[standard]为什么需要ASGI服务器？
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="深入理解 FastAPI"><meta property="og:description" content='深入理解 FastAPI# 现代Python高性能API框架的完整指南
目录# 1. FastAPI概述与核心特性 2. 异步编程原理 3. Pydantic数据验证 4. 依赖注入系统 5. 中间件与生命周期 6. 认证与安全 7. 数据库集成 8. 后台任务与WebSocket 9. 测试策略 10. 生产部署与性能优化 1. FastAPI概述与核心特性# 1.1 什么是FastAPI# FastAPI是一个现代、高性能的Python Web框架，专门用于构建API。它诞生于2018年，由Sebastián Ramírez创建，目标是解决Python Web开发中长期存在的几个痛点：
传统框架的问题：
Flask：简单灵活，但缺乏数据验证、类型提示支持，需要大量第三方库 Django REST Framework：功能强大但过于重量级，学习曲线陡峭 性能瓶颈：传统同步框架在高并发场景下表现不佳 FastAPI的解决方案：
FastAPI站在巨人的肩膀上，它不是从零开始，而是巧妙地组合了两个优秀的库：
Starlette：提供Web框架的核心能力（路由、中间件、WebSocket等） Pydantic：提供数据验证和序列化能力 这种设计哲学意味着FastAPI本身的代码量很小，但功能极其强大。当你使用FastAPI时，实际上是在使用这两个经过生产验证的成熟库。
核心优势：
特性 说明 对比传统框架 极高性能 与NodeJS、Go相当 比Flask快10-100倍 开发效率 开发速度提升200-300% 自动文档、自动验证 减少Bug 类型提示减少约40%的人为错误 编译时发现问题 标准化 基于OpenAPI和JSON Schema 无需手写API文档 学习曲线 只需了解Python类型注解 无需学习DSL 1.2 安装与环境配置# FastAPI提供了多种安装方式，根据你的需求选择：
# 方式1：标准安装（推荐，包含所有常用依赖） # 包含：uvicorn、httpx、jinja2、python-multipart等 pip install "fastapi[standard]" # 方式2：最小安装（只有核心功能） # 适合：对依赖有严格控制的环境 pip install fastapi # 方式3：单独安装ASGI服务器 # 如果你选择了最小安装，需要单独安装服务器 pip install uvicorn[standard]为什么需要ASGI服务器？'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="深入理解 FastAPI"><meta itemprop=description content='深入理解 FastAPI# 现代Python高性能API框架的完整指南
目录# 1. FastAPI概述与核心特性 2. 异步编程原理 3. Pydantic数据验证 4. 依赖注入系统 5. 中间件与生命周期 6. 认证与安全 7. 数据库集成 8. 后台任务与WebSocket 9. 测试策略 10. 生产部署与性能优化 1. FastAPI概述与核心特性# 1.1 什么是FastAPI# FastAPI是一个现代、高性能的Python Web框架，专门用于构建API。它诞生于2018年，由Sebastián Ramírez创建，目标是解决Python Web开发中长期存在的几个痛点：
传统框架的问题：
Flask：简单灵活，但缺乏数据验证、类型提示支持，需要大量第三方库 Django REST Framework：功能强大但过于重量级，学习曲线陡峭 性能瓶颈：传统同步框架在高并发场景下表现不佳 FastAPI的解决方案：
FastAPI站在巨人的肩膀上，它不是从零开始，而是巧妙地组合了两个优秀的库：
Starlette：提供Web框架的核心能力（路由、中间件、WebSocket等） Pydantic：提供数据验证和序列化能力 这种设计哲学意味着FastAPI本身的代码量很小，但功能极其强大。当你使用FastAPI时，实际上是在使用这两个经过生产验证的成熟库。
核心优势：
特性 说明 对比传统框架 极高性能 与NodeJS、Go相当 比Flask快10-100倍 开发效率 开发速度提升200-300% 自动文档、自动验证 减少Bug 类型提示减少约40%的人为错误 编译时发现问题 标准化 基于OpenAPI和JSON Schema 无需手写API文档 学习曲线 只需了解Python类型注解 无需学习DSL 1.2 安装与环境配置# FastAPI提供了多种安装方式，根据你的需求选择：
# 方式1：标准安装（推荐，包含所有常用依赖） # 包含：uvicorn、httpx、jinja2、python-multipart等 pip install "fastapi[standard]" # 方式2：最小安装（只有核心功能） # 适合：对依赖有严格控制的环境 pip install fastapi # 方式3：单独安装ASGI服务器 # 如果你选择了最小安装，需要单独安装服务器 pip install uvicorn[standard]为什么需要ASGI服务器？'><meta itemprop=wordCount content="5443"><title>深入理解 FastAPI | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle checked>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/ class=active>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>深入理解 FastAPI</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#目录>目录</a></li><li><a href=#1-fastapi概述与核心特性>1. FastAPI概述与核心特性</a><ul><li><a href=#11-什么是fastapi>1.1 什么是FastAPI</a></li><li><a href=#12-安装与环境配置>1.2 安装与环境配置</a></li><li><a href=#13-第一个fastapi应用>1.3 第一个FastAPI应用</a></li><li><a href=#14-请求参数的多种来源>1.4 请求参数的多种来源</a></li></ul></li><li><a href=#2-异步编程原理>2. 异步编程原理</a><ul><li><a href=#21-为什么需要异步>2.1 为什么需要异步？</a></li><li><a href=#22-深入理解-asyncawait>2.2 深入理解 async/await</a></li><li><a href=#23-何时使用-async-def-vs-def>2.3 何时使用 async def vs def</a></li><li><a href=#24-异步上下文管理器与应用生命周期>2.4 异步上下文管理器与应用生命周期</a></li></ul></li><li><a href=#3-pydantic数据验证>3. Pydantic数据验证</a><ul><li><a href=#31-为什么需要数据验证>3.1 为什么需要数据验证？</a></li><li><a href=#32-高级验证技巧>3.2 高级验证技巧</a></li><li><a href=#33-泛型响应模型>3.3 泛型响应模型</a></li><li><a href=#34-配置管理>3.4 配置管理</a></li></ul></li><li><a href=#4-依赖注入系统>4. 依赖注入系统</a><ul><li><a href=#41-什么是依赖注入>4.1 什么是依赖注入？</a></li><li><a href=#42-类作为依赖>4.2 类作为依赖</a></li><li><a href=#43-依赖链构建复杂的依赖关系>4.3 依赖链：构建复杂的依赖关系</a></li><li><a href=#44-路由级别依赖>4.4 路由级别依赖</a></li></ul></li><li><a href=#5-中间件与生命周期>5. 中间件与生命周期</a><ul><li><a href=#51-理解中间件>5.1 理解中间件</a></li><li><a href=#52-高级中间件限流>5.2 高级中间件：限流</a></li><li><a href=#53-中间件-vs-依赖注入如何选择>5.3 中间件 vs 依赖注入：如何选择？</a></li></ul></li><li><a href=#6-认证与安全>6. 认证与安全</a><ul><li><a href=#61-理解oauth2>6.1 理解OAuth2</a></li><li><a href=#62-基于角色的访问控制rbac>6.2 基于角色的访问控制（RBAC）</a></li></ul></li><li><a href=#7-数据库集成>7. 数据库集成</a><ul><li><a href=#71-sqlalchemy异步集成>7.1 SQLAlchemy异步集成</a></li><li><a href=#72-crud操作模式>7.2 CRUD操作模式</a></li></ul></li><li><a href=#8-后台任务与websocket>8. 后台任务与WebSocket</a><ul><li><a href=#81-后台任务>8.1 后台任务</a></li><li><a href=#82-websocket实时通信>8.2 WebSocket实时通信</a></li></ul></li><li><a href=#9-测试策略>9. 测试策略</a><ul><li><a href=#91-测试的重要性>9.1 测试的重要性</a></li><li><a href=#92-依赖注入覆盖>9.2 依赖注入覆盖</a></li></ul></li><li><a href=#10-生产部署与性能优化>10. 生产部署与性能优化</a><ul><li><a href=#101-部署架构>10.1 部署架构</a></li><li><a href=#102-docker部署>10.2 Docker部署</a></li><li><a href=#103-性能优化>10.3 性能优化</a></li></ul></li><li><a href=#总结>总结</a><ul><li><a href=#核心要点回顾>核心要点回顾</a></li><li><a href=#最佳实践清单>最佳实践清单</a></li><li><a href=#参考资源>参考资源</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=深入理解-fastapi>深入理解 FastAPI<a class=anchor href=#%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3-fastapi>#</a></h1><blockquote class=book-hint><p>现代Python高性能API框架的完整指南</p></blockquote><h2 id=目录>目录<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><ul><li><a href=#1-fastapi%e6%a6%82%e8%bf%b0%e4%b8%8e%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7>1. FastAPI概述与核心特性</a></li><li><a href=#2-%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b%e5%8e%9f%e7%90%86>2. 异步编程原理</a></li><li><a href=#3-pydantic%e6%95%b0%e6%8d%ae%e9%aa%8c%e8%af%81>3. Pydantic数据验证</a></li><li><a href=#4-%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5%e7%b3%bb%e7%bb%9f>4. 依赖注入系统</a></li><li><a href=#5-%e4%b8%ad%e9%97%b4%e4%bb%b6%e4%b8%8e%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f>5. 中间件与生命周期</a></li><li><a href=#6-%e8%ae%a4%e8%af%81%e4%b8%8e%e5%ae%89%e5%85%a8>6. 认证与安全</a></li><li><a href=#7-%e6%95%b0%e6%8d%ae%e5%ba%93%e9%9b%86%e6%88%90>7. 数据库集成</a></li><li><a href=#8-%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1%e4%b8%8ewebsocket>8. 后台任务与WebSocket</a></li><li><a href=#9-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>9. 测试策略</a></li><li><a href=#10-%e7%94%9f%e4%ba%a7%e9%83%a8%e7%bd%b2%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>10. 生产部署与性能优化</a></li></ul><hr><h2 id=1-fastapi概述与核心特性>1. FastAPI概述与核心特性<a class=anchor href=#1-fastapi%e6%a6%82%e8%bf%b0%e4%b8%8e%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7>#</a></h2><h3 id=11-什么是fastapi>1.1 什么是FastAPI<a class=anchor href=#11-%e4%bb%80%e4%b9%88%e6%98%affastapi>#</a></h3><p>FastAPI是一个现代、高性能的Python Web框架，专门用于构建API。它诞生于2018年，由Sebastián Ramírez创建，目标是解决Python Web开发中长期存在的几个痛点：</p><p><strong>传统框架的问题</strong>：</p><ul><li><strong>Flask</strong>：简单灵活，但缺乏数据验证、类型提示支持，需要大量第三方库</li><li><strong>Django REST Framework</strong>：功能强大但过于重量级，学习曲线陡峭</li><li><strong>性能瓶颈</strong>：传统同步框架在高并发场景下表现不佳</li></ul><p><strong>FastAPI的解决方案</strong>：</p><p>FastAPI站在巨人的肩膀上，它不是从零开始，而是巧妙地组合了两个优秀的库：</p><ol><li><strong>Starlette</strong>：提供Web框架的核心能力（路由、中间件、WebSocket等）</li><li><strong>Pydantic</strong>：提供数据验证和序列化能力</li></ol><p>这种设计哲学意味着FastAPI本身的代码量很小，但功能极其强大。当你使用FastAPI时，实际上是在使用这两个经过生产验证的成熟库。</p><p><strong>核心优势</strong>：</p><table><thead><tr><th>特性</th><th>说明</th><th>对比传统框架</th></tr></thead><tbody><tr><td>极高性能</td><td>与NodeJS、Go相当</td><td>比Flask快10-100倍</td></tr><tr><td>开发效率</td><td>开发速度提升200-300%</td><td>自动文档、自动验证</td></tr><tr><td>减少Bug</td><td>类型提示减少约40%的人为错误</td><td>编译时发现问题</td></tr><tr><td>标准化</td><td>基于OpenAPI和JSON Schema</td><td>无需手写API文档</td></tr><tr><td>学习曲线</td><td>只需了解Python类型注解</td><td>无需学习DSL</td></tr></tbody></table><h3 id=12-安装与环境配置>1.2 安装与环境配置<a class=anchor href=#12-%e5%ae%89%e8%a3%85%e4%b8%8e%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae>#</a></h3><p>FastAPI提供了多种安装方式，根据你的需求选择：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 方式1：标准安装（推荐，包含所有常用依赖）</span>
</span></span><span class=line><span class=cl><span class=c1># 包含：uvicorn、httpx、jinja2、python-multipart等</span>
</span></span><span class=line><span class=cl>pip install <span class=s2>&#34;fastapi[standard]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：最小安装（只有核心功能）</span>
</span></span><span class=line><span class=cl><span class=c1># 适合：对依赖有严格控制的环境</span>
</span></span><span class=line><span class=cl>pip install fastapi
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式3：单独安装ASGI服务器</span>
</span></span><span class=line><span class=cl><span class=c1># 如果你选择了最小安装，需要单独安装服务器</span>
</span></span><span class=line><span class=cl>pip install uvicorn<span class=o>[</span>standard<span class=o>]</span></span></span></code></pre></div><p><strong>为什么需要ASGI服务器？</strong></p><p>FastAPI本身只是一个框架，它定义了如何处理请求，但不包含网络服务器功能。ASGI（Asynchronous Server Gateway Interface）是Python异步Web应用的标准接口，Uvicorn是最流行的ASGI服务器实现。</p><p>这种分离设计的好处是：</p><ul><li>可以选择不同的ASGI服务器（Uvicorn、Hypercorn、Daphne）</li><li>框架专注于业务逻辑，服务器专注于网络处理</li><li>方便在不同环境（开发/生产）使用不同配置</li></ul><p><strong>版本要求与兼容性</strong>：</p><ul><li>Python 3.8+（推荐3.10+，可以使用 <code>|</code> 语法替代 <code>Union</code>）</li><li>FastAPI 0.100+（2024-2025年推荐0.115+）</li></ul><h3 id=13-第一个fastapi应用>1.3 第一个FastAPI应用<a class=anchor href=#13-%e7%ac%ac%e4%b8%80%e4%b8%aafastapi%e5%ba%94%e7%94%a8>#</a></h3><p>让我们从一个完整但简单的例子开始，逐步理解FastAPI的核心概念：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># main.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建FastAPI应用实例</span>
</span></span><span class=line><span class=cl><span class=c1># 这个实例是整个应用的入口点，所有路由、中间件都注册在这里</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=o>=</span><span class=s2>&#34;My API&#34;</span><span class=p>,</span>              <span class=c1># API标题，显示在文档中</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;这是一个示例API&#34;</span><span class=p>,</span>  <span class=c1># API描述</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0.0&#34;</span><span class=p>,</span>             <span class=c1># API版本</span>
</span></span><span class=line><span class=cl>    <span class=n>docs_url</span><span class=o>=</span><span class=s2>&#34;/docs&#34;</span><span class=p>,</span>            <span class=c1># Swagger文档路径（默认）</span>
</span></span><span class=line><span class=cl>    <span class=n>redoc_url</span><span class=o>=</span><span class=s2>&#34;/redoc&#34;</span>           <span class=c1># ReDoc文档路径（默认）</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 最简单的路由：GET请求，返回JSON</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>root</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    根路径端点
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这个函数会在访问 / 时被调用
</span></span></span><span class=line><span class=cl><span class=s2>    返回的字典会自动序列化为JSON
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Hello World&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 带路径参数的路由</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/</span><span class=si>{item_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_item</span><span class=p>(</span><span class=n>item_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>q</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取单个物品
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        item_id: 路径参数，自动转换为int类型
</span></span></span><span class=line><span class=cl><span class=s2>        q: 查询参数，可选，默认为None
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    FastAPI会自动：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 验证item_id是否为有效整数
</span></span></span><span class=line><span class=cl><span class=s2>    2. 如果验证失败，返回清晰的错误信息
</span></span></span><span class=line><span class=cl><span class=s2>    3. 将参数传递给函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;item_id&#34;</span><span class=p>:</span> <span class=n>item_id</span><span class=p>,</span> <span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=n>q</span><span class=p>}</span></span></span></code></pre></div><p><strong>运行应用</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 开发模式：启用自动重载，代码修改后自动重启</span>
</span></span><span class=line><span class=cl>uvicorn main:app --reload
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这个命令的含义：</span>
</span></span><span class=line><span class=cl><span class=c1># main - Python模块名（main.py）</span>
</span></span><span class=line><span class=cl><span class=c1># app - FastAPI实例的变量名</span>
</span></span><span class=line><span class=cl><span class=c1># --reload - 监视文件变化，自动重启</span></span></span></code></pre></div><p><strong>理解路由装饰器</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/</span><span class=si>{item_id}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p>这一行代码做了很多事情：</p><ol><li><code>@app.get</code> - 注册一个处理GET请求的路由</li><li><code>"/items/{item_id}"</code> - URL路径模板，<code>{item_id}</code> 是路径参数</li><li>装饰器将函数与路径绑定，FastAPI自动处理请求分发</li></ol><p><strong>自动生成的文档</strong>：</p><p>启动应用后，访问以下地址：</p><ul><li>http://127.0.0.1:8000/docs - Swagger UI（交互式文档）</li><li>http://127.0.0.1:8000/redoc - ReDoc（美观的静态文档）</li><li>http://127.0.0.1:8000/openapi.json - OpenAPI规范JSON</li></ul><p>这些文档完全自动生成，无需任何额外配置。FastAPI通过分析你的代码（类型注解、docstring）来生成文档。</p><h3 id=14-请求参数的多种来源>1.4 请求参数的多种来源<a class=anchor href=#14-%e8%af%b7%e6%b1%82%e5%8f%82%e6%95%b0%e7%9a%84%e5%a4%9a%e7%a7%8d%e6%9d%a5%e6%ba%90>#</a></h3><p>在Web开发中，客户端数据可以通过多种方式传递。FastAPI提供了统一且类型安全的方式来处理所有这些来源：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Query</span><span class=p>,</span> <span class=n>Path</span><span class=p>,</span> <span class=n>Body</span><span class=p>,</span> <span class=n>Header</span><span class=p>,</span> <span class=n>Cookie</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 1. 路径参数 ====================</span>
</span></span><span class=line><span class=cl><span class=c1># 路径参数是URL的一部分，用于标识特定资源</span>
</span></span><span class=line><span class=cl><span class=c1># 例如：/users/123 中的 123 就是用户ID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users/</span><span class=si>{user_id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>Path</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>title</span><span class=o>=</span><span class=s2>&#34;用户ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;要查询的用户的唯一标识符&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>           <span class=c1># 大于等于1</span>
</span></span><span class=line><span class=cl>        <span class=n>example</span><span class=o>=</span><span class=mi>42</span>      <span class=c1># 文档中的示例值</span>
</span></span><span class=line><span class=cl>    <span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Path参数的特点：
</span></span></span><span class=line><span class=cl><span class=s2>    - 必须存在（否则URL不匹配）
</span></span></span><span class=line><span class=cl><span class=s2>    - 通常用于资源标识
</span></span></span><span class=line><span class=cl><span class=s2>    - 支持类型验证和约束
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 2. 查询参数 ====================</span>
</span></span><span class=line><span class=cl><span class=c1># 查询参数在URL的?后面，用于过滤、分页、搜索等</span>
</span></span><span class=line><span class=cl><span class=c1># 例如：/items/?skip=0&amp;limit=10&amp;q=phone</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_items</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1># 必选参数：没有默认值</span>
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 可选参数：有默认值</span>
</span></span><span class=line><span class=cl>    <span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 带验证的参数：使用Query添加约束</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>Query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>          <span class=c1># 最大100</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;返回结果数量限制&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)]</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 带长度验证的字符串参数</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>    <span class=c1># 最短3个字符</span>
</span></span><span class=line><span class=cl>        <span class=n>max_length</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>   <span class=c1># 最长50个字符</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;^[a-zA-Z0-9]+$&#34;</span>  <span class=c1># 只允许字母数字</span>
</span></span><span class=line><span class=cl>    <span class=p>)]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Query参数的特点：
</span></span></span><span class=line><span class=cl><span class=s2>    - 用于可选的筛选条件
</span></span></span><span class=line><span class=cl><span class=s2>    - 可以有默认值
</span></span></span><span class=line><span class=cl><span class=s2>    - 支持复杂的验证规则
</span></span></span><span class=line><span class=cl><span class=s2>    - 非必须（除非没有默认值）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=n>category</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;skip&#34;</span><span class=p>:</span> <span class=n>skip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;limit&#34;</span><span class=p>:</span> <span class=n>limit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=n>q</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 3. 请求体 ====================</span>
</span></span><span class=line><span class=cl><span class=c1># 请求体用于发送复杂的结构化数据，通常是JSON格式</span>
</span></span><span class=line><span class=cl><span class=c1># 常见于POST、PUT、PATCH请求</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Item</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Pydantic模型定义请求体结构
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这不仅仅是数据容器，它还提供：
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动JSON解析
</span></span></span><span class=line><span class=cl><span class=s2>    - 类型验证
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动文档生成
</span></span></span><span class=line><span class=cl><span class=s2>    - IDE智能提示
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>price</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>tax</span><span class=p>:</span> <span class=nb>float</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/items/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_item</span><span class=p>(</span><span class=n>item</span><span class=p>:</span> <span class=n>Item</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建新物品
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    FastAPI看到参数类型是Pydantic模型，
</span></span></span><span class=line><span class=cl><span class=s2>    会自动从请求体读取JSON并验证
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># item 已经是验证过的 Item 实例</span>
</span></span><span class=line><span class=cl>    <span class=n>item_dict</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>item</span><span class=o>.</span><span class=n>tax</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>item_dict</span><span class=p>[</span><span class=s2>&#34;price_with_tax&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>item</span><span class=o>.</span><span class=n>price</span> <span class=o>+</span> <span class=n>item</span><span class=o>.</span><span class=n>tax</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>item_dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 4. 请求头 ====================</span>
</span></span><span class=line><span class=cl><span class=c1># HTTP头部通常用于元数据：认证、内容类型、追踪ID等</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/headers/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_headers</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1># Header会自动处理HTTP头部的命名转换</span>
</span></span><span class=line><span class=cl>    <span class=c1># X-Token 在Python中变成 x_token</span>
</span></span><span class=line><span class=cl>    <span class=n>user_agent</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Header</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>x_request_id</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Header</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>authorization</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Header</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Header参数的特点：
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动转换下划线为连字符（x_token -&gt; X-Token）
</span></span></span><span class=line><span class=cl><span class=s2>    - 大小写不敏感
</span></span></span><span class=line><span class=cl><span class=s2>    - 常用于认证、追踪、内容协商
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;User-Agent&#34;</span><span class=p>:</span> <span class=n>user_agent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;X-Request-ID&#34;</span><span class=p>:</span> <span class=n>x_request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Authorization&#34;</span><span class=p>:</span> <span class=n>authorization</span><span class=p>[:</span><span class=mi>20</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;...&#34;</span> <span class=k>if</span> <span class=n>authorization</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 5. Cookie ====================</span>
</span></span><span class=line><span class=cl><span class=c1># Cookie用于客户端状态存储，如会话ID、用户偏好等</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/cookies/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_cookies</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>session_id</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Cookie</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>preferences</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Cookie</span><span class=p>()]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Cookie参数的特点：
</span></span></span><span class=line><span class=cl><span class=s2>    - 由浏览器自动发送
</span></span></span><span class=line><span class=cl><span class=s2>    - 常用于会话管理
</span></span></span><span class=line><span class=cl><span class=s2>    - 注意安全性（HttpOnly、Secure、SameSite）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;session_id&#34;</span><span class=p>:</span> <span class=n>session_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;preferences&#34;</span><span class=p>:</span> <span class=n>preferences</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><p><strong>Annotated类型的设计哲学</strong>：</p><p>你可能注意到我们使用了 <code>Annotated[int, Query(...)]</code> 这种语法。这是Python 3.9引入的类型注解增强，FastAPI充分利用了这一特性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 传统方式（仍然支持，但不推荐）</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>old_style</span><span class=p>(</span><span class=n>q</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 现代方式（推荐）</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>new_style</span><span class=p>(</span><span class=n>q</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Query</span><span class=p>(</span><span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>)]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><p>使用Annotated的好处：</p><ol><li><strong>类型和元数据分离</strong>：类型检查工具只看到 <code>str | None</code></li><li><strong>更清晰的默认值</strong>：默认值在最后，一目了然</li><li><strong>可复用</strong>：可以创建类型别名复用验证规则</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建可复用的类型别名</span>
</span></span><span class=line><span class=cl><span class=n>PositiveInt</span> <span class=o>=</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=n>Query</span><span class=p>(</span><span class=n>gt</span><span class=o>=</span><span class=mi>0</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>SearchQuery</span> <span class=o>=</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span><span class=p>,</span> <span class=n>Query</span><span class=p>(</span><span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>50</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在多个路由中复用</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/products/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_products</span><span class=p>(</span><span class=n>page</span><span class=p>:</span> <span class=n>PositiveInt</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>q</span><span class=p>:</span> <span class=n>SearchQuery</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/orders/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_orders</span><span class=p>(</span><span class=n>page</span><span class=p>:</span> <span class=n>PositiveInt</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>q</span><span class=p>:</span> <span class=n>SearchQuery</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><hr><h2 id=2-异步编程原理>2. 异步编程原理<a class=anchor href=#2-%e5%bc%82%e6%ad%a5%e7%bc%96%e7%a8%8b%e5%8e%9f%e7%90%86>#</a></h2><h3 id=21-为什么需要异步>2.1 为什么需要异步？<a class=anchor href=#21-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%bc%82%e6%ad%a5>#</a></h3><p>要理解异步编程的价值，我们需要先理解Web服务器面临的挑战：</p><p><strong>传统同步模型的问题</strong>：</p><p>想象一个餐厅只有一个服务员。同步模型下，这个服务员：</p><ol><li>接待客人A，记录点单</li><li>去厨房等待A的菜做好</li><li>把菜端给A</li><li>然后才能服务客人B</li></ol><p>如果做一道菜需要10分钟，这个服务员一小时只能服务6位客人。</p><p><strong>异步模型的解决方案</strong>：</p><p>聪明的服务员会这样做：</p><ol><li>接待客人A，记录点单，提交给厨房</li><li>不等待，立即去接待客人B</li><li>记录B的点单，提交厨房</li><li>继续接待C、D、E&mldr;</li><li>当厨房通知某道菜好了，再去端菜</li></ol><p>这就是异步编程的核心思想：<strong>不要傻等，去做别的事</strong>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>httpx</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 同步方式（阻塞） ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/sync&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sync_endpoint</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    同步请求示例
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    问题：
</span></span></span><span class=line><span class=cl><span class=s2>    - 这个函数执行期间，整个worker都在等待
</span></span></span><span class=line><span class=cl><span class=s2>    - 如果外部API响应需要2秒，这个worker 2秒内无法处理其他请求
</span></span></span><span class=line><span class=cl><span class=s2>    - 在高并发场景下，这会导致严重的性能问题
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl>    <span class=c1># 发起HTTP请求，线程阻塞等待响应</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://api.example.com/data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 异步方式（非阻塞） ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/async&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>async_endpoint</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    异步请求示例
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    优势：
</span></span></span><span class=line><span class=cl><span class=s2>    - await期间，事件循环可以处理其他请求
</span></span></span><span class=line><span class=cl><span class=s2>    - 单个worker可以同时处理数百个并发请求
</span></span></span><span class=line><span class=cl><span class=s2>    - 资源利用率大幅提升
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>()</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># await表示：发起请求后，让出控制权，等响应回来再继续</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://api.example.com/data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span></span></span></code></pre></div><h3 id=22-深入理解-asyncawait>2.2 深入理解 async/await<a class=anchor href=#22-%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3-asyncawait>#</a></h3><p><code>async</code> 和 <code>await</code> 是Python异步编程的核心关键字，理解它们的本质很重要：</p><p><strong>async def - 定义协程函数</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>my_coroutine</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    async def 定义了一个协程函数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    调用这个函数不会立即执行函数体，
</span></span></span><span class=line><span class=cl><span class=s2>    而是返回一个协程对象，需要被await或事件循环调度
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;Hello&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 直接调用不会执行函数体</span>
</span></span><span class=line><span class=cl><span class=n>coro</span> <span class=o>=</span> <span class=n>my_coroutine</span><span class=p>()</span>  <span class=c1># 返回协程对象 &lt;coroutine object my_coroutine at 0x...&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 必须await才会真正执行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>my_coroutine</span><span class=p>()</span>  <span class=c1># 返回 &#34;Hello&#34;</span></span></span></code></pre></div><p><strong>await - 等待异步操作完成</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>fetch_data</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模拟异步数据获取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 模拟I/O操作，这1秒内可以处理其他请求</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=n>url</span><span class=p>,</span> <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=s2>&#34;some data&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>process_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模拟异步数据处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>  <span class=c1># 模拟I/O操作</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;processed&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span> <span class=o>**</span><span class=n>data</span><span class=p>}</span></span></span></code></pre></div><p><strong>串行 vs 并行执行</strong>：</p><p>理解这两种模式的区别对写出高效的异步代码至关重要：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ==================== 串行执行 ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/serial&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>serial_execution</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    串行执行：总耗时 = 1秒 + 1秒 = 2秒
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    适用场景：
</span></span></span><span class=line><span class=cl><span class=s2>    - 第二个操作依赖第一个的结果
</span></span></span><span class=line><span class=cl><span class=s2>    - 需要保证执行顺序
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 先执行第一个，等待完成</span>
</span></span><span class=line><span class=cl>    <span class=n>data1</span> <span class=o>=</span> <span class=k>await</span> <span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url1&#34;</span><span class=p>)</span>  <span class=c1># 等待1秒</span>
</span></span><span class=line><span class=cl>    <span class=c1># 再执行第二个</span>
</span></span><span class=line><span class=cl>    <span class=n>data2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url2&#34;</span><span class=p>)</span>  <span class=c1># 再等待1秒</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;串行耗时: </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>  <span class=c1># 约2秒</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>data1</span><span class=p>,</span> <span class=n>data2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 并行执行 ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/parallel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>parallel_execution</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    并行执行：总耗时 = max(1秒, 1秒) = 1秒
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    适用场景：
</span></span></span><span class=line><span class=cl><span class=s2>    - 多个独立的I/O操作
</span></span></span><span class=line><span class=cl><span class=s2>    - 操作之间没有依赖关系
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># asyncio.gather 同时启动多个协程</span>
</span></span><span class=line><span class=cl>    <span class=c1># 它们会并发执行，等待最慢的那个完成</span>
</span></span><span class=line><span class=cl>    <span class=n>data1</span><span class=p>,</span> <span class=n>data2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url1&#34;</span><span class=p>),</span>  <span class=c1># 启动</span>
</span></span><span class=line><span class=cl>        <span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url2&#34;</span><span class=p>)</span>   <span class=c1># 同时启动</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;并行耗时: </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>  <span class=c1># 约1秒</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>data1</span><span class=p>,</span> <span class=n>data2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== TaskGroup（Python 3.11+） ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/taskgroup&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>taskgroup_execution</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    TaskGroup是Python 3.11引入的更现代的并发控制方式
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    相比asyncio.gather的优势：
</span></span></span><span class=line><span class=cl><span class=s2>    - 更好的异常处理：一个任务失败会取消所有其他任务
</span></span></span><span class=line><span class=cl><span class=s2>    - 结构化并发：任务有明确的生命周期边界
</span></span></span><span class=line><span class=cl><span class=s2>    - 代码更清晰
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TaskGroup</span><span class=p>()</span> <span class=k>as</span> <span class=n>tg</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 创建任务，立即开始执行</span>
</span></span><span class=line><span class=cl>        <span class=n>task1</span> <span class=o>=</span> <span class=n>tg</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url1&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>task2</span> <span class=o>=</span> <span class=n>tg</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>fetch_data</span><span class=p>(</span><span class=s2>&#34;url2&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 退出上下文管理器时，所有任务都已完成</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;TaskGroup耗时: </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>task1</span><span class=o>.</span><span class=n>result</span><span class=p>(),</span> <span class=n>task2</span><span class=o>.</span><span class=n>result</span><span class=p>()]</span></span></span></code></pre></div><h3 id=23-何时使用-async-def-vs-def>2.3 何时使用 async def vs def<a class=anchor href=#23-%e4%bd%95%e6%97%b6%e4%bd%bf%e7%94%a8-async-def-vs-def>#</a></h3><p>这是FastAPI新手最常见的困惑之一。简单的判断标准：</p><p><strong>使用 async def</strong>：</p><ul><li>函数内部有 <code>await</code> 调用</li><li>进行异步I/O操作（async数据库、async HTTP客户端）</li></ul><p><strong>使用普通 def</strong>：</p><ul><li>纯CPU计算</li><li>使用同步库（如 <code>requests</code>、同步数据库驱动）</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 场景1：异步I/O操作 ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/io-bound&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>io_bound</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    使用 async def：适合I/O密集型操作
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    I/O操作的特点是大部分时间在等待：
</span></span></span><span class=line><span class=cl><span class=s2>    - 等待数据库响应
</span></span></span><span class=line><span class=cl><span class=s2>    - 等待HTTP请求响应
</span></span></span><span class=line><span class=cl><span class=s2>    - 等待文件读写完成
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>()</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这个await期间，事件循环可以处理其他请求</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://api.example.com/data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 场景2：CPU密集型操作 ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/cpu-bound&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cpu_bound</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    使用普通 def：适合CPU密集型操作
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    FastAPI的智能处理：
</span></span></span><span class=line><span class=cl><span class=s2>    - 普通函数会在线程池中运行
</span></span></span><span class=line><span class=cl><span class=s2>    - 不会阻塞事件循环
</span></span></span><span class=line><span class=cl><span class=s2>    - 但要注意：线程池大小有限（默认40个线程）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟CPU密集计算</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>i</span> <span class=o>*</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000000</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 反面教材：阻塞事件循环 ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/bad-example&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>bad_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    ❌ 错误示范：在async函数中使用阻塞操作
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    问题：
</span></span></span><span class=line><span class=cl><span class=s2>    - time.sleep是同步阻塞调用
</span></span></span><span class=line><span class=cl><span class=s2>    - 在async函数中，它会阻塞整个事件循环
</span></span></span><span class=line><span class=cl><span class=s2>    - 所有其他请求都要等这5秒过去
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># 千万别这样做！</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;done&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==================== 正确处理：使用run_in_executor ====================</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/good-example&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>good_example</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    ✓ 正确示范：将阻塞操作放到线程池
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    如果必须使用同步阻塞函数（比如某些遗留库），
</span></span></span><span class=line><span class=cl><span class=s2>    使用run_in_executor将其放到线程池执行
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>loop</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1># 在线程池中运行阻塞操作，不会阻塞事件循环</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>loop</span><span class=o>.</span><span class=n>run_in_executor</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;done&#34;</span><span class=p>}</span></span></span></code></pre></div><h3 id=24-异步上下文管理器与应用生命周期>2.4 异步上下文管理器与应用生命周期<a class=anchor href=#24-%e5%bc%82%e6%ad%a5%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86%e5%99%a8%e4%b8%8e%e5%ba%94%e7%94%a8%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f>#</a></h3><p>现代FastAPI应用通常需要管理各种资源：数据库连接池、HTTP客户端、缓存连接等。这些资源应该在应用启动时创建，关闭时清理。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>httpx</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.asyncio</span> <span class=kn>import</span> <span class=n>create_async_engine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>lifespan</span><span class=p>(</span><span class=n>app</span><span class=p>:</span> <span class=n>FastAPI</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    应用生命周期管理器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这是FastAPI推荐的资源管理方式（替代了旧的on_event装饰器）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    设计模式：
</span></span></span><span class=line><span class=cl><span class=s2>    - yield之前的代码在应用启动时执行（初始化）
</span></span></span><span class=line><span class=cl><span class=s2>    - yield之后的代码在应用关闭时执行（清理）
</span></span></span><span class=line><span class=cl><span class=s2>    - 通过app.state存储共享资源
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 启动时执行 =====</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🚀 应用启动中...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 初始化数据库连接池</span>
</span></span><span class=line><span class=cl>    <span class=c1># 为什么要在启动时创建？</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 连接池创建需要时间，不应该让第一个请求等待</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 连接池应该被所有请求共享，而不是每个请求创建</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>db_engine</span> <span class=o>=</span> <span class=n>create_async_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;postgresql+asyncpg://user:pass@localhost/db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pool_size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>      <span class=c1># 池中保持的连接数</span>
</span></span><span class=line><span class=cl>        <span class=n>max_overflow</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>   <span class=c1># 超出pool_size时可以额外创建的连接数</span>
</span></span><span class=line><span class=cl>        <span class=n>pool_recycle</span><span class=o>=</span><span class=mi>3600</span>  <span class=c1># 连接1小时后回收，避免数据库超时断开</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 初始化HTTP客户端</span>
</span></span><span class=line><span class=cl>    <span class=c1># 为什么要复用客户端？</span>
</span></span><span class=line><span class=cl>    <span class=c1># - HTTP连接建立需要TCP握手、可能的TLS握手，开销大</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 复用客户端可以使用HTTP连接池，大幅减少延迟</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>http_client</span> <span class=o>=</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span><span class=o>=</span><span class=mf>30.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>limits</span><span class=o>=</span><span class=n>httpx</span><span class=o>.</span><span class=n>Limits</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>max_keepalive_connections</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_connections</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 初始化Redis连接</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>redis.asyncio</span> <span class=k>as</span> <span class=nn>aioredis</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=k>await</span> <span class=n>aioredis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;redis://localhost&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 所有服务初始化完成!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>yield</span>  <span class=c1># 应用运行中，处理请求</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 关闭时执行 =====</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🛑 应用关闭中...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 优雅关闭所有连接</span>
</span></span><span class=line><span class=cl>    <span class=c1># 为什么需要优雅关闭？</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 确保正在进行的数据库事务能够完成</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 释放系统资源（文件描述符、内存）</span>
</span></span><span class=line><span class=cl>    <span class=c1># - 避免连接泄漏导致数据库连接池耗尽</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>db_engine</span><span class=o>.</span><span class=n>dispose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>http_client</span><span class=o>.</span><span class=n>aclose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;👋 应用已安全关闭&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建应用，传入生命周期管理器</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>lifespan</span><span class=o>=</span><span class=n>lifespan</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/external-api&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>call_external</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    使用共享的HTTP客户端
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    好处：
</span></span></span><span class=line><span class=cl><span class=s2>    - 复用连接池，减少连接建立开销
</span></span></span><span class=line><span class=cl><span class=s2>    - 统一的超时配置
</span></span></span><span class=line><span class=cl><span class=s2>    - 应用关闭时自动清理
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>http_client</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;https://api.github.com/zen&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;github_zen&#34;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/cache/</span><span class=si>{key}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_cache</span><span class=p>(</span><span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;使用共享的Redis连接&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=k>await</span> <span class=n>app</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=n>key</span><span class=p>,</span> <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=n>value</span><span class=p>}</span></span></span></code></pre></div><hr><h2 id=3-pydantic数据验证>3. Pydantic数据验证<a class=anchor href=#3-pydantic%e6%95%b0%e6%8d%ae%e9%aa%8c%e8%af%81>#</a></h2><h3 id=31-为什么需要数据验证>3.1 为什么需要数据验证？<a class=anchor href=#31-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e6%95%b0%e6%8d%ae%e9%aa%8c%e8%af%81>#</a></h3><p>在Web开发中，永远不要信任客户端数据。用户可能：</p><ul><li>输入错误的数据类型（字符串代替数字）</li><li>输入不符合业务规则的数据（负数价格、空用户名）</li><li>恶意输入（SQL注入、XSS攻击）</li></ul><p>传统方式需要大量手动验证代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 传统方式：繁琐且容易遗漏</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_user_old</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s2>&#34;username&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;缺少用户名&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>],</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;用户名必须是字符串&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>])</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;用户名至少3个字符&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>50</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;用户名最多50个字符&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 还有email、password等字段</span>
</span></span><span class=line><span class=cl>    <span class=c1># 代码冗长，容易出错，维护困难</span></span></span></code></pre></div><p>Pydantic通过声明式的方式解决这个问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>field_validator</span><span class=p>,</span> <span class=n>model_validator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用枚举限制有效值</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserRole</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    用户角色枚举
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    继承str的好处：
</span></span></span><span class=line><span class=cl><span class=s2>    - JSON序列化时自动转为字符串
</span></span></span><span class=line><span class=cl><span class=s2>    - 可以直接与字符串比较
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ADMIN</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>USER</span> <span class=o>=</span> <span class=s2>&#34;user&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>GUEST</span> <span class=o>=</span> <span class=s2>&#34;guest&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserBase</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    用户基础模型
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    BaseModel的魔力：
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动从JSON/dict解析数据
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动类型转换（&#34;123&#34; -&gt; 123）
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动验证约束
</span></span></span><span class=line><span class=cl><span class=s2>    - 生成JSON Schema（用于API文档）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Field提供更详细的验证规则</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=p>,</span>              <span class=c1># ... 表示必填字段</span>
</span></span><span class=line><span class=cl>        <span class=n>min_length</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>     <span class=c1># 最短3个字符</span>
</span></span><span class=line><span class=cl>        <span class=n>max_length</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>    <span class=c1># 最长50个字符</span>
</span></span><span class=line><span class=cl>        <span class=n>examples</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;john_doe&#34;</span><span class=p>]</span>  <span class=c1># 文档示例</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 使用正则表达式验证email格式</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^[\w\.-]+@[\w\.-]+\.\w+$&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>examples</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;user@example.com&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 枚举类型，只接受定义的值</span>
</span></span><span class=line><span class=cl>    <span class=n>role</span><span class=p>:</span> <span class=n>UserRole</span> <span class=o>=</span> <span class=n>UserRole</span><span class=o>.</span><span class=n>USER</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserCreate</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建用户时的请求模型
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    继承UserBase，额外添加password字段
</span></span></span><span class=line><span class=cl><span class=s2>    这种分层设计很常见：
</span></span></span><span class=line><span class=cl><span class=s2>    - UserBase: 共享的基础字段
</span></span></span><span class=line><span class=cl><span class=s2>    - UserCreate: 创建时的输入（包含密码）
</span></span></span><span class=line><span class=cl><span class=s2>    - UserResponse: 返回给客户端的数据（不包含密码）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_password_strength</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        自定义字段验证器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        验证密码强度：
</span></span></span><span class=line><span class=cl><span class=s2>        - 必须包含大写字母
</span></span></span><span class=line><span class=cl><span class=s2>        - 必须包含数字
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>isupper</span><span class=p>()</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;密码必须包含至少一个大写字母&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>c</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=k>for</span> <span class=n>c</span> <span class=ow>in</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;密码必须包含至少一个数字&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserResponse</span><span class=p>(</span><span class=n>UserBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    返回给客户端的用户模型
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    注意：不包含password字段
</span></span></span><span class=line><span class=cl><span class=s2>    这是一个安全最佳实践：永远不要将密码返回给客户端
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>model_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;from_attributes&#34;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># 允许从ORM模型创建</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><h3 id=32-高级验证技巧>3.2 高级验证技巧<a class=anchor href=#32-%e9%ab%98%e7%ba%a7%e9%aa%8c%e8%af%81%e6%8a%80%e5%b7%a7>#</a></h3><p>Pydantic v2提供了强大的验证能力，让我们看几个实际场景：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>field_validator</span><span class=p>,</span> <span class=n>model_validator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Self</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>decimal</span> <span class=kn>import</span> <span class=n>Decimal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Order</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    订单模型 - 展示多种验证技巧
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>product_id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>quantity</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>gt</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;购买数量，必须大于0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>unit_price</span><span class=p>:</span> <span class=n>Decimal</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>gt</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>decimal_places</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>discount</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>default</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;折扣率，0-1之间&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>total</span><span class=p>:</span> <span class=n>Decimal</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>  <span class=c1># 计算字段，允许为空</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;quantity&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_quantity</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        单字段验证器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        使用场景：
</span></span></span><span class=line><span class=cl><span class=s2>        - 检查库存（需要查询数据库）
</span></span></span><span class=line><span class=cl><span class=s2>        - 业务规则限制
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;单次订单数量不能超过1000&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;after&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_total</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Self</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        模型验证器 - 在所有字段验证完成后执行
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        mode=&#39;after&#39; 表示在字段验证后执行
</span></span></span><span class=line><span class=cl><span class=s2>        mode=&#39;before&#39; 表示在字段验证前执行（用于预处理原始数据）
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        这里用于计算派生字段
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>total</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>total</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>quantity</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>unit_price</span> <span class=o>*</span> <span class=n>Decimal</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>discount</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DateRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    日期范围 - 展示跨字段验证
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>start_date</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>end_date</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;after&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_date_range</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Self</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        验证结束日期必须晚于开始日期
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        这种跨字段验证只能用model_validator实现
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>end_date</span> <span class=o>&lt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_date</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;结束日期必须晚于开始日期&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BatchRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    批量请求 - 展示列表验证
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>Order</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;after&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Self</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证批量操作的约束&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;批量订单不能超过100个&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否有重复的product_id</span>
</span></span><span class=line><span class=cl>        <span class=n>product_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>o</span><span class=o>.</span><span class=n>product_id</span> <span class=k>for</span> <span class=n>o</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>orders</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>product_ids</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>product_ids</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;批量订单中存在重复的产品&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span></span></span></code></pre></div><h3 id=33-泛型响应模型>3.3 泛型响应模型<a class=anchor href=#33-%e6%b3%9b%e5%9e%8b%e5%93%8d%e5%ba%94%e6%a8%a1%e5%9e%8b>#</a></h3><p>在实际项目中，API响应通常有统一的格式。使用泛型可以创建可复用的响应包装器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Generic</span><span class=p>,</span> <span class=n>TypeVar</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义类型变量</span>
</span></span><span class=line><span class=cl><span class=n>T</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s1>&#39;T&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Response</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>,</span> <span class=n>Generic</span><span class=p>[</span><span class=n>T</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    通用响应包装器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    为什么需要统一的响应格式？
</span></span></span><span class=line><span class=cl><span class=s2>    - 前端可以用统一的逻辑处理所有响应
</span></span></span><span class=line><span class=cl><span class=s2>    - 便于错误处理和日志记录
</span></span></span><span class=line><span class=cl><span class=s2>    - API文档更加一致
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;业务状态码&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;状态消息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=n>T</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;响应数据&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>success</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>T</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;success&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s2>&#34;Response[T]&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;便捷方法：创建成功响应&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>error</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>code</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=s2>&#34;Response[None]&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;便捷方法：创建错误响应&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=n>code</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=n>message</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PaginatedResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>,</span> <span class=n>Generic</span><span class=p>[</span><span class=n>T</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分页响应包装器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    分页是API设计中最常见的需求之一
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>items</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>T</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>total</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;总记录数&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>page</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;当前页码&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>page_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;每页大小&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>pages</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;总页数&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>has_next</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;是否有下一页&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>has_prev</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;是否有上一页&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>T</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>page</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>page_size</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=s2>&#34;PaginatedResponse[T]&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        工厂方法：根据参数计算分页信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        为什么用工厂方法？
</span></span></span><span class=line><span class=cl><span class=s2>        - 封装计算逻辑
</span></span></span><span class=line><span class=cl><span class=s2>        - 确保字段一致性
</span></span></span><span class=line><span class=cl><span class=s2>        - 减少调用方的重复代码
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>pages</span> <span class=o>=</span> <span class=p>(</span><span class=n>total</span> <span class=o>+</span> <span class=n>page_size</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>//</span> <span class=n>page_size</span>  <span class=c1># 向上取整</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>cls</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>items</span><span class=o>=</span><span class=n>items</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>total</span><span class=o>=</span><span class=n>total</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>page</span><span class=o>=</span><span class=n>page</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>page_size</span><span class=o>=</span><span class=n>page_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pages</span><span class=o>=</span><span class=n>pages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>has_next</span><span class=o>=</span><span class=n>page</span> <span class=o>&lt;</span> <span class=n>pages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>has_prev</span><span class=o>=</span><span class=n>page</span> <span class=o>&gt;</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 具体的业务模型</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Article</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在路由中使用泛型响应</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>Response</span><span class=p>[</span><span class=n>PaginatedResponse</span><span class=p>[</span><span class=n>User</span><span class=p>]])</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_users</span><span class=p>(</span><span class=n>page</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>page_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取用户列表
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    response_model的作用：
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动序列化响应
</span></span></span><span class=line><span class=cl><span class=s2>    - 过滤多余字段（如密码）
</span></span></span><span class=line><span class=cl><span class=s2>    - 生成OpenAPI文档
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟数据</span>
</span></span><span class=line><span class=cl>    <span class=n>total</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=nb>id</span><span class=o>=</span><span class=n>i</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;user_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;user</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>@example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>             <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>((</span><span class=n>page</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=n>page_size</span><span class=p>,</span> <span class=nb>min</span><span class=p>(</span><span class=n>page</span><span class=o>*</span><span class=n>page_size</span><span class=p>,</span> <span class=n>total</span><span class=p>))]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>paginated</span> <span class=o>=</span> <span class=n>PaginatedResponse</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>items</span><span class=o>=</span><span class=n>users</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span><span class=o>=</span><span class=n>total</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>page</span><span class=o>=</span><span class=n>page</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>page_size</span><span class=o>=</span><span class=n>page_size</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=n>paginated</span><span class=p>)</span></span></span></code></pre></div><h3 id=34-配置管理>3.4 配置管理<a class=anchor href=#34-%e9%85%8d%e7%bd%ae%e7%ae%a1%e7%90%86>#</a></h3><p>Pydantic Settings是管理应用配置的最佳实践：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic_settings</span> <span class=kn>import</span> <span class=n>BaseSettings</span><span class=p>,</span> <span class=n>SettingsConfigDict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>Field</span><span class=p>,</span> <span class=n>SecretStr</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Settings</span><span class=p>(</span><span class=n>BaseSettings</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    应用配置类
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    设计原则（12-Factor App）：
</span></span></span><span class=line><span class=cl><span class=s2>    - 配置与代码分离
</span></span></span><span class=line><span class=cl><span class=s2>    - 从环境变量读取敏感信息
</span></span></span><span class=line><span class=cl><span class=s2>    - 有合理的默认值
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 应用基础配置 =====</span>
</span></span><span class=line><span class=cl>    <span class=n>app_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;My FastAPI App&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>debug</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>environment</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=s2>&#34;development&#34;</span><span class=p>,</span> <span class=n>pattern</span><span class=o>=</span><span class=s2>&#34;^(development|staging|production)$&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 数据库配置 =====</span>
</span></span><span class=line><span class=cl>    <span class=n>database_url</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span><span class=p>,</span>  <span class=c1># 必填</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;数据库连接字符串&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>examples</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;postgresql://user:pass@localhost/db&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>database_pool_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>database_max_overflow</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== Redis配置 =====</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_url</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;redis://localhost:6379/0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_max_connections</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== JWT配置 =====</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用SecretStr存储敏感信息</span>
</span></span><span class=line><span class=cl>    <span class=c1># 它不会在日志、repr中显示实际值</span>
</span></span><span class=line><span class=cl>    <span class=n>secret_key</span><span class=p>:</span> <span class=n>SecretStr</span>
</span></span><span class=line><span class=cl>    <span class=n>algorithm</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;HS256&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>access_token_expire_minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>refresh_token_expire_days</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>7</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 外部服务配置 =====</span>
</span></span><span class=line><span class=cl>    <span class=n>openai_api_key</span><span class=p>:</span> <span class=n>SecretStr</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>sentry_dsn</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ===== 配置来源设置 =====</span>
</span></span><span class=line><span class=cl>    <span class=n>model_config</span> <span class=o>=</span> <span class=n>SettingsConfigDict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>env_file</span><span class=o>=</span><span class=s2>&#34;.env&#34;</span><span class=p>,</span>           <span class=c1># 从.env文件读取</span>
</span></span><span class=line><span class=cl>        <span class=n>env_file_encoding</span><span class=o>=</span><span class=s2>&#34;utf-8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>case_sensitive</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>      <span class=c1># 环境变量名不区分大小写</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span><span class=o>=</span><span class=s2>&#34;ignore&#34;</span>             <span class=c1># 忽略.env中多余的变量</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@lru_cache</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_settings</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>Settings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取配置单例
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    为什么用lru_cache？
</span></span></span><span class=line><span class=cl><span class=s2>    - 配置只需要加载一次
</span></span></span><span class=line><span class=cl><span class=s2>    - 避免重复读取环境变量和.env文件
</span></span></span><span class=line><span class=cl><span class=s2>    - 保证整个应用使用同一个配置实例
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Settings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在FastAPI中使用配置</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_config</span><span class=p>(</span><span class=n>settings</span><span class=p>:</span> <span class=n>Settings</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_settings</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    显示（安全的）配置信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    注意：
</span></span></span><span class=line><span class=cl><span class=s2>    - 不要暴露敏感信息
</span></span></span><span class=line><span class=cl><span class=s2>    - 生产环境应该禁用这个端点
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>settings</span><span class=o>.</span><span class=n>environment</span> <span class=o>==</span> <span class=s2>&#34;production&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Not available in production&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;app_name&#34;</span><span class=p>:</span> <span class=n>settings</span><span class=o>.</span><span class=n>app_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;environment&#34;</span><span class=p>:</span> <span class=n>settings</span><span class=o>.</span><span class=n>environment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;debug&#34;</span><span class=p>:</span> <span class=n>settings</span><span class=o>.</span><span class=n>debug</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1># SecretStr的get_secret_value()方法获取实际值</span>
</span></span><span class=line><span class=cl>        <span class=c1># 但这里我们只显示是否已配置</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;openai_configured&#34;</span><span class=p>:</span> <span class=n>settings</span><span class=o>.</span><span class=n>openai_api_key</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><hr><h2 id=4-依赖注入系统>4. 依赖注入系统<a class=anchor href=#4-%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5%e7%b3%bb%e7%bb%9f>#</a></h2><h3 id=41-什么是依赖注入>4.1 什么是依赖注入？<a class=anchor href=#41-%e4%bb%80%e4%b9%88%e6%98%af%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5>#</a></h3><p>依赖注入（Dependency Injection，DI）是软件设计中的一个重要模式。核心思想是：<strong>不要在函数内部创建依赖，而是从外部注入</strong>。</p><p><strong>没有依赖注入的代码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 紧耦合的代码</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user_orders</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 函数内部直接创建数据库连接</span>
</span></span><span class=line><span class=cl>    <span class=c1># 问题：</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 难以测试（无法模拟数据库）</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 难以复用（连接配置写死）</span>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 资源管理困难（连接何时关闭？）</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>DatabaseConnection</span><span class=p>(</span><span class=s2>&#34;postgresql://...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SELECT * FROM orders WHERE user_id = </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>orders</span></span></span></code></pre></div><p><strong>使用依赖注入的代码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 松耦合的代码</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_user_orders</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>DatabaseConnection</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 数据库连接从外部传入</span>
</span></span><span class=line><span class=cl>    <span class=c1># 优势：</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 可测试（传入Mock数据库）</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 可复用（不关心连接来源）</span>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 关注点分离</span>
</span></span><span class=line><span class=cl>    <span class=n>orders</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SELECT * FROM orders WHERE user_id = </span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>orders</span></span></span></code></pre></div><p>FastAPI的依赖注入系统让这一切变得简单优雅：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>HTTPException</span><span class=p>,</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 定义依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>common_parameters</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    公共查询参数依赖
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这是一个简单的依赖函数，返回一个字典
</span></span></span><span class=line><span class=cl><span class=s2>    FastAPI会：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 分析函数签名，获取参数
</span></span></span><span class=line><span class=cl><span class=s2>    2. 从请求中提取参数值
</span></span></span><span class=line><span class=cl><span class=s2>    3. 调用函数获取依赖值
</span></span></span><span class=line><span class=cl><span class=s2>    4. 将结果注入到路由函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;q&#34;</span><span class=p>:</span> <span class=n>q</span><span class=p>,</span> <span class=s2>&#34;skip&#34;</span><span class=p>:</span> <span class=n>skip</span><span class=p>,</span> <span class=s2>&#34;limit&#34;</span><span class=p>:</span> <span class=n>limit</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建类型别名，提高可读性</span>
</span></span><span class=line><span class=cl><span class=n>CommonParams</span> <span class=o>=</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>dict</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>common_parameters</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_items</span><span class=p>(</span><span class=n>commons</span><span class=p>:</span> <span class=n>CommonParams</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    这里的commons会自动获得common_parameters的返回值
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    执行流程：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 请求到达 /items/?q=test&amp;skip=10
</span></span></span><span class=line><span class=cl><span class=s2>    2. FastAPI调用common_parameters(q=&#34;test&#34;, skip=10, limit=100)
</span></span></span><span class=line><span class=cl><span class=s2>    3. 返回值 {&#34;q&#34;: &#34;test&#34;, &#34;skip&#34;: 10, &#34;limit&#34;: 100}
</span></span></span><span class=line><span class=cl><span class=s2>    4. 这个字典作为commons参数传给read_items
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=p>[</span><span class=o>...</span><span class=p>],</span> <span class=s2>&#34;params&#34;</span><span class=p>:</span> <span class=n>commons</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_users</span><span class=p>(</span><span class=n>commons</span><span class=p>:</span> <span class=n>CommonParams</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    同样的依赖可以在多个路由中复用
</span></span></span><span class=line><span class=cl><span class=s2>    这就是依赖注入的威力：代码复用 + 关注点分离
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;users&#34;</span><span class=p>:</span> <span class=p>[</span><span class=o>...</span><span class=p>],</span> <span class=s2>&#34;params&#34;</span><span class=p>:</span> <span class=n>commons</span><span class=p>}</span></span></span></code></pre></div><h3 id=42-类作为依赖>4.2 类作为依赖<a class=anchor href=#42-%e7%b1%bb%e4%bd%9c%e4%b8%ba%e4%be%9d%e8%b5%96>#</a></h3><p>当依赖逻辑复杂时，使用类可以提供更好的组织和封装：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>Query</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Pagination</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    分页参数依赖类
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用类的优势：
</span></span></span><span class=line><span class=cl><span class=s2>    - 可以有实例属性，存储计算后的值
</span></span></span><span class=line><span class=cl><span class=s2>    - 可以有方法，提供额外功能
</span></span></span><span class=line><span class=cl><span class=s2>    - 更好的IDE支持和类型提示
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>page</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;页码，从1开始&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>page_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Query</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;每页数量&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化方法就像普通依赖函数一样工作
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        FastAPI会：
</span></span></span><span class=line><span class=cl><span class=s2>        1. 分析__init__的参数
</span></span></span><span class=line><span class=cl><span class=s2>        2. 从请求中提取page和page_size
</span></span></span><span class=line><span class=cl><span class=s2>        3. 创建Pagination实例
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>page</span> <span class=o>=</span> <span class=n>page</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>page_size</span> <span class=o>=</span> <span class=n>page_size</span>
</span></span><span class=line><span class=cl>        <span class=c1># 计算派生值</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>skip</span> <span class=o>=</span> <span class=p>(</span><span class=n>page</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>page_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>limit</span> <span class=o>=</span> <span class=n>page_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>paginate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;便捷方法：应用分页到SQLAlchemy查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>query</span><span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>skip</span><span class=p>)</span><span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/items/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_items</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1># Depends()不带参数时，FastAPI会实例化Pagination类</span>
</span></span><span class=line><span class=cl>    <span class=n>pagination</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Pagination</span><span class=p>,</span> <span class=n>Depends</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    pagination是Pagination类的实例
</span></span></span><span class=line><span class=cl><span class=s2>    可以访问其属性和方法
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;page&#34;</span><span class=p>:</span> <span class=n>pagination</span><span class=o>.</span><span class=n>page</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;page_size&#34;</span><span class=p>:</span> <span class=n>pagination</span><span class=o>.</span><span class=n>page_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;skip&#34;</span><span class=p>:</span> <span class=n>pagination</span><span class=o>.</span><span class=n>skip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;limit&#34;</span><span class=p>:</span> <span class=n>pagination</span><span class=o>.</span><span class=n>limit</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><h3 id=43-依赖链构建复杂的依赖关系>4.3 依赖链：构建复杂的依赖关系<a class=anchor href=#43-%e4%be%9d%e8%b5%96%e9%93%be%e6%9e%84%e5%bb%ba%e5%a4%8d%e6%9d%82%e7%9a%84%e4%be%9d%e8%b5%96%e5%85%b3%e7%b3%bb>#</a></h3><p>FastAPI的依赖可以组成链式结构，解决复杂的依赖关系：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>HTTPException</span><span class=p>,</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 第一层：基础设施依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    数据库会话依赖
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用yield的依赖（上下文依赖）：
</span></span></span><span class=line><span class=cl><span class=s2>    - yield之前的代码在请求处理前执行
</span></span></span><span class=line><span class=cl><span class=s2>    - yield的值作为依赖注入
</span></span></span><span class=line><span class=cl><span class=s2>    - yield之后的代码在请求处理后执行（无论成功还是异常）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span> <span class=o>=</span> <span class=n>SessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>db</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>  <span class=c1># 成功则提交</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>  <span class=c1># 异常则回滚</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>  <span class=c1># 无论如何都关闭连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 第二层：认证依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_current_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>oauth2_scheme</span><span class=p>),</span>  <span class=c1># 从请求头获取token</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=p>:</span> <span class=n>Session</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)</span>          <span class=c1># 需要数据库来验证用户</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取当前登录用户
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这是一个组合依赖：
</span></span></span><span class=line><span class=cl><span class=s2>    - 依赖oauth2_scheme获取token
</span></span></span><span class=line><span class=cl><span class=s2>    - 依赖get_db获取数据库会话
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    执行顺序：
</span></span></span><span class=line><span class=cl><span class=s2>    1. oauth2_scheme从请求头提取token
</span></span></span><span class=line><span class=cl><span class=s2>    2. get_db创建数据库会话
</span></span></span><span class=line><span class=cl><span class=s2>    3. 本函数验证token，查询用户
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>credentials_exception</span> <span class=o>=</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;无法验证凭据&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;WWW-Authenticate&#34;</span><span class=p>:</span> <span class=s2>&#34;Bearer&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 验证token</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>SECRET_KEY</span><span class=p>,</span> <span class=n>algorithms</span><span class=o>=</span><span class=p>[</span><span class=n>ALGORITHM</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;sub&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>JWTError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 查询用户</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>User</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 第三层：权限检查依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_current_active_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>current_user</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取活跃用户
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    在get_current_user的基础上，额外检查用户是否被禁用
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>current_user</span><span class=o>.</span><span class=n>is_active</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_400_BAD_REQUEST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;用户已被禁用&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>current_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 第四层：角色检查依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>require_role</span><span class=p>(</span><span class=n>required_role</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    角色检查依赖工厂
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这是一个高阶函数，返回一个依赖
</span></span></span><span class=line><span class=cl><span class=s2>    允许参数化依赖行为
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>role_checker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>current_user</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_user</span><span class=o>.</span><span class=n>role</span> <span class=o>!=</span> <span class=n>required_role</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_403_FORBIDDEN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;需要 </span><span class=si>{</span><span class=n>required_role</span><span class=si>}</span><span class=s2> 角色&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>current_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>role_checker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 在路由中使用 =====</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users/me&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_current_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;任何登录用户都可以访问&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/admin/users&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>admin_list_users</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>admin</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>require_role</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>))],</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>Session</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    只有管理员可以访问
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    依赖执行顺序：
</span></span></span><span class=line><span class=cl><span class=s2>    1. oauth2_scheme提取token
</span></span></span><span class=line><span class=cl><span class=s2>    2. get_db创建数据库会话
</span></span></span><span class=line><span class=cl><span class=s2>    3. get_current_user验证token，获取用户
</span></span></span><span class=line><span class=cl><span class=s2>    4. get_current_active_user检查用户状态
</span></span></span><span class=line><span class=cl><span class=s2>    5. require_role(&#34;admin&#34;)检查角色
</span></span></span><span class=line><span class=cl><span class=s2>    6. 最后执行路由函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>users</span></span></span></code></pre></div><h3 id=44-路由级别依赖>4.4 路由级别依赖<a class=anchor href=#44-%e8%b7%af%e7%94%b1%e7%ba%a7%e5%88%ab%e4%be%9d%e8%b5%96>#</a></h3><p>有时候你需要给一组路由添加相同的依赖，FastAPI支持在路由器级别声明依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>APIRouter</span><span class=p>,</span> <span class=n>Depends</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个需要认证的路由器</span>
</span></span><span class=line><span class=cl><span class=n>authenticated_router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix</span><span class=o>=</span><span class=s2>&#34;/protected&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;Protected&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里的依赖会应用到这个路由器下的所有路由</span>
</span></span><span class=line><span class=cl>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>get_current_active_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@authenticated_router.get</span><span class=p>(</span><span class=s2>&#34;/resource1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_resource1</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自动需要认证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;resource&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@authenticated_router.get</span><span class=p>(</span><span class=s2>&#34;/resource2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_resource2</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自动需要认证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;resource&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建一个管理员路由器</span>
</span></span><span class=line><span class=cl><span class=n>admin_router</span> <span class=o>=</span> <span class=n>APIRouter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>prefix</span><span class=o>=</span><span class=s2>&#34;/admin&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;Admin&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>dependencies</span><span class=o>=</span><span class=p>[</span><span class=n>Depends</span><span class=p>(</span><span class=n>require_role</span><span class=p>(</span><span class=s2>&#34;admin&#34;</span><span class=p>))]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@admin_router.get</span><span class=p>(</span><span class=s2>&#34;/dashboard&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>admin_dashboard</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;只有管理员可以访问&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;admin area&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将路由器注册到主应用</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>include_router</span><span class=p>(</span><span class=n>authenticated_router</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>include_router</span><span class=p>(</span><span class=n>admin_router</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=5-中间件与生命周期>5. 中间件与生命周期<a class=anchor href=#5-%e4%b8%ad%e9%97%b4%e4%bb%b6%e4%b8%8e%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f>#</a></h2><h3 id=51-理解中间件>5.1 理解中间件<a class=anchor href=#51-%e7%90%86%e8%a7%a3%e4%b8%ad%e9%97%b4%e4%bb%b6>#</a></h3><p>中间件是处理请求/响应的"层"，它在路由函数执行前后运行，适合实现横切关注点（Cross-Cutting Concerns）。</p><p><strong>中间件的执行流程</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>请求 → 中间件A(前) → 中间件B(前) → 路由函数 → 中间件B(后) → 中间件A(后) → 响应</span></span></code></pre></div><p>像洋葱一样，后添加的中间件在内层。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.middleware.cors</span> <span class=kn>import</span> <span class=n>CORSMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 自定义中间件 =====</span>
</span></span><span class=line><span class=cl><span class=nd>@app.middleware</span><span class=p>(</span><span class=s2>&#34;http&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>request_middleware</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    请求处理中间件
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这个中间件做三件事：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 生成请求ID（用于追踪）
</span></span></span><span class=line><span class=cl><span class=s2>    2. 记录请求开始
</span></span></span><span class=line><span class=cl><span class=s2>    3. 计算处理时间
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 生成唯一请求ID</span>
</span></span><span class=line><span class=cl>    <span class=n>request_id</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;X-Request-ID&#34;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 记录请求开始时间</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 将request_id存入request.state，供路由函数使用</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=o>.</span><span class=n>state</span><span class=o>.</span><span class=n>request_id</span> <span class=o>=</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>request_id</span><span class=si>}</span><span class=s2>] 开始处理: </span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>method</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>request</span><span class=o>.</span><span class=n>url</span><span class=o>.</span><span class=n>path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 调用下一个中间件或路由</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这是关键！不调用call_next请求就不会被处理</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算处理时间</span>
</span></span><span class=line><span class=cl>        <span class=n>process_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 在响应头中添加有用信息</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-Request-ID&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-Process-Time&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>process_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>request_id</span><span class=si>}</span><span class=s2>] 处理完成: </span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2> &#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;耗时 </span><span class=si>{</span><span class=n>process_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>s&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 记录异常</span>
</span></span><span class=line><span class=cl>        <span class=n>process_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>request_id</span><span class=si>}</span><span class=s2>] 处理异常: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2> &#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;耗时 </span><span class=si>{</span><span class=n>process_time</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>s&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== CORS中间件 =====</span>
</span></span><span class=line><span class=cl><span class=c1># CORS（跨源资源共享）是Web安全的重要机制</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>CORSMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># 允许的源</span>
</span></span><span class=line><span class=cl>    <span class=c1># 开发环境可以用[&#34;*&#34;]，生产环境应该明确指定</span>
</span></span><span class=line><span class=cl>    <span class=n>allow_origins</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;http://localhost:3000&#34;</span><span class=p>,</span>     <span class=c1># 本地前端</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;https://myapp.com&#34;</span><span class=p>,</span>         <span class=c1># 生产前端</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1># 是否允许携带凭据（cookies、Authorization头）</span>
</span></span><span class=line><span class=cl>    <span class=n>allow_credentials</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1># 允许的HTTP方法</span>
</span></span><span class=line><span class=cl>    <span class=n>allow_methods</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1># 允许的请求头</span>
</span></span><span class=line><span class=cl>    <span class=n>allow_headers</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;*&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=c1># 预检请求的缓存时间</span>
</span></span><span class=line><span class=cl>    <span class=n>max_age</span><span class=o>=</span><span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h3 id=52-高级中间件限流>5.2 高级中间件：限流<a class=anchor href=#52-%e9%ab%98%e7%ba%a7%e4%b8%ad%e9%97%b4%e4%bb%b6%e9%99%90%e6%b5%81>#</a></h3><p>限流是保护API的重要手段，防止滥用和DDoS攻击：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.middleware.base</span> <span class=kn>import</span> <span class=n>BaseHTTPMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.requests</span> <span class=kn>import</span> <span class=n>Request</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>starlette.responses</span> <span class=kn>import</span> <span class=n>Response</span><span class=p>,</span> <span class=n>JSONResponse</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitMiddleware</span><span class=p>(</span><span class=n>BaseHTTPMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    速率限制中间件
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    实现滑动窗口限流算法：
</span></span></span><span class=line><span class=cl><span class=s2>    - 记录每个IP的请求时间戳
</span></span></span><span class=line><span class=cl><span class=s2>    - 只保留时间窗口内的记录
</span></span></span><span class=line><span class=cl><span class=s2>    - 超过限制返回429
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    注意：这是简化实现，生产环境应该使用Redis
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>app</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>requests_per_minute</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>window_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>requests_per_minute</span> <span class=o>=</span> <span class=n>requests_per_minute</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window_size</span> <span class=o>=</span> <span class=n>window_size</span>
</span></span><span class=line><span class=cl>        <span class=c1># 存储请求记录：{ip: [timestamp1, timestamp2, ...]}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 用于清理过期记录</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_cleanup_lock</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>dispatch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取客户端IP</span>
</span></span><span class=line><span class=cl>        <span class=c1># 注意：如果在反向代理后面，应该从X-Forwarded-For获取</span>
</span></span><span class=line><span class=cl>        <span class=n>client_ip</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>client</span><span class=o>.</span><span class=n>host</span>
</span></span><span class=line><span class=cl>        <span class=n>forwarded_for</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>headers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;X-Forwarded-For&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>forwarded_for</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>client_ip</span> <span class=o>=</span> <span class=n>forwarded_for</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 清理过期记录（避免内存泄漏）</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cleanup_lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>client_ip</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 只保留窗口内的请求</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_ip</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_ip</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>current_time</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>window_size</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否超过限制</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_requests</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_ip</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_requests</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests_per_minute</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 计算重试时间</span>
</span></span><span class=line><span class=cl>            <span class=n>oldest_request</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>recent_requests</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>retry_after</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>window_size</span> <span class=o>-</span> <span class=p>(</span><span class=n>current_time</span> <span class=o>-</span> <span class=n>oldest_request</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>JSONResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>status_code</span><span class=o>=</span><span class=mi>429</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Too Many Requests&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;detail&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;超过速率限制（</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>requests_per_minute</span><span class=si>}</span><span class=s2>次/分钟）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;retry_after&#34;</span><span class=p>:</span> <span class=n>retry_after</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span>
</span></span><span class=line><span class=cl>                <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;Retry-After&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>retry_after</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录本次请求</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_ip</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>current_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 处理请求</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加限流信息到响应头</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-RateLimit-Limit&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>requests_per_minute</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-RateLimit-Remaining&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>requests_per_minute</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_ip</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加中间件</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span><span class=n>RateLimitMiddleware</span><span class=p>,</span> <span class=n>requests_per_minute</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span></span></span></code></pre></div><h3 id=53-中间件-vs-依赖注入如何选择>5.3 中间件 vs 依赖注入：如何选择？<a class=anchor href=#53-%e4%b8%ad%e9%97%b4%e4%bb%b6-vs-%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5%e5%a6%82%e4%bd%95%e9%80%89%e6%8b%a9>#</a></h3><p>这是一个常见的设计决策。两者的区别：</p><table><thead><tr><th>特性</th><th>中间件</th><th>依赖注入</th></tr></thead><tbody><tr><td>执行范围</td><td>所有请求</td><td>指定路由</td></tr><tr><td>访问响应</td><td>✓ 可以</td><td>✗ 不能</td></tr><tr><td>返回早期响应</td><td>✓ 可以</td><td>✓ 可以（抛异常）</td></tr><tr><td>修改响应头</td><td>✓ 可以</td><td>✗ 不能</td></tr><tr><td>测试便利性</td><td>中等</td><td>优秀（易于mock）</td></tr><tr><td>典型用途</td><td>日志、CORS、限流</td><td>认证、数据库、参数验证</td></tr></tbody></table><p><strong>选择建议</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 使用中间件：需要处理所有请求，或需要修改响应</span>
</span></span><span class=line><span class=cl><span class=nd>@app.middleware</span><span class=p>(</span><span class=s2>&#34;http&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>add_security_headers</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>Request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-Content-Type-Options&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;nosniff&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span><span class=o>.</span><span class=n>headers</span><span class=p>[</span><span class=s2>&#34;X-Frame-Options&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;DENY&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用依赖注入：只需要处理特定路由，或需要复杂的依赖关系</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/protected&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>protected_route</span><span class=p>(</span><span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>}</span></span></span></code></pre></div><hr><h2 id=6-认证与安全>6. 认证与安全<a class=anchor href=#6-%e8%ae%a4%e8%af%81%e4%b8%8e%e5%ae%89%e5%85%a8>#</a></h2><h3 id=61-理解oauth2>6.1 理解OAuth2<a class=anchor href=#61-%e7%90%86%e8%a7%a3oauth2>#</a></h3><p>OAuth2是现代Web认证的标准协议。FastAPI内置了完整的OAuth2支持。</p><p><strong>OAuth2 Password Flow的工作原理</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 用户提交用户名和密码
</span></span><span class=line><span class=cl>2. 服务器验证凭据
</span></span><span class=line><span class=cl>3. 验证成功，服务器返回JWT token
</span></span><span class=line><span class=cl>4. 后续请求携带token
</span></span><span class=line><span class=cl>5. 服务器验证token，获取用户身份</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>Depends</span><span class=p>,</span> <span class=n>HTTPException</span><span class=p>,</span> <span class=n>status</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.security</span> <span class=kn>import</span> <span class=n>OAuth2PasswordBearer</span><span class=p>,</span> <span class=n>OAuth2PasswordRequestForm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>jose</span> <span class=kn>import</span> <span class=n>JWTError</span><span class=p>,</span> <span class=n>jwt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>passlib.context</span> <span class=kn>import</span> <span class=n>CryptContext</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 配置 =====</span>
</span></span><span class=line><span class=cl><span class=n>SECRET_KEY</span> <span class=o>=</span> <span class=s2>&#34;your-secret-key-keep-it-secret&#34;</span>  <span class=c1># 生产环境使用环境变量</span>
</span></span><span class=line><span class=cl><span class=n>ALGORITHM</span> <span class=o>=</span> <span class=s2>&#34;HS256&#34;</span>
</span></span><span class=line><span class=cl><span class=n>ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class=o>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 密码哈希 =====</span>
</span></span><span class=line><span class=cl><span class=c1># 使用bcrypt算法，这是目前推荐的密码哈希算法</span>
</span></span><span class=line><span class=cl><span class=c1># 特点：慢（故意的，防止暴力破解）、自动加盐</span>
</span></span><span class=line><span class=cl><span class=n>pwd_context</span> <span class=o>=</span> <span class=n>CryptContext</span><span class=p>(</span><span class=n>schemes</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;bcrypt&#34;</span><span class=p>],</span> <span class=n>deprecated</span><span class=o>=</span><span class=s2>&#34;auto&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== OAuth2配置 =====</span>
</span></span><span class=line><span class=cl><span class=c1># tokenUrl是获取token的路径，用于Swagger UI的认证表单</span>
</span></span><span class=line><span class=cl><span class=n>oauth2_scheme</span> <span class=o>=</span> <span class=n>OAuth2PasswordBearer</span><span class=p>(</span><span class=n>tokenUrl</span><span class=o>=</span><span class=s2>&#34;token&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 数据模型 =====</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Token</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Token响应模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>access_token</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>token_type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>expires_in</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># token有效期（秒）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TokenData</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Token解析后的数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用户模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>is_active</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserInDB</span><span class=p>(</span><span class=n>User</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据库中的用户（包含密码哈希）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>hashed_password</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 密码工具函数 =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_password</span><span class=p>(</span><span class=n>plain_password</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>hashed_password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    验证密码
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    为什么不直接比较？
</span></span></span><span class=line><span class=cl><span class=s2>    - 密码存储的是哈希值，不是明文
</span></span></span><span class=line><span class=cl><span class=s2>    - 需要用相同的算法处理输入的密码，再比较哈希
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pwd_context</span><span class=o>.</span><span class=n>verify</span><span class=p>(</span><span class=n>plain_password</span><span class=p>,</span> <span class=n>hashed_password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_password_hash</span><span class=p>(</span><span class=n>password</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    生成密码哈希
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    bcrypt的特点：
</span></span></span><span class=line><span class=cl><span class=s2>    - 自动生成随机盐
</span></span></span><span class=line><span class=cl><span class=s2>    - 盐存储在哈希结果中
</span></span></span><span class=line><span class=cl><span class=s2>    - 每次哈希结果不同（因为盐不同），但验证时都能通过
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pwd_context</span><span class=o>.</span><span class=n>hash</span><span class=p>(</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== JWT工具函数 =====</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_access_token</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>expires_delta</span><span class=p>:</span> <span class=n>timedelta</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建JWT访问令牌
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    JWT结构：header.payload.signature
</span></span></span><span class=line><span class=cl><span class=s2>    - header: 算法和类型
</span></span></span><span class=line><span class=cl><span class=s2>    - payload: 用户数据（不要放敏感信息！）
</span></span></span><span class=line><span class=cl><span class=s2>    - signature: 签名，防止篡改
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>to_encode</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 设置过期时间</span>
</span></span><span class=line><span class=cl>    <span class=n>expire</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span> <span class=o>+</span> <span class=p>(</span><span class=n>expires_delta</span> <span class=ow>or</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=mi>15</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>to_encode</span><span class=o>.</span><span class=n>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;exp&#34;</span><span class=p>:</span> <span class=n>expire</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;iat&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>(),</span>  <span class=c1># 签发时间</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;access&#34;</span>           <span class=c1># 令牌类型</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 生成JWT</span>
</span></span><span class=line><span class=cl>    <span class=n>encoded_jwt</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>to_encode</span><span class=p>,</span> <span class=n>SECRET_KEY</span><span class=p>,</span> <span class=n>algorithm</span><span class=o>=</span><span class=n>ALGORITHM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>encoded_jwt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 用户认证依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_current_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>oauth2_scheme</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    从token获取当前用户
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这是核心认证逻辑，被其他需要认证的路由依赖
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>credentials_exception</span> <span class=o>=</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;无法验证凭据&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;WWW-Authenticate&#34;</span><span class=p>:</span> <span class=s2>&#34;Bearer&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 解码JWT</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>SECRET_KEY</span><span class=p>,</span> <span class=n>algorithms</span><span class=o>=</span><span class=p>[</span><span class=n>ALGORITHM</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取用户信息</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;sub&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>username</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>token_data</span> <span class=o>=</span> <span class=n>TokenData</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>JWTError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># JWT解码失败（过期、签名无效等）</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 从数据库获取用户（这里简化为模拟）</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>get_user_from_db</span><span class=p>(</span><span class=n>token_data</span><span class=o>.</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>credentials_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 登录端点 =====</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/token&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>Token</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>login</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>form_data</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>OAuth2PasswordRequestForm</span><span class=p>,</span> <span class=n>Depends</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    用户登录，获取访问令牌
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    OAuth2PasswordRequestForm是标准的OAuth2密码流表单：
</span></span></span><span class=line><span class=cl><span class=s2>    - username: 用户名
</span></span></span><span class=line><span class=cl><span class=s2>    - password: 密码
</span></span></span><span class=line><span class=cl><span class=s2>    - scope: 权限范围（可选）
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 验证用户凭据</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=n>authenticate_user</span><span class=p>(</span><span class=n>form_data</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=n>form_data</span><span class=o>.</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_401_UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;用户名或密码错误&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;WWW-Authenticate&#34;</span><span class=p>:</span> <span class=s2>&#34;Bearer&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 创建访问令牌</span>
</span></span><span class=line><span class=cl>    <span class=n>access_token_expires</span> <span class=o>=</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=n>ACCESS_TOKEN_EXPIRE_MINUTES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>access_token</span> <span class=o>=</span> <span class=n>create_access_token</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sub&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>expires_delta</span><span class=o>=</span><span class=n>access_token_expires</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 返回令牌</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Token</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>access_token</span><span class=o>=</span><span class=n>access_token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>token_type</span><span class=o>=</span><span class=s2>&#34;bearer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>expires_in</span><span class=o>=</span><span class=n>ACCESS_TOKEN_EXPIRE_MINUTES</span> <span class=o>*</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 受保护的端点 =====</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/users/me&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>read_users_me</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>current_user</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    获取当前登录用户信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    由于依赖get_current_user，未认证的请求会返回401
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>current_user</span></span></span></code></pre></div><h3 id=62-基于角色的访问控制rbac>6.2 基于角色的访问控制（RBAC）<a class=anchor href=#62-%e5%9f%ba%e4%ba%8e%e8%a7%92%e8%89%b2%e7%9a%84%e8%ae%bf%e9%97%ae%e6%8e%a7%e5%88%b6rbac>#</a></h3><p>实际应用通常需要更细粒度的权限控制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Permission</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;权限枚举&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>READ</span> <span class=o>=</span> <span class=s2>&#34;read&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>WRITE</span> <span class=o>=</span> <span class=s2>&#34;write&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>DELETE</span> <span class=o>=</span> <span class=s2>&#34;delete&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ADMIN</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Role</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;角色枚举&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>VIEWER</span> <span class=o>=</span> <span class=s2>&#34;viewer&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>EDITOR</span> <span class=o>=</span> <span class=s2>&#34;editor&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ADMIN</span> <span class=o>=</span> <span class=s2>&#34;admin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 角色-权限映射</span>
</span></span><span class=line><span class=cl><span class=n>ROLE_PERMISSIONS</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Role</span><span class=o>.</span><span class=n>VIEWER</span><span class=p>:</span> <span class=p>[</span><span class=n>Permission</span><span class=o>.</span><span class=n>READ</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Role</span><span class=o>.</span><span class=n>EDITOR</span><span class=p>:</span> <span class=p>[</span><span class=n>Permission</span><span class=o>.</span><span class=n>READ</span><span class=p>,</span> <span class=n>Permission</span><span class=o>.</span><span class=n>WRITE</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>Role</span><span class=o>.</span><span class=n>ADMIN</span><span class=p>:</span> <span class=p>[</span><span class=n>Permission</span><span class=o>.</span><span class=n>READ</span><span class=p>,</span> <span class=n>Permission</span><span class=o>.</span><span class=n>WRITE</span><span class=p>,</span> <span class=n>Permission</span><span class=o>.</span><span class=n>DELETE</span><span class=p>,</span> <span class=n>Permission</span><span class=o>.</span><span class=n>ADMIN</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>role</span><span class=p>:</span> <span class=n>Role</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>require_permissions</span><span class=p>(</span><span class=o>*</span><span class=n>required_permissions</span><span class=p>:</span> <span class=n>Permission</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    权限检查依赖工厂
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用方式：
</span></span></span><span class=line><span class=cl><span class=s2>    @app.delete(&#34;/items/</span><span class=si>{id}</span><span class=s2>&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>    async def delete_item(
</span></span></span><span class=line><span class=cl><span class=s2>        id: int,
</span></span></span><span class=line><span class=cl><span class=s2>        user: User = Depends(require_permissions(Permission.DELETE))
</span></span></span><span class=line><span class=cl><span class=s2>    ):
</span></span></span><span class=line><span class=cl><span class=s2>        ...
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>permission_checker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>current_user</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_current_user</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取用户的所有权限</span>
</span></span><span class=line><span class=cl>        <span class=n>user_permissions</span> <span class=o>=</span> <span class=n>ROLE_PERMISSIONS</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>current_user</span><span class=o>.</span><span class=n>role</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否拥有所需权限</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>perm</span> <span class=ow>in</span> <span class=n>required_permissions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>perm</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_permissions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>status_code</span><span class=o>=</span><span class=n>status</span><span class=o>.</span><span class=n>HTTP_403_FORBIDDEN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>detail</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;需要 </span><span class=si>{</span><span class=n>perm</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2> 权限&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>current_user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>permission_checker</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/articles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>list_articles</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>require_permissions</span><span class=p>(</span><span class=n>Permission</span><span class=o>.</span><span class=n>READ</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;任何角色都可以读取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;articles&#34;</span><span class=p>:</span> <span class=p>[</span><span class=o>...</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/articles&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_article</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>article</span><span class=p>:</span> <span class=n>Article</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>require_permissions</span><span class=p>(</span><span class=n>Permission</span><span class=o>.</span><span class=n>WRITE</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;需要写入权限&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;created&#34;</span><span class=p>:</span> <span class=n>article</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.delete</span><span class=p>(</span><span class=s2>&#34;/articles/</span><span class=si>{id}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>delete_article</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=p>:</span> <span class=n>User</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>require_permissions</span><span class=p>(</span><span class=n>Permission</span><span class=o>.</span><span class=n>DELETE</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;需要删除权限（只有管理员）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;deleted&#34;</span><span class=p>:</span> <span class=nb>id</span><span class=p>}</span></span></span></code></pre></div><hr><h2 id=7-数据库集成>7. 数据库集成<a class=anchor href=#7-%e6%95%b0%e6%8d%ae%e5%ba%93%e9%9b%86%e6%88%90>#</a></h2><h3 id=71-sqlalchemy异步集成>7.1 SQLAlchemy异步集成<a class=anchor href=#71-sqlalchemy%e5%bc%82%e6%ad%a5%e9%9b%86%e6%88%90>#</a></h3><p>现代FastAPI应用推荐使用异步数据库操作。SQLAlchemy 2.0完全支持async/await：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.asyncio</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>create_async_engine</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>async_sessionmaker</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>DeclarativeBase</span><span class=p>,</span> <span class=n>Mapped</span><span class=p>,</span> <span class=n>mapped_column</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>String</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>,</span> <span class=n>select</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>AsyncGenerator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 数据库配置 =====</span>
</span></span><span class=line><span class=cl><span class=c1># 异步PostgreSQL连接需要使用asyncpg驱动</span>
</span></span><span class=line><span class=cl><span class=n>DATABASE_URL</span> <span class=o>=</span> <span class=s2>&#34;postgresql+asyncpg://user:password@localhost/dbname&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建异步引擎</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_async_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>DATABASE_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>echo</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>           <span class=c1># 开发环境打印SQL，生产环境关闭</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_size</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>        <span class=c1># 连接池大小</span>
</span></span><span class=line><span class=cl>    <span class=n>max_overflow</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>     <span class=c1># 超出pool_size时可额外创建的连接数</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_recycle</span><span class=o>=</span><span class=mi>3600</span><span class=p>,</span>   <span class=c1># 连接回收时间，防止数据库断开空闲连接</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_pre_ping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># 使用前检查连接是否有效</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建会话工厂</span>
</span></span><span class=line><span class=cl><span class=n>async_session</span> <span class=o>=</span> <span class=n>async_sessionmaker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>engine</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>class_</span><span class=o>=</span><span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>expire_on_commit</span><span class=o>=</span><span class=kc>False</span>  <span class=c1># 提交后不过期对象，避免额外查询</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 模型定义 =====</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Base</span><span class=p>(</span><span class=n>DeclarativeBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;所有模型的基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    用户模型
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    SQLAlchemy 2.0使用Mapped和mapped_column进行类型安全的定义
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;users&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 主键</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 唯一索引列</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>50</span><span class=p>),</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 普通列</span>
</span></span><span class=line><span class=cl>    <span class=n>hashed_password</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>255</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>is_active</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 带默认值的时间戳</span>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>updated_at</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=n>datetime</span> <span class=o>|</span> <span class=kc>None</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>onupdate</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Article</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;文章模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&#34;articles&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>String</span><span class=p>(</span><span class=mi>200</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>()</span>  <span class=c1># TEXT类型</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 外键关联</span>
</span></span><span class=line><span class=cl>    <span class=n>author_id</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s2>&#34;users.id&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>created_at</span><span class=p>:</span> <span class=n>Mapped</span><span class=p>[</span><span class=n>datetime</span><span class=p>]</span> <span class=o>=</span> <span class=n>mapped_column</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 数据库会话依赖 =====</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_db</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>AsyncGenerator</span><span class=p>[</span><span class=n>AsyncSession</span><span class=p>,</span> <span class=kc>None</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    数据库会话依赖
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用async with确保会话正确关闭
</span></span></span><span class=line><span class=cl><span class=s2>    使用try/except处理异常时的回滚
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>async_session</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>session</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span></span></span></code></pre></div><h3 id=72-crud操作模式>7.2 CRUD操作模式<a class=anchor href=#72-crud%e6%93%8d%e4%bd%9c%e6%a8%a1%e5%bc%8f>#</a></h3><p>组织良好的CRUD操作可以提高代码复用性和可维护性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>select</span><span class=p>,</span> <span class=n>update</span><span class=p>,</span> <span class=n>delete</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.asyncio</span> <span class=kn>import</span> <span class=n>AsyncSession</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>TypeVar</span><span class=p>,</span> <span class=n>Generic</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 泛型类型</span>
</span></span><span class=line><span class=cl><span class=n>ModelType</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s2>&#34;ModelType&#34;</span><span class=p>,</span> <span class=n>bound</span><span class=o>=</span><span class=n>Base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CreateSchemaType</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s2>&#34;CreateSchemaType&#34;</span><span class=p>,</span> <span class=n>bound</span><span class=o>=</span><span class=n>BaseModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>UpdateSchemaType</span> <span class=o>=</span> <span class=n>TypeVar</span><span class=p>(</span><span class=s2>&#34;UpdateSchemaType&#34;</span><span class=p>,</span> <span class=n>bound</span><span class=o>=</span><span class=n>BaseModel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CRUDBase</span><span class=p>(</span><span class=n>Generic</span><span class=p>[</span><span class=n>ModelType</span><span class=p>,</span> <span class=n>CreateSchemaType</span><span class=p>,</span> <span class=n>UpdateSchemaType</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    通用CRUD基类
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    提供标准的增删改查操作，子类可以继承并扩展
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model</span><span class=p>:</span> <span class=nb>type</span><span class=p>[</span><span class=n>ModelType</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelType</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据ID获取单个记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>select</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>scalar_one_or_none</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_multi</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>skip</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=n>ModelType</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取多条记录，支持分页&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>select</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>offset</span><span class=p>(</span><span class=n>skip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>id</span><span class=o>.</span><span class=n>desc</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>scalars</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_in</span><span class=p>:</span> <span class=n>CreateSchemaType</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建新记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 将Pydantic模型转换为字典</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_in_data</span> <span class=o>=</span> <span class=n>obj_in</span><span class=o>.</span><span class=n>model_dump</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 创建数据库模型实例</span>
</span></span><span class=line><span class=cl>        <span class=n>db_obj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>obj_in_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># flush将对象持久化到数据库，但不提交事务</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># refresh获取数据库生成的值（如自增ID）</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>db_obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>update</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db_obj</span><span class=p>:</span> <span class=n>ModelType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_in</span><span class=p>:</span> <span class=n>UpdateSchemaType</span> <span class=o>|</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelType</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;更新记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 处理输入数据</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>obj_in</span><span class=p>,</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>update_data</span> <span class=o>=</span> <span class=n>obj_in</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>update_data</span> <span class=o>=</span> <span class=n>obj_in</span><span class=o>.</span><span class=n>model_dump</span><span class=p>(</span><span class=n>exclude_unset</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新对象属性</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>update_data</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>db_obj</span><span class=p>,</span> <span class=n>field</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>setattr</span><span class=p>(</span><span class=n>db_obj</span><span class=p>,</span> <span class=n>field</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>db_obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;删除记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>delete</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>rowcount</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 用户CRUD =====</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserCreate</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UserUpdate</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>is_active</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CRUDUser</span><span class=p>(</span><span class=n>CRUDBase</span><span class=p>[</span><span class=n>User</span><span class=p>,</span> <span class=n>UserCreate</span><span class=p>,</span> <span class=n>UserUpdate</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    用户CRUD操作
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    继承通用CRUD，添加用户特定的操作
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_by_email</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据邮箱获取用户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>select</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>email</span> <span class=o>==</span> <span class=n>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>scalar_one_or_none</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_by_username</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据用户名获取用户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>select</span><span class=p>(</span><span class=n>User</span><span class=p>)</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>User</span><span class=o>.</span><span class=n>username</span> <span class=o>==</span> <span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>scalar_one_or_none</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_in</span><span class=p>:</span> <span class=n>UserCreate</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建用户（密码需要哈希）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>db_obj</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>username</span><span class=o>=</span><span class=n>obj_in</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>email</span><span class=o>=</span><span class=n>obj_in</span><span class=o>.</span><span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>hashed_password</span><span class=o>=</span><span class=n>get_password_hash</span><span class=p>(</span><span class=n>obj_in</span><span class=o>.</span><span class=n>password</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>db_obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>db_obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>authenticate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>username</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>User</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证用户凭据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_by_username</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>user</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>verify_password</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>user</span><span class=o>.</span><span class=n>hashed_password</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建CRUD实例</span>
</span></span><span class=line><span class=cl><span class=n>user_crud</span> <span class=o>=</span> <span class=n>CRUDUser</span><span class=p>(</span><span class=n>User</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 在路由中使用 =====</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>UserResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user_in</span><span class=p>:</span> <span class=n>UserCreate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>AsyncSession</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建新用户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 检查用户名是否已存在</span>
</span></span><span class=line><span class=cl>    <span class=n>existing</span> <span class=o>=</span> <span class=k>await</span> <span class=n>user_crud</span><span class=o>.</span><span class=n>get_by_username</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>user_in</span><span class=o>.</span><span class=n>username</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>existing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;用户名已被使用&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查邮箱是否已存在</span>
</span></span><span class=line><span class=cl>    <span class=n>existing</span> <span class=o>=</span> <span class=k>await</span> <span class=n>user_crud</span><span class=o>.</span><span class=n>get_by_email</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>user_in</span><span class=o>.</span><span class=n>email</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>existing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>status_code</span><span class=o>=</span><span class=mi>400</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>detail</span><span class=o>=</span><span class=s2>&#34;邮箱已被使用&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建用户</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>user_crud</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>obj_in</span><span class=o>=</span><span class=n>user_in</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user</span></span></span></code></pre></div><hr><h2 id=8-后台任务与websocket>8. 后台任务与WebSocket<a class=anchor href=#8-%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1%e4%b8%8ewebsocket>#</a></h2><h3 id=81-后台任务>8.1 后台任务<a class=anchor href=#81-%e5%90%8e%e5%8f%b0%e4%bb%bb%e5%8a%a1>#</a></h3><p>有些操作不需要让用户等待，比如发送邮件、生成报告等。FastAPI提供了简单的后台任务机制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>BackgroundTasks</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>write_log</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    写日志的后台任务
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    这个函数会在响应发送后执行
</span></span></span><span class=line><span class=cl><span class=s2>    即使它执行很慢，也不会影响响应时间
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;log.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>send_email_async</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>subject</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>body</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    异步发送邮件
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    后台任务也可以是async函数
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 模拟发送邮件</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;邮件已发送到 </span><span class=si>{</span><span class=n>email</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_user</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=p>:</span> <span class=n>UserCreate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>background_tasks</span><span class=p>:</span> <span class=n>BackgroundTasks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>AsyncSession</span><span class=p>,</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    创建用户并发送欢迎邮件
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    邮件发送在后台进行，用户无需等待
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建用户</span>
</span></span><span class=line><span class=cl>    <span class=n>new_user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>user_crud</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>db</span><span class=p>,</span> <span class=n>obj_in</span><span class=o>=</span><span class=n>user</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 添加后台任务</span>
</span></span><span class=line><span class=cl>    <span class=c1># 注意：这只是添加到队列，不会立即执行</span>
</span></span><span class=line><span class=cl>    <span class=n>background_tasks</span><span class=o>.</span><span class=n>add_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>send_email_async</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>email</span><span class=o>=</span><span class=n>user</span><span class=o>.</span><span class=n>email</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>subject</span><span class=o>=</span><span class=s2>&#34;欢迎加入！&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>body</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;你好 </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>，欢迎使用我们的服务！&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 添加多个后台任务</span>
</span></span><span class=line><span class=cl>    <span class=n>background_tasks</span><span class=o>.</span><span class=n>add_task</span><span class=p>(</span><span class=n>write_log</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;新用户注册: </span><span class=si>{</span><span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 立即返回响应，后台任务稍后执行</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>new_user</span></span></span></code></pre></div><p><strong>后台任务的限制</strong>：</p><p>后台任务适合简单、快速的操作。对于以下情况，应该使用专门的任务队列（如Celery）：</p><ul><li>执行时间很长（几分钟甚至几小时）</li><li>需要重试机制</li><li>需要任务状态追踪</li><li>需要在多个服务器间分布执行</li></ul><h3 id=82-websocket实时通信>8.2 WebSocket实时通信<a class=anchor href=#82-websocket%e5%ae%9e%e6%97%b6%e9%80%9a%e4%bf%a1>#</a></h3><p>WebSocket提供了全双工通信能力，适合聊天、通知、实时数据等场景：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>WebSocket</span><span class=p>,</span> <span class=n>WebSocketDisconnect</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConnectionManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    WebSocket连接管理器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    职责：
</span></span></span><span class=line><span class=cl><span class=s2>    - 维护活跃连接列表
</span></span></span><span class=line><span class=cl><span class=s2>    - 管理连接的加入和断开
</span></span></span><span class=line><span class=cl><span class=s2>    - 提供广播和定向发送能力
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 按房间组织连接</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>WebSocket</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=c1># 连接到用户的映射</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_users</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=n>WebSocket</span><span class=p>,</span> <span class=nb>dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>connect</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>room</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_info</span><span class=p>:</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        建立连接
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        连接建立流程：
</span></span></span><span class=line><span class=cl><span class=s2>        1. 接受WebSocket握手
</span></span></span><span class=line><span class=cl><span class=s2>        2. 将连接添加到房间
</span></span></span><span class=line><span class=cl><span class=s2>        3. 记录用户信息
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>room</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>[</span><span class=n>room</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>[</span><span class=n>room</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>websocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_users</span><span class=p>[</span><span class=n>websocket</span><span class=p>]</span> <span class=o>=</span> <span class=n>user_info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 广播加入消息</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>broadcast_to_room</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>room</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>user_info</span><span class=p>[</span><span class=s1>&#39;username&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> 加入了房间&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=n>exclude</span><span class=o>=</span><span class=n>websocket</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>disconnect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span> <span class=n>room</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;断开连接&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>room</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>[</span><span class=n>room</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>websocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>[</span><span class=n>room</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=p>[</span><span class=n>room</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>user_info</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_users</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>user_info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>send_personal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;发送私人消息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>send_json</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>broadcast_to_room</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>room</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>exclude</span><span class=p>:</span> <span class=n>WebSocket</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        广播消息到房间内所有连接
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        exclude参数用于排除发送者自己
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>connection</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>room</span><span class=p>,</span> <span class=p>[]):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>connection</span> <span class=o>!=</span> <span class=n>exclude</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>connection</span><span class=o>.</span><span class=n>send_json</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 连接可能已断开</span>
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_room_users</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>room</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取房间内的用户列表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>users</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>conn</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_connections</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>room</span><span class=p>,</span> <span class=p>[]):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>conn</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_users</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>users</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>connection_users</span><span class=p>[</span><span class=n>conn</span><span class=p>][</span><span class=s1>&#39;username&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>users</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>manager</span> <span class=o>=</span> <span class=n>ConnectionManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.websocket</span><span class=p>(</span><span class=s2>&#34;/ws/chat/</span><span class=si>{room}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>websocket_endpoint</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>websocket</span><span class=p>:</span> <span class=n>WebSocket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>room</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>token</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># 通过查询参数传递token</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    聊天室WebSocket端点
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    连接URL示例: ws://localhost:8000/ws/chat/general?token=xxx
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 验证token</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=k>await</span> <span class=n>verify_token</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>close</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=mi>4001</span><span class=p>,</span> <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;认证失败&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>user_info</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 建立连接</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>manager</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=n>room</span><span class=p>,</span> <span class=n>user_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 发送房间信息</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>manager</span><span class=o>.</span><span class=n>send_personal</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;room_info&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;room&#34;</span><span class=p>:</span> <span class=n>room</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;users&#34;</span><span class=p>:</span> <span class=n>manager</span><span class=o>.</span><span class=n>get_room_users</span><span class=p>(</span><span class=n>room</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 接收消息</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>websocket</span><span class=o>.</span><span class=n>receive_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 处理不同类型的消息</span>
</span></span><span class=line><span class=cl>            <span class=n>msg_type</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;type&#34;</span><span class=p>,</span> <span class=s2>&#34;message&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>msg_type</span> <span class=o>==</span> <span class=s2>&#34;message&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 广播聊天消息</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>manager</span><span class=o>.</span><span class=n>broadcast_to_room</span><span class=p>(</span><span class=n>room</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;message&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>msg_type</span> <span class=o>==</span> <span class=s2>&#34;typing&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 广播正在输入状态</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>manager</span><span class=o>.</span><span class=n>broadcast_to_room</span><span class=p>(</span><span class=n>room</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;typing&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=n>user</span><span class=o>.</span><span class=n>username</span>
</span></span><span class=line><span class=cl>                <span class=p>},</span> <span class=n>exclude</span><span class=o>=</span><span class=n>websocket</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>WebSocketDisconnect</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 处理断开连接</span>
</span></span><span class=line><span class=cl>        <span class=n>user_info</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>disconnect</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=n>room</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>manager</span><span class=o>.</span><span class=n>broadcast_to_room</span><span class=p>(</span><span class=n>room</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;system&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>user_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=s1>&#39;Unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2> 离开了房间&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span></span></span></code></pre></div><hr><h2 id=9-测试策略>9. 测试策略<a class=anchor href=#9-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>#</a></h2><h3 id=91-测试的重要性>9.1 测试的重要性<a class=anchor href=#91-%e6%b5%8b%e8%af%95%e7%9a%84%e9%87%8d%e8%a6%81%e6%80%a7>#</a></h3><p>好的测试是高质量软件的基石。FastAPI的设计让测试变得非常简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># test_main.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>main</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TestClient使用requests库，提供同步的测试接口</span>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>TestClient</span><span class=p>(</span><span class=n>app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestUserAPI</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;用户API测试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_create_user_success</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试成功创建用户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/users/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;testuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;test@example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;TestPass123&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;testuser&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;test@example.com&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;password&#34;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>data</span>  <span class=c1># 确保密码不返回</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;id&#34;</span> <span class=ow>in</span> <span class=n>data</span>  <span class=c1># 确保返回了ID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_create_user_invalid_email</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试邮箱格式无效&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/users/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;testuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;invalid-email&#34;</span><span class=p>,</span>  <span class=c1># 无效邮箱</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;TestPass123&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>422</span>  <span class=c1># 验证错误</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;detail&#34;</span> <span class=ow>in</span> <span class=n>error</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_create_user_weak_password</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试弱密码&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/users/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;testuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;test@example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;weak&#34;</span>  <span class=c1># 太短</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>422</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_get_user_not_found</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试用户不存在&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/users/99999&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>404</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestAuthentication</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;认证测试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login_success</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试登录成功&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 先创建用户</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;loginuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;login@example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;TestPass123&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 登录</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span>  <span class=c1># OAuth2使用form data</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;loginuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;TestPass123&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;access_token&#34;</span> <span class=ow>in</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;token_type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;bearer&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_login_wrong_password</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试密码错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;loginuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;WrongPassword&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>401</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_protected_route_without_token</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试未认证访问受保护路由&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;/users/me&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>401</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_protected_route_with_token</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试认证后访问受保护路由&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 登录获取token</span>
</span></span><span class=line><span class=cl>        <span class=n>login_response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/token&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;loginuser&#34;</span><span class=p>,</span> <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;TestPass123&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>token</span> <span class=o>=</span> <span class=n>login_response</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s2>&#34;access_token&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用token访问</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;/users/me&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>headers</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;Authorization&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Bearer </span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;loginuser&#34;</span></span></span></code></pre></div><h3 id=92-依赖注入覆盖>9.2 依赖注入覆盖<a class=anchor href=#92-%e4%be%9d%e8%b5%96%e6%b3%a8%e5%85%a5%e8%a6%86%e7%9b%96>#</a></h3><p>测试时经常需要替换真实依赖，比如使用测试数据库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.testclient</span> <span class=kn>import</span> <span class=n>TestClient</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>sessionmaker</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.pool</span> <span class=kn>import</span> <span class=n>StaticPool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>main</span> <span class=kn>import</span> <span class=n>app</span><span class=p>,</span> <span class=n>get_db</span><span class=p>,</span> <span class=n>Base</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ===== 测试数据库配置 =====</span>
</span></span><span class=line><span class=cl><span class=c1># 使用内存SQLite，每次测试都是干净的</span>
</span></span><span class=line><span class=cl><span class=n>TEST_DATABASE_URL</span> <span class=o>=</span> <span class=s2>&#34;sqlite:///:memory:&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>TEST_DATABASE_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>connect_args</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;check_same_thread&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>poolclass</span><span class=o>=</span><span class=n>StaticPool</span>  <span class=c1># 保持单一连接</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TestingSessionLocal</span> <span class=o>=</span> <span class=n>sessionmaker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>autocommit</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>autoflush</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bind</span><span class=o>=</span><span class=n>engine</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s2>&#34;function&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>db_session</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    数据库会话fixture
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    每个测试函数都会：
</span></span></span><span class=line><span class=cl><span class=s2>    1. 创建全新的表
</span></span></span><span class=line><span class=cl><span class=s2>    2. 获得独立的数据库会话
</span></span></span><span class=line><span class=cl><span class=s2>    3. 测试结束后删除所有表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建表</span>
</span></span><span class=line><span class=cl>    <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>create_all</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>TestingSessionLocal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>session</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1># 清理</span>
</span></span><span class=line><span class=cl>        <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>drop_all</span><span class=p>(</span><span class=n>bind</span><span class=o>=</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.fixture</span><span class=p>(</span><span class=n>scope</span><span class=o>=</span><span class=s2>&#34;function&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>client</span><span class=p>(</span><span class=n>db_session</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    测试客户端fixture
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    覆盖get_db依赖，使用测试数据库
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>override_get_db</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>db_session</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 覆盖依赖</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>dependency_overrides</span><span class=p>[</span><span class=n>get_db</span><span class=p>]</span> <span class=o>=</span> <span class=n>override_get_db</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>TestClient</span><span class=p>(</span><span class=n>app</span><span class=p>)</span> <span class=k>as</span> <span class=n>c</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 清理覆盖</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>dependency_overrides</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_create_and_get_user</span><span class=p>(</span><span class=n>client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    集成测试：创建用户并获取
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用覆盖后的测试数据库
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 创建</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=s2>&#34;/users/&#34;</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;username&#34;</span><span class=p>:</span> <span class=s2>&#34;newuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;new@example.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;password&#34;</span><span class=p>:</span> <span class=s2>&#34;Pass123456&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;/users/</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()[</span><span class=s2>&#34;username&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;newuser&#34;</span></span></span></code></pre></div><hr><h2 id=10-生产部署与性能优化>10. 生产部署与性能优化<a class=anchor href=#10-%e7%94%9f%e4%ba%a7%e9%83%a8%e7%bd%b2%e4%b8%8e%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>#</a></h2><h3 id=101-部署架构>10.1 部署架构<a class=anchor href=#101-%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84>#</a></h3><p>生产环境的典型部署架构：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>                    ┌─────────────────┐
</span></span><span class=line><span class=cl>                    │   Nginx/Caddy   │  反向代理、SSL终止、静态文件
</span></span><span class=line><span class=cl>                    └────────┬────────┘
</span></span><span class=line><span class=cl>                             │
</span></span><span class=line><span class=cl>              ┌──────────────┼──────────────┐
</span></span><span class=line><span class=cl>              │              │              │
</span></span><span class=line><span class=cl>        ┌─────┴─────┐  ┌─────┴─────┐  ┌─────┴─────┐
</span></span><span class=line><span class=cl>        │ Gunicorn  │  │ Gunicorn  │  │ Gunicorn  │  进程管理
</span></span><span class=line><span class=cl>        │  Worker   │  │  Worker   │  │  Worker   │
</span></span><span class=line><span class=cl>        └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
</span></span><span class=line><span class=cl>              │              │              │
</span></span><span class=line><span class=cl>        ┌─────┴─────┐  ┌─────┴─────┐  ┌─────┴─────┐
</span></span><span class=line><span class=cl>        │  Uvicorn  │  │  Uvicorn  │  │  Uvicorn  │  ASGI服务器
</span></span><span class=line><span class=cl>        │ (FastAPI) │  │ (FastAPI) │  │ (FastAPI) │
</span></span><span class=line><span class=cl>        └───────────┘  └───────────┘  └───────────┘</span></span></code></pre></div><p><strong>Uvicorn配置</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># run.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uvicorn</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>main</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;main:app&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>host</span><span class=o>=</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>workers</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>              <span class=c1># 工作进程数</span>
</span></span><span class=line><span class=cl>        <span class=n>loop</span><span class=o>=</span><span class=s2>&#34;uvloop&#34;</span><span class=p>,</span>          <span class=c1># 更快的事件循环</span>
</span></span><span class=line><span class=cl>        <span class=n>http</span><span class=o>=</span><span class=s2>&#34;httptools&#34;</span><span class=p>,</span>       <span class=c1># 更快的HTTP解析器</span>
</span></span><span class=line><span class=cl>        <span class=n>log_level</span><span class=o>=</span><span class=s2>&#34;info&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>access_log</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>reload</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>           <span class=c1># 生产环境禁用</span>
</span></span><span class=line><span class=cl>        <span class=n>proxy_headers</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>     <span class=c1># 信任代理头</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><p><strong>Gunicorn + Uvicorn</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># gunicorn.conf.py</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> <span class=o>=</span> <span class=s2>&#34;0.0.0.0:8000&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>workers</span> <span class=o>=</span> <span class=m>4</span>                    <span class=c1># 通常为 CPU核心数 * 2 + 1</span>
</span></span><span class=line><span class=cl><span class=nv>worker_class</span> <span class=o>=</span> <span class=s2>&#34;uvicorn.workers.UvicornWorker&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>timeout</span> <span class=o>=</span> <span class=m>120</span>                  <span class=c1># 请求超时</span>
</span></span><span class=line><span class=cl><span class=nv>keepalive</span> <span class=o>=</span> <span class=m>5</span>                  <span class=c1># Keep-alive超时</span>
</span></span><span class=line><span class=cl><span class=nv>max_requests</span> <span class=o>=</span> <span class=m>1000</span>            <span class=c1># Worker处理多少请求后重启</span>
</span></span><span class=line><span class=cl><span class=nv>max_requests_jitter</span> <span class=o>=</span> <span class=m>50</span>       <span class=c1># 添加随机性，避免所有worker同时重启</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动命令</span>
</span></span><span class=line><span class=cl><span class=c1># gunicorn main:app -c gunicorn.conf.py</span></span></span></code></pre></div><h3 id=102-docker部署>10.2 Docker部署<a class=anchor href=#102-docker%e9%83%a8%e7%bd%b2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>python:3.11-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 设置工作目录</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 安装系统依赖</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y <span class=se>\
</span></span></span><span class=line><span class=cl>    gcc <span class=se>\
</span></span></span><span class=line><span class=cl>    libpq-dev <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 复制依赖文件</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 安装Python依赖</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 复制应用代码</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 创建非root用户（安全最佳实践）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> useradd -m appuser <span class=o>&amp;&amp;</span> chown -R appuser:appuser /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>USER</span><span class=w> </span><span class=s>appuser</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 暴露端口</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>EXPOSE</span><span class=w> </span><span class=s>8000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 健康检查</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>HEALTHCHECK</span> --interval<span class=o>=</span>30s --timeout<span class=o>=</span>10s --start-period<span class=o>=</span>5s --retries<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    CMD curl -f http://localhost:8000/health <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 启动命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>CMD</span> <span class=o>[</span><span class=s2>&#34;gunicorn&#34;</span>, <span class=s2>&#34;main:app&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl>     <span class=s2>&#34;--workers&#34;</span>, <span class=s2>&#34;4&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl>     <span class=s2>&#34;--worker-class&#34;</span>, <span class=s2>&#34;uvicorn.workers.UvicornWorker&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl>     <span class=s2>&#34;--bind&#34;</span>, <span class=s2>&#34;0.0.0.0:8000&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl>     <span class=s2>&#34;--access-logfile&#34;</span>, <span class=s2>&#34;-&#34;</span>, <span class=se>\
</span></span></span><span class=line><span class=cl>     <span class=s2>&#34;--error-logfile&#34;</span>, <span class=s2>&#34;-&#34;</span><span class=o>]</span></span></span></code></pre></div><h3 id=103-性能优化>10.3 性能优化<a class=anchor href=#103-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.responses</span> <span class=kn>import</span> <span class=n>ORJSONResponse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 使用更快的JSON序列化器</span>
</span></span><span class=line><span class=cl><span class=c1># orjson比标准json快3-10倍</span>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>default_response_class</span><span class=o>=</span><span class=n>ORJSONResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 启用Gzip压缩</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.middleware.gzip</span> <span class=kn>import</span> <span class=n>GZipMiddleware</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>add_middleware</span><span class=p>(</span><span class=n>GZipMiddleware</span><span class=p>,</span> <span class=n>minimum_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 数据库连接池优化</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_async_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>DATABASE_URL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_size</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>           <span class=c1># 根据并发需求调整</span>
</span></span><span class=line><span class=cl>    <span class=n>max_overflow</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>        <span class=c1># 突发流量时额外的连接</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_timeout</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>        <span class=c1># 等待可用连接的超时时间</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_recycle</span><span class=o>=</span><span class=mi>1800</span><span class=p>,</span>      <span class=c1># 连接回收时间（防止数据库断开）</span>
</span></span><span class=line><span class=cl>    <span class=n>pool_pre_ping</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>     <span class=c1># 使用前检查连接有效性</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 响应缓存（使用Redis）</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi_cache</span> <span class=kn>import</span> <span class=n>FastAPICache</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi_cache.backends.redis</span> <span class=kn>import</span> <span class=n>RedisBackend</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi_cache.decorator</span> <span class=kn>import</span> <span class=n>cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.on_event</span><span class=p>(</span><span class=s2>&#34;startup&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>startup</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>redis</span> <span class=o>=</span> <span class=k>await</span> <span class=n>aioredis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=s2>&#34;redis://localhost&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>FastAPICache</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>RedisBackend</span><span class=p>(</span><span class=n>redis</span><span class=p>),</span> <span class=n>prefix</span><span class=o>=</span><span class=s2>&#34;api-cache&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/expensive-data&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nd>@cache</span><span class=p>(</span><span class=n>expire</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>  <span class=c1># 缓存60秒</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_expensive_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 耗时的计算或查询</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 批量操作代替循环</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/users/batch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>create_users_batch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>UserCreate</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=p>:</span> <span class=n>AsyncSession</span> <span class=o>=</span> <span class=n>Depends</span><span class=p>(</span><span class=n>get_db</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 批量插入</span>
</span></span><span class=line><span class=cl>    <span class=n>db_users</span> <span class=o>=</span> <span class=p>[</span><span class=n>User</span><span class=p>(</span><span class=o>**</span><span class=n>u</span><span class=o>.</span><span class=n>model_dump</span><span class=p>())</span> <span class=k>for</span> <span class=n>u</span> <span class=ow>in</span> <span class=n>users</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>add_all</span><span class=p>(</span><span class=n>db_users</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>db</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;created&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>db_users</span><span class=p>)}</span></span></span></code></pre></div><hr><h2 id=总结>总结<a class=anchor href=#%e6%80%bb%e7%bb%93>#</a></h2><h3 id=核心要点回顾>核心要点回顾<a class=anchor href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9%e5%9b%9e%e9%a1%be>#</a></h3><ol><li><p><strong>异步编程</strong>：理解async/await的本质，正确区分I/O密集和CPU密集操作</p></li><li><p><strong>类型系统</strong>：充分利用Python类型注解和Pydantic，让代码更安全、文档更完善</p></li><li><p><strong>依赖注入</strong>：这是FastAPI的核心设计，用于代码复用、测试便利、关注点分离</p></li><li><p><strong>中间件</strong>：处理横切关注点，如日志、CORS、限流</p></li><li><p><strong>安全认证</strong>：实现OAuth2、JWT，保护API安全</p></li><li><p><strong>数据库</strong>：使用异步SQLAlchemy，正确管理连接和事务</p></li><li><p><strong>测试</strong>：编写全面的测试，使用依赖覆盖隔离外部依赖</p></li><li><p><strong>部署</strong>：使用Docker容器化，Gunicorn管理进程，注意性能优化</p></li></ol><h3 id=最佳实践清单>最佳实践清单<a class=anchor href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e6%b8%85%e5%8d%95>#</a></h3><ul><li><input disabled type=checkbox> 使用类型注解和Pydantic模型验证数据</li><li><input disabled type=checkbox> 正确区分async def和def的使用场景</li><li><input disabled type=checkbox> 使用依赖注入管理数据库、认证等</li><li><input disabled type=checkbox> 实现统一的异常处理和响应格式</li><li><input disabled type=checkbox> 编写测试覆盖核心功能</li><li><input disabled type=checkbox> 使用环境变量管理配置，不要硬编码敏感信息</li><li><input disabled type=checkbox> 实现日志和监控</li><li><input disabled type=checkbox> 使用Docker容器化部署</li><li><input disabled type=checkbox> 配置HTTPS和安全响应头</li><li><input disabled type=checkbox> 实现速率限制保护API</li></ul><h3 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h3><ul><li><a href=https://fastapi.tiangolo.com/>FastAPI官方文档</a></li><li><a href=https://docs.pydantic.dev/>Pydantic官方文档</a></li><li><a href=https://docs.sqlalchemy.org/>SQLAlchemy文档</a></li><li><a href=https://sqlmodel.tiangolo.com/>SQLModel文档</a></li><li><a href=https://www.starlette.io/>Starlette文档</a></li></ul></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>完结报告</span>
</a></span><span><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ class="flex align-center"><span>Agent最佳设计模式</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#目录>目录</a></li><li><a href=#1-fastapi概述与核心特性>1. FastAPI概述与核心特性</a><ul><li><a href=#11-什么是fastapi>1.1 什么是FastAPI</a></li><li><a href=#12-安装与环境配置>1.2 安装与环境配置</a></li><li><a href=#13-第一个fastapi应用>1.3 第一个FastAPI应用</a></li><li><a href=#14-请求参数的多种来源>1.4 请求参数的多种来源</a></li></ul></li><li><a href=#2-异步编程原理>2. 异步编程原理</a><ul><li><a href=#21-为什么需要异步>2.1 为什么需要异步？</a></li><li><a href=#22-深入理解-asyncawait>2.2 深入理解 async/await</a></li><li><a href=#23-何时使用-async-def-vs-def>2.3 何时使用 async def vs def</a></li><li><a href=#24-异步上下文管理器与应用生命周期>2.4 异步上下文管理器与应用生命周期</a></li></ul></li><li><a href=#3-pydantic数据验证>3. Pydantic数据验证</a><ul><li><a href=#31-为什么需要数据验证>3.1 为什么需要数据验证？</a></li><li><a href=#32-高级验证技巧>3.2 高级验证技巧</a></li><li><a href=#33-泛型响应模型>3.3 泛型响应模型</a></li><li><a href=#34-配置管理>3.4 配置管理</a></li></ul></li><li><a href=#4-依赖注入系统>4. 依赖注入系统</a><ul><li><a href=#41-什么是依赖注入>4.1 什么是依赖注入？</a></li><li><a href=#42-类作为依赖>4.2 类作为依赖</a></li><li><a href=#43-依赖链构建复杂的依赖关系>4.3 依赖链：构建复杂的依赖关系</a></li><li><a href=#44-路由级别依赖>4.4 路由级别依赖</a></li></ul></li><li><a href=#5-中间件与生命周期>5. 中间件与生命周期</a><ul><li><a href=#51-理解中间件>5.1 理解中间件</a></li><li><a href=#52-高级中间件限流>5.2 高级中间件：限流</a></li><li><a href=#53-中间件-vs-依赖注入如何选择>5.3 中间件 vs 依赖注入：如何选择？</a></li></ul></li><li><a href=#6-认证与安全>6. 认证与安全</a><ul><li><a href=#61-理解oauth2>6.1 理解OAuth2</a></li><li><a href=#62-基于角色的访问控制rbac>6.2 基于角色的访问控制（RBAC）</a></li></ul></li><li><a href=#7-数据库集成>7. 数据库集成</a><ul><li><a href=#71-sqlalchemy异步集成>7.1 SQLAlchemy异步集成</a></li><li><a href=#72-crud操作模式>7.2 CRUD操作模式</a></li></ul></li><li><a href=#8-后台任务与websocket>8. 后台任务与WebSocket</a><ul><li><a href=#81-后台任务>8.1 后台任务</a></li><li><a href=#82-websocket实时通信>8.2 WebSocket实时通信</a></li></ul></li><li><a href=#9-测试策略>9. 测试策略</a><ul><li><a href=#91-测试的重要性>9.1 测试的重要性</a></li><li><a href=#92-依赖注入覆盖>9.2 依赖注入覆盖</a></li></ul></li><li><a href=#10-生产部署与性能优化>10. 生产部署与性能优化</a><ul><li><a href=#101-部署架构>10.1 部署架构</a></li><li><a href=#102-docker部署>10.2 Docker部署</a></li><li><a href=#103-性能优化>10.3 性能优化</a></li></ul></li><li><a href=#总结>总结</a><ul><li><a href=#核心要点回顾>核心要点回顾</a></li><li><a href=#最佳实践清单>最佳实践清单</a></li><li><a href=#参考资源>参考资源</a></li></ul></li></ul></nav></div></aside></main></body></html>