<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="4. Agent最佳设计模式与生产实践# 版本: LangChain 1.0.7+ | LangGraph 1.0.3+ 定位: Agent系统从设计到生产的完整实践指南 更新: 2025-11-20
概述# 本笔记系统总结了大模型Agent开发与部署的核心实践,涵盖架构设计、性能优化、可靠性保障、监控运维等生产环节。所有内容基于真实项目经验,提供可运行的完整代码示例。
与《LangChain笔记》的关系# 建议学习路径:
《LangChain笔记》第一~三篇 (基础) → 本实践笔记 (生产)本笔记深化《LangChain笔记》第七篇(高级应用)和第八篇(生产实践)的内容,补充实战细节。
学习目标# 掌握核心技能:
设计可扩展的Agent架构 优化响应速度和成本 构建可靠的错误处理机制 建立完善的监控体系 达成生产标准:
响应时间 < 1s (P95) 系统可用性 > 99.9% 错误恢复自动化 全链路可观测 目录# 第一部分: 架构设计模式# 1.1 单Agent架构设计 1.2 状态管理最佳实践 1.3 工具系统设计 第二部分: 性能优化实战# 2.1 响应速度优化 2.2 成本优化策略 2.3 并发与异步处理 第三部分: 可靠性保障# 3.1 错误处理与重试 3.2 降级与熔断 3.3 测试策略 第四部分: 监控运维# 4.1 可观测性建设 4.2 关键指标监控 第五部分: 案例研究# 5.1 智能客服Agent优化实战 第一部分:架构设计模式# 1.1 单Agent架构设计# 核心原则# 单Agent架构遵循以下设计原则:
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="Agent最佳设计模式"><meta property="og:description" content="4. Agent最佳设计模式与生产实践# 版本: LangChain 1.0.7+ | LangGraph 1.0.3+ 定位: Agent系统从设计到生产的完整实践指南 更新: 2025-11-20
概述# 本笔记系统总结了大模型Agent开发与部署的核心实践,涵盖架构设计、性能优化、可靠性保障、监控运维等生产环节。所有内容基于真实项目经验,提供可运行的完整代码示例。
与《LangChain笔记》的关系# 建议学习路径:
《LangChain笔记》第一~三篇 (基础) → 本实践笔记 (生产)本笔记深化《LangChain笔记》第七篇(高级应用)和第八篇(生产实践)的内容,补充实战细节。
学习目标# 掌握核心技能:
设计可扩展的Agent架构 优化响应速度和成本 构建可靠的错误处理机制 建立完善的监控体系 达成生产标准:
响应时间 < 1s (P95) 系统可用性 > 99.9% 错误恢复自动化 全链路可观测 目录# 第一部分: 架构设计模式# 1.1 单Agent架构设计 1.2 状态管理最佳实践 1.3 工具系统设计 第二部分: 性能优化实战# 2.1 响应速度优化 2.2 成本优化策略 2.3 并发与异步处理 第三部分: 可靠性保障# 3.1 错误处理与重试 3.2 降级与熔断 3.3 测试策略 第四部分: 监控运维# 4.1 可观测性建设 4.2 关键指标监控 第五部分: 案例研究# 5.1 智能客服Agent优化实战 第一部分:架构设计模式# 1.1 单Agent架构设计# 核心原则# 单Agent架构遵循以下设计原则:"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="Agent最佳设计模式"><meta itemprop=description content="4. Agent最佳设计模式与生产实践# 版本: LangChain 1.0.7+ | LangGraph 1.0.3+ 定位: Agent系统从设计到生产的完整实践指南 更新: 2025-11-20
概述# 本笔记系统总结了大模型Agent开发与部署的核心实践,涵盖架构设计、性能优化、可靠性保障、监控运维等生产环节。所有内容基于真实项目经验,提供可运行的完整代码示例。
与《LangChain笔记》的关系# 建议学习路径:
《LangChain笔记》第一~三篇 (基础) → 本实践笔记 (生产)本笔记深化《LangChain笔记》第七篇(高级应用)和第八篇(生产实践)的内容,补充实战细节。
学习目标# 掌握核心技能:
设计可扩展的Agent架构 优化响应速度和成本 构建可靠的错误处理机制 建立完善的监控体系 达成生产标准:
响应时间 < 1s (P95) 系统可用性 > 99.9% 错误恢复自动化 全链路可观测 目录# 第一部分: 架构设计模式# 1.1 单Agent架构设计 1.2 状态管理最佳实践 1.3 工具系统设计 第二部分: 性能优化实战# 2.1 响应速度优化 2.2 成本优化策略 2.3 并发与异步处理 第三部分: 可靠性保障# 3.1 错误处理与重试 3.2 降级与熔断 3.3 测试策略 第四部分: 监控运维# 4.1 可观测性建设 4.2 关键指标监控 第五部分: 案例研究# 5.1 智能客服Agent优化实战 第一部分:架构设计模式# 1.1 单Agent架构设计# 核心原则# 单Agent架构遵循以下设计原则:"><meta itemprop=wordCount content="2978"><title>Agent最佳设计模式 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle checked>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/ class=active>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>Agent最佳设计模式</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#概述>概述</a><ul><li><a href=#与langchain笔记的关系>与《LangChain笔记》的关系</a></li><li><a href=#学习目标>学习目标</a></li></ul></li><li><a href=#目录>目录</a><ul><li><a href=#第一部分-架构设计模式>第一部分: 架构设计模式</a></li><li><a href=#第二部分-性能优化实战>第二部分: 性能优化实战</a></li><li><a href=#第三部分-可靠性保障>第三部分: 可靠性保障</a></li><li><a href=#第四部分-监控运维>第四部分: 监控运维</a></li><li><a href=#第五部分-案例研究>第五部分: 案例研究</a></li></ul></li></ul><ul><li><a href=#11-单agent架构设计>1.1 单Agent架构设计</a><ul><li><a href=#核心原则>核心原则</a></li><li><a href=#三种核心模式>三种核心模式</a><ul><li><a href=#模式1-react-agent-推荐->模式1: ReAct Agent (推荐 ⭐⭐⭐⭐⭐)</a></li></ul></li></ul></li><li><a href=#12-状态管理最佳实践>1.2 状态管理最佳实践</a><ul><li><a href=#状态设计原则>状态设计原则</a></li><li><a href=#持久化方案对比>持久化方案对比</a></li></ul></li><li><a href=#13-工具系统设计>1.3 工具系统设计</a><ul><li><a href=#工具设计原则>工具设计原则</a></li><li><a href=#工具数量控制>工具数量控制</a></li></ul></li></ul><ul><li><a href=#21-响应速度优化>2.1 响应速度优化</a><ul><li><a href=#性能基准>性能基准</a></li><li><a href=#优化策略1-流式输出-必做->优化策略1: 流式输出 (必做 ⭐⭐⭐⭐⭐)</a></li><li><a href=#优化策略2-并行工具调用-收益->优化策略2: 并行工具调用 (收益 ⭐⭐⭐⭐)</a></li><li><a href=#优化策略3-模型路由-收益->优化策略3: 模型路由 (收益 ⭐⭐⭐⭐)</a></li><li><a href=#优化策略4-智能缓存-收益->优化策略4: 智能缓存 (收益 ⭐⭐⭐)</a><ul><li><a href=#精确缓存>精确缓存</a></li><li><a href=#语义缓存>语义缓存</a></li></ul></li></ul></li><li><a href=#22-成本优化策略>2.2 成本优化策略</a><ul><li><a href=#token使用优化>Token使用优化</a></li></ul></li><li><a href=#23-并发与异步处理>2.3 并发与异步处理</a><ul><li><a href=#异步调用-必做>异步调用 (必做)</a></li><li><a href=#批处理优化>批处理优化</a></li></ul></li></ul><ul><li><a href=#31-错误处理与重试>3.1 错误处理与重试</a><ul><li><a href=#错误分类>错误分类</a></li><li><a href=#重试策略>重试策略</a><ul><li><a href=#策略1-简单重试>策略1: 简单重试</a></li><li><a href=#策略2-指数退避-推荐->策略2: 指数退避 (推荐 ⭐⭐⭐⭐⭐)</a></li><li><a href=#策略3-智能重试-生产推荐->策略3: 智能重试 (生产推荐 ⭐⭐⭐⭐⭐)</a></li><li><a href=#策略4-断路器模式-防雪崩->策略4: 断路器模式 (防雪崩 ⭐⭐⭐⭐)</a></li></ul></li></ul></li><li><a href=#32-降级与熔断>3.2 降级与熔断</a><ul><li><a href=#降级策略>降级策略</a><ul><li><a href=#降级1-工具降级>降级1: 工具降级</a></li><li><a href=#降级2-模型降级>降级2: 模型降级</a></li><li><a href=#降级3-功能降级>降级3: 功能降级</a></li></ul></li></ul></li><li><a href=#33-测试策略>3.3 测试策略</a><ul><li><a href=#单元测试>单元测试</a></li></ul></li></ul><ul><li><a href=#41-可观测性建设>4.1 可观测性建设</a><ul><li><a href=#三大支柱>三大支柱</a></li><li><a href=#结构化日志>结构化日志</a></li><li><a href=#langsmith集成>LangSmith集成</a></li></ul></li><li><a href=#42-关键指标监控>4.2 关键指标监控</a><ul><li><a href=#核心指标>核心指标</a></li></ul></li></ul><ul><li><a href=#51-智能客服agent优化实战>5.1 智能客服Agent优化实战</a><ul><li><a href=#场景描述>场景描述</a></li><li><a href=#优化前状态>优化前状态</a></li><li><a href=#优化策略>优化策略</a><ul><li><a href=#优化1-启用流式输出>优化1: 启用流式输出</a></li><li><a href=#优化2-redis缓存常见问题>优化2: Redis缓存常见问题</a></li><li><a href=#优化3-简单问题路由到gpt-4o-mini>优化3: 简单问题路由到gpt-4o-mini</a></li><li><a href=#优化4-并行调用知识库和订单系统>优化4: 并行调用知识库和订单系统</a></li></ul></li><li><a href=#优化后状态>优化后状态</a></li><li><a href=#投入产出比>投入产出比</a></li></ul></li><li><a href=#最佳实践速查表>最佳实践速查表</a><ul><li><a href=#-必做清单-高优先级>✅ 必做清单 (高优先级)</a></li><li><a href=#-推荐清单-中优先级>⭐ 推荐清单 (中优先级)</a></li><li><a href=#-高级清单-可选>🚀 高级清单 (可选)</a></li></ul></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#路径1-快速提升-1-2周>路径1: 快速提升 (1-2周)</a></li><li><a href=#路径2-系统学习-4-6周>路径2: 系统学习 (4-6周)</a></li><li><a href=#路径3-专项深入-按需>路径3: 专项深入 (按需)</a></li></ul></li><li><a href=#环境准备>环境准备</a><ul><li><a href=#依赖安装>依赖安装</a></li><li><a href=#环境变量>环境变量</a></li></ul></li><li><a href=#参考资源>参考资源</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#相关笔记>相关笔记</a></li><li><a href=#社区资源>社区资源</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=4-agent最佳设计模式与生产实践>4. Agent最佳设计模式与生产实践<a class=anchor href=#4-agent%e6%9c%80%e4%bd%b3%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e4%b8%8e%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5>#</a></h1><blockquote class=book-hint><p><strong>版本</strong>: LangChain 1.0.7+ | LangGraph 1.0.3+
<strong>定位</strong>: Agent系统从设计到生产的完整实践指南
<strong>更新</strong>: 2025-11-20</p></blockquote><hr><h2 id=概述>概述<a class=anchor href=#%e6%a6%82%e8%bf%b0>#</a></h2><p>本笔记系统总结了大模型Agent开发与部署的核心实践,涵盖架构设计、性能优化、可靠性保障、监控运维等生产环节。所有内容基于真实项目经验,提供可运行的完整代码示例。</p><h3 id=与langchain笔记的关系>与《LangChain笔记》的关系<a class=anchor href=#%e4%b8%8elangchain%e7%ac%94%e8%ae%b0%e7%9a%84%e5%85%b3%e7%b3%bb>#</a></h3><p>建议学习路径:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>《LangChain笔记》第一~三篇 (基础) → 本实践笔记 (生产)</span></span></code></pre></div><p>本笔记深化《LangChain笔记》第七篇(高级应用)和第八篇(生产实践)的内容,补充实战细节。</p><h3 id=学习目标>学习目标<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87>#</a></h3><p><strong>掌握核心技能</strong>:</p><ul><li>设计可扩展的Agent架构</li><li>优化响应速度和成本</li><li>构建可靠的错误处理机制</li><li>建立完善的监控体系</li></ul><p><strong>达成生产标准</strong>:</p><ul><li>响应时间 &lt; 1s (P95)</li><li>系统可用性 > 99.9%</li><li>错误恢复自动化</li><li>全链路可观测</li></ul><hr><h2 id=目录>目录<a class=anchor href=#%e7%9b%ae%e5%bd%95>#</a></h2><h3 id=第一部分-架构设计模式><a href=#%e7%ac%ac%e4%b8%80%e9%83%a8%e5%88%86%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f>第一部分: 架构设计模式</a><a class=anchor href=#%e7%ac%ac%e4%b8%80%e9%83%a8%e5%88%86-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f>#</a></h3><ul><li><a href=#11-%e5%8d%95agent%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>1.1 单Agent架构设计</a></li><li><a href=#12-%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>1.2 状态管理最佳实践</a></li><li><a href=#13-%e5%b7%a5%e5%85%b7%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1>1.3 工具系统设计</a></li></ul><h3 id=第二部分-性能优化实战><a href=#%e7%ac%ac%e4%ba%8c%e9%83%a8%e5%88%86%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e5%ae%9e%e6%88%98>第二部分: 性能优化实战</a><a class=anchor href=#%e7%ac%ac%e4%ba%8c%e9%83%a8%e5%88%86-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e5%ae%9e%e6%88%98>#</a></h3><ul><li><a href=#21-%e5%93%8d%e5%ba%94%e9%80%9f%e5%ba%a6%e4%bc%98%e5%8c%96>2.1 响应速度优化</a></li><li><a href=#22-%e6%88%90%e6%9c%ac%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5>2.2 成本优化策略</a></li><li><a href=#23-%e5%b9%b6%e5%8f%91%e4%b8%8e%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86>2.3 并发与异步处理</a></li></ul><h3 id=第三部分-可靠性保障><a href=#%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e5%8f%af%e9%9d%a0%e6%80%a7%e4%bf%9d%e9%9a%9c>第三部分: 可靠性保障</a><a class=anchor href=#%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86-%e5%8f%af%e9%9d%a0%e6%80%a7%e4%bf%9d%e9%9a%9c>#</a></h3><ul><li><a href=#31-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e4%b8%8e%e9%87%8d%e8%af%95>3.1 错误处理与重试</a></li><li><a href=#32-%e9%99%8d%e7%ba%a7%e4%b8%8e%e7%86%94%e6%96%ad>3.2 降级与熔断</a></li><li><a href=#33-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>3.3 测试策略</a></li></ul><h3 id=第四部分-监控运维><a href=#%e7%ac%ac%e5%9b%9b%e9%83%a8%e5%88%86%e7%9b%91%e6%8e%a7%e8%bf%90%e7%bb%b4>第四部分: 监控运维</a><a class=anchor href=#%e7%ac%ac%e5%9b%9b%e9%83%a8%e5%88%86-%e7%9b%91%e6%8e%a7%e8%bf%90%e7%bb%b4>#</a></h3><ul><li><a href=#41-%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7%e5%bb%ba%e8%ae%be>4.1 可观测性建设</a></li><li><a href=#42-%e5%85%b3%e9%94%ae%e6%8c%87%e6%a0%87%e7%9b%91%e6%8e%a7>4.2 关键指标监控</a></li></ul><h3 id=第五部分-案例研究><a href=#%e7%ac%ac%e4%ba%94%e9%83%a8%e5%88%86%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6>第五部分: 案例研究</a><a class=anchor href=#%e7%ac%ac%e4%ba%94%e9%83%a8%e5%88%86-%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6>#</a></h3><ul><li><a href=#51-%e6%99%ba%e8%83%bd%e5%ae%a2%e6%9c%8dagent%e4%bc%98%e5%8c%96%e5%ae%9e%e6%88%98>5.1 智能客服Agent优化实战</a></li></ul><hr><h1 id=第一部分架构设计模式>第一部分:架构设计模式<a class=anchor href=#%e7%ac%ac%e4%b8%80%e9%83%a8%e5%88%86%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f>#</a></h1><h2 id=11-单agent架构设计>1.1 单Agent架构设计<a class=anchor href=#11-%e5%8d%95agent%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h2><h3 id=核心原则>核心原则<a class=anchor href=#%e6%a0%b8%e5%bf%83%e5%8e%9f%e5%88%99>#</a></h3><p>单Agent架构遵循以下设计原则:</p><ol><li><strong>单一职责</strong> - 一个Agent专注解决一类问题</li><li><strong>工具齐全</strong> - 通过工具扩展能力,而非复杂逻辑</li><li><strong>状态清晰</strong> - 最小化状态管理复杂度</li><li><strong>易于测试</strong> - 输入输出明确,可测试性强</li></ol><h3 id=三种核心模式>三种核心模式<a class=anchor href=#%e4%b8%89%e7%a7%8d%e6%a0%b8%e5%bf%83%e6%a8%a1%e5%bc%8f>#</a></h3><h4 id=模式1-react-agent-推荐->模式1: ReAct Agent (推荐 ⭐⭐⭐⭐⭐)<a class=anchor href=#%e6%a8%a1%e5%bc%8f1-react-agent-%e6%8e%a8%e8%8d%90->#</a></h4><p><strong>适用场景</strong>: 90%的Agent应用场景</p><p><strong>架构图</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户输入
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>[Agent State]
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>LLM推理 → 决策 → 工具调用 → 工具执行 → 更新状态
</span></span><span class=line><span class=cl>   ↑                                        ↓
</span></span><span class=line><span class=cl>   └────────────── 循环 (直到任务完成) ──────┘
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>最终响应</span></span></code></pre></div><p><strong>完整实现</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>ReAct Agent 完整实现示例
</span></span></span><span class=line><span class=cl><span class=s2>演示三种状态管理模式: 无状态、内存、持久化
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>__future__</span> <span class=kn>import</span> <span class=n>annotations</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>create_react_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 工具定义</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>search_web</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索网络信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: 搜索关键词
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        搜索结果摘要
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 实际应用中,这里会调用真实的搜索API (如Tavily、SerpAPI)</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>  <span class=c1># 模拟网络延迟</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;搜索结果: 关于&#39;</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#39;的最新信息包括...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>calculate</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算数学表达式
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        expression: 数学表达式,如 &#34;2 + 2&#34; 或 &#34;10 * 5&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        计算结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;计算结果: </span><span class=si>{</span><span class=n>expression</span><span class=si>}</span><span class=s2> = </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;计算错误: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>get_weather</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取指定城市的天气信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        city: 城市名称,如 &#34;北京&#34; 或 &#34;上海&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        天气信息
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 实际应用中,这里会调用天气API</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2>的天气: 晴天, 温度25°C, 湿度60%&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_tools</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取工具列表&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>search_web</span><span class=p>,</span> <span class=n>calculate</span><span class=p>,</span> <span class=n>get_weather</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_model</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>ChatOpenAI</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;获取LLM模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>api_key</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>api_key</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;请设置 OPENAI_API_KEY 环境变量&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ChatOpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>  <span class=c1># 使用mini版本节省成本</span>
</span></span><span class=line><span class=cl>        <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 模式1: 无状态Agent</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StatelessAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;无状态Agent - 每次调用独立
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    优点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 简单、可靠
</span></span></span><span class=line><span class=cl><span class=s2>    - 易于扩展
</span></span></span><span class=line><span class=cl><span class=s2>    - 无状态泄漏风险
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    缺点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 不支持多轮对话
</span></span></span><span class=line><span class=cl><span class=s2>    - 每次都重新初始化
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>get_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>get_tools</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>state_modifier</span><span class=o>=</span><span class=s2>&#34;你是一个智能助手,可以搜索信息、计算和查询天气。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理用户输入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 模式2: 内存状态Agent</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InMemoryAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;内存状态Agent - 支持多轮对话
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    优点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 实现简单
</span></span></span><span class=line><span class=cl><span class=s2>    - 支持多轮对话上下文
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    缺点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 进程重启丢失状态
</span></span></span><span class=line><span class=cl><span class=s2>    - 无法水平扩展
</span></span></span><span class=line><span class=cl><span class=s2>    - 内存占用持续增长
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>get_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>get_tools</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>state_modifier</span><span class=o>=</span><span class=s2>&#34;你是一个智能助手,可以搜索信息、计算和查询天气。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 每个用户的对话历史 (存储在内存中)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversations</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理用户输入 (支持多轮对话)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取该用户的历史消息</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conversations</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用Agent</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>messages</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新历史消息</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversations</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>clear_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;清空用户的对话历史&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conversations</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 模式3: 持久化Agent (生产推荐 ⭐⭐⭐⭐⭐)</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PersistentAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;持久化Agent - 生产级方案
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    优点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 进程重启不丢失状态
</span></span></span><span class=line><span class=cl><span class=s2>    - 支持水平扩展
</span></span></span><span class=line><span class=cl><span class=s2>    - 可查询历史记录
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    缺点:
</span></span></span><span class=line><span class=cl><span class=s2>    - 需要数据库依赖
</span></span></span><span class=line><span class=cl><span class=s2>    - 增加延迟 (通常 &lt; 10ms)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>checkpoint_uri</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>get_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>get_tools</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 持久化存储</span>
</span></span><span class=line><span class=cl>        <span class=n>checkpointer</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>checkpoint_uri</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=kn>from</span> <span class=nn>langgraph.checkpoint.postgres</span> <span class=kn>import</span> <span class=n>PostgresSaver</span>
</span></span><span class=line><span class=cl>                <span class=n>checkpointer</span> <span class=o>=</span> <span class=n>PostgresSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=n>checkpoint_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✓ 使用PostgreSQL持久化: </span><span class=si>{</span><span class=n>checkpoint_uri</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;⚠ PostgreSQL依赖未安装,降级到内存模式&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠ PostgreSQL连接失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>,降级到内存模式&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>checkpointer</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 降级到SQLite(仅用于演示)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=kn>from</span> <span class=nn>langgraph.checkpoint.sqlite</span> <span class=kn>import</span> <span class=n>SqliteSaver</span>
</span></span><span class=line><span class=cl>                <span class=n>checkpointer</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=s2>&#34;:memory:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✓ 使用SQLite内存模式 (仅演示)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;⚠ 无可用checkpointer,使用无状态模式&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>state_modifier</span><span class=o>=</span><span class=s2>&#34;你是一个智能助手,可以搜索信息、计算和查询天气。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>thread_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理用户输入 (自动持久化)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            thread_id: 会话ID,用于区分不同会话
</span></span></span><span class=line><span class=cl><span class=s2>            user_input: 用户输入
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=n>thread_id</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用Agent - 自动加载历史状态</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>            <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 状态自动持久化</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span></span></span></code></pre></div><p><strong>使用示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>demo_stateless</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;演示无状态模式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>StatelessAgent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第一次调用</span>
</span></span><span class=line><span class=cl>    <span class=n>response1</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;北京天气怎么样?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response1</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第二次调用 - 无法记住上一轮对话</span>
</span></span><span class=line><span class=cl>    <span class=n>response2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;那上海呢?&#34;</span><span class=p>)</span>  <span class=c1># Agent无法理解&#34;那上海呢&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>demo_in_memory</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;演示内存状态模式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>InMemoryAgent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=s2>&#34;user_123&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第一轮对话</span>
</span></span><span class=line><span class=cl>    <span class=n>response1</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s2>&#34;北京天气怎么样?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response1</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第二轮对话 - 可以理解上下文</span>
</span></span><span class=line><span class=cl>    <span class=n>response2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s2>&#34;那上海呢?&#34;</span><span class=p>)</span>  <span class=c1># ✓ 能够理解</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>demo_persistent</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;演示持久化模式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 尝试使用PostgreSQL,失败则降级</span>
</span></span><span class=line><span class=cl>    <span class=n>postgres_uri</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;POSTGRES_URI&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>PersistentAgent</span><span class=p>(</span><span class=n>checkpoint_uri</span><span class=o>=</span><span class=n>postgres_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>thread_id</span> <span class=o>=</span> <span class=s2>&#34;conversation_456&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第一轮对话</span>
</span></span><span class=line><span class=cl>    <span class=n>response1</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>thread_id</span><span class=p>,</span> <span class=s2>&#34;搜索LangChain最新版本&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response1</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第二轮对话 (即使进程重启,通过相同thread_id也能恢复)</span>
</span></span><span class=line><span class=cl>    <span class=n>response2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>thread_id</span><span class=p>,</span> <span class=s2>&#34;它有哪些新特性?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;助手: </span><span class=si>{</span><span class=n>response2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>性能对比</strong>:</p><table><thead><tr><th>模式</th><th>首次调用</th><th>后续调用</th><th>状态持久化</th><th>水平扩展</th><th>推荐场景</th></tr></thead><tbody><tr><td>无状态</td><td>~500ms</td><td>~500ms</td><td>❌</td><td>✅</td><td>单次查询</td></tr><tr><td>内存</td><td>~500ms</td><td>~520ms</td><td>❌</td><td>❌</td><td>开发测试</td></tr><tr><td>持久化</td><td>~510ms</td><td>~530ms</td><td>✅</td><td>✅</td><td><strong>生产环境</strong></td></tr></tbody></table><hr><h2 id=12-状态管理最佳实践>1.2 状态管理最佳实践<a class=anchor href=#12-%e7%8a%b6%e6%80%81%e7%ae%a1%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h2><h3 id=状态设计原则>状态设计原则<a class=anchor href=#%e7%8a%b6%e6%80%81%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99>#</a></h3><p><strong>1. 最小化原则</strong> - 只保存必要的状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 不好 - 保存过多冗余信息</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;all_messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=o>...</span><span class=p>],</span>  <span class=c1># 完整历史</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;user_profile&#34;</span><span class=p>:</span> <span class=p>{</span><span class=o>...</span><span class=p>},</span>  <span class=c1># 用户信息</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;search_cache&#34;</span><span class=p>:</span> <span class=p>{</span><span class=o>...</span><span class=p>},</span>  <span class=c1># 搜索缓存</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;debug_info&#34;</span><span class=p>:</span> <span class=p>{</span><span class=o>...</span><span class=p>}</span>     <span class=c1># 调试信息</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 好 - 只保存核心状态</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:],</span>  <span class=c1># 只保留最近10轮</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>2. 状态隔离</strong> - 不同用户/会话的状态完全隔离</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 使用thread_id隔离</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;user_</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}}</span></span></span></code></pre></div><p><strong>3. 状态清理</strong> - 定期清理过期状态</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>cleanup_old_sessions</span><span class=p>(</span><span class=n>checkpointer</span><span class=p>,</span> <span class=n>days</span><span class=o>=</span><span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;清理30天前的会话&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cutoff</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=n>days</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 实现清理逻辑</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><h3 id=持久化方案对比>持久化方案对比<a class=anchor href=#%e6%8c%81%e4%b9%85%e5%8c%96%e6%96%b9%e6%a1%88%e5%af%b9%e6%af%94>#</a></h3><table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SQLite</strong></td><td>简单,无额外依赖</td><td>不支持并发写</td><td>单机开发</td></tr><tr><td><strong>PostgreSQL</strong></td><td>成熟,支持高并发</td><td>需要运维</td><td><strong>生产推荐</strong></td></tr><tr><td><strong>Redis</strong></td><td>快速,支持TTL</td><td>内存开销大</td><td>短期会话</td></tr></tbody></table><p><strong>PostgreSQL持久化完整示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.postgres</span> <span class=kn>import</span> <span class=n>PostgresSaver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>PostgresSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;postgresql://user:password@localhost:5432/langchain&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user_123&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=n>input_data</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询历史</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=k>await</span> <span class=n>checkpointer</span><span class=o>.</span><span class=n>aget</span><span class=p>(</span><span class=n>config</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=13-工具系统设计>1.3 工具系统设计<a class=anchor href=#13-%e5%b7%a5%e5%85%b7%e7%b3%bb%e7%bb%9f%e8%ae%be%e8%ae%a1>#</a></h2><h3 id=工具设计原则>工具设计原则<a class=anchor href=#%e5%b7%a5%e5%85%b7%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99>#</a></h3><p><strong>1. 单一职责</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 不好 - 一个工具做太多事</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>universal_tool</span><span class=p>(</span><span class=n>action</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;search&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>search</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;calculate&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>calculate</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 好 - 每个工具职责明确</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索网络信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算数学表达式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><p><strong>2. 清晰的文档字符串</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>query_database</span><span class=p>(</span><span class=n>sql</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;查询数据库
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        sql: SQL查询语句 (只支持SELECT)
</span></span></span><span class=line><span class=cl><span class=s2>        limit: 返回结果数量限制,默认100条
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        JSON格式的查询结果
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    示例:
</span></span></span><span class=line><span class=cl><span class=s2>        query_database(&#34;SELECT * FROM users WHERE age &gt; 18&#34;, limit=10)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><p><strong>3. 错误处理</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>api_call</span><span class=p>(</span><span class=n>endpoint</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;调用外部API&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>10.0</span><span class=p>)</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>endpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>httpx</span><span class=o>.</span><span class=n>TimeoutException</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;错误: API调用超时&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>httpx</span><span class=o>.</span><span class=n>HTTPError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;错误: API调用失败 - </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><h3 id=工具数量控制>工具数量控制<a class=anchor href=#%e5%b7%a5%e5%85%b7%e6%95%b0%e9%87%8f%e6%8e%a7%e5%88%b6>#</a></h3><p><strong>推荐方案</strong>: 根据场景动态加载工具</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_tools_by_context</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;根据用户输入选择相关工具&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 关键词检测</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>user_input</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;天气&#34;</span><span class=p>,</span> <span class=s2>&#34;温度&#34;</span><span class=p>,</span> <span class=s2>&#34;下雨&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>get_weather</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>user_input</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;计算&#34;</span><span class=p>,</span> <span class=s2>&#34;加&#34;</span><span class=p>,</span> <span class=s2>&#34;减&#34;</span><span class=p>,</span> <span class=s2>&#34;乘&#34;</span><span class=p>,</span> <span class=s2>&#34;除&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>calculate</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>user_input</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;搜索&#34;</span><span class=p>,</span> <span class=s2>&#34;查找&#34;</span><span class=p>,</span> <span class=s2>&#34;了解&#34;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>search_web</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 默认提供基础工具</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>search_web</span><span class=p>,</span> <span class=n>calculate</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 动态创建Agent</span>
</span></span><span class=line><span class=cl><span class=n>relevant_tools</span> <span class=o>=</span> <span class=n>select_tools_by_context</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=n>relevant_tools</span><span class=p>)</span></span></span></code></pre></div><p><strong>工具数量建议</strong>:</p><ul><li>✅ 推荐: 3-7个工具 (最优)</li><li>⚠️ 可接受: 8-15个工具</li><li>❌ 避免: >20个工具 (LLM容易选错)</li></ul><hr><h1 id=第二部分性能优化实战>第二部分:性能优化实战<a class=anchor href=#%e7%ac%ac%e4%ba%8c%e9%83%a8%e5%88%86%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e5%ae%9e%e6%88%98>#</a></h1><h2 id=21-响应速度优化>2.1 响应速度优化<a class=anchor href=#21-%e5%93%8d%e5%ba%94%e9%80%9f%e5%ba%a6%e4%bc%98%e5%8c%96>#</a></h2><h3 id=性能基准>性能基准<a class=anchor href=#%e6%80%a7%e8%83%bd%e5%9f%ba%e5%87%86>#</a></h3><p><strong>响应时间分级</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>响应时间      用户感知        评级
</span></span><span class=line><span class=cl>&lt; 100ms      即时响应        ⭐⭐⭐⭐⭐ 卓越
</span></span><span class=line><span class=cl>&lt; 500ms      流畅体验        ⭐⭐⭐⭐   优秀
</span></span><span class=line><span class=cl>&lt; 1s         可接受          ⭐⭐⭐     良好
</span></span><span class=line><span class=cl>1-3s         开始感觉慢      ⭐⭐       需优化
</span></span><span class=line><span class=cl>3-5s         明显延迟        ⭐         差
</span></span><span class=line><span class=cl>&gt; 5s         用户流失风险    ❌         紧急</span></span></code></pre></div><p><strong>Agent响应时间组成</strong> (以GPT-4o为例):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>总响应时间 = LLM首Token (40%) + LLM生成 (15%) + 工具执行 (35%) + 网络+系统 (10%)</span></span></code></pre></div><h3 id=优化策略1-流式输出-必做->优化策略1: 流式输出 (必做 ⭐⭐⭐⭐⭐)<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a51-%e6%b5%81%e5%bc%8f%e8%be%93%e5%87%ba-%e5%bf%85%e5%81%9a->#</a></h3><p><strong>收益</strong>: 首字延迟从5s降至0.2s,降低96%</p><p><strong>完整实现</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>流式输出完整示例
</span></span></span><span class=line><span class=cl><span class=s2>对比流式 vs 非流式的性能差异
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>create_react_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 模拟搜索延迟</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;搜索结果: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 非流式调用 - 用户等待所有内容生成完成</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>non_streaming_example</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;非流式调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;【非流式调用】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总耗时: </span><span class=si>{</span><span class=n>total_time</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;最终响应: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># 流式调用 - 用户立即开始看到内容</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>streaming_example</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;流式调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;【流式调用】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>first_chunk_time</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>agent</span><span class=o>.</span><span class=n>astream_events</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>version</span><span class=o>=</span><span class=s2>&#34;v2&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>kind</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;event&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 流式返回LLM生成的内容</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>kind</span> <span class=o>==</span> <span class=s2>&#34;on_chat_model_stream&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;chunk&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>first_chunk_time</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>first_chunk_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;首字延迟: </span><span class=si>{</span><span class=n>first_chunk_time</span> <span class=o>-</span> <span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 显示工具调用</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>kind</span> <span class=o>==</span> <span class=s2>&#34;on_tool_start&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[🔧 调用工具: </span><span class=si>{</span><span class=n>event</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>]&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>kind</span> <span class=o>==</span> <span class=s2>&#34;on_tool_end&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[✓ 工具完成]&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>总耗时: </span><span class=si>{</span><span class=n>total_time</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl><span class=c1># FastAPI集成示例</span>
</span></span><span class=line><span class=cl><span class=c1># ============================================================================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi.responses</span> <span class=kn>import</span> <span class=n>StreamingResponse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/chat/stream&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>chat_stream</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;流式聊天端点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>generate</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>agent</span><span class=o>.</span><span class=n>astream_events</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>            <span class=n>version</span><span class=o>=</span><span class=s2>&#34;v2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;event&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;on_chat_model_stream&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;chunk&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>yield</span> <span class=sa>f</span><span class=s2>&#34;data: </span><span class=si>{</span><span class=n>content</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>StreamingResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>generate</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>media_type</span><span class=o>=</span><span class=s2>&#34;text/event-stream&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><p><strong>性能对比</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;搜索2024年GDP数据并分析&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 非流式: 用户等待5秒后一次性看到结果</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>non_streaming_example</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: 总耗时: 5.23s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 流式: 用户200ms后就开始看到内容</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>streaming_example</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: 首字延迟: 0.21s, 总耗时: 5.18s</span></span></span></code></pre></div><hr><h3 id=优化策略2-并行工具调用-收益->优化策略2: 并行工具调用 (收益 ⭐⭐⭐⭐)<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a52-%e5%b9%b6%e8%a1%8c%e5%b7%a5%e5%85%b7%e8%b0%83%e7%94%a8-%e6%94%b6%e7%9b%8a->#</a></h3><p><strong>收益</strong>: 等待时间降低50-70%</p><p><strong>原理</strong>: 现代LLM (GPT-4o, Claude 3.5) 会自动识别可并行的工具调用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>search_web</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索网络 (耗时: 1s)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;搜索结果: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>query_database</span><span class=p>(</span><span class=n>sql</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;查询数据库 (耗时: 1s)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;查询结果: </span><span class=si>{</span><span class=n>sql</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>call_api</span><span class=p>(</span><span class=n>endpoint</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;调用API (耗时: 1s)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;API响应: </span><span class=si>{</span><span class=n>endpoint</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Agent会自动并行调用</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_web</span><span class=p>,</span> <span class=n>query_database</span><span class=p>,</span> <span class=n>call_api</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 单个请求触发3个工具调用</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;搜索天气,查询用户数,调用支付API&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ❌ 串行执行: 3s (1s + 1s + 1s)</span>
</span></span><span class=line><span class=cl><span class=c1># ✅ 并行执行: ~1s (max(1s, 1s, 1s))</span></span></span></code></pre></div><p><strong>控制并发数</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 限制最大并发数 (避免过载)</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>RunnableConfig</span><span class=p>(</span><span class=n>max_concurrency</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=n>input_data</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=优化策略3-模型路由-收益->优化策略3: 模型路由 (收益 ⭐⭐⭐⭐)<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a53-%e6%a8%a1%e5%9e%8b%e8%b7%af%e7%94%b1-%e6%94%b6%e7%9b%8a->#</a></h3><p><strong>收益</strong>: 成本降低50-70%,速度提升40-60%</p><p><strong>原理</strong>: 简单任务用快速模型,复杂任务用强大模型</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_anthropic</span> <span class=kn>import</span> <span class=n>ChatAnthropic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 模型性能对比 (实测数据)</span>
</span></span><span class=line><span class=cl><span class=n>MODELS</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;fast&#34;</span><span class=p>:</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>      <span class=c1># ~200ms, $0.15/1M tokens</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;balanced&#34;</span><span class=p>:</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>       <span class=c1># ~500ms, $2.5/1M tokens</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;powerful&#34;</span><span class=p>:</span> <span class=n>ChatAnthropic</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-sonnet-4&#34;</span><span class=p>),</span>  <span class=c1># ~800ms, $3/1M tokens</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>select_model</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ChatOpenAI</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;根据查询复杂度选择模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 简单规则</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>50</span> <span class=ow>and</span> <span class=s2>&#34;?&#34;</span> <span class=ow>in</span> <span class=n>user_input</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>MODELS</span><span class=p>[</span><span class=s2>&#34;fast&#34;</span><span class=p>]</span>  <span class=c1># 简单问答</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 关键词检测</span>
</span></span><span class=line><span class=cl>    <span class=n>complex_keywords</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;分析&#34;</span><span class=p>,</span> <span class=s2>&#34;总结&#34;</span><span class=p>,</span> <span class=s2>&#34;评估&#34;</span><span class=p>,</span> <span class=s2>&#34;对比&#34;</span><span class=p>,</span> <span class=s2>&#34;推理&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>user_input</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>complex_keywords</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>MODELS</span><span class=p>[</span><span class=s2>&#34;powerful&#34;</span><span class=p>]</span>  <span class=c1># 复杂分析</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>MODELS</span><span class=p>[</span><span class=s2>&#34;balanced&#34;</span><span class=p>]</span>  <span class=c1># 默认</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用动态模型</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>smart_agent</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>select_model</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span></span></span></code></pre></div><p><strong>基于LLM的路由</strong> (高级):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RouteDecision</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;路由决策&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=nb>str</span>  <span class=c1># &#34;fast&#34; | &#34;balanced&#34; | &#34;powerful&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用快速模型做路由决策</span>
</span></span><span class=line><span class=cl><span class=n>router_model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>router</span> <span class=o>=</span> <span class=n>router_model</span><span class=o>.</span><span class=n>with_structured_output</span><span class=p>(</span><span class=n>RouteDecision</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>llm_based_routing</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 用快速模型分析任务复杂度</span>
</span></span><span class=line><span class=cl>    <span class=n>decision</span> <span class=o>=</span> <span class=k>await</span> <span class=n>router</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;分析以下任务的复杂度,选择合适的模型:</span><span class=se>\n</span><span class=si>{</span><span class=n>user_input</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 用选定的模型执行任务</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>MODELS</span><span class=p>[</span><span class=n>decision</span><span class=o>.</span><span class=n>model</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span></span></span></code></pre></div><hr><h3 id=优化策略4-智能缓存-收益->优化策略4: 智能缓存 (收益 ⭐⭐⭐)<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a54-%e6%99%ba%e8%83%bd%e7%bc%93%e5%ad%98-%e6%94%b6%e7%9b%8a->#</a></h3><p><strong>收益</strong>: 相同查询响应时间 &lt; 10ms</p><h4 id=精确缓存>精确缓存<a class=anchor href=#%e7%b2%be%e7%a1%ae%e7%bc%93%e5%ad%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.cache</span> <span class=kn>import</span> <span class=n>RedisCache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis缓存</span>
</span></span><span class=line><span class=cl><span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>host</span><span class=o>=</span><span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cache</span> <span class=o>=</span> <span class=n>RedisCache</span><span class=p>(</span><span class=n>redis_client</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 首次查询: 500ms</span>
</span></span><span class=line><span class=cl><span class=n>result1</span> <span class=o>=</span> <span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;什么是LangChain?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二次相同查询: &lt;10ms (缓存命中)</span>
</span></span><span class=line><span class=cl><span class=n>result2</span> <span class=o>=</span> <span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;什么是LangChain?&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=语义缓存>语义缓存<a class=anchor href=#%e8%af%ad%e4%b9%89%e7%bc%93%e5%ad%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.cache</span> <span class=kn>import</span> <span class=n>RedisSemanticCache</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 语义缓存 - 相似问题也命中</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>semantic_cache</span> <span class=o>=</span> <span class=n>RedisSemanticCache</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>redis_url</span><span class=o>=</span><span class=s2>&#34;redis://localhost:6379&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_threshold</span><span class=o>=</span><span class=mf>0.9</span>  <span class=c1># 相似度阈值</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=n>semantic_cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 首次查询</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;什么是LangChain?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 语义相似的查询也命中缓存</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;LangChain是什么?&#34;</span><span class=p>)</span>      <span class=c1># ✓ 缓存命中</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;介绍一下LangChain&#34;</span><span class=p>)</span>     <span class=c1># ✓ 缓存命中</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=s2>&#34;LangChain的作用&#34;</span><span class=p>)</span>       <span class=c1># ✓ 缓存命中</span></span></span></code></pre></div><hr><h2 id=22-成本优化策略>2.2 成本优化策略<a class=anchor href=#22-%e6%88%90%e6%9c%ac%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5>#</a></h2><h3 id=token使用优化>Token使用优化<a class=anchor href=#token%e4%bd%bf%e7%94%a8%e4%bc%98%e5%8c%96>#</a></h3><p><strong>策略1: Prompt压缩</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 不好 - Prompt冗长</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>你是一个专业的AI助手。
</span></span></span><span class=line><span class=cl><span class=s2>你需要帮助用户解决各种问题。
</span></span></span><span class=line><span class=cl><span class=s2>你应该提供准确、详细的回答。
</span></span></span><span class=line><span class=cl><span class=s2>你需要保持礼貌和专业。
</span></span></span><span class=line><span class=cl><span class=s2>...  (更多冗余描述)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>用户问题: </span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 好 - Prompt简洁</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;专业AI助手,提供准确回答。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题: </span><span class=si>{question}</span><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><p><strong>策略2: 上下文窗口控制</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 只保留最近N轮对话</span>
</span></span><span class=line><span class=cl><span class=n>MAX_HISTORY</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>messages</span> <span class=o>=</span> <span class=n>conversation_history</span><span class=p>[</span><span class=o>-</span><span class=n>MAX_HISTORY</span><span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>messages</span><span class=p>})</span></span></span></code></pre></div><p><strong>策略3: 使用便宜的Embedding模型</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 对比</span>
</span></span><span class=line><span class=cl><span class=n>expensive_embed</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>)</span>  <span class=c1># $0.13/1M tokens</span>
</span></span><span class=line><span class=cl><span class=n>cheap_embed</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-small&#34;</span><span class=p>)</span>      <span class=c1># $0.02/1M tokens</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对于大多数场景,small模型足够</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=p>(</span><span class=n>embedding_function</span><span class=o>=</span><span class=n>cheap_embed</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=23-并发与异步处理>2.3 并发与异步处理<a class=anchor href=#23-%e5%b9%b6%e5%8f%91%e4%b8%8e%e5%bc%82%e6%ad%a5%e5%a4%84%e7%90%86>#</a></h2><h3 id=异步调用-必做>异步调用 (必做)<a class=anchor href=#%e5%bc%82%e6%ad%a5%e8%b0%83%e7%94%a8-%e5%bf%85%e5%81%9a>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 不好 - 同步调用</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_requests</span><span class=p>(</span><span class=n>queries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>  <span class=c1># 串行处理,100个查询需要100s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 好 - 异步批处理</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>process_requests_async</span><span class=p>(</span><span class=n>queries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>queries</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>  <span class=c1># 并发处理,100个查询约10s (取决于max_concurrency)</span></span></span></code></pre></div><h3 id=批处理优化>批处理优化<a class=anchor href=#%e6%89%b9%e5%a4%84%e7%90%86%e4%bc%98%e5%8c%96>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量处理</span>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=p>[{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;问题</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)]}</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 控制并发</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>RunnableConfig</span><span class=p>(</span><span class=n>max_concurrency</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>abatch</span><span class=p>(</span><span class=n>inputs</span><span class=p>,</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 性能对比:</span>
</span></span><span class=line><span class=cl><span class=c1># 串行: 100次 × 1s = 100s</span>
</span></span><span class=line><span class=cl><span class=c1># 并发(10): 100次 ÷ 10 = 10s</span></span></span></code></pre></div><hr><h1 id=第三部分可靠性保障>第三部分:可靠性保障<a class=anchor href=#%e7%ac%ac%e4%b8%89%e9%83%a8%e5%88%86%e5%8f%af%e9%9d%a0%e6%80%a7%e4%bf%9d%e9%9a%9c>#</a></h1><h2 id=31-错误处理与重试>3.1 错误处理与重试<a class=anchor href=#31-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e4%b8%8e%e9%87%8d%e8%af%95>#</a></h2><h3 id=错误分类>错误分类<a class=anchor href=#%e9%94%99%e8%af%af%e5%88%86%e7%b1%bb>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 可恢复错误 - 重试有意义</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecoverableError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;可恢复错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 网络超时</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>NetworkTimeoutError</span><span class=p>(</span><span class=n>RecoverableError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 速率限制</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitError</span><span class=p>(</span><span class=n>RecoverableError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 不可恢复错误 - 立即失败</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>UnrecoverableError</span><span class=p>(</span><span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;不可恢复错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 认证失败</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AuthError</span><span class=p>(</span><span class=n>UnrecoverableError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配额耗尽</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>QuotaExceededError</span><span class=p>(</span><span class=n>UnrecoverableError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><h3 id=重试策略>重试策略<a class=anchor href=#%e9%87%8d%e8%af%95%e7%ad%96%e7%95%a5>#</a></h3><h4 id=策略1-简单重试>策略1: 简单重试<a class=anchor href=#%e7%ad%96%e7%95%a51-%e7%ae%80%e5%8d%95%e9%87%8d%e8%af%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tenacity</span> <span class=kn>import</span> <span class=n>retry</span><span class=p>,</span> <span class=n>stop_after_attempt</span><span class=p>,</span> <span class=n>wait_fixed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@retry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span>  <span class=c1># 最多3次</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=o>=</span><span class=n>wait_fixed</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>            <span class=c1># 每次等待2秒</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>simple_retry_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;简单重试策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span></span></span></code></pre></div><h4 id=策略2-指数退避-推荐->策略2: 指数退避 (推荐 ⭐⭐⭐⭐⭐)<a class=anchor href=#%e7%ad%96%e7%95%a52-%e6%8c%87%e6%95%b0%e9%80%80%e9%81%bf-%e6%8e%a8%e8%8d%90->#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tenacity</span> <span class=kn>import</span> <span class=n>retry</span><span class=p>,</span> <span class=n>stop_after_attempt</span><span class=p>,</span> <span class=n>wait_exponential</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@retry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=o>=</span><span class=n>wait_exponential</span><span class=p>(</span><span class=n>multiplier</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>min</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 重试间隔: 2s, 4s, 8s, 16s, 32s</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>exponential_backoff_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;指数退避重试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span></span></span></code></pre></div><h4 id=策略3-智能重试-生产推荐->策略3: 智能重试 (生产推荐 ⭐⭐⭐⭐⭐)<a class=anchor href=#%e7%ad%96%e7%95%a53-%e6%99%ba%e8%83%bd%e9%87%8d%e8%af%95-%e7%94%9f%e4%ba%a7%e6%8e%a8%e8%8d%90->#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tenacity</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retry</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>stop_after_attempt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>wait_exponential</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_if_exception_type</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>httpx</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>RateLimitError</span><span class=p>,</span> <span class=n>APITimeoutError</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@retry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1># 只对特定错误重试</span>
</span></span><span class=line><span class=cl>    <span class=n>retry</span><span class=o>=</span><span class=n>retry_if_exception_type</span><span class=p>((</span><span class=n>APITimeoutError</span><span class=p>,</span> <span class=n>httpx</span><span class=o>.</span><span class=n>TimeoutException</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>    <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>wait</span><span class=o>=</span><span class=n>wait_exponential</span><span class=p>(</span><span class=n>multiplier</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>min</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>smart_retry_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;智能重试 - 只重试可恢复错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>RateLimitError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 速率限制 - 等待更长时间</span>
</span></span><span class=line><span class=cl>        <span class=n>wait_time</span> <span class=o>=</span> <span class=n>parse_retry_after_header</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>wait_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>  <span class=c1># 继续重试</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 输入错误 - 不重试</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;输入验证失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=kn>from</span> <span class=bp>None</span></span></span></code></pre></div><h4 id=策略4-断路器模式-防雪崩->策略4: 断路器模式 (防雪崩 ⭐⭐⭐⭐)<a class=anchor href=#%e7%ad%96%e7%95%a54-%e6%96%ad%e8%b7%af%e5%99%a8%e6%a8%a1%e5%bc%8f-%e9%98%b2%e9%9b%aa%e5%b4%a9->#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>CLOSED</span> <span class=o>=</span> <span class=s2>&#34;closed&#34;</span>      <span class=c1># 正常</span>
</span></span><span class=line><span class=cl>    <span class=n>OPEN</span> <span class=o>=</span> <span class=s2>&#34;open&#34;</span>          <span class=c1># 断路</span>
</span></span><span class=line><span class=cl>    <span class=n>HALF_OPEN</span> <span class=o>=</span> <span class=s2>&#34;half_open&#34;</span>  <span class=c1># 半开(测试)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitBreaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;断路器 - 防止持续调用失败服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>failure_threshold</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>expected_exception</span><span class=p>:</span> <span class=nb>type</span> <span class=o>=</span> <span class=ne>Exception</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span> <span class=o>=</span> <span class=n>failure_threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>expected_exception</span> <span class=o>=</span> <span class=n>expected_exception</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>CLOSED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行调用,带断路器保护&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>OPEN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检查是否可以尝试恢复</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>HALF_OPEN</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[断路器] 进入半开状态,尝试恢复&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;断路器开启,服务不可用&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 成功 - 重置计数</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>HALF_OPEN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>CLOSED</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[断路器] 恢复正常&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=bp>self</span><span class=o>.</span><span class=n>expected_exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>OPEN</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[断路器] 触发断路 (失败</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span><span class=si>}</span><span class=s2>次)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>breaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>(</span><span class=n>failure_threshold</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>30</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>protected_agent_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>breaker</span><span class=o>.</span><span class=n>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><hr><h2 id=32-降级与熔断>3.2 降级与熔断<a class=anchor href=#32-%e9%99%8d%e7%ba%a7%e4%b8%8e%e7%86%94%e6%96%ad>#</a></h2><h3 id=降级策略>降级策略<a class=anchor href=#%e9%99%8d%e7%ba%a7%e7%ad%96%e7%95%a5>#</a></h3><h4 id=降级1-工具降级>降级1: 工具降级<a class=anchor href=#%e9%99%8d%e7%ba%a71-%e5%b7%a5%e5%85%b7%e9%99%8d%e7%ba%a7>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>search_with_fallback</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索(带降级)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 主工具: 高质量API</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>premium_search_api</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[降级] 主搜索失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 降级1: 免费API</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>free_search_api</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[降级] 备用搜索失败: </span><span class=si>{</span><span class=n>e2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 降级2: 返回缓存</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>get_cached_result</span><span class=p>(</span><span class=n>query</span><span class=p>)</span></span></span></code></pre></div><h4 id=降级2-模型降级>降级2: 模型降级<a class=anchor href=#%e9%99%8d%e7%ba%a72-%e6%a8%a1%e5%9e%8b%e9%99%8d%e7%ba%a7>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelFallback</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模型降级&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>models</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>              <span class=c1># 主模型</span>
</span></span><span class=line><span class=cl>            <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>         <span class=c1># 降级1</span>
</span></span><span class=line><span class=cl>            <span class=n>ChatAnthropic</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-sonnet-4&#34;</span><span class=p>),</span>  <span class=c1># 降级2</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>invoke_with_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>messages</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带降级的模型调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>model</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[降级] 模型</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>models</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span>  <span class=c1># 所有模型都失败</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;所有模型均不可用&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=降级3-功能降级>降级3: 功能降级<a class=anchor href=#%e9%99%8d%e7%ba%a73-%e5%8a%9f%e8%83%bd%e9%99%8d%e7%ba%a7>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>agent_with_degradation</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带功能降级的Agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 完整功能: 多工具ReAct Agent</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=n>all_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[降级] 完整Agent失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 降级1: 只用核心工具</span>
</span></span><span class=line><span class=cl>            <span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=n>core_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[降级] 简化Agent失败: </span><span class=si>{</span><span class=n>e2</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 降级2: 纯LLM,无工具</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>model</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>(</span><span class=n>user_input</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=33-测试策略>3.3 测试策略<a class=anchor href=#33-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>#</a></h2><h3 id=单元测试>单元测试<a class=anchor href=#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>AsyncMock</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.mark.asyncio</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>test_agent_with_search</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试Agent能正确调用搜索工具&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Mock工具</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_search</span> <span class=o>=</span> <span class=n>AsyncMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=s2>&#34;Mock搜索结果&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建Agent</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>mock_search</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 执行</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;搜索Python教程&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 验证</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>mock_search</span><span class=o>.</span><span class=n>called</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=s2>&#34;Mock搜索结果&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.mark.asyncio</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>test_retry_on_timeout</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试超时重试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_agent</span> <span class=o>=</span> <span class=n>AsyncMock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>mock_agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>(),</span>  <span class=c1># 第1次失败</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>(),</span>  <span class=c1># 第2次失败</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>}</span>    <span class=c1># 第3次成功</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@retry</span><span class=p>(</span><span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_with_retry</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>mock_agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_with_retry</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>result</span> <span class=o>==</span> <span class=p>{</span><span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>mock_agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=o>.</span><span class=n>call_count</span> <span class=o>==</span> <span class=mi>3</span></span></span></code></pre></div><hr><h1 id=第四部分监控运维>第四部分:监控运维<a class=anchor href=#%e7%ac%ac%e5%9b%9b%e9%83%a8%e5%88%86%e7%9b%91%e6%8e%a7%e8%bf%90%e7%bb%b4>#</a></h1><h2 id=41-可观测性建设>4.1 可观测性建设<a class=anchor href=#41-%e5%8f%af%e8%a7%82%e6%b5%8b%e6%80%a7%e5%bb%ba%e8%ae%be>#</a></h2><h3 id=三大支柱>三大支柱<a class=anchor href=#%e4%b8%89%e5%a4%a7%e6%94%af%e6%9f%b1>#</a></h3><ol><li><strong>Metrics (指标)</strong> - 定量监控</li><li><strong>Logs (日志)</strong> - 事件记录</li><li><strong>Traces (追踪)</strong> - 链路还原</li></ol><h3 id=结构化日志>结构化日志<a class=anchor href=#%e7%bb%93%e6%9e%84%e5%8c%96%e6%97%a5%e5%bf%97>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>StructuredLogger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;结构化日志&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&#34;agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_request</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>log_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;event&#34;</span><span class=p>:</span> <span class=s2>&#34;agent_request&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=n>user_input</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=n>response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;latency_ms&#34;</span><span class=p>:</span> <span class=n>latency</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=n>success</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>log_entry</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>StructuredLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>query</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>    <span class=n>latency</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>log_request</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>user_input</span><span class=o>=</span><span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>=</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span><span class=o>=</span><span class=n>latency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=s2>&#34;tools_used&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;search&#34;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>latency</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>log_request</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>user_input</span><span class=o>=</span><span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span><span class=o>=</span><span class=n>latency</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;error_type&#34;</span><span class=p>:</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><h3 id=langsmith集成>LangSmith集成<a class=anchor href=#langsmith%e9%9b%86%e6%88%90>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>traceable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;agent_call&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>traced_agent_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自动追踪到LangSmith&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># LangSmith会自动记录:</span>
</span></span><span class=line><span class=cl><span class=c1># - 总延迟</span>
</span></span><span class=line><span class=cl><span class=c1># - LLM调用次数和时间</span>
</span></span><span class=line><span class=cl><span class=c1># - 工具调用次数和时间</span>
</span></span><span class=line><span class=cl><span class=c1># - Token消耗</span>
</span></span><span class=line><span class=cl><span class=c1># - 完整的调用链路</span></span></span></code></pre></div><hr><h2 id=42-关键指标监控>4.2 关键指标监控<a class=anchor href=#42-%e5%85%b3%e9%94%ae%e6%8c%87%e6%a0%87%e7%9b%91%e6%8e%a7>#</a></h2><h3 id=核心指标>核心指标<a class=anchor href=#%e6%a0%b8%e5%bf%83%e6%8c%87%e6%a0%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 请求计数</span>
</span></span><span class=line><span class=cl><span class=n>request_count</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;agent_requests_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total agent requests&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;status&#39;</span><span class=p>,</span> <span class=s1>&#39;model&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 延迟分布</span>
</span></span><span class=line><span class=cl><span class=n>request_latency</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;agent_request_latency_seconds&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Agent request latency&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Token消耗</span>
</span></span><span class=line><span class=cl><span class=n>token_usage</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;agent_tokens_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total tokens used&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>]</span>  <span class=c1># type: prompt/completion</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当前并发</span>
</span></span><span class=line><span class=cl><span class=n>concurrent_requests</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;agent_concurrent_requests&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Current concurrent requests&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=nd>@request_latency.labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>monitored_agent_call</span><span class=p>(</span><span class=n>user_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>concurrent_requests</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>user_input</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>        <span class=n>request_count</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录Token使用</span>
</span></span><span class=line><span class=cl>        <span class=n>token_usage</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;prompt&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;usage&#39;</span><span class=p>][</span><span class=s1>&#39;prompt_tokens&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>token_usage</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;completion&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;usage&#39;</span><span class=p>][</span><span class=s1>&#39;completion_tokens&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request_count</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>status</span><span class=o>=</span><span class=s2>&#34;error&#34;</span><span class=p>,</span> <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>concurrent_requests</span><span class=o>.</span><span class=n>dec</span><span class=p>()</span></span></span></code></pre></div><hr><h1 id=第五部分案例研究>第五部分:案例研究<a class=anchor href=#%e7%ac%ac%e4%ba%94%e9%83%a8%e5%88%86%e6%a1%88%e4%be%8b%e7%a0%94%e7%a9%b6>#</a></h1><h2 id=51-智能客服agent优化实战>5.1 智能客服Agent优化实战<a class=anchor href=#51-%e6%99%ba%e8%83%bd%e5%ae%a2%e6%9c%8dagent%e4%bc%98%e5%8c%96%e5%ae%9e%e6%88%98>#</a></h2><h3 id=场景描述>场景描述<a class=anchor href=#%e5%9c%ba%e6%99%af%e6%8f%8f%e8%bf%b0>#</a></h3><p>某电商平台智能客服系统,日均10万次对话。</p><h3 id=优化前状态>优化前状态<a class=anchor href=#%e4%bc%98%e5%8c%96%e5%89%8d%e7%8a%b6%e6%80%81>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>性能指标:
</span></span><span class=line><span class=cl>- 平均响应时间: 5.2s
</span></span><span class=line><span class=cl>- P95延迟: 8.5s
</span></span><span class=line><span class=cl>- P99延迟: 12.3s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>用户体验:
</span></span><span class=line><span class=cl>- 用户满意度: 62%
</span></span><span class=line><span class=cl>- 超时率: 15%
</span></span><span class=line><span class=cl>- 转人工率: 35%
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>成本:
</span></span><span class=line><span class=cl>- 月度LLM成本: $5,000
</span></span><span class=line><span class=cl>- 服务器成本: $1,200</span></span></code></pre></div><h3 id=优化策略>优化策略<a class=anchor href=#%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5>#</a></h3><h4 id=优化1-启用流式输出>优化1: 启用流式输出<a class=anchor href=#%e4%bc%98%e5%8c%961-%e5%90%af%e7%94%a8%e6%b5%81%e5%bc%8f%e8%be%93%e5%87%ba>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 前: 非流式,用户等待5s</span>
</span></span><span class=line><span class=cl><span class=c1># 后: 流式,首字延迟0.3s</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>stream_chat</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>for</span> <span class=n>event</span> <span class=ow>in</span> <span class=n>agent</span><span class=o>.</span><span class=n>astream_events</span><span class=p>(</span><span class=nb>input</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=s2>&#34;v2&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;event&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;on_chat_model_stream&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;data&#34;</span><span class=p>][</span><span class=s2>&#34;chunk&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>content</span></span></span></code></pre></div><p><strong>效果</strong>: 首字延迟 ↓94% (5.2s → 0.3s)</p><h4 id=优化2-redis缓存常见问题>优化2: Redis缓存常见问题<a class=anchor href=#%e4%bc%98%e5%8c%962-redis%e7%bc%93%e5%ad%98%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>cache</span> <span class=o>=</span> <span class=n>RedisCache</span><span class=p>(</span><span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=o>...</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=n>cache</span><span class=o>=</span><span class=n>cache</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 命中率: 35%</span>
</span></span><span class=line><span class=cl><span class=c1># 缓存响应时间: &lt;50ms</span></span></span></code></pre></div><p><strong>效果</strong>: 35%请求响应时间 ↓99%</p><h4 id=优化3-简单问题路由到gpt-4o-mini>优化3: 简单问题路由到gpt-4o-mini<a class=anchor href=#%e4%bc%98%e5%8c%963-%e7%ae%80%e5%8d%95%e9%97%ae%e9%a2%98%e8%b7%af%e7%94%b1%e5%88%b0gpt-4o-mini>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>route_model</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>is_simple_qa</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>  <span class=c1># FAQ类问题</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;gpt-4o-mini&#34;</span>  <span class=c1># $0.15/1M vs $2.5/1M</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;gpt-4o&#34;</span></span></span></code></pre></div><p><strong>效果</strong>: 成本 ↓55%</p><h4 id=优化4-并行调用知识库和订单系统>优化4: 并行调用知识库和订单系统<a class=anchor href=#%e4%bc%98%e5%8c%964-%e5%b9%b6%e8%a1%8c%e8%b0%83%e7%94%a8%e7%9f%a5%e8%af%86%e5%ba%93%e5%92%8c%e8%ae%a2%e5%8d%95%e7%b3%bb%e7%bb%9f>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 前: 串行 - 知识库1s + 订单系统1s = 2s</span>
</span></span><span class=line><span class=cl><span class=c1># 后: 并行 - max(1s, 1s) = 1s</span></span></span></code></pre></div><p><strong>效果</strong>: 工具调用时间 ↓50%</p><h3 id=优化后状态>优化后状态<a class=anchor href=#%e4%bc%98%e5%8c%96%e5%90%8e%e7%8a%b6%e6%80%81>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>性能指标:
</span></span><span class=line><span class=cl>- 首字延迟: 0.3s (↓94%)
</span></span><span class=line><span class=cl>- 平均完整响应: 1.8s (↓65%)
</span></span><span class=line><span class=cl>- P95延迟: 3.2s (↓62%)
</span></span><span class=line><span class=cl>- P99延迟: 5.1s (↓59%)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>用户体验:
</span></span><span class=line><span class=cl>- 用户满意度: 89% (↑27%)
</span></span><span class=line><span class=cl>- 超时率: 2% (↓13%)
</span></span><span class=line><span class=cl>- 转人工率: 18% (↓17%)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>成本:
</span></span><span class=line><span class=cl>- 月度LLM成本: $2,250 (↓55%)
</span></span><span class=line><span class=cl>- 服务器成本: $980 (↓18%)</span></span></code></pre></div><h3 id=投入产出比>投入产出比<a class=anchor href=#%e6%8a%95%e5%85%a5%e4%ba%a7%e5%87%ba%e6%af%94>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>优化投入:
</span></span><span class=line><span class=cl>- 开发时间: 2周
</span></span><span class=line><span class=cl>- 基础设施: Redis ($100/月)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>收益:
</span></span><span class=line><span class=cl>- 成本节省: $2,870/月
</span></span><span class=line><span class=cl>- 用户满意度提升: 27%
</span></span><span class=line><span class=cl>- ROI: ~28倍/年</span></span></code></pre></div><hr><h2 id=最佳实践速查表>最佳实践速查表<a class=anchor href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e9%80%9f%e6%9f%a5%e8%a1%a8>#</a></h2><h3 id=-必做清单-高优先级>✅ 必做清单 (高优先级)<a class=anchor href=#-%e5%bf%85%e5%81%9a%e6%b8%85%e5%8d%95-%e9%ab%98%e4%bc%98%e5%85%88%e7%ba%a7>#</a></h3><p><strong>架构设计</strong>:</p><ul><li><input disabled type=checkbox> 使用<code>create_react_agent</code>而非手动循环</li><li><input disabled type=checkbox> 生产环境用PostgreSQL持久化checkpointer</li><li><input disabled type=checkbox> 工具函数有清晰的docstring和参数说明</li><li><input disabled type=checkbox> 控制工具数量 (3-7个最优)</li></ul><p><strong>性能优化</strong>:</p><ul><li><input disabled type=checkbox> 启用流式输出 (收益⭐⭐⭐⭐⭐, 成本低)</li><li><input disabled type=checkbox> 配置Redis缓存 (收益⭐⭐⭐⭐, 成本低)</li><li><input disabled type=checkbox> 使用异步调用ainvoke/astream (收益⭐⭐⭐⭐, 成本低)</li><li><input disabled type=checkbox> 添加性能监控</li></ul><p><strong>可靠性</strong>:</p><ul><li><input disabled type=checkbox> 所有外部调用添加超时控制 (30s)</li><li><input disabled type=checkbox> 实现指数退避重试 (至少3次)</li><li><input disabled type=checkbox> 区分可恢复/不可恢复错误</li><li><input disabled type=checkbox> 关键路径添加降级方案</li></ul><p><strong>监控</strong>:</p><ul><li><input disabled type=checkbox> 集成LangSmith追踪</li><li><input disabled type=checkbox> 记录关键指标 (延迟、成本、错误率)</li><li><input disabled type=checkbox> 设置错误率告警 (>5%)</li><li><input disabled type=checkbox> 定期审查错误日志</li></ul><h3 id=-推荐清单-中优先级>⭐ 推荐清单 (中优先级)<a class=anchor href=#-%e6%8e%a8%e8%8d%90%e6%b8%85%e5%8d%95-%e4%b8%ad%e4%bc%98%e5%85%88%e7%ba%a7>#</a></h3><ul><li><input disabled type=checkbox> 实现模型路由降低成本</li><li><input disabled type=checkbox> 断路器保护下游服务</li><li><input disabled type=checkbox> 语义缓存提升命中率</li><li><input disabled type=checkbox> 编写核心场景测试用例</li><li><input disabled type=checkbox> 集成Sentry错误追踪</li></ul><h3 id=-高级清单-可选>🚀 高级清单 (可选)<a class=anchor href=#-%e9%ab%98%e7%ba%a7%e6%b8%85%e5%8d%95-%e5%8f%af%e9%80%89>#</a></h3><ul><li><input disabled type=checkbox> 边缘部署降低全球延迟</li><li><input disabled type=checkbox> 预测性预加载</li><li><input disabled type=checkbox> 自动化错误分类与恢复</li><li><input disabled type=checkbox> 构建评估基准</li><li><input disabled type=checkbox> A/B测试系统</li></ul><hr><h2 id=学习路径建议>学习路径建议<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84%e5%bb%ba%e8%ae%ae>#</a></h2><h3 id=路径1-快速提升-1-2周>路径1: 快速提升 (1-2周)<a class=anchor href=#%e8%b7%af%e5%be%841-%e5%bf%ab%e9%80%9f%e6%8f%90%e5%8d%87-1-2%e5%91%a8>#</a></h3><p>适合: 已有Agent项目,需要快速优化</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>第二部分 (性能优化) → 第三部分 (可靠性) → 第四部分 (监控)</span></span></code></pre></div><h3 id=路径2-系统学习-4-6周>路径2: 系统学习 (4-6周)<a class=anchor href=#%e8%b7%af%e5%be%842-%e7%b3%bb%e7%bb%9f%e5%ad%a6%e4%b9%a0-4-6%e5%91%a8>#</a></h3><p>适合: 从零构建生产级Agent</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>第一部分 (架构) → 第二部分 (性能) → 第三部分 (可靠性)
</span></span><span class=line><span class=cl>  → 第四部分 (监控) → 第五部分 (案例)</span></span></code></pre></div><h3 id=路径3-专项深入-按需>路径3: 专项深入 (按需)<a class=anchor href=#%e8%b7%af%e5%be%843-%e4%b8%93%e9%a1%b9%e6%b7%b1%e5%85%a5-%e6%8c%89%e9%9c%80>#</a></h3><p>适合: 针对特定问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>根据实际问题选择对应章节深入研究</span></span></code></pre></div><hr><h2 id=环境准备>环境准备<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87>#</a></h2><h3 id=依赖安装>依赖安装<a class=anchor href=#%e4%be%9d%e8%b5%96%e5%ae%89%e8%a3%85>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 核心依赖</span>
</span></span><span class=line><span class=cl>pip install langchain&gt;<span class=o>=</span>1.0.7
</span></span><span class=line><span class=cl>pip install langgraph&gt;<span class=o>=</span>1.0.3
</span></span><span class=line><span class=cl>pip install langsmith&gt;<span class=o>=</span>0.2.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># LLM Providers</span>
</span></span><span class=line><span class=cl>pip install langchain-openai&gt;<span class=o>=</span>1.0.3
</span></span><span class=line><span class=cl>pip install langchain-anthropic
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数据存储</span>
</span></span><span class=line><span class=cl>pip install langchain-chroma
</span></span><span class=line><span class=cl>pip install redis
</span></span><span class=line><span class=cl>pip install psycopg2-binary
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 监控与测试</span>
</span></span><span class=line><span class=cl>pip install prometheus-client
</span></span><span class=line><span class=cl>pip install pytest pytest-asyncio
</span></span><span class=line><span class=cl>pip install tenacity  <span class=c1># 重试库</span>
</span></span><span class=line><span class=cl>pip install sentry-sdk  <span class=c1># 错误追踪</span></span></span></code></pre></div><h3 id=环境变量>环境变量<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># .env文件</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAI_API_KEY</span><span class=o>=</span>sk-...
</span></span><span class=line><span class=cl><span class=nv>LANGCHAIN_API_KEY</span><span class=o>=</span>ls__...
</span></span><span class=line><span class=cl><span class=nv>LANGCHAIN_TRACING_V2</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>LANGCHAIN_PROJECT</span><span class=o>=</span>agent-production
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># PostgreSQL (可选)</span>
</span></span><span class=line><span class=cl><span class=nv>POSTGRES_URI</span><span class=o>=</span>postgresql://user:pass@localhost:5432/langchain
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Redis (可选)</span>
</span></span><span class=line><span class=cl><span class=nv>REDIS_HOST</span><span class=o>=</span>localhost
</span></span><span class=line><span class=cl><span class=nv>REDIS_PORT</span><span class=o>=</span><span class=m>6379</span></span></span></code></pre></div><hr><h2 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h2><h3 id=官方文档>官方文档<a class=anchor href=#%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3>#</a></h3><ul><li><a href=https://docs.langchain.com>LangChain Docs</a></li><li><a href=https://docs.langchain.com/oss/python/langgraph/>LangGraph Docs</a></li><li><a href=https://docs.smith.langchain.com/>LangSmith Docs</a></li></ul><h3 id=相关笔记>相关笔记<a class=anchor href=#%e7%9b%b8%e5%85%b3%e7%ac%94%e8%ae%b0>#</a></h3><ul><li><a href=../../chapter27/LangChain%e7%ac%94%e8%ae%b0.md>LangChain笔记</a> - 基础教程</li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/3.-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/>大模型设计思想</a> - 设计理念</li></ul><h3 id=社区资源>社区资源<a class=anchor href=#%e7%a4%be%e5%8c%ba%e8%b5%84%e6%ba%90>#</a></h3><ul><li><a href=https://github.com/langchain-ai/langchain>LangChain GitHub</a></li><li><a href=https://discord.gg/langchain>LangChain Discord</a></li><li><a href=https://blog.langchain.com>LangChain Blog</a></li></ul><hr><p><strong>维护</strong>: LangChain笔记项目组
<strong>版本</strong>: v1.0.0
<strong>最后更新</strong>: 2025-11-20</p></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>深入理解 FastAPI</span>
</a></span><span><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/ class="flex align-center"><span>第01章 机器学习概览</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概述>概述</a><ul><li><a href=#与langchain笔记的关系>与《LangChain笔记》的关系</a></li><li><a href=#学习目标>学习目标</a></li></ul></li><li><a href=#目录>目录</a><ul><li><a href=#第一部分-架构设计模式>第一部分: 架构设计模式</a></li><li><a href=#第二部分-性能优化实战>第二部分: 性能优化实战</a></li><li><a href=#第三部分-可靠性保障>第三部分: 可靠性保障</a></li><li><a href=#第四部分-监控运维>第四部分: 监控运维</a></li><li><a href=#第五部分-案例研究>第五部分: 案例研究</a></li></ul></li></ul><ul><li><a href=#11-单agent架构设计>1.1 单Agent架构设计</a><ul><li><a href=#核心原则>核心原则</a></li><li><a href=#三种核心模式>三种核心模式</a><ul><li><a href=#模式1-react-agent-推荐->模式1: ReAct Agent (推荐 ⭐⭐⭐⭐⭐)</a></li></ul></li></ul></li><li><a href=#12-状态管理最佳实践>1.2 状态管理最佳实践</a><ul><li><a href=#状态设计原则>状态设计原则</a></li><li><a href=#持久化方案对比>持久化方案对比</a></li></ul></li><li><a href=#13-工具系统设计>1.3 工具系统设计</a><ul><li><a href=#工具设计原则>工具设计原则</a></li><li><a href=#工具数量控制>工具数量控制</a></li></ul></li></ul><ul><li><a href=#21-响应速度优化>2.1 响应速度优化</a><ul><li><a href=#性能基准>性能基准</a></li><li><a href=#优化策略1-流式输出-必做->优化策略1: 流式输出 (必做 ⭐⭐⭐⭐⭐)</a></li><li><a href=#优化策略2-并行工具调用-收益->优化策略2: 并行工具调用 (收益 ⭐⭐⭐⭐)</a></li><li><a href=#优化策略3-模型路由-收益->优化策略3: 模型路由 (收益 ⭐⭐⭐⭐)</a></li><li><a href=#优化策略4-智能缓存-收益->优化策略4: 智能缓存 (收益 ⭐⭐⭐)</a><ul><li><a href=#精确缓存>精确缓存</a></li><li><a href=#语义缓存>语义缓存</a></li></ul></li></ul></li><li><a href=#22-成本优化策略>2.2 成本优化策略</a><ul><li><a href=#token使用优化>Token使用优化</a></li></ul></li><li><a href=#23-并发与异步处理>2.3 并发与异步处理</a><ul><li><a href=#异步调用-必做>异步调用 (必做)</a></li><li><a href=#批处理优化>批处理优化</a></li></ul></li></ul><ul><li><a href=#31-错误处理与重试>3.1 错误处理与重试</a><ul><li><a href=#错误分类>错误分类</a></li><li><a href=#重试策略>重试策略</a><ul><li><a href=#策略1-简单重试>策略1: 简单重试</a></li><li><a href=#策略2-指数退避-推荐->策略2: 指数退避 (推荐 ⭐⭐⭐⭐⭐)</a></li><li><a href=#策略3-智能重试-生产推荐->策略3: 智能重试 (生产推荐 ⭐⭐⭐⭐⭐)</a></li><li><a href=#策略4-断路器模式-防雪崩->策略4: 断路器模式 (防雪崩 ⭐⭐⭐⭐)</a></li></ul></li></ul></li><li><a href=#32-降级与熔断>3.2 降级与熔断</a><ul><li><a href=#降级策略>降级策略</a><ul><li><a href=#降级1-工具降级>降级1: 工具降级</a></li><li><a href=#降级2-模型降级>降级2: 模型降级</a></li><li><a href=#降级3-功能降级>降级3: 功能降级</a></li></ul></li></ul></li><li><a href=#33-测试策略>3.3 测试策略</a><ul><li><a href=#单元测试>单元测试</a></li></ul></li></ul><ul><li><a href=#41-可观测性建设>4.1 可观测性建设</a><ul><li><a href=#三大支柱>三大支柱</a></li><li><a href=#结构化日志>结构化日志</a></li><li><a href=#langsmith集成>LangSmith集成</a></li></ul></li><li><a href=#42-关键指标监控>4.2 关键指标监控</a><ul><li><a href=#核心指标>核心指标</a></li></ul></li></ul><ul><li><a href=#51-智能客服agent优化实战>5.1 智能客服Agent优化实战</a><ul><li><a href=#场景描述>场景描述</a></li><li><a href=#优化前状态>优化前状态</a></li><li><a href=#优化策略>优化策略</a><ul><li><a href=#优化1-启用流式输出>优化1: 启用流式输出</a></li><li><a href=#优化2-redis缓存常见问题>优化2: Redis缓存常见问题</a></li><li><a href=#优化3-简单问题路由到gpt-4o-mini>优化3: 简单问题路由到gpt-4o-mini</a></li><li><a href=#优化4-并行调用知识库和订单系统>优化4: 并行调用知识库和订单系统</a></li></ul></li><li><a href=#优化后状态>优化后状态</a></li><li><a href=#投入产出比>投入产出比</a></li></ul></li><li><a href=#最佳实践速查表>最佳实践速查表</a><ul><li><a href=#-必做清单-高优先级>✅ 必做清单 (高优先级)</a></li><li><a href=#-推荐清单-中优先级>⭐ 推荐清单 (中优先级)</a></li><li><a href=#-高级清单-可选>🚀 高级清单 (可选)</a></li></ul></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#路径1-快速提升-1-2周>路径1: 快速提升 (1-2周)</a></li><li><a href=#路径2-系统学习-4-6周>路径2: 系统学习 (4-6周)</a></li><li><a href=#路径3-专项深入-按需>路径3: 专项深入 (按需)</a></li></ul></li><li><a href=#环境准备>环境准备</a><ul><li><a href=#依赖安装>依赖安装</a></li><li><a href=#环境变量>环境变量</a></li></ul></li><li><a href=#参考资源>参考资源</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#相关笔记>相关笔记</a></li><li><a href=#社区资源>社区资源</a></li></ul></li></ul></nav></div></aside></main></body></html>