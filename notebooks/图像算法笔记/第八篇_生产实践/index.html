<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="第八篇：生产实践与工程化# 工程实战篇章 - 将计算机视觉模型从实验室带到生产环境的完整指南
篇章定位# 本篇是整个计算机视觉笔记的工程实战篇章，专注于将训练好的模型真正部署到生产环境。从模型优化到服务化部署，从性能监控到最佳实践，系统讲解工程化的全流程。
为什么需要生产实践？# 性能要求 - 生产环境对延迟、吞吐量有严格要求 资源限制 - 边缘设备内存、算力有限，需要模型压缩 稳定性 - 7x24小时运行，需要完善的监控和容错 可维护性 - 便于更新、回滚、A/B测试 内容结构# 第19章：模型优化与加速# 深入讲解模型压缩和加速技术：
19.1 量化：INT8/FP16推理
量化原理与类型 PyTorch原生量化 ONNX Runtime量化 精度损失分析 19.2 剪枝与蒸馏
结构化剪枝 非结构化剪枝 知识蒸馏方法 实战：压缩ResNet 19.3 TensorRT加速
TensorRT工作原理 ONNX转TensorRT 性能优化技巧 INT8校准 19.4 实战：模型压缩与部署
完整优化流程 性能基准测试 精度-速度权衡 第20章：生产部署# 系统讲解部署方案和最佳实践：
20.1 ONNX模型转换
PyTorch转ONNX 模型验证与简化 跨框架部署 20.2 服务化部署（FastAPI/Triton）
FastAPI构建推理服务 Triton Inference Server 负载均衡与扩展 Docker容器化 20.3 边缘设备部署
移动端部署（TFLite/CoreML） Jetson嵌入式设备 ONNX Runtime Mobile 性能优化 20.4 实战：构建生产级服务
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第八篇 生产实践"><meta property="og:description" content="第八篇：生产实践与工程化# 工程实战篇章 - 将计算机视觉模型从实验室带到生产环境的完整指南
篇章定位# 本篇是整个计算机视觉笔记的工程实战篇章，专注于将训练好的模型真正部署到生产环境。从模型优化到服务化部署，从性能监控到最佳实践，系统讲解工程化的全流程。
为什么需要生产实践？# 性能要求 - 生产环境对延迟、吞吐量有严格要求 资源限制 - 边缘设备内存、算力有限，需要模型压缩 稳定性 - 7x24小时运行，需要完善的监控和容错 可维护性 - 便于更新、回滚、A/B测试 内容结构# 第19章：模型优化与加速# 深入讲解模型压缩和加速技术：
19.1 量化：INT8/FP16推理
量化原理与类型 PyTorch原生量化 ONNX Runtime量化 精度损失分析 19.2 剪枝与蒸馏
结构化剪枝 非结构化剪枝 知识蒸馏方法 实战：压缩ResNet 19.3 TensorRT加速
TensorRT工作原理 ONNX转TensorRT 性能优化技巧 INT8校准 19.4 实战：模型压缩与部署
完整优化流程 性能基准测试 精度-速度权衡 第20章：生产部署# 系统讲解部署方案和最佳实践：
20.1 ONNX模型转换
PyTorch转ONNX 模型验证与简化 跨框架部署 20.2 服务化部署（FastAPI/Triton）
FastAPI构建推理服务 Triton Inference Server 负载均衡与扩展 Docker容器化 20.3 边缘设备部署
移动端部署（TFLite/CoreML） Jetson嵌入式设备 ONNX Runtime Mobile 性能优化 20.4 实战：构建生产级服务"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第八篇 生产实践"><meta itemprop=description content="第八篇：生产实践与工程化# 工程实战篇章 - 将计算机视觉模型从实验室带到生产环境的完整指南
篇章定位# 本篇是整个计算机视觉笔记的工程实战篇章，专注于将训练好的模型真正部署到生产环境。从模型优化到服务化部署，从性能监控到最佳实践，系统讲解工程化的全流程。
为什么需要生产实践？# 性能要求 - 生产环境对延迟、吞吐量有严格要求 资源限制 - 边缘设备内存、算力有限，需要模型压缩 稳定性 - 7x24小时运行，需要完善的监控和容错 可维护性 - 便于更新、回滚、A/B测试 内容结构# 第19章：模型优化与加速# 深入讲解模型压缩和加速技术：
19.1 量化：INT8/FP16推理
量化原理与类型 PyTorch原生量化 ONNX Runtime量化 精度损失分析 19.2 剪枝与蒸馏
结构化剪枝 非结构化剪枝 知识蒸馏方法 实战：压缩ResNet 19.3 TensorRT加速
TensorRT工作原理 ONNX转TensorRT 性能优化技巧 INT8校准 19.4 实战：模型压缩与部署
完整优化流程 性能基准测试 精度-速度权衡 第20章：生产部署# 系统讲解部署方案和最佳实践：
20.1 ONNX模型转换
PyTorch转ONNX 模型验证与简化 跨框架部署 20.2 服务化部署（FastAPI/Triton）
FastAPI构建推理服务 Triton Inference Server 负载均衡与扩展 Docker容器化 20.3 边缘设备部署
移动端部署（TFLite/CoreML） Jetson嵌入式设备 ONNX Runtime Mobile 性能优化 20.4 实战：构建生产级服务"><meta itemprop=wordCount content="3523"><title>第八篇 生产实践 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle checked>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/ class=active>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第八篇 生产实践</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#篇章定位>篇章定位</a></li><li><a href=#为什么需要生产实践>为什么需要生产实践？</a></li><li><a href=#内容结构>内容结构</a><ul><li><a href=#第19章模型优化与加速>第19章：模型优化与加速</a></li><li><a href=#第20章生产部署>第20章：生产部署</a></li><li><a href=#第21章mlops与最佳实践>第21章：MLOps与最佳实践</a></li></ul></li><li><a href=#技术栈>技术栈</a></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#快速入门路径>快速入门路径</a></li><li><a href=#系统学习路径>系统学习路径</a></li><li><a href=#工程化路径>工程化路径</a></li></ul></li><li><a href=#实践项目建议>实践项目建议</a><ul><li><a href=#入门项目>入门项目</a></li><li><a href=#进阶项目>进阶项目</a></li><li><a href=#高级项目>高级项目</a></li></ul></li><li><a href=#性能目标>性能目标</a></li><li><a href=#应用场景>应用场景</a></li><li><a href=#学习目标>学习目标</a></li><li><a href=#参考资源>参考资源</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#工具与平台>工具与平台</a></li><li><a href=#社区资源>社区资源</a></li></ul></li><li><a href=#前置知识>前置知识</a></li><li><a href=#开始学习>开始学习</a></li></ul><ul><li><a href=#本章概览>本章概览</a></li><li><a href=#为什么需要模型优化>为什么需要模型优化？</a></li><li><a href=#章节结构>章节结构</a></li><li><a href=#191-量化int8fp16推理>19.1 量化：INT8/FP16推理</a><ul><li><a href=#1911-量化原理>19.1.1 量化原理</a></li><li><a href=#1912-pytorch量化实战>19.1.2 PyTorch量化实战</a></li><li><a href=#1913-fp16混合精度>19.1.3 FP16混合精度</a></li></ul></li><li><a href=#192-剪枝与蒸馏>19.2 剪枝与蒸馏</a><ul><li><a href=#1921-模型剪枝>19.2.1 模型剪枝</a></li><li><a href=#1922-知识蒸馏>19.2.2 知识蒸馏</a></li></ul></li><li><a href=#193-tensorrt加速>19.3 TensorRT加速</a><ul><li><a href=#1931-onnx转tensorrt>19.3.1 ONNX转TensorRT</a></li></ul></li><li><a href=#194-实战模型压缩与部署>19.4 实战：模型压缩与部署</a><ul><li><a href=#优化决策矩阵>优化决策矩阵</a></li></ul></li><li><a href=#本章小结>本章小结</a></li></ul><ul><li><a href=#本章概览-1>本章概览</a></li><li><a href=#为什么需要服务化部署>为什么需要服务化部署？</a></li><li><a href=#201-onnx模型转换>20.1 ONNX模型转换</a><ul><li><a href=#2011-为什么选择onnx>20.1.1 为什么选择ONNX？</a></li><li><a href=#2012-pytorch转onnx>20.1.2 PyTorch转ONNX</a></li><li><a href=#2013-模型验证与简化>20.1.3 模型验证与简化</a></li></ul></li><li><a href=#202-服务化部署>20.2 服务化部署</a><ul><li><a href=#2021-fastapi构建推理服务>20.2.1 FastAPI构建推理服务</a></li><li><a href=#2022-triton-inference-server>20.2.2 Triton Inference Server</a></li><li><a href=#2023-docker容器化>20.2.3 Docker容器化</a></li></ul></li><li><a href=#203-边缘设备部署>20.3 边缘设备部署</a><ul><li><a href=#2031-移动端部署>20.3.1 移动端部署</a></li><li><a href=#2032-jetson嵌入式设备>20.3.2 Jetson嵌入式设备</a></li><li><a href=#2033-onnx-runtime-mobile>20.3.3 ONNX Runtime Mobile</a></li></ul></li><li><a href=#204-实战构建生产级服务>20.4 实战：构建生产级服务</a><ul><li><a href=#完整架构示例>完整架构示例</a></li><li><a href=#api设计规范>API设计规范</a></li><li><a href=#监控指标>监控指标</a></li></ul></li><li><a href=#本章小结-1>本章小结</a><ul><li><a href=#核心要点>核心要点</a></li><li><a href=#部署决策树>部署决策树</a></li></ul></li></ul><ul><li><a href=#本章概览-2>本章概览</a></li><li><a href=#为什么需要mlops>为什么需要MLOps？</a></li><li><a href=#211-数据管理与标注>21.1 数据管理与标注</a><ul><li><a href=#2111-数据版本控制dvc>21.1.1 数据版本控制（DVC）</a></li><li><a href=#2112-标注工具选型>21.1.2 标注工具选型</a></li><li><a href=#2113-数据质量管理>21.1.3 数据质量管理</a></li></ul></li><li><a href=#212-实验跟踪>21.2 实验跟踪</a><ul><li><a href=#2121-weights--biases集成>21.2.1 Weights & Biases集成</a></li><li><a href=#2122-超参数优化>21.2.2 超参数优化</a></li><li><a href=#2123-模型版本管理>21.2.3 模型版本管理</a></li></ul></li><li><a href=#213-模型监控与ab测试>21.3 模型监控与A/B测试</a><ul><li><a href=#2131-生产监控指标>21.3.1 生产监控指标</a></li><li><a href=#2132-数据漂移检测>21.3.2 数据漂移检测</a></li><li><a href=#2133-ab测试设计>21.3.3 A/B测试设计</a></li></ul></li><li><a href=#214-最佳实践清单>21.4 最佳实践清单</a><ul><li><a href=#开发流程规范>开发流程规范</a></li><li><a href=#代码质量标准>代码质量标准</a></li><li><a href=#部署检查清单>部署检查清单</a></li><li><a href=#常见问题解答>常见问题解答</a></li></ul></li><li><a href=#本章小结-2>本章小结</a><ul><li><a href=#核心要点-1>核心要点</a></li><li><a href=#mlops成熟度级别>MLOps成熟度级别</a></li><li><a href=#学习资源>学习资源</a></li></ul></li><li><a href=#第八篇总结>第八篇总结</a><ul><li><a href=#学习成果>学习成果</a></li><li><a href=#技术栈总结>技术栈总结</a></li><li><a href=#下一步>下一步</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第八篇生产实践与工程化>第八篇：生产实践与工程化<a class=anchor href=#%e7%ac%ac%e5%85%ab%e7%af%87%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5%e4%b8%8e%e5%b7%a5%e7%a8%8b%e5%8c%96>#</a></h1><blockquote class=book-hint><p><strong>工程实战篇章</strong> - 将计算机视觉模型从实验室带到生产环境的完整指南</p></blockquote><h2 id=篇章定位>篇章定位<a class=anchor href=#%e7%af%87%e7%ab%a0%e5%ae%9a%e4%bd%8d>#</a></h2><p>本篇是整个计算机视觉笔记的<strong>工程实战篇章</strong>，专注于将训练好的模型真正部署到生产环境。从模型优化到服务化部署，从性能监控到最佳实践，系统讲解工程化的全流程。</p><h2 id=为什么需要生产实践>为什么需要生产实践？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5>#</a></h2><ol><li><strong>性能要求</strong> - 生产环境对延迟、吞吐量有严格要求</li><li><strong>资源限制</strong> - 边缘设备内存、算力有限，需要模型压缩</li><li><strong>稳定性</strong> - 7x24小时运行，需要完善的监控和容错</li><li><strong>可维护性</strong> - 便于更新、回滚、A/B测试</li></ol><h2 id=内容结构>内容结构<a class=anchor href=#%e5%86%85%e5%ae%b9%e7%bb%93%e6%9e%84>#</a></h2><h3 id=第19章模型优化与加速>第19章：模型优化与加速<a class=anchor href=#%e7%ac%ac19%e7%ab%a0%e6%a8%a1%e5%9e%8b%e4%bc%98%e5%8c%96%e4%b8%8e%e5%8a%a0%e9%80%9f>#</a></h3><p>深入讲解模型压缩和加速技术：</p><ul><li><p><strong>19.1 量化：INT8/FP16推理</strong></p><ul><li>量化原理与类型</li><li>PyTorch原生量化</li><li>ONNX Runtime量化</li><li>精度损失分析</li></ul></li><li><p><strong>19.2 剪枝与蒸馏</strong></p><ul><li>结构化剪枝</li><li>非结构化剪枝</li><li>知识蒸馏方法</li><li>实战：压缩ResNet</li></ul></li><li><p><strong>19.3 TensorRT加速</strong></p><ul><li>TensorRT工作原理</li><li>ONNX转TensorRT</li><li>性能优化技巧</li><li>INT8校准</li></ul></li><li><p><strong>19.4 实战：模型压缩与部署</strong></p><ul><li>完整优化流程</li><li>性能基准测试</li><li>精度-速度权衡</li></ul></li></ul><h3 id=第20章生产部署>第20章：生产部署<a class=anchor href=#%e7%ac%ac20%e7%ab%a0%e7%94%9f%e4%ba%a7%e9%83%a8%e7%bd%b2>#</a></h3><p>系统讲解部署方案和最佳实践：</p><ul><li><p><strong>20.1 ONNX模型转换</strong></p><ul><li>PyTorch转ONNX</li><li>模型验证与简化</li><li>跨框架部署</li></ul></li><li><p><strong>20.2 服务化部署（FastAPI/Triton）</strong></p><ul><li>FastAPI构建推理服务</li><li>Triton Inference Server</li><li>负载均衡与扩展</li><li>Docker容器化</li></ul></li><li><p><strong>20.3 边缘设备部署</strong></p><ul><li>移动端部署（TFLite/CoreML）</li><li>Jetson嵌入式设备</li><li>ONNX Runtime Mobile</li><li>性能优化</li></ul></li><li><p><strong>20.4 实战：构建生产级服务</strong></p><ul><li>完整服务架构</li><li>API设计规范</li><li>性能监控</li><li>高可用保障</li></ul></li></ul><h3 id=第21章mlops与最佳实践>第21章：MLOps与最佳实践<a class=anchor href=#%e7%ac%ac21%e7%ab%a0mlops%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><p>讲解机器学习运维和工程化规范：</p><ul><li><p><strong>21.1 数据管理与标注</strong></p><ul><li>数据版本控制</li><li>标注工具选型</li><li>数据质量管理</li><li>持续数据收集</li></ul></li><li><p><strong>21.2 实验跟踪（Weights & Biases）</strong></p><ul><li>W&amp;B集成</li><li>实验管理</li><li>超参数优化</li><li>模型版本管理</li></ul></li><li><p><strong>21.3 模型监控与A/B测试</strong></p><ul><li>性能监控指标</li><li>数据漂移检测</li><li>A/B测试设计</li><li>模型回滚策略</li></ul></li><li><p><strong>21.4 最佳实践清单</strong></p><ul><li>开发流程规范</li><li>代码质量标准</li><li>部署检查清单</li><li>常见问题解答</li></ul></li></ul><h2 id=技术栈>技术栈<a class=anchor href=#%e6%8a%80%e6%9c%af%e6%a0%88>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>模型优化</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>torch&gt;=2.0.0          </span><span class=w> </span><span class=c># PyTorch量化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>onnx&gt;=1.15.0          </span><span class=w> </span><span class=c># ONNX模型格式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>onnxruntime-gpu       </span><span class=w> </span><span class=c># ONNX推理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>tensorrt&gt;=10.0        </span><span class=w> </span><span class=c># NVIDIA加速</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>torch-pruning         </span><span class=w> </span><span class=c># 模型剪枝</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>服务部署</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>fastapi&gt;=0.115.0      </span><span class=w> </span><span class=c># Web服务框架</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>uvicorn[standard]     </span><span class=w> </span><span class=c># ASGI服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>docker                </span><span class=w> </span><span class=c># 容器化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>tritonserver          </span><span class=w> </span><span class=c># NVIDIA推理服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>redis                 </span><span class=w> </span><span class=c># 缓存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>MLOps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>wandb                 </span><span class=w> </span><span class=c># 实验跟踪</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>mlflow                </span><span class=w> </span><span class=c># 模型管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>prometheus            </span><span class=w> </span><span class=c># 监控</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>grafana               </span><span class=w> </span><span class=c># 可视化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>dvc                   </span><span class=w> </span><span class=c># 数据版本控制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>边缘部署</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>onnxruntime-mobile    </span><span class=w> </span><span class=c># 移动端推理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>coremltools           </span><span class=w> </span><span class=c># iOS部署</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>tensorflow-lite       </span><span class=w> </span><span class=c># 移动端推理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>openvino              </span><span class=w> </span><span class=c># Intel优化</span></span></span></code></pre></div><h2 id=学习路径建议>学习路径建议<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84%e5%bb%ba%e8%ae%ae>#</a></h2><h3 id=快速入门路径>快速入门路径<a class=anchor href=#%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8%e8%b7%af%e5%be%84>#</a></h3><ol><li>先学第20章，快速搭建推理服务</li><li>再学第19章，优化模型性能</li><li>最后学第21章，完善工程化流程</li></ol><h3 id=系统学习路径>系统学习路径<a class=anchor href=#%e7%b3%bb%e7%bb%9f%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84>#</a></h3><ol><li>按顺序学习19→20→21章</li><li>每章完成实战项目</li><li>构建完整的生产系统</li></ol><h3 id=工程化路径>工程化路径<a class=anchor href=#%e5%b7%a5%e7%a8%8b%e5%8c%96%e8%b7%af%e5%be%84>#</a></h3><ol><li>重点学习第21章MLOps</li><li>结合前面章节的模型训练</li><li>建立完整的开发-部署流程</li></ol><h2 id=实践项目建议>实践项目建议<a class=anchor href=#%e5%ae%9e%e8%b7%b5%e9%a1%b9%e7%9b%ae%e5%bb%ba%e8%ae%ae>#</a></h2><h3 id=入门项目>入门项目<a class=anchor href=#%e5%85%a5%e9%97%a8%e9%a1%b9%e7%9b%ae>#</a></h3><ul><li><strong>项目1</strong>：使用FastAPI部署YOLOv8检测服务</li><li><strong>项目2</strong>：将PyTorch模型转换为ONNX并优化</li><li><strong>项目3</strong>：使用W&amp;B跟踪训练实验</li></ul><h3 id=进阶项目>进阶项目<a class=anchor href=#%e8%bf%9b%e9%98%b6%e9%a1%b9%e7%9b%ae>#</a></h3><ul><li><strong>项目4</strong>：使用TensorRT加速推理10倍</li><li><strong>项目5</strong>：构建基于Triton的多模型服务</li><li><strong>项目6</strong>：INT8量化并在Jetson上部署</li></ul><h3 id=高级项目>高级项目<a class=anchor href=#%e9%ab%98%e7%ba%a7%e9%a1%b9%e7%9b%ae>#</a></h3><ul><li><strong>项目7</strong>：构建完整的MLOps流程</li><li><strong>项目8</strong>：实现模型A/B测试系统</li><li><strong>项目9</strong>：搭建生产级视觉AI服务</li></ul><h2 id=性能目标>性能目标<a class=anchor href=#%e6%80%a7%e8%83%bd%e7%9b%ae%e6%a0%87>#</a></h2><p>基于典型场景的性能指标：</p><table><thead><tr><th>优化方法</th><th>模型大小</th><th>推理速度</th><th>精度损失</th><th>难度</th></tr></thead><tbody><tr><td>FP16量化</td><td>50%</td><td>1.5-2x</td><td>&lt;0.5%</td><td>简单</td></tr><tr><td>INT8量化</td><td>25%</td><td>2-4x</td><td>1-2%</td><td>中等</td></tr><tr><td>剪枝+量化</td><td>10-20%</td><td>3-5x</td><td>2-3%</td><td>困难</td></tr><tr><td>蒸馏</td><td>自定义</td><td>5-10x</td><td>2-5%</td><td>困难</td></tr><tr><td>TensorRT</td><td>-</td><td>2-10x</td><td>&lt;1%</td><td>中等</td></tr></tbody></table><h2 id=应用场景>应用场景<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h2><p>本篇技术适用于：</p><ol><li><strong>云端部署</strong> - 服务化推理API</li><li><strong>边缘设备</strong> - Jetson、树莓派、移动端</li><li><strong>实时系统</strong> - 低延迟要求的应用</li><li><strong>大规模服务</strong> - 高并发场景</li><li><strong>资源受限</strong> - 内存、算力有限的环境</li></ol><h2 id=学习目标>学习目标<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87>#</a></h2><p>完成本篇学习后，你将能够：</p><ol><li>✅ 理解模型优化的完整技术栈</li><li>✅ 掌握量化、剪枝、蒸馏等压缩技术</li><li>✅ 熟练使用TensorRT加速推理</li><li>✅ 能够构建生产级的推理服务</li><li>✅ 掌握Docker容器化部署</li><li>✅ 了解Triton多模型服务架构</li><li>✅ 能够在边缘设备上部署模型</li><li>✅ 建立完整的MLOps流程</li><li>✅ 掌握实验跟踪和模型管理</li><li>✅ 实现模型监控和A/B测试</li></ol><h2 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h2><h3 id=官方文档>官方文档<a class=anchor href=#%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3>#</a></h3><ul><li><a href=https://pytorch.org/docs/stable/quantization.html>PyTorch Quantization</a></li><li><a href=https://onnxruntime.ai/>ONNX Runtime</a></li><li><a href=https://docs.nvidia.com/deeplearning/tensorrt/>TensorRT Documentation</a></li><li><a href=https://fastapi.tiangolo.com/>FastAPI Documentation</a></li><li><a href=https://github.com/triton-inference-server/server>Triton Inference Server</a></li><li><a href=https://docs.wandb.ai/>Weights & Biases</a></li></ul><h3 id=工具与平台>工具与平台<a class=anchor href=#%e5%b7%a5%e5%85%b7%e4%b8%8e%e5%b9%b3%e5%8f%b0>#</a></h3><ul><li>Docker Hub: <a href=https://hub.docker.com/>https://hub.docker.com/</a></li><li>NVIDIA NGC: <a href=https://catalog.ngc.nvidia.com/>https://catalog.ngc.nvidia.com/</a></li><li>Hugging Face: <a href=https://huggingface.co/>https://huggingface.co/</a></li></ul><h3 id=社区资源>社区资源<a class=anchor href=#%e7%a4%be%e5%8c%ba%e8%b5%84%e6%ba%90>#</a></h3><ul><li>Model Optimization Toolkit</li><li>ONNX Model Zoo</li><li>TensorRT Samples</li></ul><h2 id=前置知识>前置知识<a class=anchor href=#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86>#</a></h2><p>学习本篇前，建议已掌握：</p><ul><li>前七篇的计算机视觉基础知识</li><li>PyTorch深度学习框架</li><li>Python编程和Linux基础</li><li>Docker基本使用</li><li>基础的网络和服务器知识</li></ul><h2 id=开始学习>开始学习<a class=anchor href=#%e5%bc%80%e5%a7%8b%e5%ad%a6%e4%b9%a0>#</a></h2><p>准备好将你的模型部署到生产环境了吗？让我们从第19章开始，学习如何优化和加速模型！</p><p><strong>下一步</strong>：<a href=./chapter19/README.md>第19章：模型优化与加速</a></p><hr><p><strong>更新日期</strong>：2025年11月
<strong>基于版本</strong>：PyTorch 2.0+, TensorRT 10.0+, FastAPI 0.115+</p><hr><h1 id=第19章模型优化与加速-1>第19章：模型优化与加速<a class=anchor href=#%e7%ac%ac19%e7%ab%a0%e6%a8%a1%e5%9e%8b%e4%bc%98%e5%8c%96%e4%b8%8e%e5%8a%a0%e9%80%9f-1>#</a></h1><blockquote class=book-hint><p><strong>性能优化核心章节</strong> - 深入讲解模型压缩和推理加速技术</p></blockquote><h2 id=本章概览>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88>#</a></h2><p>本章将系统讲解如何将训练好的深度学习模型进行优化和加速，使其能够在生产环境中高效运行。我们将学习：</p><ul><li>量化（INT8/FP16）原理与实践</li><li>剪枝与知识蒸馏技术</li><li>TensorRT加速引擎</li><li>完整的模型压缩流程</li></ul><h2 id=为什么需要模型优化>为什么需要模型优化？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e6%a8%a1%e5%9e%8b%e4%bc%98%e5%8c%96>#</a></h2><p><strong>典型场景的挑战</strong>：</p><ol><li><strong>云端服务</strong> - 高并发下GPU资源昂贵，需要优化提升吞吐量</li><li><strong>边缘设备</strong> - 内存有限（如Jetson Nano仅4GB），需要模型压缩</li><li><strong>实时应用</strong> - 延迟要求严格（如自动驾驶&lt;100ms），需要推理加速</li><li><strong>移动端</strong> - 算力和功耗限制，需要轻量化模型</li></ol><h2 id=章节结构>章节结构<a class=anchor href=#%e7%ab%a0%e8%8a%82%e7%bb%93%e6%9e%84>#</a></h2><ul><li><strong>19.1</strong> 量化：INT8/FP16推理</li><li><strong>19.2</strong> 剪枝与蒸馏</li><li><strong>19.3</strong> TensorRT加速</li><li><strong>19.4</strong> 实战：模型压缩与部署</li></ul><hr><h2 id=191-量化int8fp16推理>19.1 量化：INT8/FP16推理<a class=anchor href=#191-%e9%87%8f%e5%8c%96int8fp16%e6%8e%a8%e7%90%86>#</a></h2><h3 id=1911-量化原理>19.1.1 量化原理<a class=anchor href=#1911-%e9%87%8f%e5%8c%96%e5%8e%9f%e7%90%86>#</a></h3><p><strong>什么是量化？</strong></p><p>量化是将浮点数（FP32）转换为低精度表示（INT8/FP16）的过程。</p><p><strong>数值表示对比</strong>：</p><table><thead><tr><th>类型</th><th>位数</th><th>范围</th><th>内存占用</th><th>典型用途</th></tr></thead><tbody><tr><td>FP32</td><td>32位</td><td>±3.4×10^38</td><td>4 bytes</td><td>训练、高精度推理</td></tr><tr><td>FP16</td><td>16位</td><td>±6.5×10^4</td><td>2 bytes</td><td>混合精度训练、推理</td></tr><tr><td>INT8</td><td>8位</td><td>-128~127</td><td>1 byte</td><td>推理</td></tr></tbody></table><p><strong>量化公式</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>量化值 = round((实际值 - zero_point) / scale)
</span></span><span class=line><span class=cl>反量化值 = 量化值 × scale + zero_point</span></span></code></pre></div><h3 id=1912-pytorch量化实战>19.1.2 PyTorch量化实战<a class=anchor href=#1912-pytorch%e9%87%8f%e5%8c%96%e5%ae%9e%e6%88%98>#</a></h3><p><strong>动态量化（最简单）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch</span> <span class=kn>import</span> <span class=n>nn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 原始模型</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SimpleModel</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fc1</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>fc2</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 动态量化（一行代码）</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>SimpleModel</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>quantized_model</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>quantization</span><span class=o>.</span><span class=n>quantize_dynamic</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>qint8</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p>完整示例见 <code>code/chapter19_optimization/model_quantization.py</code></p><h3 id=1913-fp16混合精度>19.1.3 FP16混合精度<a class=anchor href=#1913-fp16%e6%b7%b7%e5%90%88%e7%b2%be%e5%ba%a6>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.cuda.amp</span> <span class=kn>import</span> <span class=n>autocast</span><span class=p>,</span> <span class=n>GradScaler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scaler</span> <span class=o>=</span> <span class=n>GradScaler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>images</span><span class=p>,</span> <span class=n>labels</span> <span class=ow>in</span> <span class=n>dataloader</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>images</span><span class=p>,</span> <span class=n>labels</span> <span class=o>=</span> <span class=n>images</span><span class=o>.</span><span class=n>cuda</span><span class=p>(),</span> <span class=n>labels</span><span class=o>.</span><span class=n>cuda</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=n>autocast</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>images</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>outputs</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>scaler</span><span class=o>.</span><span class=n>scale</span><span class=p>(</span><span class=n>loss</span><span class=p>)</span><span class=o>.</span><span class=n>backward</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>scaler</span><span class=o>.</span><span class=n>step</span><span class=p>(</span><span class=n>optimizer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>scaler</span><span class=o>.</span><span class=n>update</span><span class=p>()</span></span></span></code></pre></div><hr><h2 id=192-剪枝与蒸馏>19.2 剪枝与蒸馏<a class=anchor href=#192-%e5%89%aa%e6%9e%9d%e4%b8%8e%e8%92%b8%e9%a6%8f>#</a></h2><h3 id=1921-模型剪枝>19.2.1 模型剪枝<a class=anchor href=#1921-%e6%a8%a1%e5%9e%8b%e5%89%aa%e6%9e%9d>#</a></h3><p>使用torch-pruning库：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch_pruning</span> <span class=k>as</span> <span class=nn>tp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pruner</span> <span class=o>=</span> <span class=n>tp</span><span class=o>.</span><span class=n>pruner</span><span class=o>.</span><span class=n>MagnitudePruner</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>example_inputs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>pruning_ratio</span><span class=o>=</span><span class=mf>0.5</span>  <span class=c1># 剪枝50%</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pruner</span><span class=o>.</span><span class=n>step</span><span class=p>()</span></span></span></code></pre></div><h3 id=1922-知识蒸馏>19.2.2 知识蒸馏<a class=anchor href=#1922-%e7%9f%a5%e8%af%86%e8%92%b8%e9%a6%8f>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>DistillationLoss</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mf>4.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span> <span class=o>=</span> <span class=n>temperature</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>student_logits</span><span class=p>,</span> <span class=n>teacher_logits</span><span class=p>,</span> <span class=n>labels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>hard_loss</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>cross_entropy</span><span class=p>(</span><span class=n>student_logits</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>soft_loss</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>kl_div</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>F</span><span class=o>.</span><span class=n>log_softmax</span><span class=p>(</span><span class=n>student_logits</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>F</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>teacher_logits</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>temperature</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>reduction</span><span class=o>=</span><span class=s1>&#39;batchmean&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=o>*</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>temperature</span> <span class=o>**</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=n>hard_loss</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>soft_loss</span></span></span></code></pre></div><hr><h2 id=193-tensorrt加速>19.3 TensorRT加速<a class=anchor href=#193-tensorrt%e5%8a%a0%e9%80%9f>#</a></h2><h3 id=1931-onnx转tensorrt>19.3.1 ONNX转TensorRT<a class=anchor href=#1931-onnx%e8%bd%actensorrt>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 步骤1：导出ONNX</span>
</span></span><span class=line><span class=cl><span class=n>torch</span><span class=o>.</span><span class=n>onnx</span><span class=o>.</span><span class=n>export</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>dummy_input</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;model.onnx&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>opset_version</span><span class=o>=</span><span class=mi>17</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：转换TensorRT（见 tensorrt_inference.py）</span>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：推理</span></span></span></code></pre></div><p>完整实现见 <code>code/chapter19_optimization/tensorrt_inference.py</code></p><hr><h2 id=194-实战模型压缩与部署>19.4 实战：模型压缩与部署<a class=anchor href=#194-%e5%ae%9e%e6%88%98%e6%a8%a1%e5%9e%8b%e5%8e%8b%e7%bc%a9%e4%b8%8e%e9%83%a8%e7%bd%b2>#</a></h2><h3 id=优化决策矩阵>优化决策矩阵<a class=anchor href=#%e4%bc%98%e5%8c%96%e5%86%b3%e7%ad%96%e7%9f%a9%e9%98%b5>#</a></h3><table><thead><tr><th>方法</th><th>精度损失</th><th>速度提升</th><th>压缩比</th><th>适用场景</th></tr></thead><tbody><tr><td>FP16</td><td>&lt;0.5%</td><td>1.5-2x</td><td>2x</td><td>云端推理</td></tr><tr><td>INT8 QAT</td><td>1-2%</td><td>3-4x</td><td>4x</td><td>生产部署</td></tr><tr><td>INT8 PTQ</td><td>2-3%</td><td>3-4x</td><td>4x</td><td>边缘设备</td></tr><tr><td>剪枝+量化</td><td>3-5%</td><td>5x+</td><td>10x+</td><td>移动端</td></tr></tbody></table><h2 id=本章小结>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><p>核心技术：</p><ul><li>量化：INT8/FP16，4x加速</li><li>剪枝：减少参数，1.5-2x加速</li><li>蒸馏：用大模型训练小模型</li><li>TensorRT：GPU专用优化，2-10x加速</li></ul><p><strong>下一步</strong>：<a href=../chapter20/README.md>第20章</a> - 生产部署</p><hr><p><strong>代码文件</strong>：</p><ul><li><code>code/chapter19_optimization/model_quantization.py</code> - 完整量化示例</li><li><code>code/chapter19_optimization/tensorrt_inference.py</code> - TensorRT推理实现</li></ul><hr><h1 id=第20章生产部署-1>第20章：生产部署<a class=anchor href=#%e7%ac%ac20%e7%ab%a0%e7%94%9f%e4%ba%a7%e9%83%a8%e7%bd%b2-1>#</a></h1><blockquote class=book-hint><p><strong>服务化部署篇</strong> - 从模型到可用API的完整流程</p></blockquote><h2 id=本章概览-1>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88-1>#</a></h2><p>本章系统讲解如何将训练好的模型部署为生产级服务。包括：</p><ul><li>ONNX跨框架模型转换</li><li>FastAPI构建推理服务</li><li>Triton Inference Server大规模部署</li><li>边缘设备部署方案</li></ul><h2 id=为什么需要服务化部署>为什么需要服务化部署？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e6%9c%8d%e5%8a%a1%e5%8c%96%e9%83%a8%e7%bd%b2>#</a></h2><ol><li><strong>提供API接口</strong> - 让其他系统可以调用模型</li><li><strong>资源管理</strong> - 有效利用GPU/CPU资源</li><li><strong>弹性扩展</strong> - 根据负载自动扩缩容</li><li><strong>版本管理</strong> - 支持多版本模型并行运行</li></ol><hr><h2 id=201-onnx模型转换>20.1 ONNX模型转换<a class=anchor href=#201-onnx%e6%a8%a1%e5%9e%8b%e8%bd%ac%e6%8d%a2>#</a></h2><h3 id=2011-为什么选择onnx>20.1.1 为什么选择ONNX？<a class=anchor href=#2011-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9onnx>#</a></h3><p><strong>ONNX (Open Neural Network Exchange)</strong> 是微软、Facebook等联合开发的开放格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PyTorch模型
</span></span><span class=line><span class=cl>    ↓ 导出
</span></span><span class=line><span class=cl>ONNX格式（通用中间表示）
</span></span><span class=line><span class=cl>    ↓ 部署
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│ ONNX Runtime  TensorRT  OpenVINO │
</span></span><span class=line><span class=cl>│ CoreML       TFLite    DirectML  │
</span></span><span class=line><span class=cl>└───────────────────────────────────┘</span></span></code></pre></div><p><strong>优势</strong>：</p><ul><li>跨框架兼容性</li><li>推理优化成熟</li><li>部署灵活性高</li></ul><h3 id=2012-pytorch转onnx>20.1.2 PyTorch转ONNX<a class=anchor href=#2012-pytorch%e8%bd%aconnx>#</a></h3><p><strong>基本导出</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.onnx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>export_to_onnx</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>save_path</span><span class=p>,</span> <span class=n>input_shape</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;将PyTorch模型导出为ONNX格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建示例输入</span>
</span></span><span class=line><span class=cl>    <span class=n>dummy_input</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=o>*</span><span class=n>input_shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 导出ONNX</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>onnx</span><span class=o>.</span><span class=n>export</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=p>,</span>                          <span class=c1># 模型</span>
</span></span><span class=line><span class=cl>        <span class=n>dummy_input</span><span class=p>,</span>                    <span class=c1># 示例输入</span>
</span></span><span class=line><span class=cl>        <span class=n>save_path</span><span class=p>,</span>                      <span class=c1># 保存路径</span>
</span></span><span class=line><span class=cl>        <span class=n>export_params</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>             <span class=c1># 导出权重</span>
</span></span><span class=line><span class=cl>        <span class=n>opset_version</span><span class=o>=</span><span class=mi>17</span><span class=p>,</span>               <span class=c1># ONNX版本</span>
</span></span><span class=line><span class=cl>        <span class=n>do_constant_folding</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>       <span class=c1># 常量折叠优化</span>
</span></span><span class=line><span class=cl>        <span class=n>input_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;input&#39;</span><span class=p>],</span>          <span class=c1># 输入名称</span>
</span></span><span class=line><span class=cl>        <span class=n>output_names</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;output&#39;</span><span class=p>],</span>        <span class=c1># 输出名称</span>
</span></span><span class=line><span class=cl>        <span class=n>dynamic_axes</span><span class=o>=</span><span class=p>{</span>                  <span class=c1># 动态维度</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;input&#39;</span><span class=p>:</span> <span class=p>{</span><span class=mi>0</span><span class=p>:</span> <span class=s1>&#39;batch_size&#39;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;output&#39;</span><span class=p>:</span> <span class=p>{</span><span class=mi>0</span><span class=p>:</span> <span class=s1>&#39;batch_size&#39;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;模型已导出到: </span><span class=si>{</span><span class=n>save_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torchvision.models</span> <span class=kn>import</span> <span class=n>resnet50</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>resnet50</span><span class=p>(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>export_to_onnx</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=s2>&#34;resnet50.onnx&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>YOLOv8导出</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 导出ONNX（一行代码）</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>export</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s2>&#34;onnx&#34;</span><span class=p>,</span> <span class=n>opset</span><span class=o>=</span><span class=mi>17</span><span class=p>,</span> <span class=n>simplify</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>dynamic</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span></span></span></code></pre></div><h3 id=2013-模型验证与简化>20.1.3 模型验证与简化<a class=anchor href=#2013-%e6%a8%a1%e5%9e%8b%e9%aa%8c%e8%af%81%e4%b8%8e%e7%ae%80%e5%8c%96>#</a></h3><p><strong>验证ONNX模型</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>onnx</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>onnxruntime</span> <span class=k>as</span> <span class=nn>ort</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>verify_onnx_model</span><span class=p>(</span><span class=n>onnx_path</span><span class=p>,</span> <span class=n>test_input</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;验证ONNX模型正确性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 检查模型结构</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>onnx</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>onnx_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>onnx</span><span class=o>.</span><span class=n>checker</span><span class=o>.</span><span class=n>check_model</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✓ 模型结构验证通过&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 推理测试</span>
</span></span><span class=line><span class=cl>    <span class=n>session</span> <span class=o>=</span> <span class=n>ort</span><span class=o>.</span><span class=n>InferenceSession</span><span class=p>(</span><span class=n>onnx_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>input_name</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get_inputs</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=p>{</span><span class=n>input_name</span><span class=p>:</span> <span class=n>test_input</span><span class=p>})[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✓ 推理测试通过，输出形状: </span><span class=si>{</span><span class=n>output</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>test_input</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>verify_onnx_model</span><span class=p>(</span><span class=s2>&#34;resnet50.onnx&#34;</span><span class=p>,</span> <span class=n>test_input</span><span class=p>)</span></span></span></code></pre></div><p><strong>模型简化（去除冗余节点）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>onnx</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>onnxsim</span> <span class=kn>import</span> <span class=n>simplify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>simplify_onnx</span><span class=p>(</span><span class=n>input_path</span><span class=p>,</span> <span class=n>output_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;简化ONNX模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>onnx</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>input_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 简化</span>
</span></span><span class=line><span class=cl>    <span class=n>model_simplified</span><span class=p>,</span> <span class=n>check</span> <span class=o>=</span> <span class=n>simplify</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>check</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>onnx</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>model_simplified</span><span class=p>,</span> <span class=n>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 打印对比</span>
</span></span><span class=line><span class=cl>        <span class=n>original_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>input_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>simplified_size</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>getsize</span><span class=p>(</span><span class=n>output_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始大小: </span><span class=si>{</span><span class=n>original_size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> MB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;简化后: </span><span class=si>{</span><span class=n>simplified_size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> MB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;减少: </span><span class=si>{</span><span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>simplified_size</span><span class=o>/</span><span class=n>original_size</span><span class=p>)</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;简化失败，保持原模型&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>simplify_onnx</span><span class=p>(</span><span class=s2>&#34;model.onnx&#34;</span><span class=p>,</span> <span class=s2>&#34;model_simplified.onnx&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=202-服务化部署>20.2 服务化部署<a class=anchor href=#202-%e6%9c%8d%e5%8a%a1%e5%8c%96%e9%83%a8%e7%bd%b2>#</a></h2><h3 id=2021-fastapi构建推理服务>20.2.1 FastAPI构建推理服务<a class=anchor href=#2021-fastapi%e6%9e%84%e5%bb%ba%e6%8e%a8%e7%90%86%e6%9c%8d%e5%8a%a1>#</a></h3><p><strong>完整的推理服务示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>File</span><span class=p>,</span> <span class=n>UploadFile</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>onnxruntime</span> <span class=k>as</span> <span class=nn>ort</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>io</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span><span class=n>title</span><span class=o>=</span><span class=s2>&#34;CV推理服务&#34;</span><span class=p>,</span> <span class=n>version</span><span class=o>=</span><span class=s2>&#34;1.0.0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 全局模型会话</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 配置GPU加速</span>
</span></span><span class=line><span class=cl>        <span class=n>providers</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;CUDAExecutionProvider&#39;</span><span class=p>,</span> <span class=s1>&#39;CPUExecutionProvider&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>session</span> <span class=o>=</span> <span class=n>ort</span><span class=o>.</span><span class=n>InferenceSession</span><span class=p>(</span><span class=n>model_path</span><span class=p>,</span> <span class=n>providers</span><span class=o>=</span><span class=n>providers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>input_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>get_inputs</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>get_outputs</span><span class=p>()[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>preprocess</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image</span><span class=p>:</span> <span class=n>Image</span><span class=o>.</span><span class=n>Image</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;图像预处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>image</span><span class=o>.</span><span class=n>resize</span><span class=p>((</span><span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>image</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>image</span> <span class=o>/</span> <span class=mf>255.0</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=p>(</span><span class=n>image</span> <span class=o>-</span> <span class=p>[</span><span class=mf>0.485</span><span class=p>,</span> <span class=mf>0.456</span><span class=p>,</span> <span class=mf>0.406</span><span class=p>])</span> <span class=o>/</span> <span class=p>[</span><span class=mf>0.229</span><span class=p>,</span> <span class=mf>0.224</span><span class=p>,</span> <span class=mf>0.225</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>image</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;推理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>run</span><span class=p>([</span><span class=bp>self</span><span class=o>.</span><span class=n>output_name</span><span class=p>],</span> <span class=p>{</span><span class=bp>self</span><span class=o>.</span><span class=n>input_name</span><span class=p>:</span> <span class=n>image</span><span class=p>})[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ModelManager</span><span class=p>(</span><span class=s2>&#34;resnet50.onnx&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 响应模型</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PredictionResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>class_id</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_ms</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/health&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>health_check</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;健康检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;healthy&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/predict&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>PredictionResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>file</span><span class=p>:</span> <span class=n>UploadFile</span> <span class=o>=</span> <span class=n>File</span><span class=p>(</span><span class=o>...</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;图像分类推理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 验证文件类型</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>file</span><span class=o>.</span><span class=n>content_type</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;image/&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=s2>&#34;请上传图片文件&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 读取图片</span>
</span></span><span class=line><span class=cl>        <span class=n>contents</span> <span class=o>=</span> <span class=k>await</span> <span class=n>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>BytesIO</span><span class=p>(</span><span class=n>contents</span><span class=p>))</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=s2>&#34;RGB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 预处理</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tensor</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>preprocess</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 推理计时</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>input_tensor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span> <span class=o>=</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 后处理</span>
</span></span><span class=line><span class=cl>        <span class=n>probs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>output</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>  <span class=c1># softmax</span>
</span></span><span class=line><span class=cl>        <span class=n>class_id</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>probs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>confidence</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>probs</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=n>class_id</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>PredictionResponse</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>class_id</span><span class=o>=</span><span class=n>class_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence</span><span class=o>=</span><span class=n>confidence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_ms</span><span class=o>=</span><span class=nb>round</span><span class=p>(</span><span class=n>latency</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>HTTPException</span><span class=p>(</span><span class=mi>500</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;推理失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行: uvicorn main:app --host 0.0.0.0 --port 8000</span></span></span></code></pre></div><p><strong>性能优化版本（批处理 + 异步）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>asyncio</span> <span class=kn>import</span> <span class=n>Queue</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BatchInferenceService</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;批处理推理服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span> <span class=n>max_wait</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>ModelManager</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_wait</span> <span class=o>=</span> <span class=n>max_wait</span>  <span class=c1># 最大等待时间(秒)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=p>:</span> <span class=n>Queue</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>running</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;启动批处理循环&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_batch_loop</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_batch_loop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批处理主循环&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>running</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>futures</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 收集请求</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 等待第一个请求</span>
</span></span><span class=line><span class=cl>                <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>(),</span> <span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>batch</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=n>futures</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 收集更多请求（带超时）</span>
</span></span><span class=line><span class=cl>                <span class=n>deadline</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_wait</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=ow>and</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>&lt;</span> <span class=n>deadline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                            <span class=n>timeout</span><span class=o>=</span><span class=n>deadline</span> <span class=o>-</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=n>batch</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=n>futures</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 批量推理</span>
</span></span><span class=line><span class=cl>                <span class=n>inputs</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>batch</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>outputs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 分发结果</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>future</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>futures</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>future</span><span class=o>.</span><span class=n>set_result</span><span class=p>(</span><span class=n>outputs</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_tensor</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加到批处理队列&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>future</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>create_future</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>put</span><span class=p>((</span><span class=n>input_tensor</span><span class=p>,</span> <span class=n>future</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>future</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用批处理服务</span>
</span></span><span class=line><span class=cl><span class=n>batch_service</span> <span class=o>=</span> <span class=n>BatchInferenceService</span><span class=p>(</span><span class=s2>&#34;model.onnx&#34;</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.on_event</span><span class=p>(</span><span class=s2>&#34;startup&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>startup</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>batch_service</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/predict_batch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>predict_batch</span><span class=p>(</span><span class=n>file</span><span class=p>:</span> <span class=n>UploadFile</span> <span class=o>=</span> <span class=n>File</span><span class=p>(</span><span class=o>...</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 预处理 ...</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=k>await</span> <span class=n>batch_service</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>input_tensor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 后处理 ...</span></span></span></code></pre></div><h3 id=2022-triton-inference-server>20.2.2 Triton Inference Server<a class=anchor href=#2022-triton-inference-server>#</a></h3><p><strong>Triton简介</strong>：</p><p>NVIDIA Triton是生产级推理服务器，支持：</p><ul><li>多模型、多框架（PyTorch、TensorFlow、ONNX、TensorRT）</li><li>动态批处理</li><li>GPU多实例</li><li>模型版本管理</li></ul><p><strong>模型仓库结构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>model_repository/
</span></span><span class=line><span class=cl>├── yolov8/
</span></span><span class=line><span class=cl>│   ├── config.pbtxt
</span></span><span class=line><span class=cl>│   └── 1/
</span></span><span class=line><span class=cl>│       └── model.onnx
</span></span><span class=line><span class=cl>├── resnet50/
</span></span><span class=line><span class=cl>│   ├── config.pbtxt
</span></span><span class=line><span class=cl>│   └── 1/
</span></span><span class=line><span class=cl>│       └── model.plan  # TensorRT格式</span></span></code></pre></div><p><strong>模型配置（config.pbtxt）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=n>name</span><span class=o>:</span> <span class=s>&#34;yolov8&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>platform</span><span class=o>:</span> <span class=s>&#34;onnxruntime_onnx&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>max_batch_size</span><span class=o>:</span> <span class=mi>8</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>input</span> <span class=p>[</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>:</span> <span class=s>&#34;images&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>data_type</span><span class=o>:</span> <span class=n>TYPE_FP32</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>dims</span><span class=o>:</span> <span class=p>[</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>640</span><span class=p>,</span> <span class=mi>640</span> <span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>output</span> <span class=p>[</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>:</span> <span class=s>&#34;output0&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>data_type</span><span class=o>:</span> <span class=n>TYPE_FP32</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>dims</span><span class=o>:</span> <span class=p>[</span> <span class=mi>84</span><span class=p>,</span> <span class=mi>8400</span> <span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>instance_group</span> <span class=p>[</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>count</span><span class=o>:</span> <span class=mi>2</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>kind</span><span class=o>:</span> <span class=n>KIND_GPU</span><span class=err>
</span></span></span><span class=line><span class=cl>    <span class=n>gpus</span><span class=o>:</span> <span class=p>[</span> <span class=mi>0</span> <span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=n>dynamic_batching</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=n>preferred_batch_size</span><span class=o>:</span> <span class=p>[</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>8</span> <span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl>  <span class=n>max_queue_delay_microseconds</span><span class=o>:</span> <span class=mi>50000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>启动Triton服务器</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 使用Docker启动</span>
</span></span><span class=line><span class=cl>docker run --gpus all --rm -p 8000:8000 -p 8001:8001 -p 8002:8002 <span class=se>\
</span></span></span><span class=line><span class=cl>  -v <span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/model_repository:/models <span class=se>\
</span></span></span><span class=line><span class=cl>  nvcr.io/nvidia/tritonserver:24.05-py3 <span class=se>\
</span></span></span><span class=line><span class=cl>  tritonserver --model-repository<span class=o>=</span>/models</span></span></code></pre></div><p><strong>Python客户端调用</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tritonclient.grpc</span> <span class=k>as</span> <span class=nn>grpcclient</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>triton_inference</span><span class=p>(</span><span class=n>image</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;调用Triton推理服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>grpcclient</span><span class=o>.</span><span class=n>InferenceServerClient</span><span class=p>(</span><span class=n>url</span><span class=o>=</span><span class=s2>&#34;localhost:8001&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 准备输入</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>grpcclient</span><span class=o>.</span><span class=n>InferInput</span><span class=p>(</span><span class=s2>&#34;images&#34;</span><span class=p>,</span> <span class=n>image</span><span class=o>.</span><span class=n>shape</span><span class=p>,</span> <span class=s2>&#34;FP32&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>set_data_from_numpy</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 准备输出</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>grpcclient</span><span class=o>.</span><span class=n>InferRequestedOutput</span><span class=p>(</span><span class=s2>&#34;output0&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 推理</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>infer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model_name</span><span class=o>=</span><span class=s2>&#34;yolov8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>=</span><span class=n>inputs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span><span class=o>=</span><span class=n>outputs</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>as_numpy</span><span class=p>(</span><span class=s2>&#34;output0&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=2023-docker容器化>20.2.3 Docker容器化<a class=anchor href=#2023-docker%e5%ae%b9%e5%99%a8%e5%8c%96>#</a></h3><p><strong>Dockerfile示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>python:3.11-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 安装依赖</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 复制代码和模型</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> app.py .<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> models/ ./models/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 暴露端口</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>EXPOSE</span><span class=w> </span><span class=s>8000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 健康检查</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>HEALTHCHECK</span> --interval<span class=o>=</span>30s --timeout<span class=o>=</span>10s --start-period<span class=o>=</span>5s --retries<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  CMD curl -f http://localhost:8000/health <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 启动命令</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;uvicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;app:app&#34;</span><span class=p>,</span> <span class=s2>&#34;--host&#34;</span><span class=p>,</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=s2>&#34;--port&#34;</span><span class=p>,</span> <span class=s2>&#34;8000&#34;</span><span class=p>,</span> <span class=s2>&#34;--workers&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>]</span></span></span></code></pre></div><p><strong>docker-compose.yml（含GPU支持）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>inference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8000:8000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>reservations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>devices</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>nvidia</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>count</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>capabilities</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>gpu]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>CUDA_VISIBLE_DEVICES=0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./models:/app/models</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;80:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./nginx.conf:/etc/nginx/nginx.conf:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>inference</span></span></span></code></pre></div><hr><h2 id=203-边缘设备部署>20.3 边缘设备部署<a class=anchor href=#203-%e8%be%b9%e7%bc%98%e8%ae%be%e5%a4%87%e9%83%a8%e7%bd%b2>#</a></h2><h3 id=2031-移动端部署>20.3.1 移动端部署<a class=anchor href=#2031-%e7%a7%bb%e5%8a%a8%e7%ab%af%e9%83%a8%e7%bd%b2>#</a></h3><p><strong>iOS部署（CoreML）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>coremltools</span> <span class=k>as</span> <span class=nn>ct</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># PyTorch转CoreML</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert_to_coreml</span><span class=p>(</span><span class=n>pytorch_model</span><span class=p>,</span> <span class=n>save_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;转换为CoreML格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 转为TorchScript</span>
</span></span><span class=line><span class=cl>    <span class=n>traced_model</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>jit</span><span class=o>.</span><span class=n>trace</span><span class=p>(</span><span class=n>pytorch_model</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>randn</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 转换</span>
</span></span><span class=line><span class=cl>    <span class=n>mlmodel</span> <span class=o>=</span> <span class=n>ct</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>traced_model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>=</span><span class=p>[</span><span class=n>ct</span><span class=o>.</span><span class=n>ImageType</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;input&#34;</span><span class=p>,</span> <span class=n>shape</span><span class=o>=</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>224</span><span class=p>,</span> <span class=mi>224</span><span class=p>))],</span>
</span></span><span class=line><span class=cl>        <span class=n>minimum_deployment_target</span><span class=o>=</span><span class=n>ct</span><span class=o>.</span><span class=n>target</span><span class=o>.</span><span class=n>iOS15</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>mlmodel</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=n>save_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;CoreML模型已保存: </span><span class=si>{</span><span class=n>save_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>Android部署（TFLite）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>convert_to_tflite</span><span class=p>(</span><span class=n>saved_model_dir</span><span class=p>,</span> <span class=n>output_path</span><span class=p>,</span> <span class=n>quantize</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;转换为TFLite格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>converter</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>lite</span><span class=o>.</span><span class=n>TFLiteConverter</span><span class=o>.</span><span class=n>from_saved_model</span><span class=p>(</span><span class=n>saved_model_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>quantize</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>converter</span><span class=o>.</span><span class=n>optimizations</span> <span class=o>=</span> <span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>lite</span><span class=o>.</span><span class=n>Optimize</span><span class=o>.</span><span class=n>DEFAULT</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>converter</span><span class=o>.</span><span class=n>target_spec</span><span class=o>.</span><span class=n>supported_types</span> <span class=o>=</span> <span class=p>[</span><span class=n>tf</span><span class=o>.</span><span class=n>float16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tflite_model</span> <span class=o>=</span> <span class=n>converter</span><span class=o>.</span><span class=n>convert</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>output_path</span><span class=p>,</span> <span class=s1>&#39;wb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>f</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>tflite_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;TFLite模型大小: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>tflite_model</span><span class=p>)</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> MB&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=2032-jetson嵌入式设备>20.3.2 Jetson嵌入式设备<a class=anchor href=#2032-jetson%e5%b5%8c%e5%85%a5%e5%bc%8f%e8%ae%be%e5%a4%87>#</a></h3><p><strong>Jetson设备对比</strong>：</p><table><thead><tr><th>设备</th><th>GPU</th><th>内存</th><th>算力</th><th>功耗</th><th>价格</th></tr></thead><tbody><tr><td>Jetson Nano</td><td>Maxwell 128核</td><td>4GB</td><td>472 GFLOPS</td><td>5-10W</td><td>$149</td></tr><tr><td>Jetson Orin Nano</td><td>Ampere 1024核</td><td>8GB</td><td>40 TOPS</td><td>7-15W</td><td>$299</td></tr><tr><td>Jetson Orin NX</td><td>Ampere 1024核</td><td>16GB</td><td>100 TOPS</td><td>10-25W</td><td>$599</td></tr></tbody></table><p><strong>在Jetson上部署YOLOv8</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 导出TensorRT引擎（在Jetson上执行）</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>export</span><span class=p>(</span><span class=nb>format</span><span class=o>=</span><span class=s2>&#34;engine&#34;</span><span class=p>,</span> <span class=n>device</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>half</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># FP16</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 推理</span>
</span></span><span class=line><span class=cl><span class=n>engine_model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.engine&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>engine_model</span><span class=p>(</span><span class=s2>&#34;image.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 性能对比（Jetson Orin Nano）</span>
</span></span><span class=line><span class=cl><span class=c1># yolov8n.pt:     ~25 FPS</span>
</span></span><span class=line><span class=cl><span class=c1># yolov8n.engine: ~80 FPS (FP16)</span></span></span></code></pre></div><h3 id=2033-onnx-runtime-mobile>20.3.3 ONNX Runtime Mobile<a class=anchor href=#2033-onnx-runtime-mobile>#</a></h3><p><strong>轻量级部署方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>onnxruntime</span> <span class=k>as</span> <span class=nn>ort</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_mobile_session</span><span class=p>(</span><span class=n>model_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建移动端优化的推理会话&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span> <span class=o>=</span> <span class=n>ort</span><span class=o>.</span><span class=n>SessionOptions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 优化设置</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>graph_optimization_level</span> <span class=o>=</span> <span class=n>ort</span><span class=o>.</span><span class=n>GraphOptimizationLevel</span><span class=o>.</span><span class=n>ORT_ENABLE_ALL</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>intra_op_num_threads</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>    <span class=n>options</span><span class=o>.</span><span class=n>inter_op_num_threads</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 使用NNAPI（Android）或CoreML（iOS）</span>
</span></span><span class=line><span class=cl>    <span class=n>providers</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;NnapiExecutionProvider&#39;</span><span class=p>,</span> <span class=s1>&#39;CoreMLExecutionProvider&#39;</span><span class=p>,</span> <span class=s1>&#39;CPUExecutionProvider&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ort</span><span class=o>.</span><span class=n>InferenceSession</span><span class=p>(</span><span class=n>model_path</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>providers</span><span class=o>=</span><span class=n>providers</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=204-实战构建生产级服务>20.4 实战：构建生产级服务<a class=anchor href=#204-%e5%ae%9e%e6%88%98%e6%9e%84%e5%bb%ba%e7%94%9f%e4%ba%a7%e7%ba%a7%e6%9c%8d%e5%8a%a1>#</a></h2><h3 id=完整架构示例>完整架构示例<a class=anchor href=#%e5%ae%8c%e6%95%b4%e6%9e%b6%e6%9e%84%e7%a4%ba%e4%be%8b>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                       负载均衡器                          │
</span></span><span class=line><span class=cl>│                    (Nginx/Traefik)                      │
</span></span><span class=line><span class=cl>└─────────────────────────┬───────────────────────────────┘
</span></span><span class=line><span class=cl>                          │
</span></span><span class=line><span class=cl>        ┌─────────────────┼─────────────────┐
</span></span><span class=line><span class=cl>        ↓                 ↓                 ↓
</span></span><span class=line><span class=cl>┌───────────────┐ ┌───────────────┐ ┌───────────────┐
</span></span><span class=line><span class=cl>│   推理服务1    │ │   推理服务2    │ │   推理服务3    │
</span></span><span class=line><span class=cl>│  (GPU 0)      │ │  (GPU 1)      │ │  (GPU 2)      │
</span></span><span class=line><span class=cl>└───────────────┘ └───────────────┘ └───────────────┘
</span></span><span class=line><span class=cl>        │                 │                 │
</span></span><span class=line><span class=cl>        └────────┬────────┴────────┬────────┘
</span></span><span class=line><span class=cl>                 ↓                 ↓
</span></span><span class=line><span class=cl>        ┌───────────────┐  ┌───────────────┐
</span></span><span class=line><span class=cl>        │    Redis      │  │   监控系统     │
</span></span><span class=line><span class=cl>        │  (结果缓存)    │  │(Prometheus)   │
</span></span><span class=line><span class=cl>        └───────────────┘  └───────────────┘</span></span></code></pre></div><h3 id=api设计规范>API设计规范<a class=anchor href=#api%e8%ae%be%e8%ae%a1%e8%a7%84%e8%8c%83>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span><span class=p>,</span> <span class=n>HTTPException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=o>=</span><span class=s2>&#34;视觉AI服务&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>version</span><span class=o>=</span><span class=s2>&#34;2.0.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;生产级计算机视觉推理API&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 数据模型 ===</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BoundingBox</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>x1</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;左上角x坐标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>y1</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;左上角y坐标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x2</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;右下角x坐标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>y2</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;右下角y坐标&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Detection</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>class_name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bbox</span><span class=p>:</span> <span class=n>BoundingBox</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DetectionResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>request_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>detections</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Detection</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>inference_time_ms</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>image_size</span><span class=p>:</span> <span class=nb>tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># === 端点 ===</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/v2/detect&#34;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>DetectionResponse</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>detect_objects</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>file</span><span class=p>:</span> <span class=n>UploadFile</span> <span class=o>=</span> <span class=n>File</span><span class=p>(</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence_threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_detections</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    目标检测API
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    - **file**: 待检测图片
</span></span></span><span class=line><span class=cl><span class=s2>    - **confidence_threshold**: 置信度阈值 (0-1)
</span></span></span><span class=line><span class=cl><span class=s2>    - **max_detections**: 最大检测数量
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 实现 ...</span></span></span></code></pre></div><h3 id=监控指标>监控指标<a class=anchor href=#%e7%9b%91%e6%8e%a7%e6%8c%87%e6%a0%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span><span class=p>,</span> <span class=n>generate_latest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>Response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义指标</span>
</span></span><span class=line><span class=cl><span class=n>REQUEST_COUNT</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;inference_requests_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total inference requests&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INFERENCE_LATENCY</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;inference_latency_seconds&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Inference latency&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>buckets</span><span class=o>=</span><span class=p>[</span><span class=mf>0.01</span><span class=p>,</span> <span class=mf>0.025</span><span class=p>,</span> <span class=mf>0.05</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.25</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>GPU_UTILIZATION</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;gpu_utilization_percent&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;GPU utilization&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;gpu_id&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在推理中记录</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/predict&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>file</span><span class=p>:</span> <span class=n>UploadFile</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>REQUEST_COUNT</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s1>&#39;yolov8&#39;</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s1>&#39;success&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>REQUEST_COUNT</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s1>&#39;yolov8&#39;</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s1>&#39;error&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>INFERENCE_LATENCY</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s1>&#39;yolov8&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>observe</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 暴露指标端点</span>
</span></span><span class=line><span class=cl><span class=nd>@app.get</span><span class=p>(</span><span class=s2>&#34;/metrics&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>metrics</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>Response</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=n>generate_latest</span><span class=p>(),</span> <span class=n>media_type</span><span class=o>=</span><span class=s2>&#34;text/plain&#34;</span><span class=p>)</span></span></span></code></pre></div><h2 id=本章小结-1>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1>#</a></h2><h3 id=核心要点>核心要点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9>#</a></h3><ol><li><strong>ONNX转换</strong>：通用格式，跨框架部署</li><li><strong>FastAPI服务</strong>：轻量、高性能、易扩展</li><li><strong>Triton Server</strong>：生产级、多模型、动态批处理</li><li><strong>边缘部署</strong>：CoreML/TFLite/TensorRT</li><li><strong>容器化</strong>：Docker + GPU支持</li><li><strong>监控</strong>：Prometheus指标收集</li></ol><h3 id=部署决策树>部署决策树<a class=anchor href=#%e9%83%a8%e7%bd%b2%e5%86%b3%e7%ad%96%e6%a0%91>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>需要部署模型?
</span></span><span class=line><span class=cl>    │
</span></span><span class=line><span class=cl>    ├─ 云端服务 ─→ 高并发? ─→ 是 ─→ Triton Server
</span></span><span class=line><span class=cl>    │                      └─ 否 ─→ FastAPI + ONNX Runtime
</span></span><span class=line><span class=cl>    │
</span></span><span class=line><span class=cl>    ├─ 边缘设备 ─→ NVIDIA硬件? ─→ 是 ─→ TensorRT
</span></span><span class=line><span class=cl>    │                          └─ 否 ─→ ONNX Runtime
</span></span><span class=line><span class=cl>    │
</span></span><span class=line><span class=cl>    └─ 移动端 ─→ iOS? ─→ CoreML
</span></span><span class=line><span class=cl>               └─ Android? ─→ TFLite/NNAPI</span></span></code></pre></div><p><strong>下一步</strong>：<a href=../chapter21/README.md>第21章</a> - MLOps与最佳实践</p><hr><p><strong>代码文件</strong>：</p><ul><li><code>code/chapter20_deployment/fastapi_service.py</code> - FastAPI推理服务</li><li><code>code/chapter20_deployment/triton_client.py</code> - Triton客户端示例</li><li><code>code/chapter20_deployment/docker/</code> - Docker部署配置</li></ul><hr><h1 id=第21章mlops与最佳实践-1>第21章：MLOps与最佳实践<a class=anchor href=#%e7%ac%ac21%e7%ab%a0mlops%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5-1>#</a></h1><blockquote class=book-hint><p><strong>工程化规范篇</strong> - 建立可持续的机器学习开发流程</p></blockquote><h2 id=本章概览-2>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88-2>#</a></h2><p>MLOps是机器学习和DevOps的结合，旨在建立可靠、可复现的ML系统。本章内容：</p><ul><li>数据管理与版本控制</li><li>实验跟踪与超参数优化</li><li>模型监控与A/B测试</li><li>工程化最佳实践清单</li></ul><h2 id=为什么需要mlops>为什么需要MLOps？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81mlops>#</a></h2><p>传统ML开发的问题：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>研究环境:                生产环境:
</span></span><span class=line><span class=cl>├── notebooks/           ├── 模型性能下降
</span></span><span class=line><span class=cl>│   ├── exp1.ipynb      ├── 无法复现结果
</span></span><span class=line><span class=cl>│   ├── exp2.ipynb      ├── 数据漂移
</span></span><span class=line><span class=cl>│   └── final_v3.ipynb  └── 版本混乱
</span></span><span class=line><span class=cl>└── &#34;这个版本是哪个?&#34;</span></span></code></pre></div><p>MLOps解决方案：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌──────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                    MLOps流水线                        │
</span></span><span class=line><span class=cl>├──────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│  数据 → 训练 → 评估 → 部署 → 监控 → 反馈 → 数据...   │
</span></span><span class=line><span class=cl>│   ↓      ↓      ↓      ↓      ↓      ↓              │
</span></span><span class=line><span class=cl>│  DVC   W&amp;B   测试    CI/CD  监控   A/B              │
</span></span><span class=line><span class=cl>└──────────────────────────────────────────────────────┘</span></span></code></pre></div><hr><h2 id=211-数据管理与标注>21.1 数据管理与标注<a class=anchor href=#211-%e6%95%b0%e6%8d%ae%e7%ae%a1%e7%90%86%e4%b8%8e%e6%a0%87%e6%b3%a8>#</a></h2><h3 id=2111-数据版本控制dvc>21.1.1 数据版本控制（DVC）<a class=anchor href=#2111-%e6%95%b0%e6%8d%ae%e7%89%88%e6%9c%ac%e6%8e%a7%e5%88%b6dvc>#</a></h3><p><strong>DVC (Data Version Control)</strong> 像Git一样管理数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装</span>
</span></span><span class=line><span class=cl>pip install dvc dvc-s3  <span class=c1># 或 dvc-gs, dvc-azure</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化</span>
</span></span><span class=line><span class=cl>dvc init
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 跟踪数据目录</span>
</span></span><span class=line><span class=cl>dvc add data/images
</span></span><span class=line><span class=cl>git add data/images.dvc .gitignore
</span></span><span class=line><span class=cl>git commit -m <span class=s2>&#34;Add training images&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推送到远程存储</span>
</span></span><span class=line><span class=cl>dvc remote add -d myremote s3://my-bucket/dvc
</span></span><span class=line><span class=cl>dvc push
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他人拉取数据</span>
</span></span><span class=line><span class=cl>git clone https://github.com/...
</span></span><span class=line><span class=cl>dvc pull</span></span></code></pre></div><p><strong>DVC Pipeline</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># dvc.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>stages</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>preprocess</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=l>python src/preprocess.py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>data/raw</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>src/preprocess.py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>data/processed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>train</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cmd</span><span class=p>:</span><span class=w> </span><span class=l>python src/train.py --epochs 100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>data/processed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>src/train.py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>train.epochs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>train.lr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>outs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>models/model.pt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>metrics.json</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cache</span><span class=p>:</span><span class=w> </span><span class=kc>false</span></span></span></code></pre></div><p>运行流水线：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dvc repro  <span class=c1># 自动执行有变更的阶段</span>
</span></span><span class=line><span class=cl>dvc metrics show  <span class=c1># 查看指标</span></span></span></code></pre></div><h3 id=2112-标注工具选型>21.1.2 标注工具选型<a class=anchor href=#2112-%e6%a0%87%e6%b3%a8%e5%b7%a5%e5%85%b7%e9%80%89%e5%9e%8b>#</a></h3><table><thead><tr><th>工具</th><th>类型</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Label Studio</strong></td><td>开源</td><td>功能全面、可自部署</td><td>中小团队</td></tr><tr><td><strong>CVAT</strong></td><td>开源</td><td>专注CV、支持视频</td><td>视觉标注</td></tr><tr><td><strong>Roboflow</strong></td><td>SaaS</td><td>自动化、模型辅助</td><td>快速迭代</td></tr><tr><td><strong>Labelbox</strong></td><td>企业级</td><td>工作流管理</td><td>大型团队</td></tr></tbody></table><p><strong>Label Studio快速开始</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装</span>
</span></span><span class=line><span class=cl>pip install label-studio
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动</span>
</span></span><span class=line><span class=cl>label-studio start
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 访问 http://localhost:8080</span></span></span></code></pre></div><h3 id=2113-数据质量管理>21.1.3 数据质量管理<a class=anchor href=#2113-%e6%95%b0%e6%8d%ae%e8%b4%a8%e9%87%8f%e7%ae%a1%e7%90%86>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataQualityChecker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据质量检查器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dir</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>data_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_images</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查图像完整性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>issues</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>img_path</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;**/*.jpg&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>img</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>img_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>img</span><span class=o>.</span><span class=n>verify</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 检查尺寸</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>min</span><span class=p>(</span><span class=n>img</span><span class=o>.</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>32</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;图片太小: </span><span class=si>{</span><span class=n>img_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;损坏文件: </span><span class=si>{</span><span class=n>img_path</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>issues</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_labels</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>labels_file</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查标签质量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=n>labels_file</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>issues</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缺失值</span>
</span></span><span class=line><span class=cl>        <span class=n>missing</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>isnull</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>missing</span><span class=o>.</span><span class=n>any</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缺失值: </span><span class=si>{</span><span class=n>missing</span><span class=p>[</span><span class=n>missing</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查类别分布</span>
</span></span><span class=line><span class=cl>        <span class=n>class_counts</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;label&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>value_counts</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>imbalance</span> <span class=o>=</span> <span class=n>class_counts</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>/</span> <span class=n>class_counts</span><span class=o>.</span><span class=n>min</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>imbalance</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>issues</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;类别不平衡严重: </span><span class=si>{</span><span class=n>imbalance</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>x&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>issues</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_report</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成数据质量报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>image_issues</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_images</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>label_issues</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_labels</span><span class=p>(</span><span class=s2>&#34;labels.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_images&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;**/*.jpg&#34;</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;image_issues&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>image_issues</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;label_issues&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>label_issues</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;images&#34;</span><span class=p>:</span> <span class=n>image_issues</span><span class=p>[:</span><span class=mi>10</span><span class=p>],</span>  <span class=c1># 前10个问题</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;labels&#34;</span><span class=p>:</span> <span class=n>label_issues</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>report</span></span></span></code></pre></div><hr><h2 id=212-实验跟踪>21.2 实验跟踪<a class=anchor href=#212-%e5%ae%9e%e9%aa%8c%e8%b7%9f%e8%b8%aa>#</a></h2><h3 id=2121-weights--biases集成>21.2.1 Weights & Biases集成<a class=anchor href=#2121-weights--biases%e9%9b%86%e6%88%90>#</a></h3><p><strong>初始化</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>wandb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 登录（首次需要API key）</span>
</span></span><span class=line><span class=cl><span class=n>wandb</span><span class=o>.</span><span class=n>login</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化实验</span>
</span></span><span class=line><span class=cl><span class=n>wandb</span><span class=o>.</span><span class=n>init</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>project</span><span class=o>=</span><span class=s2>&#34;yolov8-detection&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;exp-001-baseline&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;yolov8n&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;epochs&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;batch_size&#34;</span><span class=p>:</span> <span class=mi>16</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lr&#34;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;optimizer&#34;</span><span class=p>:</span> <span class=s2>&#34;SGD&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;augmentation&#34;</span><span class=p>:</span> <span class=s2>&#34;mosaic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>训练过程记录</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>wandb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>train_with_wandb</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化</span>
</span></span><span class=line><span class=cl>    <span class=n>wandb</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>project</span><span class=o>=</span><span class=s2>&#34;yolov8-detection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 训练</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 训练循环中记录指标</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>epoch</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>wandb</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>epochs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 训练...</span>
</span></span><span class=line><span class=cl>        <span class=n>train_loss</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>        <span class=n>val_map</span> <span class=o>=</span> <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录指标</span>
</span></span><span class=line><span class=cl>        <span class=n>wandb</span><span class=o>.</span><span class=n>log</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;epoch&#34;</span><span class=p>:</span> <span class=n>epoch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;train/loss&#34;</span><span class=p>:</span> <span class=n>train_loss</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;val/mAP50&#34;</span><span class=p>:</span> <span class=n>val_map</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;lr&#34;</span><span class=p>:</span> <span class=n>optimizer</span><span class=o>.</span><span class=n>param_groups</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=s1>&#39;lr&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录样本预测（每10个epoch）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>epoch</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>predictions</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>val_images</span><span class=p>[:</span><span class=mi>5</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>wandb</span><span class=o>.</span><span class=n>log</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;predictions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>wandb</span><span class=o>.</span><span class=n>Image</span><span class=p>(</span><span class=n>img</span><span class=p>,</span> <span class=n>caption</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Epoch </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>img</span> <span class=ow>in</span> <span class=n>predictions</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 保存最佳模型</span>
</span></span><span class=line><span class=cl>    <span class=n>wandb</span><span class=o>.</span><span class=n>save</span><span class=p>(</span><span class=s2>&#34;best.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>wandb</span><span class=o>.</span><span class=n>finish</span><span class=p>()</span></span></span></code></pre></div><p><strong>YOLOv8原生集成</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自动集成W&amp;B</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;coco128.yaml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>epochs</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>project</span><span class=o>=</span><span class=s2>&#34;yolov8-wandb&#34;</span>  <span class=c1># 自动上传到W&amp;B</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h3 id=2122-超参数优化>21.2.2 超参数优化<a class=anchor href=#2122-%e8%b6%85%e5%8f%82%e6%95%b0%e4%bc%98%e5%8c%96>#</a></h3><p><strong>W&amp;B Sweeps</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>wandb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义搜索空间</span>
</span></span><span class=line><span class=cl><span class=n>sweep_config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;bayes&#34;</span><span class=p>,</span>  <span class=c1># random, grid, bayes</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;metric&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;val/mAP50&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;goal&#34;</span><span class=p>:</span> <span class=s2>&#34;maximize&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;parameters&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lr&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;min&#34;</span><span class=p>:</span> <span class=mf>0.0001</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;max&#34;</span><span class=p>:</span> <span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;distribution&#34;</span><span class=p>:</span> <span class=s2>&#34;log_uniform_values&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;batch_size&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;values&#34;</span><span class=p>:</span> <span class=p>[</span><span class=mi>8</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>64</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;optimizer&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;values&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;SGD&#34;</span><span class=p>,</span> <span class=s2>&#34;Adam&#34;</span><span class=p>,</span> <span class=s2>&#34;AdamW&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;augmentation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;values&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;none&#34;</span><span class=p>,</span> <span class=s2>&#34;basic&#34;</span><span class=p>,</span> <span class=s2>&#34;mosaic&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建sweep</span>
</span></span><span class=line><span class=cl><span class=n>sweep_id</span> <span class=o>=</span> <span class=n>wandb</span><span class=o>.</span><span class=n>sweep</span><span class=p>(</span><span class=n>sweep_config</span><span class=p>,</span> <span class=n>project</span><span class=o>=</span><span class=s2>&#34;yolov8-sweep&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>train</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>wandb</span><span class=o>.</span><span class=n>init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>wandb</span><span class=o>.</span><span class=n>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=s2>&#34;coco128.yaml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>epochs</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>lr0</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>lr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>optimizer</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>wandb</span><span class=o>.</span><span class=n>finish</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行sweep</span>
</span></span><span class=line><span class=cl><span class=n>wandb</span><span class=o>.</span><span class=n>agent</span><span class=p>(</span><span class=n>sweep_id</span><span class=p>,</span> <span class=n>train</span><span class=p>,</span> <span class=n>count</span><span class=o>=</span><span class=mi>20</span><span class=p>)</span>  <span class=c1># 跑20组实验</span></span></span></code></pre></div><h3 id=2123-模型版本管理>21.2.3 模型版本管理<a class=anchor href=#2123-%e6%a8%a1%e5%9e%8b%e7%89%88%e6%9c%ac%e7%ae%a1%e7%90%86>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>wandb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注册模型</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>register_model</span><span class=p>(</span><span class=n>model_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>model_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;将训练好的模型注册到W&amp;B Model Registry&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>run</span> <span class=o>=</span> <span class=n>wandb</span><span class=o>.</span><span class=n>init</span><span class=p>(</span><span class=n>project</span><span class=o>=</span><span class=s2>&#34;model-registry&#34;</span><span class=p>,</span> <span class=n>job_type</span><span class=o>=</span><span class=s2>&#34;register&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建模型artifact</span>
</span></span><span class=line><span class=cl>    <span class=n>artifact</span> <span class=o>=</span> <span class=n>wandb</span><span class=o>.</span><span class=n>Artifact</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=n>model_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;model&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span><span class=o>=</span><span class=n>metrics</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>artifact</span><span class=o>.</span><span class=n>add_file</span><span class=p>(</span><span class=n>model_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 记录模型</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=o>.</span><span class=n>log_artifact</span><span class=p>(</span><span class=n>artifact</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 链接到Model Registry</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=o>.</span><span class=n>link_artifact</span><span class=p>(</span><span class=n>artifact</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;model-registry/</span><span class=si>{</span><span class=n>model_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>run</span><span class=o>.</span><span class=n>finish</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>register_model</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;best.pt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;yolov8-detector&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;mAP50&#34;</span><span class=p>:</span> <span class=mf>0.85</span><span class=p>,</span> <span class=s2>&#34;mAP50-95&#34;</span><span class=p>:</span> <span class=mf>0.65</span><span class=p>,</span> <span class=s2>&#34;FPS&#34;</span><span class=p>:</span> <span class=mi>120</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h2 id=213-模型监控与ab测试>21.3 模型监控与A/B测试<a class=anchor href=#213-%e6%a8%a1%e5%9e%8b%e7%9b%91%e6%8e%a7%e4%b8%8eab%e6%b5%8b%e8%af%95>#</a></h2><h3 id=2131-生产监控指标>21.3.1 生产监控指标<a class=anchor href=#2131-%e7%94%9f%e4%ba%a7%e7%9b%91%e6%8e%a7%e6%8c%87%e6%a0%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模型性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_p50</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_p95</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_p99</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>throughput</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>error_rate</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence_mean</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence_std</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模型监控系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>window_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window_size</span> <span class=o>=</span> <span class=n>window_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>predictions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>latencies</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>errors</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_prediction</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>latency</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录一次预测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>confidence</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>latencies</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>errors</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保持窗口大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>window_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>latencies</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取当前指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ModelMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_p50</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>latencies</span><span class=p>,</span> <span class=mi>50</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_p95</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>latencies</span><span class=p>,</span> <span class=mi>95</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_p99</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>latencies</span><span class=p>,</span> <span class=mi>99</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>throughput</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=p>)</span> <span class=o>/</span> <span class=mi>60</span><span class=p>,</span>  <span class=c1># per minute</span>
</span></span><span class=line><span class=cl>            <span class=n>error_rate</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>errors</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=p>)</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>predictions</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence_mean</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>confidence_std</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>predictions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_alerts</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查告警条件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_metrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 延迟告警</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>latency_p95</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>  <span class=c1># 100ms</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;高延迟告警: P95=</span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>latency_p95</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 错误率告警</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>error_rate</span> <span class=o>&gt;</span> <span class=mf>0.01</span><span class=p>:</span>  <span class=c1># 1%</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;错误率告警: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>error_rate</span><span class=o>*</span><span class=mi>100</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 置信度异常（可能是数据漂移）</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>confidence_mean</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;置信度下降告警: mean=</span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>confidence_mean</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>alerts</span></span></span></code></pre></div><h3 id=2132-数据漂移检测>21.3.2 数据漂移检测<a class=anchor href=#2132-%e6%95%b0%e6%8d%ae%e6%bc%82%e7%a7%bb%e6%a3%80%e6%b5%8b>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DriftDetector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据漂移检测器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>reference_data</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reference</span> <span class=o>=</span> <span class=n>reference_data</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reference_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>reference_data</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reference_std</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>std</span><span class=p>(</span><span class=n>reference_data</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect_drift</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>current_data</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span> <span class=n>alpha</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.05</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        检测数据漂移
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        使用多种统计检验：
</span></span></span><span class=line><span class=cl><span class=s2>        - KS检验：分布变化
</span></span></span><span class=line><span class=cl><span class=s2>        - Z检验：均值变化
</span></span></span><span class=line><span class=cl><span class=s2>        - F检验：方差变化
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;has_drift&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;tests&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># KS检验（分布）</span>
</span></span><span class=line><span class=cl>        <span class=n>ks_stat</span><span class=p>,</span> <span class=n>ks_pvalue</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ks_2samp</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>reference</span><span class=o>.</span><span class=n>flatten</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>current_data</span><span class=o>.</span><span class=n>flatten</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=p>[</span><span class=s2>&#34;tests&#34;</span><span class=p>][</span><span class=s2>&#34;ks&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;statistic&#34;</span><span class=p>:</span> <span class=n>ks_stat</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pvalue&#34;</span><span class=p>:</span> <span class=n>ks_pvalue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;drift&#34;</span><span class=p>:</span> <span class=n>ks_pvalue</span> <span class=o>&lt;</span> <span class=n>alpha</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 均值变化</span>
</span></span><span class=line><span class=cl>        <span class=n>current_mean</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>current_data</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>z_score</span> <span class=o>=</span> <span class=p>(</span><span class=n>current_mean</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>reference_mean</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>reference_std</span> <span class=o>/</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>current_data</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>mean_drift</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>z_score</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=p>[</span><span class=s2>&#34;tests&#34;</span><span class=p>][</span><span class=s2>&#34;mean&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;z_score&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>z_score</span><span class=p>))),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;drift&#34;</span><span class=p>:</span> <span class=nb>bool</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>any</span><span class=p>(</span><span class=n>mean_drift</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 综合判断</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=p>[</span><span class=s2>&#34;has_drift&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span><span class=n>t</span><span class=p>[</span><span class=s2>&#34;drift&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;tests&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>detector</span> <span class=o>=</span> <span class=n>DriftDetector</span><span class=p>(</span><span class=n>training_features</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>drift_result</span> <span class=o>=</span> <span class=n>detector</span><span class=o>.</span><span class=n>detect_drift</span><span class=p>(</span><span class=n>production_features</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>drift_result</span><span class=p>[</span><span class=s2>&#34;has_drift&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;⚠️ 检测到数据漂移，建议重新训练模型&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=2133-ab测试设计>21.3.3 A/B测试设计<a class=anchor href=#2133-ab%e6%b5%8b%e8%af%95%e8%ae%be%e8%ae%a1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Literal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ABTestManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A/B测试管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_experiment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>model_a</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>model_b</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>traffic_split</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建A/B测试实验&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;model_a&#34;</span><span class=p>:</span> <span class=n>model_a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;model_b&#34;</span><span class=p>:</span> <span class=n>model_b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;traffic_split&#34;</span><span class=p>:</span> <span class=n>traffic_split</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;start_time&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;a&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;requests&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=p>[]},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;b&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;requests&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;success&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=p>[]}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_variant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>experiment_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Literal</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=s2>&#34;b&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        基于用户ID分配变体（确保同一用户始终看到相同变体）
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>exp</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiments</span><span class=p>[</span><span class=n>experiment_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用哈希确保一致性</span>
</span></span><span class=line><span class=cl>        <span class=n>hash_val</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>experiment_name</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>hash_val</span> <span class=o>%</span> <span class=mi>100</span><span class=p>)</span> <span class=o>/</span> <span class=mi>100</span> <span class=o>&lt;</span> <span class=n>exp</span><span class=p>[</span><span class=s2>&#34;traffic_split&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;a&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;b&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_result</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>experiment_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>variant</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>latency</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录实验结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>experiment_name</span><span class=p>][</span><span class=n>variant</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>[</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>success</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span><span class=p>[</span><span class=s2>&#34;success&#34;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>analyze</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>experiment_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;分析实验结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>results</span><span class=p>[</span><span class=n>experiment_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>analysis</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>variant</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>,</span> <span class=s2>&#34;b&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=n>variant</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>analysis</span><span class=p>[</span><span class=n>variant</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;success_rate&#34;</span><span class=p>:</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;success&#34;</span><span class=p>]</span> <span class=o>/</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=k>if</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;avg_latency&#34;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>])</span> <span class=k>if</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;p95_latency&#34;</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>percentile</span><span class=p>(</span><span class=n>r</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>],</span> <span class=mi>95</span><span class=p>)</span> <span class=k>if</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>]</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;sample_size&#34;</span><span class=p>:</span> <span class=n>r</span><span class=p>[</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 统计显著性检验</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>][</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span> <span class=ow>and</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>][</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 成功率卡方检验</span>
</span></span><span class=line><span class=cl>            <span class=n>contingency</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>][</span><span class=s2>&#34;success&#34;</span><span class=p>],</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>][</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>-</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;a&#34;</span><span class=p>][</span><span class=s2>&#34;success&#34;</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span><span class=n>results</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>][</span><span class=s2>&#34;success&#34;</span><span class=p>],</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>][</span><span class=s2>&#34;requests&#34;</span><span class=p>]</span> <span class=o>-</span> <span class=n>results</span><span class=p>[</span><span class=s2>&#34;b&#34;</span><span class=p>][</span><span class=s2>&#34;success&#34;</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>chi2</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>chi2_contingency</span><span class=p>(</span><span class=n>contingency</span><span class=p>)[:</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>analysis</span><span class=p>[</span><span class=s2>&#34;significance&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;chi2&#34;</span><span class=p>:</span> <span class=n>chi2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;p_value&#34;</span><span class=p>:</span> <span class=n>p_value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;is_significant&#34;</span><span class=p>:</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>analysis</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>ab_manager</span> <span class=o>=</span> <span class=n>ABTestManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建实验</span>
</span></span><span class=line><span class=cl><span class=n>ab_manager</span><span class=o>.</span><span class=n>create_experiment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;yolov8_vs_yolo11&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>model_a</span><span class=o>=</span><span class=s2>&#34;yolov8n.pt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>model_b</span><span class=o>=</span><span class=s2>&#34;yolo11n.pt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>traffic_split</span><span class=o>=</span><span class=mf>0.5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在推理服务中使用</span>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/predict&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>file</span><span class=p>:</span> <span class=n>UploadFile</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>variant</span> <span class=o>=</span> <span class=n>ab_manager</span><span class=o>.</span><span class=n>get_variant</span><span class=p>(</span><span class=s2>&#34;yolov8_vs_yolo11&#34;</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>models</span><span class=p>[</span><span class=n>variant</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=n>latency</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ab_manager</span><span class=o>.</span><span class=n>record_result</span><span class=p>(</span><span class=s2>&#34;yolov8_vs_yolo11&#34;</span><span class=p>,</span> <span class=n>variant</span><span class=p>,</span> <span class=n>success</span><span class=p>,</span> <span class=n>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span></span></span></code></pre></div><hr><h2 id=214-最佳实践清单>21.4 最佳实践清单<a class=anchor href=#214-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e6%b8%85%e5%8d%95>#</a></h2><h3 id=开发流程规范>开发流程规范<a class=anchor href=#%e5%bc%80%e5%8f%91%e6%b5%81%e7%a8%8b%e8%a7%84%e8%8c%83>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl><span class=gu>## 项目结构
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>project/
</span></span><span class=line><span class=cl>├── data/
</span></span><span class=line><span class=cl>│   ├── raw/           # 原始数据（DVC跟踪）
</span></span><span class=line><span class=cl>│   ├── processed/     # 处理后数据
</span></span><span class=line><span class=cl>│   └── data.dvc       # DVC元数据
</span></span><span class=line><span class=cl>├── src/
</span></span><span class=line><span class=cl>│   ├── data/          # 数据处理
</span></span><span class=line><span class=cl>│   ├── models/        # 模型定义
</span></span><span class=line><span class=cl>│   ├── training/      # 训练脚本
</span></span><span class=line><span class=cl>│   └── inference/     # 推理服务
</span></span><span class=line><span class=cl>├── configs/
</span></span><span class=line><span class=cl>│   └── train.yaml     # 训练配置
</span></span><span class=line><span class=cl>├── tests/
</span></span><span class=line><span class=cl>│   ├── test_data.py
</span></span><span class=line><span class=cl>│   └── test_model.py
</span></span><span class=line><span class=cl>├── notebooks/         # 实验notebook
</span></span><span class=line><span class=cl>├── docker/
</span></span><span class=line><span class=cl>│   └── Dockerfile
</span></span><span class=line><span class=cl>├── dvc.yaml           # DVC流水线
</span></span><span class=line><span class=cl>├── requirements.txt
</span></span><span class=line><span class=cl>└── README.md</span></span></code></pre></div><h3 id=代码质量标准>代码质量标准<a class=anchor href=#%e4%bb%a3%e7%a0%81%e8%b4%a8%e9%87%8f%e6%a0%87%e5%87%86>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 使用类型注解</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>preprocess_image</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>image_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>target_size</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=mi>640</span><span class=p>,</span> <span class=mi>640</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>normalize</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    预处理图像
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        image_path: 图像文件路径
</span></span></span><span class=line><span class=cl><span class=s2>        target_size: 目标尺寸 (height, width)
</span></span></span><span class=line><span class=cl><span class=s2>        normalize: 是否归一化到[0,1]
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        处理后的图像数组，形状为 (C, H, W)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Raises:
</span></span></span><span class=line><span class=cl><span class=s2>        FileNotFoundError: 图像文件不存在
</span></span></span><span class=line><span class=cl><span class=s2>        ValueError: 图像格式不支持
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用配置文件而非硬编码</span>
</span></span><span class=line><span class=cl><span class=c1># config.yaml</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>name</span><span class=p>:</span> <span class=n>yolov8n</span>
</span></span><span class=line><span class=cl>  <span class=n>input_size</span><span class=p>:</span> <span class=mi>640</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>training</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>epochs</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>  <span class=n>batch_size</span><span class=p>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl>  <span class=n>lr</span><span class=p>:</span> <span class=mf>0.01</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载配置</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yaml</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;config.yaml&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>safe_load</span><span class=p>(</span><span class=n>f</span><span class=p>)</span></span></span></code></pre></div><h3 id=部署检查清单>部署检查清单<a class=anchor href=#%e9%83%a8%e7%bd%b2%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl><span class=gu>## 部署前检查
</span></span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>### 模型验证
</span></span></span><span class=line><span class=cl><span class=k>- [ ]</span> 模型在测试集上的指标满足要求
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 模型已转换为部署格式（ONNX/TensorRT）
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 已验证转换后模型的精度损失可接受
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 已进行推理速度基准测试
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>### 服务验证
</span></span></span><span class=line><span class=cl><span class=k>- [ ]</span> API接口文档完整
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 健康检查端点正常
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 错误处理和返回格式规范
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 输入验证（文件类型、大小限制）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>### 监控配置
</span></span></span><span class=line><span class=cl><span class=k>- [ ]</span> Prometheus指标已配置
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 告警规则已设置
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 日志收集已配置
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 数据漂移检测已启用
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>### 安全性
</span></span></span><span class=line><span class=cl><span class=k>- [ ]</span> API认证已启用
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 请求限流已配置
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 敏感信息未硬编码
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 依赖项无已知漏洞
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=gu>### 高可用
</span></span></span><span class=line><span class=cl><span class=k>- [ ]</span> 多实例部署
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 负载均衡配置
</span></span><span class=line><span class=cl><span class=k>- [ ]</span> 自动重启策略
</span></span><span class=line><span class=cl>- [ ] 回滚方案准备</span></span></code></pre></div><h3 id=常见问题解答>常见问题解答<a class=anchor href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e8%a7%a3%e7%ad%94>#</a></h3><table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>模型在生产环境精度下降</td><td>检查数据漂移；确保预处理一致</td></tr><tr><td>推理速度比预期慢</td><td>检查批处理配置；使用TensorRT</td></tr><tr><td>显存溢出</td><td>减小batch size；启用模型offload</td></tr><tr><td>服务不稳定</td><td>增加健康检查；配置自动重启</td></tr><tr><td>难以复现实验结果</td><td>固定随机种子；使用DVC跟踪数据</td></tr></tbody></table><h2 id=本章小结-2>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2>#</a></h2><h3 id=核心要点-1>核心要点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9-1>#</a></h3><ol><li><strong>数据管理</strong>：DVC版本控制 + 质量检查</li><li><strong>实验跟踪</strong>：W&amp;B记录 + 超参数优化</li><li><strong>模型监控</strong>：性能指标 + 漂移检测</li><li><strong>A/B测试</strong>：科学验证模型改进</li><li><strong>工程规范</strong>：标准化项目结构和流程</li></ol><h3 id=mlops成熟度级别>MLOps成熟度级别<a class=anchor href=#mlops%e6%88%90%e7%86%9f%e5%ba%a6%e7%ba%a7%e5%88%ab>#</a></h3><table><thead><tr><th>级别</th><th>特征</th><th>实践</th></tr></thead><tbody><tr><td><strong>L0</strong></td><td>手工流程</td><td>Jupyter notebook</td></tr><tr><td><strong>L1</strong></td><td>自动化训练</td><td>脚本化训练流程</td></tr><tr><td><strong>L2</strong></td><td>自动化部署</td><td>CI/CD + 模型注册</td></tr><tr><td><strong>L3</strong></td><td>持续监控</td><td>A/B测试 + 自动重训练</td></tr></tbody></table><h3 id=学习资源>学习资源<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e8%b5%84%e6%ba%90>#</a></h3><ul><li><a href=https://ml-ops.org/>MLOps Principles</a></li><li><a href=https://madewithml.com/>Made With ML</a></li><li><a href=https://fullstackdeeplearning.com/>Full Stack Deep Learning</a></li></ul><hr><h2 id=第八篇总结>第八篇总结<a class=anchor href=#%e7%ac%ac%e5%85%ab%e7%af%87%e6%80%bb%e7%bb%93>#</a></h2><p>恭喜完成生产实践与工程化篇章！</p><h3 id=学习成果>学习成果<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9e%9c>#</a></h3><ol><li>✅ 掌握模型优化技术（量化、剪枝、蒸馏）</li><li>✅ 熟练使用TensorRT加速推理</li><li>✅ 能够构建生产级推理服务</li><li>✅ 掌握边缘设备部署方案</li><li>✅ 建立完整的MLOps流程</li><li>✅ 实现模型监控和A/B测试</li></ol><h3 id=技术栈总结>技术栈总结<a class=anchor href=#%e6%8a%80%e6%9c%af%e6%a0%88%e6%80%bb%e7%bb%93>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>模型优化</span><span class=p>:</span><span class=w> </span><span class=l>PyTorch量化, TensorRT, ONNX</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>服务部署</span><span class=p>:</span><span class=w> </span><span class=l>FastAPI, Triton, Docker</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>边缘部署</span><span class=p>:</span><span class=w> </span><span class=l>CoreML, TFLite, ONNX Runtime</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>MLOps</span><span class=p>:</span><span class=w> </span><span class=l>DVC, W&amp;B, Prometheus</span></span></span></code></pre></div><h3 id=下一步>下一步<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5>#</a></h3><ol><li>在实际项目中应用这些技术</li><li>构建端到端的MLOps流水线</li><li>持续关注新技术发展</li></ol><hr><p><strong>参考资源</strong>：</p><ul><li><a href=https://dvc.org/doc>DVC Documentation</a></li><li><a href=https://docs.wandb.ai/>Weights & Biases</a></li><li><a href=https://mlflow.org/>MLflow</a></li><li><a href=https://prometheus.io/>Prometheus</a></li></ul><hr><p><strong>更新日期</strong>：2025年11月
<strong>基于版本</strong>：DVC 3.x, W&amp;B 0.16+, FastAPI 0.115+</p></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第七篇 视觉大模型</span>
</a></span><span><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/ class="flex align-center"><span>大模型笔记</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#篇章定位>篇章定位</a></li><li><a href=#为什么需要生产实践>为什么需要生产实践？</a></li><li><a href=#内容结构>内容结构</a><ul><li><a href=#第19章模型优化与加速>第19章：模型优化与加速</a></li><li><a href=#第20章生产部署>第20章：生产部署</a></li><li><a href=#第21章mlops与最佳实践>第21章：MLOps与最佳实践</a></li></ul></li><li><a href=#技术栈>技术栈</a></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#快速入门路径>快速入门路径</a></li><li><a href=#系统学习路径>系统学习路径</a></li><li><a href=#工程化路径>工程化路径</a></li></ul></li><li><a href=#实践项目建议>实践项目建议</a><ul><li><a href=#入门项目>入门项目</a></li><li><a href=#进阶项目>进阶项目</a></li><li><a href=#高级项目>高级项目</a></li></ul></li><li><a href=#性能目标>性能目标</a></li><li><a href=#应用场景>应用场景</a></li><li><a href=#学习目标>学习目标</a></li><li><a href=#参考资源>参考资源</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#工具与平台>工具与平台</a></li><li><a href=#社区资源>社区资源</a></li></ul></li><li><a href=#前置知识>前置知识</a></li><li><a href=#开始学习>开始学习</a></li></ul><ul><li><a href=#本章概览>本章概览</a></li><li><a href=#为什么需要模型优化>为什么需要模型优化？</a></li><li><a href=#章节结构>章节结构</a></li><li><a href=#191-量化int8fp16推理>19.1 量化：INT8/FP16推理</a><ul><li><a href=#1911-量化原理>19.1.1 量化原理</a></li><li><a href=#1912-pytorch量化实战>19.1.2 PyTorch量化实战</a></li><li><a href=#1913-fp16混合精度>19.1.3 FP16混合精度</a></li></ul></li><li><a href=#192-剪枝与蒸馏>19.2 剪枝与蒸馏</a><ul><li><a href=#1921-模型剪枝>19.2.1 模型剪枝</a></li><li><a href=#1922-知识蒸馏>19.2.2 知识蒸馏</a></li></ul></li><li><a href=#193-tensorrt加速>19.3 TensorRT加速</a><ul><li><a href=#1931-onnx转tensorrt>19.3.1 ONNX转TensorRT</a></li></ul></li><li><a href=#194-实战模型压缩与部署>19.4 实战：模型压缩与部署</a><ul><li><a href=#优化决策矩阵>优化决策矩阵</a></li></ul></li><li><a href=#本章小结>本章小结</a></li></ul><ul><li><a href=#本章概览-1>本章概览</a></li><li><a href=#为什么需要服务化部署>为什么需要服务化部署？</a></li><li><a href=#201-onnx模型转换>20.1 ONNX模型转换</a><ul><li><a href=#2011-为什么选择onnx>20.1.1 为什么选择ONNX？</a></li><li><a href=#2012-pytorch转onnx>20.1.2 PyTorch转ONNX</a></li><li><a href=#2013-模型验证与简化>20.1.3 模型验证与简化</a></li></ul></li><li><a href=#202-服务化部署>20.2 服务化部署</a><ul><li><a href=#2021-fastapi构建推理服务>20.2.1 FastAPI构建推理服务</a></li><li><a href=#2022-triton-inference-server>20.2.2 Triton Inference Server</a></li><li><a href=#2023-docker容器化>20.2.3 Docker容器化</a></li></ul></li><li><a href=#203-边缘设备部署>20.3 边缘设备部署</a><ul><li><a href=#2031-移动端部署>20.3.1 移动端部署</a></li><li><a href=#2032-jetson嵌入式设备>20.3.2 Jetson嵌入式设备</a></li><li><a href=#2033-onnx-runtime-mobile>20.3.3 ONNX Runtime Mobile</a></li></ul></li><li><a href=#204-实战构建生产级服务>20.4 实战：构建生产级服务</a><ul><li><a href=#完整架构示例>完整架构示例</a></li><li><a href=#api设计规范>API设计规范</a></li><li><a href=#监控指标>监控指标</a></li></ul></li><li><a href=#本章小结-1>本章小结</a><ul><li><a href=#核心要点>核心要点</a></li><li><a href=#部署决策树>部署决策树</a></li></ul></li></ul><ul><li><a href=#本章概览-2>本章概览</a></li><li><a href=#为什么需要mlops>为什么需要MLOps？</a></li><li><a href=#211-数据管理与标注>21.1 数据管理与标注</a><ul><li><a href=#2111-数据版本控制dvc>21.1.1 数据版本控制（DVC）</a></li><li><a href=#2112-标注工具选型>21.1.2 标注工具选型</a></li><li><a href=#2113-数据质量管理>21.1.3 数据质量管理</a></li></ul></li><li><a href=#212-实验跟踪>21.2 实验跟踪</a><ul><li><a href=#2121-weights--biases集成>21.2.1 Weights & Biases集成</a></li><li><a href=#2122-超参数优化>21.2.2 超参数优化</a></li><li><a href=#2123-模型版本管理>21.2.3 模型版本管理</a></li></ul></li><li><a href=#213-模型监控与ab测试>21.3 模型监控与A/B测试</a><ul><li><a href=#2131-生产监控指标>21.3.1 生产监控指标</a></li><li><a href=#2132-数据漂移检测>21.3.2 数据漂移检测</a></li><li><a href=#2133-ab测试设计>21.3.3 A/B测试设计</a></li></ul></li><li><a href=#214-最佳实践清单>21.4 最佳实践清单</a><ul><li><a href=#开发流程规范>开发流程规范</a></li><li><a href=#代码质量标准>代码质量标准</a></li><li><a href=#部署检查清单>部署检查清单</a></li><li><a href=#常见问题解答>常见问题解答</a></li></ul></li><li><a href=#本章小结-2>本章小结</a><ul><li><a href=#核心要点-1>核心要点</a></li><li><a href=#mlops成熟度级别>MLOps成熟度级别</a></li><li><a href=#学习资源>学习资源</a></li></ul></li><li><a href=#第八篇总结>第八篇总结</a><ul><li><a href=#学习成果>学习成果</a></li><li><a href=#技术栈总结>技术栈总结</a></li><li><a href=#下一步>下一步</a></li></ul></li></ul></nav></div></aside></main></body></html>