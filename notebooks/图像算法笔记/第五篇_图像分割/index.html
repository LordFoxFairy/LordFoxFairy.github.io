<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第五篇：图像分割与实例分割# 从像素级理解到万物分割，掌握图像分割的完整技术栈
篇章概览# 图像分割是计算机视觉的核心任务之一，它不仅要识别"哪里有物体"（目标检测），还要精确描绘"物体的每一个像素"。本篇将系统学习：
语义分割：为每个像素分配类别标签 实例分割：区分同一类别的不同个体 Segment Anything：零样本分割的革命性突破 为什么要学习图像分割？# 1. 更精细的视觉理解# 目标检测：这里有一辆车 [矩形框] 语义分割：这些像素是车 [像素级mask] 实例分割：这是第1辆车，那是第2辆车 [区分个体]2. 广泛的应用场景# 医学影像：肿瘤分割、器官分割 自动驾驶：道路分割、车道线检测 遥感分析：土地利用分类 图像编辑：抠图、背景替换 工业检测：缺陷分割 3. 技术发展迅速# 从FCN到U-Net：编码器-解码器架构 从Mask R-CNN到YOLACT：实时实例分割 从SAM到SAM 2：零样本视频分割 篇章结构# 第11章：语义分割# 语义分割为每个像素分配类别标签，不区分同类物体的个体。
核心内容：
11.1 FCN：全卷积网络的开创性工作 11.2 U-Net：医学图像分割的经典架构 11.3 DeepLab系列：空洞卷积与ASPP 11.4 实战：医学图像分割项目 代码实践：
U-Net完整实现与训练 医学影像数据处理 分割评估指标（IoU、Dice） 第12章：实例分割# 实例分割不仅识别像素类别，还要区分同类物体的不同个体。
核心内容：
12.1 Mask R-CNN：两阶段实例分割 12.2 YOLACT：实时实例分割 12.3 YOLOv8-Seg：YOLO的分割版本 12.4 实战：COCO实例分割 代码实践：
YOLOv8-Seg训练与推理 实例分割后处理 可视化mask输出 第13章：Segment Anything (SAM)# Meta的SAM模型开启了"万物分割"的新时代，支持零样本分割。
核心内容：
13.1 SAM模型架构详解 13.2 Prompt Engineering for SAM 13.3 SAM 2：视频分割能力 13.4 实战：零样本分割应用 代码实践：
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第五篇 图像分割"><meta property="og:description" content='第五篇：图像分割与实例分割# 从像素级理解到万物分割，掌握图像分割的完整技术栈
篇章概览# 图像分割是计算机视觉的核心任务之一，它不仅要识别"哪里有物体"（目标检测），还要精确描绘"物体的每一个像素"。本篇将系统学习：
语义分割：为每个像素分配类别标签 实例分割：区分同一类别的不同个体 Segment Anything：零样本分割的革命性突破 为什么要学习图像分割？# 1. 更精细的视觉理解# 目标检测：这里有一辆车 [矩形框] 语义分割：这些像素是车 [像素级mask] 实例分割：这是第1辆车，那是第2辆车 [区分个体]2. 广泛的应用场景# 医学影像：肿瘤分割、器官分割 自动驾驶：道路分割、车道线检测 遥感分析：土地利用分类 图像编辑：抠图、背景替换 工业检测：缺陷分割 3. 技术发展迅速# 从FCN到U-Net：编码器-解码器架构 从Mask R-CNN到YOLACT：实时实例分割 从SAM到SAM 2：零样本视频分割 篇章结构# 第11章：语义分割# 语义分割为每个像素分配类别标签，不区分同类物体的个体。
核心内容：
11.1 FCN：全卷积网络的开创性工作 11.2 U-Net：医学图像分割的经典架构 11.3 DeepLab系列：空洞卷积与ASPP 11.4 实战：医学图像分割项目 代码实践：
U-Net完整实现与训练 医学影像数据处理 分割评估指标（IoU、Dice） 第12章：实例分割# 实例分割不仅识别像素类别，还要区分同类物体的不同个体。
核心内容：
12.1 Mask R-CNN：两阶段实例分割 12.2 YOLACT：实时实例分割 12.3 YOLOv8-Seg：YOLO的分割版本 12.4 实战：COCO实例分割 代码实践：
YOLOv8-Seg训练与推理 实例分割后处理 可视化mask输出 第13章：Segment Anything (SAM)# Meta的SAM模型开启了"万物分割"的新时代，支持零样本分割。
核心内容：
13.1 SAM模型架构详解 13.2 Prompt Engineering for SAM 13.3 SAM 2：视频分割能力 13.4 实战：零样本分割应用 代码实践：'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第五篇 图像分割"><meta itemprop=description content='第五篇：图像分割与实例分割# 从像素级理解到万物分割，掌握图像分割的完整技术栈
篇章概览# 图像分割是计算机视觉的核心任务之一，它不仅要识别"哪里有物体"（目标检测），还要精确描绘"物体的每一个像素"。本篇将系统学习：
语义分割：为每个像素分配类别标签 实例分割：区分同一类别的不同个体 Segment Anything：零样本分割的革命性突破 为什么要学习图像分割？# 1. 更精细的视觉理解# 目标检测：这里有一辆车 [矩形框] 语义分割：这些像素是车 [像素级mask] 实例分割：这是第1辆车，那是第2辆车 [区分个体]2. 广泛的应用场景# 医学影像：肿瘤分割、器官分割 自动驾驶：道路分割、车道线检测 遥感分析：土地利用分类 图像编辑：抠图、背景替换 工业检测：缺陷分割 3. 技术发展迅速# 从FCN到U-Net：编码器-解码器架构 从Mask R-CNN到YOLACT：实时实例分割 从SAM到SAM 2：零样本视频分割 篇章结构# 第11章：语义分割# 语义分割为每个像素分配类别标签，不区分同类物体的个体。
核心内容：
11.1 FCN：全卷积网络的开创性工作 11.2 U-Net：医学图像分割的经典架构 11.3 DeepLab系列：空洞卷积与ASPP 11.4 实战：医学图像分割项目 代码实践：
U-Net完整实现与训练 医学影像数据处理 分割评估指标（IoU、Dice） 第12章：实例分割# 实例分割不仅识别像素类别，还要区分同类物体的不同个体。
核心内容：
12.1 Mask R-CNN：两阶段实例分割 12.2 YOLACT：实时实例分割 12.3 YOLOv8-Seg：YOLO的分割版本 12.4 实战：COCO实例分割 代码实践：
YOLOv8-Seg训练与推理 实例分割后处理 可视化mask输出 第13章：Segment Anything (SAM)# Meta的SAM模型开启了"万物分割"的新时代，支持零样本分割。
核心内容：
13.1 SAM模型架构详解 13.2 Prompt Engineering for SAM 13.3 SAM 2：视频分割能力 13.4 实战：零样本分割应用 代码实践：'><meta itemprop=wordCount content="5343"><title>第五篇 图像分割 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle checked>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/ class=active>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第五篇 图像分割</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#篇章概览>篇章概览</a></li><li><a href=#为什么要学习图像分割>为什么要学习图像分割？</a><ul><li><a href=#1-更精细的视觉理解>1. 更精细的视觉理解</a></li><li><a href=#2-广泛的应用场景>2. 广泛的应用场景</a></li><li><a href=#3-技术发展迅速>3. 技术发展迅速</a></li></ul></li><li><a href=#篇章结构>篇章结构</a><ul><li><a href=#第11章语义分割>第11章：语义分割</a></li><li><a href=#第12章实例分割>第12章：实例分割</a></li><li><a href=#第13章segment-anything-sam>第13章：Segment Anything (SAM)</a></li></ul></li><li><a href=#分割任务对比>分割任务对比</a></li><li><a href=#评估指标>评估指标</a><ul><li><a href=#1-iou-intersection-over-union>1. IoU (Intersection over Union)</a></li><li><a href=#2-dice-coefficient-f1-score>2. Dice Coefficient (F1 Score)</a></li><li><a href=#3-miou-mean-iou>3. mIoU (mean IoU)</a></li><li><a href=#4-pixel-accuracy>4. Pixel Accuracy</a></li></ul></li><li><a href=#技术演进路线>技术演进路线</a></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#入门阶段>入门阶段</a></li><li><a href=#进阶阶段>进阶阶段</a></li><li><a href=#高级阶段>高级阶段</a></li></ul></li><li><a href=#实战项目>实战项目</a><ul><li><a href=#1-医学图像分割>1. 医学图像分割</a></li><li><a href=#2-coco实例分割>2. COCO实例分割</a></li><li><a href=#3-零样本分割应用>3. 零样本分割应用</a></li></ul></li><li><a href=#代码示例>代码示例</a><ul><li><a href=#语义分割>语义分割</a></li><li><a href=#实例分割>实例分割</a></li><li><a href=#零样本分割>零样本分割</a></li></ul></li><li><a href=#工具与资源>工具与资源</a><ul><li><a href=#开源框架>开源框架</a></li><li><a href=#数据集>数据集</a></li><li><a href=#标注工具>标注工具</a></li></ul></li><li><a href=#学习目标>学习目标</a></li><li><a href=#下一步>下一步</a></li></ul><ul><li><a href=#本章概览>本章概览</a></li><li><a href=#什么是语义分割>什么是语义分割？</a><ul><li><a href=#任务定义>任务定义</a></li><li><a href=#与其他任务的区别>与其他任务的区别</a></li><li><a href=#应用场景>应用场景</a></li></ul></li><li><a href=#111-fcn全卷积网络>11.1 FCN：全卷积网络</a><ul><li><a href=#1111-核心思想>11.1.1 核心思想</a></li><li><a href=#1112-架构设计>11.1.2 架构设计</a><ul><li><a href=#1-全卷积化>1. 全卷积化</a></li><li><a href=#2-上采样upsampling>2. 上采样（Upsampling）</a></li><li><a href=#3-跳跃连接skip-connections>3. 跳跃连接（Skip Connections）</a></li><li><a href=#4-fcn-8s架构代码>4. FCN-8s架构代码</a></li></ul></li><li><a href=#1113-训练技巧>11.1.3 训练技巧</a><ul><li><a href=#1-损失函数>1. 损失函数</a></li><li><a href=#2-评估指标>2. 评估指标</a></li></ul></li><li><a href=#1114-fcn的局限>11.1.4 FCN的局限</a></li></ul></li><li><a href=#112-u-net编码器-解码器架构>11.2 U-Net：编码器-解码器架构</a><ul><li><a href=#1121-为什么u-net如此成功>11.2.1 为什么U-Net如此成功？</a></li><li><a href=#1122-架构设计>11.2.2 架构设计</a><ul><li><a href=#u型结构>U型结构</a></li><li><a href=#关键组件>关键组件</a></li></ul></li><li><a href=#1123-完整实现>11.2.3 完整实现</a></li><li><a href=#1124-训练策略>11.2.4 训练策略</a><ul><li><a href=#1-数据增强>1. 数据增强</a></li><li><a href=#2-加权损失>2. 加权损失</a></li><li><a href=#3-dice-loss>3. Dice Loss</a></li></ul></li><li><a href=#1125-u-net变体>11.2.5 U-Net变体</a><ul><li><a href=#1-attention-u-net>1. Attention U-Net</a></li><li><a href=#2-res-unet>2. Res-UNet</a></li><li><a href=#3-u-net>3. U-Net++</a></li></ul></li></ul></li><li><a href=#113-deeplab系列空洞卷积>11.3 DeepLab系列：空洞卷积</a><ul><li><a href=#1131-核心创新空洞卷积>11.3.1 核心创新：空洞卷积</a></li><li><a href=#1132-asppatrous-spatial-pyramid-pooling>11.3.2 ASPP（Atrous Spatial Pyramid Pooling）</a></li><li><a href=#1133-deeplab-v3架构>11.3.3 DeepLab v3+架构</a></li><li><a href=#1134-性能对比>11.3.4 性能对比</a></li></ul></li><li><a href=#114-实战医学图像分割>11.4 实战：医学图像分割</a><ul><li><a href=#1141-项目目标>11.4.1 项目目标</a></li><li><a href=#1142-数据准备>11.4.2 数据准备</a></li><li><a href=#1143-训练流程>11.4.3 训练流程</a></li><li><a href=#1144-评估指标>11.4.4 评估指标</a></li></ul></li><li><a href=#本章小结>本章小结</a><ul><li><a href=#核心知识点>核心知识点</a></li><li><a href=#技术对比>技术对比</a></li><li><a href=#实践建议>实践建议</a></li><li><a href=#下一步-1>下一步</a></li></ul></li></ul><ul><li><a href=#本章概览-1>本章概览</a></li><li><a href=#实例分割-vs-语义分割>实例分割 vs 语义分割</a><ul><li><a href=#任务对比>任务对比</a></li><li><a href=#应用场景-1>应用场景</a></li></ul></li><li><a href=#121-mask-r-cnn原理>12.1 Mask R-CNN原理</a><ul><li><a href=#1211-核心思想>12.1.1 核心思想</a></li><li><a href=#1212-关键创新>12.1.2 关键创新</a><ul><li><a href=#1-roi-align>1. RoI Align</a></li><li><a href=#2-mask分支>2. Mask分支</a></li><li><a href=#3-损失函数>3. 损失函数</a></li></ul></li><li><a href=#1213-使用detectron2>12.1.3 使用Detectron2</a></li><li><a href=#1214-mask-r-cnn变体>12.1.4 Mask R-CNN变体</a><ul><li><a href=#1-cascade-mask-r-cnn>1. Cascade Mask R-CNN</a></li><li><a href=#2-pointrend>2. PointRend</a></li></ul></li></ul></li><li><a href=#122-yolact实时实例分割>12.2 YOLACT：实时实例分割</a><ul><li><a href=#1221-核心思想>12.2.1 核心思想</a></li><li><a href=#1222-架构设计>12.2.2 架构设计</a><ul><li><a href=#1-protonet>1. Protonet</a></li><li><a href=#2-prediction-head>2. Prediction Head</a></li><li><a href=#3-mask-assembly>3. Mask Assembly</a></li></ul></li><li><a href=#1223-性能特点>12.2.3 性能特点</a></li></ul></li><li><a href=#123-yolov8-segyolo的分割版本>12.3 YOLOv8-Seg：YOLO的分割版本</a><ul><li><a href=#1231-核心特性>12.3.1 核心特性</a></li><li><a href=#1232-模型变体>12.3.2 模型变体</a></li><li><a href=#1233-使用示例>12.3.3 使用示例</a></li><li><a href=#1234-训练自定义数据>12.3.4 训练自定义数据</a><ul><li><a href=#1-数据格式>1. 数据格式</a></li><li><a href=#2-数据集配置>2. 数据集配置</a></li><li><a href=#3-训练代码>3. 训练代码</a></li></ul></li></ul></li><li><a href=#124-实战实例分割项目>12.4 实战：实例分割项目</a><ul><li><a href=#1241-项目目标>12.4.1 项目目标</a></li><li><a href=#1242-完整代码>12.4.2 完整代码</a></li><li><a href=#1243-评估指标>12.4.3 评估指标</a><ul><li><a href=#1-mask-map>1. Mask mAP</a></li><li><a href=#2-边界精度>2. 边界精度</a></li></ul></li><li><a href=#1244-后处理技巧>12.4.4 后处理技巧</a><ul><li><a href=#1-mask平滑>1. Mask平滑</a></li><li><a href=#2-小区域过滤>2. 小区域过滤</a></li><li><a href=#3-mask融合>3. Mask融合</a></li></ul></li></ul></li><li><a href=#本章小结-1>本章小结</a><ul><li><a href=#核心知识点-1>核心知识点</a></li><li><a href=#模型对比>模型对比</a></li><li><a href=#选择建议>选择建议</a></li><li><a href=#实践建议-1>实践建议</a></li><li><a href=#下一步-2>下一步</a></li></ul></li></ul><ul><li><a href=#本章概览-2>本章概览</a></li><li><a href=#为什么sam是革命性的>为什么SAM是革命性的？</a><ul><li><a href=#1-零样本分割能力>1. 零样本分割能力</a></li><li><a href=#2-promptable分割>2. Promptable分割</a></li><li><a href=#3-强大的泛化能力>3. 强大的泛化能力</a></li></ul></li><li><a href=#131-sam模型架构>13.1 SAM模型架构</a><ul><li><a href=#1311-整体架构>13.1.1 整体架构</a></li><li><a href=#1312-image-encoder>13.1.2 Image Encoder</a></li><li><a href=#1313-prompt-encoder>13.1.3 Prompt Encoder</a></li><li><a href=#1314-mask-decoder>13.1.4 Mask Decoder</a></li></ul></li><li><a href=#132-prompt-engineering-for-sam>13.2 Prompt Engineering for SAM</a><ul><li><a href=#1321-点击式分割>13.2.1 点击式分割</a></li><li><a href=#1322-边界框提示>13.2.2 边界框提示</a></li><li><a href=#1323-mask提示>13.2.3 Mask提示</a></li><li><a href=#1324-自动分割everything-mode>13.2.4 自动分割（Everything Mode）</a></li></ul></li><li><a href=#133-sam-2视频分割>13.3 SAM 2：视频分割</a><ul><li><a href=#1331-核心改进>13.3.1 核心改进</a></li><li><a href=#1332-memory-mechanism>13.3.2 Memory Mechanism</a></li><li><a href=#1333-使用sam-2>13.3.3 使用SAM 2</a></li><li><a href=#1334-sam-2性能>13.3.4 SAM 2性能</a></li></ul></li><li><a href=#134-实战零样本分割应用>13.4 实战：零样本分割应用</a><ul><li><a href=#1341-项目交互式图像编辑>13.4.1 项目：交互式图像编辑</a></li><li><a href=#1342-应用场景>13.4.2 应用场景</a><ul><li><a href=#1-快速数据标注>1. 快速数据标注</a></li><li><a href=#2-移除背景>2. 移除背景</a></li><li><a href=#3-对象替换>3. 对象替换</a></li></ul></li><li><a href=#1343-sam的局限>13.4.3 SAM的局限</a></li><li><a href=#1344-sam--其他模型>13.4.4 SAM + 其他模型</a><ul><li><a href=#1-grounded-sam>1. Grounded-SAM</a></li><li><a href=#2-mobilesam>2. MobileSAM</a></li></ul></li></ul></li><li><a href=#本章小结-2>本章小结</a><ul><li><a href=#核心知识点-2>核心知识点</a></li><li><a href=#技术对比-1>技术对比</a></li><li><a href=#应用场景-2>应用场景</a></li><li><a href=#实践建议-2>实践建议</a></li><li><a href=#未来展望>未来展望</a></li></ul></li><li><a href=#第五篇总结>第五篇总结</a><ul><li><a href=#完整技术栈>完整技术栈</a></li><li><a href=#学习成果>学习成果</a></li><li><a href=#下一步-3>下一步</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第五篇图像分割与实例分割>第五篇：图像分割与实例分割<a class=anchor href=#%e7%ac%ac%e4%ba%94%e7%af%87%e5%9b%be%e5%83%8f%e5%88%86%e5%89%b2%e4%b8%8e%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2>#</a></h1><blockquote class=book-hint><p>从像素级理解到万物分割，掌握图像分割的完整技术栈</p></blockquote><h2 id=篇章概览>篇章概览<a class=anchor href=#%e7%af%87%e7%ab%a0%e6%a6%82%e8%a7%88>#</a></h2><p>图像分割是计算机视觉的核心任务之一，它不仅要识别"哪里有物体"（目标检测），还要精确描绘"物体的每一个像素"。本篇将系统学习：</p><ul><li><strong>语义分割</strong>：为每个像素分配类别标签</li><li><strong>实例分割</strong>：区分同一类别的不同个体</li><li><strong>Segment Anything</strong>：零样本分割的革命性突破</li></ul><h2 id=为什么要学习图像分割>为什么要学习图像分割？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e5%ad%a6%e4%b9%a0%e5%9b%be%e5%83%8f%e5%88%86%e5%89%b2>#</a></h2><h3 id=1-更精细的视觉理解>1. 更精细的视觉理解<a class=anchor href=#1-%e6%9b%b4%e7%b2%be%e7%bb%86%e7%9a%84%e8%a7%86%e8%a7%89%e7%90%86%e8%a7%a3>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>目标检测：这里有一辆车 [矩形框]
</span></span><span class=line><span class=cl>语义分割：这些像素是车 [像素级mask]
</span></span><span class=line><span class=cl>实例分割：这是第1辆车，那是第2辆车 [区分个体]</span></span></code></pre></div><h3 id=2-广泛的应用场景>2. 广泛的应用场景<a class=anchor href=#2-%e5%b9%bf%e6%b3%9b%e7%9a%84%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h3><ul><li><strong>医学影像</strong>：肿瘤分割、器官分割</li><li><strong>自动驾驶</strong>：道路分割、车道线检测</li><li><strong>遥感分析</strong>：土地利用分类</li><li><strong>图像编辑</strong>：抠图、背景替换</li><li><strong>工业检测</strong>：缺陷分割</li></ul><h3 id=3-技术发展迅速>3. 技术发展迅速<a class=anchor href=#3-%e6%8a%80%e6%9c%af%e5%8f%91%e5%b1%95%e8%bf%85%e9%80%9f>#</a></h3><ul><li>从FCN到U-Net：编码器-解码器架构</li><li>从Mask R-CNN到YOLACT：实时实例分割</li><li>从SAM到SAM 2：零样本视频分割</li></ul><h2 id=篇章结构>篇章结构<a class=anchor href=#%e7%af%87%e7%ab%a0%e7%bb%93%e6%9e%84>#</a></h2><h3 id=第11章语义分割><a href=./chapter11/README.md>第11章：语义分割</a><a class=anchor href=#%e7%ac%ac11%e7%ab%a0%e8%af%ad%e4%b9%89%e5%88%86%e5%89%b2>#</a></h3><p>语义分割为每个像素分配类别标签，不区分同类物体的个体。</p><p><strong>核心内容</strong>：</p><ul><li>11.1 FCN：全卷积网络的开创性工作</li><li>11.2 U-Net：医学图像分割的经典架构</li><li>11.3 DeepLab系列：空洞卷积与ASPP</li><li>11.4 实战：医学图像分割项目</li></ul><p><strong>代码实践</strong>：</p><ul><li>U-Net完整实现与训练</li><li>医学影像数据处理</li><li>分割评估指标（IoU、Dice）</li></ul><h3 id=第12章实例分割><a href=./chapter12/README.md>第12章：实例分割</a><a class=anchor href=#%e7%ac%ac12%e7%ab%a0%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2>#</a></h3><p>实例分割不仅识别像素类别，还要区分同类物体的不同个体。</p><p><strong>核心内容</strong>：</p><ul><li>12.1 Mask R-CNN：两阶段实例分割</li><li>12.2 YOLACT：实时实例分割</li><li>12.3 YOLOv8-Seg：YOLO的分割版本</li><li>12.4 实战：COCO实例分割</li></ul><p><strong>代码实践</strong>：</p><ul><li>YOLOv8-Seg训练与推理</li><li>实例分割后处理</li><li>可视化mask输出</li></ul><h3 id=第13章segment-anything-sam><a href=./chapter13/README.md>第13章：Segment Anything (SAM)</a><a class=anchor href=#%e7%ac%ac13%e7%ab%a0segment-anything-sam>#</a></h3><p>Meta的SAM模型开启了"万物分割"的新时代，支持零样本分割。</p><p><strong>核心内容</strong>：</p><ul><li>13.1 SAM模型架构详解</li><li>13.2 Prompt Engineering for SAM</li><li>13.3 SAM 2：视频分割能力</li><li>13.4 实战：零样本分割应用</li></ul><p><strong>代码实践</strong>：</p><ul><li>SAM点击式分割</li><li>SAM边界框分割</li><li>SAM 2视频对象分割</li></ul><h2 id=分割任务对比>分割任务对比<a class=anchor href=#%e5%88%86%e5%89%b2%e4%bb%bb%e5%8a%a1%e5%af%b9%e6%af%94>#</a></h2><table><thead><tr><th>任务类型</th><th>定义</th><th>输出</th><th>应用场景</th><th>代表模型</th></tr></thead><tbody><tr><td><strong>语义分割</strong></td><td>像素级分类</td><td>类别掩码</td><td>场景理解、医学影像</td><td>FCN, U-Net, DeepLab</td></tr><tr><td><strong>实例分割</strong></td><td>区分个体</td><td>实例掩码</td><td>自动驾驶、工业检测</td><td>Mask R-CNN, YOLOv8-Seg</td></tr><tr><td><strong>全景分割</strong></td><td>语义+实例</td><td>统一掩码</td><td>完整场景理解</td><td>Panoptic FPN</td></tr><tr><td><strong>交互式分割</strong></td><td>用户引导</td><td>交互掩码</td><td>图像编辑、标注工具</td><td>SAM, SAM 2</td></tr></tbody></table><h2 id=评估指标>评估指标<a class=anchor href=#%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87>#</a></h2><h3 id=1-iou-intersection-over-union>1. IoU (Intersection over Union)<a class=anchor href=#1-iou-intersection-over-union>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>IoU = 交集 / 并集 = (预测 ∩ 真实) / (预测 ∪ 真实)</span></span></code></pre></div><p><strong>优点</strong>：直观，易于理解
<strong>缺点</strong>：对类别不平衡敏感</p><h3 id=2-dice-coefficient-f1-score>2. Dice Coefficient (F1 Score)<a class=anchor href=#2-dice-coefficient-f1-score>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Dice = 2 × 交集 / (预测 + 真实) = 2 × |A ∩ B| / (|A| + |B|)</span></span></code></pre></div><p><strong>优点</strong>：对小目标更友好
<strong>应用</strong>：医学图像分割常用</p><h3 id=3-miou-mean-iou>3. mIoU (mean IoU)<a class=anchor href=#3-miou-mean-iou>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>mIoU = (1/N) × Σ IoU_i</span></span></code></pre></div><p>对所有类别的IoU取平均，评估整体性能。</p><h3 id=4-pixel-accuracy>4. Pixel Accuracy<a class=anchor href=#4-pixel-accuracy>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>PA = 正确分类的像素数 / 总像素数</span></span></code></pre></div><p><strong>缺点</strong>：对类别不平衡非常敏感</p><h2 id=技术演进路线>技术演进路线<a class=anchor href=#%e6%8a%80%e6%9c%af%e6%bc%94%e8%bf%9b%e8%b7%af%e7%ba%bf>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>2015    FCN           全卷积网络，开创像素级预测
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2015    U-Net         编码器-解码器，医学图像分割经典
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2017    DeepLab v3    空洞卷积 + ASPP
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2017    Mask R-CNN    实例分割里程碑
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2019    YOLACT        实时实例分割
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2023    YOLOv8-Seg    YOLO统一框架
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2023    SAM           零样本分割，Prompt驱动
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>2024    SAM 2         扩展到视频分割</span></span></code></pre></div><h2 id=学习路径建议>学习路径建议<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84%e5%bb%ba%e8%ae%ae>#</a></h2><h3 id=入门阶段>入门阶段<a class=anchor href=#%e5%85%a5%e9%97%a8%e9%98%b6%e6%ae%b5>#</a></h3><ol><li>理解语义分割与实例分割的区别</li><li>掌握FCN和U-Net的核心思想</li><li>实践医学图像分割项目</li></ol><h3 id=进阶阶段>进阶阶段<a class=anchor href=#%e8%bf%9b%e9%98%b6%e9%98%b6%e6%ae%b5>#</a></h3><ol><li>学习Mask R-CNN的两阶段设计</li><li>掌握YOLOv8-Seg的实时分割</li><li>理解空洞卷积的作用</li></ol><h3 id=高级阶段>高级阶段<a class=anchor href=#%e9%ab%98%e7%ba%a7%e9%98%b6%e6%ae%b5>#</a></h3><ol><li>深入SAM的架构和Prompt机制</li><li>探索SAM 2的视频分割能力</li><li>应用于实际项目</li></ol><h2 id=实战项目>实战项目<a class=anchor href=#%e5%ae%9e%e6%88%98%e9%a1%b9%e7%9b%ae>#</a></h2><h3 id=1-医学图像分割>1. 医学图像分割<a class=anchor href=#1-%e5%8c%bb%e5%ad%a6%e5%9b%be%e5%83%8f%e5%88%86%e5%89%b2>#</a></h3><ul><li>数据集：Medical Segmentation Decathlon</li><li>任务：肺部CT分割</li><li>模型：U-Net</li><li>指标：Dice Coefficient</li></ul><h3 id=2-coco实例分割>2. COCO实例分割<a class=anchor href=#2-coco%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2>#</a></h3><ul><li>数据集：COCO 2017</li><li>任务：80类物体实例分割</li><li>模型：YOLOv8-Seg</li><li>指标：mAP (box + mask)</li></ul><h3 id=3-零样本分割应用>3. 零样本分割应用<a class=anchor href=#3-%e9%9b%b6%e6%a0%b7%e6%9c%ac%e5%88%86%e5%89%b2%e5%ba%94%e7%94%a8>#</a></h3><ul><li>任务：自定义物体分割</li><li>模型：SAM</li><li>交互：点击、框选、文本提示</li></ul><h2 id=代码示例>代码示例<a class=anchor href=#%e4%bb%a3%e7%a0%81%e7%a4%ba%e4%be%8b>#</a></h2><h3 id=语义分割>语义分割<a class=anchor href=#%e8%af%ad%e4%b9%89%e5%88%86%e5%89%b2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>models</span> <span class=kn>import</span> <span class=n>UNet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载U-Net模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>UNet</span><span class=p>(</span><span class=n>in_channels</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>load_state_dict</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s1>&#39;unet.pth&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推理</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>load_medical_image</span><span class=p>(</span><span class=s1>&#39;ct_scan.nii&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>mask</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>prediction</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span></span></span></code></pre></div><h3 id=实例分割>实例分割<a class=anchor href=#%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载YOLOv8-Seg</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s1>&#39;yolo11n-seg.pt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推理</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=s1>&#39;street.jpg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>masks</span><span class=o>.</span><span class=n>data</span>  <span class=c1># 实例掩码</span>
</span></span><span class=line><span class=cl><span class=n>boxes</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>boxes</span><span class=o>.</span><span class=n>data</span>  <span class=c1># 边界框</span></span></span></code></pre></div><h3 id=零样本分割>零样本分割<a class=anchor href=#%e9%9b%b6%e6%a0%b7%e6%9c%ac%e5%88%86%e5%89%b2>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>SamModel</span><span class=p>,</span> <span class=n>SamProcessor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载SAM</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>SamModel</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;facebook/sam-vit-huge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processor</span> <span class=o>=</span> <span class=n>SamProcessor</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;facebook/sam-vit-huge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 点击式分割</span>
</span></span><span class=line><span class=cl><span class=n>input_points</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>450</span><span class=p>,</span> <span class=mi>600</span><span class=p>]]]</span>  <span class=c1># 点击坐标</span>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>input_points</span><span class=o>=</span><span class=n>input_points</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>post_process_masks</span><span class=p>(</span><span class=n>outputs</span><span class=o>.</span><span class=n>pred_masks</span><span class=p>)</span></span></span></code></pre></div><h2 id=工具与资源>工具与资源<a class=anchor href=#%e5%b7%a5%e5%85%b7%e4%b8%8e%e8%b5%84%e6%ba%90>#</a></h2><h3 id=开源框架>开源框架<a class=anchor href=#%e5%bc%80%e6%ba%90%e6%a1%86%e6%9e%b6>#</a></h3><ul><li><strong>Ultralytics</strong>：YOLOv8-Seg实现</li><li><strong>MMSegmentation</strong>：丰富的分割模型库</li><li><strong>Segmentation Models PyTorch</strong>：预训练分割模型</li></ul><h3 id=数据集>数据集<a class=anchor href=#%e6%95%b0%e6%8d%ae%e9%9b%86>#</a></h3><ul><li><strong>COCO</strong>：实例分割标准数据集</li><li><strong>Pascal VOC</strong>：语义分割经典数据集</li><li><strong>Cityscapes</strong>：自动驾驶场景分割</li><li><strong>ADE20K</strong>：场景解析数据集</li><li><strong>Medical Decathlon</strong>：医学图像分割</li></ul><h3 id=标注工具>标注工具<a class=anchor href=#%e6%a0%87%e6%b3%a8%e5%b7%a5%e5%85%b7>#</a></h3><ul><li><strong>LabelMe</strong>：通用分割标注</li><li><strong>CVAT</strong>：支持实例分割</li><li><strong>SAM Demo</strong>：基于SAM的快速标注</li></ul><h2 id=学习目标>学习目标<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e7%9b%ae%e6%a0%87>#</a></h2><p>学完本篇后，你将能够：</p><ol><li><p><strong>理解分割任务</strong></p><ul><li>区分语义分割、实例分割、全景分割</li><li>掌握评估指标的计算和意义</li></ul></li><li><p><strong>掌握核心模型</strong></p><ul><li>实现U-Net从零开始</li><li>使用YOLOv8-Seg进行实例分割</li><li>应用SAM进行零样本分割</li></ul></li><li><p><strong>完成实战项目</strong></p><ul><li>医学图像分割</li><li>COCO实例分割</li><li>自定义分割应用</li></ul></li><li><p><strong>解决实际问题</strong></p><ul><li>小目标分割优化</li><li>类别不平衡处理</li><li>实时性能优化</li></ul></li></ol><h2 id=下一步>下一步<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5>#</a></h2><p>准备好了吗？让我们从<a href=./chapter11/README.md>第11章</a>开始，深入学习语义分割的核心技术！</p><hr><p><strong>本篇特色</strong>：</p><ul><li>从经典到前沿的完整技术栈</li><li>医学图像分割实战项目</li><li>SAM零样本分割深度解析</li><li>完整可运行的代码示例</li></ul><hr><h1 id=第11章语义分割-1>第11章：语义分割<a class=anchor href=#%e7%ac%ac11%e7%ab%a0%e8%af%ad%e4%b9%89%e5%88%86%e5%89%b2-1>#</a></h1><blockquote class=book-hint><p>从FCN到DeepLab，掌握像素级分类的核心技术</p></blockquote><h2 id=本章概览>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88>#</a></h2><p>语义分割（Semantic Segmentation）是计算机视觉的基础任务之一，目标是为图像中的每个像素分配一个类别标签。与目标检测不同，语义分割不仅要找到物体，还要精确描绘其边界。</p><p><strong>核心内容</strong>：</p><ul><li>FCN如何开创全卷积网络范式</li><li>U-Net为何成为医学图像分割的金标准</li><li>DeepLab的空洞卷积如何扩大感受野</li><li>实战医学图像分割项目</li></ul><h2 id=什么是语义分割>什么是语义分割？<a class=anchor href=#%e4%bb%80%e4%b9%88%e6%98%af%e8%af%ad%e4%b9%89%e5%88%86%e5%89%b2>#</a></h2><h3 id=任务定义>任务定义<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e5%ae%9a%e4%b9%89>#</a></h3><p>给定输入图像 <code>I ∈ R^(H×W×3)</code>，输出分割掩码 <code>S ∈ {1,2,...,C}^(H×W)</code>，其中C是类别数。</p><p><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入：街景图像 (512×512×3)
</span></span><span class=line><span class=cl>输出：
</span></span><span class=line><span class=cl>  - 像素(100, 200) → 类别2 (人)
</span></span><span class=line><span class=cl>  - 像素(300, 150) → 类别7 (汽车)
</span></span><span class=line><span class=cl>  - 像素(450, 400) → 类别0 (背景)</span></span></code></pre></div><h3 id=与其他任务的区别>与其他任务的区别<a class=anchor href=#%e4%b8%8e%e5%85%b6%e4%bb%96%e4%bb%bb%e5%8a%a1%e7%9a%84%e5%8c%ba%e5%88%ab>#</a></h3><table><thead><tr><th>任务</th><th>输出</th><th>特点</th><th>示例</th></tr></thead><tbody><tr><td><strong>图像分类</strong></td><td>单一标签</td><td>整图级别</td><td>&ldquo;这是一只猫&rdquo;</td></tr><tr><td><strong>目标检测</strong></td><td>边界框+类别</td><td>物体级别</td><td>&ldquo;这里有2只猫&rdquo;</td></tr><tr><td><strong>语义分割</strong></td><td>像素级类别</td><td>像素级别</td><td>&ldquo;这些像素是猫&rdquo;</td></tr><tr><td><strong>实例分割</strong></td><td>像素级实例</td><td>区分个体</td><td>&ldquo;第1只猫、第2只猫&rdquo;</td></tr></tbody></table><h3 id=应用场景>应用场景<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h3><ol><li><p><strong>医学影像分析</strong></p><ul><li>器官分割（肝脏、肺部）</li><li>病灶检测（肿瘤、病变）</li><li>细胞分割</li></ul></li><li><p><strong>自动驾驶</strong></p><ul><li>道路分割</li><li>车道线检测</li><li>障碍物识别</li></ul></li><li><p><strong>遥感图像分析</strong></p><ul><li>土地利用分类</li><li>建筑物提取</li><li>森林监测</li></ul></li><li><p><strong>图像编辑</strong></p><ul><li>人像抠图</li><li>背景替换</li><li>风格迁移</li></ul></li></ol><hr><h2 id=111-fcn全卷积网络>11.1 FCN：全卷积网络<a class=anchor href=#111-fcn%e5%85%a8%e5%8d%b7%e7%a7%af%e7%bd%91%e7%bb%9c>#</a></h2><p><strong>论文</strong>：Fully Convolutional Networks for Semantic Segmentation (CVPR 2015)
<strong>作者</strong>：Jonathan Long, Evan Shelhamer, Trevor Darrell (UC Berkeley)</p><h3 id=1111-核心思想>11.1.1 核心思想<a class=anchor href=#1111-%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3>#</a></h3><p>FCN的革命性贡献：<strong>将分类网络改造为全卷积网络，实现端到端的像素级预测</strong>。</p><p><strong>传统分类网络的问题</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像 (224×224×3)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>卷积层 (提取特征)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>全连接层 (分类)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>输出：单一类别标签</span></span></code></pre></div><p>全连接层有两个问题：</p><ol><li><strong>固定输入尺寸</strong>：必须是224×224</li><li><strong>丢失空间信息</strong>：输出是1D向量</li></ol><p><strong>FCN的解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像 (任意尺寸 H×W×3)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>全卷积层 (无全连接层)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>上采样 (恢复分辨率)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>输出：像素级预测 (H×W×C)</span></span></code></pre></div><h3 id=1112-架构设计>11.1.2 架构设计<a class=anchor href=#1112-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h3><h4 id=1-全卷积化>1. 全卷积化<a class=anchor href=#1-%e5%85%a8%e5%8d%b7%e7%a7%af%e5%8c%96>#</a></h4><p>将AlexNet/VGG的全连接层替换为1×1卷积：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 传统分类网络</span>
</span></span><span class=line><span class=cl><span class=n>fc6</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span><span class=mi>512</span> <span class=o>*</span> <span class=mi>7</span> <span class=o>*</span> <span class=mi>7</span><span class=p>,</span> <span class=mi>4096</span><span class=p>)</span>  <span class=c1># 展平后全连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># FCN改造</span>
</span></span><span class=line><span class=cl><span class=n>fc6</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>7</span><span class=p>)</span>  <span class=c1># 7×7卷积</span>
</span></span><span class=line><span class=cl><span class=n>fc7</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>4096</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 1×1卷积</span>
</span></span><span class=line><span class=cl><span class=n>score</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>4096</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># 分类层</span></span></span></code></pre></div><p><strong>优势</strong>：</p><ul><li>接受任意尺寸输入</li><li>保留空间信息</li><li>输出热图（heatmap）</li></ul><h4 id=2-上采样upsampling>2. 上采样（Upsampling）<a class=anchor href=#2-%e4%b8%8a%e9%87%87%e6%a0%b7upsampling>#</a></h4><p>经过卷积和池化后，特征图尺寸缩小，需要恢复到原始分辨率。</p><p><strong>方法1：双线性插值上采样</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>upsampled</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>interpolate</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>scale_factor</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;bilinear&#39;</span><span class=p>)</span></span></span></code></pre></div><p><strong>方法2：转置卷积（Transposed Convolution）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 也称为反卷积（Deconvolution）</span>
</span></span><span class=line><span class=cl><span class=n>upsample</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>in_channels</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>out_channels</span><span class=o>=</span><span class=n>num_classes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>kernel_size</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>padding</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>转置卷积原理</strong>：</p><p>标准卷积：<code>输入4×4 → (kernel=3, stride=2) → 输出2×2</code>
转置卷积：<code>输入2×2 → (kernel=3, stride=2) → 输出4×4</code></p><h4 id=3-跳跃连接skip-connections>3. 跳跃连接（Skip Connections）<a class=anchor href=#3-%e8%b7%b3%e8%b7%83%e8%bf%9e%e6%8e%a5skip-connections>#</a></h4><p><strong>问题</strong>：直接32倍上采样会丢失细节</p><p><strong>解决方案</strong>：融合不同层的特征</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像 (H×W)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>conv1 → pool1 (H/2×W/2)  ←─┐
</span></span><span class=line><span class=cl>    ↓                      │ Skip
</span></span><span class=line><span class=cl>conv2 → pool2 (H/4×W/4)  ←─┼─┐
</span></span><span class=line><span class=cl>    ↓                      │ │ Skip
</span></span><span class=line><span class=cl>conv3 → pool3 (H/8×W/8)  ←─┼─┼─┐
</span></span><span class=line><span class=cl>    ↓                      │ │ │
</span></span><span class=line><span class=cl>[卷积层]                   │ │ │
</span></span><span class=line><span class=cl>    ↓                      │ │ │
</span></span><span class=line><span class=cl>上采样2倍 + 融合pool3 ──────┘ │ │
</span></span><span class=line><span class=cl>    ↓                          │ │
</span></span><span class=line><span class=cl>上采样2倍 + 融合pool2 ──────────┘ │
</span></span><span class=line><span class=cl>    ↓                            │
</span></span><span class=line><span class=cl>上采样2倍 + 融合pool1 ────────────┘
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>输出 (H×W×C)</span></span></code></pre></div><p><strong>三种变体</strong>：</p><table><thead><tr><th>模型</th><th>上采样倍数</th><th>跳跃连接</th><th>性能</th></tr></thead><tbody><tr><td><strong>FCN-32s</strong></td><td>32倍</td><td>无</td><td>粗糙</td></tr><tr><td><strong>FCN-16s</strong></td><td>16倍</td><td>pool4</td><td>改善</td></tr><tr><td><strong>FCN-8s</strong></td><td>8倍</td><td>pool4 + pool3</td><td>最佳</td></tr></tbody></table><h4 id=4-fcn-8s架构代码>4. FCN-8s架构代码<a class=anchor href=#4-fcn-8s%e6%9e%b6%e6%9e%84%e4%bb%a3%e7%a0%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.nn</span> <span class=k>as</span> <span class=nn>nn</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch.nn.functional</span> <span class=k>as</span> <span class=nn>F</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FCN8s</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>21</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>FCN8s</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># VGG16的卷积层</span>
</span></span><span class=line><span class=cl>        <span class=c1># Block 1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu1_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu1_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pool1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>MaxPool2d</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ceil_mode</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Block 2</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu2_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu2_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pool2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>MaxPool2d</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ceil_mode</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Block 3</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu3_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu3_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu3_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pool3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>MaxPool2d</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ceil_mode</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Block 4</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv4_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu4_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv4_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu4_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv4_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu4_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pool4</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>MaxPool2d</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ceil_mode</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Block 5</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv5_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu5_1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv5_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu5_2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv5_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>512</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu5_3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pool5</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>MaxPool2d</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>ceil_mode</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># FC6-7替换为卷积</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc6</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu6</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>drop6</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout2d</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fc7</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>4096</span><span class=p>,</span> <span class=mi>4096</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu7</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>drop7</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Dropout2d</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 分类层</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>score_fr</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>4096</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>score_pool3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>score_pool4</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>512</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 上采样层</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upscore2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>num_classes</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upscore8</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>num_classes</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upscore_pool4</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>num_classes</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># VGG卷积</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu1_1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv1_1</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu1_2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv1_2</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pool1</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu2_1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv2_1</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu2_2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv2_2</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pool2</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu3_1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv3_1</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu3_2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv3_2</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu3_3</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv3_3</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pool3</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pool3</span> <span class=o>=</span> <span class=n>h</span>  <span class=c1># 保存pool3用于跳跃连接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu4_1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv4_1</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu4_2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv4_2</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu4_3</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv4_3</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pool4</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>pool4</span> <span class=o>=</span> <span class=n>h</span>  <span class=c1># 保存pool4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu5_1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv5_1</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu5_2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv5_2</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu5_3</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv5_3</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pool5</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># FC层</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu6</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fc6</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>drop6</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu7</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>fc7</span><span class=p>(</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>drop7</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>score_fr</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upscore2</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upscore2</span> <span class=o>=</span> <span class=n>h</span>  <span class=c1># 2倍上采样</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 融合pool4</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>score_pool4</span><span class=p>(</span><span class=n>pool4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>h</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>5</span><span class=p>:</span><span class=mi>5</span><span class=o>+</span><span class=n>upscore2</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>5</span><span class=p>:</span><span class=mi>5</span><span class=o>+</span><span class=n>upscore2</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>3</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=n>score_pool4c</span> <span class=o>=</span> <span class=n>h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>upscore2</span> <span class=o>+</span> <span class=n>score_pool4c</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upscore_pool4</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>upscore_pool4</span> <span class=o>=</span> <span class=n>h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 融合pool3</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>score_pool3</span><span class=p>(</span><span class=n>pool3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>h</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>9</span><span class=p>:</span><span class=mi>9</span><span class=o>+</span><span class=n>upscore_pool4</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>9</span><span class=p>:</span><span class=mi>9</span><span class=o>+</span><span class=n>upscore_pool4</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>3</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>        <span class=n>score_pool3c</span> <span class=o>=</span> <span class=n>h</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>upscore_pool4</span> <span class=o>+</span> <span class=n>score_pool3c</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upscore8</span><span class=p>(</span><span class=n>h</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>h</span> <span class=o>=</span> <span class=n>h</span><span class=p>[:,</span> <span class=p>:,</span> <span class=mi>31</span><span class=p>:</span><span class=mi>31</span><span class=o>+</span><span class=n>x</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>31</span><span class=p>:</span><span class=mi>31</span><span class=o>+</span><span class=n>x</span><span class=o>.</span><span class=n>size</span><span class=p>()[</span><span class=mi>3</span><span class=p>]]</span><span class=o>.</span><span class=n>contiguous</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>h</span></span></span></code></pre></div><h3 id=1113-训练技巧>11.1.3 训练技巧<a class=anchor href=#1113-%e8%ae%ad%e7%bb%83%e6%8a%80%e5%b7%a7>#</a></h3><h4 id=1-损失函数>1. 损失函数<a class=anchor href=#1-%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0>#</a></h4><p>像素级交叉熵损失：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>CrossEntropyLoss</span><span class=p>(</span><span class=n>ignore_index</span><span class=o>=</span><span class=mi>255</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>loss</span> <span class=o>=</span> <span class=n>criterion</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span></span></span></code></pre></div><p><strong>类别加权</strong>（处理类别不平衡）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 计算类别权重</span>
</span></span><span class=line><span class=cl><span class=n>class_weights</span> <span class=o>=</span> <span class=n>compute_class_weight</span><span class=p>(</span><span class=s1>&#39;balanced&#39;</span><span class=p>,</span> <span class=n>classes</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>criterion</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>CrossEntropyLoss</span><span class=p>(</span><span class=n>weight</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>FloatTensor</span><span class=p>(</span><span class=n>class_weights</span><span class=p>))</span></span></span></code></pre></div><h4 id=2-评估指标>2. 评估指标<a class=anchor href=#2-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87>#</a></h4><p><strong>IoU（Intersection over Union）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_iou</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ious</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>pred</span> <span class=o>=</span> <span class=n>pred</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=bp>cls</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_classes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pred_cls</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred</span> <span class=o>==</span> <span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>target_cls</span> <span class=o>=</span> <span class=p>(</span><span class=n>target</span> <span class=o>==</span> <span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>intersection</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred_cls</span> <span class=o>&amp;</span> <span class=n>target_cls</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=o>.</span><span class=n>float</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>union</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred_cls</span> <span class=o>|</span> <span class=n>target_cls</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=o>.</span><span class=n>float</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>union</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ious</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>float</span><span class=p>(</span><span class=s1>&#39;nan&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>ious</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>intersection</span> <span class=o>/</span> <span class=n>union</span><span class=p>)</span><span class=o>.</span><span class=n>item</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ious</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mIoU (mean IoU)</span>
</span></span><span class=line><span class=cl><span class=n>mean_iou</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>nanmean</span><span class=p>(</span><span class=n>ious</span><span class=p>)</span></span></span></code></pre></div><h3 id=1114-fcn的局限>11.1.4 FCN的局限<a class=anchor href=#1114-fcn%e7%9a%84%e5%b1%80%e9%99%90>#</a></h3><ol><li><strong>感受野受限</strong>：由backbone决定</li><li><strong>边界粗糙</strong>：8倍下采样仍有细节丢失</li><li><strong>小物体效果差</strong>：多次下采样导致信息损失</li><li><strong>训练慢</strong>：需要大量像素级标注</li></ol><hr><h2 id=112-u-net编码器-解码器架构>11.2 U-Net：编码器-解码器架构<a class=anchor href=#112-u-net%e7%bc%96%e7%a0%81%e5%99%a8-%e8%a7%a3%e7%a0%81%e5%99%a8%e6%9e%b6%e6%9e%84>#</a></h2><p><strong>论文</strong>：U-Net: Convolutional Networks for Biomedical Image Segmentation (MICCAI 2015)
<strong>作者</strong>：Olaf Ronneberger, Philipp Fischer, Thomas Brox</p><h3 id=1121-为什么u-net如此成功>11.2.1 为什么U-Net如此成功？<a class=anchor href=#1121-%e4%b8%ba%e4%bb%80%e4%b9%88u-net%e5%a6%82%e6%ad%a4%e6%88%90%e5%8a%9f>#</a></h3><p>U-Net最初为医学图像分割设计，但其架构设计如此优雅，成为了语义分割的经典范式。</p><p><strong>核心优势</strong>：</p><ol><li><strong>对称的编码器-解码器结构</strong></li><li><strong>密集的跳跃连接</strong></li><li><strong>数据增强策略</strong></li><li><strong>少量数据也能训练</strong></li></ol><h3 id=1122-架构设计>11.2.2 架构设计<a class=anchor href=#1122-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h3><h4 id=u型结构>U型结构<a class=anchor href=#u%e5%9e%8b%e7%bb%93%e6%9e%84>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像 (572×572×1)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>【编码器 Encoder】下采样路径
</span></span><span class=line><span class=cl>    conv 3×3, ReLU
</span></span><span class=line><span class=cl>    conv 3×3, ReLU
</span></span><span class=line><span class=cl>    max pool 2×2  → (280×280×64)  ─────┐
</span></span><span class=line><span class=cl>    ↓                                   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │
</span></span><span class=line><span class=cl>    max pool 2×2  → (136×136×128) ─────┼───┐
</span></span><span class=line><span class=cl>    ↓                                   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │   │
</span></span><span class=line><span class=cl>    max pool 2×2  → (64×64×256)   ─────┼───┼───┐
</span></span><span class=line><span class=cl>    ↓                                   │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │   │   │
</span></span><span class=line><span class=cl>    max pool 2×2  → (28×28×512)   ─────┼───┼───┼───┐
</span></span><span class=line><span class=cl>    ↓                                   │   │   │   │
</span></span><span class=line><span class=cl>【Bottleneck】                          │   │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                      │   │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU  → (24×24×1024)      │   │   │   │
</span></span><span class=line><span class=cl>    ↓                                   │   │   │   │
</span></span><span class=line><span class=cl>【解码器 Decoder】上采样路径             │   │   │   │
</span></span><span class=line><span class=cl>    up-conv 2×2 → (48×48×512)           │   │   │   │
</span></span><span class=line><span class=cl>    concat ←────────────────────────────┘   │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                          │   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                          │   │   │
</span></span><span class=line><span class=cl>    ↓                                       │   │   │
</span></span><span class=line><span class=cl>    up-conv 2×2 → (96×96×256)               │   │   │
</span></span><span class=line><span class=cl>    concat ←────────────────────────────────┘   │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                              │   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                              │   │
</span></span><span class=line><span class=cl>    ↓                                           │   │
</span></span><span class=line><span class=cl>    up-conv 2×2 → (192×192×128)                 │   │
</span></span><span class=line><span class=cl>    concat ←────────────────────────────────────┘   │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                                  │
</span></span><span class=line><span class=cl>    conv 3×3, ReLU                                  │
</span></span><span class=line><span class=cl>    ↓                                               │
</span></span><span class=line><span class=cl>    up-conv 2×2 → (384×384×64)                      │
</span></span><span class=line><span class=cl>    concat ←────────────────────────────────────────┘
</span></span><span class=line><span class=cl>    conv 3×3, ReLU
</span></span><span class=line><span class=cl>    conv 3×3, ReLU
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>    conv 1×1 → (388×388×2)  输出</span></span></code></pre></div><h4 id=关键组件>关键组件<a class=anchor href=#%e5%85%b3%e9%94%ae%e7%bb%84%e4%bb%b6>#</a></h4><p><strong>1. 下采样路径（Encoder）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>down_block</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><p><strong>2. 上采样路径（Decoder）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>up_block</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><p><strong>3. 跳跃连接（Skip Connections）</strong></p><p>U-Net的跳跃连接通过**通道拼接（concatenation）**实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 编码器特征</span>
</span></span><span class=line><span class=cl><span class=n>encoder_feature</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (B, C, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解码器上采样</span>
</span></span><span class=line><span class=cl><span class=n>decoder_upsampled</span> <span class=o>=</span> <span class=n>upsample</span><span class=p>(</span><span class=n>decoder_input</span><span class=p>)</span>  <span class=c1># (B, C, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 拼接</span>
</span></span><span class=line><span class=cl><span class=n>combined</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>encoder_feature</span><span class=p>,</span> <span class=n>decoder_upsampled</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (B, 2C, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 继续卷积</span>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>conv</span><span class=p>(</span><span class=n>combined</span><span class=p>)</span></span></span></code></pre></div><p><strong>为什么用concat而不是add？</strong></p><ul><li>concat保留更多信息</li><li>让网络学习如何融合特征</li><li>提供更丰富的梯度</li></ul><h3 id=1123-完整实现>11.2.3 完整实现<a class=anchor href=#1123-%e5%ae%8c%e6%95%b4%e5%ae%9e%e7%8e%b0>#</a></h3><p>见代码文件：<a href=../../chapter29/code/chapter11_semantic_seg/unet_segmentation.py><code>unet_segmentation.py</code></a></p><h3 id=1124-训练策略>11.2.4 训练策略<a class=anchor href=#1124-%e8%ae%ad%e7%bb%83%e7%ad%96%e7%95%a5>#</a></h3><h4 id=1-数据增强>1. 数据增强<a class=anchor href=#1-%e6%95%b0%e6%8d%ae%e5%a2%9e%e5%bc%ba>#</a></h4><p>医学图像数据少，需要强力增强：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>albumentations</span> <span class=k>as</span> <span class=nn>A</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>train_transform</span> <span class=o>=</span> <span class=n>A</span><span class=o>.</span><span class=n>Compose</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>HorizontalFlip</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>VerticalFlip</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>RandomRotate90</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>ShiftScaleRotate</span><span class=p>(</span><span class=n>shift_limit</span><span class=o>=</span><span class=mf>0.0625</span><span class=p>,</span> <span class=n>scale_limit</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span> <span class=n>rotate_limit</span><span class=o>=</span><span class=mi>45</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>ElasticTransform</span><span class=p>(</span><span class=n>alpha</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>  <span class=c1># 弹性变形</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>GridDistortion</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.5</span><span class=p>),</span>  <span class=c1># 网格扭曲</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>RandomBrightnessContrast</span><span class=p>(</span><span class=n>p</span><span class=o>=</span><span class=mf>0.3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>A</span><span class=o>.</span><span class=n>Normalize</span><span class=p>(</span><span class=n>mean</span><span class=o>=</span><span class=p>(</span><span class=mf>0.485</span><span class=p>,),</span> <span class=n>std</span><span class=o>=</span><span class=p>(</span><span class=mf>0.229</span><span class=p>,))</span>
</span></span><span class=line><span class=cl><span class=p>])</span></span></span></code></pre></div><h4 id=2-加权损失>2. 加权损失<a class=anchor href=#2-%e5%8a%a0%e6%9d%83%e6%8d%9f%e5%a4%b1>#</a></h4><p>处理边界和小目标：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>WeightedBCELoss</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>weight_map</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>weight_map</span> <span class=o>=</span> <span class=n>weight_map</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>bce</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>binary_cross_entropy_with_logits</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>reduction</span><span class=o>=</span><span class=s1>&#39;none&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>weighted_bce</span> <span class=o>=</span> <span class=n>bce</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>weight_map</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>weighted_bce</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 计算权重图</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_weight_map</span><span class=p>(</span><span class=n>mask</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 边界权重更高</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>scipy.ndimage</span> <span class=kn>import</span> <span class=n>distance_transform_edt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>distances</span> <span class=o>=</span> <span class=n>distance_transform_edt</span><span class=p>(</span><span class=n>mask</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=n>distances</span> <span class=o>**</span> <span class=mi>2</span> <span class=o>/</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>sigma</span> <span class=o>**</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>weights</span></span></span></code></pre></div><h4 id=3-dice-loss>3. Dice Loss<a class=anchor href=#3-dice-loss>#</a></h4><p>医学图像分割常用Dice Loss：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>DiceLoss</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>smooth</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>smooth</span> <span class=o>=</span> <span class=n>smooth</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pred</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>sigmoid</span><span class=p>(</span><span class=n>pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>intersection</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred</span> <span class=o>*</span> <span class=n>target</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>union</span> <span class=o>=</span> <span class=n>pred</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span> <span class=o>+</span> <span class=n>target</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dice</span> <span class=o>=</span> <span class=p>(</span><span class=mf>2.</span> <span class=o>*</span> <span class=n>intersection</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>smooth</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>union</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>smooth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span> <span class=o>-</span> <span class=n>dice</span><span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合损失</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CombinedLoss</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>alpha</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>=</span> <span class=n>alpha</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bce</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>BCEWithLogitsLoss</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>dice</span> <span class=o>=</span> <span class=n>DiceLoss</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>bce</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>dice</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span></span></span></code></pre></div><h3 id=1125-u-net变体>11.2.5 U-Net变体<a class=anchor href=#1125-u-net%e5%8f%98%e4%bd%93>#</a></h3><h4 id=1-attention-u-net>1. Attention U-Net<a class=anchor href=#1-attention-u-net>#</a></h4><p>添加注意力机制：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AttentionBlock</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>F_g</span><span class=p>,</span> <span class=n>F_l</span><span class=p>,</span> <span class=n>F_int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>W_g</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>F_g</span><span class=p>,</span> <span class=n>F_int</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>W_x</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>F_l</span><span class=p>,</span> <span class=n>F_int</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>psi</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>F_int</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relu</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sigmoid</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sigmoid</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>g1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>W_g</span><span class=p>(</span><span class=n>g</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>x1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>W_x</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>psi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=n>g1</span> <span class=o>+</span> <span class=n>x1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>psi</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>sigmoid</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>psi</span><span class=p>(</span><span class=n>psi</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span> <span class=o>*</span> <span class=n>psi</span>  <span class=c1># 加权特征</span></span></span></code></pre></div><h4 id=2-res-unet>2. Res-UNet<a class=anchor href=#2-res-unet>#</a></h4><p>加入残差连接：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResidualBlock</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bn1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bn2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>shortcut</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>in_channels</span> <span class=o>!=</span> <span class=n>out_channels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>shortcut</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>residual</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>shortcut</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bn1</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv1</span><span class=p>(</span><span class=n>x</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bn2</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv2</span><span class=p>(</span><span class=n>out</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>+=</span> <span class=n>residual</span>
</span></span><span class=line><span class=cl>        <span class=n>out</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>out</span></span></span></code></pre></div><h4 id=3-u-net>3. U-Net++<a class=anchor href=#3-u-net>#</a></h4><p>多尺度嵌套U-Net：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>X^0,0 → X^0,1 → X^0,2 → X^0,3 → X^0,4
</span></span><span class=line><span class=cl>  ↓ ↘     ↓ ↘     ↓ ↘     ↓ ↘
</span></span><span class=line><span class=cl>X^1,0 → X^1,1 → X^1,2 → X^1,3
</span></span><span class=line><span class=cl>  ↓ ↘     ↓ ↘     ↓ ↘
</span></span><span class=line><span class=cl>X^2,0 → X^2,1 → X^2,2
</span></span><span class=line><span class=cl>  ↓ ↘     ↓ ↘
</span></span><span class=line><span class=cl>X^3,0 → X^3,1
</span></span><span class=line><span class=cl>  ↓ ↘
</span></span><span class=line><span class=cl>X^4,0</span></span></code></pre></div><hr><h2 id=113-deeplab系列空洞卷积>11.3 DeepLab系列：空洞卷积<a class=anchor href=#113-deeplab%e7%b3%bb%e5%88%97%e7%a9%ba%e6%b4%9e%e5%8d%b7%e7%a7%af>#</a></h2><p><strong>论文系列</strong>：</p><ul><li>DeepLab v1 (ICLR 2015)</li><li>DeepLab v2 (TPAMI 2017)</li><li>DeepLab v3 (arXiv 2017)</li><li>DeepLab v3+ (ECCV 2018)</li></ul><h3 id=1131-核心创新空洞卷积>11.3.1 核心创新：空洞卷积<a class=anchor href=#1131-%e6%a0%b8%e5%bf%83%e5%88%9b%e6%96%b0%e7%a9%ba%e6%b4%9e%e5%8d%b7%e7%a7%af>#</a></h3><p><strong>标准卷积的局限</strong>：</p><p>为了扩大感受野，需要：</p><ol><li>增加卷积层深度</li><li>使用更大的卷积核</li><li>池化操作</li></ol><p>但这些都会导致：</p><ul><li>分辨率下降</li><li>参数量增加</li><li>计算成本上升</li></ul><p><strong>空洞卷积（Atrous Convolution / Dilated Convolution）</strong>：</p><p>在不增加参数和计算量的情况下，扩大感受野。</p><p><strong>原理</strong>：</p><p>标准3×3卷积（rate=1）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>× × ×
</span></span><span class=line><span class=cl>× × ×
</span></span><span class=line><span class=cl>× × ×</span></span></code></pre></div><p>空洞卷积（rate=2）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>×  ·  ×  ·  ×
</span></span><span class=line><span class=cl>·  ·  ·  ·  ·
</span></span><span class=line><span class=cl>×  ·  ×  ·  ×
</span></span><span class=line><span class=cl>·  ·  ·  ·  ·
</span></span><span class=line><span class=cl>×  ·  ×  ·  ×</span></span></code></pre></div><p>空洞卷积（rate=4）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>×  ·  ·  ·  ×  ·  ·  ·  ×
</span></span><span class=line><span class=cl>·  ·  ·  ·  ·  ·  ·  ·  ·
</span></span><span class=line><span class=cl>·  ·  ·  ·  ·  ·  ·  ·  ·
</span></span><span class=line><span class=cl>·  ·  ·  ·  ·  ·  ·  ·  ·
</span></span><span class=line><span class=cl>×  ·  ·  ·  ×  ·  ·  ·  ×</span></span></code></pre></div><p><strong>PyTorch实现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 标准卷积：感受野3×3</span>
</span></span><span class=line><span class=cl><span class=n>conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 空洞卷积：感受野5×5，但参数量相同</span>
</span></span><span class=line><span class=cl><span class=n>atrous_conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 空洞卷积：感受野9×9</span>
</span></span><span class=line><span class=cl><span class=n>atrous_conv2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span></span></span></code></pre></div><p><strong>感受野计算</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>receptive_field = (kernel_size - 1) * dilation + 1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kernel=3, dilation=1 → RF = 3
</span></span><span class=line><span class=cl>kernel=3, dilation=2 → RF = 5
</span></span><span class=line><span class=cl>kernel=3, dilation=4 → RF = 9
</span></span><span class=line><span class=cl>kernel=3, dilation=8 → RF = 17</span></span></code></pre></div><h3 id=1132-asppatrous-spatial-pyramid-pooling>11.3.2 ASPP（Atrous Spatial Pyramid Pooling）<a class=anchor href=#1132-asppatrous-spatial-pyramid-pooling>#</a></h3><p><strong>灵感来源</strong>：SPP（Spatial Pyramid Pooling）</p><p><strong>核心思想</strong>：并行使用多个不同膨胀率的空洞卷积，捕获多尺度信息。</p><p><strong>DeepLab v2的ASPP</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入特征图
</span></span><span class=line><span class=cl>    ├── rate=6  空洞卷积  ──┐
</span></span><span class=line><span class=cl>    ├── rate=12 空洞卷积  ──┤
</span></span><span class=line><span class=cl>    ├── rate=18 空洞卷积  ──┤ Concatenate
</span></span><span class=line><span class=cl>    └── rate=24 空洞卷积  ──┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>       1×1卷积融合
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>        输出特征</span></span></code></pre></div><p><strong>DeepLab v3的ASPP</strong>：</p><p>改进版本，添加全局池化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ASPP</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=o>=</span><span class=mi>256</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 1×1卷积</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3×3空洞卷积，rate=6</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3×3空洞卷积，rate=12</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>12</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3×3空洞卷积，rate=18</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv4</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>dilation</span><span class=o>=</span><span class=mi>18</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 全局平均池化</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>global_avg_pool</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>AdaptiveAvgPool2d</span><span class=p>((</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 融合</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>project</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>out_channels</span> <span class=o>*</span> <span class=mi>5</span><span class=p>,</span> <span class=n>out_channels</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>BatchNorm2d</span><span class=p>(</span><span class=n>out_channels</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>ReLU</span><span class=p>(</span><span class=n>inplace</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Dropout</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 并行分支</span>
</span></span><span class=line><span class=cl>        <span class=n>feat1</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>feat2</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conv2</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>feat3</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conv3</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>feat4</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>conv4</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>feat5</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>interpolate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>global_avg_pool</span><span class=p>(</span><span class=n>x</span><span class=p>),</span> <span class=n>size</span><span class=o>=</span><span class=n>size</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;bilinear&#39;</span><span class=p>,</span> <span class=n>align_corners</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 拼接</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>feat1</span><span class=p>,</span> <span class=n>feat2</span><span class=p>,</span> <span class=n>feat3</span><span class=p>,</span> <span class=n>feat4</span><span class=p>,</span> <span class=n>feat5</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 融合</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>project</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span></span></span></code></pre></div><h3 id=1133-deeplab-v3架构>11.3.3 DeepLab v3+架构<a class=anchor href=#1133-deeplab-v3%e6%9e%b6%e6%9e%84>#</a></h3><p>DeepLab v3+结合了：</p><ul><li><strong>Encoder-Decoder结构</strong>（借鉴U-Net）</li><li><strong>ASPP模块</strong>（多尺度特征）</li><li><strong>Xception Backbone</strong>（深度可分离卷积）</li></ul><p><strong>整体架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>【Encoder】
</span></span><span class=line><span class=cl>Xception Backbone
</span></span><span class=line><span class=cl>    ├── 低层特征 (1/4) ──────────────┐
</span></span><span class=line><span class=cl>    ↓                              │
</span></span><span class=line><span class=cl>ASPP模块                           │
</span></span><span class=line><span class=cl>    ↓                              │
</span></span><span class=line><span class=cl>1×1卷积 (降维到256)                 │
</span></span><span class=line><span class=cl>    ↓                              │
</span></span><span class=line><span class=cl>上采样4倍                           │
</span></span><span class=line><span class=cl>    ↓                              │
</span></span><span class=line><span class=cl>【Decoder】                         │
</span></span><span class=line><span class=cl>    ├─ 拼接 ←──────────────────────┘
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>3×3卷积
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>3×3卷积
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>上采样4倍
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>输出 (原始分辨率)</span></span></code></pre></div><p><strong>使用torchvision实现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torchvision.models.segmentation</span> <span class=k>as</span> <span class=nn>segmentation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载预训练DeepLab v3</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>segmentation</span><span class=o>.</span><span class=n>deeplabv3_resnet50</span><span class=p>(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>21</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或使用MobileNetV3作为backbone（更轻量）</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>segmentation</span><span class=o>.</span><span class=n>deeplabv3_mobilenet_v3_large</span><span class=p>(</span><span class=n>pretrained</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>21</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推理</span>
</span></span><span class=line><span class=cl><span class=n>model</span><span class=o>.</span><span class=n>eval</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=n>image</span><span class=p>)[</span><span class=s1>&#39;out&#39;</span><span class=p>]</span>  <span class=c1># 注意返回字典</span>
</span></span><span class=line><span class=cl>    <span class=n>prediction</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span></span></span></code></pre></div><h3 id=1134-性能对比>11.3.4 性能对比<a class=anchor href=#1134-%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94>#</a></h3><p><strong>PASCAL VOC 2012 test set</strong>：</p><table><thead><tr><th>模型</th><th>Backbone</th><th>mIoU (%)</th></tr></thead><tbody><tr><td>FCN-8s</td><td>VGG16</td><td>62.2</td></tr><tr><td>DeepLab v2</td><td>ResNet-101</td><td>79.7</td></tr><tr><td>DeepLab v3</td><td>ResNet-101</td><td>85.7</td></tr><tr><td>DeepLab v3+</td><td>Xception-65</td><td>87.8</td></tr><tr><td>DeepLab v3+</td><td>Xception-71</td><td>89.0</td></tr></tbody></table><p><strong>优势</strong>：</p><ul><li>空洞卷积：保持分辨率</li><li>ASPP：多尺度感受野</li><li>Decoder：恢复边界细节</li></ul><hr><h2 id=114-实战医学图像分割>11.4 实战：医学图像分割<a class=anchor href=#114-%e5%ae%9e%e6%88%98%e5%8c%bb%e5%ad%a6%e5%9b%be%e5%83%8f%e5%88%86%e5%89%b2>#</a></h2><h3 id=1141-项目目标>11.4.1 项目目标<a class=anchor href=#1141-%e9%a1%b9%e7%9b%ae%e7%9b%ae%e6%a0%87>#</a></h3><p>使用U-Net实现肺部CT图像的分割。</p><p><strong>数据集</strong>：Medical Segmentation Decathlon - Lung Task</p><ul><li>训练集：64个CT扫描</li><li>每个扫描包含多个切片</li><li>标注：肺部区域mask</li></ul><h3 id=1142-数据准备>11.4.2 数据准备<a class=anchor href=#1142-%e6%95%b0%e6%8d%ae%e5%87%86%e5%a4%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>nibabel</span> <span class=k>as</span> <span class=nn>nib</span>  <span class=c1># 读取医学图像格式</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch.utils.data</span> <span class=kn>import</span> <span class=n>Dataset</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LungCTDataset</span><span class=p>(</span><span class=n>Dataset</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_paths</span><span class=p>,</span> <span class=n>mask_paths</span><span class=p>,</span> <span class=n>transform</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>image_paths</span> <span class=o>=</span> <span class=n>image_paths</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mask_paths</span> <span class=o>=</span> <span class=n>mask_paths</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>transform</span> <span class=o>=</span> <span class=n>transform</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>image_paths</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 读取NIfTI格式</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>nib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>image_paths</span><span class=p>[</span><span class=n>idx</span><span class=p>])</span><span class=o>.</span><span class=n>get_fdata</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=n>nib</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mask_paths</span><span class=p>[</span><span class=n>idx</span><span class=p>])</span><span class=o>.</span><span class=n>get_fdata</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 归一化</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=p>(</span><span class=n>image</span> <span class=o>-</span> <span class=n>image</span><span class=o>.</span><span class=n>min</span><span class=p>())</span> <span class=o>/</span> <span class=p>(</span><span class=n>image</span><span class=o>.</span><span class=n>max</span><span class=p>()</span> <span class=o>-</span> <span class=n>image</span><span class=o>.</span><span class=n>min</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 转换为tensor</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>FloatTensor</span><span class=p>(</span><span class=n>image</span><span class=p>)</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (1, H, W)</span>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 应用数据增强</span>
</span></span><span class=line><span class=cl>            <span class=n>augmented</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>transform</span><span class=p>(</span><span class=n>image</span><span class=o>=</span><span class=n>image</span><span class=o>.</span><span class=n>numpy</span><span class=p>(),</span> <span class=n>mask</span><span class=o>=</span><span class=n>mask</span><span class=o>.</span><span class=n>numpy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>image</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>FloatTensor</span><span class=p>(</span><span class=n>augmented</span><span class=p>[</span><span class=s1>&#39;image&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>LongTensor</span><span class=p>(</span><span class=n>augmented</span><span class=p>[</span><span class=s1>&#39;mask&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>image</span><span class=p>,</span> <span class=n>mask</span></span></span></code></pre></div><h3 id=1143-训练流程>11.4.3 训练流程<a class=anchor href=#1143-%e8%ae%ad%e7%bb%83%e6%b5%81%e7%a8%8b>#</a></h3><p>完整代码见：<a href=../../chapter29/code/chapter11_semantic_seg/unet_segmentation.py><code>code/chapter11_semantic_seg/unet_segmentation.py</code></a></p><h3 id=1144-评估指标>11.4.4 评估指标<a class=anchor href=#1144-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_dice_score</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Dice系数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>smooth</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>    <span class=n>pred_flat</span> <span class=o>=</span> <span class=n>pred</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target_flat</span> <span class=o>=</span> <span class=n>target</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>intersection</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred_flat</span> <span class=o>*</span> <span class=n>target_flat</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>dice</span> <span class=o>=</span> <span class=p>(</span><span class=mf>2.</span> <span class=o>*</span> <span class=n>intersection</span> <span class=o>+</span> <span class=n>smooth</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>pred_flat</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>+</span> <span class=n>target_flat</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span> <span class=o>+</span> <span class=n>smooth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dice</span><span class=o>.</span><span class=n>item</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_hausdorff_distance</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Hausdorff距离（边界精度）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>scipy.spatial.distance</span> <span class=kn>import</span> <span class=n>directed_hausdorff</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pred_points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argwhere</span><span class=p>(</span><span class=n>pred</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>target_points</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argwhere</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>forward</span> <span class=o>=</span> <span class=n>directed_hausdorff</span><span class=p>(</span><span class=n>pred_points</span><span class=p>,</span> <span class=n>target_points</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>backward</span> <span class=o>=</span> <span class=n>directed_hausdorff</span><span class=p>(</span><span class=n>target_points</span><span class=p>,</span> <span class=n>pred_points</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>forward</span><span class=p>,</span> <span class=n>backward</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=本章小结>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><h3 id=核心知识点>核心知识点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e7%9f%a5%e8%af%86%e7%82%b9>#</a></h3><ol><li><p><strong>FCN（2015）</strong></p><ul><li>全卷积网络，开创像素级预测</li><li>转置卷积上采样</li><li>跳跃连接融合多尺度特征</li></ul></li><li><p><strong>U-Net（2015）</strong></p><ul><li>对称的编码器-解码器结构</li><li>密集的跳跃连接（concatenation）</li><li>医学图像分割的金标准</li><li>少量数据也能训练</li></ul></li><li><p><strong>DeepLab系列（2015-2018）</strong></p><ul><li>空洞卷积：扩大感受野，保持分辨率</li><li>ASPP：多尺度特征提取</li><li>Encoder-Decoder：恢复边界细节</li></ul></li></ol><h3 id=技术对比>技术对比<a class=anchor href=#%e6%8a%80%e6%9c%af%e5%af%b9%e6%af%94>#</a></h3><table><thead><tr><th>模型</th><th>核心技术</th><th>优势</th><th>局限</th></tr></thead><tbody><tr><td><strong>FCN</strong></td><td>全卷积+跳跃连接</td><td>开创性，简单</td><td>边界粗糙</td></tr><tr><td><strong>U-Net</strong></td><td>对称结构+密集连接</td><td>少量数据，边界精确</td><td>内存占用大</td></tr><tr><td><strong>DeepLab</strong></td><td>空洞卷积+ASPP</td><td>多尺度，高分辨率</td><td>计算量大</td></tr></tbody></table><h3 id=实践建议>实践建议<a class=anchor href=#%e5%ae%9e%e8%b7%b5%e5%bb%ba%e8%ae%ae>#</a></h3><ol><li><strong>医学图像分割</strong>：首选U-Net</li><li><strong>自然图像分割</strong>：DeepLab v3+</li><li><strong>实时应用</strong>：轻量化backbone（MobileNet）</li><li><strong>小数据集</strong>：强数据增强 + U-Net</li><li><strong>类别不平衡</strong>：Dice Loss + Focal Loss</li></ol><h3 id=下一步-1>下一步<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5-1>#</a></h3><p>在<a href=../chapter12/README.md>第12章</a>，我们将学习实例分割，了解如何区分同一类别的不同个体，掌握Mask R-CNN和YOLOv8-Seg的实现。</p><hr><p><strong>参考资源</strong>：</p><ul><li><a href=https://arxiv.org/abs/1411.4038>FCN论文</a></li><li><a href=https://arxiv.org/abs/1505.04597>U-Net论文</a></li><li><a href=https://arxiv.org/abs/1802.02611>DeepLab v3+论文</a></li><li><a href=https://mmsegmentation.readthedocs.io/>MMSegmentation文档</a></li></ul><hr><h1 id=第12章实例分割-1>第12章：实例分割<a class=anchor href=#%e7%ac%ac12%e7%ab%a0%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2-1>#</a></h1><blockquote class=book-hint><p>从Mask R-CNN到YOLOv8-Seg，掌握实例级分割技术</p></blockquote><h2 id=本章概览-1>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88-1>#</a></h2><p>实例分割（Instance Segmentation）是目标检测和语义分割的结合：不仅要识别每个像素的类别，还要区分同一类别的不同个体。</p><p><strong>核心内容</strong>：</p><ul><li>Mask R-CNN如何扩展Faster R-CNN</li><li>YOLACT如何实现实时实例分割</li><li>YOLOv8-Seg的统一框架设计</li><li>COCO实例分割实战项目</li></ul><h2 id=实例分割-vs-语义分割>实例分割 vs 语义分割<a class=anchor href=#%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2-vs-%e8%af%ad%e4%b9%89%e5%88%86%e5%89%b2>#</a></h2><h3 id=任务对比>任务对比<a class=anchor href=#%e4%bb%bb%e5%8a%a1%e5%af%b9%e6%af%94>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>场景：街道上有3辆汽车
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【语义分割】输出：
</span></span><span class=line><span class=cl>  像素分类图：
</span></span><span class=line><span class=cl>  - 像素(100,200) → 类别: 汽车
</span></span><span class=line><span class=cl>  - 像素(300,150) → 类别: 汽车
</span></span><span class=line><span class=cl>  - 像素(500,400) → 类别: 汽车
</span></span><span class=line><span class=cl>  所有汽车像素标记为同一类别
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【实例分割】输出：
</span></span><span class=line><span class=cl>  实例掩码:
</span></span><span class=line><span class=cl>  - 汽车1的mask
</span></span><span class=line><span class=cl>  - 汽车2的mask
</span></span><span class=line><span class=cl>  - 汽车3的mask
</span></span><span class=line><span class=cl>  每辆汽车有独立的mask</span></span></code></pre></div><h3 id=应用场景-1>应用场景<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af-1>#</a></h3><table><thead><tr><th>任务类型</th><th>应用场景</th><th>示例</th></tr></thead><tbody><tr><td><strong>语义分割</strong></td><td>场景理解</td><td>道路分割、天空分割</td></tr><tr><td><strong>实例分割</strong></td><td>个体计数</td><td>车辆统计、人群分析</td></tr><tr><td><strong>实例分割</strong></td><td>机器人抓取</td><td>识别每个物体的位置</td></tr><tr><td><strong>实例分割</strong></td><td>医学分析</td><td>细胞计数、器官分割</td></tr></tbody></table><hr><h2 id=121-mask-r-cnn原理>12.1 Mask R-CNN原理<a class=anchor href=#121-mask-r-cnn%e5%8e%9f%e7%90%86>#</a></h2><p><strong>论文</strong>：Mask R-CNN (ICCV 2017)
<strong>作者</strong>：Kaiming He, Georgia Gkioxari, Piotr Dollár, Ross Girshick (Facebook AI Research)</p><h3 id=1211-核心思想>12.1.1 核心思想<a class=anchor href=#1211-%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3>#</a></h3><p>Mask R-CNN = Faster R-CNN + Mask分支</p><p><strong>Faster R-CNN回顾</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Backbone (ResNet/FPN)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>RPN (Region Proposal Network)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>RoI Pooling
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>分类 + 边界框回归</span></span></code></pre></div><p><strong>Mask R-CNN扩展</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Backbone + FPN
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>RPN
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>RoI Align (替代RoI Pooling)
</span></span><span class=line><span class=cl>    ├── 分类分支 → 类别
</span></span><span class=line><span class=cl>    ├── 边界框分支 → 坐标
</span></span><span class=line><span class=cl>    └── Mask分支 → 像素级掩码</span></span></code></pre></div><h3 id=1212-关键创新>12.1.2 关键创新<a class=anchor href=#1212-%e5%85%b3%e9%94%ae%e5%88%9b%e6%96%b0>#</a></h3><h4 id=1-roi-align>1. RoI Align<a class=anchor href=#1-roi-align>#</a></h4><p><strong>RoI Pooling的问题</strong>：</p><p>RoI Pooling涉及两次量化（quantization）：</p><ol><li>将RoI边界量化到特征图网格</li><li>将RoI划分为bins时的量化</li></ol><p><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>原始RoI: [12.4, 8.7, 45.2, 31.9]
</span></span><span class=line><span class=cl>量化后:   [12,   8,   45,   31  ]  ← 丢失小数部分</span></span></code></pre></div><p>这种量化会导致<strong>像素级对齐误差</strong>，对分割任务影响很大。</p><p><strong>RoI Align的解决方案</strong>：</p><p>使用<strong>双线性插值</strong>避免量化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># RoI Align伪代码</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>roi_align</span><span class=p>(</span><span class=n>feature_map</span><span class=p>,</span> <span class=n>roi</span><span class=p>,</span> <span class=n>output_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    feature_map: 特征图
</span></span></span><span class=line><span class=cl><span class=s2>    roi: [x1, y1, x2, y2]（保留小数）
</span></span></span><span class=line><span class=cl><span class=s2>    output_size: 输出尺寸 (7, 7)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算每个bin的精确位置（不量化）</span>
</span></span><span class=line><span class=cl>    <span class=n>bin_height</span> <span class=o>=</span> <span class=p>(</span><span class=n>roi</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>-</span> <span class=n>roi</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span> <span class=o>/</span> <span class=n>output_size</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>bin_width</span> <span class=o>=</span> <span class=p>(</span><span class=n>roi</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>-</span> <span class=n>roi</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>/</span> <span class=n>output_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>output_size</span><span class=p>[</span><span class=mi>0</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>output_size</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 计算bin的精确边界</span>
</span></span><span class=line><span class=cl>            <span class=n>y_start</span> <span class=o>=</span> <span class=n>roi</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>+</span> <span class=n>i</span> <span class=o>*</span> <span class=n>bin_height</span>
</span></span><span class=line><span class=cl>            <span class=n>x_start</span> <span class=o>=</span> <span class=n>roi</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=n>j</span> <span class=o>*</span> <span class=n>bin_width</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 在bin内采样4个点（或更多）</span>
</span></span><span class=line><span class=cl>            <span class=n>sampling_points</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>y_start</span> <span class=o>+</span> <span class=mf>0.25</span> <span class=o>*</span> <span class=n>bin_height</span><span class=p>,</span> <span class=n>x_start</span> <span class=o>+</span> <span class=mf>0.25</span> <span class=o>*</span> <span class=n>bin_width</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>y_start</span> <span class=o>+</span> <span class=mf>0.25</span> <span class=o>*</span> <span class=n>bin_height</span><span class=p>,</span> <span class=n>x_start</span> <span class=o>+</span> <span class=mf>0.75</span> <span class=o>*</span> <span class=n>bin_width</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>y_start</span> <span class=o>+</span> <span class=mf>0.75</span> <span class=o>*</span> <span class=n>bin_height</span><span class=p>,</span> <span class=n>x_start</span> <span class=o>+</span> <span class=mf>0.25</span> <span class=o>*</span> <span class=n>bin_width</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>y_start</span> <span class=o>+</span> <span class=mf>0.75</span> <span class=o>*</span> <span class=n>bin_height</span><span class=p>,</span> <span class=n>x_start</span> <span class=o>+</span> <span class=mf>0.75</span> <span class=o>*</span> <span class=n>bin_width</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 对每个采样点使用双线性插值</span>
</span></span><span class=line><span class=cl>            <span class=n>values</span> <span class=o>=</span> <span class=p>[</span><span class=n>bilinear_interpolate</span><span class=p>(</span><span class=n>feature_map</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>y</span><span class=p>,</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>sampling_points</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 聚合（max pooling或average）</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=nb>max</span><span class=p>(</span><span class=n>values</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>output</span></span></span></code></pre></div><p><strong>效果对比</strong>：</p><ul><li>RoI Pooling：AP50 = 55.3%</li><li>RoI Align：AP50 = 58.7% (+3.4%)</li></ul><h4 id=2-mask分支>2. Mask分支<a class=anchor href=#2-mask%e5%88%86%e6%94%af>#</a></h4><p><strong>架构设计</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MaskHead</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>80</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4个3×3卷积（保持分辨率）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv4</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 转置卷积（上采样2倍）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>deconv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ConvTranspose2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 每个类别一个mask</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>predictor</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># x: RoI Align输出 (N, 256, 14, 14)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv1</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv2</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv3</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv4</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>deconv</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>  <span class=c1># (N, 256, 28, 28)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>predictor</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (N, num_classes, 28, 28)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mask</span></span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>输入：14×14的RoI特征</li><li>输出：28×28的mask预测（每个类别一个）</li><li>使用FCN风格的全卷积架构</li></ul><h4 id=3-损失函数>3. 损失函数<a class=anchor href=#3-%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0>#</a></h4><p>Mask R-CNN的总损失：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>L = L_cls + L_box + L_mask
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>其中：
</span></span><span class=line><span class=cl>  L_cls: 分类损失（交叉熵）
</span></span><span class=line><span class=cl>  L_box: 边界框回归损失（Smooth L1）
</span></span><span class=line><span class=cl>  L_mask: Mask损失（二元交叉熵）</span></span></code></pre></div><p><strong>关键设计</strong>：Mask损失是<strong>per-class</strong>的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>mask_loss</span><span class=p>(</span><span class=n>mask_pred</span><span class=p>,</span> <span class=n>mask_target</span><span class=p>,</span> <span class=n>labels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    mask_pred: (N, num_classes, H, W)
</span></span></span><span class=line><span class=cl><span class=s2>    mask_target: (N, H, W)
</span></span></span><span class=line><span class=cl><span class=s2>    labels: (N,) - 每个RoI的真实类别
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>N</span> <span class=o>=</span> <span class=n>mask_pred</span><span class=o>.</span><span class=n>size</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>N</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 只计算真实类别的mask损失</span>
</span></span><span class=line><span class=cl>        <span class=bp>cls</span> <span class=o>=</span> <span class=n>labels</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>pred</span> <span class=o>=</span> <span class=n>mask_pred</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=bp>cls</span><span class=p>]</span>  <span class=c1># (H, W)</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=n>mask_target</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>   <span class=c1># (H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 二元交叉熵</span>
</span></span><span class=line><span class=cl>        <span class=n>loss</span> <span class=o>+=</span> <span class=n>F</span><span class=o>.</span><span class=n>binary_cross_entropy_with_logits</span><span class=p>(</span><span class=n>pred</span><span class=p>,</span> <span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>loss</span> <span class=o>/</span> <span class=n>N</span></span></span></code></pre></div><p>这样设计的好处：</p><ul><li>分类和分割解耦</li><li>避免类间竞争</li><li>每个类别独立优化</li></ul><h3 id=1213-使用detectron2>12.1.3 使用Detectron2<a class=anchor href=#1213-%e4%bd%bf%e7%94%a8detectron2>#</a></h3><p>Facebook开源的Detectron2提供了完整的Mask R-CNN实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detectron2.engine</span> <span class=kn>import</span> <span class=n>DefaultPredictor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detectron2.config</span> <span class=kn>import</span> <span class=n>get_cfg</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detectron2</span> <span class=kn>import</span> <span class=n>model_zoo</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>cv2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置</span>
</span></span><span class=line><span class=cl><span class=n>cfg</span> <span class=o>=</span> <span class=n>get_cfg</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>cfg</span><span class=o>.</span><span class=n>merge_from_file</span><span class=p>(</span><span class=n>model_zoo</span><span class=o>.</span><span class=n>get_config_file</span><span class=p>(</span><span class=s2>&#34;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>cfg</span><span class=o>.</span><span class=n>MODEL</span><span class=o>.</span><span class=n>WEIGHTS</span> <span class=o>=</span> <span class=n>model_zoo</span><span class=o>.</span><span class=n>get_checkpoint_url</span><span class=p>(</span><span class=s2>&#34;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cfg</span><span class=o>.</span><span class=n>MODEL</span><span class=o>.</span><span class=n>ROI_HEADS</span><span class=o>.</span><span class=n>SCORE_THRESH_TEST</span> <span class=o>=</span> <span class=mf>0.5</span>  <span class=c1># 置信度阈值</span>
</span></span><span class=line><span class=cl><span class=n>cfg</span><span class=o>.</span><span class=n>MODEL</span><span class=o>.</span><span class=n>DEVICE</span> <span class=o>=</span> <span class=s2>&#34;cuda&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建预测器</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span> <span class=o>=</span> <span class=n>DefaultPredictor</span><span class=p>(</span><span class=n>cfg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推理</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>cv2</span><span class=o>.</span><span class=n>imread</span><span class=p>(</span><span class=s2>&#34;test.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>=</span> <span class=n>predictor</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 提取结果</span>
</span></span><span class=line><span class=cl><span class=n>instances</span> <span class=o>=</span> <span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;instances&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=s2>&#34;cpu&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>boxes</span> <span class=o>=</span> <span class=n>instances</span><span class=o>.</span><span class=n>pred_boxes</span><span class=o>.</span><span class=n>tensor</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>  <span class=c1># 边界框</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>instances</span><span class=o>.</span><span class=n>pred_masks</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>  <span class=c1># 实例掩码 (N, H, W)</span>
</span></span><span class=line><span class=cl><span class=n>classes</span> <span class=o>=</span> <span class=n>instances</span><span class=o>.</span><span class=n>pred_classes</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>  <span class=c1># 类别</span>
</span></span><span class=line><span class=cl><span class=n>scores</span> <span class=o>=</span> <span class=n>instances</span><span class=o>.</span><span class=n>scores</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span>  <span class=c1># 置信度</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可视化</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detectron2.utils.visualizer</span> <span class=kn>import</span> <span class=n>Visualizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>detectron2.data</span> <span class=kn>import</span> <span class=n>MetadataCatalog</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>Visualizer</span><span class=p>(</span><span class=n>image</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>::</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>MetadataCatalog</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cfg</span><span class=o>.</span><span class=n>DATASETS</span><span class=o>.</span><span class=n>TRAIN</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=n>scale</span><span class=o>=</span><span class=mf>1.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>out</span> <span class=o>=</span> <span class=n>v</span><span class=o>.</span><span class=n>draw_instance_predictions</span><span class=p>(</span><span class=n>instances</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cv2</span><span class=o>.</span><span class=n>imwrite</span><span class=p>(</span><span class=s2>&#34;result.jpg&#34;</span><span class=p>,</span> <span class=n>out</span><span class=o>.</span><span class=n>get_image</span><span class=p>()[:,</span> <span class=p>:,</span> <span class=p>::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span></span></span></code></pre></div><h3 id=1214-mask-r-cnn变体>12.1.4 Mask R-CNN变体<a class=anchor href=#1214-mask-r-cnn%e5%8f%98%e4%bd%93>#</a></h3><h4 id=1-cascade-mask-r-cnn>1. Cascade Mask R-CNN<a class=anchor href=#1-cascade-mask-r-cnn>#</a></h4><p>多阶段精化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>RPN
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Stage 1: IoU threshold=0.5
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Stage 2: IoU threshold=0.6
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Stage 3: IoU threshold=0.7
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>最终预测</span></span></code></pre></div><h4 id=2-pointrend>2. PointRend<a class=anchor href=#2-pointrend>#</a></h4><p>高分辨率边界精化：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>粗糙mask (28×28)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>上采样到原始分辨率
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>选择不确定的点（边界附近）
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>对这些点进行高分辨率推理
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>精细mask</span></span></code></pre></div><hr><h2 id=122-yolact实时实例分割>12.2 YOLACT：实时实例分割<a class=anchor href=#122-yolact%e5%ae%9e%e6%97%b6%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2>#</a></h2><p><strong>论文</strong>：YOLACT: Real-time Instance Segmentation (ICCV 2019)
<strong>作者</strong>：Daniel Bolya et al. (UC Davis)</p><h3 id=1221-核心思想>12.2.1 核心思想<a class=anchor href=#1221-%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3>#</a></h3><p><strong>Mask R-CNN的问题</strong>：</p><ul><li>串行处理：先检测再分割</li><li>速度慢：~5 FPS</li></ul><p><strong>YOLACT的方案</strong>：并行生成原型mask和系数</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ├── Protonet分支 → 原型masks (k个基础mask)
</span></span><span class=line><span class=cl>    └── 检测分支 → 边界框 + 类别 + mask系数
</span></span><span class=line><span class=cl>                    ↓
</span></span><span class=line><span class=cl>            线性组合原型masks
</span></span><span class=line><span class=cl>                    ↓
</span></span><span class=line><span class=cl>            实例masks</span></span></code></pre></div><p><strong>数学表达</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>M = σ(P × C^T)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>其中：
</span></span><span class=line><span class=cl>  M: 最终mask (H×W)
</span></span><span class=line><span class=cl>  P: 原型masks (H×W×k)
</span></span><span class=line><span class=cl>  C: mask系数 (k×1)
</span></span><span class=line><span class=cl>  σ: sigmoid激活</span></span></code></pre></div><h3 id=1222-架构设计>12.2.2 架构设计<a class=anchor href=#1222-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h3><h4 id=1-protonet>1. Protonet<a class=anchor href=#1-protonet>#</a></h4><p>生成k个原型masks：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Protonet</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_protos</span><span class=o>=</span><span class=mi>32</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv1</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv2</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conv3</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 上采样</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>upsample</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Upsample</span><span class=p>(</span><span class=n>scale_factor</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;bilinear&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 生成原型</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>final_conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_protos</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv1</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv2</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>F</span><span class=o>.</span><span class=n>relu</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>conv3</span><span class=p>(</span><span class=n>x</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>upsample</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>protos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>final_conv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (B, k, H, W)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>protos</span></span></span></code></pre></div><h4 id=2-prediction-head>2. Prediction Head<a class=anchor href=#2-prediction-head>#</a></h4><p>在检测头添加mask系数预测：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>PredictionHead</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>in_channels</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>num_classes</span><span class=o>=</span><span class=mi>80</span><span class=p>,</span> <span class=n>num_protos</span><span class=o>=</span><span class=mi>32</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 类别预测</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>class_conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>num_classes</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 边界框预测</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>box_conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Mask系数预测</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coef_conv</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=n>in_channels</span><span class=p>,</span> <span class=n>num_protos</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>classes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>class_conv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>boxes</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>box_conv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>coefs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>coef_conv</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (B, k, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>classes</span><span class=p>,</span> <span class=n>boxes</span><span class=p>,</span> <span class=n>coefs</span></span></span></code></pre></div><h4 id=3-mask-assembly>3. Mask Assembly<a class=anchor href=#3-mask-assembly>#</a></h4><p>组装最终mask：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>assemble_masks</span><span class=p>(</span><span class=n>protos</span><span class=p>,</span> <span class=n>coefs</span><span class=p>,</span> <span class=n>boxes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    protos: (H, W, k) - 原型masks
</span></span></span><span class=line><span class=cl><span class=s2>    coefs: (n, k) - n个实例的系数
</span></span></span><span class=line><span class=cl><span class=s2>    boxes: (n, 4) - 边界框
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 线性组合</span>
</span></span><span class=line><span class=cl>    <span class=n>masks</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>protos</span><span class=p>,</span> <span class=n>coefs</span><span class=o>.</span><span class=n>t</span><span class=p>())</span>  <span class=c1># (H, W, n)</span>
</span></span><span class=line><span class=cl>    <span class=n>masks</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>sigmoid</span><span class=p>(</span><span class=n>masks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 裁剪到边界框内</span>
</span></span><span class=line><span class=cl>    <span class=n>masks</span> <span class=o>=</span> <span class=n>crop_masks</span><span class=p>(</span><span class=n>masks</span><span class=p>,</span> <span class=n>boxes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>masks</span></span></span></code></pre></div><h3 id=1223-性能特点>12.2.3 性能特点<a class=anchor href=#1223-%e6%80%a7%e8%83%bd%e7%89%b9%e7%82%b9>#</a></h3><p><strong>COCO test-dev</strong>：</p><table><thead><tr><th>模型</th><th>Backbone</th><th>mAP</th><th>FPS (Titan Xp)</th></tr></thead><tbody><tr><td>Mask R-CNN</td><td>ResNet-101-FPN</td><td>37.1</td><td>5</td></tr><tr><td>YOLACT-550</td><td>ResNet-101-FPN</td><td>29.8</td><td>33</td></tr><tr><td>YOLACT-700</td><td>ResNet-101-FPN</td><td>31.2</td><td>23</td></tr></tbody></table><p><strong>优势</strong>：</p><ul><li>速度快：30+ FPS</li><li>端到端训练</li><li>架构简单</li></ul><p><strong>劣势</strong>：</p><ul><li>精度略低于Mask R-CNN</li><li>原型数量k需要调优</li></ul><hr><h2 id=123-yolov8-segyolo的分割版本>12.3 YOLOv8-Seg：YOLO的分割版本<a class=anchor href=#123-yolov8-segyolo%e7%9a%84%e5%88%86%e5%89%b2%e7%89%88%e6%9c%ac>#</a></h2><p><strong>发布时间</strong>：2023年1月
<strong>开发者</strong>：Ultralytics</p><h3 id=1231-核心特性>12.3.1 核心特性<a class=anchor href=#1231-%e6%a0%b8%e5%bf%83%e7%89%b9%e6%80%a7>#</a></h3><p>YOLOv8-Seg = YOLOv8检测 + 分割头</p><p><strong>架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>【Backbone】CSPDarknet + C2f
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>【Neck】PAN-FPN
</span></span><span class=line><span class=cl>    ├── 检测分支
</span></span><span class=line><span class=cl>    │   ├── 类别预测
</span></span><span class=line><span class=cl>    │   └── 边界框预测
</span></span><span class=line><span class=cl>    └── 分割分支
</span></span><span class=line><span class=cl>        ├── Prototype生成（类似YOLACT）
</span></span><span class=line><span class=cl>        └── Mask系数预测</span></span></code></pre></div><h3 id=1232-模型变体>12.3.2 模型变体<a class=anchor href=#1232-%e6%a8%a1%e5%9e%8b%e5%8f%98%e4%bd%93>#</a></h3><p>YOLOv8-Seg提供5个尺寸：</p><table><thead><tr><th>模型</th><th>mAP^box</th><th>mAP^mask</th><th>速度 (A100)</th><th>参数量</th></tr></thead><tbody><tr><td>YOLOv8n-seg</td><td>36.7</td><td>30.5</td><td>96 FPS</td><td>3.4M</td></tr><tr><td>YOLOv8s-seg</td><td>44.6</td><td>36.8</td><td>77 FPS</td><td>11.8M</td></tr><tr><td>YOLOv8m-seg</td><td>49.9</td><td>40.8</td><td>53 FPS</td><td>27.3M</td></tr><tr><td>YOLOv8l-seg</td><td>52.3</td><td>42.6</td><td>39 FPS</td><td>46.0M</td></tr><tr><td>YOLOv8x-seg</td><td>53.4</td><td>43.4</td><td>28 FPS</td><td>71.8M</td></tr></tbody></table><p><strong>YOLO11-Seg更新</strong>（2024年9月）：</p><table><thead><tr><th>模型</th><th>mAP^box</th><th>mAP^mask</th><th>参数量</th><th>改进</th></tr></thead><tbody><tr><td>YOLO11n-seg</td><td>38.9</td><td>32.0</td><td>2.9M</td><td>更轻量</td></tr><tr><td>YOLO11s-seg</td><td>46.6</td><td>37.8</td><td>10.1M</td><td>+2.0 mAP</td></tr><tr><td>YOLO11m-seg</td><td>51.5</td><td>41.5</td><td>22.4M</td><td>+1.6 mAP</td></tr><tr><td>YOLO11l-seg</td><td>53.4</td><td>42.9</td><td>27.6M</td><td>+1.1 mAP</td></tr><tr><td>YOLO11x-seg</td><td>54.7</td><td>43.8</td><td>62.1M</td><td>+1.3 mAP</td></tr></tbody></table><h3 id=1233-使用示例>12.3.3 使用示例<a class=anchor href=#1233-%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b>#</a></h3><p>见代码文件：<a href=../../chapter29/code/chapter12_instance_seg/yolov8_instance_seg.py><code>yolov8_instance_seg.py</code></a></p><h3 id=1234-训练自定义数据>12.3.4 训练自定义数据<a class=anchor href=#1234-%e8%ae%ad%e7%bb%83%e8%87%aa%e5%ae%9a%e4%b9%89%e6%95%b0%e6%8d%ae>#</a></h3><h4 id=1-数据格式>1. 数据格式<a class=anchor href=#1-%e6%95%b0%e6%8d%ae%e6%a0%bc%e5%bc%8f>#</a></h4><p>YOLO分割格式（每行一个实例）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>class_id x1 y1 x2 y2 x3 y3 ... xn yn</span></span></code></pre></div><p>坐标归一化到[0, 1]。</p><p><strong>示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># person.txt
</span></span><span class=line><span class=cl>0 0.1 0.2 0.3 0.2 0.3 0.8 0.1 0.8  # 人的轮廓多边形</span></span></code></pre></div><h4 id=2-数据集配置>2. 数据集配置<a class=anchor href=#2-%e6%95%b0%e6%8d%ae%e9%9b%86%e9%85%8d%e7%bd%ae>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># custom_seg.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/path/to/dataset</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>train</span><span class=p>:</span><span class=w> </span><span class=l>images/train</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>val</span><span class=p>:</span><span class=w> </span><span class=l>images/val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>nc</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=c># 类别数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>names</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;person&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;car&#39;</span><span class=p>]</span></span></span></code></pre></div><h4 id=3-训练代码>3. 训练代码<a class=anchor href=#3-%e8%ae%ad%e7%bb%83%e4%bb%a3%e7%a0%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>ultralytics</span> <span class=kn>import</span> <span class=n>YOLO</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载预训练模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>YOLO</span><span class=p>(</span><span class=s1>&#39;yolo11n-seg.pt&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 训练</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>train</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s1>&#39;custom_seg.yaml&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>epochs</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>imgsz</span><span class=o>=</span><span class=mi>640</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>batch</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>device</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>workers</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 分割特定参数</span>
</span></span><span class=line><span class=cl>    <span class=n>overlap_mask</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># mask重叠</span>
</span></span><span class=line><span class=cl>    <span class=n>mask_ratio</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>  <span class=c1># mask下采样比例</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 数据增强</span>
</span></span><span class=line><span class=cl>    <span class=n>degrees</span><span class=o>=</span><span class=mf>10.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>translate</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>scale</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>mosaic</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>mixup</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h2 id=124-实战实例分割项目>12.4 实战：实例分割项目<a class=anchor href=#124-%e5%ae%9e%e6%88%98%e5%ae%9e%e4%be%8b%e5%88%86%e5%89%b2%e9%a1%b9%e7%9b%ae>#</a></h2><h3 id=1241-项目目标>12.4.1 项目目标<a class=anchor href=#1241-%e9%a1%b9%e7%9b%ae%e7%9b%ae%e6%a0%87>#</a></h3><p>使用YOLO11-Seg在COCO数据集上进行实例分割。</p><p><strong>任务</strong>：</p><ol><li>加载预训练模型</li><li>在自定义图像上推理</li><li>可视化分割结果</li><li>导出ONNX模型</li></ol><h3 id=1242-完整代码>12.4.2 完整代码<a class=anchor href=#1242-%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81>#</a></h3><p>见代码文件：<a href=../../chapter29/code/chapter12_instance_seg/yolov8_instance_seg.py><code>yolov8_instance_seg.py</code></a></p><h3 id=1243-评估指标>12.4.3 评估指标<a class=anchor href=#1243-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87>#</a></h3><h4 id=1-mask-map>1. Mask mAP<a class=anchor href=#1-mask-map>#</a></h4><p>与目标检测mAP类似，但用mask IoU代替box IoU：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>compute_mask_iou</span><span class=p>(</span><span class=n>mask1</span><span class=p>,</span> <span class=n>mask2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算两个mask的IoU&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>intersection</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>logical_and</span><span class=p>(</span><span class=n>mask1</span><span class=p>,</span> <span class=n>mask2</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>union</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>logical_or</span><span class=p>(</span><span class=n>mask1</span><span class=p>,</span> <span class=n>mask2</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>union</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>intersection</span> <span class=o>/</span> <span class=n>union</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># COCO评估</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pycocotools.cocoeval</span> <span class=kn>import</span> <span class=n>COCOeval</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>coco_eval</span> <span class=o>=</span> <span class=n>COCOeval</span><span class=p>(</span><span class=n>coco_gt</span><span class=p>,</span> <span class=n>coco_dt</span><span class=p>,</span> <span class=s1>&#39;segm&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>coco_eval</span><span class=o>.</span><span class=n>evaluate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>coco_eval</span><span class=o>.</span><span class=n>accumulate</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>coco_eval</span><span class=o>.</span><span class=n>summarize</span><span class=p>()</span></span></span></code></pre></div><h4 id=2-边界精度>2. 边界精度<a class=anchor href=#2-%e8%be%b9%e7%95%8c%e7%b2%be%e5%ba%a6>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>boundary_iou</span><span class=p>(</span><span class=n>pred_mask</span><span class=p>,</span> <span class=n>gt_mask</span><span class=p>,</span> <span class=n>dilation_ratio</span><span class=o>=</span><span class=mf>0.02</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算边界IoU&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>scipy.ndimage</span> <span class=kn>import</span> <span class=n>binary_dilation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 提取边界</span>
</span></span><span class=line><span class=cl>    <span class=n>pred_boundary</span> <span class=o>=</span> <span class=n>binary_dilation</span><span class=p>(</span><span class=n>pred_mask</span><span class=p>)</span> <span class=o>^</span> <span class=n>pred_mask</span>
</span></span><span class=line><span class=cl>    <span class=n>gt_boundary</span> <span class=o>=</span> <span class=n>binary_dilation</span><span class=p>(</span><span class=n>gt_mask</span><span class=p>)</span> <span class=o>^</span> <span class=n>gt_mask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算IoU</span>
</span></span><span class=line><span class=cl>    <span class=n>intersection</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred_boundary</span> <span class=o>&amp;</span> <span class=n>gt_boundary</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>union</span> <span class=o>=</span> <span class=p>(</span><span class=n>pred_boundary</span> <span class=o>|</span> <span class=n>gt_boundary</span><span class=p>)</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>intersection</span> <span class=o>/</span> <span class=n>union</span> <span class=k>if</span> <span class=n>union</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span></span></span></code></pre></div><h3 id=1244-后处理技巧>12.4.4 后处理技巧<a class=anchor href=#1244-%e5%90%8e%e5%a4%84%e7%90%86%e6%8a%80%e5%b7%a7>#</a></h3><h4 id=1-mask平滑>1. Mask平滑<a class=anchor href=#1-mask%e5%b9%b3%e6%bb%91>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.ndimage</span> <span class=kn>import</span> <span class=n>gaussian_filter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>smooth_mask</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>sigma</span><span class=o>=</span><span class=mf>1.0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高斯平滑mask边界&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>smoothed</span> <span class=o>=</span> <span class=n>gaussian_filter</span><span class=p>(</span><span class=n>mask</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>float</span><span class=p>),</span> <span class=n>sigma</span><span class=o>=</span><span class=n>sigma</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>smoothed</span> <span class=o>&gt;</span> <span class=mf>0.5</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>uint8</span><span class=p>)</span></span></span></code></pre></div><h4 id=2-小区域过滤>2. 小区域过滤<a class=anchor href=#2-%e5%b0%8f%e5%8c%ba%e5%9f%9f%e8%bf%87%e6%bb%a4>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_small_regions</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>min_area</span><span class=o>=</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;移除小区域&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>skimage.measure</span> <span class=kn>import</span> <span class=n>label</span><span class=p>,</span> <span class=n>regionprops</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>labeled</span> <span class=o>=</span> <span class=n>label</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>region</span> <span class=ow>in</span> <span class=n>regionprops</span><span class=p>(</span><span class=n>labeled</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>region</span><span class=o>.</span><span class=n>area</span> <span class=o>&lt;</span> <span class=n>min_area</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span><span class=p>[</span><span class=n>labeled</span> <span class=o>==</span> <span class=n>region</span><span class=o>.</span><span class=n>label</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mask</span></span></span></code></pre></div><h4 id=3-mask融合>3. Mask融合<a class=anchor href=#3-mask%e8%9e%8d%e5%90%88>#</a></h4><p>处理重叠mask：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>merge_overlapping_masks</span><span class=p>(</span><span class=n>masks</span><span class=p>,</span> <span class=n>scores</span><span class=p>,</span> <span class=n>iou_threshold</span><span class=o>=</span><span class=mf>0.5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;合并重叠的mask&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>keep</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 按置信度排序</span>
</span></span><span class=line><span class=cl>    <span class=n>order</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>argsort</span><span class=p>(</span><span class=n>scores</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=n>order</span><span class=o>.</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span> <span class=o>=</span> <span class=n>order</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>keep</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算与其他mask的IoU</span>
</span></span><span class=line><span class=cl>        <span class=n>ious</span> <span class=o>=</span> <span class=p>[</span><span class=n>compute_mask_iou</span><span class=p>(</span><span class=n>masks</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>masks</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=n>order</span><span class=p>[</span><span class=mi>1</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保留IoU低的mask</span>
</span></span><span class=line><span class=cl>        <span class=n>inds</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>ious</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=n>iou_threshold</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>order</span><span class=p>[</span><span class=n>inds</span> <span class=o>+</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>keep</span></span></span></code></pre></div><hr><h2 id=本章小结-1>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1>#</a></h2><h3 id=核心知识点-1>核心知识点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e7%9f%a5%e8%af%86%e7%82%b9-1>#</a></h3><ol><li><p><strong>Mask R-CNN（2017）</strong></p><ul><li>RoI Align：精确的特征对齐</li><li>独立的Mask分支</li><li>Per-class mask预测</li><li>两阶段架构</li></ul></li><li><p><strong>YOLACT（2019）</strong></p><ul><li>原型masks + 线性组合</li><li>实时性能（30+ FPS）</li><li>并行处理</li></ul></li><li><p><strong>YOLOv8-Seg / YOLO11-Seg（2023-2024）</strong></p><ul><li>统一框架，多任务支持</li><li>Anchor-free设计</li><li>实时性能 + 高精度</li><li>易于训练和部署</li></ul></li></ol><h3 id=模型对比>模型对比<a class=anchor href=#%e6%a8%a1%e5%9e%8b%e5%af%b9%e6%af%94>#</a></h3><table><thead><tr><th>模型</th><th>架构</th><th>速度</th><th>精度</th><th>特点</th></tr></thead><tbody><tr><td><strong>Mask R-CNN</strong></td><td>两阶段</td><td>~5 FPS</td><td>高</td><td>精度高，速度慢</td></tr><tr><td><strong>YOLACT</strong></td><td>单阶段</td><td>30+ FPS</td><td>中</td><td>实时，精度中等</td></tr><tr><td><strong>YOLOv8-Seg</strong></td><td>单阶段</td><td>50+ FPS</td><td>中高</td><td>平衡性能</td></tr><tr><td><strong>YOLO11-Seg</strong></td><td>单阶段</td><td>50+ FPS</td><td>高</td><td>当前最优</td></tr></tbody></table><h3 id=选择建议>选择建议<a class=anchor href=#%e9%80%89%e6%8b%a9%e5%bb%ba%e8%ae%ae>#</a></h3><table><thead><tr><th>需求</th><th>推荐模型</th><th>理由</th></tr></thead><tbody><tr><td><strong>最高精度</strong></td><td>Mask R-CNN</td><td>学术研究</td></tr><tr><td><strong>实时应用</strong></td><td>YOLO11-Seg</td><td>工业部署</td></tr><tr><td><strong>边缘设备</strong></td><td>YOLO11n-seg</td><td>轻量级</td></tr><tr><td><strong>视频分析</strong></td><td>YOLOv8-Seg</td><td>速度快</td></tr></tbody></table><h3 id=实践建议-1>实践建议<a class=anchor href=#%e5%ae%9e%e8%b7%b5%e5%bb%ba%e8%ae%ae-1>#</a></h3><ol><li><p><strong>数据准备</strong>：</p><ul><li>使用COCO格式或YOLO格式</li><li>确保mask质量高</li><li>充分的数据增强</li></ul></li><li><p><strong>训练技巧</strong>：</p><ul><li>先用检测模型预训练</li><li>冻结backbone加速训练</li><li>使用组合损失（box + mask）</li></ul></li><li><p><strong>后处理</strong>：</p><ul><li>Mask平滑</li><li>小区域过滤</li><li>重叠处理</li></ul></li></ol><h3 id=下一步-2>下一步<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5-2>#</a></h3><p>在<a href=../chapter13/README.md>第13章</a>，我们将学习Segment Anything (SAM)，探索零样本分割的革命性技术，了解如何通过Prompt实现"万物分割"。</p><hr><p><strong>参考资源</strong>：</p><ul><li><a href=https://arxiv.org/abs/1703.06870>Mask R-CNN论文</a></li><li><a href=https://arxiv.org/abs/1904.02689>YOLACT论文</a></li><li><a href=https://docs.ultralytics.com/tasks/segment/>Ultralytics文档</a></li><li><a href=https://detectron2.readthedocs.io/>Detectron2文档</a></li></ul><hr><h1 id=第13章segment-anything-sam-1>第13章：Segment Anything (SAM)<a class=anchor href=#%e7%ac%ac13%e7%ab%a0segment-anything-sam-1>#</a></h1><blockquote class=book-hint><p>Meta的"万物分割"模型，零样本分割的革命性突破</p></blockquote><h2 id=本章概览-2>本章概览<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e6%a6%82%e8%a7%88-2>#</a></h2><p>Segment Anything Model (SAM) 是Meta AI在2023年4月发布的foundation model，开启了"万物分割"的新时代。SAM具有强大的零样本分割能力，可以在没有训练的情况下分割任意物体。</p><p><strong>核心内容</strong>：</p><ul><li>SAM的模型架构和训练策略</li><li>Prompt Engineering：点、框、mask提示</li><li>SAM 2：扩展到视频分割</li><li>实战：零样本分割应用</li></ul><h2 id=为什么sam是革命性的>为什么SAM是革命性的？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88sam%e6%98%af%e9%9d%a9%e5%91%bd%e6%80%a7%e7%9a%84>#</a></h2><h3 id=1-零样本分割能力>1. 零样本分割能力<a class=anchor href=#1-%e9%9b%b6%e6%a0%b7%e6%9c%ac%e5%88%86%e5%89%b2%e8%83%bd%e5%8a%9b>#</a></h3><p><strong>传统分割模型</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 只能分割训练时见过的类别</span>
</span></span><span class=line><span class=cl><span class=n>model_coco</span> <span class=o>=</span> <span class=n>SegmentationModel</span><span class=p>(</span><span class=n>classes</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;person&#39;</span><span class=p>,</span> <span class=s1>&#39;car&#39;</span><span class=p>,</span> <span class=s1>&#39;dog&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>mask</span> <span class=o>=</span> <span class=n>model_coco</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>  <span class=c1># 只能分割这3类</span></span></span></code></pre></div><p><strong>SAM</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 可以分割任意物体，无需训练</span>
</span></span><span class=line><span class=cl><span class=n>model_sam</span> <span class=o>=</span> <span class=n>SAM</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mask</span> <span class=o>=</span> <span class=n>model_sam</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>point</span><span class=o>=</span><span class=p>[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>200</span><span class=p>])</span>  <span class=c1># 分割点击的任何物体</span></span></span></code></pre></div><h3 id=2-promptable分割>2. Promptable分割<a class=anchor href=#2-promptable%e5%88%86%e5%89%b2>#</a></h3><p>SAM支持多种提示方式：</p><table><thead><tr><th>提示类型</th><th>描述</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>点击（Point）</strong></td><td>点击物体内部或外部</td><td>交互式分割</td></tr><tr><td><strong>边界框（Box）</strong></td><td>框选感兴趣区域</td><td>快速标注</td></tr><tr><td><strong>Mask</strong></td><td>提供粗糙mask</td><td>精细化分割</td></tr><tr><td><strong>文本（间接）</strong></td><td>通过Grounding DINO转换</td><td>语言驱动分割</td></tr></tbody></table><h3 id=3-强大的泛化能力>3. 强大的泛化能力<a class=anchor href=#3-%e5%bc%ba%e5%a4%a7%e7%9a%84%e6%b3%9b%e5%8c%96%e8%83%bd%e5%8a%9b>#</a></h3><ul><li>在SA-1B数据集上训练（11亿mask）</li><li>覆盖广泛的场景和物体</li><li>对新领域有良好的适应性</li></ul><hr><h2 id=131-sam模型架构>13.1 SAM模型架构<a class=anchor href=#131-sam%e6%a8%a1%e5%9e%8b%e6%9e%b6%e6%9e%84>#</a></h2><h3 id=1311-整体架构>13.1.1 整体架构<a class=anchor href=#1311-%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84>#</a></h3><p>SAM采用三阶段架构：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>输入图像 + Prompt
</span></span><span class=line><span class=cl>        ↓
</span></span><span class=line><span class=cl>【Image Encoder】
</span></span><span class=line><span class=cl>Vision Transformer (ViT)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Image Embeddings (一次性计算)
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>【Prompt Encoder】
</span></span><span class=line><span class=cl>    ├── 点 → 位置编码
</span></span><span class=line><span class=cl>    ├── 框 → 位置编码
</span></span><span class=line><span class=cl>    └── Mask → 卷积嵌入
</span></span><span class=line><span class=cl>        ↓
</span></span><span class=line><span class=cl>Prompt Embeddings
</span></span><span class=line><span class=cl>        ↓
</span></span><span class=line><span class=cl>【Mask Decoder】
</span></span><span class=line><span class=cl>Transformer Decoder
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>输出Masks (多个候选)</span></span></code></pre></div><h3 id=1312-image-encoder>13.1.2 Image Encoder<a class=anchor href=#1312-image-encoder>#</a></h3><p><strong>架构</strong>：Vision Transformer (ViT)</p><p>SAM使用预训练的ViT作为图像编码器：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ImageEncoderViT</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    SAM的图像编码器：ViT-H/16
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    配置：
</span></span></span><span class=line><span class=cl><span class=s2>    - 模型：ViT-Huge
</span></span></span><span class=line><span class=cl><span class=s2>    - Patch size：16×16
</span></span></span><span class=line><span class=cl><span class=s2>    - 输入分辨率：1024×1024
</span></span></span><span class=line><span class=cl><span class=s2>    - 嵌入维度：1280
</span></span></span><span class=line><span class=cl><span class=s2>    - 层数：32
</span></span></span><span class=line><span class=cl><span class=s2>    - 注意力头：16
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Patch Embedding</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patch_embed</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>1280</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Position Embedding</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pos_embed</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Parameter</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>64</span><span class=o>*</span><span class=mi>64</span><span class=p>,</span> <span class=mi>1280</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Transformer Blocks</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ModuleList</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=n>TransformerBlock</span><span class=p>(</span><span class=n>dim</span><span class=o>=</span><span class=mi>1280</span><span class=p>,</span> <span class=n>num_heads</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Neck（降维）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>neck</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>1280</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>LayerNorm2d</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>256</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>LayerNorm2d</span><span class=p>(</span><span class=mi>256</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># x: (B, 3, 1024, 1024)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Patch Embedding</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>patch_embed</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (B, 1280, 64, 64)</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>flatten</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>  <span class=c1># (B, 4096, 1280)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Add Position Embedding</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>pos_embed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Transformer Blocks</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>blocks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>x</span> <span class=o>=</span> <span class=n>block</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Reshape</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>1280</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Neck</span>
</span></span><span class=line><span class=cl>        <span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>neck</span><span class=p>(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># (B, 256, 64, 64)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span></span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>输入固定为1024×1024</li><li>只需计算一次（可缓存）</li><li>使用MAE预训练权重</li></ul><h3 id=1313-prompt-encoder>13.1.3 Prompt Encoder<a class=anchor href=#1313-prompt-encoder>#</a></h3><p><strong>点和框的编码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>PromptEncoder</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>embed_dim</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span> <span class=n>image_size</span><span class=o>=</span><span class=mi>1024</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 位置编码</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pe_layer</span> <span class=o>=</span> <span class=n>PositionalEncoding</span><span class=p>(</span><span class=n>embed_dim</span> <span class=o>//</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 点类型编码（前景/背景）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>point_embeddings</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=n>embed_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 不提供prompt时的嵌入</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>not_a_point_embed</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>embed_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_embed_points</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>points</span><span class=p>,</span> <span class=n>labels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        points: (B, N, 2) - 归一化坐标 [0, 1]
</span></span></span><span class=line><span class=cl><span class=s2>        labels: (B, N) - 1=前景, 0=背景, -1=ignore
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 位置编码</span>
</span></span><span class=line><span class=cl>        <span class=n>point_embedding</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pe_layer</span><span class=p>(</span><span class=n>points</span><span class=p>)</span>  <span class=c1># (B, N, 256)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加类型编码</span>
</span></span><span class=line><span class=cl>        <span class=n>point_embedding</span> <span class=o>+=</span> <span class=bp>self</span><span class=o>.</span><span class=n>point_embeddings</span><span class=p>(</span><span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>point_embedding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_embed_boxes</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>boxes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        boxes: (B, 4) - [x1, y1, x2, y2] 归一化
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 框编码为2个点（左上 + 右下）</span>
</span></span><span class=line><span class=cl>        <span class=n>top_left</span> <span class=o>=</span> <span class=n>boxes</span><span class=p>[:,</span> <span class=p>:</span><span class=mi>2</span><span class=p>]</span>  <span class=c1># (B, 2)</span>
</span></span><span class=line><span class=cl>        <span class=n>bottom_right</span> <span class=o>=</span> <span class=n>boxes</span><span class=p>[:,</span> <span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>corner_embedding</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_embed_points</span><span class=p>(</span><span class=n>top_left</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>1</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_embed_points</span><span class=p>(</span><span class=n>bottom_right</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>ones</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>corner_embedding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_embed_masks</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>masks</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        masks: (B, 1, H, W) - 提示mask
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用卷积编码</span>
</span></span><span class=line><span class=cl>        <span class=n>mask_embedding</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>mask_downscaling</span><span class=p>(</span><span class=n>masks</span><span class=p>)</span>  <span class=c1># (B, 256, 64, 64)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>mask_embedding</span></span></span></code></pre></div><p><strong>Mask的编码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>mask_downscaling</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Sequential</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>LayerNorm2d</span><span class=p>(</span><span class=mi>4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>nn</span><span class=o>.</span><span class=n>GELU</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>stride</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>LayerNorm2d</span><span class=p>(</span><span class=mi>16</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>nn</span><span class=o>.</span><span class=n>GELU</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>nn</span><span class=o>.</span><span class=n>Conv2d</span><span class=p>(</span><span class=mi>16</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h3 id=1314-mask-decoder>13.1.4 Mask Decoder<a class=anchor href=#1314-mask-decoder>#</a></h3><p><strong>轻量级Transformer Decoder</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MaskDecoder</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>transformer_dim</span><span class=o>=</span><span class=mi>256</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>num_multimask_outputs</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Transformer解码器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>transformer</span> <span class=o>=</span> <span class=n>TwoWayTransformer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>depth</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embedding_dim</span><span class=o>=</span><span class=n>transformer_dim</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>num_heads</span><span class=o>=</span><span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>mlp_dim</span><span class=o>=</span><span class=mi>2048</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Mask tokens（可学习的query）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iou_token</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>transformer_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mask_tokens</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Embedding</span><span class=p>(</span><span class=n>num_multimask_outputs</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>transformer_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 输出MLP</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iou_prediction_head</span> <span class=o>=</span> <span class=n>MLP</span><span class=p>(</span><span class=n>transformer_dim</span><span class=p>,</span> <span class=n>transformer_dim</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mask_prediction_heads</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>ModuleList</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=n>MLP</span><span class=p>(</span><span class=n>transformer_dim</span><span class=p>,</span> <span class=n>transformer_dim</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>num_multimask_outputs</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>image_embeddings</span><span class=p>,</span> <span class=n>prompt_embeddings</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        image_embeddings: (B, 256, 64, 64)
</span></span></span><span class=line><span class=cl><span class=s2>        prompt_embeddings: (B, N, 256)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>B</span> <span class=o>=</span> <span class=n>image_embeddings</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 准备tokens</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>iou_token</span><span class=o>.</span><span class=n>weight</span><span class=p>,</span>  <span class=c1># (1, 256)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>mask_tokens</span><span class=o>.</span><span class=n>weight</span><span class=p>,</span>  <span class=c1># (4, 256)</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>expand</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (B, 5, 256)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 组合prompt</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>tokens</span><span class=p>,</span> <span class=n>prompt_embeddings</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Transformer解码</span>
</span></span><span class=line><span class=cl>        <span class=n>src</span> <span class=o>=</span> <span class=n>image_embeddings</span><span class=o>.</span><span class=n>flatten</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>permute</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>  <span class=c1># (B, 4096, 256)</span>
</span></span><span class=line><span class=cl>        <span class=n>hs</span><span class=p>,</span> <span class=n>src</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>transformer</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 提取IoU token和mask tokens</span>
</span></span><span class=line><span class=cl>        <span class=n>iou_token_out</span> <span class=o>=</span> <span class=n>hs</span><span class=p>[:,</span> <span class=mi>0</span><span class=p>,</span> <span class=p>:]</span>  <span class=c1># (B, 256)</span>
</span></span><span class=line><span class=cl>        <span class=n>mask_tokens_out</span> <span class=o>=</span> <span class=n>hs</span><span class=p>[:,</span> <span class=mi>1</span><span class=p>:</span><span class=mi>5</span><span class=p>,</span> <span class=p>:]</span>  <span class=c1># (B, 4, 256)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 上采样到原始分辨率</span>
</span></span><span class=line><span class=cl>        <span class=n>src</span> <span class=o>=</span> <span class=n>src</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 预测masks</span>
</span></span><span class=line><span class=cl>        <span class=n>masks</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>mlp</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>mask_prediction_heads</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>mask_emb</span> <span class=o>=</span> <span class=n>mlp</span><span class=p>(</span><span class=n>mask_tokens_out</span><span class=p>[:,</span> <span class=n>i</span><span class=p>,</span> <span class=p>:])</span>  <span class=c1># (B, 256)</span>
</span></span><span class=line><span class=cl>            <span class=n>mask</span> <span class=o>=</span> <span class=p>(</span><span class=n>mask_emb</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>@</span> <span class=n>src</span><span class=o>.</span><span class=n>flatten</span><span class=p>(</span><span class=mi>2</span><span class=p>))</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>B</span><span class=p>,</span> <span class=mi>64</span><span class=p>,</span> <span class=mi>64</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>masks</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>masks</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>masks</span><span class=p>,</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># (B, 4, 64, 64)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 预测IoU</span>
</span></span><span class=line><span class=cl>        <span class=n>iou_pred</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>iou_prediction_head</span><span class=p>(</span><span class=n>iou_token_out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>masks</span><span class=p>,</span> <span class=n>iou_pred</span></span></span></code></pre></div><p><strong>输出</strong>：</p><ul><li>3个候选mask + 1个低质量mask</li><li>每个mask的IoU预测</li><li>选择IoU最高的mask作为最终结果</li></ul><hr><h2 id=132-prompt-engineering-for-sam>13.2 Prompt Engineering for SAM<a class=anchor href=#132-prompt-engineering-for-sam>#</a></h2><h3 id=1321-点击式分割>13.2.1 点击式分割<a class=anchor href=#1321-%e7%82%b9%e5%87%bb%e5%bc%8f%e5%88%86%e5%89%b2>#</a></h3><p><strong>单点提示</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>transformers</span> <span class=kn>import</span> <span class=n>SamModel</span><span class=p>,</span> <span class=n>SamProcessor</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载模型</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>SamModel</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;facebook/sam-vit-huge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>processor</span> <span class=o>=</span> <span class=n>SamProcessor</span><span class=o>.</span><span class=n>from_pretrained</span><span class=p>(</span><span class=s2>&#34;facebook/sam-vit-huge&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 准备输入</span>
</span></span><span class=line><span class=cl><span class=n>image</span> <span class=o>=</span> <span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=s2>&#34;cat.jpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>input_points</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>500</span><span class=p>,</span> <span class=mi>375</span><span class=p>]]]</span>  <span class=c1># 点击猫的中心</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>input_points</span><span class=o>=</span><span class=n>input_points</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推理</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>no_grad</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 后处理</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>image_processor</span><span class=o>.</span><span class=n>post_process_masks</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=o>.</span><span class=n>pred_masks</span><span class=o>.</span><span class=n>cpu</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;original_sizes&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>cpu</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;reshaped_input_sizes&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>cpu</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 选择最佳mask</span>
</span></span><span class=line><span class=cl><span class=n>iou_scores</span> <span class=o>=</span> <span class=n>outputs</span><span class=o>.</span><span class=n>iou_scores</span>
</span></span><span class=line><span class=cl><span class=n>best_mask</span> <span class=o>=</span> <span class=n>masks</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>iou_scores</span><span class=p>),</span> <span class=p>:,</span> <span class=p>:]</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span></span></span></code></pre></div><p><strong>多点提示</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 前景点 + 背景点</span>
</span></span><span class=line><span class=cl><span class=n>input_points</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>500</span><span class=p>,</span> <span class=mi>375</span><span class=p>],</span> <span class=p>[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>]]]</span>  <span class=c1># 2个点</span>
</span></span><span class=line><span class=cl><span class=n>point_labels</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]]</span>  <span class=c1># 1=前景, 0=背景</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_points</span><span class=o>=</span><span class=n>input_points</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_labels</span><span class=o>=</span><span class=n>point_labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>迭代优化</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第1次：点击物体</span>
</span></span><span class=line><span class=cl><span class=n>points</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>500</span><span class=p>,</span> <span class=mi>375</span><span class=p>]]</span>
</span></span><span class=line><span class=cl><span class=n>labels</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取初步mask</span>
</span></span><span class=line><span class=cl><span class=n>mask1</span> <span class=o>=</span> <span class=n>get_mask</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第2次：添加背景点（去除多余区域）</span>
</span></span><span class=line><span class=cl><span class=n>points</span><span class=o>.</span><span class=n>append</span><span class=p>([</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>labels</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取改进的mask</span>
</span></span><span class=line><span class=cl><span class=n>mask2</span> <span class=o>=</span> <span class=n>get_mask</span><span class=p>(</span><span class=n>points</span><span class=p>,</span> <span class=n>labels</span><span class=p>)</span></span></span></code></pre></div><h3 id=1322-边界框提示>13.2.2 边界框提示<a class=anchor href=#1322-%e8%be%b9%e7%95%8c%e6%a1%86%e6%8f%90%e7%a4%ba>#</a></h3><p><strong>框选物体</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 定义边界框 [x1, y1, x2, y2]</span>
</span></span><span class=line><span class=cl><span class=n>input_boxes</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>400</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>input_boxes</span><span class=o>=</span><span class=n>input_boxes</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>post_process_masks</span><span class=p>(</span><span class=n>outputs</span><span class=o>.</span><span class=n>pred_masks</span><span class=p>)</span></span></span></code></pre></div><p><strong>框 + 点组合</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 粗略框选 + 精确点击</span>
</span></span><span class=line><span class=cl><span class=n>input_boxes</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>400</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl><span class=n>input_points</span> <span class=o>=</span> <span class=p>[[[</span><span class=mi>300</span><span class=p>,</span> <span class=mi>250</span><span class=p>]]]</span>
</span></span><span class=line><span class=cl><span class=n>point_labels</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_boxes</span><span class=o>=</span><span class=n>input_boxes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_points</span><span class=o>=</span><span class=n>input_points</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_labels</span><span class=o>=</span><span class=n>point_labels</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h3 id=1323-mask提示>13.2.3 Mask提示<a class=anchor href=#1323-mask%e6%8f%90%e7%a4%ba>#</a></h3><p><strong>从粗糙mask到精细mask</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 提供一个粗糙的mask（例如从其他模型得到）</span>
</span></span><span class=line><span class=cl><span class=n>rough_mask</span> <span class=o>=</span> <span class=n>get_rough_mask</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>  <span class=c1># (H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用SAM精细化</span>
</span></span><span class=line><span class=cl><span class=n>input_masks</span> <span class=o>=</span> <span class=n>rough_mask</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># (1, 1, H, W)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>input_masks</span><span class=o>=</span><span class=n>input_masks</span><span class=p>,</span> <span class=n>return_tensors</span><span class=o>=</span><span class=s2>&#34;pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>=</span> <span class=n>model</span><span class=p>(</span><span class=o>**</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取精细化的mask</span>
</span></span><span class=line><span class=cl><span class=n>refined_mask</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>post_process_masks</span><span class=p>(</span><span class=n>outputs</span><span class=o>.</span><span class=n>pred_masks</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span></span></span></code></pre></div><h3 id=1324-自动分割everything-mode>13.2.4 自动分割（Everything Mode）<a class=anchor href=#1324-%e8%87%aa%e5%8a%a8%e5%88%86%e5%89%b2everything-mode>#</a></h3><p><strong>生成所有可能的mask</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>segment_anything</span> <span class=kn>import</span> <span class=n>SamAutomaticMaskGenerator</span><span class=p>,</span> <span class=n>sam_model_registry</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载模型</span>
</span></span><span class=line><span class=cl><span class=n>sam</span> <span class=o>=</span> <span class=n>sam_model_registry</span><span class=p>[</span><span class=s2>&#34;vit_h&#34;</span><span class=p>](</span><span class=n>checkpoint</span><span class=o>=</span><span class=s2>&#34;sam_vit_h.pth&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mask_generator</span> <span class=o>=</span> <span class=n>SamAutomaticMaskGenerator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>sam</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>points_per_side</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>  <span class=c1># 网格点数</span>
</span></span><span class=line><span class=cl>    <span class=n>pred_iou_thresh</span><span class=o>=</span><span class=mf>0.88</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>stability_score_thresh</span><span class=o>=</span><span class=mf>0.95</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>crop_n_layers</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>crop_n_points_downscale_factor</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>min_mask_region_area</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>  <span class=c1># 最小区域</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成所有masks</span>
</span></span><span class=line><span class=cl><span class=n>masks</span> <span class=o>=</span> <span class=n>mask_generator</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>image_np</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># masks是一个列表，每个元素包含：</span>
</span></span><span class=line><span class=cl><span class=c1># - segmentation: (H, W) bool array</span>
</span></span><span class=line><span class=cl><span class=c1># - area: int</span>
</span></span><span class=line><span class=cl><span class=c1># - bbox: [x, y, w, h]</span>
</span></span><span class=line><span class=cl><span class=c1># - predicted_iou: float</span>
</span></span><span class=line><span class=cl><span class=c1># - stability_score: float</span></span></span></code></pre></div><hr><h2 id=133-sam-2视频分割>13.3 SAM 2：视频分割<a class=anchor href=#133-sam-2%e8%a7%86%e9%a2%91%e5%88%86%e5%89%b2>#</a></h2><p><strong>发布时间</strong>：2024年7月
<strong>论文</strong>：SAM 2: Segment Anything in Images and Videos</p><h3 id=1331-核心改进>13.3.1 核心改进<a class=anchor href=#1331-%e6%a0%b8%e5%bf%83%e6%94%b9%e8%bf%9b>#</a></h3><p>SAM 2扩展了SAM的能力：</p><ol><li><strong>统一的图像和视频架构</strong></li><li><strong>流式记忆（Streaming Memory）</strong></li><li><strong>实时视频对象跟踪</strong></li></ol><p><strong>架构对比</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>【SAM】
</span></span><span class=line><span class=cl>图像 → Image Encoder → Prompt Encoder → Mask Decoder → Mask
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【SAM 2】
</span></span><span class=line><span class=cl>视频帧序列 → Image Encoder → Memory Bank ← 历史帧
</span></span><span class=line><span class=cl>                                ↓
</span></span><span class=line><span class=cl>                        Prompt Encoder + Memory Attention
</span></span><span class=line><span class=cl>                                ↓
</span></span><span class=line><span class=cl>                        Mask Decoder → Masks</span></span></code></pre></div><h3 id=1332-memory-mechanism>13.3.2 Memory Mechanism<a class=anchor href=#1332-memory-mechanism>#</a></h3><p><strong>流式记忆</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryBank</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_size</span><span class=o>=</span><span class=mi>7</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>memory</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span> <span class=o>=</span> <span class=n>max_size</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>update</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>frame_embedding</span><span class=p>,</span> <span class=n>mask</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加新帧的特征和mask&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;embedding&#39;</span><span class=p>:</span> <span class=n>frame_embedding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;mask&#39;</span><span class=p>:</span> <span class=n>mask</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保持固定大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=p>)</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_context</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取历史上下文&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>embeddings</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;embedding&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>masks</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;mask&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>memory</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>embeddings</span><span class=p>),</span> <span class=n>torch</span><span class=o>.</span><span class=n>stack</span><span class=p>(</span><span class=n>masks</span><span class=p>)</span></span></span></code></pre></div><p><strong>Memory Attention</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryAttention</span><span class=p>(</span><span class=n>nn</span><span class=o>.</span><span class=n>Module</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>memory_bank</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        query: 当前帧的特征
</span></span></span><span class=line><span class=cl><span class=s2>        memory_bank: 历史帧的特征和mask
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>memory_bank</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>query</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mem_embeddings</span><span class=p>,</span> <span class=n>mem_masks</span> <span class=o>=</span> <span class=n>memory_bank</span><span class=o>.</span><span class=n>get_context</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Cross-attention</span>
</span></span><span class=line><span class=cl>        <span class=n>attended</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cross_attention</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span><span class=o>=</span><span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=o>=</span><span class=n>mem_embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span><span class=o>=</span><span class=n>mem_embeddings</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>attended</span></span></span></code></pre></div><h3 id=1333-使用sam-2>13.3.3 使用SAM 2<a class=anchor href=#1333-%e4%bd%bf%e7%94%a8sam-2>#</a></h3><p><strong>安装</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/facebookresearch/sam2.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> sam2
</span></span><span class=line><span class=cl>pip install -e .</span></span></code></pre></div><p><strong>视频对象分割</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam2.build_sam</span> <span class=kn>import</span> <span class=n>build_sam2_video_predictor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载模型</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span> <span class=o>=</span> <span class=n>build_sam2_video_predictor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;configs/sam2.1/sam2.1_hiera_large.yaml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;checkpoints/sam2.1_hiera_large.pt&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化视频</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>torch</span><span class=o>.</span><span class=n>inference_mode</span><span class=p>(),</span> <span class=n>torch</span><span class=o>.</span><span class=n>autocast</span><span class=p>(</span><span class=s2>&#34;cuda&#34;</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>bfloat16</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>init_state</span><span class=p>(</span><span class=n>video_path</span><span class=o>=</span><span class=s2>&#34;video.mp4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 在第一帧添加点击</span>
</span></span><span class=line><span class=cl>    <span class=n>frame_idx</span><span class=p>,</span> <span class=n>object_ids</span><span class=p>,</span> <span class=n>masks</span> <span class=o>=</span> <span class=n>predictor</span><span class=o>.</span><span class=n>add_new_points_or_box</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>frame_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>obj_id</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>points</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([[</span><span class=mi>500</span><span class=p>,</span> <span class=mi>375</span><span class=p>]],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>labels</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 传播到所有帧</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>frame_idx</span><span class=p>,</span> <span class=n>object_ids</span><span class=p>,</span> <span class=n>masks</span> <span class=ow>in</span> <span class=n>predictor</span><span class=o>.</span><span class=n>propagate_in_video</span><span class=p>(</span><span class=n>state</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># masks: (num_objects, H, W)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 保存或显示masks</span>
</span></span><span class=line><span class=cl>        <span class=n>save_masks</span><span class=p>(</span><span class=n>frame_idx</span><span class=p>,</span> <span class=n>masks</span><span class=p>)</span></span></span></code></pre></div><p><strong>多对象跟踪</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 添加多个对象</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span><span class=o>.</span><span class=n>add_new_points_or_box</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>frame_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>obj_id</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=p>[[</span><span class=mi>100</span><span class=p>,</span> <span class=mi>200</span><span class=p>]],</span> <span class=n>labels</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span><span class=o>.</span><span class=n>add_new_points_or_box</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>frame_idx</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>obj_id</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=p>[[</span><span class=mi>500</span><span class=p>,</span> <span class=mi>300</span><span class=p>]],</span> <span class=n>labels</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 传播</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>frame_idx</span><span class=p>,</span> <span class=n>object_ids</span><span class=p>,</span> <span class=n>masks</span> <span class=ow>in</span> <span class=n>predictor</span><span class=o>.</span><span class=n>propagate_in_video</span><span class=p>(</span><span class=n>state</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># masks[0]: 对象0的mask</span>
</span></span><span class=line><span class=cl>    <span class=c1># masks[1]: 对象1的mask</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><h3 id=1334-sam-2性能>13.3.4 SAM 2性能<a class=anchor href=#1334-sam-2%e6%80%a7%e8%83%bd>#</a></h3><p><strong>SA-V (Segment Anything Video) 数据集</strong>：</p><table><thead><tr><th>模型</th><th>J&amp;F (%)</th><th>FPS</th><th>参数量</th></tr></thead><tbody><tr><td>SAM 2.1 Tiny</td><td>76.5</td><td>91.2</td><td>38.9M</td></tr><tr><td>SAM 2.1 Small</td><td>76.6</td><td>84.8</td><td>46M</td></tr><tr><td>SAM 2.1 Base Plus</td><td>78.2</td><td>64.1</td><td>80.8M</td></tr><tr><td>SAM 2.1 Large</td><td>79.5</td><td>39.5</td><td>224.4M</td></tr></tbody></table><p><strong>改进</strong>：</p><ul><li>支持视频（SAM仅支持图像）</li><li>实时性能（91 FPS for Tiny）</li><li>更好的时序一致性</li></ul><hr><h2 id=134-实战零样本分割应用>13.4 实战：零样本分割应用<a class=anchor href=#134-%e5%ae%9e%e6%88%98%e9%9b%b6%e6%a0%b7%e6%9c%ac%e5%88%86%e5%89%b2%e5%ba%94%e7%94%a8>#</a></h2><h3 id=1341-项目交互式图像编辑>13.4.1 项目：交互式图像编辑<a class=anchor href=#1341-%e9%a1%b9%e7%9b%ae%e4%ba%a4%e4%ba%92%e5%bc%8f%e5%9b%be%e5%83%8f%e7%bc%96%e8%be%91>#</a></h3><p>完整代码见：<a href=../../chapter29/code/chapter13_sam/sam_zero_shot.py><code>sam_zero_shot.py</code></a></p><h3 id=1342-应用场景>13.4.2 应用场景<a class=anchor href=#1342-%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af>#</a></h3><h4 id=1-快速数据标注>1. 快速数据标注<a class=anchor href=#1-%e5%bf%ab%e9%80%9f%e6%95%b0%e6%8d%ae%e6%a0%87%e6%b3%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 标注工作流</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>annotation_workflow</span><span class=p>(</span><span class=n>images</span><span class=p>,</span> <span class=n>output_dir</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sam</span> <span class=o>=</span> <span class=n>load_sam_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>img_path</span> <span class=ow>in</span> <span class=n>images</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>image</span> <span class=o>=</span> <span class=n>load_image</span><span class=p>(</span><span class=n>img_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 用户点击</span>
</span></span><span class=line><span class=cl>        <span class=n>points</span> <span class=o>=</span> <span class=n>get_user_clicks</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># SAM自动分割</span>
</span></span><span class=line><span class=cl>        <span class=n>mask</span> <span class=o>=</span> <span class=n>sam</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=n>points</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保存标注</span>
</span></span><span class=line><span class=cl>        <span class=n>save_annotation</span><span class=p>(</span><span class=n>mask</span><span class=p>,</span> <span class=n>output_dir</span> <span class=o>/</span> <span class=n>img_path</span><span class=o>.</span><span class=n>name</span><span class=p>)</span></span></span></code></pre></div><h4 id=2-移除背景>2. 移除背景<a class=anchor href=#2-%e7%a7%bb%e9%99%a4%e8%83%8c%e6%99%af>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>remove_background</span><span class=p>(</span><span class=n>image_path</span><span class=p>,</span> <span class=n>point</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;一键移除背景&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>sam</span> <span class=o>=</span> <span class=n>load_sam_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span> <span class=o>=</span> <span class=n>load_image</span><span class=p>(</span><span class=n>image_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 点击前景物体</span>
</span></span><span class=line><span class=cl>    <span class=n>mask</span> <span class=o>=</span> <span class=n>sam</span><span class=p>(</span><span class=n>image</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=p>[</span><span class=n>point</span><span class=p>],</span> <span class=n>labels</span><span class=o>=</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 提取前景</span>
</span></span><span class=line><span class=cl>    <span class=n>foreground</span> <span class=o>=</span> <span class=n>image</span> <span class=o>*</span> <span class=n>mask</span><span class=p>[:,</span> <span class=p>:,</span> <span class=kc>None</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 透明背景</span>
</span></span><span class=line><span class=cl>    <span class=n>rgba</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>foreground</span><span class=p>,</span> <span class=n>mask</span><span class=p>[:,</span> <span class=p>:,</span> <span class=kc>None</span><span class=p>]</span> <span class=o>*</span> <span class=mi>255</span><span class=p>],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rgba</span></span></span></code></pre></div><h4 id=3-对象替换>3. 对象替换<a class=anchor href=#3-%e5%af%b9%e8%b1%a1%e6%9b%bf%e6%8d%a2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>object_replacement</span><span class=p>(</span><span class=n>base_image</span><span class=p>,</span> <span class=n>object_image</span><span class=p>,</span> <span class=n>point</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;替换物体&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 分割出要替换的区域</span>
</span></span><span class=line><span class=cl>    <span class=n>mask</span> <span class=o>=</span> <span class=n>sam</span><span class=p>(</span><span class=n>base_image</span><span class=p>,</span> <span class=n>points</span><span class=o>=</span><span class=p>[</span><span class=n>point</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 将新物体放置到该区域</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>base_image</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span> <span class=o>=</span> <span class=n>object_image</span><span class=p>[</span><span class=n>mask</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span></span></span></code></pre></div><h3 id=1343-sam的局限>13.4.3 SAM的局限<a class=anchor href=#1343-sam%e7%9a%84%e5%b1%80%e9%99%90>#</a></h3><ol><li><p><strong>不支持类别识别</strong></p><ul><li>SAM只分割，不识别类别</li><li>需要结合分类模型</li></ul></li><li><p><strong>小物体效果一般</strong></p><ul><li>对小物体（&lt;32×32）效果不佳</li></ul></li><li><p><strong>边界精度</strong></p><ul><li>某些情况下边界不够精细</li><li>可能需要后处理</li></ul></li><li><p><strong>计算成本</strong></p><ul><li>ViT-Huge模型较大</li><li>需要高性能GPU</li></ul></li></ol><h3 id=1344-sam--其他模型>13.4.4 SAM + 其他模型<a class=anchor href=#1344-sam--%e5%85%b6%e4%bb%96%e6%a8%a1%e5%9e%8b>#</a></h3><h4 id=1-grounded-sam>1. Grounded-SAM<a class=anchor href=#1-grounded-sam>#</a></h4><p>结合Grounding DINO实现文本驱动分割：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>groundingdino.util.inference</span> <span class=kn>import</span> <span class=n>load_model</span><span class=p>,</span> <span class=n>predict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sam</span> <span class=kn>import</span> <span class=n>sam_model_registry</span><span class=p>,</span> <span class=n>SamPredictor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Grounding DINO检测</span>
</span></span><span class=line><span class=cl><span class=n>boxes</span><span class=p>,</span> <span class=n>logits</span><span class=p>,</span> <span class=n>phrases</span> <span class=o>=</span> <span class=n>predict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>grounding_dino</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>image</span><span class=o>=</span><span class=n>image</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>caption</span><span class=o>=</span><span class=s2>&#34;a cat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>box_threshold</span><span class=o>=</span><span class=mf>0.35</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SAM分割</span>
</span></span><span class=line><span class=cl><span class=n>sam</span> <span class=o>=</span> <span class=n>SamPredictor</span><span class=p>(</span><span class=n>sam_model_registry</span><span class=p>[</span><span class=s2>&#34;vit_h&#34;</span><span class=p>]())</span>
</span></span><span class=line><span class=cl><span class=n>sam</span><span class=o>.</span><span class=n>set_image</span><span class=p>(</span><span class=n>image</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>masks</span><span class=p>,</span> <span class=n>_</span><span class=p>,</span> <span class=n>_</span> <span class=o>=</span> <span class=n>sam</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>boxes</span><span class=o>=</span><span class=n>boxes</span><span class=p>,</span>  <span class=c1># 使用检测框作为提示</span>
</span></span><span class=line><span class=cl>    <span class=n>multimask_output</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=2-mobilesam>2. MobileSAM<a class=anchor href=#2-mobilesam>#</a></h4><p>轻量化版本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 原始SAM: 636M参数</span>
</span></span><span class=line><span class=cl><span class=c1># MobileSAM: 仅9.7M参数，速度快10倍</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mobile_sam</span> <span class=kn>import</span> <span class=n>sam_model_registry</span><span class=p>,</span> <span class=n>SamPredictor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mobile_sam</span> <span class=o>=</span> <span class=n>sam_model_registry</span><span class=p>[</span><span class=s2>&#34;vit_t&#34;</span><span class=p>](</span><span class=n>checkpoint</span><span class=o>=</span><span class=s2>&#34;mobile_sam.pt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>predictor</span> <span class=o>=</span> <span class=n>SamPredictor</span><span class=p>(</span><span class=n>mobile_sam</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=本章小结-2>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2>#</a></h2><h3 id=核心知识点-2>核心知识点<a class=anchor href=#%e6%a0%b8%e5%bf%83%e7%9f%a5%e8%af%86%e7%82%b9-2>#</a></h3><ol><li><p><strong>SAM架构（2023）</strong></p><ul><li>Image Encoder (ViT-H)</li><li>Prompt Encoder (点/框/mask)</li><li>Mask Decoder (轻量级Transformer)</li><li>零样本分割能力</li></ul></li><li><p><strong>Prompt Engineering</strong></p><ul><li>单点/多点提示</li><li>边界框提示</li><li>Mask提示</li><li>Everything模式</li></ul></li><li><p><strong>SAM 2（2024）</strong></p><ul><li>统一图像和视频</li><li>流式记忆机制</li><li>实时视频对象分割</li><li>多对象跟踪</li></ul></li></ol><h3 id=技术对比-1>技术对比<a class=anchor href=#%e6%8a%80%e6%9c%af%e5%af%b9%e6%af%94-1>#</a></h3><table><thead><tr><th>特性</th><th>SAM</th><th>SAM 2</th><th>传统分割</th></tr></thead><tbody><tr><td><strong>零样本</strong></td><td>✓</td><td>✓</td><td>✗</td></tr><tr><td><strong>视频支持</strong></td><td>✗</td><td>✓</td><td>部分</td></tr><tr><td><strong>交互式</strong></td><td>✓</td><td>✓</td><td>✗</td></tr><tr><td><strong>实时性</strong></td><td>中</td><td>高</td><td>高</td></tr><tr><td><strong>精度</strong></td><td>高</td><td>高</td><td>取决于训练</td></tr></tbody></table><h3 id=应用场景-2>应用场景<a class=anchor href=#%e5%ba%94%e7%94%a8%e5%9c%ba%e6%99%af-2>#</a></h3><table><thead><tr><th>场景</th><th>SAM优势</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>数据标注</strong></td><td>快速、准确</td><td>SAM + 标注工具</td></tr><tr><td><strong>图像编辑</strong></td><td>交互式</td><td>SAM</td></tr><tr><td><strong>视频编辑</strong></td><td>时序一致</td><td>SAM 2</td></tr><tr><td><strong>目标提取</strong></td><td>无需训练</td><td>SAM + Grounding DINO</td></tr><tr><td><strong>医学分割</strong></td><td>泛化能力强</td><td>SAM + 微调</td></tr></tbody></table><h3 id=实践建议-2>实践建议<a class=anchor href=#%e5%ae%9e%e8%b7%b5%e5%bb%ba%e8%ae%ae-2>#</a></h3><ol><li><p><strong>选择合适的模型尺寸</strong>：</p><ul><li>ViT-Huge: 最高精度</li><li>ViT-Large: 平衡</li><li>ViT-Base: 速度快</li><li>MobileSAM: 边缘设备</li></ul></li><li><p><strong>Prompt策略</strong>：</p><ul><li>简单物体：单点</li><li>复杂物体：多点 + 框</li><li>精细边界：迭代优化</li></ul></li><li><p><strong>后处理</strong>：</p><ul><li>Mask平滑</li><li>小区域过滤</li><li>边界精化</li></ul></li></ol><h3 id=未来展望>未来展望<a class=anchor href=#%e6%9c%aa%e6%9d%a5%e5%b1%95%e6%9c%9b>#</a></h3><ol><li><strong>更小的模型</strong>：MobileSAM、FastSAM</li><li><strong>更强的能力</strong>：3D分割、语义理解</li><li><strong>更多应用</strong>：AR/VR、机器人、医疗</li></ol><hr><h2 id=第五篇总结>第五篇总结<a class=anchor href=#%e7%ac%ac%e4%ba%94%e7%af%87%e6%80%bb%e7%bb%93>#</a></h2><h3 id=完整技术栈>完整技术栈<a class=anchor href=#%e5%ae%8c%e6%95%b4%e6%8a%80%e6%9c%af%e6%a0%88>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>【语义分割】
</span></span><span class=line><span class=cl>FCN (2015) → U-Net (2015) → DeepLab v3+ (2018)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【实例分割】
</span></span><span class=line><span class=cl>Mask R-CNN (2017) → YOLACT (2019) → YOLOv8-Seg (2023) → YOLO11-Seg (2024)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>【零样本分割】
</span></span><span class=line><span class=cl>SAM (2023) → SAM 2 (2024)</span></span></code></pre></div><h3 id=学习成果>学习成果<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9e%9c>#</a></h3><p>学完本篇后，你已经掌握：</p><ol><li><p><strong>理论基础</strong></p><ul><li>分割任务的分类和特点</li><li>编码器-解码器架构</li><li>评估指标（IoU、Dice）</li></ul></li><li><p><strong>经典模型</strong></p><ul><li>FCN: 全卷积网络</li><li>U-Net: 医学图像分割</li><li>DeepLab: 空洞卷积</li><li>Mask R-CNN: 实例分割</li></ul></li><li><p><strong>前沿技术</strong></p><ul><li>YOLOv8/YOLO11-Seg: 实时分割</li><li>SAM: 零样本分割</li><li>SAM 2: 视频分割</li></ul></li><li><p><strong>实战能力</strong></p><ul><li>医学图像分割项目</li><li>COCO实例分割</li><li>交互式分割应用</li></ul></li></ol><h3 id=下一步-3>下一步<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5-3>#</a></h3><p>恭喜完成第五篇！接下来可以：</p><ol><li><strong>深入研究</strong>：阅读相关论文</li><li><strong>实战项目</strong>：在自己的数据上训练</li><li><strong>探索应用</strong>：结合实际需求开发应用</li><li><strong>跟进前沿</strong>：关注最新研究进展</li></ol><hr><p><strong>参考资源</strong>：</p><ul><li><a href=https://arxiv.org/abs/2304.02643>SAM论文</a></li><li><a href=https://arxiv.org/abs/2408.00714>SAM 2论文</a></li><li><a href=https://github.com/facebookresearch/segment-anything>SAM GitHub</a></li><li><a href=https://github.com/facebookresearch/segment-anything-2>SAM 2 GitHub</a></li><li><a href=https://huggingface.co/docs/transformers/model_doc/sam>Hugging Face SAM</a></li></ul><hr></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第四篇 目标检测与YOLO系列</span>
</a></span><span><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/ class="flex align-center"><span>第六篇 生成模型</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#篇章概览>篇章概览</a></li><li><a href=#为什么要学习图像分割>为什么要学习图像分割？</a><ul><li><a href=#1-更精细的视觉理解>1. 更精细的视觉理解</a></li><li><a href=#2-广泛的应用场景>2. 广泛的应用场景</a></li><li><a href=#3-技术发展迅速>3. 技术发展迅速</a></li></ul></li><li><a href=#篇章结构>篇章结构</a><ul><li><a href=#第11章语义分割>第11章：语义分割</a></li><li><a href=#第12章实例分割>第12章：实例分割</a></li><li><a href=#第13章segment-anything-sam>第13章：Segment Anything (SAM)</a></li></ul></li><li><a href=#分割任务对比>分割任务对比</a></li><li><a href=#评估指标>评估指标</a><ul><li><a href=#1-iou-intersection-over-union>1. IoU (Intersection over Union)</a></li><li><a href=#2-dice-coefficient-f1-score>2. Dice Coefficient (F1 Score)</a></li><li><a href=#3-miou-mean-iou>3. mIoU (mean IoU)</a></li><li><a href=#4-pixel-accuracy>4. Pixel Accuracy</a></li></ul></li><li><a href=#技术演进路线>技术演进路线</a></li><li><a href=#学习路径建议>学习路径建议</a><ul><li><a href=#入门阶段>入门阶段</a></li><li><a href=#进阶阶段>进阶阶段</a></li><li><a href=#高级阶段>高级阶段</a></li></ul></li><li><a href=#实战项目>实战项目</a><ul><li><a href=#1-医学图像分割>1. 医学图像分割</a></li><li><a href=#2-coco实例分割>2. COCO实例分割</a></li><li><a href=#3-零样本分割应用>3. 零样本分割应用</a></li></ul></li><li><a href=#代码示例>代码示例</a><ul><li><a href=#语义分割>语义分割</a></li><li><a href=#实例分割>实例分割</a></li><li><a href=#零样本分割>零样本分割</a></li></ul></li><li><a href=#工具与资源>工具与资源</a><ul><li><a href=#开源框架>开源框架</a></li><li><a href=#数据集>数据集</a></li><li><a href=#标注工具>标注工具</a></li></ul></li><li><a href=#学习目标>学习目标</a></li><li><a href=#下一步>下一步</a></li></ul><ul><li><a href=#本章概览>本章概览</a></li><li><a href=#什么是语义分割>什么是语义分割？</a><ul><li><a href=#任务定义>任务定义</a></li><li><a href=#与其他任务的区别>与其他任务的区别</a></li><li><a href=#应用场景>应用场景</a></li></ul></li><li><a href=#111-fcn全卷积网络>11.1 FCN：全卷积网络</a><ul><li><a href=#1111-核心思想>11.1.1 核心思想</a></li><li><a href=#1112-架构设计>11.1.2 架构设计</a><ul><li><a href=#1-全卷积化>1. 全卷积化</a></li><li><a href=#2-上采样upsampling>2. 上采样（Upsampling）</a></li><li><a href=#3-跳跃连接skip-connections>3. 跳跃连接（Skip Connections）</a></li><li><a href=#4-fcn-8s架构代码>4. FCN-8s架构代码</a></li></ul></li><li><a href=#1113-训练技巧>11.1.3 训练技巧</a><ul><li><a href=#1-损失函数>1. 损失函数</a></li><li><a href=#2-评估指标>2. 评估指标</a></li></ul></li><li><a href=#1114-fcn的局限>11.1.4 FCN的局限</a></li></ul></li><li><a href=#112-u-net编码器-解码器架构>11.2 U-Net：编码器-解码器架构</a><ul><li><a href=#1121-为什么u-net如此成功>11.2.1 为什么U-Net如此成功？</a></li><li><a href=#1122-架构设计>11.2.2 架构设计</a><ul><li><a href=#u型结构>U型结构</a></li><li><a href=#关键组件>关键组件</a></li></ul></li><li><a href=#1123-完整实现>11.2.3 完整实现</a></li><li><a href=#1124-训练策略>11.2.4 训练策略</a><ul><li><a href=#1-数据增强>1. 数据增强</a></li><li><a href=#2-加权损失>2. 加权损失</a></li><li><a href=#3-dice-loss>3. Dice Loss</a></li></ul></li><li><a href=#1125-u-net变体>11.2.5 U-Net变体</a><ul><li><a href=#1-attention-u-net>1. Attention U-Net</a></li><li><a href=#2-res-unet>2. Res-UNet</a></li><li><a href=#3-u-net>3. U-Net++</a></li></ul></li></ul></li><li><a href=#113-deeplab系列空洞卷积>11.3 DeepLab系列：空洞卷积</a><ul><li><a href=#1131-核心创新空洞卷积>11.3.1 核心创新：空洞卷积</a></li><li><a href=#1132-asppatrous-spatial-pyramid-pooling>11.3.2 ASPP（Atrous Spatial Pyramid Pooling）</a></li><li><a href=#1133-deeplab-v3架构>11.3.3 DeepLab v3+架构</a></li><li><a href=#1134-性能对比>11.3.4 性能对比</a></li></ul></li><li><a href=#114-实战医学图像分割>11.4 实战：医学图像分割</a><ul><li><a href=#1141-项目目标>11.4.1 项目目标</a></li><li><a href=#1142-数据准备>11.4.2 数据准备</a></li><li><a href=#1143-训练流程>11.4.3 训练流程</a></li><li><a href=#1144-评估指标>11.4.4 评估指标</a></li></ul></li><li><a href=#本章小结>本章小结</a><ul><li><a href=#核心知识点>核心知识点</a></li><li><a href=#技术对比>技术对比</a></li><li><a href=#实践建议>实践建议</a></li><li><a href=#下一步-1>下一步</a></li></ul></li></ul><ul><li><a href=#本章概览-1>本章概览</a></li><li><a href=#实例分割-vs-语义分割>实例分割 vs 语义分割</a><ul><li><a href=#任务对比>任务对比</a></li><li><a href=#应用场景-1>应用场景</a></li></ul></li><li><a href=#121-mask-r-cnn原理>12.1 Mask R-CNN原理</a><ul><li><a href=#1211-核心思想>12.1.1 核心思想</a></li><li><a href=#1212-关键创新>12.1.2 关键创新</a><ul><li><a href=#1-roi-align>1. RoI Align</a></li><li><a href=#2-mask分支>2. Mask分支</a></li><li><a href=#3-损失函数>3. 损失函数</a></li></ul></li><li><a href=#1213-使用detectron2>12.1.3 使用Detectron2</a></li><li><a href=#1214-mask-r-cnn变体>12.1.4 Mask R-CNN变体</a><ul><li><a href=#1-cascade-mask-r-cnn>1. Cascade Mask R-CNN</a></li><li><a href=#2-pointrend>2. PointRend</a></li></ul></li></ul></li><li><a href=#122-yolact实时实例分割>12.2 YOLACT：实时实例分割</a><ul><li><a href=#1221-核心思想>12.2.1 核心思想</a></li><li><a href=#1222-架构设计>12.2.2 架构设计</a><ul><li><a href=#1-protonet>1. Protonet</a></li><li><a href=#2-prediction-head>2. Prediction Head</a></li><li><a href=#3-mask-assembly>3. Mask Assembly</a></li></ul></li><li><a href=#1223-性能特点>12.2.3 性能特点</a></li></ul></li><li><a href=#123-yolov8-segyolo的分割版本>12.3 YOLOv8-Seg：YOLO的分割版本</a><ul><li><a href=#1231-核心特性>12.3.1 核心特性</a></li><li><a href=#1232-模型变体>12.3.2 模型变体</a></li><li><a href=#1233-使用示例>12.3.3 使用示例</a></li><li><a href=#1234-训练自定义数据>12.3.4 训练自定义数据</a><ul><li><a href=#1-数据格式>1. 数据格式</a></li><li><a href=#2-数据集配置>2. 数据集配置</a></li><li><a href=#3-训练代码>3. 训练代码</a></li></ul></li></ul></li><li><a href=#124-实战实例分割项目>12.4 实战：实例分割项目</a><ul><li><a href=#1241-项目目标>12.4.1 项目目标</a></li><li><a href=#1242-完整代码>12.4.2 完整代码</a></li><li><a href=#1243-评估指标>12.4.3 评估指标</a><ul><li><a href=#1-mask-map>1. Mask mAP</a></li><li><a href=#2-边界精度>2. 边界精度</a></li></ul></li><li><a href=#1244-后处理技巧>12.4.4 后处理技巧</a><ul><li><a href=#1-mask平滑>1. Mask平滑</a></li><li><a href=#2-小区域过滤>2. 小区域过滤</a></li><li><a href=#3-mask融合>3. Mask融合</a></li></ul></li></ul></li><li><a href=#本章小结-1>本章小结</a><ul><li><a href=#核心知识点-1>核心知识点</a></li><li><a href=#模型对比>模型对比</a></li><li><a href=#选择建议>选择建议</a></li><li><a href=#实践建议-1>实践建议</a></li><li><a href=#下一步-2>下一步</a></li></ul></li></ul><ul><li><a href=#本章概览-2>本章概览</a></li><li><a href=#为什么sam是革命性的>为什么SAM是革命性的？</a><ul><li><a href=#1-零样本分割能力>1. 零样本分割能力</a></li><li><a href=#2-promptable分割>2. Promptable分割</a></li><li><a href=#3-强大的泛化能力>3. 强大的泛化能力</a></li></ul></li><li><a href=#131-sam模型架构>13.1 SAM模型架构</a><ul><li><a href=#1311-整体架构>13.1.1 整体架构</a></li><li><a href=#1312-image-encoder>13.1.2 Image Encoder</a></li><li><a href=#1313-prompt-encoder>13.1.3 Prompt Encoder</a></li><li><a href=#1314-mask-decoder>13.1.4 Mask Decoder</a></li></ul></li><li><a href=#132-prompt-engineering-for-sam>13.2 Prompt Engineering for SAM</a><ul><li><a href=#1321-点击式分割>13.2.1 点击式分割</a></li><li><a href=#1322-边界框提示>13.2.2 边界框提示</a></li><li><a href=#1323-mask提示>13.2.3 Mask提示</a></li><li><a href=#1324-自动分割everything-mode>13.2.4 自动分割（Everything Mode）</a></li></ul></li><li><a href=#133-sam-2视频分割>13.3 SAM 2：视频分割</a><ul><li><a href=#1331-核心改进>13.3.1 核心改进</a></li><li><a href=#1332-memory-mechanism>13.3.2 Memory Mechanism</a></li><li><a href=#1333-使用sam-2>13.3.3 使用SAM 2</a></li><li><a href=#1334-sam-2性能>13.3.4 SAM 2性能</a></li></ul></li><li><a href=#134-实战零样本分割应用>13.4 实战：零样本分割应用</a><ul><li><a href=#1341-项目交互式图像编辑>13.4.1 项目：交互式图像编辑</a></li><li><a href=#1342-应用场景>13.4.2 应用场景</a><ul><li><a href=#1-快速数据标注>1. 快速数据标注</a></li><li><a href=#2-移除背景>2. 移除背景</a></li><li><a href=#3-对象替换>3. 对象替换</a></li></ul></li><li><a href=#1343-sam的局限>13.4.3 SAM的局限</a></li><li><a href=#1344-sam--其他模型>13.4.4 SAM + 其他模型</a><ul><li><a href=#1-grounded-sam>1. Grounded-SAM</a></li><li><a href=#2-mobilesam>2. MobileSAM</a></li></ul></li></ul></li><li><a href=#本章小结-2>本章小结</a><ul><li><a href=#核心知识点-2>核心知识点</a></li><li><a href=#技术对比-1>技术对比</a></li><li><a href=#应用场景-2>应用场景</a></li><li><a href=#实践建议-2>实践建议</a></li><li><a href=#未来展望>未来展望</a></li></ul></li><li><a href=#第五篇总结>第五篇总结</a><ul><li><a href=#完整技术栈>完整技术栈</a></li><li><a href=#学习成果>学习成果</a></li><li><a href=#下一步-3>下一步</a></li></ul></li></ul></nav></div></aside></main></body></html>