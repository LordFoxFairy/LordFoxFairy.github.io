<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第五篇：RAG高级篇 - 高级检索与优化# 前言# 在第四篇中,我们学习了RAG的基础概念,实现了基本的RAG系统。但在生产环境中,基础的向量检索往往无法满足复杂的业务需求:
基础RAG的局限性:
召回不全面:单一向量检索可能遗漏关键信息 排序不精确:top-k结果中可能包含不相关内容 上下文冗余:检索到的文本可能包含大量无关信息 复杂查询支持弱:难以处理多跳推理、实体关系查询 本篇将深入探讨LangChain高级检索技术和优化方案,帮助你构建生产级的RAG系统。
核心概念对比# 技术 解决的问题 性能提升 复杂度 适用场景 混合检索 单一检索召回不全 +20-30% 低 通用RAG 重排序 top-k结果不精确 +15-25% 中 精度要求高 查询改写 查询表达不匹配 +10-20% 低 口语化查询 上下文压缩 token成本过高 成本-50% 中 长上下文 知识图谱RAG 实体关系查询弱 +30-40% 高 结构化知识 Self-RAG 检索结果不可靠 +20-30% 高 高质量要求 第1章:混合检索技术(Hybrid Search)# 1.1 为什么需要混合检索# 1.1.1 向量检索的局限性# 问题示例:
# 用户查询:"Python 3.11的新特性" # 向量检索可能返回: # ❌ "Python 3.10的新特性"(语义相似,但版本不对) # ❌ "Python的发展历史"(相关,但不精确) # ✅ "Python 3.11 release notes"(精确匹配)向量检索的问题:
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第五篇 RAG高级篇(LangChain篇)"><meta property="og:description" content='第五篇：RAG高级篇 - 高级检索与优化# 前言# 在第四篇中,我们学习了RAG的基础概念,实现了基本的RAG系统。但在生产环境中,基础的向量检索往往无法满足复杂的业务需求:
基础RAG的局限性:
召回不全面:单一向量检索可能遗漏关键信息 排序不精确:top-k结果中可能包含不相关内容 上下文冗余:检索到的文本可能包含大量无关信息 复杂查询支持弱:难以处理多跳推理、实体关系查询 本篇将深入探讨LangChain高级检索技术和优化方案,帮助你构建生产级的RAG系统。
核心概念对比# 技术 解决的问题 性能提升 复杂度 适用场景 混合检索 单一检索召回不全 +20-30% 低 通用RAG 重排序 top-k结果不精确 +15-25% 中 精度要求高 查询改写 查询表达不匹配 +10-20% 低 口语化查询 上下文压缩 token成本过高 成本-50% 中 长上下文 知识图谱RAG 实体关系查询弱 +30-40% 高 结构化知识 Self-RAG 检索结果不可靠 +20-30% 高 高质量要求 第1章:混合检索技术(Hybrid Search)# 1.1 为什么需要混合检索# 1.1.1 向量检索的局限性# 问题示例:
# 用户查询:"Python 3.11的新特性" # 向量检索可能返回: # ❌ "Python 3.10的新特性"(语义相似,但版本不对) # ❌ "Python的发展历史"(相关,但不精确) # ✅ "Python 3.11 release notes"(精确匹配)向量检索的问题:'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第五篇 RAG高级篇(LangChain篇)"><meta itemprop=description content='第五篇：RAG高级篇 - 高级检索与优化# 前言# 在第四篇中,我们学习了RAG的基础概念,实现了基本的RAG系统。但在生产环境中,基础的向量检索往往无法满足复杂的业务需求:
基础RAG的局限性:
召回不全面:单一向量检索可能遗漏关键信息 排序不精确:top-k结果中可能包含不相关内容 上下文冗余:检索到的文本可能包含大量无关信息 复杂查询支持弱:难以处理多跳推理、实体关系查询 本篇将深入探讨LangChain高级检索技术和优化方案,帮助你构建生产级的RAG系统。
核心概念对比# 技术 解决的问题 性能提升 复杂度 适用场景 混合检索 单一检索召回不全 +20-30% 低 通用RAG 重排序 top-k结果不精确 +15-25% 中 精度要求高 查询改写 查询表达不匹配 +10-20% 低 口语化查询 上下文压缩 token成本过高 成本-50% 中 长上下文 知识图谱RAG 实体关系查询弱 +30-40% 高 结构化知识 Self-RAG 检索结果不可靠 +20-30% 高 高质量要求 第1章:混合检索技术(Hybrid Search)# 1.1 为什么需要混合检索# 1.1.1 向量检索的局限性# 问题示例:
# 用户查询:"Python 3.11的新特性" # 向量检索可能返回: # ❌ "Python 3.10的新特性"(语义相似,但版本不对) # ❌ "Python的发展历史"(相关,但不精确) # ✅ "Python 3.11 release notes"(精确匹配)向量检索的问题:'><meta itemprop=wordCount content="4765"><title>第五篇 RAG高级篇(LangChain篇) | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/ class=active>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第五篇 RAG高级篇(LangChain篇)</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#核心概念对比>核心概念对比</a></li><li><a href=#第1章混合检索技术hybrid-search>第1章:混合检索技术(Hybrid Search)</a><ul><li><a href=#11-为什么需要混合检索>1.1 为什么需要混合检索</a><ul><li><a href=#111-向量检索的局限性>1.1.1 向量检索的局限性</a></li><li><a href=#112-全文检索的局限性>1.1.2 全文检索的局限性</a></li><li><a href=#113-混合检索的优势>1.1.3 混合检索的优势</a></li></ul></li><li><a href=#12-langchain混合检索实现>1.2 LangChain混合检索实现</a><ul><li><a href=#121-基础混合检索>1.2.1 基础混合检索</a></li><li><a href=#122-权重调优>1.2.2 权重调优</a></li><li><a href=#123-完整rag系统混合检索>1.2.3 完整RAG系统(混合检索)</a></li><li><a href=#124-rrfreciprocal-rank-fusion算法>1.2.4 RRF(Reciprocal Rank Fusion)算法</a></li></ul></li><li><a href=#13-混合检索实战电商产品搜索>1.3 混合检索实战:电商产品搜索</a><ul><li><a href=#131-场景说明>1.3.1 场景说明</a></li><li><a href=#132-完整实现>1.3.2 完整实现</a></li></ul></li><li><a href=#14-混合检索最佳实践>1.4 混合检索最佳实践</a><ul><li><a href=#141-权重调优策略>1.4.1 权重调优策略</a></li><li><a href=#142-何时使用混合检索>1.4.2 何时使用混合检索</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#第2章重排序技术reranking>第2章:重排序技术(Reranking)</a><ul><li><a href=#21-为什么需要重排序>2.1 为什么需要重排序</a><ul><li><a href=#211-检索器的局限性>2.1.1 检索器的局限性</a></li><li><a href=#212-重排序的作用>2.1.2 重排序的作用</a></li><li><a href=#213-重排序-vs-检索器>2.1.3 重排序 vs 检索器</a></li></ul></li><li><a href=#22-langchain重排序实现>2.2 LangChain重排序实现</a><ul><li><a href=#221-基于contextualcompressionretriever>2.2.1 基于ContextualCompressionRetriever</a></li><li><a href=#222-使用embeddingsfilter基于embedding距离>2.2.2 使用EmbeddingsFilter(基于embedding距离)</a></li><li><a href=#223-本地重排序模型cross-encoder>2.2.3 本地重排序模型(Cross-Encoder)</a></li><li><a href=#224-集成到完整rag系统>2.2.4 集成到完整RAG系统</a></li></ul></li><li><a href=#23-查询改写query-rewriting>2.3 查询改写(Query Rewriting)</a><ul><li><a href=#231-多查询生成multi-query>2.3.1 多查询生成(Multi-Query)</a></li></ul></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#第3章知识图谱raggraphrag>第3章:知识图谱RAG(GraphRAG)</a><ul><li><a href=#31-为什么需要知识图谱rag>3.1 为什么需要知识图谱RAG</a><ul><li><a href=#311-向量rag的局限性>3.1.1 向量RAG的局限性</a></li></ul></li><li><a href=#32-neo4j--langchain实现>3.2 Neo4j + LangChain实现</a><ul><li><a href=#321-环境准备>3.2.1 环境准备</a></li><li><a href=#322-基础知识图谱rag>3.2.2 基础知识图谱RAG</a></li><li><a href=#323-graphrag-向量--图遍历-neo4jvector>3.2.3 GraphRAG: 向量 + 图遍历 (Neo4jVector)</a></li></ul></li><li><a href=#33-graphrag-vs-传统rag性能对比>3.3 GraphRAG vs 传统RAG性能对比</a></li></ul></li><li><a href=#第4章前沿rag方案>第4章:前沿RAG方案</a><ul><li><a href=#41-self-rag自我反思检索>4.1 Self-RAG(自我反思检索)</a><ul><li><a href=#411-核心思想>4.1.1 核心思想</a></li><li><a href=#412-简化实现>4.1.2 简化实现</a></li></ul></li><li><a href=#42-corrective-rag-crag>4.2 Corrective RAG (CRAG)</a><ul><li><a href=#421-核心流程>4.2.1 核心流程</a></li><li><a href=#422-简化实现>4.2.2 简化实现</a></li></ul></li><li><a href=#43-agentic-rag>4.3 Agentic RAG</a></li><li><a href=#小结-2>小结</a><ul><li><a href=#知识图谱rag第3章>知识图谱RAG(第3章)</a></li><li><a href=#前沿rag方案第4章>前沿RAG方案(第4章)</a></li></ul></li></ul></li><li><a href=#第5章混合检索生产实践完整指南>第5章：混合检索生产实践完整指南</a><ul><li><ul><li><a href=#51-生产系统架构设计>5.1 生产系统架构设计</a><ul><li><a href=#511-完整架构>5.1.1 完整架构</a></li><li><a href=#512-生产级实现>5.1.2 生产级实现</a></li></ul></li><li><a href=#52-评估与优化体系>5.2 评估与优化体系</a><ul><li><a href=#521-构建评估数据集>5.2.1 构建评估数据集</a></li><li><a href=#522-自定义evaluators>5.2.2 自定义Evaluators</a></li><li><a href=#523-运行自动化评估>5.2.3 运行自动化评估</a></li><li><a href=#524-权重优化实验>5.2.4 权重优化实验</a></li></ul></li><li><a href=#53-性能优化技巧>5.3 性能优化技巧</a><ul><li><a href=#531-并发检索优化>5.3.1 并发检索优化</a></li><li><a href=#532-缓存策略>5.3.2 缓存策略</a></li><li><a href=#533-批处理优化>5.3.3 批处理优化</a></li></ul></li><li><a href=#54-监控与告警>5.4 监控与告警</a><ul><li><a href=#541-langsmith集成监控>5.4.1 LangSmith集成监控</a></li><li><a href=#542-自定义监控dashboard>5.4.2 自定义监控Dashboard</a></li></ul></li><li><a href=#55-总结生产清单>5.5 总结：生产清单</a></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第五篇rag高级篇---高级检索与优化>第五篇：RAG高级篇 - 高级检索与优化<a class=anchor href=#%e7%ac%ac%e4%ba%94%e7%af%87rag%e9%ab%98%e7%ba%a7%e7%af%87---%e9%ab%98%e7%ba%a7%e6%a3%80%e7%b4%a2%e4%b8%8e%e4%bc%98%e5%8c%96>#</a></h1><h2 id=前言>前言<a class=anchor href=#%e5%89%8d%e8%a8%80>#</a></h2><p>在第四篇中,我们学习了RAG的基础概念,实现了基本的RAG系统。但在生产环境中,基础的向量检索往往无法满足复杂的业务需求:</p><p><strong>基础RAG的局限性</strong>:</p><ol><li><strong>召回不全面</strong>:单一向量检索可能遗漏关键信息</li><li><strong>排序不精确</strong>:top-k结果中可能包含不相关内容</li><li><strong>上下文冗余</strong>:检索到的文本可能包含大量无关信息</li><li><strong>复杂查询支持弱</strong>:难以处理多跳推理、实体关系查询</li></ol><p>本篇将深入探讨<strong>LangChain高级检索技术</strong>和<strong>优化方案</strong>,帮助你构建生产级的RAG系统。</p><hr><h2 id=核心概念对比>核心概念对比<a class=anchor href=#%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5%e5%af%b9%e6%af%94>#</a></h2><table><thead><tr><th>技术</th><th>解决的问题</th><th>性能提升</th><th>复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>混合检索</strong></td><td>单一检索召回不全</td><td>+20-30%</td><td>低</td><td>通用RAG</td></tr><tr><td><strong>重排序</strong></td><td>top-k结果不精确</td><td>+15-25%</td><td>中</td><td>精度要求高</td></tr><tr><td><strong>查询改写</strong></td><td>查询表达不匹配</td><td>+10-20%</td><td>低</td><td>口语化查询</td></tr><tr><td><strong>上下文压缩</strong></td><td>token成本过高</td><td>成本-50%</td><td>中</td><td>长上下文</td></tr><tr><td><strong>知识图谱RAG</strong></td><td>实体关系查询弱</td><td>+30-40%</td><td>高</td><td>结构化知识</td></tr><tr><td><strong>Self-RAG</strong></td><td>检索结果不可靠</td><td>+20-30%</td><td>高</td><td>高质量要求</td></tr></tbody></table><hr><h2 id=第1章混合检索技术hybrid-search>第1章:混合检索技术(Hybrid Search)<a class=anchor href=#%e7%ac%ac1%e7%ab%a0%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e6%8a%80%e6%9c%afhybrid-search>#</a></h2><h3 id=11-为什么需要混合检索>1.1 为什么需要混合检索<a class=anchor href=#11-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2>#</a></h3><h4 id=111-向量检索的局限性>1.1.1 向量检索的局限性<a class=anchor href=#111-%e5%90%91%e9%87%8f%e6%a3%80%e7%b4%a2%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7>#</a></h4><p><strong>问题示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 用户查询:&#34;Python 3.11的新特性&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 向量检索可能返回:</span>
</span></span><span class=line><span class=cl><span class=c1># ❌ &#34;Python 3.10的新特性&#34;(语义相似,但版本不对)</span>
</span></span><span class=line><span class=cl><span class=c1># ❌ &#34;Python的发展历史&#34;(相关,但不精确)</span>
</span></span><span class=line><span class=cl><span class=c1># ✅ &#34;Python 3.11 release notes&#34;(精确匹配)</span></span></span></code></pre></div><p><strong>向量检索的问题</strong>:</p><ol><li><strong>关键词敏感信息丢失</strong>:版本号、产品型号等精确匹配需求</li><li><strong>罕见词处理不佳</strong>:专业术语、公司名称等低频词</li><li><strong>语义泛化过度</strong>:可能返回相关但不精确的结果</li></ol><h4 id=112-全文检索的局限性>1.1.2 全文检索的局限性<a class=anchor href=#112-%e5%85%a8%e6%96%87%e6%a3%80%e7%b4%a2%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7>#</a></h4><p><strong>BM25算法的问题</strong>:</p><ol><li><strong>无法理解语义</strong>:&ldquo;汽车保养"和"车辆维护"无法匹配</li><li><strong>同义词问题</strong>:&ldquo;北京"和"首都"无法关联</li><li><strong>词序不敏感</strong>:&ldquo;狗咬人"和"人咬狗"评分相似</li></ol><h4 id=113-混合检索的优势>1.1.3 混合检索的优势<a class=anchor href=#113-%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e7%9a%84%e4%bc%98%e5%8a%bf>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>混合检索 = 向量检索(语义理解) + 全文检索(精确匹配)</span></span></code></pre></div><p><strong>互补效果</strong>:</p><ul><li>向量检索:捕获语义相关性</li><li>BM25检索:捕获关键词精确匹配</li><li>融合算法:RRF(Reciprocal Rank Fusion)综合排序</li></ul><hr><h3 id=12-langchain混合检索实现>1.2 LangChain混合检索实现<a class=anchor href=#12-langchain%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=121-基础混合检索>1.2.1 基础混合检索<a class=anchor href=#121-%e5%9f%ba%e7%a1%80%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers</span> <span class=kn>import</span> <span class=n>BM25Retriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>EnsembleRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>DirectoryLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 加载和分块文档</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>DirectoryLoader</span><span class=p>(</span><span class=s2>&#34;./docs&#34;</span><span class=p>,</span> <span class=n>glob</span><span class=o>=</span><span class=s2>&#34;**/*.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>splits</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 创建向量检索器</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>splits</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>vector_retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>4</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建BM25检索器</span>
</span></span><span class=line><span class=cl><span class=n>bm25_retriever</span> <span class=o>=</span> <span class=n>BM25Retriever</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>splits</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>k</span> <span class=o>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 创建混合检索器(EnsembleRetriever)</span>
</span></span><span class=line><span class=cl><span class=n>ensemble_retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>]</span>  <span class=c1># 权重:向量50%,BM25 50%</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5: 使用混合检索</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>ensemble_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Python 3.11的新特性有哪些?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;内容: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;来源: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>输出示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>内容: Python 3.11于2022年10月发布,主要新特性包括:
</span></span><span class=line><span class=cl>1. 性能提升(平均快25%)
</span></span><span class=line><span class=cl>2. 更好的错误提示...
</span></span><span class=line><span class=cl>来源: docs/python_releases.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>内容: Python 3.11引入了异常组(Exception Groups)和except*语法...
</span></span><span class=line><span class=cl>来源: docs/python_311_features.txt</span></span></code></pre></div><hr><h4 id=122-权重调优>1.2.2 权重调优<a class=anchor href=#122-%e6%9d%83%e9%87%8d%e8%b0%83%e4%bc%98>#</a></h4><p><strong>不同权重的效果</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 测试不同权重组合</span>
</span></span><span class=line><span class=cl><span class=n>test_weights</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>([</span><span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>],</span> <span class=s2>&#34;向量为主&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>([</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>],</span> <span class=s2>&#34;平衡&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>],</span> <span class=s2>&#34;BM25为主&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;如何安装Python 3.11&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>weights</span><span class=p>,</span> <span class=n>desc</span> <span class=ow>in</span> <span class=n>test_weights</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span><span class=o>=</span><span class=n>weights</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=n>desc</span><span class=si>}</span><span class=s2> (向量:</span><span class=si>{</span><span class=n>weights</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>, BM25:</span><span class=si>{</span><span class=n>weights</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Top-1: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>权重选择建议</strong>:</p><table><thead><tr><th>场景</th><th>推荐权重(向量:BM25)</th><th>原因</th></tr></thead><tbody><tr><td>问答系统</td><td>0.7:0.3</td><td>重视语义理解</td></tr><tr><td>文档搜索</td><td>0.5:0.5</td><td>平衡语义和关键词</td></tr><tr><td>代码搜索</td><td>0.3:0.7</td><td>精确匹配函数名、变量名</td></tr><tr><td>产品查询</td><td>0.4:0.6</td><td>型号、规格等精确匹配</td></tr></tbody></table><hr><h4 id=123-完整rag系统混合检索>1.2.3 完整RAG系统(混合检索)<a class=anchor href=#123-%e5%ae%8c%e6%95%b4rag%e7%b3%bb%e7%bb%9f%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 创建混合检索器(同上)</span>
</span></span><span class=line><span class=cl><span class=n>ensemble_retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=mf>0.6</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 包装为工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_docs</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索文档库,返回相关信息。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    适用于:
</span></span></span><span class=line><span class=cl><span class=s2>    - 查找产品文档
</span></span></span><span class=line><span class=cl><span class=s2>    - 搜索技术资料
</span></span></span><span class=line><span class=cl><span class=s2>    - 获取配置说明
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>ensemble_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># 格式化结果</span>
</span></span><span class=line><span class=cl>    <span class=n>formatted</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>[:</span><span class=mi>3</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>formatted</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;[文档</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>]</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;内容: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;来源: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>formatted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_docs</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个文档搜索助手,可以帮助用户查找技术文档。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用 search_docs 工具搜索相关信息,然后给出准确的回答。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 查询</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;Python 3.11相比3.10有哪些性能提升?&#34;</span><span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=124-rrfreciprocal-rank-fusion算法>1.2.4 RRF(Reciprocal Rank Fusion)算法<a class=anchor href=#124-rrfreciprocal-rank-fusion%e7%ae%97%e6%b3%95>#</a></h4><p><strong>RRF原理</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>对于文档d,其RRF分数 = Σ (1 / (k + rank_i(d)))
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>其中:
</span></span><span class=line><span class=cl>- rank_i(d):文档d在第i个检索器中的排名
</span></span><span class=line><span class=cl>- k:常数(通常为60)</span></span></code></pre></div><p><strong>手动实现RRF</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>reciprocal_rank_fusion</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever_results</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>],</span>  <span class=c1># 多个检索器的结果列表</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    RRF算法实现
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        retriever_results: [[doc1, doc2, ...], [doc3, doc1, ...], ...]
</span></span></span><span class=line><span class=cl><span class=s2>        k: RRF常数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        融合后的文档列表(按RRF分数排序)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 计算每个文档的RRF分数</span>
</span></span><span class=line><span class=cl>    <span class=n>doc_scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>retriever_docs</span> <span class=ow>in</span> <span class=n>retriever_results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rank</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>retriever_docs</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_id</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=nb>id</span><span class=p>(</span><span class=n>doc</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># RRF分数累加</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>doc_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>doc_scores</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>doc_scores</span><span class=p>[</span><span class=n>doc_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;doc&#39;</span><span class=p>:</span> <span class=n>doc</span><span class=p>,</span> <span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>doc_scores</span><span class=p>[</span><span class=n>doc_id</span><span class=p>][</span><span class=s1>&#39;score&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>k</span> <span class=o>+</span> <span class=n>rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 按分数排序</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_docs</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>doc_scores</span><span class=o>.</span><span class=n>values</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s1>&#39;score&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=n>item</span><span class=p>[</span><span class=s1>&#39;doc&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>sorted_docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>vector_results</span> <span class=o>=</span> <span class=n>vector_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Python 3.11&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bm25_results</span> <span class=o>=</span> <span class=n>bm25_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Python 3.11&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>fused_results</span> <span class=o>=</span> <span class=n>reciprocal_rank_fusion</span><span class=p>([</span><span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;融合后top-3文档:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>fused_results</span><span class=p>[:</span><span class=mi>3</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>RRF vs 加权平均</strong>:</p><table><thead><tr><th>方法</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>RRF</td><td>不需要归一化分数,鲁棒性强</td><td>忽略原始分数的绝对值</td><td>检索器评分尺度不同</td></tr><tr><td>加权平均</td><td>保留原始分数信息</td><td>需要归一化,对分数尺度敏感</td><td>检索器评分可比</td></tr></tbody></table><hr><h3 id=13-混合检索实战电商产品搜索>1.3 混合检索实战:电商产品搜索<a class=anchor href=#13-%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e5%ae%9e%e6%88%98%e7%94%b5%e5%95%86%e4%ba%a7%e5%93%81%e6%90%9c%e7%b4%a2>#</a></h3><h4 id=131-场景说明>1.3.1 场景说明<a class=anchor href=#131-%e5%9c%ba%e6%99%af%e8%af%b4%e6%98%8e>#</a></h4><p><strong>业务需求</strong>:</p><ul><li>用户查询:&ldquo;iPhone 14 Pro 256GB 紫色&rdquo;</li><li>需求1:精确匹配型号(iPhone 14 Pro)</li><li>需求2:精确匹配容量(256GB)</li><li>需求3:精确匹配颜色(紫色)</li><li>需求4:理解"最新款&rdquo;、&ldquo;旗舰机"等语义</li></ul><p><strong>为什么需要混合检索</strong>:</p><ul><li>纯向量检索:可能返回iPhone 13 Pro(语义相似)</li><li>纯BM25检索:可能返回"iPhone 14 普通版 256GB&rdquo;(关键词匹配)</li><li>混合检索:同时满足型号、容量、颜色的精确匹配</li></ul><hr><h4 id=132-完整实现>1.3.2 完整实现<a class=anchor href=#132-%e5%ae%8c%e6%95%b4%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>JSONLoader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span><span class=p>,</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers</span> <span class=kn>import</span> <span class=n>BM25Retriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>EnsembleRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 准备产品数据</span>
</span></span><span class=line><span class=cl><span class=n>products_data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 14 Pro 256GB 深空黑&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;手机&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;brand&#34;</span><span class=p>:</span> <span class=s2>&#34;Apple&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 14 Pro&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;storage&#34;</span><span class=p>:</span> <span class=s2>&#34;256GB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=s2>&#34;深空黑&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>8999</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Apple 最新旗舰手机,搭载A16芯片,4800万像素主摄,支持灵动岛交互&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 14 Pro 256GB 紫色&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;手机&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;brand&#34;</span><span class=p>:</span> <span class=s2>&#34;Apple&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 14 Pro&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;storage&#34;</span><span class=p>:</span> <span class=s2>&#34;256GB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=s2>&#34;紫色&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>8999</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;Apple 旗舰机型,紫色配色,256GB大容量存储,专业级摄影系统&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 13 Pro 256GB 远峰蓝&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;手机&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;brand&#34;</span><span class=p>:</span> <span class=s2>&#34;Apple&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;iPhone 13 Pro&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;storage&#34;</span><span class=p>:</span> <span class=s2>&#34;256GB&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;color&#34;</span><span class=p>:</span> <span class=s2>&#34;远峰蓝&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;price&#34;</span><span class=p>:</span> <span class=mi>7499</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;上一代旗舰,A15芯片,三摄系统,性价比之选&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转换为Document对象</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>product</span> <span class=ow>in</span> <span class=n>products_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 构建富文本描述(便于检索)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>产品名称:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>品牌:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;brand&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>型号:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>容量:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;storage&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>颜色:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;color&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>价格:¥</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>描述:</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;description&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>doc</span> <span class=o>=</span> <span class=n>Document</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>page_content</span><span class=o>=</span><span class=n>text</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span><span class=o>=</span><span class=n>product</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 创建混合检索器</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>,</span> <span class=n>embeddings</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>vector_retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bm25_retriever</span> <span class=o>=</span> <span class=n>BM25Retriever</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>k</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 产品搜索:BM25权重更高(精确匹配型号、容量、颜色)</span>
</span></span><span class=line><span class=cl><span class=n>product_retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>]</span>  <span class=c1># 更重视精确匹配</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建搜索工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_products</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索产品库,返回匹配的商品信息。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    适用于查询:
</span></span></span><span class=line><span class=cl><span class=s2>    - 手机型号搜索(如&#34;iPhone 14 Pro&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>    - 特定配置搜索(如&#34;256GB 紫色&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>    - 价格范围查询
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>product_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>formatted</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>meta</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span>
</span></span><span class=line><span class=cl>        <span class=n>formatted</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;【商品</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>】</span><span class=si>{</span><span class=n>meta</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;价格:¥</span><span class=si>{</span><span class=n>meta</span><span class=p>[</span><span class=s1>&#39;price&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;描述:</span><span class=si>{</span><span class=n>meta</span><span class=p>[</span><span class=s1>&#39;description&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>formatted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 创建购物助手Agent</span>
</span></span><span class=line><span class=cl><span class=n>shopping_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_products</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个专业的购物助手,帮助用户查找和推荐商品。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用 search_products 工具搜索商品信息,然后给出准确的推荐。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>注意:
</span></span></span><span class=line><span class=cl><span class=s2>- 优先推荐完全匹配用户需求的商品
</span></span></span><span class=line><span class=cl><span class=s2>- 如果没有完全匹配,推荐相近的替代品
</span></span></span><span class=line><span class=cl><span class=s2>- 清晰说明商品的价格和主要特点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5: 测试查询</span>
</span></span><span class=line><span class=cl><span class=n>test_queries</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;我想买iPhone 14 Pro 256GB 紫色&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;有没有256GB的紫色手机&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;8000元左右的Apple旗舰机&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>test_queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=si>{</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>50</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;用户查询:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;=&#39;</span><span class=o>*</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>shopping_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>}]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=14-混合检索最佳实践>1.4 混合检索最佳实践<a class=anchor href=#14-%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><h4 id=141-权重调优策略>1.4.1 权重调优策略<a class=anchor href=#141-%e6%9d%83%e9%87%8d%e8%b0%83%e4%bc%98%e7%ad%96%e7%95%a5>#</a></h4><p><strong>A/B测试不同权重</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>evaluate_retrieval</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>test_queries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>ground_truth</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span>  <span class=c1># 每个查询的正确文档ID列表</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;评估检索器性能&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>precisions</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>recalls</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>query</span><span class=p>,</span> <span class=n>truth_ids</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>test_queries</span><span class=p>,</span> <span class=n>ground_truth</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算Precision@K</span>
</span></span><span class=line><span class=cl>        <span class=n>hits</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>retrieved_ids</span><span class=p>)</span> <span class=o>&amp;</span> <span class=nb>set</span><span class=p>(</span><span class=n>truth_ids</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>precision</span> <span class=o>=</span> <span class=n>hits</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_ids</span><span class=p>)</span> <span class=k>if</span> <span class=n>retrieved_ids</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>recall</span> <span class=o>=</span> <span class=n>hits</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>truth_ids</span><span class=p>)</span> <span class=k>if</span> <span class=n>truth_ids</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>precisions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>precision</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recalls</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>recall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;precision&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>precisions</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>precisions</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;recall&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>recalls</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recalls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试不同权重</span>
</span></span><span class=line><span class=cl><span class=n>test_queries</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;iPhone 14 Pro 256GB 紫色&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;8000元左右的旗舰机&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Apple最新手机&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ground_truth</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s2>&#34;2&#34;</span><span class=p>],</span>  <span class=c1># 精确匹配</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>,</span> <span class=s2>&#34;3&#34;</span><span class=p>],</span>  <span class=c1># 价格范围</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;2&#34;</span><span class=p>]</span>  <span class=c1># 最新型号</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>weights_to_test</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.6</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;权重调优结果:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>vec_weight</span><span class=p>,</span> <span class=n>bm25_weight</span> <span class=ow>in</span> <span class=n>weights_to_test</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=n>vec_weight</span><span class=p>,</span> <span class=n>bm25_weight</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>evaluate_retrieval</span><span class=p>(</span><span class=n>retriever</span><span class=p>,</span> <span class=n>test_queries</span><span class=p>,</span> <span class=n>ground_truth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;向量:</span><span class=si>{</span><span class=n>vec_weight</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>, BM25:</span><span class=si>{</span><span class=n>bm25_weight</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> =&gt; &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;Precision: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;precision&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>, &#34;</span>
</span></span><span class=line><span class=cl>          <span class=sa>f</span><span class=s2>&#34;Recall: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;recall&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=142-何时使用混合检索>1.4.2 何时使用混合检索<a class=anchor href=#142-%e4%bd%95%e6%97%b6%e4%bd%bf%e7%94%a8%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2>#</a></h4><p><strong>决策树</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>查询类型
</span></span><span class=line><span class=cl>├── 包含精确关键词(型号、版本、规格)
</span></span><span class=line><span class=cl>│   └── 使用混合检索(BM25权重0.5-0.7)
</span></span><span class=line><span class=cl>├── 自然语言问句
</span></span><span class=line><span class=cl>│   └── 使用混合检索(向量权重0.6-0.7)
</span></span><span class=line><span class=cl>├── 纯语义查询(概念、主题)
</span></span><span class=line><span class=cl>│   └── 仅使用向量检索
</span></span><span class=line><span class=cl>└── 代码/命令搜索
</span></span><span class=line><span class=cl>    └── 使用混合检索(BM25权重0.7-0.8)</span></span></code></pre></div><p><strong>实际案例</strong>:</p><table><thead><tr><th>查询示例</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>&ldquo;Python 3.11 新特性&rdquo;</td><td>混合(0.4:0.6)</td><td>&ldquo;3.11"需要精确匹配</td></tr><tr><td>&ldquo;如何提升程序性能&rdquo;</td><td>向量为主(0.7:0.3)</td><td>纯语义查询</td></tr><tr><td>&ldquo;numpy.array()用法&rdquo;</td><td>BM25为主(0.3:0.7)</td><td>函数名精确匹配</td></tr><tr><td>&ldquo;深度学习入门教程&rdquo;</td><td>向量为主(0.7:0.3)</td><td>主题相关性</td></tr></tbody></table><hr><h3 id=小结>小结<a class=anchor href=#%e5%b0%8f%e7%bb%93>#</a></h3><p><strong>混合检索核心要点</strong>:</p><ol><li><p><strong>何时使用</strong>:</p><ul><li>✅ 查询包含精确关键词(版本号、型号、专有名词)</li><li>✅ 需要平衡语义理解和精确匹配</li><li>❌ 纯概念性问题可直接使用向量检索</li></ul></li><li><p><strong>权重选择</strong>:</p><ul><li>问答系统:0.6-0.7(向量): 0.3-0.4(BM25)</li><li>产品搜索:0.4(向量): 0.6(BM25)</li><li>代码搜索:0.3(向量): 0.7(BM25)</li></ul></li><li><p><strong>融合算法</strong>:</p><ul><li>简单加权:LangChain的EnsembleRetriever</li><li>RRF:更鲁棒,适合分数尺度不同的检索器</li></ul></li><li><p><strong>性能提升</strong>:</p><ul><li>召回率:+20-30%</li><li>精确率:+15-25%</li><li>查询延迟:+30-50ms(可接受)</li></ul></li></ol><p><strong>下一章预告</strong>:
第2章将深入探讨<strong>重排序技术(Reranking)</strong>,进一步提升top-k结果的精确度。</p><hr><h2 id=第2章重排序技术reranking>第2章:重排序技术(Reranking)<a class=anchor href=#%e7%ac%ac2%e7%ab%a0%e9%87%8d%e6%8e%92%e5%ba%8f%e6%8a%80%e6%9c%afreranking>#</a></h2><h3 id=21-为什么需要重排序>2.1 为什么需要重排序<a class=anchor href=#21-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e9%87%8d%e6%8e%92%e5%ba%8f>#</a></h3><h4 id=211-检索器的局限性>2.1.1 检索器的局限性<a class=anchor href=#211-%e6%a3%80%e7%b4%a2%e5%99%a8%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7>#</a></h4><p><strong>问题场景</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 用户查询:&#34;如何在Python中实现多线程安全的单例模式?&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向量检索top-5结果:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. &#34;Python单例模式实现&#34;(相关度:0.85)</span>
</span></span><span class=line><span class=cl><span class=c1># 2. &#34;多线程编程基础&#34;(相关度:0.82)</span>
</span></span><span class=line><span class=cl><span class=c1># 3. &#34;Python设计模式大全&#34;(相关度:0.80)← 内容太泛化</span>
</span></span><span class=line><span class=cl><span class=c1># 4. &#34;线程安全的单例模式&#34;(相关度:0.78)← 应该排更前</span>
</span></span><span class=line><span class=cl><span class=c1># 5. &#34;Python线程锁使用&#34;(相关度:0.75)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 问题:</span>
</span></span><span class=line><span class=cl><span class=c1># - 第3个文档太泛化,但相关度分数高</span>
</span></span><span class=line><span class=cl><span class=c1># - 第4个文档最相关,但排序靠后</span></span></span></code></pre></div><p><strong>向量检索的问题</strong>:</p><ol><li><strong>语义相似≠查询相关</strong>:文档可能语义相似,但不回答具体问题</li><li><strong>粗粒度排序</strong>:基于embedding的余弦相似度,无法理解查询意图</li><li><strong>上下文缺失</strong>:不考虑查询和文档的交互关系</li></ol><hr><h4 id=212-重排序的作用>2.1.2 重排序的作用<a class=anchor href=#212-%e9%87%8d%e6%8e%92%e5%ba%8f%e7%9a%84%e4%bd%9c%e7%94%a8>#</a></h4><p><strong>重排序流程</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>原始检索(快速,粗排)→ top-100候选
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>重排序模型(精细,慢)→ top-5最终结果
</span></span><span class=line><span class=cl>         ↓
</span></span><span class=line><span class=cl>LLM生成</span></span></code></pre></div><p><strong>优势</strong>:</p><ul><li><strong>精细化理解</strong>:使用Cross-Encoder深度理解查询-文档匹配度</li><li><strong>提升精确度</strong>:top-5结果的精确度提升15-30%</li><li><strong>成本优化</strong>:只对top-K候选重排,计算开销可控</li></ul><hr><h4 id=213-重排序-vs-检索器>2.1.3 重排序 vs 检索器<a class=anchor href=#213-%e9%87%8d%e6%8e%92%e5%ba%8f-vs-%e6%a3%80%e7%b4%a2%e5%99%a8>#</a></h4><table><thead><tr><th>维度</th><th>检索器(Retriever)</th><th>重排序器(Reranker)</th></tr></thead><tbody><tr><td><strong>模型结构</strong></td><td>Bi-Encoder(查询和文档分别编码)</td><td>Cross-Encoder(联合编码)</td></tr><tr><td><strong>速度</strong></td><td>快(预计算文档向量)</td><td>慢(实时计算交互分数)</td></tr><tr><td><strong>精度</strong></td><td>中等(余弦相似度)</td><td>高(深度语义匹配)</td></tr><tr><td><strong>适用阶段</strong></td><td>初筛(从百万文档找top-100)</td><td>精排(从top-100找top-5)</td></tr><tr><td><strong>计算成本</strong></td><td>低</td><td>高</td></tr></tbody></table><hr><h3 id=22-langchain重排序实现>2.2 LangChain重排序实现<a class=anchor href=#22-langchain%e9%87%8d%e6%8e%92%e5%ba%8f%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=221-基于contextualcompressionretriever>2.2.1 基于ContextualCompressionRetriever<a class=anchor href=#221-%e5%9f%ba%e4%ba%8econtextualcompressionretriever>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>ContextualCompressionRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers.document_compressors</span> <span class=kn>import</span> <span class=n>LLMChainExtractor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span><span class=p>,</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>DirectoryLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 准备文档</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>DirectoryLoader</span><span class=p>(</span><span class=s2>&#34;./docs&#34;</span><span class=p>,</span> <span class=n>glob</span><span class=o>=</span><span class=s2>&#34;**/*.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>splits</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 创建基础检索器(粗排)</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>splits</span><span class=p>,</span> <span class=n>embeddings</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>base_retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}</span>  <span class=c1># 先检索20个候选</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建LLM压缩器(精排)</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>compressor</span> <span class=o>=</span> <span class=n>LLMChainExtractor</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span><span class=n>llm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 组合为压缩检索器</span>
</span></span><span class=line><span class=cl><span class=n>compression_retriever</span> <span class=o>=</span> <span class=n>ContextualCompressionRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>base_compressor</span><span class=o>=</span><span class=n>compressor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>base_retriever</span><span class=o>=</span><span class=n>base_retriever</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5: 使用</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;如何在Python中实现线程安全的单例模式?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>compressed_docs</span> <span class=o>=</span> <span class=n>compression_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;原始检索器返回:20个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;重排序后返回:</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>compressed_docs</span><span class=p>)</span><span class=si>}</span><span class=s2>个文档</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>compressed_docs</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;【文档</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>】&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;内容:</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>150</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;来源:</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>工作原理</strong>:</p><ol><li>base_retriever检索20个候选文档</li><li>LLMChainExtractor使用LLM评估每个文档与查询的相关性</li><li>提取最相关的内容片段</li><li>返回精排后的文档(通常&lt;10个)</li></ol><hr><h4 id=222-使用embeddingsfilter基于embedding距离>2.2.2 使用EmbeddingsFilter(基于embedding距离)<a class=anchor href=#222-%e4%bd%bf%e7%94%a8embeddingsfilter%e5%9f%ba%e4%ba%8eembedding%e8%b7%9d%e7%a6%bb>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers.document_compressors</span> <span class=kn>import</span> <span class=n>EmbeddingsFilter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建embedding过滤器</span>
</span></span><span class=line><span class=cl><span class=n>embeddings_filter</span> <span class=o>=</span> <span class=n>EmbeddingsFilter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>embeddings</span><span class=o>=</span><span class=n>OpenAIEmbeddings</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_threshold</span><span class=o>=</span><span class=mf>0.75</span>  <span class=c1># 相似度阈值</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合为压缩检索器</span>
</span></span><span class=line><span class=cl><span class=n>compression_retriever</span> <span class=o>=</span> <span class=n>ContextualCompressionRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>base_compressor</span><span class=o>=</span><span class=n>embeddings_filter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>base_retriever</span><span class=o>=</span><span class=n>base_retriever</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;Python单例模式实现&#34;</span>
</span></span><span class=line><span class=cl><span class=n>filtered_docs</span> <span class=o>=</span> <span class=n>compression_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;过滤前:</span><span class=si>{</span><span class=mi>20</span><span class=si>}</span><span class=s2>个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;过滤后:</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>filtered_docs</span><span class=p>)</span><span class=si>}</span><span class=s2>个文档(相似度≥0.75)&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>优势</strong>:</p><ul><li>速度快(基于预计算的embedding)</li><li>成本低(无需调用LLM)</li></ul><p><strong>劣势</strong>:</p><ul><li>精度不如LLM压缩器</li><li>仍基于余弦相似度</li></ul><hr><h4 id=223-本地重排序模型cross-encoder>2.2.3 本地重排序模型(Cross-Encoder)<a class=anchor href=#223-%e6%9c%ac%e5%9c%b0%e9%87%8d%e6%8e%92%e5%ba%8f%e6%a8%a1%e5%9e%8bcross-encoder>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sentence_transformers</span> <span class=kn>import</span> <span class=n>CrossEncoder</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CrossEncoderReranker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于Cross-Encoder的重排序器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;BAAI/bge-reranker-large&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        初始化Cross-Encoder重排序器
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            model_name: HuggingFace模型名称
</span></span></span><span class=line><span class=cl><span class=s2>                - BAAI/bge-reranker-base(英文,速度快)
</span></span></span><span class=line><span class=cl><span class=s2>                - BAAI/bge-reranker-large(英文,精度高)
</span></span></span><span class=line><span class=cl><span class=s2>                - BAAI/bge-reranker-v2-m3(多语言,推荐中文)
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>CrossEncoder</span><span class=p>(</span><span class=n>model_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>rerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>top_n</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        重排序文档列表
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Args:
</span></span></span><span class=line><span class=cl><span class=s2>            query: 用户查询
</span></span></span><span class=line><span class=cl><span class=s2>            documents: 候选文档列表
</span></span></span><span class=line><span class=cl><span class=s2>            top_n: 返回top-N个文档
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Returns:
</span></span></span><span class=line><span class=cl><span class=s2>            重排序后的文档列表
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 构建查询-文档对</span>
</span></span><span class=line><span class=cl>        <span class=n>pairs</span> <span class=o>=</span> <span class=p>[[</span><span class=n>query</span><span class=p>,</span> <span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>]</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算相关性分数</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>predict</span><span class=p>(</span><span class=n>pairs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 按分数排序</span>
</span></span><span class=line><span class=cl>        <span class=n>doc_scores</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>documents</span><span class=p>,</span> <span class=n>scores</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>doc_scores</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 返回top-N</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>doc_scores</span><span class=p>[:</span><span class=n>top_n</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>reranker</span> <span class=o>=</span> <span class=n>CrossEncoderReranker</span><span class=p>(</span><span class=n>model_name</span><span class=o>=</span><span class=s2>&#34;BAAI/bge-reranker-v2-m3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 先用向量检索获取候选</span>
</span></span><span class=line><span class=cl><span class=n>base_results</span> <span class=o>=</span> <span class=n>base_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Python单例模式线程安全实现&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;初筛文档数:</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>base_results</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重排序</span>
</span></span><span class=line><span class=cl><span class=n>reranked_results</span> <span class=o>=</span> <span class=n>reranker</span><span class=o>.</span><span class=n>rerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;Python单例模式线程安全实现&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>base_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>top_n</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>重排序后top-5:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>reranked_results</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>推荐模型对比</strong>:</p><table><thead><tr><th>模型</th><th>语言</th><th>参数量</th><th>速度</th><th>精度</th><th>适用场景</th></tr></thead><tbody><tr><td><code>BAAI/bge-reranker-base</code></td><td>英文</td><td>110M</td><td>快</td><td>★★★</td><td>英文通用</td></tr><tr><td><code>BAAI/bge-reranker-large</code></td><td>英文</td><td>340M</td><td>中</td><td>★★★★</td><td>英文精度优先</td></tr><tr><td><code>BAAI/bge-reranker-v2-m3</code></td><td>多语言</td><td>560M</td><td>中</td><td>★★★★★</td><td>中文/多语言</td></tr><tr><td><code>cross-encoder/ms-marco-MiniLM-L-6-v2</code></td><td>英文</td><td>23M</td><td>快</td><td>★★★</td><td>速度优先</td></tr></tbody></table><hr><h4 id=224-集成到完整rag系统>2.2.4 集成到完整RAG系统<a class=anchor href=#224-%e9%9b%86%e6%88%90%e5%88%b0%e5%ae%8c%e6%95%b4rag%e7%b3%bb%e7%bb%9f>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 创建带重排序的检索器</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RerankedRetriever</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带重排序的检索器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>base_retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>reranker</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>initial_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>final_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_retriever</span> <span class=o>=</span> <span class=n>base_retriever</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reranker</span> <span class=o>=</span> <span class=n>reranker</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>initial_k</span> <span class=o>=</span> <span class=n>initial_k</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>final_k</span> <span class=o>=</span> <span class=n>final_k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>invoke</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行检索和重排序&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 粗排:检索initial_k个候选</span>
</span></span><span class=line><span class=cl>        <span class=n>candidates</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>base_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 精排:重排序并返回final_k个</span>
</span></span><span class=line><span class=cl>        <span class=n>reranked</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>reranker</span><span class=o>.</span><span class=n>rerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span><span class=o>=</span><span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span><span class=o>=</span><span class=n>candidates</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>top_n</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>final_k</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>reranked</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建检索器实例</span>
</span></span><span class=line><span class=cl><span class=n>reranked_retriever</span> <span class=o>=</span> <span class=n>RerankedRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>base_retriever</span><span class=o>=</span><span class=n>base_retriever</span><span class=p>,</span>  <span class=c1># 粗排检索器</span>
</span></span><span class=line><span class=cl>    <span class=n>reranker</span><span class=o>=</span><span class=n>CrossEncoderReranker</span><span class=p>(</span><span class=s2>&#34;BAAI/bge-reranker-v2-m3&#34;</span><span class=p>),</span>  <span class=c1># 重排序器</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_k</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>  <span class=c1># 粗排top-20</span>
</span></span><span class=line><span class=cl>    <span class=n>final_k</span><span class=o>=</span><span class=mi>5</span>      <span class=c1># 精排top-5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 包装为工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_docs_with_rerank</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索文档库并重排序,返回最相关的内容。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    使用两阶段检索:
</span></span></span><span class=line><span class=cl><span class=s2>    1. 向量检索:快速筛选top-20候选
</span></span></span><span class=line><span class=cl><span class=s2>    2. Cross-Encoder重排序:精确排序top-5结果
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>reranked_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>formatted</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>formatted</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;【文档</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>】</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;来源:</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;unknown&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>formatted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_docs_with_rerank</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个技术文档助手,帮助用户查找和理解技术文档。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用 search_docs_with_rerank 工具搜索相关文档,然后给出详细的技术解答。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>注意:
</span></span></span><span class=line><span class=cl><span class=s2>- 优先使用检索到的文档内容
</span></span></span><span class=line><span class=cl><span class=s2>- 如果文档中有代码示例,请引用
</span></span></span><span class=line><span class=cl><span class=s2>- 保持回答的专业性和准确性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 测试</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;Python中如何实现线程安全的单例模式?请给出完整代码示例。&#34;</span><span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><p><strong>性能对比</strong>:</p><table><thead><tr><th>检索方案</th><th>精确度@5</th><th>查询延迟</th><th>成本</th></tr></thead><tbody><tr><td>仅向量检索</td><td>65%</td><td>50ms</td><td>$</td></tr><tr><td>向量+Embedding过滤</td><td>72%</td><td>80ms</td><td>$</td></tr><tr><td>向量+LLM压缩</td><td>85%</td><td>2000ms</td><td>$$$</td></tr><tr><td>向量+Cross-Encoder</td><td>88%</td><td>150ms</td><td>$</td></tr></tbody></table><hr><h3 id=23-查询改写query-rewriting>2.3 查询改写(Query Rewriting)<a class=anchor href=#23-%e6%9f%a5%e8%af%a2%e6%94%b9%e5%86%99query-rewriting>#</a></h3><h4 id=231-多查询生成multi-query>2.3.1 多查询生成(Multi-Query)<a class=anchor href=#231-%e5%a4%9a%e6%9f%a5%e8%af%a2%e7%94%9f%e6%88%90multi-query>#</a></h4><p><strong>问题</strong>:用户查询可能表达不清晰</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 原始查询:&#34;怎么让Python快一点&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 问题:</span>
</span></span><span class=line><span class=cl><span class=c1># - 表达模糊(&#34;快一点&#34;指什么?)</span>
</span></span><span class=line><span class=cl><span class=c1># - 可能遗漏相关文档</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解决方案:生成多个改写查询</span>
</span></span><span class=line><span class=cl><span class=c1># 1. &#34;如何优化Python代码性能&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 2. &#34;Python程序加速方法&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 3. &#34;提升Python执行效率的技巧&#34;</span></span></span></code></pre></div><p><strong>实现</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>MultiQueryRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Multi-Query检索器</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>multi_query_retriever</span> <span class=o>=</span> <span class=n>MultiQueryRetriever</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用(自动生成3-5个改写查询并检索)</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;怎么让Python快一点&#34;</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>multi_query_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检索到</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s2>个文档(去重后)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[:</span><span class=mi>3</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;- </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>工作流程</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户查询:&#34;怎么让Python快一点&#34;
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>LLM生成改写查询:
</span></span><span class=line><span class=cl>    ├── &#34;如何优化Python代码性能&#34;
</span></span><span class=line><span class=cl>    ├── &#34;Python程序加速方法&#34;
</span></span><span class=line><span class=cl>    └── &#34;提升Python执行效率的技巧&#34;
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>并行检索3个查询
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>合并 + 去重
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>返回结果</span></span></code></pre></div><hr><h3 id=小结-1>小结<a class=anchor href=#%e5%b0%8f%e7%bb%93-1>#</a></h3><p><strong>重排序技术核心要点</strong>:</p><ol><li><p><strong>何时使用重排序</strong>:</p><ul><li>✅ 精度要求高的场景(客服、医疗、法律)</li><li>✅ top-K结果质量不稳定</li><li>❌ 实时性要求极高(&lt;100ms)</li></ul></li><li><p><strong>重排序方案选择</strong>:</p><ul><li><strong>Embedding过滤</strong>:速度快,成本低,精度提升有限(+7%)</li><li><strong>Cross-Encoder</strong>:平衡方案,精度高(+23%),延迟可接受(+100ms)</li><li><strong>LLM压缩</strong>:精度最高(+20%),成本高(每查询$0.02-0.05)</li></ul></li><li><p><strong>查询改写技术</strong>:</p><ul><li><strong>Multi-Query</strong>:处理模糊查询,召回率+15%</li></ul></li></ol><p><strong>下一章预告</strong>:
第3章将探讨<strong>知识图谱RAG(GraphRAG)</strong>,如何利用结构化知识提升多跳推理能力。</p><hr><h2 id=第3章知识图谱raggraphrag>第3章:知识图谱RAG(GraphRAG)<a class=anchor href=#%e7%ac%ac3%e7%ab%a0%e7%9f%a5%e8%af%86%e5%9b%be%e8%b0%b1raggraphrag>#</a></h2><h3 id=31-为什么需要知识图谱rag>3.1 为什么需要知识图谱RAG<a class=anchor href=#31-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%9f%a5%e8%af%86%e5%9b%be%e8%b0%b1rag>#</a></h3><h4 id=311-向量rag的局限性>3.1.1 向量RAG的局限性<a class=anchor href=#311-%e5%90%91%e9%87%8frag%e7%9a%84%e5%b1%80%e9%99%90%e6%80%a7>#</a></h4><p><strong>问题场景</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>查询:&#34;张三的领导的领导是谁?&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>向量RAG:
</span></span><span class=line><span class=cl>├── 检索到:&#34;张三的直接领导是李四&#34;
</span></span><span class=line><span class=cl>├── 检索到:&#34;李四的绩效评估为优秀&#34;
</span></span><span class=line><span class=cl>└── ❌ 无法推理出&#34;张三的领导的领导&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>知识图谱RAG:
</span></span><span class=line><span class=cl>├── 实体:张三 --[reports_to]--&gt; 李四
</span></span><span class=line><span class=cl>├── 实体:李四 --[reports_to]--&gt; 王五
</span></span><span class=line><span class=cl>└── ✅ 推理:张三 --&gt; 李四 --&gt; 王五(多跳查询)</span></span></code></pre></div><p><strong>向量RAG vs 知识图谱RAG</strong>:</p><table><thead><tr><th>维度</th><th>向量RAG</th><th>知识图谱RAG</th></tr></thead><tbody><tr><td><strong>数据表示</strong></td><td>非结构化文本</td><td>结构化三元组(主-谓-宾)</td></tr><tr><td><strong>检索方式</strong></td><td>语义相似度</td><td>图遍历+语义匹配</td></tr><tr><td><strong>多跳推理</strong></td><td>❌ 弱</td><td>✅ 强</td></tr><tr><td><strong>实体关系</strong></td><td>❌ 隐式</td><td>✅ 显式</td></tr><tr><td><strong>适用场景</strong></td><td>文档问答</td><td>复杂关系查询</td></tr></tbody></table><hr><h3 id=32-neo4j--langchain实现>3.2 Neo4j + LangChain实现<a class=anchor href=#32-neo4j--langchain%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=321-环境准备>3.2.1 环境准备<a class=anchor href=#321-%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装Neo4j(使用Docker)</span>
</span></span><span class=line><span class=cl>docker run <span class=se>\
</span></span></span><span class=line><span class=cl>    --name neo4j <span class=se>\
</span></span></span><span class=line><span class=cl>    -p 7474:7474 -p 7687:7687 <span class=se>\
</span></span></span><span class=line><span class=cl>    -e <span class=nv>NEO4J_AUTH</span><span class=o>=</span>neo4j/password <span class=se>\
</span></span></span><span class=line><span class=cl>    neo4j:latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装Python依赖</span>
</span></span><span class=line><span class=cl>pip install langchain-community langchain-neo4j neo4j</span></span></code></pre></div><h4 id=322-基础知识图谱rag>3.2.2 基础知识图谱RAG<a class=anchor href=#322-%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86%e5%9b%be%e8%b0%b1rag>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.graphs</span> <span class=kn>import</span> <span class=n>Neo4jGraph</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.chains.graph_qa.cypher</span> <span class=kn>import</span> <span class=n>GraphCypherQAChain</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 连接Neo4j</span>
</span></span><span class=line><span class=cl><span class=n>graph</span> <span class=o>=</span> <span class=n>Neo4jGraph</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=o>=</span><span class=s2>&#34;bolt://localhost:7687&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=o>=</span><span class=s2>&#34;neo4j&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=o>=</span><span class=s2>&#34;password&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 构建示例知识图谱</span>
</span></span><span class=line><span class=cl><span class=c1># 创建组织架构图</span>
</span></span><span class=line><span class=cl><span class=n>graph</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>// 创建员工节点
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (张三:Employee {name: &#39;张三&#39;, position: &#39;工程师&#39;, department: &#39;研发部&#39;})
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (李四:Employee {name: &#39;李四&#39;, position: &#39;技术经理&#39;, department: &#39;研发部&#39;})
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (王五:Employee {name: &#39;王五&#39;, position: &#39;技术总监&#39;, department: &#39;研发部&#39;})
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (赵六:Employee {name: &#39;赵六&#39;, position: &#39;产品经理&#39;, department: &#39;产品部&#39;})
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>// 创建汇报关系
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (张三)-[:REPORTS_TO]-&gt;(李四)
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (李四)-[:REPORTS_TO]-&gt;(王五)
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (赵六)-[:REPORTS_TO]-&gt;(王五)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>// 创建项目节点和参与关系
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (项目A:Project {name: &#39;项目A&#39;, status: &#39;进行中&#39;})
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (张三)-[:WORKS_ON]-&gt;(项目A)
</span></span></span><span class=line><span class=cl><span class=s2>CREATE (赵六)-[:WORKS_ON]-&gt;(项目A)
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: 创建Cypher QA链</span>
</span></span><span class=line><span class=cl><span class=n>cypher_chain</span> <span class=o>=</span> <span class=n>GraphCypherQAChain</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>graph</span><span class=o>=</span><span class=n>graph</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 查询(自动生成Cypher语句)</span>
</span></span><span class=line><span class=cl><span class=n>queries</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;张三的领导是谁?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;张三的领导的领导是谁?&#34;</span><span class=p>,</span>  <span class=c1># 多跳查询</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;研发部有哪些人?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;项目A有哪些参与者?&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>查询:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>cypher_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;答案:</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;result&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>输出示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>查询:张三的领导是谁?
</span></span><span class=line><span class=cl>生成Cypher:
</span></span><span class=line><span class=cl>MATCH (e:Employee {name: &#39;张三&#39;})-[:REPORTS_TO]-&gt;(manager)
</span></span><span class=line><span class=cl>RETURN manager.name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>答案:张三的领导是李四
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>查询:张三的领导的领导是谁?
</span></span><span class=line><span class=cl>生成Cypher:
</span></span><span class=line><span class=cl>MATCH (e:Employee {name: &#39;张三&#39;})-[:REPORTS_TO*2]-&gt;(manager)
</span></span><span class=line><span class=cl>RETURN manager.name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>答案:张三的领导的领导是王五</span></span></code></pre></div><hr><h4 id=323-graphrag-向量--图遍历-neo4jvector>3.2.3 GraphRAG: 向量 + 图遍历 (Neo4jVector)<a class=anchor href=#323-graphrag-%e5%90%91%e9%87%8f--%e5%9b%be%e9%81%8d%e5%8e%86-neo4jvector>#</a></h4><p>真正的 GraphRAG 不仅仅是让 Agent 多一个查图的工具，而是利用"向量搜索"作为图入口，结合图遍历获取上下文。</p><p><strong>工作流程</strong>:</p><ol><li><strong>Indexing</strong>: 提取文档中的实体(Nodes)和关系(Relationships)存入Neo4j，并对实体文本或文档块进行Embedding。</li><li><strong>Retrieval</strong>:<ul><li>Step 1: Query -> Vector Search -> 找到最相似的实体节点(Entry Points)。</li><li>Step 2: Graph Traversal -> 从入口节点出发，遍历获取邻居节点(Context)。</li></ul></li><li><strong>Generation</strong>: 将结构化上下文(邻居关系)提交给LLM回答。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.vectorstores</span> <span class=kn>import</span> <span class=n>Neo4jVector</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用Neo4jVector实现&#34;向量入口 + 图遍历&#34;的检索</span>
</span></span><span class=line><span class=cl><span class=c1># 假设Graph中已经存在 Employee 节点, 且包含 &#34;name&#34;, &#34;position&#34; 等属性</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 创建向量检索器 (连接现有的图)</span>
</span></span><span class=line><span class=cl><span class=n>vector_store</span> <span class=o>=</span> <span class=n>Neo4jVector</span><span class=o>.</span><span class=n>from_existing_graph</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>OpenAIEmbeddings</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span><span class=o>=</span><span class=s2>&#34;bolt://localhost:7687&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span><span class=o>=</span><span class=s2>&#34;neo4j&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>password</span><span class=o>=</span><span class=s2>&#34;password&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>index_name</span><span class=o>=</span><span class=s2>&#34;employee_index&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>node_label</span><span class=o>=</span><span class=s2>&#34;Employee&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>text_node_properties</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=s2>&#34;position&#34;</span><span class=p>,</span> <span class=s2>&#34;department&#34;</span><span class=p>],</span> <span class=c1># 这些属性内容会被向量化</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding_node_property</span><span class=o>=</span><span class=s2>&#34;embedding&#34;</span><span class=p>,</span> <span class=c1># 向量存放在节点的embedding属性中</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 【核心Magic】retrieval_query: 向量检索找到节点后, 执行此Cypher获取上下文</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里的 &#39;node&#39; 是向量匹配到的节点</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieval_query</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    // 找到该员工的直接下属 (1跳关系)
</span></span></span><span class=line><span class=cl><span class=s2>    MATCH (node)&lt;-[:REPORTS_TO]-(subordinate)
</span></span></span><span class=line><span class=cl><span class=s2>    RETURN &#34;员工: &#34; + node.name + &#34; (&#34; + node.position + &#34;)&#34; +
</span></span></span><span class=line><span class=cl><span class=s2>           &#34; 管理着: &#34; + subordinate.name + &#34; (&#34; + subordinate.position + &#34;)&#34; AS text,
</span></span></span><span class=line><span class=cl><span class=s2>           score,
</span></span></span><span class=line><span class=cl><span class=s2>           </span><span class=si>{}</span><span class=s2> AS metadata
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 执行检索</span>
</span></span><span class=line><span class=cl><span class=c1># 查询: &#34;谁是李四的下属?&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 向量检索找到 &#34;李四&#34; 节点</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 执行 retrieval_query 找到李四的下属</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vector_store</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=s2>&#34;李四&#34;</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;GraphRAG检索结果:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出示例:</span>
</span></span><span class=line><span class=cl><span class=c1># 员工: 李四 (技术经理) 管理着: 张三 (工程师)</span></span></span></code></pre></div><hr><h3 id=33-graphrag-vs-传统rag性能对比>3.3 GraphRAG vs 传统RAG性能对比<a class=anchor href=#33-graphrag-vs-%e4%bc%a0%e7%bb%9frag%e6%80%a7%e8%83%bd%e5%af%b9%e6%af%94>#</a></h3><table><thead><tr><th>查询类型</th><th>传统RAG准确率</th><th>GraphRAG准确率</th><th>提升</th></tr></thead><tbody><tr><td>单跳关系查询</td><td>75%</td><td>95%</td><td>+20%</td></tr><tr><td>多跳关系查询</td><td>30%</td><td>88%</td><td>+58%</td></tr><tr><td>描述性问答</td><td>85%</td><td>87%</td><td>+2%</td></tr><tr><td>混合查询</td><td>55%</td><td>82%</td><td>+27%</td></tr></tbody></table><p><strong>适用场景</strong>:</p><ul><li>✅ 组织架构、家族关系等层次结构</li><li>✅ 供应链、知识网络等复杂关系网</li><li>✅ 需要多跳推理的查询</li><li>❌ 纯文本问答(传统RAG更简单)</li></ul><hr><h2 id=第4章前沿rag方案>第4章:前沿RAG方案<a class=anchor href=#%e7%ac%ac4%e7%ab%a0%e5%89%8d%e6%b2%bfrag%e6%96%b9%e6%a1%88>#</a></h2><h3 id=41-self-rag自我反思检索>4.1 Self-RAG(自我反思检索)<a class=anchor href=#41-self-rag%e8%87%aa%e6%88%91%e5%8f%8d%e6%80%9d%e6%a3%80%e7%b4%a2>#</a></h3><h4 id=411-核心思想>4.1.1 核心思想<a class=anchor href=#411-%e6%a0%b8%e5%bf%83%e6%80%9d%e6%83%b3>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>传统RAG:
</span></span><span class=line><span class=cl>查询 → 检索 → 生成
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Self-RAG:
</span></span><span class=line><span class=cl>查询 → 检索 → 评估相关性 → 生成 → 验证答案 → (重新检索)</span></span></code></pre></div><p><strong>关键步骤</strong>:</p><ol><li><strong>检索决策</strong>:判断是否需要检索</li><li><strong>相关性评估</strong>:评估检索文档是否相关</li><li><strong>答案生成</strong>:基于文档生成答案</li><li><strong>答案验证</strong>:验证答案是否被文档支持</li><li><strong>迭代改进</strong>:如果不满意,重新检索</li></ol><hr><h4 id=412-简化实现>4.1.2 简化实现<a class=anchor href=#412-%e7%ae%80%e5%8c%96%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SelfRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Self-RAG实现&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>retriever</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>=</span> <span class=n>retriever</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 相关性评估提示词</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>relevance_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>评估以下文档与查询的相关性。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>查询:</span><span class=si>{query}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档:
</span></span></span><span class=line><span class=cl><span class=si>{document}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>相关性(0-10分):
</span></span></span><span class=line><span class=cl><span class=s2>理由:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 答案验证提示词</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>verification_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>验证答案是否被文档支持。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>查询:</span><span class=si>{query}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>答案:</span><span class=si>{answer}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档:
</span></span></span><span class=line><span class=cl><span class=si>{documents}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>验证结果(支持/不支持):
</span></span></span><span class=line><span class=cl><span class=s2>理由:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>invoke</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_iterations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Self-RAG查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>iteration</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>iteration</span> <span class=o>&lt;</span> <span class=n>max_iterations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>iteration</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>第</span><span class=si>{</span><span class=n>iteration</span><span class=si>}</span><span class=s2>轮检索...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 步骤1: 检索文档</span>
</span></span><span class=line><span class=cl>            <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 步骤2: 评估相关性</span>
</span></span><span class=line><span class=cl>            <span class=n>relevant_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>[:</span><span class=mi>5</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>relevance_result</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>relevance_prompt</span> <span class=o>|</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=p>)</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;document&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>page_content</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 简单解析评分(实际应用中可用structured output)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;相关性&#34;</span> <span class=ow>in</span> <span class=n>relevance_result</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>score_line</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                        <span class=n>line</span> <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>relevance_result</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=s1>&#39;相关性&#39;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>or</span> <span class=s1>&#39;分&#39;</span> <span class=ow>in</span> <span class=n>line</span>
</span></span><span class=line><span class=cl>                    <span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=n>score</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=nb>str</span><span class=o>.</span><span class=n>isdigit</span><span class=p>,</span> <span class=n>score_line</span><span class=p>))[:</span><span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=mi>7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=n>relevant_docs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>relevant_docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  未找到相关文档,重新检索...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  找到</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>relevant_docs</span><span class=p>)</span><span class=si>}</span><span class=s2>个相关文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 步骤3: 生成答案</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>relevant_docs</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>answer_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>基于以下文档回答问题:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>答案:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>answer_prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 步骤4: 验证答案</span>
</span></span><span class=line><span class=cl>            <span class=n>verification</span> <span class=o>=</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>verification_prompt</span> <span class=o>|</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=p>)</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;documents&#34;</span><span class=p>:</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;支持&#34;</span> <span class=ow>in</span> <span class=n>verification</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;documents&#34;</span><span class=p>:</span> <span class=n>relevant_docs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;iterations&#34;</span><span class=p>:</span> <span class=n>iteration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;verified&#34;</span><span class=p>:</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  答案未通过验证,重新检索...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 最大迭代次数后仍未验证通过</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;documents&#34;</span><span class=p>:</span> <span class=n>relevant_docs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;iterations&#34;</span><span class=p>:</span> <span class=n>iteration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;verified&#34;</span><span class=p>:</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>self_rag</span> <span class=o>=</span> <span class=n>SelfRAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>self_rag</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Python 3.11的主要新特性是什么?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最终答案:</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>迭代次数:</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;iterations&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;验证通过:</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;verified&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=42-corrective-rag-crag>4.2 Corrective RAG (CRAG)<a class=anchor href=#42-corrective-rag-crag>#</a></h3><h4 id=421-核心流程>4.2.1 核心流程<a class=anchor href=#421-%e6%a0%b8%e5%bf%83%e6%b5%81%e7%a8%8b>#</a></h4><pre class=mermaid>graph TD
    A[用户查询] --&gt; B[检索文档]
    B --&gt; C{评估相关性}
    C --&gt;|高相关| D[直接生成]
    C --&gt;|低相关| E[网络搜索]
    C --&gt;|中等相关| F[知识精炼]
    E --&gt; D
    F --&gt; D
    D --&gt; G[最终答案]</pre><script src=/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"default"})</script><hr><h4 id=422-简化实现>4.2.2 简化实现<a class=anchor href=#422-%e7%ae%80%e5%8c%96%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.tools</span> <span class=kn>import</span> <span class=n>DuckDuckGoSearchRun</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CorrectiveRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Corrective RAG实现&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>retriever</span><span class=p>,</span> <span class=n>llm</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>=</span> <span class=n>retriever</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>web_search</span> <span class=o>=</span> <span class=n>DuckDuckGoSearchRun</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>invoke</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;CRAG查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤1: 本地检索</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 步骤2: 评估相关性</span>
</span></span><span class=line><span class=cl>        <span class=n>relevance_score</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_evaluate_relevance</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>relevance_score</span> <span class=o>&gt;=</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 高相关:直接使用</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>[:</span><span class=mi>3</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_answer</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>relevance_score</span> <span class=o>&lt;</span> <span class=mf>0.4</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 低相关:网络搜索</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;本地文档相关性低,启动网络搜索...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>web_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>web_search</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_answer</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>web_results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 中等相关:知识精炼</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;文档需要精炼...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>refined_context</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_refine_knowledge</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_answer</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>refined_context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_evaluate_relevance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>docs</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;评估文档相关性(简化版)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 实际应用中可使用专门的评估模型</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>评估以下文档与查询的平均相关性(0-1之间的分数)。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>查询:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档:
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>docs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>200</span><span class=p>]</span><span class=si>}</span><span class=s2>...
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>相关性分数(0-1):
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=s1>&#39;&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=ow>or</span> <span class=n>x</span> <span class=o>==</span> <span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=n>response</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=mf>1.0</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_refine_knowledge</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>docs</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;知识精炼:提取关键信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>[:</span><span class=mi>5</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>从以下文档中提取与查询相关的关键信息(去除无关内容)。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>查询:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>文档:
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>关键信息:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_generate_answer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成答案&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>基于以下信息回答问题:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题:</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>答案:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>crag</span> <span class=o>=</span> <span class=n>CorrectiveRAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>answer</span> <span class=o>=</span> <span class=n>crag</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;量子计算机的最新进展&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=43-agentic-rag>4.3 Agentic RAG<a class=anchor href=#43-agentic-rag>#</a></h3><p><strong>核心思想</strong>:让Agent自主决定何时检索、检索什么、如何组合信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义多个检索工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_technical_docs</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索技术文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用向量检索器</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>tech_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[:</span><span class=mi>3</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_company_policies</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索公司政策文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>policy_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[:</span><span class=mi>3</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>query_database</span><span class=p>(</span><span class=n>sql_query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;查询数据库获取统计数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简化示例</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;查询结果:...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Agentic RAG</span>
</span></span><span class=line><span class=cl><span class=n>agentic_rag</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_technical_docs</span><span class=p>,</span> <span class=n>search_company_policies</span><span class=p>,</span> <span class=n>query_database</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个智能助手,可以查询技术文档、公司政策和数据库。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>根据用户问题自主决定:
</span></span></span><span class=line><span class=cl><span class=s2>1. 需要使用哪些工具
</span></span></span><span class=line><span class=cl><span class=s2>2. 以什么顺序使用工具
</span></span></span><span class=line><span class=cl><span class=s2>3. 如何组合不同来源的信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>保持回答准确、完整、专业。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agentic_rag</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;公司的远程办公政策是什么?需要提交哪些申请?&#34;</span><span class=p>}]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=小结-2>小结<a class=anchor href=#%e5%b0%8f%e7%bb%93-2>#</a></h3><p><strong>第3-4章核心要点</strong>:</p><h4 id=知识图谱rag第3章>知识图谱RAG(第3章)<a class=anchor href=#%e7%9f%a5%e8%af%86%e5%9b%be%e8%b0%b1rag%e7%ac%ac3%e7%ab%a0>#</a></h4><table><thead><tr><th>特性</th><th>价值</th></tr></thead><tbody><tr><td>多跳推理</td><td>准确率提升30-60%</td></tr><tr><td>显式关系</td><td>可解释性强</td></tr><tr><td>结构化表示</td><td>适合组织架构、供应链等场景</td></tr></tbody></table><p><strong>实施建议</strong>:</p><ul><li>✅ 混合方案:向量RAG(文档) + 图RAG(关系)</li><li>✅ 工具:Neo4j + LangChain</li><li>⚠️ 成本:需要构建和维护知识图谱</li></ul><hr><h4 id=前沿rag方案第4章>前沿RAG方案(第4章)<a class=anchor href=#%e5%89%8d%e6%b2%bfrag%e6%96%b9%e6%a1%88%e7%ac%ac4%e7%ab%a0>#</a></h4><table><thead><tr><th>方案</th><th>核心特点</th><th>性能提升</th><th>成本</th></tr></thead><tbody><tr><td><strong>Self-RAG</strong></td><td>自我反思、迭代检索</td><td>+15-20%</td><td>LLM调用2-3倍</td></tr><tr><td><strong>Corrective RAG</strong></td><td>相关性评估、网络补充</td><td>+20-25%</td><td>+Web搜索成本</td></tr><tr><td><strong>Agentic RAG</strong></td><td>Agent自主决策</td><td>+25-30%</td><td>高(多次LLM调用)</td></tr></tbody></table><p><strong>选择建议</strong>:</p><ul><li><strong>高准确率需求</strong> → Self-RAG或Corrective RAG</li><li><strong>复杂信息整合</strong> → Agentic RAG</li><li><strong>成本敏感</strong> → 传统RAG + 重排序(第2章)</li></ul><hr><h2 id=第5章混合检索生产实践完整指南>第5章：混合检索生产实践完整指南<a class=anchor href=#%e7%ac%ac5%e7%ab%a0%e6%b7%b7%e5%90%88%e6%a3%80%e7%b4%a2%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5%e5%ae%8c%e6%95%b4%e6%8c%87%e5%8d%97>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>: 将混合检索从demo提升到企业级生产系统</p></blockquote><p>在前面的章节中,我们学习了混合检索的基本原理和实现。但<strong>生产环境</strong>有更高的要求:</p><ul><li>🎯 <strong>性能</strong>: 延迟 &lt; 300ms</li><li>📊 <strong>质量</strong>: 检索准确率 > 90%</li><li>💰 <strong>成本</strong>: Token使用优化</li><li>🔄 <strong>可维护</strong>: 可评估、可优化、可监控</li></ul><p>本章将展示如何构建、评估、优化、部署一个<strong>生产级混合检索系统</strong>。</p><hr><h4 id=51-生产系统架构设计>5.1 生产系统架构设计<a class=anchor href=#51-%e7%94%9f%e4%ba%a7%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h4><h5 id=511-完整架构>5.1.1 完整架构<a class=anchor href=#511-%e5%ae%8c%e6%95%b4%e6%9e%b6%e6%9e%84>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户查询
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  查询处理层 (Query Processing)      │
</span></span><span class=line><span class=cl>│  - 查询改写                         │
</span></span><span class=line><span class=cl>│  - 意图识别                         │
</span></span><span class=line><span class=cl>│  - 参数提取                         │
</span></span><span class=line><span class=cl>└───────────┬───────────────────────┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  并发检索层 (Parallel Retrieval)    │
</span></span><span class=line><span class=cl>│  ┌─────────┐      ┌─────────┐     │
</span></span><span class=line><span class=cl>│  │ 向量检索 │      │ BM25检索 │     │
</span></span><span class=line><span class=cl>│  └─────────┘      └─────────┘     │
</span></span><span class=line><span class=cl>└───────────┬───────────────────────┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  融合排序层 (Hybrid Ranking)        │
</span></span><span class=line><span class=cl>│  - RRF融合                          │
</span></span><span class=line><span class=cl>│  - 权重调整                         │
</span></span><span class=line><span class=cl>│  - 去重                             │
</span></span><span class=line><span class=cl>└───────────┬───────────────────────┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  重排序层 (Reranking) [可选]        │
</span></span><span class=line><span class=cl>│  - Cross-Encoder精排                │
</span></span><span class=line><span class=cl>│  - 多样性优化                        │
</span></span><span class=line><span class=cl>└───────────┬───────────────────────┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  缓存层 (Caching)                   │
</span></span><span class=line><span class=cl>│  - 查询缓存                         │
</span></span><span class=line><span class=cl>│  - 结果缓存                         │
</span></span><span class=line><span class=cl>└───────────┬───────────────────────┘
</span></span><span class=line><span class=cl>            ↓
</span></span><span class=line><span class=cl>┌───────────────────────────────────┐
</span></span><span class=line><span class=cl>│  监控层 (Monitoring)                │
</span></span><span class=line><span class=cl>│  - 延迟监控                         │
</span></span><span class=line><span class=cl>│  - 质量监控                         │
</span></span><span class=line><span class=cl>│  - 成本监控                         │
</span></span><span class=line><span class=cl>└───────────────────────────────────┘</span></span></code></pre></div><h5 id=512-生产级实现>5.1.2 生产级实现<a class=anchor href=#512-%e7%94%9f%e4%ba%a7%e7%ba%a7%e5%ae%9e%e7%8e%b0>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># production_hybrid_retriever.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers</span> <span class=kn>import</span> <span class=n>BM25Retriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>EnsembleRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置日志</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RetrievalMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检索指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_ms</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>num_results</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>cache_hit</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever_used</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionHybridRetriever</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生产级混合检索器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>vector_weight</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bm25_weight</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>enable_cache</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>enable_rerank</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>enable_monitoring</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_weight</span> <span class=o>=</span> <span class=n>vector_weight</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bm25_weight</span> <span class=o>=</span> <span class=n>bm25_weight</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span> <span class=o>=</span> <span class=n>top_k</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_cache</span> <span class=o>=</span> <span class=n>enable_cache</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_rerank</span> <span class=o>=</span> <span class=n>enable_rerank</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_monitoring</span> <span class=o>=</span> <span class=n>enable_monitoring</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化检索器</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;初始化生产级混合检索器...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 向量检索器</span>
</span></span><span class=line><span class=cl>        <span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_retriever</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=n>top_k</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># BM25检索器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bm25_retriever</span> <span class=o>=</span> <span class=n>BM25Retriever</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>k</span> <span class=o>=</span> <span class=n>top_k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 混合检索器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ensemble_retriever</span> <span class=o>=</span> <span class=n>EnsembleRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>retrievers</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>vector_retriever</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>bm25_retriever</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=n>vector_weight</span><span class=p>,</span> <span class=n>bm25_weight</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 监控数据</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RetrievalMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✅ 混合检索器初始化完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_cached_retrieve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>k</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;缓存的检索（使用tuple因为List不可hash）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_retrieve_internal</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 转为tuple以支持缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>tuple</span><span class=p>((</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>,</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_retrieve_internal</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>k</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;内部检索实现&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>ensemble_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_async_retrieve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;异步并发检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 并发执行向量检索和BM25检索</span>
</span></span><span class=line><span class=cl>        <span class=n>vector_task</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>to_thread</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>vector_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bm25_task</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>to_thread</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=n>vector_task</span><span class=p>,</span> <span class=n>bm25_task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 手动融合（使用RRF）</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rrf_fusion</span><span class=p>(</span><span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_rrf_fusion</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>vector_results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>bm25_results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Reciprocal Rank Fusion融合&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 向量检索评分</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rank</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>vector_results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_id</span> <span class=o>=</span> <span class=nb>id</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rrf_score</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>k</span> <span class=o>+</span> <span class=n>rank</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>scores</span><span class=p>[</span><span class=n>doc_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>doc_id</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_weight</span> <span class=o>*</span> <span class=n>rrf_score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># BM25检索评分</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rank</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>bm25_results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_id</span> <span class=o>=</span> <span class=nb>id</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>rrf_score</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=n>k</span> <span class=o>+</span> <span class=n>rank</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>scores</span><span class=p>[</span><span class=n>doc_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>scores</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>doc_id</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>bm25_weight</span> <span class=o>*</span> <span class=n>rrf_score</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 合并并去重</span>
</span></span><span class=line><span class=cl>        <span class=n>all_docs</span> <span class=o>=</span> <span class=p>{</span><span class=nb>id</span><span class=p>(</span><span class=n>doc</span><span class=p>):</span> <span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>vector_results</span> <span class=o>+</span> <span class=n>bm25_results</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 按分数排序</span>
</span></span><span class=line><span class=cl>        <span class=n>sorted_doc_ids</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>scores</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>scores</span><span class=p>[</span><span class=n>x</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>all_docs</span><span class=p>[</span><span class=n>doc_id</span><span class=p>]</span> <span class=k>for</span> <span class=n>doc_id</span> <span class=ow>in</span> <span class=n>sorted_doc_ids</span><span class=p>[:</span><span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>retrieve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>use_async</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bypass_cache</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行检索并返回结果+指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_hit</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 缓存检索</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_cache</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>bypass_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>cached_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cached_retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>documents</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>Document</span><span class=p>(</span><span class=n>page_content</span><span class=o>=</span><span class=n>content</span><span class=p>,</span> <span class=n>metadata</span><span class=o>=</span><span class=n>metadata</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>content</span><span class=p>,</span> <span class=n>metadata</span> <span class=ow>in</span> <span class=n>cached_results</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>cache_hit</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缓存失败，使用直接检索: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>documents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_retrieve_internal</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>use_async</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 异步并发检索</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_async_retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 同步检索</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_retrieve_internal</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>latency_ms</span> <span class=o>=</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录指标</span>
</span></span><span class=line><span class=cl>        <span class=n>metrics</span> <span class=o>=</span> <span class=n>RetrievalMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_ms</span><span class=o>=</span><span class=n>latency_ms</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>num_results</span><span class=o>=</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_hit</span><span class=o>=</span><span class=n>cache_hit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>retriever_used</span><span class=o>=</span><span class=s2>&#34;async&#34;</span> <span class=k>if</span> <span class=n>use_async</span> <span class=k>else</span> <span class=s2>&#34;sync&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_monitoring</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;检索完成: </span><span class=si>{</span><span class=n>latency_ms</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms | &#34;</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;结果数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span><span class=si>}</span><span class=s2> | &#34;</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;缓存: </span><span class=si>{</span><span class=s1>&#39;命中&#39;</span> <span class=k>if</span> <span class=n>cache_hit</span> <span class=k>else</span> <span class=s1>&#39;未命中&#39;</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;documents&#34;</span><span class=p>:</span> <span class=n>documents</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;metrics&#34;</span><span class=p>:</span> <span class=n>metrics</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_performance_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取性能统计&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>latencies</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=o>.</span><span class=n>latency_ms</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_hits</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>cache_hit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_queries&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p50_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p95_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.95</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p99_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.99</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cache_hit_rate&#34;</span><span class=p>:</span> <span class=n>cache_hits</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_results_per_query&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>num_results</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span></span></span></code></pre></div><p><strong>使用示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>DirectoryLoader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载文档</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>DirectoryLoader</span><span class=p>(</span><span class=s2>&#34;./docs&#34;</span><span class=p>,</span> <span class=n>glob</span><span class=o>=</span><span class=s2>&#34;**/*.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分块</span>
</span></span><span class=line><span class=cl><span class=n>splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>splits</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建生产级检索器</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>ProductionHybridRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>splits</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>vector_weight</span><span class=o>=</span><span class=mf>0.6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bm25_weight</span><span class=o>=</span><span class=mf>0.4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>top_k</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>enable_cache</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>enable_monitoring</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行检索</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=s2>&#34;Python 3.11的新特性&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检索结果: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;documents&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>个&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;延迟: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>latency_ms</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缓存: </span><span class=si>{</span><span class=s1>&#39;命中&#39;</span> <span class=k>if</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;metrics&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>cache_hit</span> <span class=k>else</span> <span class=s1>&#39;未命中&#39;</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看性能统计</span>
</span></span><span class=line><span class=cl><span class=n>stats</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>get_performance_stats</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>性能统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  平均延迟: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;avg_latency_ms&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  P95延迟: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;p95_latency_ms&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  缓存命中率: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;cache_hit_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=52-评估与优化体系>5.2 评估与优化体系<a class=anchor href=#52-%e8%af%84%e4%bc%b0%e4%b8%8e%e4%bc%98%e5%8c%96%e4%bd%93%e7%b3%bb>#</a></h4><h5 id=521-构建评估数据集>5.2.1 构建评估数据集<a class=anchor href=#521-%e6%9e%84%e5%bb%ba%e8%af%84%e4%bc%b0%e6%95%b0%e6%8d%ae%e9%9b%86>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># build_eval_dataset.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_retrieval_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;hybrid_retrieval_eval&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;构建检索评估数据集&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 步骤1：创建Dataset</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset_name</span><span class=o>=</span><span class=n>dataset_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;混合检索质量评估数据集&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 步骤2：定义测试用例</span>
</span></span><span class=line><span class=cl>    <span class=n>test_cases</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;Python 3.11的新特性有哪些？&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;expected_doc_ids&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;doc_123&#34;</span><span class=p>,</span> <span class=s2>&#34;doc_456&#34;</span><span class=p>],</span>  <span class=c1># 文档ID</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;expected_keywords&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;Python 3.11&#34;</span><span class=p>,</span> <span class=s2>&#34;性能提升&#34;</span><span class=p>,</span> <span class=s2>&#34;异常组&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;relevance_score&#34;</span><span class=p>:</span> <span class=mi>5</span>  <span class=c1># 1-5分</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;技术查询&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;difficulty&#34;</span><span class=p>:</span> <span class=s2>&#34;easy&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;如何优化LangChain的性能？&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;expected_doc_ids&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;doc_789&#34;</span><span class=p>,</span> <span class=s2>&#34;doc_012&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;expected_keywords&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;缓存&#34;</span><span class=p>,</span> <span class=s2>&#34;并发&#34;</span><span class=p>,</span> <span class=s2>&#34;批处理&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;relevance_score&#34;</span><span class=p>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;性能优化&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;difficulty&#34;</span><span class=p>:</span> <span class=s2>&#34;medium&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=c1># ... 更多测试用例(建议100+个)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 步骤3：添加测试用例</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>case</span> <span class=ow>in</span> <span class=n>test_cases</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>inputs</span><span class=o>=</span><span class=k>case</span><span class=p>[</span><span class=s2>&#34;inputs&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>outputs</span><span class=o>=</span><span class=k>case</span><span class=p>[</span><span class=s2>&#34;outputs&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>metadata</span><span class=o>=</span><span class=k>case</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;metadata&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 创建Dataset成功: </span><span class=si>{</span><span class=n>dataset_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   包含 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>test_cases</span><span class=p>)</span><span class=si>}</span><span class=s2> 个测试用例&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   Dataset ID: </span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=522-自定义evaluators>5.2.2 自定义Evaluators<a class=anchor href=#522-%e8%87%aa%e5%ae%9a%e4%b9%89evaluators>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># evaluators.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@evaluator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>keyword_coverage_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;关键词覆盖率评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;documents&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_keywords</span> <span class=o>=</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_keywords&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 合并所有检索文档的内容</span>
</span></span><span class=line><span class=cl>    <span class=n>all_content</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>retrieved_docs</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查关键词覆盖</span>
</span></span><span class=line><span class=cl>    <span class=n>found_keywords</span> <span class=o>=</span> <span class=p>[</span><span class=n>kw</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>expected_keywords</span> <span class=k>if</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>all_content</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>coverage</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>found_keywords</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>expected_keywords</span><span class=p>)</span> <span class=k>if</span> <span class=n>expected_keywords</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;keyword_coverage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>coverage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;覆盖 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>found_keywords</span><span class=p>)</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>expected_keywords</span><span class=p>)</span><span class=si>}</span><span class=s2> 个关键词&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@evaluator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>recall_at_k_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Recall@K评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;documents&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_doc_ids</span> <span class=o>=</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_doc_ids&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 提取检索到的文档ID</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>retrieved_docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算Recall</span>
</span></span><span class=line><span class=cl>    <span class=n>hits</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=nb>set</span><span class=p>(</span><span class=n>retrieved_ids</span><span class=p>)</span> <span class=o>&amp;</span> <span class=nb>set</span><span class=p>(</span><span class=n>expected_doc_ids</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>recall</span> <span class=o>=</span> <span class=n>hits</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>expected_doc_ids</span><span class=p>)</span> <span class=k>if</span> <span class=n>expected_doc_ids</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;recall_at_k&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>recall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;召回 </span><span class=si>{</span><span class=n>hits</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>expected_doc_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> 个相关文档&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@evaluator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mrr_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;MRR (Mean Reciprocal Rank) 评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;documents&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_doc_ids</span> <span class=o>=</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_doc_ids&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_ids</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>retrieved_docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 找到第一个相关文档的位置</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>rank</span><span class=p>,</span> <span class=n>doc_id</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>retrieved_ids</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>doc_id</span> <span class=ow>in</span> <span class=n>expected_doc_ids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>mrr</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=n>rank</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;mrr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>mrr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;第一个相关文档在位置 </span><span class=si>{</span><span class=n>rank</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;mrr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;未检索到相关文档&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@evaluator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>latency_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;延迟评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;metrics&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_ms</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>latency_ms</span> <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>metrics</span><span class=p>,</span> <span class=s1>&#39;latency_ms&#39;</span><span class=p>)</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 评分标准: &lt;200ms=1.0, 200-500ms=0.8, 500-1000ms=0.5, &gt;1000ms=0.0</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>latency_ms</span> <span class=o>&lt;</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>latency_ms</span> <span class=o>&lt;</span> <span class=mi>500</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=mf>0.8</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>latency_ms</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=mf>0.5</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;latency_score&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;延迟 </span><span class=si>{</span><span class=n>latency_ms</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><h5 id=523-运行自动化评估>5.2.3 运行自动化评估<a class=anchor href=#523-%e8%bf%90%e8%a1%8c%e8%87%aa%e5%8a%a8%e5%8c%96%e8%af%84%e4%bc%b0>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># run_evaluation.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>production_hybrid_retriever</span> <span class=kn>import</span> <span class=n>ProductionHybridRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>evaluators</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>keyword_coverage_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>recall_at_k_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>mrr_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_evaluator</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载数据</span>
</span></span><span class=line><span class=cl><span class=c1># ... (同前面的文档加载代码)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建检索器</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>ProductionHybridRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>splits</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>vector_weight</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bm25_weight</span><span class=o>=</span><span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>top_k</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义预测函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>inputs</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;执行检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行评估</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;hybrid_retrieval_eval&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>keyword_coverage_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>recall_at_k_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>mrr_evaluator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>latency_evaluator</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;baseline_v1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;基准版本评估&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_concurrency</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出结果</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>=== 评估结果 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总计: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;total&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;关键词覆盖率: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Recall@5: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;recall_at_k_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;MRR: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;mrr_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;延迟评分: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;latency_score_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=524-权重优化实验>5.2.4 权重优化实验<a class=anchor href=#524-%e6%9d%83%e9%87%8d%e4%bc%98%e5%8c%96%e5%ae%9e%e9%aa%8c>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># optimize_weights.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>grid_search_weights</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>weight_candidates</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>]],</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;hybrid_retrieval_eval&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>float</span><span class=p>,</span> <span class=nb>float</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;网格搜索最优权重&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>best_score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>best_weights</span> <span class=o>=</span> <span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>all_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>vector_weight</span><span class=p>,</span> <span class=n>bm25_weight</span> <span class=ow>in</span> <span class=n>weight_candidates</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>测试权重: 向量=</span><span class=si>{</span><span class=n>vector_weight</span><span class=si>}</span><span class=s2>, BM25=</span><span class=si>{</span><span class=n>bm25_weight</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建检索器</span>
</span></span><span class=line><span class=cl>        <span class=n>retriever</span> <span class=o>=</span> <span class=n>ProductionHybridRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span><span class=o>=</span><span class=n>splits</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>vector_weight</span><span class=o>=</span><span class=n>vector_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>bm25_weight</span><span class=o>=</span><span class=n>bm25_weight</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 运行评估</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=k>lambda</span> <span class=n>inputs</span><span class=p>:</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=n>dataset_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>recall_at_k_evaluator</span><span class=p>,</span> <span class=n>mrr_evaluator</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>experiment_prefix</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;weight_v</span><span class=si>{</span><span class=n>vector_weight</span><span class=si>}</span><span class=s2>_b</span><span class=si>{</span><span class=n>bm25_weight</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 综合评分 (Recall@K * 0.6 + MRR * 0.4)</span>
</span></span><span class=line><span class=cl>        <span class=n>combined_score</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=s1>&#39;recall_at_k_avg&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.6</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=s1>&#39;mrr_avg&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mf>0.4</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>all_results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;vector_weight&#34;</span><span class=p>:</span> <span class=n>vector_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;bm25_weight&#34;</span><span class=p>:</span> <span class=n>bm25_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;recall&#34;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;recall_at_k_avg&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;mrr&#34;</span><span class=p>:</span> <span class=n>results</span><span class=p>[</span><span class=s1>&#39;mrr_avg&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;combined_score&#34;</span><span class=p>:</span> <span class=n>combined_score</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  Recall@K: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;recall_at_k_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  MRR: </span><span class=si>{</span><span class=n>results</span><span class=p>[</span><span class=s1>&#39;mrr_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  综合评分: </span><span class=si>{</span><span class=n>combined_score</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>combined_score</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>best_score</span> <span class=o>=</span> <span class=n>combined_score</span>
</span></span><span class=line><span class=cl>            <span class=n>best_weights</span> <span class=o>=</span> <span class=p>(</span><span class=n>vector_weight</span><span class=p>,</span> <span class=n>bm25_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>✅ 最优权重: 向量=</span><span class=si>{</span><span class=n>best_weights</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2>, BM25=</span><span class=si>{</span><span class=n>best_weights</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   综合评分: </span><span class=si>{</span><span class=n>best_score</span><span class=si>:</span><span class=s2>.3f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>best_weights</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>best_weights</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>all_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行网格搜索</span>
</span></span><span class=line><span class=cl><span class=n>weight_candidates</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.6</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>best_vector_weight</span><span class=p>,</span> <span class=n>best_bm25_weight</span><span class=p>,</span> <span class=n>all_results</span> <span class=o>=</span> <span class=n>grid_search_weights</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>weight_candidates</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可视化结果</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vector_weights</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;vector_weight&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>all_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>combined_scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;combined_score&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>all_results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>figure</span><span class=p>(</span><span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>6</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>plot</span><span class=p>(</span><span class=n>vector_weights</span><span class=p>,</span> <span class=n>combined_scores</span><span class=p>,</span> <span class=n>marker</span><span class=o>=</span><span class=s1>&#39;o&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>xlabel</span><span class=p>(</span><span class=s1>&#39;Vector Weight&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>ylabel</span><span class=p>(</span><span class=s1>&#39;Combined Score&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>title</span><span class=p>(</span><span class=s1>&#39;Weight Optimization Results&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>grid</span><span class=p>(</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>plt</span><span class=o>.</span><span class=n>savefig</span><span class=p>(</span><span class=s1>&#39;weight_optimization.png&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>📊 结果图表已保存: weight_optimization.png&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=53-性能优化技巧>5.3 性能优化技巧<a class=anchor href=#53-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%8a%80%e5%b7%a7>#</a></h4><h5 id=531-并发检索优化>5.3.1 并发检索优化<a class=anchor href=#531-%e5%b9%b6%e5%8f%91%e6%a3%80%e7%b4%a2%e4%bc%98%e5%8c%96>#</a></h5><p><strong>问题</strong>: 串行执行向量检索和BM25检索，延迟翻倍</p><p><strong>解决方案</strong>: 并发执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>parallel_retrieve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>vector_retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bm25_retriever</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;并发检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 并发执行</span>
</span></span><span class=line><span class=cl>    <span class=n>vector_task</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>to_thread</span><span class=p>(</span><span class=n>vector_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bm25_task</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>to_thread</span><span class=p>(</span><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>vector_task</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>bm25_task</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;Python 3.11新特性&#34;</span>
</span></span><span class=line><span class=cl><span class=n>vector_results</span><span class=p>,</span> <span class=n>bm25_results</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>parallel_retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>vector_retriever</span><span class=p>,</span> <span class=n>bm25_retriever</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 性能对比:</span>
</span></span><span class=line><span class=cl><span class=c1># 串行: 300ms + 200ms = 500ms</span>
</span></span><span class=line><span class=cl><span class=c1># 并发: max(300ms, 200ms) = 300ms ⬅️ 提速40%</span></span></span></code></pre></div><h5 id=532-缓存策略>5.3.2 缓存策略<a class=anchor href=#532-%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5>#</a></h5><p><strong>1. 查询缓存</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_query_hash</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成查询哈希&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cached_retrieve</span><span class=p>(</span><span class=n>query_hash</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>k</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带缓存的检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ensemble_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;Python 3.11新特性&#34;</span>
</span></span><span class=line><span class=cl><span class=n>query_hash</span> <span class=o>=</span> <span class=n>get_query_hash</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>cached_retrieve</span><span class=p>(</span><span class=n>query_hash</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二次调用直接从缓存返回 (0ms)</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>cached_retrieve</span><span class=p>(</span><span class=n>query_hash</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span></span></span></code></pre></div><p><strong>2. Redis缓存（生产环境）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisCache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Redis缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_host</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>redis_port</span><span class=o>=</span><span class=mi>6379</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>3600</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>host</span><span class=o>=</span><span class=n>redis_host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span><span class=o>=</span><span class=n>redis_port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ttl</span> <span class=o>=</span> <span class=n>ttl</span>  <span class=c1># 缓存过期时间(秒)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cached</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>Document</span><span class=p>(</span><span class=n>page_content</span><span class=o>=</span><span class=n>d</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>],</span> <span class=n>metadata</span><span class=o>=</span><span class=n>d</span><span class=p>[</span><span class=s2>&#34;metadata&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>d</span> <span class=ow>in</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>,</span> <span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis_client</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>ttl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>cache</span> <span class=o>=</span> <span class=n>RedisCache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retrieve_with_cache</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带Redis缓存的检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;retrieval:</span><span class=si>{</span><span class=n>get_query_hash</span><span class=p>(</span><span class=n>query</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 尝试从缓存获取</span>
</span></span><span class=line><span class=cl>    <span class=n>cached_results</span> <span class=o>=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cached_results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;缓存命中: </span><span class=si>{</span><span class=n>cache_key</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>cached_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 缓存未命中，执行检索</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>ensemble_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 存入缓存</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>cache_key</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span></span></span></code></pre></div><h5 id=533-批处理优化>5.3.3 批处理优化<a class=anchor href=#533-%e6%89%b9%e5%a4%84%e7%90%86%e4%bc%98%e5%8c%96>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>batch_retrieve</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>queries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;批量检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 分批处理</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>queries</span><span class=p>),</span> <span class=n>batch_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=n>queries</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>batch_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 并发执行batch内的查询</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>asyncio</span><span class=o>.</span><span class=n>to_thread</span><span class=p>(</span><span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>batch</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>batch_results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 存储结果</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>query</span><span class=p>,</span> <span class=n>docs</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>batch</span><span class=p>,</span> <span class=n>batch_results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=p>[</span><span class=n>query</span><span class=p>]</span> <span class=o>=</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>queries</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;查询</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_retrieve</span><span class=p>(</span><span class=n>queries</span><span class=p>,</span> <span class=n>ensemble_retriever</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 性能对比:</span>
</span></span><span class=line><span class=cl><span class=c1># 串行: 100查询 * 300ms = 30秒</span>
</span></span><span class=line><span class=cl><span class=c1># 批处理(batch=10): 10批 * 300ms = 3秒 ⬅️ 提速10倍</span></span></span></code></pre></div><hr><h4 id=54-监控与告警>5.4 监控与告警<a class=anchor href=#54-%e7%9b%91%e6%8e%a7%e4%b8%8e%e5%91%8a%e8%ad%a6>#</a></h4><h5 id=541-langsmith集成监控>5.4.1 LangSmith集成监控<a class=anchor href=#541-langsmith%e9%9b%86%e6%88%90%e7%9b%91%e6%8e%a7>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TRACING&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;lsv2_...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retrieve_with_monitoring</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带监控的检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 执行检索</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>latency_ms</span> <span class=o>=</span> <span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span><span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 上报到LangSmith</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>create_run</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;hybrid_retrieval&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;retriever&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;documents&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;documents&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;num_results&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;documents&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>extra</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;latency_ms&#34;</span><span class=p>:</span> <span class=n>latency_ms</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cache_hit&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;metrics&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>cache_hit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;vector_weight&#34;</span><span class=p>:</span> <span class=n>retriever</span><span class=o>.</span><span class=n>vector_weight</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;bm25_weight&#34;</span><span class=p>:</span> <span class=n>retriever</span><span class=o>.</span><span class=n>bm25_weight</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span></span></span></code></pre></div><h5 id=542-自定义监控dashboard>5.4.2 自定义监控Dashboard<a class=anchor href=#542-%e8%87%aa%e5%ae%9a%e4%b9%89%e7%9b%91%e6%8e%a7dashboard>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># monitoring_dashboard.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RetrievalMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>latency_ms</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>num_results</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>cache_hit</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoringDashboard</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;监控Dashboard&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RetrievalMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>latency_ms</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>num_results</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>cache_hit</span><span class=p>:</span> <span class=nb>bool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>RetrievalMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>latency_ms</span><span class=o>=</span><span class=n>latency_ms</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>num_results</span><span class=o>=</span><span class=n>num_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_hit</span><span class=o>=</span><span class=n>cache_hit</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>window_minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取统计数据（最近N分钟）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cutoff_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=n>window_minutes</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_metrics</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=n>cutoff_time</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>recent_metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>latencies</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=o>.</span><span class=n>latency_ms</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_queries&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p50_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>//</span> <span class=mi>2</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p95_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.95</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;p99_latency_ms&#34;</span><span class=p>:</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>latencies</span><span class=p>)[</span><span class=nb>int</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>latencies</span><span class=p>)</span> <span class=o>*</span> <span class=mf>0.99</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;max_latency_ms&#34;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>latencies</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cache_hit_rate&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>cache_hit</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_results_per_query&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>num_results</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_alerts</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查告警&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>stats</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_stats</span><span class=p>(</span><span class=n>window_minutes</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># P95延迟告警</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stats</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;p95_latency_ms&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  P95延迟过高: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;p95_latency_ms&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.0f</span><span class=si>}</span><span class=s2>ms&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 缓存命中率告警</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stats</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;cache_hit_rate&#34;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>0.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  缓存命中率过低: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;cache_hit_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 结果数量告警</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stats</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;avg_results_per_query&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  平均结果数过少: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;avg_results_per_query&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>alerts</span></span></span></code></pre></div><hr><h4 id=55-总结生产清单>5.5 总结：生产清单<a class=anchor href=#55-%e6%80%bb%e7%bb%93%e7%94%9f%e4%ba%a7%e6%b8%85%e5%8d%95>#</a></h4><p><strong>部署前检查清单</strong>：</p><ul><li><p><input disabled type=checkbox> <strong>性能测试</strong></p><ul><li><input disabled type=checkbox> P95延迟 &lt; 500ms</li><li><input disabled type=checkbox> P99延迟 &lt; 1000ms</li><li><input disabled type=checkbox> 并发支持 > 100 QPS</li></ul></li><li><p><input disabled type=checkbox> <strong>质量评估</strong></p><ul><li><input disabled type=checkbox> Recall@5 > 85%</li><li><input disabled type=checkbox> MRR > 0.7</li><li><input disabled type=checkbox> 关键词覆盖率 > 80%</li></ul></li><li><p><input disabled type=checkbox> <strong>可靠性</strong></p><ul><li><input disabled type=checkbox> 缓存策略已配置</li><li><input disabled type=checkbox> 错误处理已实现</li><li><input disabled type=checkbox> 降级方案已准备</li></ul></li><li><p><input disabled type=checkbox> <strong>可观测性</strong></p><ul><li><input disabled type=checkbox> LangSmith追踪已启用</li><li><input disabled type=checkbox> 监控Dashboard已部署</li><li><input disabled type=checkbox> 告警规则已配置</li></ul></li><li><p><input disabled type=checkbox> <strong>成本优化</strong></p><ul><li><input disabled type=checkbox> 缓存命中率 > 50%</li><li><input disabled type=checkbox> 批处理已实现</li><li><input disabled type=checkbox> Token使用已优化</li></ul></li></ul><p><strong>关键指标</strong>：</p><table><thead><tr><th>指标</th><th>目标值</th><th>告警阈值</th></tr></thead><tbody><tr><td><strong>P95延迟</strong></td><td>&lt; 300ms</td><td>> 500ms</td></tr><tr><td><strong>P99延迟</strong></td><td>&lt; 500ms</td><td>> 1000ms</td></tr><tr><td><strong>Recall@5</strong></td><td>> 90%</td><td>&lt; 80%</td></tr><tr><td><strong>MRR</strong></td><td>> 0.8</td><td>&lt; 0.6</td></tr><tr><td><strong>缓存命中率</strong></td><td>> 70%</td><td>&lt; 50%</td></tr><tr><td><strong>QPS</strong></td><td>> 100</td><td>-</td></tr></tbody></table><p><strong>持续优化循环</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 监控生产指标
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>2. 识别瓶颈/问题
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>3. A/B测试优化方案
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>4. 评估效果
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>5. 灰度发布
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>6. 全量部署
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>(回到步骤1)</span></span></code></pre></div><hr></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第四篇 RAG基础篇(LlamaIndex篇)</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/ class="flex align-center"><span>第五篇 RAG高级篇(LlamaIndex篇)</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#核心概念对比>核心概念对比</a></li><li><a href=#第1章混合检索技术hybrid-search>第1章:混合检索技术(Hybrid Search)</a><ul><li><a href=#11-为什么需要混合检索>1.1 为什么需要混合检索</a><ul><li><a href=#111-向量检索的局限性>1.1.1 向量检索的局限性</a></li><li><a href=#112-全文检索的局限性>1.1.2 全文检索的局限性</a></li><li><a href=#113-混合检索的优势>1.1.3 混合检索的优势</a></li></ul></li><li><a href=#12-langchain混合检索实现>1.2 LangChain混合检索实现</a><ul><li><a href=#121-基础混合检索>1.2.1 基础混合检索</a></li><li><a href=#122-权重调优>1.2.2 权重调优</a></li><li><a href=#123-完整rag系统混合检索>1.2.3 完整RAG系统(混合检索)</a></li><li><a href=#124-rrfreciprocal-rank-fusion算法>1.2.4 RRF(Reciprocal Rank Fusion)算法</a></li></ul></li><li><a href=#13-混合检索实战电商产品搜索>1.3 混合检索实战:电商产品搜索</a><ul><li><a href=#131-场景说明>1.3.1 场景说明</a></li><li><a href=#132-完整实现>1.3.2 完整实现</a></li></ul></li><li><a href=#14-混合检索最佳实践>1.4 混合检索最佳实践</a><ul><li><a href=#141-权重调优策略>1.4.1 权重调优策略</a></li><li><a href=#142-何时使用混合检索>1.4.2 何时使用混合检索</a></li></ul></li><li><a href=#小结>小结</a></li></ul></li><li><a href=#第2章重排序技术reranking>第2章:重排序技术(Reranking)</a><ul><li><a href=#21-为什么需要重排序>2.1 为什么需要重排序</a><ul><li><a href=#211-检索器的局限性>2.1.1 检索器的局限性</a></li><li><a href=#212-重排序的作用>2.1.2 重排序的作用</a></li><li><a href=#213-重排序-vs-检索器>2.1.3 重排序 vs 检索器</a></li></ul></li><li><a href=#22-langchain重排序实现>2.2 LangChain重排序实现</a><ul><li><a href=#221-基于contextualcompressionretriever>2.2.1 基于ContextualCompressionRetriever</a></li><li><a href=#222-使用embeddingsfilter基于embedding距离>2.2.2 使用EmbeddingsFilter(基于embedding距离)</a></li><li><a href=#223-本地重排序模型cross-encoder>2.2.3 本地重排序模型(Cross-Encoder)</a></li><li><a href=#224-集成到完整rag系统>2.2.4 集成到完整RAG系统</a></li></ul></li><li><a href=#23-查询改写query-rewriting>2.3 查询改写(Query Rewriting)</a><ul><li><a href=#231-多查询生成multi-query>2.3.1 多查询生成(Multi-Query)</a></li></ul></li><li><a href=#小结-1>小结</a></li></ul></li><li><a href=#第3章知识图谱raggraphrag>第3章:知识图谱RAG(GraphRAG)</a><ul><li><a href=#31-为什么需要知识图谱rag>3.1 为什么需要知识图谱RAG</a><ul><li><a href=#311-向量rag的局限性>3.1.1 向量RAG的局限性</a></li></ul></li><li><a href=#32-neo4j--langchain实现>3.2 Neo4j + LangChain实现</a><ul><li><a href=#321-环境准备>3.2.1 环境准备</a></li><li><a href=#322-基础知识图谱rag>3.2.2 基础知识图谱RAG</a></li><li><a href=#323-graphrag-向量--图遍历-neo4jvector>3.2.3 GraphRAG: 向量 + 图遍历 (Neo4jVector)</a></li></ul></li><li><a href=#33-graphrag-vs-传统rag性能对比>3.3 GraphRAG vs 传统RAG性能对比</a></li></ul></li><li><a href=#第4章前沿rag方案>第4章:前沿RAG方案</a><ul><li><a href=#41-self-rag自我反思检索>4.1 Self-RAG(自我反思检索)</a><ul><li><a href=#411-核心思想>4.1.1 核心思想</a></li><li><a href=#412-简化实现>4.1.2 简化实现</a></li></ul></li><li><a href=#42-corrective-rag-crag>4.2 Corrective RAG (CRAG)</a><ul><li><a href=#421-核心流程>4.2.1 核心流程</a></li><li><a href=#422-简化实现>4.2.2 简化实现</a></li></ul></li><li><a href=#43-agentic-rag>4.3 Agentic RAG</a></li><li><a href=#小结-2>小结</a><ul><li><a href=#知识图谱rag第3章>知识图谱RAG(第3章)</a></li><li><a href=#前沿rag方案第4章>前沿RAG方案(第4章)</a></li></ul></li></ul></li><li><a href=#第5章混合检索生产实践完整指南>第5章：混合检索生产实践完整指南</a><ul><li><ul><li><a href=#51-生产系统架构设计>5.1 生产系统架构设计</a><ul><li><a href=#511-完整架构>5.1.1 完整架构</a></li><li><a href=#512-生产级实现>5.1.2 生产级实现</a></li></ul></li><li><a href=#52-评估与优化体系>5.2 评估与优化体系</a><ul><li><a href=#521-构建评估数据集>5.2.1 构建评估数据集</a></li><li><a href=#522-自定义evaluators>5.2.2 自定义Evaluators</a></li><li><a href=#523-运行自动化评估>5.2.3 运行自动化评估</a></li><li><a href=#524-权重优化实验>5.2.4 权重优化实验</a></li></ul></li><li><a href=#53-性能优化技巧>5.3 性能优化技巧</a><ul><li><a href=#531-并发检索优化>5.3.1 并发检索优化</a></li><li><a href=#532-缓存策略>5.3.2 缓存策略</a></li><li><a href=#533-批处理优化>5.3.3 批处理优化</a></li></ul></li><li><a href=#54-监控与告警>5.4 监控与告警</a><ul><li><a href=#541-langsmith集成监控>5.4.1 LangSmith集成监控</a></li><li><a href=#542-自定义监控dashboard>5.4.2 自定义监控Dashboard</a></li></ul></li><li><a href=#55-总结生产清单>5.5 总结：生产清单</a></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>