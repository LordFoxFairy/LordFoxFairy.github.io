<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第四篇 RAG基础篇 (LlamaIndex)# 前置准备# 环境配置# # 核心依赖 pip install llama-index>=0.11.0 pip install llama-index-core>=0.11.0 pip install llama-index-llms-openai>=0.2.0 pip install llama-index-embeddings-openai>=0.2.0 # 向量数据库集成（可选） pip install llama-index-vector-stores-chroma pip install chromadb>=0.5.0 # 其他依赖 pip install pypdf # PDF支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env 文件 OPENAI_API_KEY=sk-your-api-key-here准备测试数据# # 创建数据目录 mkdir -p ./data # 创建示例文档 echo "LlamaIndex 是一个数据框架，专为 RAG（检索增强生成）应用设计。它提供了简单的接口来加载、索引和查询数据。" > ./data/intro.txt 第 1 章：为什么选择 LlamaIndex？# 1.1 LlamaIndex vs LangChain：设计哲学对比# 核心定位差异# 维度 LlamaIndex LangChain 核心定位 数据优先框架（Data Framework） 编排优先框架（Orchestration Framework） 主要用途 RAG、文档问答、知识库 Agent、复杂链式调用、工作流 抽象层级 高层抽象（开箱即用） 低层抽象（灵活组合） 学习曲线 平缓（5行代码启动） 陡峭（需理解LCEL、Runnable） 索引能力 强（多种索引类型） 弱（需自行实现） 数据连接 丰富（100+ Loaders） 基础（需集成） 最佳场景 RAG、搜索、文档分析 Agent、复杂工作流、多步推理 设计哲学# LlamaIndex 的核心理念：
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第四篇 RAG基础篇(LlamaIndex篇)"><meta property="og:description" content='第四篇 RAG基础篇 (LlamaIndex)# 前置准备# 环境配置# # 核心依赖 pip install llama-index>=0.11.0 pip install llama-index-core>=0.11.0 pip install llama-index-llms-openai>=0.2.0 pip install llama-index-embeddings-openai>=0.2.0 # 向量数据库集成（可选） pip install llama-index-vector-stores-chroma pip install chromadb>=0.5.0 # 其他依赖 pip install pypdf # PDF支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env 文件 OPENAI_API_KEY=sk-your-api-key-here准备测试数据# # 创建数据目录 mkdir -p ./data # 创建示例文档 echo "LlamaIndex 是一个数据框架，专为 RAG（检索增强生成）应用设计。它提供了简单的接口来加载、索引和查询数据。" > ./data/intro.txt 第 1 章：为什么选择 LlamaIndex？# 1.1 LlamaIndex vs LangChain：设计哲学对比# 核心定位差异# 维度 LlamaIndex LangChain 核心定位 数据优先框架（Data Framework） 编排优先框架（Orchestration Framework） 主要用途 RAG、文档问答、知识库 Agent、复杂链式调用、工作流 抽象层级 高层抽象（开箱即用） 低层抽象（灵活组合） 学习曲线 平缓（5行代码启动） 陡峭（需理解LCEL、Runnable） 索引能力 强（多种索引类型） 弱（需自行实现） 数据连接 丰富（100+ Loaders） 基础（需集成） 最佳场景 RAG、搜索、文档分析 Agent、复杂工作流、多步推理 设计哲学# LlamaIndex 的核心理念：'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第四篇 RAG基础篇(LlamaIndex篇)"><meta itemprop=description content='第四篇 RAG基础篇 (LlamaIndex)# 前置准备# 环境配置# # 核心依赖 pip install llama-index>=0.11.0 pip install llama-index-core>=0.11.0 pip install llama-index-llms-openai>=0.2.0 pip install llama-index-embeddings-openai>=0.2.0 # 向量数据库集成（可选） pip install llama-index-vector-stores-chroma pip install chromadb>=0.5.0 # 其他依赖 pip install pypdf # PDF支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env 文件 OPENAI_API_KEY=sk-your-api-key-here准备测试数据# # 创建数据目录 mkdir -p ./data # 创建示例文档 echo "LlamaIndex 是一个数据框架，专为 RAG（检索增强生成）应用设计。它提供了简单的接口来加载、索引和查询数据。" > ./data/intro.txt 第 1 章：为什么选择 LlamaIndex？# 1.1 LlamaIndex vs LangChain：设计哲学对比# 核心定位差异# 维度 LlamaIndex LangChain 核心定位 数据优先框架（Data Framework） 编排优先框架（Orchestration Framework） 主要用途 RAG、文档问答、知识库 Agent、复杂链式调用、工作流 抽象层级 高层抽象（开箱即用） 低层抽象（灵活组合） 学习曲线 平缓（5行代码启动） 陡峭（需理解LCEL、Runnable） 索引能力 强（多种索引类型） 弱（需自行实现） 数据连接 丰富（100+ Loaders） 基础（需集成） 最佳场景 RAG、搜索、文档分析 Agent、复杂工作流、多步推理 设计哲学# LlamaIndex 的核心理念：'><meta itemprop=wordCount content="2512"><title>第四篇 RAG基础篇(LlamaIndex篇) | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/ class=active>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第四篇 RAG基础篇(LlamaIndex篇)</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#前置准备>前置准备</a><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#环境变量设置>环境变量设置</a></li><li><a href=#准备测试数据>准备测试数据</a></li></ul></li><li><a href=#第-1-章为什么选择-llamaindex>第 1 章：为什么选择 LlamaIndex？</a><ul><li><a href=#11-llamaindex-vs-langchain设计哲学对比>1.1 LlamaIndex vs LangChain：设计哲学对比</a><ul><li><a href=#核心定位差异>核心定位差异</a></li><li><a href=#设计哲学>设计哲学</a></li><li><a href=#何时选择-llamaindex>何时选择 LlamaIndex？</a></li><li><a href=#最佳实践两者结合>最佳实践：两者结合</a></li></ul></li><li><a href=#12-快速开始5行代码实现rag>1.2 快速开始：5行代码实现RAG</a><ul><li><a href=#最简单的rag应用>最简单的RAG应用</a></li><li><a href=#查看详细信息>查看详细信息</a></li></ul></li><li><a href=#13-核心组件详解>1.3 核心组件详解</a><ul><li><a href=#document文档>Document（文档）</a></li><li><a href=#node节点>Node（节点）</a></li><li><a href=#index索引>Index（索引）</a></li></ul></li></ul></li><li><a href=#第-2-章数据摄取data-ingestion>第 2 章：数据摄取（Data Ingestion）</a><ul><li><a href=#21-文档加载器document-loaders>2.1 文档加载器（Document Loaders）</a><ul><li><a href=#simpledirectoryreader最常用>SimpleDirectoryReader（最常用）</a></li><li><a href=#远程文件系统支持>远程文件系统支持</a></li></ul></li><li><a href=#22-节点解析器node-parser>2.2 节点解析器（Node Parser）</a><ul><li><a href=#为什么需要分块>为什么需要分块？</a></li><li><a href=#sentencesplitter---智能句子分割>SentenceSplitter - 智能句子分割</a></li><li><a href=#semanticsplitter---语义分块>SemanticSplitter - 语义分块</a></li><li><a href=#分块策略对比>分块策略对比</a></li></ul></li><li><a href=#23-摄取管道ingestion-pipeline>2.3 摄取管道（Ingestion Pipeline）</a><ul><li><a href=#什么是-ingestion-pipeline>什么是 Ingestion Pipeline？</a></li><li><a href=#基础用法>基础用法</a></li><li><a href=#带缓存的管道生产推荐>带缓存的管道（生产推荐）</a></li><li><a href=#持久化缓存>持久化缓存</a></li></ul></li></ul></li><li><a href=#第-3-章索引indexing>第 3 章：索引（Indexing）</a><ul><li><a href=#31-vectorstoreindex---向量索引最常用>3.1 VectorStoreIndex - 向量索引（最常用）</a><ul><li><a href=#基础用法-1>基础用法</a></li><li><a href=#使用-ingestion-pipeline-创建索引>使用 Ingestion Pipeline 创建索引</a></li><li><a href=#直接管理节点>直接管理节点</a></li></ul></li><li><a href=#32-其他索引类型>3.2 其他索引类型</a><ul><li><a href=#summaryindex---摘要索引>SummaryIndex - 摘要索引</a></li><li><a href=#treeindex---树形索引>TreeIndex - 树形索引</a></li><li><a href=#keywordtableindex---关键词索引>KeywordTableIndex - 关键词索引</a></li></ul></li><li><a href=#33-持久化persisting>3.3 持久化（Persisting）</a><ul><li><a href=#保存索引到磁盘>保存索引到磁盘</a></li><li><a href=#从磁盘加载索引>从磁盘加载索引</a></li><li><a href=#使用远程存储s3>使用远程存储（S3）</a></li></ul></li><li><a href=#34-向量数据库集成>3.4 向量数据库集成</a><ul><li><a href=#内置向量存储>内置向量存储</a></li><li><a href=#集成chroma向量数据库>集成Chroma向量数据库</a></li><li><a href=#向量数据库选择指南>向量数据库选择指南</a></li></ul></li></ul></li><li><a href=#第-4-章查询querying>第 4 章：查询（Querying）</a><ul><li><a href=#41-查询引擎query-engine>4.1 查询引擎（Query Engine）</a><ul><li><a href=#基础查询引擎>基础查询引擎</a></li><li><a href=#响应模式response-mode>响应模式（Response Mode）</a></li><li><a href=#流式输出>流式输出</a></li><li><a href=#自定义prompt>自定义Prompt</a></li></ul></li><li><a href=#42-检索器retriever>4.2 检索器（Retriever）</a><ul><li><a href=#基础检索器>基础检索器</a></li><li><a href=#自定义检索器>自定义检索器</a></li></ul></li><li><a href=#43-聊天引擎chat-engine>4.3 聊天引擎（Chat Engine）</a><ul><li><a href=#基础聊天引擎>基础聊天引擎</a></li><li><a href=#流式聊天>流式聊天</a></li><li><a href=#查看对话历史>查看对话历史</a></li></ul></li></ul></li><li><a href=#第-5-章低级组件low-level-components>第 5 章：低级组件（Low-Level Components）</a><ul><li><a href=#51-为什么需要低级组件>5.1 为什么需要低级组件？</a></li><li><a href=#52-使用-retriever--responsesynthesizer>5.2 使用 Retriever + ResponseSynthesizer</a><ul><li><a href=#基础用法-2>基础用法</a></li><li><a href=#自定义响应合成器>自定义响应合成器</a></li><li><a href=#添加节点后处理器>添加节点后处理器</a></li></ul></li><li><a href=#53-手动控制检索和生成>5.3 手动控制检索和生成</a><ul><li><a href=#分步执行>分步执行</a></li><li><a href=#自定义后处理逻辑>自定义后处理逻辑</a></li></ul></li></ul></li><li><a href=#第-6-章全局配置settings>第 6 章：全局配置（Settings）</a><ul><li><a href=#61-配置llm和embedding>6.1 配置LLM和Embedding</a><ul><li><a href=#使用openai>使用OpenAI</a></li><li><a href=#配置本地模型>配置本地模型</a></li></ul></li><li><a href=#62-性能优化>6.2 性能优化</a><ul><li><a href=#分块优化>分块优化</a></li><li><a href=#批量插入优化>批量插入优化</a></li><li><a href=#缓存优化>缓存优化</a></li></ul></li></ul></li><li><a href=#第-7-章生产级应用实战>第 7 章：生产级应用实战</a><ul><li><a href=#71-完整的rag应用>7.1 完整的RAG应用</a></li></ul></li><li><a href=#第-8-章与-langchain-集成>第 8 章：与 LangChain 集成</a><ul><li><a href=#81-llamaindex-作为-langchain-工具>8.1 LlamaIndex 作为 LangChain 工具</a></li><li><a href=#82-完整集成示例>8.2 完整集成示例</a></li></ul></li><li><a href=#本章小结>本章小结</a></li><li><a href=#思考与练习>思考与练习</a></li><li><a href=#参考资源>参考资源</a></li><li><a href=#下一步学习>下一步学习</a></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第四篇-rag基础篇-llamaindex>第四篇 RAG基础篇 (LlamaIndex)<a class=anchor href=#%e7%ac%ac%e5%9b%9b%e7%af%87-rag%e5%9f%ba%e7%a1%80%e7%af%87-llamaindex>#</a></h1><h2 id=前置准备>前置准备<a class=anchor href=#%e5%89%8d%e7%bd%ae%e5%87%86%e5%a4%87>#</a></h2><h3 id=环境配置>环境配置<a class=anchor href=#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 核心依赖</span>
</span></span><span class=line><span class=cl>pip install llama-index&gt;<span class=o>=</span>0.11.0
</span></span><span class=line><span class=cl>pip install llama-index-core&gt;<span class=o>=</span>0.11.0
</span></span><span class=line><span class=cl>pip install llama-index-llms-openai&gt;<span class=o>=</span>0.2.0
</span></span><span class=line><span class=cl>pip install llama-index-embeddings-openai&gt;<span class=o>=</span>0.2.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向量数据库集成（可选）</span>
</span></span><span class=line><span class=cl>pip install llama-index-vector-stores-chroma
</span></span><span class=line><span class=cl>pip install chromadb&gt;<span class=o>=</span>0.5.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他依赖</span>
</span></span><span class=line><span class=cl>pip install pypdf  <span class=c1># PDF支持</span>
</span></span><span class=line><span class=cl>pip install python-dotenv  <span class=c1># 环境变量管理</span></span></span></code></pre></div><h3 id=环境变量设置>环境变量设置<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e8%ae%be%e7%bd%ae>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># .env 文件</span>
</span></span><span class=line><span class=cl><span class=nv>OPENAI_API_KEY</span><span class=o>=</span>sk-your-api-key-here</span></span></code></pre></div><h3 id=准备测试数据>准备测试数据<a class=anchor href=#%e5%87%86%e5%a4%87%e6%b5%8b%e8%af%95%e6%95%b0%e6%8d%ae>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建数据目录</span>
</span></span><span class=line><span class=cl>mkdir -p ./data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建示例文档</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;LlamaIndex 是一个数据框架，专为 RAG（检索增强生成）应用设计。它提供了简单的接口来加载、索引和查询数据。&#34;</span> &gt; ./data/intro.txt</span></span></code></pre></div><hr><h2 id=第-1-章为什么选择-llamaindex>第 1 章：为什么选择 LlamaIndex？<a class=anchor href=#%e7%ac%ac-1-%e7%ab%a0%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9-llamaindex>#</a></h2><h3 id=11-llamaindex-vs-langchain设计哲学对比>1.1 LlamaIndex vs LangChain：设计哲学对比<a class=anchor href=#11-llamaindex-vs-langchain%e8%ae%be%e8%ae%a1%e5%93%b2%e5%ad%a6%e5%af%b9%e6%af%94>#</a></h3><h4 id=核心定位差异>核心定位差异<a class=anchor href=#%e6%a0%b8%e5%bf%83%e5%ae%9a%e4%bd%8d%e5%b7%ae%e5%bc%82>#</a></h4><table><thead><tr><th>维度</th><th>LlamaIndex</th><th>LangChain</th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>数据优先框架（Data Framework）</td><td>编排优先框架（Orchestration Framework）</td></tr><tr><td><strong>主要用途</strong></td><td>RAG、文档问答、知识库</td><td>Agent、复杂链式调用、工作流</td></tr><tr><td><strong>抽象层级</strong></td><td>高层抽象（开箱即用）</td><td>低层抽象（灵活组合）</td></tr><tr><td><strong>学习曲线</strong></td><td>平缓（5行代码启动）</td><td>陡峭（需理解LCEL、Runnable）</td></tr><tr><td><strong>索引能力</strong></td><td>强（多种索引类型）</td><td>弱（需自行实现）</td></tr><tr><td><strong>数据连接</strong></td><td>丰富（100+ Loaders）</td><td>基础（需集成）</td></tr><tr><td><strong>最佳场景</strong></td><td>RAG、搜索、文档分析</td><td>Agent、复杂工作流、多步推理</td></tr></tbody></table><h4 id=设计哲学>设计哲学<a class=anchor href=#%e8%ae%be%e8%ae%a1%e5%93%b2%e5%ad%a6>#</a></h4><p><strong>LlamaIndex 的核心理念</strong>：</p><ol><li><p><strong>数据优先（Data-First）</strong></p><ul><li>一切从数据开始</li><li>内置丰富的数据连接器</li><li>支持结构化和非结构化数据</li></ul></li><li><p><strong>索引即查询（Index as Interface）</strong></p><ul><li>多种索引类型适应不同场景</li><li>索引自动优化查询策略</li><li>查询引擎开箱即用</li></ul></li><li><p><strong>模块化设计（Modular Architecture）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Reader → Parser → Index → Retriever → Query Engine</span></span></code></pre></div></li><li><p><strong>LLM无关（LLM-Agnostic）</strong></p><ul><li>支持OpenAI、Anthropic、本地模型</li><li>统一的接口切换模型</li></ul></li></ol><p><strong>LangChain 的核心理念</strong>：</p><ol><li><p><strong>编排优先（Orchestration-First）</strong></p><ul><li>灵活的链式调用</li><li>LCEL（LangChain Expression Language）</li><li>强大的 Agent 能力</li></ul></li><li><p><strong>低级控制（Low-Level Control）</strong></p><ul><li>手动控制每个环节</li><li>自定义程度高</li><li>适合复杂场景</li></ul></li></ol><h4 id=何时选择-llamaindex>何时选择 LlamaIndex？<a class=anchor href=#%e4%bd%95%e6%97%b6%e9%80%89%e6%8b%a9-llamaindex>#</a></h4><p>选择 LlamaIndex 如果你需要：</p><ul><li>快速搭建 RAG 系统</li><li>开箱即用的文档问答</li><li>多种索引策略（向量、关键词、摘要等）</li><li>丰富的数据源连接（PDF、数据库、API等）</li><li>生产级的检索优化</li></ul><p>选择 LangChain 如果你需要：</p><ul><li>复杂的 Agent 系统</li><li>多步推理工作流</li><li>精细的 Prompt 控制</li><li>自定义的执行链</li><li>与其他工具的深度集成</li></ul><h4 id=最佳实践两者结合>最佳实践：两者结合<a class=anchor href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e4%b8%a4%e8%80%85%e7%bb%93%e5%90%88>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># LlamaIndex 作为 LangChain 的工具</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 使用 LlamaIndex 构建索引（数据优先）</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 封装为 LangChain 工具（编排优先）</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_documents</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索文档库，回答关于文档的问题。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 在 LangChain Agent 中使用</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>create_react_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_documents</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 运行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;文档中提到了哪些关键概念？&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><p><strong>组合优势</strong>：</p><ul><li>LlamaIndex 处理数据和检索（强项）</li><li>LangChain 处理复杂逻辑和编排（强项）</li><li>发挥各自优势，构建更强大的系统</li></ul><hr><h3 id=12-快速开始5行代码实现rag>1.2 快速开始：5行代码实现RAG<a class=anchor href=#12-%e5%bf%ab%e9%80%9f%e5%bc%80%e5%a7%8b5%e8%a1%8c%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0rag>#</a></h3><h4 id=最简单的rag应用>最简单的RAG应用<a class=anchor href=#%e6%9c%80%e7%ae%80%e5%8d%95%e7%9a%84rag%e5%ba%94%e7%94%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>5行代码实现完整RAG - LlamaIndex的强大之处
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置API Key</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;sk-your-key&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 加载文档</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建查询引擎</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 查询</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;文档的主要内容是什么？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 输出</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><p><strong>就这么简单！</strong> LlamaIndex已经自动完成了：</p><ul><li>文档分块</li><li>向量化（Embedding）</li><li>向量存储</li><li>检索</li><li>LLM生成答案</li></ul><h4 id=查看详细信息>查看详细信息<a class=anchor href=#%e6%9f%a5%e7%9c%8b%e8%af%a6%e7%bb%86%e4%bf%a1%e6%81%af>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载文档</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;加载了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>documents</span><span class=p>[:</span><span class=mi>2</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>文档 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  内容: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>200</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  元数据: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询（带来源）</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>  <span class=c1># 返回Top-3最相关文档</span>
</span></span><span class=line><span class=cl>    <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>回答:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;来源:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>source_nodes</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>... (得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=13-核心组件详解>1.3 核心组件详解<a class=anchor href=#13-%e6%a0%b8%e5%bf%83%e7%bb%84%e4%bb%b6%e8%af%a6%e8%a7%a3>#</a></h3><h4 id=document文档>Document（文档）<a class=anchor href=#document%e6%96%87%e6%a1%a3>#</a></h4><p>Document是LlamaIndex的基本数据单元：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手动创建文档</span>
</span></span><span class=line><span class=cl><span class=n>doc1</span> <span class=o>=</span> <span class=n>Document</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span><span class=o>=</span><span class=s2>&#34;这是文档内容&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;manual&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=s2>&#34;张三&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;date&#34;</span><span class=p>:</span> <span class=s2>&#34;2026-01-19&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看文档属性</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;文档ID: </span><span class=si>{</span><span class=n>doc1</span><span class=o>.</span><span class=n>doc_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;内容: </span><span class=si>{</span><span class=n>doc1</span><span class=o>.</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;元数据: </span><span class=si>{</span><span class=n>doc1</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量创建</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>Document</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;文档1内容&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=n>Document</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;文档2内容&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=mi>2</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=n>Document</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;文档3内容&#34;</span><span class=p>,</span> <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><h4 id=node节点>Node（节点）<a class=anchor href=#node%e8%8a%82%e7%82%b9>#</a></h4><p>Node是文档分块后的单元：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建文档</span>
</span></span><span class=line><span class=cl><span class=n>doc</span> <span class=o>=</span> <span class=n>Document</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;很长的文本内容...&#34;</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建分块器</span>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分块</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>get_nodes_from_documents</span><span class=p>([</span><span class=n>doc</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;分割成 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span><span class=si>}</span><span class=s2> 个节点&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>nodes</span><span class=p>[:</span><span class=mi>3</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>节点 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  内容: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  长度: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=index索引>Index（索引）<a class=anchor href=#index%e7%b4%a2%e5%bc%95>#</a></h4><p>索引是LlamaIndex的核心：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载文档</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建向量索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 持久化索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从磁盘加载索引</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>StorageContext</span><span class=p>,</span> <span class=n>load_index_from_storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>storage_context</span> <span class=o>=</span> <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>loaded_index</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span><span class=n>storage_context</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-2-章数据摄取data-ingestion>第 2 章：数据摄取（Data Ingestion）<a class=anchor href=#%e7%ac%ac-2-%e7%ab%a0%e6%95%b0%e6%8d%ae%e6%91%84%e5%8f%96data-ingestion>#</a></h2><h3 id=21-文档加载器document-loaders>2.1 文档加载器（Document Loaders）<a class=anchor href=#21-%e6%96%87%e6%a1%a3%e5%8a%a0%e8%bd%bd%e5%99%a8document-loaders>#</a></h3><h4 id=simpledirectoryreader最常用>SimpleDirectoryReader（最常用）<a class=anchor href=#simpledirectoryreader%e6%9c%80%e5%b8%b8%e7%94%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础用法：加载目录下所有支持的文件</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 指定文件类型</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>required_exts</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;.pdf&#34;</span><span class=p>,</span> <span class=s2>&#34;.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;.md&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 递归加载子目录</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>recursive</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 排除某些文件</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>exclude</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;temp.txt&#34;</span><span class=p>,</span> <span class=s2>&#34;*.log&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义元数据</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>file_metadata</span><span class=o>=</span><span class=k>lambda</span> <span class=n>filename</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=n>filename</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;docs&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 并行加载（提升性能）</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>(</span><span class=n>num_workers</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 迭代加载（处理大量文件）</span>
</span></span><span class=line><span class=cl><span class=n>reader</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>,</span> <span class=n>recursive</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>all_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>docs</span> <span class=ow>in</span> <span class=n>reader</span><span class=o>.</span><span class=n>iter_data</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 处理每个文件</span>
</span></span><span class=line><span class=cl>    <span class=n>all_docs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span></span></span></code></pre></div><p><strong>支持的文件格式</strong>：</p><ul><li>文本：<code>.txt</code>, <code>.md</code>, <code>.csv</code></li><li>文档：<code>.pdf</code>, <code>.docx</code>, <code>.pptx</code>, <code>.epub</code></li><li>代码：<code>.py</code>, <code>.js</code>, <code>.java</code>, <code>.cpp</code></li><li>网页：<code>.html</code>, <code>.htm</code></li><li>数据：<code>.json</code>, <code>.xml</code></li><li>媒体：<code>.mp3</code>, <code>.mp4</code></li><li>图片：<code>.jpg</code>, <code>.png</code></li></ul><h4 id=远程文件系统支持>远程文件系统支持<a class=anchor href=#%e8%bf%9c%e7%a8%8b%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f%e6%94%af%e6%8c%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>s3fs</span> <span class=kn>import</span> <span class=n>S3FileSystem</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 连接 S3</span>
</span></span><span class=line><span class=cl><span class=n>s3_fs</span> <span class=o>=</span> <span class=n>S3FileSystem</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=s2>&#34;...&#34;</span><span class=p>,</span> <span class=n>secret</span><span class=o>=</span><span class=s2>&#34;...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载 S3 上的文档</span>
</span></span><span class=line><span class=cl><span class=n>reader</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>input_dir</span><span class=o>=</span><span class=s2>&#34;my-bucket/documents&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fs</span><span class=o>=</span><span class=n>s3_fs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>recursive</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>reader</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span></span></span></code></pre></div><hr><h3 id=22-节点解析器node-parser>2.2 节点解析器（Node Parser）<a class=anchor href=#22-%e8%8a%82%e7%82%b9%e8%a7%a3%e6%9e%90%e5%99%a8node-parser>#</a></h3><h4 id=为什么需要分块>为什么需要分块？<a class=anchor href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%88%86%e5%9d%97>#</a></h4><p><strong>分块的好处</strong>：</p><ul><li>适应模型上下文窗口</li><li>提高检索精确度</li><li>降低成本（只处理相关片段）</li><li>保持语义完整性</li></ul><h4 id=sentencesplitter---智能句子分割>SentenceSplitter - 智能句子分割<a class=anchor href=#sentencesplitter---%e6%99%ba%e8%83%bd%e5%8f%a5%e5%ad%90%e5%88%86%e5%89%b2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建分割器</span>
</span></span><span class=line><span class=cl><span class=n>splitter</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span>          <span class=c1># 每块大小（字符数）</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>,</span>        <span class=c1># 块之间重叠（保持上下文）</span>
</span></span><span class=line><span class=cl>    <span class=n>separator</span><span class=o>=</span><span class=s2>&#34; &#34;</span>            <span class=c1># 分隔符</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分割文档</span>
</span></span><span class=line><span class=cl><span class=n>doc</span> <span class=o>=</span> <span class=n>Document</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;很长的文本内容...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>splitter</span><span class=o>.</span><span class=n>get_nodes_from_documents</span><span class=p>([</span><span class=n>doc</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看结果</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>nodes</span><span class=p>[:</span><span class=mi>3</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>节点 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  内容: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  长度: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  元数据: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=semanticsplitter---语义分块>SemanticSplitter - 语义分块<a class=anchor href=#semanticsplitter---%e8%af%ad%e4%b9%89%e5%88%86%e5%9d%97>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SemanticSplitterNodeParser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbedding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 语义分块器（根据语义相似度分块）</span>
</span></span><span class=line><span class=cl><span class=n>semantic_splitter</span> <span class=o>=</span> <span class=n>SemanticSplitterNodeParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>                      <span class=c1># 缓冲区大小</span>
</span></span><span class=line><span class=cl>    <span class=n>breakpoint_percentile_threshold</span><span class=o>=</span><span class=mi>95</span><span class=p>,</span> <span class=c1># 语义断点阈值</span>
</span></span><span class=line><span class=cl>    <span class=n>embed_model</span><span class=o>=</span><span class=n>OpenAIEmbedding</span><span class=p>()</span>       <span class=c1># 使用的embedding模型</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分割</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>semantic_splitter</span><span class=o>.</span><span class=n>get_nodes_from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;语义分块创建了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span><span class=si>}</span><span class=s2> 个节点&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>语义分块的优势</strong>：</p><ul><li>保持语义完整性</li><li>自适应块大小</li><li>更好的检索效果</li></ul><p><strong>何时使用语义分块</strong>：</p><ul><li>长文档（> 5000字）</li><li>复杂结构（学术论文、技术文档）</li><li>高质量要求（生产环境）</li></ul><h4 id=分块策略对比>分块策略对比<a class=anchor href=#%e5%88%86%e5%9d%97%e7%ad%96%e7%95%a5%e5%af%b9%e6%af%94>#</a></h4><table><thead><tr><th>策略</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SentenceSplitter</strong></td><td>快速、简单</td><td>可能切断语义</td><td>通用文档、快速原型</td></tr><tr><td><strong>SemanticSplitter</strong></td><td>语义完整性最佳</td><td>计算开销大</td><td>学术论文、技术文档</td></tr></tbody></table><hr><h3 id=23-摄取管道ingestion-pipeline>2.3 摄取管道（Ingestion Pipeline）<a class=anchor href=#23-%e6%91%84%e5%8f%96%e7%ae%a1%e9%81%93ingestion-pipeline>#</a></h3><h4 id=什么是-ingestion-pipeline>什么是 Ingestion Pipeline？<a class=anchor href=#%e4%bb%80%e4%b9%88%e6%98%af-ingestion-pipeline>#</a></h4><p>Ingestion Pipeline 是 LlamaIndex 中用于构建数据处理流水线的高级抽象：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Documents → Transformation 1 (分块) → Transformation 2 (元数据提取) → Transformation 3 (Embedding) → Nodes → Vector Store</span></span></code></pre></div><h4 id=基础用法>基础用法<a class=anchor href=#%e5%9f%ba%e7%a1%80%e7%94%a8%e6%b3%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbedding</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.extractors</span> <span class=kn>import</span> <span class=n>TitleExtractor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.ingestion</span> <span class=kn>import</span> <span class=n>IngestionPipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建管道</span>
</span></span><span class=line><span class=cl><span class=n>pipeline</span> <span class=o>=</span> <span class=n>IngestionPipeline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>transformations</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SentenceSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>TitleExtractor</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>OpenAIEmbedding</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行管道</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>)</span></span></span></code></pre></div><h4 id=带缓存的管道生产推荐>带缓存的管道（生产推荐）<a class=anchor href=#%e5%b8%a6%e7%bc%93%e5%ad%98%e7%9a%84%e7%ae%a1%e9%81%93%e7%94%9f%e4%ba%a7%e6%8e%a8%e8%8d%90>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.ingestion</span> <span class=kn>import</span> <span class=n>IngestionPipeline</span><span class=p>,</span> <span class=n>IngestionCache</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.storage.docstore</span> <span class=kn>import</span> <span class=n>SimpleDocumentStore</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建缓存</span>
</span></span><span class=line><span class=cl><span class=n>cache</span> <span class=o>=</span> <span class=n>IngestionCache</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>=</span><span class=n>SimpleDocumentStore</span><span class=p>(),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建带缓存的管道</span>
</span></span><span class=line><span class=cl><span class=n>pipeline</span> <span class=o>=</span> <span class=n>IngestionPipeline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>transformations</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SentenceSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>OpenAIEmbedding</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>cache</span><span class=o>=</span><span class=n>cache</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一次运行（会执行所有转换）</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二次运行相同文档（会使用缓存）</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>)</span>  <span class=c1># 快速返回</span></span></span></code></pre></div><h4 id=持久化缓存>持久化缓存<a class=anchor href=#%e6%8c%81%e4%b9%85%e5%8c%96%e7%bc%93%e5%ad%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 保存管道状态</span>
</span></span><span class=line><span class=cl><span class=n>pipeline</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=s2>&#34;./pipeline_storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载并恢复状态</span>
</span></span><span class=line><span class=cl><span class=n>new_pipeline</span> <span class=o>=</span> <span class=n>IngestionPipeline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>transformations</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SentenceSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>OpenAIEmbedding</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>new_pipeline</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&#34;./pipeline_storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将立即使用缓存</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>new_pipeline</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-3-章索引indexing>第 3 章：索引（Indexing）<a class=anchor href=#%e7%ac%ac-3-%e7%ab%a0%e7%b4%a2%e5%bc%95indexing>#</a></h2><h3 id=31-vectorstoreindex---向量索引最常用>3.1 VectorStoreIndex - 向量索引（最常用）<a class=anchor href=#31-vectorstoreindex---%e5%90%91%e9%87%8f%e7%b4%a2%e5%bc%95%e6%9c%80%e5%b8%b8%e7%94%a8>#</a></h3><h4 id=基础用法-1>基础用法<a class=anchor href=#%e5%9f%ba%e7%a1%80%e7%94%a8%e6%b3%95-1>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载文档</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建向量索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span>  <span class=c1># 返回最相似的3个节点</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是RAG?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><p><strong>工作原理</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>文档 → Embedding → 向量存储
</span></span><span class=line><span class=cl>查询 → Embedding → 向量相似度搜索 → Top-K节点 → LLM生成答案</span></span></code></pre></div><p><strong>适用场景</strong>：</p><ul><li>语义搜索</li><li>问答系统</li><li>文档检索</li></ul><h4 id=使用-ingestion-pipeline-创建索引>使用 Ingestion Pipeline 创建索引<a class=anchor href=#%e4%bd%bf%e7%94%a8-ingestion-pipeline-%e5%88%9b%e5%bb%ba%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Document</span><span class=p>,</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbedding</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.extractors</span> <span class=kn>import</span> <span class=n>TitleExtractor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.ingestion</span> <span class=kn>import</span> <span class=n>IngestionPipeline</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建管道</span>
</span></span><span class=line><span class=cl><span class=n>pipeline</span> <span class=o>=</span> <span class=n>IngestionPipeline</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>transformations</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SentenceSplitter</span><span class=p>(</span><span class=n>chunk_size</span><span class=o>=</span><span class=mi>512</span><span class=p>,</span> <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>TitleExtractor</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>OpenAIEmbedding</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行管道</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>pipeline</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span></span></span></code></pre></div><h4 id=直接管理节点>直接管理节点<a class=anchor href=#%e7%9b%b4%e6%8e%a5%e7%ae%a1%e7%90%86%e8%8a%82%e7%82%b9>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.schema</span> <span class=kn>import</span> <span class=n>TextNode</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手动创建节点</span>
</span></span><span class=line><span class=cl><span class=n>node1</span> <span class=o>=</span> <span class=n>TextNode</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;第一段内容&#34;</span><span class=p>,</span> <span class=n>id_</span><span class=o>=</span><span class=s2>&#34;node1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>node2</span> <span class=o>=</span> <span class=n>TextNode</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;第二段内容&#34;</span><span class=p>,</span> <span class=n>id_</span><span class=o>=</span><span class=s2>&#34;node2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=p>[</span><span class=n>node1</span><span class=p>,</span> <span class=n>node2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 插入新节点</span>
</span></span><span class=line><span class=cl><span class=n>new_node</span> <span class=o>=</span> <span class=n>TextNode</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;新增内容&#34;</span><span class=p>,</span> <span class=n>id_</span><span class=o>=</span><span class=s2>&#34;node3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>insert_nodes</span><span class=p>([</span><span class=n>new_node</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除节点</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>delete_nodes</span><span class=p>([</span><span class=s2>&#34;node1&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更新节点</span>
</span></span><span class=line><span class=cl><span class=n>updated_node</span> <span class=o>=</span> <span class=n>TextNode</span><span class=p>(</span><span class=n>text</span><span class=o>=</span><span class=s2>&#34;更新后的内容&#34;</span><span class=p>,</span> <span class=n>id_</span><span class=o>=</span><span class=s2>&#34;node2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>update_ref_doc</span><span class=p>(</span><span class=n>updated_node</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=32-其他索引类型>3.2 其他索引类型<a class=anchor href=#32-%e5%85%b6%e4%bb%96%e7%b4%a2%e5%bc%95%e7%b1%bb%e5%9e%8b>#</a></h3><h4 id=summaryindex---摘要索引>SummaryIndex - 摘要索引<a class=anchor href=#summaryindex---%e6%91%98%e8%a6%81%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>SummaryIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建摘要索引</span>
</span></span><span class=line><span class=cl><span class=n>summary_index</span> <span class=o>=</span> <span class=n>SummaryIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询（会遍历所有文档）</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>summary_index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;总结所有文档的要点&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>遍历所有节点</li><li>适合摘要类任务</li><li>计算成本高</li></ul><p><strong>适用场景</strong>：</p><ul><li>文档摘要</li><li>全面分析</li><li>小数据集</li></ul><h4 id=treeindex---树形索引>TreeIndex - 树形索引<a class=anchor href=#treeindex---%e6%a0%91%e5%bd%a2%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>TreeIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建树形索引</span>
</span></span><span class=line><span class=cl><span class=n>tree_index</span> <span class=o>=</span> <span class=n>TreeIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>tree_index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;分层次总结文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>层次化结构</li><li>自底向上摘要</li><li>适合大文档</li></ul><h4 id=keywordtableindex---关键词索引>KeywordTableIndex - 关键词索引<a class=anchor href=#keywordtableindex---%e5%85%b3%e9%94%ae%e8%af%8d%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>KeywordTableIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建关键词索引</span>
</span></span><span class=line><span class=cl><span class=n>keyword_index</span> <span class=o>=</span> <span class=n>KeywordTableIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>keyword_index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;Python编程&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><p><strong>特点</strong>：</p><ul><li>基于关键词匹配</li><li>速度快</li><li>精确匹配</li></ul><p><strong>适用场景</strong>：</p><ul><li>精确关键词搜索</li><li>结构化文档</li><li>代码搜索</li></ul><hr><h3 id=33-持久化persisting>3.3 持久化（Persisting）<a class=anchor href=#33-%e6%8c%81%e4%b9%85%e5%8c%96persisting>#</a></h3><h4 id=保存索引到磁盘>保存索引到磁盘<a class=anchor href=#%e4%bf%9d%e5%ad%98%e7%b4%a2%e5%bc%95%e5%88%b0%e7%a3%81%e7%9b%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 持久化到磁盘</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=从磁盘加载索引>从磁盘加载索引<a class=anchor href=#%e4%bb%8e%e7%a3%81%e7%9b%98%e5%8a%a0%e8%bd%bd%e7%b4%a2%e5%bc%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>StorageContext</span><span class=p>,</span> <span class=n>load_index_from_storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载存储上下文</span>
</span></span><span class=line><span class=cl><span class=n>storage_context</span> <span class=o>=</span> <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span><span class=n>storage_context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 如果有多个索引，需要指定 index_id</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span><span class=n>storage_context</span><span class=p>,</span> <span class=n>index_id</span><span class=o>=</span><span class=s2>&#34;my_index&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=使用远程存储s3>使用远程存储（S3）<a class=anchor href=#%e4%bd%bf%e7%94%a8%e8%bf%9c%e7%a8%8b%e5%ad%98%e5%82%a8s3>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>s3fs</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>StorageContext</span><span class=p>,</span> <span class=n>load_index_from_storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置 S3 文件系统</span>
</span></span><span class=line><span class=cl><span class=n>s3</span> <span class=o>=</span> <span class=n>s3fs</span><span class=o>.</span><span class=n>S3FileSystem</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;AWS_ACCESS_KEY_ID&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>secret</span><span class=o>=</span><span class=s2>&#34;AWS_SECRET_ACCESS_KEY&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>endpoint_url</span><span class=o>=</span><span class=s2>&#34;https://s3.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存到 S3</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>set_index_id</span><span class=p>(</span><span class=s2>&#34;vector_index&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>s3_bucket_name</span> <span class=o>=</span> <span class=s2>&#34;my-bucket/storage&#34;</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=n>s3_bucket_name</span><span class=p>,</span> <span class=n>fs</span><span class=o>=</span><span class=n>s3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从 S3 加载</span>
</span></span><span class=line><span class=cl><span class=n>index_from_s3</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=n>s3_bucket_name</span><span class=p>,</span> <span class=n>fs</span><span class=o>=</span><span class=n>s3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>index_id</span><span class=o>=</span><span class=s2>&#34;vector_index&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h3 id=34-向量数据库集成>3.4 向量数据库集成<a class=anchor href=#34-%e5%90%91%e9%87%8f%e6%95%b0%e6%8d%ae%e5%ba%93%e9%9b%86%e6%88%90>#</a></h3><h4 id=内置向量存储>内置向量存储<a class=anchor href=#%e5%86%85%e7%bd%ae%e5%90%91%e9%87%8f%e5%ad%98%e5%82%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认使用内存存储（SimpleVectorStore）</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 持久化到磁盘</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=集成chroma向量数据库>集成Chroma向量数据库<a class=anchor href=#%e9%9b%86%e6%88%90chroma%e5%90%91%e9%87%8f%e6%95%b0%e6%8d%ae%e5%ba%93>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.vector_stores.chroma</span> <span class=kn>import</span> <span class=n>ChromaVectorStore</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>StorageContext</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>chromadb</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化Chroma客户端</span>
</span></span><span class=line><span class=cl><span class=n>chroma_client</span> <span class=o>=</span> <span class=n>chromadb</span><span class=o>.</span><span class=n>PersistentClient</span><span class=p>(</span><span class=n>path</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chroma_collection</span> <span class=o>=</span> <span class=n>chroma_client</span><span class=o>.</span><span class=n>get_or_create_collection</span><span class=p>(</span><span class=s2>&#34;my_collection&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建向量存储</span>
</span></span><span class=line><span class=cl><span class=n>vector_store</span> <span class=o>=</span> <span class=n>ChromaVectorStore</span><span class=p>(</span><span class=n>chroma_collection</span><span class=o>=</span><span class=n>chroma_collection</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>storage_context</span> <span class=o>=</span> <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span><span class=n>vector_store</span><span class=o>=</span><span class=n>vector_store</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载文档并构建索引</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>storage_context</span><span class=o>=</span><span class=n>storage_context</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><h4 id=向量数据库选择指南>向量数据库选择指南<a class=anchor href=#%e5%90%91%e9%87%8f%e6%95%b0%e6%8d%ae%e5%ba%93%e9%80%89%e6%8b%a9%e6%8c%87%e5%8d%97>#</a></h4><table><thead><tr><th>数据库</th><th>类型</th><th>性能</th><th>部署难度</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SimpleVectorStore</strong></td><td>内存</td><td>低</td><td>⭐</td><td>开发测试、小数据集</td></tr><tr><td><strong>Chroma</strong></td><td>嵌入式</td><td>中</td><td>⭐⭐</td><td>中小型应用、快速开发</td></tr><tr><td><strong>Pinecone</strong></td><td>云服务</td><td>高</td><td>⭐</td><td>云原生、无需运维</td></tr><tr><td><strong>Qdrant</strong></td><td>服务</td><td>高</td><td>⭐⭐⭐</td><td>生产环境、分布式</td></tr><tr><td><strong>Weaviate</strong></td><td>服务</td><td>高</td><td>⭐⭐⭐</td><td>企业级、GraphRAG</td></tr></tbody></table><hr><h2 id=第-4-章查询querying>第 4 章：查询（Querying）<a class=anchor href=#%e7%ac%ac-4-%e7%ab%a0%e6%9f%a5%e8%af%a2querying>#</a></h2><h3 id=41-查询引擎query-engine>4.1 查询引擎（Query Engine）<a class=anchor href=#41-%e6%9f%a5%e8%af%a2%e5%bc%95%e6%93%8equery-engine>#</a></h3><h4 id=基础查询引擎>基础查询引擎<a class=anchor href=#%e5%9f%ba%e7%a1%80%e6%9f%a5%e8%af%a2%e5%bc%95%e6%93%8e>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建查询引擎</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>           <span class=c1># Top-K检索</span>
</span></span><span class=line><span class=cl>    <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>,</span>      <span class=c1># 响应模式</span>
</span></span><span class=line><span class=cl>    <span class=n>verbose</span><span class=o>=</span><span class=kc>True</span>                  <span class=c1># 显示详细日志</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查询</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看来源</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>来源节点:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>source_nodes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;- </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=响应模式response-mode>响应模式（Response Mode）<a class=anchor href=#%e5%93%8d%e5%ba%94%e6%a8%a1%e5%bc%8fresponse-mode>#</a></h4><table><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>refine</strong></td><td>逐个节点精炼答案（默认）</td><td>高质量答案</td></tr><tr><td><strong>compact</strong></td><td>合并节点后一次生成</td><td>平衡质量和速度</td></tr><tr><td><strong>tree_summarize</strong></td><td>树形汇总</td><td>大量文档</td></tr><tr><td><strong>simple_summarize</strong></td><td>简单合并</td><td>快速摘要</td></tr><tr><td><strong>no_text</strong></td><td>只返回节点，不生成</td><td>检索测试</td></tr><tr><td><strong>accumulate</strong></td><td>对每个节点分别查询</td><td>需要多个答案</td></tr><tr><td><strong>compact_accumulate</strong></td><td>compact + accumulate</td><td>平衡质量和多答案</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 不同响应模式对比</span>
</span></span><span class=line><span class=cl><span class=n>query_engine_refine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span><span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;refine&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_engine_compact</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span><span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;什么是RAG?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>response1</span> <span class=o>=</span> <span class=n>query_engine_refine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>  <span class=c1># 更高质量</span>
</span></span><span class=line><span class=cl><span class=n>response2</span> <span class=o>=</span> <span class=n>query_engine_compact</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>  <span class=c1># 更快速度</span></span></span></code></pre></div><h4 id=流式输出>流式输出<a class=anchor href=#%e6%b5%81%e5%bc%8f%e8%be%93%e5%87%ba>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 启用流式输出</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span><span class=n>streaming</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;详细解释LlamaIndex的工作原理&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 流式打印</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;回答: &#34;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>response_gen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>()</span></span></span></code></pre></div><h4 id=自定义prompt>自定义Prompt<a class=anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89prompt>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>PromptTemplate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义QA模板</span>
</span></span><span class=line><span class=cl><span class=n>qa_prompt_tmpl</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;上下文信息如下：</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=si>{context_str}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;根据上下文信息（不要使用先验知识），回答以下问题：</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;</span><span class=si>{query_str}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;答案：&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用自定义Prompt</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>text_qa_template</span><span class=o>=</span><span class=n>qa_prompt_tmpl</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是向量索引？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=42-检索器retriever>4.2 检索器（Retriever）<a class=anchor href=#42-%e6%a3%80%e7%b4%a2%e5%99%a8retriever>#</a></h3><h4 id=基础检索器>基础检索器<a class=anchor href=#%e5%9f%ba%e7%a1%80%e6%a3%80%e7%b4%a2%e5%99%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建检索器</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>  <span class=c1># 返回Top-5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检索</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=s2>&#34;什么是向量索引?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>nodes</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>节点 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2> (得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>200</span><span class=p>])</span></span></span></code></pre></div><h4 id=自定义检索器>自定义检索器<a class=anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e6%a3%80%e7%b4%a2%e5%99%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.retrievers</span> <span class=kn>import</span> <span class=n>VectorIndexRetriever</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向量检索器</span>
</span></span><span class=line><span class=cl><span class=n>vector_retriever</span> <span class=o>=</span> <span class=n>VectorIndexRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检索</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>vector_retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=s2>&#34;查询文本&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>nodes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;- </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>... (得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=43-聊天引擎chat-engine>4.3 聊天引擎（Chat Engine）<a class=anchor href=#43-%e8%81%8a%e5%a4%a9%e5%bc%95%e6%93%8echat-engine>#</a></h3><h4 id=基础聊天引擎>基础聊天引擎<a class=anchor href=#%e5%9f%ba%e7%a1%80%e8%81%8a%e5%a4%a9%e5%bc%95%e6%93%8e>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建聊天引擎</span>
</span></span><span class=line><span class=cl><span class=n>chat_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_chat_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多轮对话</span>
</span></span><span class=line><span class=cl><span class=n>response1</span> <span class=o>=</span> <span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response2</span> <span class=o>=</span> <span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;它有哪些主要功能？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response3</span> <span class=o>=</span> <span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;能详细说说第一个功能吗？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response3</span><span class=p>)</span></span></span></code></pre></div><h4 id=流式聊天>流式聊天<a class=anchor href=#%e6%b5%81%e5%bc%8f%e8%81%8a%e5%a4%a9>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建流式聊天引擎</span>
</span></span><span class=line><span class=cl><span class=n>chat_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_chat_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 流式对话</span>
</span></span><span class=line><span class=cl><span class=n>streaming_response</span> <span class=o>=</span> <span class=n>chat_engine</span><span class=o>.</span><span class=n>stream_chat</span><span class=p>(</span><span class=s2>&#34;告诉我关于RAG的知识&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>streaming_response</span><span class=o>.</span><span class=n>response_gen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>()</span></span></span></code></pre></div><h4 id=查看对话历史>查看对话历史<a class=anchor href=#%e6%9f%a5%e7%9c%8b%e5%af%b9%e8%af%9d%e5%8e%86%e5%8f%b2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建聊天引擎</span>
</span></span><span class=line><span class=cl><span class=n>chat_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_chat_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多轮对话</span>
</span></span><span class=line><span class=cl><span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=s2>&#34;它有哪些功能？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看对话历史</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>chat_engine</span><span class=o>.</span><span class=n>chat_history</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-5-章低级组件low-level-components>第 5 章：低级组件（Low-Level Components）<a class=anchor href=#%e7%ac%ac-5-%e7%ab%a0%e4%bd%8e%e7%ba%a7%e7%bb%84%e4%bb%b6low-level-components>#</a></h2><h3 id=51-为什么需要低级组件>5.1 为什么需要低级组件？<a class=anchor href=#51-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e4%bd%8e%e7%ba%a7%e7%bb%84%e4%bb%b6>#</a></h3><p>高级接口（<code>as_query_engine</code>、<code>as_chat_engine</code>）虽然方便，但有时需要更精细的控制：</p><ul><li>自定义检索逻辑</li><li>复杂的后处理</li><li>特殊的响应合成策略</li><li>深度集成到现有系统</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Query → Retriever(检索) → NodePostprocessor(后处理) → ResponseSynthesizer(响应合成) → Response</span></span></code></pre></div><h3 id=52-使用-retriever--responsesynthesizer>5.2 使用 Retriever + ResponseSynthesizer<a class=anchor href=#52-%e4%bd%bf%e7%94%a8-retriever--responsesynthesizer>#</a></h3><h4 id=基础用法-2>基础用法<a class=anchor href=#%e5%9f%ba%e7%a1%80%e7%94%a8%e6%b3%95-2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>get_response_synthesizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.retrievers</span> <span class=kn>import</span> <span class=n>VectorIndexRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.query_engine</span> <span class=kn>import</span> <span class=n>RetrieverQueryEngine</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 创建检索器</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>VectorIndexRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建响应合成器</span>
</span></span><span class=line><span class=cl><span class=n>response_synthesizer</span> <span class=o>=</span> <span class=n>get_response_synthesizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 组合成查询引擎</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>RetrieverQueryEngine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_synthesizer</span><span class=o>=</span><span class=n>response_synthesizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 查询</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><h4 id=自定义响应合成器>自定义响应合成器<a class=anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%93%8d%e5%ba%94%e5%90%88%e6%88%90%e5%99%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>get_response_synthesizer</span><span class=p>,</span> <span class=n>PromptTemplate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义 Prompt</span>
</span></span><span class=line><span class=cl><span class=n>qa_prompt</span> <span class=o>=</span> <span class=n>PromptTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;上下文:</span><span class=se>\n</span><span class=si>{context_str}</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;问题: </span><span class=si>{query_str}</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;请用简洁的语言回答（不超过100字）:</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建响应合成器</span>
</span></span><span class=line><span class=cl><span class=n>response_synthesizer</span> <span class=o>=</span> <span class=n>get_response_synthesizer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>text_qa_template</span><span class=o>=</span><span class=n>qa_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>streaming</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合查询引擎</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>RetrieverQueryEngine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_synthesizer</span><span class=o>=</span><span class=n>response_synthesizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是RAG?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>response_gen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=添加节点后处理器>添加节点后处理器<a class=anchor href=#%e6%b7%bb%e5%8a%a0%e8%8a%82%e7%82%b9%e5%90%8e%e5%a4%84%e7%90%86%e5%99%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.postprocessor</span> <span class=kn>import</span> <span class=n>SimilarityPostprocessor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建后处理器（过滤低分节点）</span>
</span></span><span class=line><span class=cl><span class=n>postprocessor</span> <span class=o>=</span> <span class=n>SimilarityPostprocessor</span><span class=p>(</span><span class=n>similarity_cutoff</span><span class=o>=</span><span class=mf>0.7</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合查询引擎</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>RetrieverQueryEngine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_synthesizer</span><span class=o>=</span><span class=n>response_synthesizer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>node_postprocessors</span><span class=o>=</span><span class=p>[</span><span class=n>postprocessor</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;什么是LlamaIndex?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><h3 id=53-手动控制检索和生成>5.3 手动控制检索和生成<a class=anchor href=#53-%e6%89%8b%e5%8a%a8%e6%8e%a7%e5%88%b6%e6%a3%80%e7%b4%a2%e5%92%8c%e7%94%9f%e6%88%90>#</a></h3><h4 id=分步执行>分步执行<a class=anchor href=#%e5%88%86%e6%ad%a5%e6%89%a7%e8%a1%8c>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>get_response_synthesizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.retrievers</span> <span class=kn>import</span> <span class=n>VectorIndexRetriever</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引和检索器</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>VectorIndexRetriever</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>,</span> <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 手动检索</span>
</span></span><span class=line><span class=cl><span class=n>query_str</span> <span class=o>=</span> <span class=s2>&#34;什么是LlamaIndex?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>query_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;检索到 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span><span class=si>}</span><span class=s2> 个节点:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>nodes</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. (得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>) </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 手动合成响应</span>
</span></span><span class=line><span class=cl><span class=n>response_synthesizer</span> <span class=o>=</span> <span class=n>get_response_synthesizer</span><span class=p>(</span><span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>response_synthesizer</span><span class=o>.</span><span class=n>synthesize</span><span class=p>(</span><span class=n>query_str</span><span class=p>,</span> <span class=n>nodes</span><span class=o>=</span><span class=n>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>最终回答:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=自定义后处理逻辑>自定义后处理逻辑<a class=anchor href=#%e8%87%aa%e5%ae%9a%e4%b9%89%e5%90%8e%e5%a4%84%e7%90%86%e9%80%bb%e8%be%91>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>get_response_synthesizer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.retrievers</span> <span class=kn>import</span> <span class=n>VectorIndexRetriever</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建索引和检索器</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>VectorIndexRetriever</span><span class=p>(</span><span class=n>index</span><span class=o>=</span><span class=n>index</span><span class=p>,</span> <span class=n>similarity_top_k</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 检索</span>
</span></span><span class=line><span class=cl><span class=n>query_str</span> <span class=o>=</span> <span class=s2>&#34;什么是LlamaIndex?&#34;</span>
</span></span><span class=line><span class=cl><span class=n>nodes</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>query_str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 自定义后处理：过滤和排序</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>custom_postprocess</span><span class=p>(</span><span class=n>nodes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 过滤低分节点</span>
</span></span><span class=line><span class=cl>    <span class=n>filtered</span> <span class=o>=</span> <span class=p>[</span><span class=n>n</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>nodes</span> <span class=k>if</span> <span class=n>n</span><span class=o>.</span><span class=n>score</span> <span class=o>&gt;</span> <span class=mf>0.7</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 去重（基于文本相似度）</span>
</span></span><span class=line><span class=cl>    <span class=n>unique_nodes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>filtered</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>text</span> <span class=o>==</span> <span class=n>n</span><span class=o>.</span><span class=n>text</span> <span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=n>unique_nodes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>unique_nodes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>node</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 重新排序（可以基于自定义逻辑）</span>
</span></span><span class=line><span class=cl>    <span class=n>sorted_nodes</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>unique_nodes</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>n</span><span class=p>:</span> <span class=n>n</span><span class=o>.</span><span class=n>score</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>sorted_nodes</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span>  <span class=c1># 只保留Top-3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>processed_nodes</span> <span class=o>=</span> <span class=n>custom_postprocess</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;后处理后剩余 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>processed_nodes</span><span class=p>)</span><span class=si>}</span><span class=s2> 个节点&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 合成响应</span>
</span></span><span class=line><span class=cl><span class=n>response_synthesizer</span> <span class=o>=</span> <span class=n>get_response_synthesizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>response_synthesizer</span><span class=o>.</span><span class=n>synthesize</span><span class=p>(</span><span class=n>query_str</span><span class=p>,</span> <span class=n>nodes</span><span class=o>=</span><span class=n>processed_nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>回答:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-6-章全局配置settings>第 6 章：全局配置（Settings）<a class=anchor href=#%e7%ac%ac-6-%e7%ab%a0%e5%85%a8%e5%b1%80%e9%85%8d%e7%bd%aesettings>#</a></h2><h3 id=61-配置llm和embedding>6.1 配置LLM和Embedding<a class=anchor href=#61-%e9%85%8d%e7%bd%aellm%e5%92%8cembedding>#</a></h3><h4 id=使用openai>使用OpenAI<a class=anchor href=#%e4%bd%bf%e7%94%a8openai>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Settings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.llms.openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbedding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置LLM</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4-turbo-preview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>temperature</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>api_key</span><span class=o>=</span><span class=s2>&#34;your-api-key&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置Embedding模型</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>embed_model</span> <span class=o>=</span> <span class=n>OpenAIEmbedding</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>api_key</span><span class=o>=</span><span class=s2>&#34;your-api-key&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置分块参数</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>chunk_size</span> <span class=o>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>chunk_overlap</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 现在所有后续操作都会使用这些配置</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span></span></span></code></pre></div><h4 id=配置本地模型>配置本地模型<a class=anchor href=#%e9%85%8d%e7%bd%ae%e6%9c%ac%e5%9c%b0%e6%a8%a1%e5%9e%8b>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>Settings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.llms.ollama</span> <span class=kn>import</span> <span class=n>Ollama</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.huggingface</span> <span class=kn>import</span> <span class=n>HuggingFaceEmbedding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用Ollama本地模型</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>Ollama</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;llama2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>base_url</span><span class=o>=</span><span class=s2>&#34;http://localhost:11434&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用HuggingFace Embedding</span>
</span></span><span class=line><span class=cl><span class=n>Settings</span><span class=o>.</span><span class=n>embed_model</span> <span class=o>=</span> <span class=n>HuggingFaceEmbedding</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model_name</span><span class=o>=</span><span class=s2>&#34;BAAI/bge-small-zh-v1.5&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h3 id=62-性能优化>6.2 性能优化<a class=anchor href=#62-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96>#</a></h3><h4 id=分块优化>分块优化<a class=anchor href=#%e5%88%86%e5%9d%97%e4%bc%98%e5%8c%96>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景1: 短文本问答（如FAQ）</span>
</span></span><span class=line><span class=cl><span class=n>short_splitter</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景2: 长文档分析（如技术文档）</span>
</span></span><span class=line><span class=cl><span class=n>long_splitter</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>400</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景3: 中文文档</span>
</span></span><span class=line><span class=cl><span class=n>chinese_splitter</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>separator</span><span class=o>=</span><span class=s2>&#34;。&#34;</span>  <span class=c1># 使用中文句号</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=批量插入优化>批量插入优化<a class=anchor href=#%e6%89%b9%e9%87%8f%e6%8f%92%e5%85%a5%e4%bc%98%e5%8c%96>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置批量插入大小</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>insert_batch_size</span><span class=o>=</span><span class=mi>512</span>  <span class=c1># 默认2048</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=缓存优化>缓存优化<a class=anchor href=#%e7%bc%93%e5%ad%98%e4%bc%98%e5%8c%96>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用缓存避免重复embedding</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一次创建索引（会进行embedding）</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 持久化</span>
</span></span><span class=line><span class=cl><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 后续加载（不需要重新embedding）</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>StorageContext</span><span class=p>,</span> <span class=n>load_index_from_storage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>storage_context</span> <span class=o>=</span> <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span><span class=n>storage_context</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-7-章生产级应用实战>第 7 章：生产级应用实战<a class=anchor href=#%e7%ac%ac-7-%e7%ab%a0%e7%94%9f%e4%ba%a7%e7%ba%a7%e5%ba%94%e7%94%a8%e5%ae%9e%e6%88%98>#</a></h2><h3 id=71-完整的rag应用>7.1 完整的RAG应用<a class=anchor href=#71-%e5%ae%8c%e6%95%b4%e7%9a%84rag%e5%ba%94%e7%94%a8>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>生产级RAG应用 - LlamaIndex版本
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>VectorStoreIndex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>SimpleDirectoryReader</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>StorageContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>load_index_from_storage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Settings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core.node_parser</span> <span class=kn>import</span> <span class=n>SentenceSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.llms.openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.embeddings.openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbedding</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LlamaIndexRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data_dir</span><span class=o>=</span><span class=s2>&#34;./data&#34;</span><span class=p>,</span> <span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span> <span class=o>=</span> <span class=n>data_dir</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span> <span class=o>=</span> <span class=n>persist_dir</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 配置全局设置</span>
</span></span><span class=line><span class=cl>        <span class=n>Settings</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4-turbo-preview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Settings</span><span class=o>.</span><span class=n>embed_model</span> <span class=o>=</span> <span class=n>OpenAIEmbedding</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>Settings</span><span class=o>.</span><span class=n>chunk_size</span> <span class=o>=</span> <span class=mi>512</span>
</span></span><span class=line><span class=cl>        <span class=n>Settings</span><span class=o>.</span><span class=n>chunk_overlap</span> <span class=o>=</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_index</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>force_rebuild</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建或加载索引&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>force_rebuild</span> <span class=ow>and</span> <span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=p>)</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;加载现有索引...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>storage_context</span> <span class=o>=</span> <span class=n>StorageContext</span><span class=o>.</span><span class=n>from_defaults</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>persist_dir</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>load_index_from_storage</span><span class=p>(</span><span class=n>storage_context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;索引加载成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;加载失败，重新构建索引...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;1. 加载文档...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   加载了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;2. 文档分块...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>parser</span> <span class=o>=</span> <span class=n>SentenceSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_size</span><span class=o>=</span><span class=n>Settings</span><span class=o>.</span><span class=n>chunk_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_overlap</span><span class=o>=</span><span class=n>Settings</span><span class=o>.</span><span class=n>chunk_overlap</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>nodes</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>get_nodes_from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   创建了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span><span class=si>}</span><span class=s2> 个节点&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;3. 创建向量索引...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=p>(</span><span class=n>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;   索引创建完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;4. 持久化索引...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>storage_context</span><span class=o>.</span><span class=n>persist</span><span class=p>(</span><span class=n>persist_dir</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;   索引已保存&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>,</span> <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>,</span> <span class=n>show_sources</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;索引未初始化，请先调用 build_index()&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建查询引擎</span>
</span></span><span class=line><span class=cl>        <span class=n>query_engine</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>similarity_top_k</span><span class=o>=</span><span class=n>top_k</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>response_mode</span><span class=o>=</span><span class=n>response_mode</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>问题: </span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>回答:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>show_sources</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;来源:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>node</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>source_nodes</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>text</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>... (得分: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>node</span><span class=o>.</span><span class=n>metadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;     元数据: </span><span class=si>{</span><span class=n>node</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query_stream</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>question</span><span class=p>,</span> <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;流式查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;索引未初始化&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>query_engine</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>similarity_top_k</span><span class=o>=</span><span class=n>top_k</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>streaming</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>问题: </span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;回答: &#34;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>response_gen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;交互式聊天&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;索引未初始化&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>chat_engine</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>index</span><span class=o>.</span><span class=n>as_chat_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;开始聊天（输入 &#39;quit&#39; 退出）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>question</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>你: &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>question</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>[</span><span class=s1>&#39;quit&#39;</span><span class=p>,</span> <span class=s1>&#39;exit&#39;</span><span class=p>,</span> <span class=s1>&#39;q&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;再见！&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>question</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>chat_engine</span><span class=o>.</span><span class=n>chat</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;AI: </span><span class=si>{</span><span class=n>response</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 设置API Key</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;sk-your-key&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化RAG应用</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span> <span class=o>=</span> <span class=n>LlamaIndexRAG</span><span class=p>(</span><span class=n>data_dir</span><span class=o>=</span><span class=s2>&#34;./data&#34;</span><span class=p>,</span> <span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./storage&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建索引</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>build_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 查询</span>
</span></span><span class=line><span class=cl>    <span class=n>questions</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;文档的主要内容是什么？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;有哪些关键概念？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;如何快速上手？&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>questions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>response_mode</span><span class=o>=</span><span class=s2>&#34;compact&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-&#34;</span> <span class=o>*</span> <span class=mi>80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 流式查询</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>query_stream</span><span class=p>(</span><span class=s2>&#34;详细解释LlamaIndex的架构&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 交互式聊天</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>chat</span><span class=p>()</span></span></span></code></pre></div><hr><h2 id=第-8-章与-langchain-集成>第 8 章：与 LangChain 集成<a class=anchor href=#%e7%ac%ac-8-%e7%ab%a0%e4%b8%8e-langchain-%e9%9b%86%e6%88%90>#</a></h2><h3 id=81-llamaindex-作为-langchain-工具>8.1 LlamaIndex 作为 LangChain 工具<a class=anchor href=#81-llamaindex-%e4%bd%9c%e4%b8%ba-langchain-%e5%b7%a5%e5%85%b7>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 创建LlamaIndex索引</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./data&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_engine</span> <span class=o>=</span> <span class=n>index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 封装为LangChain工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_documents</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索文档库，回答关于文档的问题。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>query_engine</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 在LangChain Agent中使用</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>create_react_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_documents</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 运行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;文档中提到了哪些关键概念？&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><h3 id=82-完整集成示例>8.2 完整集成示例<a class=anchor href=#82-%e5%ae%8c%e6%95%b4%e9%9b%86%e6%88%90%e7%a4%ba%e4%be%8b>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>llama_index.core</span> <span class=kn>import</span> <span class=n>VectorStoreIndex</span><span class=p>,</span> <span class=n>SimpleDirectoryReader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.prebuilt</span> <span class=kn>import</span> <span class=n>create_react_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置环境变量</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;sk-your-key&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 创建多个 LlamaIndex 索引</span>
</span></span><span class=line><span class=cl><span class=n>technical_docs</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./technical_docs&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>business_docs</span> <span class=o>=</span> <span class=n>SimpleDirectoryReader</span><span class=p>(</span><span class=s2>&#34;./business_docs&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>load_data</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tech_index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>technical_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>business_index</span> <span class=o>=</span> <span class=n>VectorStoreIndex</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span><span class=n>business_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建多个工具</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_technical_docs</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索技术文档，回答技术相关问题。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>tech_index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_business_docs</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;搜索业务文档，回答业务相关问题。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>business_index</span><span class=o>.</span><span class=n>as_query_engine</span><span class=p>()</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建 Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_react_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_technical_docs</span><span class=p>,</span> <span class=n>search_business_docs</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 使用</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;技术架构是什么？业务流程是怎样的？&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=本章小结>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h2><p>本章我们完整学习了LlamaIndex的RAG基础：</p><p><strong>第1章回顾</strong>：</p><ul><li>LlamaIndex vs LangChain 设计哲学</li><li>核心优势和使用场景</li><li>5行代码快速开始</li><li>核心组件（Document、Node、Index）</li></ul><p><strong>第2章回顾</strong>：</p><ul><li>文档加载器（SimpleDirectoryReader、专用加载器）</li><li>节点解析器（SentenceSplitter、SemanticSplitter）</li><li>摄取管道（IngestionPipeline）</li></ul><p><strong>第3章回顾</strong>：</p><ul><li>索引类型（Vector、Summary、Tree、Keyword）</li><li>持久化（本地、远程S3）</li><li>向量数据库集成（Chroma等）</li></ul><p><strong>第4章回顾</strong>：</p><ul><li>查询引擎（响应模式、流式输出、自定义Prompt）</li><li>检索器（Retriever）</li><li>聊天引擎（Chat Engine）</li></ul><p><strong>第5章回顾</strong>：</p><ul><li>低级组件（Retriever + ResponseSynthesizer）</li><li>手动控制检索和生成</li><li>自定义后处理逻辑</li></ul><p><strong>第6章回顾</strong>：</p><ul><li>全局配置（Settings）</li><li>性能优化</li></ul><p><strong>第7章回顾</strong>：</p><ul><li>生产级RAG应用</li></ul><p><strong>第8章回顾</strong>：</p><ul><li>与LangChain集成</li></ul><hr><h2 id=思考与练习>思考与练习<a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0>#</a></h2><ol><li><strong>练习1</strong>：使用LlamaIndex构建一个本地文档问答系统</li><li><strong>练习2</strong>：对比不同索引类型的效果</li><li><strong>练习3</strong>：实现一个使用语义分块的高质量RAG系统</li><li><strong>练习4</strong>：将LlamaIndex集成到LangChain Agent中</li><li><strong>练习5</strong>：使用低级组件实现自定义检索逻辑</li></ol><hr><h2 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h2><ul><li><a href=https://docs.llamaindex.ai/>LlamaIndex官方文档</a></li><li><a href=https://github.com/run-llama/llama_index>LlamaIndex GitHub</a></li><li><a href=https://github.com/run-llama/llama_index/tree/main/docs/examples>LlamaIndex Examples</a></li><li><a href=https://llamahub.ai/>LlamaHub - Data Loaders</a></li></ul><hr><h2 id=下一步学习>下一步学习<a class=anchor href=#%e4%b8%8b%e4%b8%80%e6%ad%a5%e5%ad%a6%e4%b9%a0>#</a></h2><p>完成本章学习后，建议继续学习：</p><ol><li><strong>RAG 进阶篇</strong>：高级检索策略、混合检索、重排序</li><li><strong>Agent 篇</strong>：使用 LlamaIndex 构建智能 Agent</li><li><strong>生产部署篇</strong>：性能优化、监控、评估</li></ol><hr><p><strong>版本信息</strong>：</p><ul><li>LlamaIndex: 0.11.0+</li><li>llama-index-core: 0.11.0+</li><li>llama-index-llms-openai: 0.2.0+</li><li>llama-index-embeddings-openai: 0.2.0+</li><li>最后更新: 2026-01-19</li></ul></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第四篇 RAG基础篇(LangChain篇)</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/ class="flex align-center"><span>第五篇 RAG高级篇(LangChain篇)</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#前置准备>前置准备</a><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#环境变量设置>环境变量设置</a></li><li><a href=#准备测试数据>准备测试数据</a></li></ul></li><li><a href=#第-1-章为什么选择-llamaindex>第 1 章：为什么选择 LlamaIndex？</a><ul><li><a href=#11-llamaindex-vs-langchain设计哲学对比>1.1 LlamaIndex vs LangChain：设计哲学对比</a><ul><li><a href=#核心定位差异>核心定位差异</a></li><li><a href=#设计哲学>设计哲学</a></li><li><a href=#何时选择-llamaindex>何时选择 LlamaIndex？</a></li><li><a href=#最佳实践两者结合>最佳实践：两者结合</a></li></ul></li><li><a href=#12-快速开始5行代码实现rag>1.2 快速开始：5行代码实现RAG</a><ul><li><a href=#最简单的rag应用>最简单的RAG应用</a></li><li><a href=#查看详细信息>查看详细信息</a></li></ul></li><li><a href=#13-核心组件详解>1.3 核心组件详解</a><ul><li><a href=#document文档>Document（文档）</a></li><li><a href=#node节点>Node（节点）</a></li><li><a href=#index索引>Index（索引）</a></li></ul></li></ul></li><li><a href=#第-2-章数据摄取data-ingestion>第 2 章：数据摄取（Data Ingestion）</a><ul><li><a href=#21-文档加载器document-loaders>2.1 文档加载器（Document Loaders）</a><ul><li><a href=#simpledirectoryreader最常用>SimpleDirectoryReader（最常用）</a></li><li><a href=#远程文件系统支持>远程文件系统支持</a></li></ul></li><li><a href=#22-节点解析器node-parser>2.2 节点解析器（Node Parser）</a><ul><li><a href=#为什么需要分块>为什么需要分块？</a></li><li><a href=#sentencesplitter---智能句子分割>SentenceSplitter - 智能句子分割</a></li><li><a href=#semanticsplitter---语义分块>SemanticSplitter - 语义分块</a></li><li><a href=#分块策略对比>分块策略对比</a></li></ul></li><li><a href=#23-摄取管道ingestion-pipeline>2.3 摄取管道（Ingestion Pipeline）</a><ul><li><a href=#什么是-ingestion-pipeline>什么是 Ingestion Pipeline？</a></li><li><a href=#基础用法>基础用法</a></li><li><a href=#带缓存的管道生产推荐>带缓存的管道（生产推荐）</a></li><li><a href=#持久化缓存>持久化缓存</a></li></ul></li></ul></li><li><a href=#第-3-章索引indexing>第 3 章：索引（Indexing）</a><ul><li><a href=#31-vectorstoreindex---向量索引最常用>3.1 VectorStoreIndex - 向量索引（最常用）</a><ul><li><a href=#基础用法-1>基础用法</a></li><li><a href=#使用-ingestion-pipeline-创建索引>使用 Ingestion Pipeline 创建索引</a></li><li><a href=#直接管理节点>直接管理节点</a></li></ul></li><li><a href=#32-其他索引类型>3.2 其他索引类型</a><ul><li><a href=#summaryindex---摘要索引>SummaryIndex - 摘要索引</a></li><li><a href=#treeindex---树形索引>TreeIndex - 树形索引</a></li><li><a href=#keywordtableindex---关键词索引>KeywordTableIndex - 关键词索引</a></li></ul></li><li><a href=#33-持久化persisting>3.3 持久化（Persisting）</a><ul><li><a href=#保存索引到磁盘>保存索引到磁盘</a></li><li><a href=#从磁盘加载索引>从磁盘加载索引</a></li><li><a href=#使用远程存储s3>使用远程存储（S3）</a></li></ul></li><li><a href=#34-向量数据库集成>3.4 向量数据库集成</a><ul><li><a href=#内置向量存储>内置向量存储</a></li><li><a href=#集成chroma向量数据库>集成Chroma向量数据库</a></li><li><a href=#向量数据库选择指南>向量数据库选择指南</a></li></ul></li></ul></li><li><a href=#第-4-章查询querying>第 4 章：查询（Querying）</a><ul><li><a href=#41-查询引擎query-engine>4.1 查询引擎（Query Engine）</a><ul><li><a href=#基础查询引擎>基础查询引擎</a></li><li><a href=#响应模式response-mode>响应模式（Response Mode）</a></li><li><a href=#流式输出>流式输出</a></li><li><a href=#自定义prompt>自定义Prompt</a></li></ul></li><li><a href=#42-检索器retriever>4.2 检索器（Retriever）</a><ul><li><a href=#基础检索器>基础检索器</a></li><li><a href=#自定义检索器>自定义检索器</a></li></ul></li><li><a href=#43-聊天引擎chat-engine>4.3 聊天引擎（Chat Engine）</a><ul><li><a href=#基础聊天引擎>基础聊天引擎</a></li><li><a href=#流式聊天>流式聊天</a></li><li><a href=#查看对话历史>查看对话历史</a></li></ul></li></ul></li><li><a href=#第-5-章低级组件low-level-components>第 5 章：低级组件（Low-Level Components）</a><ul><li><a href=#51-为什么需要低级组件>5.1 为什么需要低级组件？</a></li><li><a href=#52-使用-retriever--responsesynthesizer>5.2 使用 Retriever + ResponseSynthesizer</a><ul><li><a href=#基础用法-2>基础用法</a></li><li><a href=#自定义响应合成器>自定义响应合成器</a></li><li><a href=#添加节点后处理器>添加节点后处理器</a></li></ul></li><li><a href=#53-手动控制检索和生成>5.3 手动控制检索和生成</a><ul><li><a href=#分步执行>分步执行</a></li><li><a href=#自定义后处理逻辑>自定义后处理逻辑</a></li></ul></li></ul></li><li><a href=#第-6-章全局配置settings>第 6 章：全局配置（Settings）</a><ul><li><a href=#61-配置llm和embedding>6.1 配置LLM和Embedding</a><ul><li><a href=#使用openai>使用OpenAI</a></li><li><a href=#配置本地模型>配置本地模型</a></li></ul></li><li><a href=#62-性能优化>6.2 性能优化</a><ul><li><a href=#分块优化>分块优化</a></li><li><a href=#批量插入优化>批量插入优化</a></li><li><a href=#缓存优化>缓存优化</a></li></ul></li></ul></li><li><a href=#第-7-章生产级应用实战>第 7 章：生产级应用实战</a><ul><li><a href=#71-完整的rag应用>7.1 完整的RAG应用</a></li></ul></li><li><a href=#第-8-章与-langchain-集成>第 8 章：与 LangChain 集成</a><ul><li><a href=#81-llamaindex-作为-langchain-工具>8.1 LlamaIndex 作为 LangChain 工具</a></li><li><a href=#82-完整集成示例>8.2 完整集成示例</a></li></ul></li><li><a href=#本章小结>本章小结</a></li><li><a href=#思考与练习>思考与练习</a></li><li><a href=#参考资源>参考资源</a></li><li><a href=#下一步学习>下一步学习</a></li></ul></nav></div></aside></main></body></html>