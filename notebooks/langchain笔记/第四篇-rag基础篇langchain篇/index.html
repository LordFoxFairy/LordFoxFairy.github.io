<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第四篇：RAG基础篇（LangChain生产实战）# 📋 前置准备# 环境配置# # 核心依赖（LangChain 1.0+） pip install langchain>=1.0.7 pip install langchain-openai>=1.0.3 pip install langchain-core>=1.0.0 pip install langchain-community>=0.4.1 pip install langchain-text-splitters>=0.4.0 # 向量数据库 pip install langchain-chroma>=0.2.0 pip install chromadb>=0.5.0 # 可选依赖 pip install pypdf # PDF文档支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env OPENAI_API_KEY=sk-your-api-key # 可选：启用LangSmith追踪 LANGSMITH_API_KEY=your-langsmith-key LANGSMITH_TRACING=true LANGSMITH_PROJECT=rag-tutorial 第 1 章：RAG架构与核心概念# 1.1 什么是RAG？# **RAG（Retrieval-Augmented Generation）**是一种结合检索和生成的技术，通过从外部知识库检索相关信息来增强LLM的回答能力。
1.1.1 为什么需要RAG？# LLM的两大限制：
有限的上下文窗口 - 无法一次性处理整个文档库 静态知识 - 训练数据固化在某个时间点 RAG的解决方案：
在查询时动态检索相关外部知识 将检索到的上下文注入到LLM提示中 生成基于实时数据的准确回答 1.1.2 RAG完整架构# graph TB subgraph "离线索引阶段 Indexing" A[📄 原始文档<br/>Documents] --> B[📥 文档加载<br/>Document Loaders] B --> C[✂️ 文本分割<br/>Text Splitters] C --> D[🔢 向量化<br/>Embeddings] D --> E[(🗄️ 向量存储<br/>Vector Store)] end subgraph "在线检索阶段 Retrieval" F[❓ 用户查询<br/>User Query] --> G[🔢 查询向量化<br/>Query Embedding] G --> H[🔍 相似度检索<br/>Similarity Search] H --> E E --> I[📑 Top-K文档<br/>Retrieved Docs] end subgraph "生成阶段 Generation" F --> J[💬 提示模板<br/>Prompt Template] I --> J J --> K[🤖 LLM生成<br/>Chat Model] K --> L[✅ 最终答案<br/>Response] end style A fill:#FFE4E1 style E fill:#E3F2FD style L fill:#C8E6C91.1.3 RAG工作流程# 阶段一：离线索引（Indexing）
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第四篇 RAG基础篇(LangChain篇)"><meta property="og:description" content='第四篇：RAG基础篇（LangChain生产实战）# 📋 前置准备# 环境配置# # 核心依赖（LangChain 1.0+） pip install langchain>=1.0.7 pip install langchain-openai>=1.0.3 pip install langchain-core>=1.0.0 pip install langchain-community>=0.4.1 pip install langchain-text-splitters>=0.4.0 # 向量数据库 pip install langchain-chroma>=0.2.0 pip install chromadb>=0.5.0 # 可选依赖 pip install pypdf # PDF文档支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env OPENAI_API_KEY=sk-your-api-key # 可选：启用LangSmith追踪 LANGSMITH_API_KEY=your-langsmith-key LANGSMITH_TRACING=true LANGSMITH_PROJECT=rag-tutorial 第 1 章：RAG架构与核心概念# 1.1 什么是RAG？# **RAG（Retrieval-Augmented Generation）**是一种结合检索和生成的技术，通过从外部知识库检索相关信息来增强LLM的回答能力。
1.1.1 为什么需要RAG？# LLM的两大限制：
有限的上下文窗口 - 无法一次性处理整个文档库 静态知识 - 训练数据固化在某个时间点 RAG的解决方案：
在查询时动态检索相关外部知识 将检索到的上下文注入到LLM提示中 生成基于实时数据的准确回答 1.1.2 RAG完整架构# graph TB subgraph "离线索引阶段 Indexing" A[📄 原始文档<br/>Documents] --> B[📥 文档加载<br/>Document Loaders] B --> C[✂️ 文本分割<br/>Text Splitters] C --> D[🔢 向量化<br/>Embeddings] D --> E[(🗄️ 向量存储<br/>Vector Store)] end subgraph "在线检索阶段 Retrieval" F[❓ 用户查询<br/>User Query] --> G[🔢 查询向量化<br/>Query Embedding] G --> H[🔍 相似度检索<br/>Similarity Search] H --> E E --> I[📑 Top-K文档<br/>Retrieved Docs] end subgraph "生成阶段 Generation" F --> J[💬 提示模板<br/>Prompt Template] I --> J J --> K[🤖 LLM生成<br/>Chat Model] K --> L[✅ 最终答案<br/>Response] end style A fill:#FFE4E1 style E fill:#E3F2FD style L fill:#C8E6C91.1.3 RAG工作流程# 阶段一：离线索引（Indexing）'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第四篇 RAG基础篇(LangChain篇)"><meta itemprop=description content='第四篇：RAG基础篇（LangChain生产实战）# 📋 前置准备# 环境配置# # 核心依赖（LangChain 1.0+） pip install langchain>=1.0.7 pip install langchain-openai>=1.0.3 pip install langchain-core>=1.0.0 pip install langchain-community>=0.4.1 pip install langchain-text-splitters>=0.4.0 # 向量数据库 pip install langchain-chroma>=0.2.0 pip install chromadb>=0.5.0 # 可选依赖 pip install pypdf # PDF文档支持 pip install python-dotenv # 环境变量管理环境变量设置# # .env OPENAI_API_KEY=sk-your-api-key # 可选：启用LangSmith追踪 LANGSMITH_API_KEY=your-langsmith-key LANGSMITH_TRACING=true LANGSMITH_PROJECT=rag-tutorial 第 1 章：RAG架构与核心概念# 1.1 什么是RAG？# **RAG（Retrieval-Augmented Generation）**是一种结合检索和生成的技术，通过从外部知识库检索相关信息来增强LLM的回答能力。
1.1.1 为什么需要RAG？# LLM的两大限制：
有限的上下文窗口 - 无法一次性处理整个文档库 静态知识 - 训练数据固化在某个时间点 RAG的解决方案：
在查询时动态检索相关外部知识 将检索到的上下文注入到LLM提示中 生成基于实时数据的准确回答 1.1.2 RAG完整架构# graph TB subgraph "离线索引阶段 Indexing" A[📄 原始文档<br/>Documents] --> B[📥 文档加载<br/>Document Loaders] B --> C[✂️ 文本分割<br/>Text Splitters] C --> D[🔢 向量化<br/>Embeddings] D --> E[(🗄️ 向量存储<br/>Vector Store)] end subgraph "在线检索阶段 Retrieval" F[❓ 用户查询<br/>User Query] --> G[🔢 查询向量化<br/>Query Embedding] G --> H[🔍 相似度检索<br/>Similarity Search] H --> E E --> I[📑 Top-K文档<br/>Retrieved Docs] end subgraph "生成阶段 Generation" F --> J[💬 提示模板<br/>Prompt Template] I --> J J --> K[🤖 LLM生成<br/>Chat Model] K --> L[✅ 最终答案<br/>Response] end style A fill:#FFE4E1 style E fill:#E3F2FD style L fill:#C8E6C91.1.3 RAG工作流程# 阶段一：离线索引（Indexing）'><meta itemprop=wordCount content="2504"><title>第四篇 RAG基础篇(LangChain篇) | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/ class=active>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第四篇 RAG基础篇(LangChain篇)</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#-前置准备>📋 前置准备</a><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#环境变量设置>环境变量设置</a></li></ul></li><li><a href=#第-1-章rag架构与核心概念>第 1 章：RAG架构与核心概念</a><ul><li><ul><li><a href=#11-什么是rag>1.1 什么是RAG？</a><ul><li><a href=#111-为什么需要rag>1.1.1 为什么需要RAG？</a></li><li><a href=#112-rag完整架构>1.1.2 RAG完整架构</a></li><li><a href=#113-rag工作流程>1.1.3 RAG工作流程</a></li></ul></li><li><a href=#12-langchain-rag的优势>1.2 LangChain RAG的优势</a></li><li><a href=#13-两种rag实现模式>1.3 两种RAG实现模式</a><ul><li><a href=#131-rag-agent智能灵活>1.3.1 RAG Agent（智能灵活）</a></li><li><a href=#132-2-step-rag-chain快速简洁>1.3.2 2-Step RAG Chain（快速简洁）</a></li></ul></li></ul></li></ul></li><li><a href=#第-2-章索引流程---从文档到向量库>第 2 章：索引流程 - 从文档到向量库</a><ul><li><a href=#21-文档加载document-loaders>2.1 文档加载（Document Loaders）</a><ul><li><ul><li><a href=#211-基础加载器>2.1.1 基础加载器</a></li><li><a href=#212-常用加载器>2.1.2 常用加载器</a></li></ul></li></ul></li><li><a href=#22-文本分割text-splitters>2.2 文本分割（Text Splitters）</a><ul><li><ul><li><a href=#221-为什么需要分割>2.2.1 为什么需要分割？</a></li><li><a href=#222-recursivecharactertextsplitter推荐>2.2.2 RecursiveCharacterTextSplitter（推荐）</a></li><li><a href=#223-不同场景的分块策略>2.2.3 不同场景的分块策略</a></li></ul></li></ul></li><li><a href=#23-向量化embeddings>2.3 向量化（Embeddings）</a><ul><li><ul><li><a href=#231-openai-embeddings推荐>2.3.1 OpenAI Embeddings（推荐）</a></li><li><a href=#232-模型选择指南>2.3.2 模型选择指南</a></li></ul></li></ul></li><li><a href=#24-向量存储vector-stores>2.4 向量存储（Vector Stores）</a><ul><li><ul><li><a href=#241-chroma本地开发推荐>2.4.1 Chroma（本地开发推荐）</a></li><li><a href=#242-inmemoryvectorstore快速原型>2.4.2 InMemoryVectorStore（快速原型）</a></li><li><a href=#243-向量数据库选择指南>2.4.3 向量数据库选择指南</a></li></ul></li></ul></li><li><a href=#25-检索器retrievers>2.5 检索器（Retrievers）</a><ul><li><ul><li><a href=#251-基础检索器>2.5.1 基础检索器</a></li></ul></li></ul></li></ul></li><li><a href=#第-3-章检索与生成---构建rag链>第 3 章：检索与生成 - 构建RAG链</a><ul><li><a href=#31-标准rag-chainlcel>3.1 标准RAG Chain（LCEL）</a><ul><li><ul><li><a href=#311-完整实现>3.1.1 完整实现</a></li><li><a href=#312-lcel语法详解>3.1.2 LCEL语法详解</a></li></ul></li></ul></li><li><a href=#32-带来源的rag-chain>3.2 带来源的RAG Chain</a><ul><li><ul><li><a href=#321-返回检索文档>3.2.1 返回检索文档</a></li><li><a href=#322-增强格式化函数>3.2.2 增强格式化函数</a></li></ul></li></ul></li><li><a href=#33-流式rag-chain>3.3 流式RAG Chain</a><ul><li><ul><li><a href=#331-实现流式输出>3.3.1 实现流式输出</a></li><li><a href=#332-流式输出的优势>3.3.2 流式输出的优势</a></li></ul></li></ul></li></ul></li><li><a href=#第-4-章生产级rag系统>第 4 章：生产级RAG系统</a><ul><li><a href=#41-完整生产级实现>4.1 完整生产级实现</a></li><li><a href=#42-性能优化指南>4.2 性能优化指南</a><ul><li><ul><li><a href=#421-分块优化>4.2.1 分块优化</a></li><li><a href=#422-embedding优化>4.2.2 Embedding优化</a></li><li><a href=#423-检索优化>4.2.3 检索优化</a></li><li><a href=#424-prompt优化>4.2.4 Prompt优化</a></li></ul></li></ul></li><li><a href=#43-langsmith监控与追踪>4.3 LangSmith监控与追踪</a><ul><li><ul><li><a href=#431-启用langsmith>4.3.1 启用LangSmith</a></li><li><a href=#432-使用langsmith>4.3.2 使用LangSmith</a></li></ul></li><li><a href=#433-自定义追踪>4.3.3 自定义追踪</a></li></ul></li></ul></li><li><a href=#第-5-章高级rag技术>第 5 章：高级RAG技术</a><ul><li><a href=#51-元数据过滤>5.1 元数据过滤</a></li><li><a href=#52-多查询检索multi-query-retrieval>5.2 多查询检索（Multi-Query Retrieval）</a></li><li><a href=#53-上下文压缩contextual-compression>5.3 上下文压缩（Contextual Compression）</a></li></ul></li><li><a href=#第-6-章评估与优化>第 6 章：评估与优化</a><ul><li><a href=#61-评估指标>6.1 评估指标</a><ul><li><ul><li><a href=#611-检索质量评估>6.1.1 检索质量评估</a></li><li><a href=#612-端到端rag评估使用langsmith>6.1.2 端到端RAG评估（使用LangSmith）</a></li></ul></li></ul></li><li><a href=#62-常见问题与解决方案>6.2 常见问题与解决方案</a><ul><li><ul><li><a href=#621-检索不到相关文档>6.2.1 检索不到相关文档</a></li><li><a href=#622-生成的答案不准确>6.2.2 生成的答案不准确</a></li><li><a href=#623-响应延迟高>6.2.3 响应延迟高</a></li></ul></li></ul></li></ul></li><li><a href=#全文总结>全文总结</a><ul><li><a href=#核心要点回顾>核心要点回顾</a><ul><li><ul><li><a href=#第1章rag架构>第1章：RAG架构</a></li><li><a href=#第2章索引流程>第2章：索引流程</a></li><li><a href=#第3章检索与生成>第3章：检索与生成</a></li><li><a href=#第4章生产级系统>第4章：生产级系统</a></li><li><a href=#第5章高级技术>第5章：高级技术</a></li><li><a href=#第6章评估与优化>第6章：评估与优化</a></li></ul></li></ul></li><li><a href=#最佳实践清单>最佳实践清单</a><ul><li><ul><li><a href=#开发阶段>开发阶段</a></li><li><a href=#生产阶段>生产阶段</a></li><li><a href=#优化阶段>优化阶段</a></li></ul></li></ul></li><li><a href=#参考资源>参考资源</a><ul><li><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#api参考>API参考</a></li><li><a href=#社区资源>社区资源</a></li></ul></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第四篇rag基础篇langchain生产实战>第四篇：RAG基础篇（LangChain生产实战）<a class=anchor href=#%e7%ac%ac%e5%9b%9b%e7%af%87rag%e5%9f%ba%e7%a1%80%e7%af%87langchain%e7%94%9f%e4%ba%a7%e5%ae%9e%e6%88%98>#</a></h1><h2 id=-前置准备>📋 前置准备<a class=anchor href=#-%e5%89%8d%e7%bd%ae%e5%87%86%e5%a4%87>#</a></h2><h3 id=环境配置>环境配置<a class=anchor href=#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 核心依赖（LangChain 1.0+）</span>
</span></span><span class=line><span class=cl>pip install langchain&gt;<span class=o>=</span>1.0.7
</span></span><span class=line><span class=cl>pip install langchain-openai&gt;<span class=o>=</span>1.0.3
</span></span><span class=line><span class=cl>pip install langchain-core&gt;<span class=o>=</span>1.0.0
</span></span><span class=line><span class=cl>pip install langchain-community&gt;<span class=o>=</span>0.4.1
</span></span><span class=line><span class=cl>pip install langchain-text-splitters&gt;<span class=o>=</span>0.4.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向量数据库</span>
</span></span><span class=line><span class=cl>pip install langchain-chroma&gt;<span class=o>=</span>0.2.0
</span></span><span class=line><span class=cl>pip install chromadb&gt;<span class=o>=</span>0.5.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可选依赖</span>
</span></span><span class=line><span class=cl>pip install pypdf              <span class=c1># PDF文档支持</span>
</span></span><span class=line><span class=cl>pip install python-dotenv      <span class=c1># 环境变量管理</span></span></span></code></pre></div><h3 id=环境变量设置>环境变量设置<a class=anchor href=#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e8%ae%be%e7%bd%ae>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># .env</span>
</span></span><span class=line><span class=cl><span class=n>OPENAI_API_KEY</span><span class=o>=</span><span class=n>sk</span><span class=o>-</span><span class=n>your</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=n>key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可选：启用LangSmith追踪</span>
</span></span><span class=line><span class=cl><span class=n>LANGSMITH_API_KEY</span><span class=o>=</span><span class=n>your</span><span class=o>-</span><span class=n>langsmith</span><span class=o>-</span><span class=n>key</span>
</span></span><span class=line><span class=cl><span class=n>LANGSMITH_TRACING</span><span class=o>=</span><span class=n>true</span>
</span></span><span class=line><span class=cl><span class=n>LANGSMITH_PROJECT</span><span class=o>=</span><span class=n>rag</span><span class=o>-</span><span class=n>tutorial</span></span></span></code></pre></div><hr><h2 id=第-1-章rag架构与核心概念>第 1 章：RAG架构与核心概念<a class=anchor href=#%e7%ac%ac-1-%e7%ab%a0rag%e6%9e%b6%e6%9e%84%e4%b8%8e%e6%a0%b8%e5%bf%83%e6%a6%82%e5%bf%b5>#</a></h2><h4 id=11-什么是rag>1.1 什么是RAG？<a class=anchor href=#11-%e4%bb%80%e4%b9%88%e6%98%afrag>#</a></h4><p>**RAG（Retrieval-Augmented Generation）**是一种结合检索和生成的技术，通过从外部知识库检索相关信息来增强LLM的回答能力。</p><h5 id=111-为什么需要rag>1.1.1 为什么需要RAG？<a class=anchor href=#111-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81rag>#</a></h5><p><strong>LLM的两大限制</strong>：</p><ol><li><strong>有限的上下文窗口</strong> - 无法一次性处理整个文档库</li><li><strong>静态知识</strong> - 训练数据固化在某个时间点</li></ol><p><strong>RAG的解决方案</strong>：</p><ul><li>在查询时动态检索相关外部知识</li><li>将检索到的上下文注入到LLM提示中</li><li>生成基于实时数据的准确回答</li></ul><h5 id=112-rag完整架构>1.1.2 RAG完整架构<a class=anchor href=#112-rag%e5%ae%8c%e6%95%b4%e6%9e%b6%e6%9e%84>#</a></h5><pre class=mermaid>graph TB
    subgraph &#34;离线索引阶段 Indexing&#34;
        A[📄 原始文档&lt;br/&gt;Documents] --&gt; B[📥 文档加载&lt;br/&gt;Document Loaders]
        B --&gt; C[✂️ 文本分割&lt;br/&gt;Text Splitters]
        C --&gt; D[🔢 向量化&lt;br/&gt;Embeddings]
        D --&gt; E[(🗄️ 向量存储&lt;br/&gt;Vector Store)]
    end

    subgraph &#34;在线检索阶段 Retrieval&#34;
        F[❓ 用户查询&lt;br/&gt;User Query] --&gt; G[🔢 查询向量化&lt;br/&gt;Query Embedding]
        G --&gt; H[🔍 相似度检索&lt;br/&gt;Similarity Search]
        H --&gt; E
        E --&gt; I[📑 Top-K文档&lt;br/&gt;Retrieved Docs]
    end

    subgraph &#34;生成阶段 Generation&#34;
        F --&gt; J[💬 提示模板&lt;br/&gt;Prompt Template]
        I --&gt; J
        J --&gt; K[🤖 LLM生成&lt;br/&gt;Chat Model]
        K --&gt; L[✅ 最终答案&lt;br/&gt;Response]
    end

    style A fill:#FFE4E1
    style E fill:#E3F2FD
    style L fill:#C8E6C9</pre><script src=/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"default"})</script><h5 id=113-rag工作流程>1.1.3 RAG工作流程<a class=anchor href=#113-rag%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b>#</a></h5><p><strong>阶段一：离线索引（Indexing）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>文档</span> <span class=err>→</span> <span class=n>加载</span> <span class=err>→</span> <span class=n>分割</span> <span class=err>→</span> <span class=n>向量化</span> <span class=err>→</span> <span class=n>存储</span></span></span></code></pre></div><p><strong>阶段二：在线检索与生成（Retrieval & Generation）</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>用户查询</span> <span class=err>→</span> <span class=n>向量化</span> <span class=err>→</span> <span class=n>检索相关文档</span> <span class=err>→</span> <span class=n>构建提示</span> <span class=err>→</span> <span class=n>LLM生成答案</span></span></span></code></pre></div><hr><h4 id=12-langchain-rag的优势>1.2 LangChain RAG的优势<a class=anchor href=#12-langchain-rag%e7%9a%84%e4%bc%98%e5%8a%bf>#</a></h4><table><thead><tr><th>特性</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>LCEL组合</strong></td><td>使用管道语法（<code>|</code>）串联组件</td><td><code>retriever | prompt | llm</code></td></tr><tr><td><strong>模块化</strong></td><td>每个组件可独立替换</td><td>轻松切换向量数据库或LLM</td></tr><tr><td><strong>生产级</strong></td><td>内置追踪、监控、评估</td><td>LangSmith集成</td></tr><tr><td><strong>灵活性</strong></td><td>支持多种RAG模式</td><td>Agent RAG、2-Step RAG</td></tr><tr><td><strong>丰富集成</strong></td><td>100+ 向量库、LLM集成</td><td>Chroma、FAISS、Pinecone等</td></tr></tbody></table><hr><h4 id=13-两种rag实现模式>1.3 两种RAG实现模式<a class=anchor href=#13-%e4%b8%a4%e7%a7%8drag%e5%ae%9e%e7%8e%b0%e6%a8%a1%e5%bc%8f>#</a></h4><h5 id=131-rag-agent智能灵活>1.3.1 RAG Agent（智能灵活）<a class=anchor href=#131-rag-agent%e6%99%ba%e8%83%bd%e7%81%b5%e6%b4%bb>#</a></h5><p><strong>特点</strong>：LLM自主决定何时检索</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span><span class=p>(</span><span class=n>response_format</span><span class=o>=</span><span class=s2>&#34;content_and_artifact&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retrieve_context</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检索相关文档以帮助回答问题&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span> <span class=o>=</span> <span class=n>vector_store</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>serialized</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;来源: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=se>\n</span><span class=s2>内容: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>serialized</span><span class=p>,</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Agent（LLM决定是否调用检索工具）</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>retrieve_context</span><span class=p>])</span></span></span></code></pre></div><p><strong>优势与劣势</strong>：</p><ul><li>✅ <strong>按需检索</strong> - LLM可处理闲聊、追问，无需每次都检索</li><li>✅ <strong>上下文查询</strong> - LLM可根据对话历史构建更好的检索查询</li><li>✅ <strong>多次检索</strong> - 可执行多轮检索以获得更全面的信息</li><li>⚠️ <strong>两次推理</strong> - 需要一次生成查询，一次生成答案（延迟更高）</li><li>⚠️ <strong>控制力弱</strong> - LLM可能跳过必要的检索或执行不必要的检索</li></ul><h5 id=132-2-step-rag-chain快速简洁>1.3.2 2-Step RAG Chain（快速简洁）<a class=anchor href=#132-2-step-rag-chain%e5%bf%ab%e9%80%9f%e7%ae%80%e6%b4%81>#</a></h5><p><strong>特点</strong>：每次查询都执行检索，单次LLM调用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnablePassthrough</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 格式化检索文档</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>format_docs</span><span class=p>(</span><span class=n>docs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建2-Step Chain（LCEL语法）</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>优势与劣势</strong>：</p><ul><li>✅ <strong>低延迟</strong> - 单次LLM调用，响应更快</li><li>✅ <strong>可预测</strong> - 每次都执行检索，行为一致</li><li>✅ <strong>易调试</strong> - 流程固定，容易追踪和优化</li><li>⚠️ <strong>灵活性低</strong> - 无法处理不需要检索的简单查询</li><li>⚠️ <strong>固定模式</strong> - 总是检索固定数量的文档</li></ul><blockquote class=book-hint><p><strong>选择建议</strong>：对于大多数应用，推荐从<strong>2-Step RAG Chain</strong>开始，因为它简单、快速、易于调试。只有在需要动态决策时才使用RAG Agent。</p></blockquote><hr><h2 id=第-2-章索引流程---从文档到向量库>第 2 章：索引流程 - 从文档到向量库<a class=anchor href=#%e7%ac%ac-2-%e7%ab%a0%e7%b4%a2%e5%bc%95%e6%b5%81%e7%a8%8b---%e4%bb%8e%e6%96%87%e6%a1%a3%e5%88%b0%e5%90%91%e9%87%8f%e5%ba%93>#</a></h2><h3 id=21-文档加载document-loaders>2.1 文档加载（Document Loaders）<a class=anchor href=#21-%e6%96%87%e6%a1%a3%e5%8a%a0%e8%bd%bddocument-loaders>#</a></h3><h5 id=211-基础加载器>2.1.1 基础加载器<a class=anchor href=#211-%e5%9f%ba%e7%a1%80%e5%8a%a0%e8%bd%bd%e5%99%a8>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>TextLoader</span><span class=p>,</span> <span class=n>DirectoryLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 加载单个文本文件</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>TextLoader</span><span class=p>(</span><span class=s2>&#34;document.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量加载目录下所有文本文件</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>DirectoryLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>glob</span><span class=o>=</span><span class=s2>&#34;**/*.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>loader_cls</span><span class=o>=</span><span class=n>TextLoader</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>documents</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 加载了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>documents</span><span class=p>[:</span><span class=mi>2</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;内容预览: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;元数据: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=212-常用加载器>2.1.2 常用加载器<a class=anchor href=#212-%e5%b8%b8%e7%94%a8%e5%8a%a0%e8%bd%bd%e5%99%a8>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># PDF加载器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>PyPDFLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>PyPDFLoader</span><span class=p>(</span><span class=s2>&#34;report.pdf&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pages</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;PDF共 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>pages</span><span class=p>)</span><span class=si>}</span><span class=s2> 页&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 网页加载器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>WebBaseLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>WebBaseLoader</span><span class=p>(</span><span class=n>web_paths</span><span class=o>=</span><span class=p>(</span><span class=s2>&#34;https://example.com&#34;</span><span class=p>,))</span>
</span></span><span class=line><span class=cl><span class=n>web_docs</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CSV加载器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>CSVLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>CSVLoader</span><span class=p>(</span><span class=n>file_path</span><span class=o>=</span><span class=s2>&#34;data.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>csv_docs</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Markdown加载器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>UnstructuredMarkdownLoader</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>UnstructuredMarkdownLoader</span><span class=p>(</span><span class=s2>&#34;README.md&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>md_docs</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span></span></span></code></pre></div><blockquote class=book-hint><p><strong>提示</strong>：所有加载器返回的文档都包含 <code>page_content</code>（文本内容）和 <code>metadata</code>（元数据，如文件名、页码等）。</p></blockquote><hr><h3 id=22-文本分割text-splitters>2.2 文本分割（Text Splitters）<a class=anchor href=#22-%e6%96%87%e6%9c%ac%e5%88%86%e5%89%b2text-splitters>#</a></h3><h5 id=221-为什么需要分割>2.2.1 为什么需要分割？<a class=anchor href=#221-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e5%88%86%e5%89%b2>#</a></h5><p><strong>挑战</strong>：</p><ul><li>LLM有上下文窗口限制</li><li>向量检索需要语义独立的文本块</li><li>块太大会降低检索精度，块太小会丢失上下文</li></ul><p><strong>解决方案</strong>：将长文档分割成适当大小的块（chunks），并保留重叠（overlap）以维持上下文。</p><h5 id=222-recursivecharactertextsplitter推荐>2.2.2 RecursiveCharacterTextSplitter（推荐）<a class=anchor href=#222-recursivecharactertextsplitter%e6%8e%a8%e8%8d%90>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建智能分割器</span>
</span></span><span class=line><span class=cl><span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>        <span class=c1># 每块最大字符数</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span>      <span class=c1># 块间重叠字符数（保持上下文）</span>
</span></span><span class=line><span class=cl>    <span class=n>length_function</span><span class=o>=</span><span class=nb>len</span><span class=p>,</span>    <span class=c1># 计算长度的函数</span>
</span></span><span class=line><span class=cl>    <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;。&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>  <span class=c1># 优先在段落/句子边界分割</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分割文档</span>
</span></span><span class=line><span class=cl><span class=n>chunks</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 分割成 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> 个块&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>chunks</span><span class=p>[:</span><span class=mi>3</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>块 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2> (长度: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>chunk</span><span class=o>.</span><span class=n>page_content</span><span class=p>)</span><span class=si>}</span><span class=s2>):&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>chunk</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>150</span><span class=p>])</span></span></span></code></pre></div><p><strong>工作原理</strong>：</p><ol><li>尝试用 <code>\n\n</code>（段落）分割</li><li>如果块仍太大，用 <code>\n</code>（换行）分割</li><li>继续用 <code>。</code>、<code>.</code>（句子）分割</li><li>最后用空格和字符分割</li></ol><h5 id=223-不同场景的分块策略>2.2.3 不同场景的分块策略<a class=anchor href=#223-%e4%b8%8d%e5%90%8c%e5%9c%ba%e6%99%af%e7%9a%84%e5%88%86%e5%9d%97%e7%ad%96%e7%95%a5>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 场景1：短文本FAQ（小块）</span>
</span></span><span class=line><span class=cl><span class=n>faq_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>50</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景2：长文档（大块，更多上下文）</span>
</span></span><span class=line><span class=cl><span class=n>long_doc_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>400</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景3：代码文档（保留代码结构）</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>Language</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>code_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=o>.</span><span class=n>from_language</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>language</span><span class=o>=</span><span class=n>Language</span><span class=o>.</span><span class=n>PYTHON</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景4：中文文档（优化分隔符）</span>
</span></span><span class=line><span class=cl><span class=n>chinese_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;。&#34;</span><span class=p>,</span> <span class=s2>&#34;！&#34;</span><span class=p>,</span> <span class=s2>&#34;？&#34;</span><span class=p>,</span> <span class=s2>&#34;；&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34;!&#34;</span><span class=p>,</span> <span class=s2>&#34;?&#34;</span><span class=p>,</span> <span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><blockquote class=book-hint><p><strong>最佳实践</strong>：</p><ul><li><code>chunk_overlap</code> 通常设置为 <code>chunk_size</code> 的 10-20%</li><li>根据实际数据调整，通过评估找到最佳值</li><li>中文建议块大小 500-1000 字符</li></ul></blockquote><hr><h3 id=23-向量化embeddings>2.3 向量化（Embeddings）<a class=anchor href=#23-%e5%90%91%e9%87%8f%e5%8c%96embeddings>#</a></h3><h5 id=231-openai-embeddings推荐>2.3.1 OpenAI Embeddings（推荐）<a class=anchor href=#231-openai-embeddings%e6%8e%a8%e8%8d%90>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Embeddings模型</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>,</span>  <span class=c1># 3072维，效果最好</span>
</span></span><span class=line><span class=cl>    <span class=c1># model=&#34;text-embedding-3-small&#34;,  # 1536维，性价比高</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向量化单个查询</span>
</span></span><span class=line><span class=cl><span class=n>query_vector</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;查询向量维度: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>query_vector</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量向量化文档（更高效）</span>
</span></span><span class=line><span class=cl><span class=n>doc_texts</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;文档1&#34;</span><span class=p>,</span> <span class=s2>&#34;文档2&#34;</span><span class=p>,</span> <span class=s2>&#34;文档3&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>doc_vectors</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_documents</span><span class=p>(</span><span class=n>doc_texts</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;批量向量化了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>doc_vectors</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文档&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=232-模型选择指南>2.3.2 模型选择指南<a class=anchor href=#232-%e6%a8%a1%e5%9e%8b%e9%80%89%e6%8b%a9%e6%8c%87%e5%8d%97>#</a></h5><table><thead><tr><th>模型</th><th>维度</th><th>性能</th><th>成本</th><th>适用场景</th></tr></thead><tbody><tr><td><code>text-embedding-3-large</code></td><td>3072</td><td>最佳</td><td>高</td><td>生产环境、高精度需求</td></tr><tr><td><code>text-embedding-3-small</code></td><td>1536</td><td>良好</td><td>低</td><td>开发测试、性价比优先</td></tr><tr><td><code>text-embedding-ada-002</code></td><td>1536</td><td>良好</td><td>中</td><td>旧版本，不推荐新项目使用</td></tr></tbody></table><blockquote class=book-hint><p><strong>提示</strong>：<code>text-embedding-3-*</code> 系列性能更优，价格更低，是推荐选择。</p></blockquote><hr><h3 id=24-向量存储vector-stores>2.4 向量存储（Vector Stores）<a class=anchor href=#24-%e5%90%91%e9%87%8f%e5%ad%98%e5%82%a8vector-stores>#</a></h3><h5 id=241-chroma本地开发推荐>2.4.1 Chroma（本地开发推荐）<a class=anchor href=#241-chroma%e6%9c%ac%e5%9c%b0%e5%bc%80%e5%8f%91%e6%8e%a8%e8%8d%90>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式1: 从文档直接创建向量库</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>chunks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span>  <span class=c1># 持久化存储</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2: 加载已有向量库</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding_function</span><span class=o>=</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加文档</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span><span class=o>.</span><span class=n>add_documents</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>new_chunks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 相似度搜索</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=o>=</span><span class=mi>3</span>  <span class=c1># 返回Top-3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=242-inmemoryvectorstore快速原型>2.4.2 InMemoryVectorStore（快速原型）<a class=anchor href=#242-inmemoryvectorstore%e5%bf%ab%e9%80%9f%e5%8e%9f%e5%9e%8b>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.vectorstores</span> <span class=kn>import</span> <span class=n>InMemoryVectorStore</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 轻量级内存向量库（无需外部依赖）</span>
</span></span><span class=line><span class=cl><span class=n>vector_store</span> <span class=o>=</span> <span class=n>InMemoryVectorStore</span><span class=p>(</span><span class=n>embeddings</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ids</span> <span class=o>=</span> <span class=n>vector_store</span><span class=o>.</span><span class=n>add_documents</span><span class=p>(</span><span class=n>documents</span><span class=o>=</span><span class=n>chunks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 相似度搜索（带分数）</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vector_store</span><span class=o>.</span><span class=n>similarity_search_with_score</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;相似度: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;内容: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=243-向量数据库选择指南>2.4.3 向量数据库选择指南<a class=anchor href=#243-%e5%90%91%e9%87%8f%e6%95%b0%e6%8d%ae%e5%ba%93%e9%80%89%e6%8b%a9%e6%8c%87%e5%8d%97>#</a></h5><table><thead><tr><th>数据库</th><th>类型</th><th>性能</th><th>部署难度</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>InMemoryVectorStore</strong></td><td>内存</td><td>快</td><td>⭐</td><td>快速原型、测试</td></tr><tr><td><strong>Chroma</strong></td><td>嵌入式</td><td>中</td><td>⭐</td><td>本地开发、中小型应用</td></tr><tr><td><strong>FAISS</strong></td><td>库</td><td>高</td><td>⭐⭐</td><td>单机高性能、大规模检索</td></tr><tr><td><strong>Qdrant</strong></td><td>服务</td><td>高</td><td>⭐⭐⭐</td><td>生产环境、分布式</td></tr><tr><td><strong>Pinecone</strong></td><td>云服务</td><td>高</td><td>⭐</td><td>云原生、无需运维</td></tr><tr><td><strong>Weaviate</strong></td><td>服务</td><td>高</td><td>⭐⭐⭐</td><td>企业级、GraphRAG</td></tr></tbody></table><hr><h3 id=25-检索器retrievers>2.5 检索器（Retrievers）<a class=anchor href=#25-%e6%a3%80%e7%b4%a2%e5%99%a8retrievers>#</a></h3><h5 id=251-基础检索器>2.5.1 基础检索器<a class=anchor href=#251-%e5%9f%ba%e7%a1%80%e6%a3%80%e7%b4%a2%e5%99%a8>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 方式1：相似度检索（默认）</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;similarity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>}</span>  <span class=c1># Top-5</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：MMR检索（增加多样性）</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;mmr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>           <span class=c1># 返回5个结果</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;fetch_k&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>    <span class=c1># 从20个候选中选择</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda_mult&#34;</span><span class=p>:</span> <span class=mf>0.5</span>  <span class=c1># 0=多样性, 1=相关性</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式3：相似度阈值过滤</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;similarity_score_threshold&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score_threshold&#34;</span><span class=p>:</span> <span class=mf>0.7</span><span class=p>,</span>  <span class=c1># 只返回相似度&gt;0.7的文档</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用检索器</span>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>])</span></span></span></code></pre></div><blockquote class=book-hint><p><strong>提示</strong>：检索器实现了 <code>Runnable</code> 接口，可直接用于LCEL链中。</p></blockquote><hr><h2 id=第-3-章检索与生成---构建rag链>第 3 章：检索与生成 - 构建RAG链<a class=anchor href=#%e7%ac%ac-3-%e7%ab%a0%e6%a3%80%e7%b4%a2%e4%b8%8e%e7%94%9f%e6%88%90---%e6%9e%84%e5%bb%barag%e9%93%be>#</a></h2><h3 id=31-标准rag-chainlcel>3.1 标准RAG Chain（LCEL）<a class=anchor href=#31-%e6%a0%87%e5%87%86rag-chainlcel>#</a></h3><h5 id=311-完整实现>3.1.1 完整实现<a class=anchor href=#311-%e5%ae%8c%e6%95%b4%e5%ae%9e%e7%8e%b0>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span><span class=p>,</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnablePassthrough</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 创建检索器</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding_function</span><span class=o>=</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建Prompt模板</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>你是一个专业的AI助手。请基于以下上下文回答问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：
</span></span></span><span class=line><span class=cl><span class=si>{context}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 如果上下文中有相关信息，请详细回答
</span></span></span><span class=line><span class=cl><span class=s2>2. 如果上下文中没有相关信息，请明确说明&#34;根据提供的文档，我无法回答这个问题&#34;
</span></span></span><span class=line><span class=cl><span class=s2>3. 不要编造信息，只使用上下文中的内容
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建LLM</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 格式化函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>format_docs</span><span class=p>(</span><span class=n>docs</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;将文档列表格式化为字符串&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 构建RAG链（LCEL语法）</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 执行查询</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span></span></span></code></pre></div><h5 id=312-lcel语法详解>3.1.2 LCEL语法详解<a class=anchor href=#312-lcel%e8%af%ad%e6%b3%95%e8%af%a6%e8%a7%a3>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># LCEL使用管道（|）操作符串联组件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1: 并行执行检索和问题传递</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()}</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: {&#34;context&#34;: &#34;检索到的文档&#34;, &#34;question&#34;: &#34;用户问题&#34;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2: 将字典传递给Prompt模板</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: ChatPromptValue（格式化后的提示）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3: LLM生成</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: AIMessage（包含answer和metadata）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4: 提取文本内容</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: str（纯文本答案）</span></span></span></code></pre></div><hr><h3 id=32-带来源的rag-chain>3.2 带来源的RAG Chain<a class=anchor href=#32-%e5%b8%a6%e6%9d%a5%e6%ba%90%e7%9a%84rag-chain>#</a></h3><h5 id=321-返回检索文档>3.2.1 返回检索文档<a class=anchor href=#321-%e8%bf%94%e5%9b%9e%e6%a3%80%e7%b4%a2%e6%96%87%e6%a1%a3>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableParallel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建返回来源的链</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain_with_source</span> <span class=o>=</span> <span class=n>RunnableParallel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;source_documents&#34;</span><span class=p>:</span> <span class=n>retriever</span><span class=p>,</span>  <span class=c1># 保留原始文档</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>answer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;context&#34;</span><span class=p>],</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行查询</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_chain_with_source</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;回答: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;📚 来源文档:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;source_documents&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   元数据: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=322-增强格式化函数>3.2.2 增强格式化函数<a class=anchor href=#322-%e5%a2%9e%e5%bc%ba%e6%a0%bc%e5%bc%8f%e5%8c%96%e5%87%bd%e6%95%b0>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>format_docs_with_metadata</span><span class=p>(</span><span class=n>docs</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;格式化文档，包含来源信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>formatted</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>docs</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>source</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;source&#39;</span><span class=p>,</span> <span class=s1>&#39;未知&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>page</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;page&#39;</span><span class=p>,</span> <span class=s1>&#39;N/A&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>formatted</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;[文档</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>] (来源: </span><span class=si>{</span><span class=n>source</span><span class=si>}</span><span class=s2>, 页码: </span><span class=si>{</span><span class=n>page</span><span class=si>}</span><span class=s2>)</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>formatted</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用增强格式化</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs_with_metadata</span><span class=p>,</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h3 id=33-流式rag-chain>3.3 流式RAG Chain<a class=anchor href=#33-%e6%b5%81%e5%bc%8frag-chain>#</a></h3><h5 id=331-实现流式输出>3.3.1 实现流式输出<a class=anchor href=#331-%e5%ae%9e%e7%8e%b0%e6%b5%81%e5%bc%8f%e8%be%93%e5%87%ba>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 创建支持流式的LLM</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>streaming</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># 启用流式</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建流式RAG链</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain_stream</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>llm</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 流式输出（实时打印）</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🤖 助手: &#34;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>rag_chain_stream</span><span class=o>.</span><span class=n>stream</span><span class=p>(</span><span class=s2>&#34;详细解释RAG的工作原理&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=332-流式输出的优势>3.3.2 流式输出的优势<a class=anchor href=#332-%e6%b5%81%e5%bc%8f%e8%be%93%e5%87%ba%e7%9a%84%e4%bc%98%e5%8a%bf>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对比：非流式 vs 流式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 非流式（用户等待完整响应）</span>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;解释什么是Transformer架构？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;非流式耗时: </span><span class=si>{</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 流式（用户立即看到输出）</span>
</span></span><span class=line><span class=cl><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>rag_chain_stream</span><span class=o>.</span><span class=n>stream</span><span class=p>(</span><span class=s2>&#34;解释什么是Transformer架构？&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>end</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>流式耗时: </span><span class=si>{</span><span class=n>end</span><span class=o>-</span><span class=n>start</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>秒&#34;</span><span class=p>)</span></span></span></code></pre></div><blockquote class=book-hint><p><strong>用户体验提升</strong>：流式输出可显著改善长回答的用户体验，用户无需等待完整生成即可开始阅读。</p></blockquote><hr><h2 id=第-4-章生产级rag系统>第 4 章：生产级RAG系统<a class=anchor href=#%e7%ac%ac-4-%e7%ab%a0%e7%94%9f%e4%ba%a7%e7%ba%a7rag%e7%b3%bb%e7%bb%9f>#</a></h2><h3 id=41-完整生产级实现>4.1 完整生产级实现<a class=anchor href=#41-%e5%ae%8c%e6%95%b4%e7%94%9f%e4%ba%a7%e7%ba%a7%e5%ae%9e%e7%8e%b0>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>生产级RAG系统 - 完整实现
</span></span></span><span class=line><span class=cl><span class=s2>包含：错误处理、日志、监控、配置管理
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>DirectoryLoader</span><span class=p>,</span> <span class=n>TextLoader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span><span class=p>,</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnablePassthrough</span><span class=p>,</span> <span class=n>RunnableParallel</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置日志</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionRAG</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生产级RAG系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data_dir</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>persist_dir</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;./chroma_db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>embedding_model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_overlap</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>data_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>persist_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span> <span class=o>=</span> <span class=n>chunk_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>chunk_overlap</span> <span class=o>=</span> <span class=n>chunk_overlap</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span> <span class=o>=</span> <span class=n>top_k</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化组件</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>embedding_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>llm_model</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ ProductionRAG初始化完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   - 数据目录: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   - 向量库: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   - Embedding模型: </span><span class=si>{</span><span class=n>embedding_model</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   - LLM模型: </span><span class=si>{</span><span class=n>llm_model</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>build_vectorstore</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>force_rebuild</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建或加载向量库&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>force_rebuild</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=o>.</span><span class=n>exists</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;📂 加载现有向量库...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>persist_directory</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>embedding_function</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✅ 向量库加载成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🔨 开始构建新向量库...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 加载文档</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;📄 步骤1: 加载文档...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>loader</span> <span class=o>=</span> <span class=n>DirectoryLoader</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>glob</span><span class=o>=</span><span class=s2>&#34;**/*.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>loader_cls</span><span class=o>=</span><span class=n>TextLoader</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>documents</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   ✅ 加载了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>documents</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;未在 </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>data_dir</span><span class=si>}</span><span class=s2> 中找到任何文档&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 分割文档</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✂️  步骤2: 分割文档...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>chunk_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>chunk_overlap</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>chunk_overlap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;。&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chunks</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;   ✅ 创建了 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> 个文本块&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 创建向量库</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;🗄️  步骤3: 创建向量库...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>documents</span><span class=o>=</span><span class=n>chunks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>embedding</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>persist_directory</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>persist_dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;   ✅ 向量库创建完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_rag_chain</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置RAG链&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;向量库未初始化，请先调用 build_vectorstore()&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建检索器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;similarity&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>top_k</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 创建Prompt模板</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>你是一个专业的AI助手。请基于以下上下文回答问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：
</span></span></span><span class=line><span class=cl><span class=si>{context}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 如果上下文中有相关信息，请详细回答
</span></span></span><span class=line><span class=cl><span class=s2>2. 如果上下文中没有相关信息，请明确说明&#34;根据提供的文档，我无法回答这个问题&#34;
</span></span></span><span class=line><span class=cl><span class=s2>3. 不要编造信息，只使用上下文中的内容
</span></span></span><span class=line><span class=cl><span class=s2>4. 如果可以，请引用具体的来源
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 格式化函数</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>format_docs</span><span class=p>(</span><span class=n>docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;[文档</span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>]</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 构建RAG链（带来源）</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span> <span class=o>=</span> <span class=n>RunnableParallel</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>|</span> <span class=n>format_docs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;source_documents&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>RunnablePassthrough</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>answer</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>prompt</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span>
</span></span><span class=line><span class=cl>                <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;context&#34;</span><span class=p>],</span> <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]})</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;✅ RAG链设置完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>show_sources</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>stream</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>setup_rag_chain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>❓ 问题: </span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stream</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 流式输出</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🤖 助手: &#34;</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>full_response</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span><span class=o>.</span><span class=n>stream</span><span class=p>(</span><span class=n>question</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=nb>dict</span><span class=p>)</span> <span class=ow>and</span> <span class=s2>&#34;answer&#34;</span> <span class=ow>in</span> <span class=n>chunk</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=n>chunk</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>],</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>flush</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>full_response</span> <span class=o>=</span> <span class=n>chunk</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>full_response</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 标准输出</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>💡 回答:</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>show_sources</span> <span class=ow>and</span> <span class=s2>&#34;source_documents&#34;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;📚 来源文档:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;source_documents&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>. </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;     元数据: </span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>batch_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>questions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量查询&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>setup_rag_chain</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;🔄 批量查询 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>questions</span><span class=p>)</span><span class=si>}</span><span class=s2> 个问题...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rag_chain</span><span class=o>.</span><span class=n>batch</span><span class=p>(</span><span class=n>questions</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>questions</span><span class=p>,</span> <span class=n>results</span><span class=p>),</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>问题 </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>q</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;回答: </span><span class=si>{</span><span class=n>r</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>][:</span><span class=mi>200</span><span class=p>]</span><span class=si>}</span><span class=s2>...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 初始化</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span> <span class=o>=</span> <span class=n>ProductionRAG</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>data_dir</span><span class=o>=</span><span class=s2>&#34;./data&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>persist_dir</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>embedding_model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>top_k</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构建向量库（首次运行或强制重建）</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>build_vectorstore</span><span class=p>(</span><span class=n>force_rebuild</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 单次查询</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;文档的主要内容是什么？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>show_sources</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 流式查询</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;详细解释关键技术&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>show_sources</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>stream</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 批量查询</span>
</span></span><span class=line><span class=cl>    <span class=n>questions</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;有哪些主要特点？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;如何快速上手？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;最佳实践是什么？&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>rag</span><span class=o>.</span><span class=n>batch_query</span><span class=p>(</span><span class=n>questions</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=42-性能优化指南>4.2 性能优化指南<a class=anchor href=#42-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e6%8c%87%e5%8d%97>#</a></h3><h5 id=421-分块优化>4.2.1 分块优化<a class=anchor href=#421-%e5%88%86%e5%9d%97%e4%bc%98%e5%8c%96>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 不佳的分块策略</span>
</span></span><span class=line><span class=cl><span class=n>bad_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>    <span class=c1># 太小，丢失上下文</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>0</span>    <span class=c1># 无重叠，可能切断语义</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 优化的分块策略</span>
</span></span><span class=line><span class=cl><span class=n>good_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>   <span class=c1># 适中大小</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span> <span class=c1># 20%重叠</span>
</span></span><span class=line><span class=cl>    <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;。&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>  <span class=c1># 优先在自然边界分割</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 针对中文的优化</span>
</span></span><span class=line><span class=cl><span class=n>chinese_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>500</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;。&#34;</span><span class=p>,</span> <span class=s2>&#34;！&#34;</span><span class=p>,</span> <span class=s2>&#34;？&#34;</span><span class=p>,</span> <span class=s2>&#34;；&#34;</span><span class=p>,</span> <span class=s2>&#34;.&#34;</span><span class=p>,</span> <span class=s2>&#34;!&#34;</span><span class=p>,</span> <span class=s2>&#34;?&#34;</span><span class=p>,</span> <span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h5 id=422-embedding优化>4.2.2 Embedding优化<a class=anchor href=#422-embedding%e4%bc%98%e5%8c%96>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 批量处理（节省时间和成本）</span>
</span></span><span class=line><span class=cl><span class=n>batch_size</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>chunks</span><span class=p>),</span> <span class=n>batch_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>batch</span> <span class=o>=</span> <span class=n>chunks</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>batch_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>vectorstore</span><span class=o>.</span><span class=n>add_documents</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 使用合适的模型</span>
</span></span><span class=line><span class=cl><span class=c1># 开发/测试阶段</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-small&#34;</span><span class=p>)</span>  <span class=c1># 快速、便宜</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生产环境</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>)</span>  <span class=c1># 高质量</span></span></span></code></pre></div><h5 id=423-检索优化>4.2.3 检索优化<a class=anchor href=#423-%e6%a3%80%e7%b4%a2%e4%bc%98%e5%8c%96>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 调整Top-K（通过评估找到最佳值）</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>}</span>  <span class=c1># 实验3-10之间的值</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 使用MMR增加多样性</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;mmr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;fetch_k&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>,</span>      <span class=c1># 从20个候选中选择5个</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda_mult&#34;</span><span class=p>:</span> <span class=mf>0.5</span>  <span class=c1># 平衡相关性和多样性</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 设置相似度阈值（过滤低质量结果）</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;similarity_score_threshold&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score_threshold&#34;</span><span class=p>:</span> <span class=mf>0.7</span><span class=p>,</span>  <span class=c1># 只返回&gt;0.7的结果</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h5 id=424-prompt优化>4.2.4 Prompt优化<a class=anchor href=#424-prompt%e4%bc%98%e5%8c%96>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 优化的Prompt模板</span>
</span></span><span class=line><span class=cl><span class=n>optimized_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>你是一个专业的AI助手。请严格基于以下上下文回答问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：
</span></span></span><span class=line><span class=cl><span class=si>{context}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答指南：
</span></span></span><span class=line><span class=cl><span class=s2>1. **有答案时**：基于上下文给出详细、准确的回答
</span></span></span><span class=line><span class=cl><span class=s2>2. **无答案时**：明确说明&#34;根据提供的文档，我无法回答这个问题&#34;
</span></span></span><span class=line><span class=cl><span class=s2>3. **部分答案时**：说明哪些部分有依据，哪些部分不确定
</span></span></span><span class=line><span class=cl><span class=s2>4. **引用来源**：如果可以，标注信息来自哪个文档片段
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>注意事项：
</span></span></span><span class=line><span class=cl><span class=s2>- 不要编造信息
</span></span></span><span class=line><span class=cl><span class=s2>- 不要使用上下文之外的知识
</span></span></span><span class=line><span class=cl><span class=s2>- 如有不确定，明确说明
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=43-langsmith监控与追踪>4.3 LangSmith监控与追踪<a class=anchor href=#43-langsmith%e7%9b%91%e6%8e%a7%e4%b8%8e%e8%bf%bd%e8%b8%aa>#</a></h3><h5 id=431-启用langsmith>4.3.1 启用LangSmith<a class=anchor href=#431-%e5%90%af%e7%94%a8langsmith>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置环境变量</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;your-langsmith-key&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TRACING&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_PROJECT&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;rag-production&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或在代码中设置</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>getpass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TRACING&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getpass</span><span class=p>(</span><span class=s2>&#34;LangSmith API Key: &#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=432-使用langsmith>4.3.2 使用LangSmith<a class=anchor href=#432-%e4%bd%bf%e7%94%a8langsmith>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 正常使用RAG（自动追踪）</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># LangSmith Dashboard会自动记录：</span>
</span></span><span class=line><span class=cl><span class=c1># - 完整的调用trace</span>
</span></span><span class=line><span class=cl><span class=c1># - 每个组件的输入/输出</span>
</span></span><span class=line><span class=cl><span class=c1># - Token使用量</span>
</span></span><span class=line><span class=cl><span class=c1># - 延迟时间</span>
</span></span><span class=line><span class=cl><span class=c1># - 成本估算</span>
</span></span><span class=line><span class=cl><span class=c1># - 错误日志</span></span></span></code></pre></div><h4 id=433-自定义追踪>4.3.3 自定义追踪<a class=anchor href=#433-%e8%87%aa%e5%ae%9a%e4%b9%89%e8%bf%bd%e8%b8%aa>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>traceable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;chain&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;custom_rag_chain&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;production&#34;</span><span class=p>,</span> <span class=s2>&#34;rag&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>custom_rag</span><span class=p>(</span><span class=n>question</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自定义RAG函数（带追踪）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>question</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用会自动追踪</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>custom_rag</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-5-章高级rag技术>第 5 章：高级RAG技术<a class=anchor href=#%e7%ac%ac-5-%e7%ab%a0%e9%ab%98%e7%ba%a7rag%e6%8a%80%e6%9c%af>#</a></h2><h3 id=51-元数据过滤>5.1 元数据过滤<a class=anchor href=#51-%e5%85%83%e6%95%b0%e6%8d%ae%e8%bf%87%e6%bb%a4>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加带元数据的文档</span>
</span></span><span class=line><span class=cl><span class=n>documents_with_metadata</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>Document</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>page_content</span><span class=o>=</span><span class=s2>&#34;Python是一种高级编程语言&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;编程&#34;</span><span class=p>,</span> <span class=s2>&#34;level&#34;</span><span class=p>:</span> <span class=s2>&#34;入门&#34;</span><span class=p>,</span> <span class=s2>&#34;language&#34;</span><span class=p>:</span> <span class=s2>&#34;Python&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>Document</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>page_content</span><span class=o>=</span><span class=s2>&#34;机器学习是AI的核心技术&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;AI&#34;</span><span class=p>,</span> <span class=s2>&#34;level&#34;</span><span class=p>:</span> <span class=s2>&#34;高级&#34;</span><span class=p>,</span> <span class=s2>&#34;language&#34;</span><span class=p>:</span> <span class=s2>&#34;通用&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span><span class=o>.</span><span class=n>add_documents</span><span class=p>(</span><span class=n>documents_with_metadata</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建带过滤的检索器</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_filtered_retriever</span><span class=p>(</span><span class=n>category</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建带元数据过滤的检索器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>category</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 只检索特定类别的文档</span>
</span></span><span class=line><span class=cl>        <span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;filter&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=n>category</span><span class=p>}</span>  <span class=c1># 元数据过滤</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>retriever</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>retriever_ai</span> <span class=o>=</span> <span class=n>create_filtered_retriever</span><span class=p>(</span><span class=n>category</span><span class=o>=</span><span class=s2>&#34;AI&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>retriever_ai</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是机器学习？&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=52-多查询检索multi-query-retrieval>5.2 多查询检索（Multi-Query Retrieval）<a class=anchor href=#52-%e5%a4%9a%e6%9f%a5%e8%af%a2%e6%a3%80%e7%b4%a2multi-query-retrieval>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers.multi_query</span> <span class=kn>import</span> <span class=n>MultiQueryRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建多查询检索器（自动生成多个查询角度）</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>multi_query_retriever</span> <span class=o>=</span> <span class=n>MultiQueryRetriever</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retriever</span><span class=o>=</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>llm</span><span class=o>=</span><span class=n>llm</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 单个查询会被扩展为多个查询</span>
</span></span><span class=line><span class=cl><span class=c1># 例如：&#34;什么是RAG？&#34; 可能扩展为：</span>
</span></span><span class=line><span class=cl><span class=c1># - &#34;RAG的定义是什么？&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># - &#34;检索增强生成如何工作？&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># - &#34;RAG的应用场景有哪些？&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>docs</span> <span class=o>=</span> <span class=n>multi_query_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=53-上下文压缩contextual-compression>5.3 上下文压缩（Contextual Compression）<a class=anchor href=#53-%e4%b8%8a%e4%b8%8b%e6%96%87%e5%8e%8b%e7%bc%a9contextual-compression>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.retrievers</span> <span class=kn>import</span> <span class=n>ContextualCompressionRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers.document_compressors</span> <span class=kn>import</span> <span class=n>LLMChainExtractor</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建压缩器（提取最相关的片段）</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>compressor</span> <span class=o>=</span> <span class=n>LLMChainExtractor</span><span class=o>.</span><span class=n>from_llm</span><span class=p>(</span><span class=n>llm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建压缩检索器</span>
</span></span><span class=line><span class=cl><span class=n>compression_retriever</span> <span class=o>=</span> <span class=n>ContextualCompressionRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>base_compressor</span><span class=o>=</span><span class=n>compressor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>base_retriever</span><span class=o>=</span><span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span><span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用（会压缩检索到的文档，只保留相关片段）</span>
</span></span><span class=line><span class=cl><span class=n>compressed_docs</span> <span class=o>=</span> <span class=n>compression_retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;什么是RAG？&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h2 id=第-6-章评估与优化>第 6 章：评估与优化<a class=anchor href=#%e7%ac%ac-6-%e7%ab%a0%e8%af%84%e4%bc%b0%e4%b8%8e%e4%bc%98%e5%8c%96>#</a></h2><h3 id=61-评估指标>6.1 评估指标<a class=anchor href=#61-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87>#</a></h3><h5 id=611-检索质量评估>6.1.1 检索质量评估<a class=anchor href=#611-%e6%a3%80%e7%b4%a2%e8%b4%a8%e9%87%8f%e8%af%84%e4%bc%b0>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>evaluate_retrieval</span><span class=p>(</span><span class=n>retriever</span><span class=p>,</span> <span class=n>test_cases</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;评估检索质量
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    test_cases: [
</span></span></span><span class=line><span class=cl><span class=s2>        {&#34;query&#34;: &#34;问题&#34;, &#34;relevant_doc_ids&#34;: [&#34;doc1&#34;, &#34;doc2&#34;]},
</span></span></span><span class=line><span class=cl><span class=s2>        ...
</span></span></span><span class=line><span class=cl><span class=s2>    ]
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>total_precision</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>total_recall</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>case</span> <span class=ow>in</span> <span class=n>test_cases</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=k>case</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_ids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=k>case</span><span class=p>[</span><span class=s2>&#34;relevant_doc_ids&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检索</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>retrieved_ids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;id&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>retrieved_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算指标</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_retrieved</span> <span class=o>=</span> <span class=n>retrieved_ids</span> <span class=o>&amp;</span> <span class=n>relevant_ids</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>precision</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>relevant_retrieved</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>retrieved_ids</span><span class=p>)</span> <span class=k>if</span> <span class=n>retrieved_ids</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=n>recall</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>relevant_retrieved</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>relevant_ids</span><span class=p>)</span> <span class=k>if</span> <span class=n>relevant_ids</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>total_precision</span> <span class=o>+=</span> <span class=n>precision</span>
</span></span><span class=line><span class=cl>        <span class=n>total_recall</span> <span class=o>+=</span> <span class=n>recall</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>avg_precision</span> <span class=o>=</span> <span class=n>total_precision</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>test_cases</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>avg_recall</span> <span class=o>=</span> <span class=n>total_recall</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>test_cases</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;precision&#34;</span><span class=p>:</span> <span class=n>avg_precision</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;recall&#34;</span><span class=p>:</span> <span class=n>avg_recall</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;f1&#34;</span><span class=p>:</span> <span class=mi>2</span> <span class=o>*</span> <span class=p>(</span><span class=n>avg_precision</span> <span class=o>*</span> <span class=n>avg_recall</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>avg_precision</span> <span class=o>+</span> <span class=n>avg_recall</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>test_cases</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是RAG？&#34;</span><span class=p>,</span> <span class=s2>&#34;relevant_doc_ids&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;doc1&#34;</span><span class=p>,</span> <span class=s2>&#34;doc2&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;如何优化检索？&#34;</span><span class=p>,</span> <span class=s2>&#34;relevant_doc_ids&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;doc3&#34;</span><span class=p>,</span> <span class=s2>&#34;doc4&#34;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>metrics</span> <span class=o>=</span> <span class=n>evaluate_retrieval</span><span class=p>(</span><span class=n>retriever</span><span class=p>,</span> <span class=n>test_cases</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Precision: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;precision&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Recall: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;recall&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;F1: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;f1&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h5 id=612-端到端rag评估使用langsmith>6.1.2 端到端RAG评估（使用LangSmith）<a class=anchor href=#612-%e7%ab%af%e5%88%b0%e7%ab%afrag%e8%af%84%e4%bc%b0%e4%bd%bf%e7%94%a8langsmith>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 准备测试数据集</span>
</span></span><span class=line><span class=cl><span class=n>test_dataset</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是RAG？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expected_answer&#34;</span><span class=p>:</span> <span class=s2>&#34;RAG是检索增强生成技术...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;如何优化检索？&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expected_answer&#34;</span><span class=p>:</span> <span class=s2>&#34;可以通过调整chunk_size...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 定义评估函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rag_evaluator</span><span class=p>(</span><span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>outputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>reference</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自定义评估函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里可以使用LLM作为评判</span>
</span></span><span class=line><span class=cl>    <span class=c1># 或者使用BLEU、ROUGE等指标</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 运行评估</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>test_dataset</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>rag_evaluator</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;rag-v1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h3 id=62-常见问题与解决方案>6.2 常见问题与解决方案<a class=anchor href=#62-%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e4%b8%8e%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88>#</a></h3><h5 id=621-检索不到相关文档>6.2.1 检索不到相关文档<a class=anchor href=#621-%e6%a3%80%e7%b4%a2%e4%b8%8d%e5%88%b0%e7%9b%b8%e5%85%b3%e6%96%87%e6%a1%a3>#</a></h5><p><strong>原因</strong>：</p><ul><li>文档分块不合理</li><li>Embedding模型不匹配</li><li>Top-K设置过小</li></ul><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 优化分块策略</span>
</span></span><span class=line><span class=cl><span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1500</span><span class=p>,</span>    <span class=c1># 增大块大小</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>300</span>   <span class=c1># 增加重叠</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 调整Top-K</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>}</span>  <span class=c1># 增加候选数量</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 使用MMR增加多样性</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;mmr&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s2>&#34;fetch_k&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h5 id=622-生成的答案不准确>6.2.2 生成的答案不准确<a class=anchor href=#622-%e7%94%9f%e6%88%90%e7%9a%84%e7%ad%94%e6%a1%88%e4%b8%8d%e5%87%86%e7%a1%ae>#</a></h5><p><strong>原因</strong>：</p><ul><li>Prompt不够清晰</li><li>LLM温度设置过高</li><li>检索到的上下文不相关</li></ul><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 优化Prompt</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>严格基于以下上下文回答问题。如果上下文中没有相关信息，请明确说明无法回答。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：
</span></span></span><span class=line><span class=cl><span class=si>{context}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答：
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 设置温度为0（确定性输出）</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 使用相似度阈值过滤</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_type</span><span class=o>=</span><span class=s2>&#34;similarity_score_threshold&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;score_threshold&#34;</span><span class=p>:</span> <span class=mf>0.7</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h5 id=623-响应延迟高>6.2.3 响应延迟高<a class=anchor href=#623-%e5%93%8d%e5%ba%94%e5%bb%b6%e8%bf%9f%e9%ab%98>#</a></h5><p><strong>原因</strong>：</p><ul><li>检索Top-K过大</li><li>LLM模型过大</li><li>未使用流式输出</li></ul><p><strong>解决方案</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 减少Top-K</span>
</span></span><span class=line><span class=cl><span class=n>retriever</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>  <span class=c1># 减少检索数量</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 使用更快的模型</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>  <span class=c1># 更快</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 启用流式输出</span>
</span></span><span class=line><span class=cl><span class=n>llm</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>streaming</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 使用2-Step RAG而非Agent RAG</span>
</span></span><span class=line><span class=cl><span class=c1># 2-Step RAG只需1次LLM调用，Agent RAG需要2次</span></span></span></code></pre></div><hr><h2 id=全文总结>全文总结<a class=anchor href=#%e5%85%a8%e6%96%87%e6%80%bb%e7%bb%93>#</a></h2><h3 id=核心要点回顾>核心要点回顾<a class=anchor href=#%e6%a0%b8%e5%bf%83%e8%a6%81%e7%82%b9%e5%9b%9e%e9%a1%be>#</a></h3><h5 id=第1章rag架构>第1章：RAG架构<a class=anchor href=#%e7%ac%ac1%e7%ab%a0rag%e6%9e%b6%e6%9e%84>#</a></h5><ul><li>✅ RAG解决LLM的上下文限制和知识陈旧问题</li><li>✅ 完整流程：索引（Load → Split → Embed → Store）→ 检索 → 生成</li><li>✅ 两种模式：Agent RAG（灵活）vs 2-Step RAG（快速）</li></ul><h5 id=第2章索引流程>第2章：索引流程<a class=anchor href=#%e7%ac%ac2%e7%ab%a0%e7%b4%a2%e5%bc%95%e6%b5%81%e7%a8%8b>#</a></h5><ul><li>✅ 文档加载：支持PDF、网页、CSV等多种格式</li><li>✅ 文本分割：RecursiveCharacterTextSplitter（推荐）</li><li>✅ 向量化：OpenAI Embeddings（text-embedding-3-large）</li><li>✅ 向量存储：Chroma（开发）、Pinecone（生产）</li></ul><h5 id=第3章检索与生成>第3章：检索与生成<a class=anchor href=#%e7%ac%ac3%e7%ab%a0%e6%a3%80%e7%b4%a2%e4%b8%8e%e7%94%9f%e6%88%90>#</a></h5><ul><li>✅ LCEL语法：使用管道（<code>|</code>）串联组件</li><li>✅ 标准RAG链：<code>retriever | prompt | llm | parser</code></li><li>✅ 流式输出：提升用户体验</li></ul><h5 id=第4章生产级系统>第4章：生产级系统<a class=anchor href=#%e7%ac%ac4%e7%ab%a0%e7%94%9f%e4%ba%a7%e7%ba%a7%e7%b3%bb%e7%bb%9f>#</a></h5><ul><li>✅ 完整实现：错误处理、日志、配置管理</li><li>✅ 性能优化：分块、Embedding、检索、Prompt</li><li>✅ LangSmith监控：追踪、调试、评估</li></ul><h5 id=第5章高级技术>第5章：高级技术<a class=anchor href=#%e7%ac%ac5%e7%ab%a0%e9%ab%98%e7%ba%a7%e6%8a%80%e6%9c%af>#</a></h5><ul><li>✅ 元数据过滤：精准检索</li><li>✅ 多查询检索：扩展查询角度</li><li>✅ 上下文压缩：提取相关片段</li></ul><h5 id=第6章评估与优化>第6章：评估与优化<a class=anchor href=#%e7%ac%ac6%e7%ab%a0%e8%af%84%e4%bc%b0%e4%b8%8e%e4%bc%98%e5%8c%96>#</a></h5><ul><li>✅ 检索评估：Precision、Recall、F1</li><li>✅ 端到端评估：使用LangSmith</li><li>✅ 常见问题：检索不准、答案错误、延迟高</li></ul><hr><h3 id=最佳实践清单>最佳实践清单<a class=anchor href=#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5%e6%b8%85%e5%8d%95>#</a></h3><h5 id=开发阶段>开发阶段<a class=anchor href=#%e5%bc%80%e5%8f%91%e9%98%b6%e6%ae%b5>#</a></h5><ul><li><input disabled type=checkbox> 使用InMemoryVectorStore或Chroma快速原型</li><li><input disabled type=checkbox> 使用text-embedding-3-small降低成本</li><li><input disabled type=checkbox> 设置<code>chunk_size=500-1000</code>，<code>chunk_overlap=100-200</code></li><li><input disabled type=checkbox> 使用gpt-4o-mini进行测试</li></ul><h5 id=生产阶段>生产阶段<a class=anchor href=#%e7%94%9f%e4%ba%a7%e9%98%b6%e6%ae%b5>#</a></h5><ul><li><input disabled type=checkbox> 切换到持久化向量库（Chroma、Qdrant、Pinecone）</li><li><input disabled type=checkbox> 使用text-embedding-3-large提升质量</li><li><input disabled type=checkbox> 启用LangSmith追踪和监控</li><li><input disabled type=checkbox> 实现流式输出改善用户体验</li><li><input disabled type=checkbox> 添加元数据过滤和错误处理</li><li><input disabled type=checkbox> 设置合理的Top-K（通常3-10）</li><li><input disabled type=checkbox> 使用MMR增加检索多样性</li></ul><h5 id=优化阶段>优化阶段<a class=anchor href=#%e4%bc%98%e5%8c%96%e9%98%b6%e6%ae%b5>#</a></h5><ul><li><input disabled type=checkbox> 评估检索质量（Precision、Recall）</li><li><input disabled type=checkbox> 调整分块策略（通过实验找到最佳值）</li><li><input disabled type=checkbox> 优化Prompt模板</li><li><input disabled type=checkbox> 使用上下文压缩减少Token消耗</li><li><input disabled type=checkbox> A/B测试不同配置</li></ul><hr><h3 id=参考资源>参考资源<a class=anchor href=#%e5%8f%82%e8%80%83%e8%b5%84%e6%ba%90>#</a></h3><h5 id=官方文档>官方文档<a class=anchor href=#%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3>#</a></h5><ul><li><a href=https://docs.langchain.com/oss/python/langchain/>LangChain Python文档</a></li><li><a href=https://docs.langchain.com/oss/python/langchain/rag>RAG教程</a></li><li><a href=https://docs.langchain.com/oss/python/langchain/knowledge-base>Semantic Search教程</a></li><li><a href=https://docs.langchain.com/langsmith/>LangSmith文档</a></li></ul><h5 id=api参考>API参考<a class=anchor href=#api%e5%8f%82%e8%80%83>#</a></h5><ul><li><a href=https://python.langchain.com/api_reference/>LangChain Python API</a></li><li><a href=https://python.langchain.com/api_reference/core/>langchain-core</a></li><li><a href=https://python.langchain.com/api_reference/openai/>langchain-openai</a></li><li><a href=https://python.langchain.com/api_reference/chroma/>langchain-chroma</a></li></ul><h5 id=社区资源>社区资源<a class=anchor href=#%e7%a4%be%e5%8c%ba%e8%b5%84%e6%ba%90>#</a></h5><ul><li><a href=https://github.com/langchain-ai/langchain>LangChain GitHub</a></li><li><a href=https://discord.gg/langchain>LangChain Discord</a></li></ul></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第三篇 LangGraph 深入</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/ class="flex align-center"><span>第四篇 RAG基础篇(LlamaIndex篇)</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#-前置准备>📋 前置准备</a><ul><li><a href=#环境配置>环境配置</a></li><li><a href=#环境变量设置>环境变量设置</a></li></ul></li><li><a href=#第-1-章rag架构与核心概念>第 1 章：RAG架构与核心概念</a><ul><li><ul><li><a href=#11-什么是rag>1.1 什么是RAG？</a><ul><li><a href=#111-为什么需要rag>1.1.1 为什么需要RAG？</a></li><li><a href=#112-rag完整架构>1.1.2 RAG完整架构</a></li><li><a href=#113-rag工作流程>1.1.3 RAG工作流程</a></li></ul></li><li><a href=#12-langchain-rag的优势>1.2 LangChain RAG的优势</a></li><li><a href=#13-两种rag实现模式>1.3 两种RAG实现模式</a><ul><li><a href=#131-rag-agent智能灵活>1.3.1 RAG Agent（智能灵活）</a></li><li><a href=#132-2-step-rag-chain快速简洁>1.3.2 2-Step RAG Chain（快速简洁）</a></li></ul></li></ul></li></ul></li><li><a href=#第-2-章索引流程---从文档到向量库>第 2 章：索引流程 - 从文档到向量库</a><ul><li><a href=#21-文档加载document-loaders>2.1 文档加载（Document Loaders）</a><ul><li><ul><li><a href=#211-基础加载器>2.1.1 基础加载器</a></li><li><a href=#212-常用加载器>2.1.2 常用加载器</a></li></ul></li></ul></li><li><a href=#22-文本分割text-splitters>2.2 文本分割（Text Splitters）</a><ul><li><ul><li><a href=#221-为什么需要分割>2.2.1 为什么需要分割？</a></li><li><a href=#222-recursivecharactertextsplitter推荐>2.2.2 RecursiveCharacterTextSplitter（推荐）</a></li><li><a href=#223-不同场景的分块策略>2.2.3 不同场景的分块策略</a></li></ul></li></ul></li><li><a href=#23-向量化embeddings>2.3 向量化（Embeddings）</a><ul><li><ul><li><a href=#231-openai-embeddings推荐>2.3.1 OpenAI Embeddings（推荐）</a></li><li><a href=#232-模型选择指南>2.3.2 模型选择指南</a></li></ul></li></ul></li><li><a href=#24-向量存储vector-stores>2.4 向量存储（Vector Stores）</a><ul><li><ul><li><a href=#241-chroma本地开发推荐>2.4.1 Chroma（本地开发推荐）</a></li><li><a href=#242-inmemoryvectorstore快速原型>2.4.2 InMemoryVectorStore（快速原型）</a></li><li><a href=#243-向量数据库选择指南>2.4.3 向量数据库选择指南</a></li></ul></li></ul></li><li><a href=#25-检索器retrievers>2.5 检索器（Retrievers）</a><ul><li><ul><li><a href=#251-基础检索器>2.5.1 基础检索器</a></li></ul></li></ul></li></ul></li><li><a href=#第-3-章检索与生成---构建rag链>第 3 章：检索与生成 - 构建RAG链</a><ul><li><a href=#31-标准rag-chainlcel>3.1 标准RAG Chain（LCEL）</a><ul><li><ul><li><a href=#311-完整实现>3.1.1 完整实现</a></li><li><a href=#312-lcel语法详解>3.1.2 LCEL语法详解</a></li></ul></li></ul></li><li><a href=#32-带来源的rag-chain>3.2 带来源的RAG Chain</a><ul><li><ul><li><a href=#321-返回检索文档>3.2.1 返回检索文档</a></li><li><a href=#322-增强格式化函数>3.2.2 增强格式化函数</a></li></ul></li></ul></li><li><a href=#33-流式rag-chain>3.3 流式RAG Chain</a><ul><li><ul><li><a href=#331-实现流式输出>3.3.1 实现流式输出</a></li><li><a href=#332-流式输出的优势>3.3.2 流式输出的优势</a></li></ul></li></ul></li></ul></li><li><a href=#第-4-章生产级rag系统>第 4 章：生产级RAG系统</a><ul><li><a href=#41-完整生产级实现>4.1 完整生产级实现</a></li><li><a href=#42-性能优化指南>4.2 性能优化指南</a><ul><li><ul><li><a href=#421-分块优化>4.2.1 分块优化</a></li><li><a href=#422-embedding优化>4.2.2 Embedding优化</a></li><li><a href=#423-检索优化>4.2.3 检索优化</a></li><li><a href=#424-prompt优化>4.2.4 Prompt优化</a></li></ul></li></ul></li><li><a href=#43-langsmith监控与追踪>4.3 LangSmith监控与追踪</a><ul><li><ul><li><a href=#431-启用langsmith>4.3.1 启用LangSmith</a></li><li><a href=#432-使用langsmith>4.3.2 使用LangSmith</a></li></ul></li><li><a href=#433-自定义追踪>4.3.3 自定义追踪</a></li></ul></li></ul></li><li><a href=#第-5-章高级rag技术>第 5 章：高级RAG技术</a><ul><li><a href=#51-元数据过滤>5.1 元数据过滤</a></li><li><a href=#52-多查询检索multi-query-retrieval>5.2 多查询检索（Multi-Query Retrieval）</a></li><li><a href=#53-上下文压缩contextual-compression>5.3 上下文压缩（Contextual Compression）</a></li></ul></li><li><a href=#第-6-章评估与优化>第 6 章：评估与优化</a><ul><li><a href=#61-评估指标>6.1 评估指标</a><ul><li><ul><li><a href=#611-检索质量评估>6.1.1 检索质量评估</a></li><li><a href=#612-端到端rag评估使用langsmith>6.1.2 端到端RAG评估（使用LangSmith）</a></li></ul></li></ul></li><li><a href=#62-常见问题与解决方案>6.2 常见问题与解决方案</a><ul><li><ul><li><a href=#621-检索不到相关文档>6.2.1 检索不到相关文档</a></li><li><a href=#622-生成的答案不准确>6.2.2 生成的答案不准确</a></li><li><a href=#623-响应延迟高>6.2.3 响应延迟高</a></li></ul></li></ul></li></ul></li><li><a href=#全文总结>全文总结</a><ul><li><a href=#核心要点回顾>核心要点回顾</a><ul><li><ul><li><a href=#第1章rag架构>第1章：RAG架构</a></li><li><a href=#第2章索引流程>第2章：索引流程</a></li><li><a href=#第3章检索与生成>第3章：检索与生成</a></li><li><a href=#第4章生产级系统>第4章：生产级系统</a></li><li><a href=#第5章高级技术>第5章：高级技术</a></li><li><a href=#第6章评估与优化>第6章：评估与优化</a></li></ul></li></ul></li><li><a href=#最佳实践清单>最佳实践清单</a><ul><li><ul><li><a href=#开发阶段>开发阶段</a></li><li><a href=#生产阶段>生产阶段</a></li><li><a href=#优化阶段>优化阶段</a></li></ul></li></ul></li><li><a href=#参考资源>参考资源</a><ul><li><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#api参考>API参考</a></li><li><a href=#社区资源>社区资源</a></li></ul></li></ul></li></ul></li></ul></nav></div></aside></main></body></html>