<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜# ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜# æœ¬ç¯‡å°†ä½¿ç”¨ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚éœ€æ·±å…¥ç†è§£è¯·å‚è€ƒç›¸å…³ç« èŠ‚ï¼š
StateGraph: LangGraphçš„çŠ¶æ€å›¾ï¼Œç”¨äºç¼–æ’å¤æ‚æµç¨‹ â†’ æœ¬ç¯‡ä»…ä½¿ç”¨åŸºç¡€åŠŸèƒ½ï¼Œé«˜çº§ç”¨æ³•è¯¦è§ç¬¬ä¸‰ç¯‡ç¬¬7ç«  Runnable Protocol: ç»Ÿä¸€æ‰§è¡Œæ¥å£ï¼ˆinvoke/stream/batchï¼‰ â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2ç« è®²è§£ LCELè¯­æ³•: ç®¡é“æ“ä½œç¬¦|å’Œå¹¶è¡Œ{} â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2.2èŠ‚è®²è§£ ğŸ’¡ å­¦ä¹ å»ºè®®: åˆå­¦è€…å¯ä»¥å…ˆè·Ÿç€æœ¬ç¯‡ä»£ç å®è·µï¼Œé‡åˆ°ä¸ç†è§£çš„æ¦‚å¿µå†å›çœ‹ç›¸å…³ç« èŠ‚ã€‚
ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€# 1.1 Message æ¶ˆæ¯ç³»ç»Ÿ# 1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage# LangChain 1.0 å¼•å…¥äº†ç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹ç³»ç»Ÿï¼Œç”¨äºè¡¨ç¤ºäººæœºå¯¹è¯ä¸­çš„ä¸åŒè§’è‰²å’Œå†…å®¹ã€‚
æ ¸å¿ƒæ¶ˆæ¯ç±»å‹
graph TD A[BaseMessage] --> B[HumanMessage] A --> C[AIMessage] A --> D[SystemMessage] A --> E[ToolMessage] A --> F[FunctionMessage] style A fill:#E3F2FD style B fill:#C8E6C9 style C fill:#FFF9C4 style D fill:#FFCCBC style E fill:#E1BEE7 style F fill:#B2DFDB1. HumanMessage - ç”¨æˆ·æ¶ˆæ¯
"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/"><meta property="og:site_name" content="LordFoxFairyçš„ç¬”è®°æœ¬"><meta property="og:title" content="ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜"><meta property="og:description" content="ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜# ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜# æœ¬ç¯‡å°†ä½¿ç”¨ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚éœ€æ·±å…¥ç†è§£è¯·å‚è€ƒç›¸å…³ç« èŠ‚ï¼š
StateGraph: LangGraphçš„çŠ¶æ€å›¾ï¼Œç”¨äºç¼–æ’å¤æ‚æµç¨‹ â†’ æœ¬ç¯‡ä»…ä½¿ç”¨åŸºç¡€åŠŸèƒ½ï¼Œé«˜çº§ç”¨æ³•è¯¦è§ç¬¬ä¸‰ç¯‡ç¬¬7ç«  Runnable Protocol: ç»Ÿä¸€æ‰§è¡Œæ¥å£ï¼ˆinvoke/stream/batchï¼‰ â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2ç« è®²è§£ LCELè¯­æ³•: ç®¡é“æ“ä½œç¬¦|å’Œå¹¶è¡Œ{} â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2.2èŠ‚è®²è§£ ğŸ’¡ å­¦ä¹ å»ºè®®: åˆå­¦è€…å¯ä»¥å…ˆè·Ÿç€æœ¬ç¯‡ä»£ç å®è·µï¼Œé‡åˆ°ä¸ç†è§£çš„æ¦‚å¿µå†å›çœ‹ç›¸å…³ç« èŠ‚ã€‚
ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€# 1.1 Message æ¶ˆæ¯ç³»ç»Ÿ# 1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage# LangChain 1.0 å¼•å…¥äº†ç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹ç³»ç»Ÿï¼Œç”¨äºè¡¨ç¤ºäººæœºå¯¹è¯ä¸­çš„ä¸åŒè§’è‰²å’Œå†…å®¹ã€‚
æ ¸å¿ƒæ¶ˆæ¯ç±»å‹
graph TD A[BaseMessage] --> B[HumanMessage] A --> C[AIMessage] A --> D[SystemMessage] A --> E[ToolMessage] A --> F[FunctionMessage] style A fill:#E3F2FD style B fill:#C8E6C9 style C fill:#FFF9C4 style D fill:#FFCCBC style E fill:#E1BEE7 style F fill:#B2DFDB1. HumanMessage - ç”¨æˆ·æ¶ˆæ¯"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜"><meta itemprop=description content="ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜# ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜# æœ¬ç¯‡å°†ä½¿ç”¨ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚éœ€æ·±å…¥ç†è§£è¯·å‚è€ƒç›¸å…³ç« èŠ‚ï¼š
StateGraph: LangGraphçš„çŠ¶æ€å›¾ï¼Œç”¨äºç¼–æ’å¤æ‚æµç¨‹ â†’ æœ¬ç¯‡ä»…ä½¿ç”¨åŸºç¡€åŠŸèƒ½ï¼Œé«˜çº§ç”¨æ³•è¯¦è§ç¬¬ä¸‰ç¯‡ç¬¬7ç«  Runnable Protocol: ç»Ÿä¸€æ‰§è¡Œæ¥å£ï¼ˆinvoke/stream/batchï¼‰ â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2ç« è®²è§£ LCELè¯­æ³•: ç®¡é“æ“ä½œç¬¦|å’Œå¹¶è¡Œ{} â†’ å·²åœ¨ç¬¬ä¸€ç¯‡ç¬¬2.2èŠ‚è®²è§£ ğŸ’¡ å­¦ä¹ å»ºè®®: åˆå­¦è€…å¯ä»¥å…ˆè·Ÿç€æœ¬ç¯‡ä»£ç å®è·µï¼Œé‡åˆ°ä¸ç†è§£çš„æ¦‚å¿µå†å›çœ‹ç›¸å…³ç« èŠ‚ã€‚
ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€# 1.1 Message æ¶ˆæ¯ç³»ç»Ÿ# 1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage# LangChain 1.0 å¼•å…¥äº†ç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹ç³»ç»Ÿï¼Œç”¨äºè¡¨ç¤ºäººæœºå¯¹è¯ä¸­çš„ä¸åŒè§’è‰²å’Œå†…å®¹ã€‚
æ ¸å¿ƒæ¶ˆæ¯ç±»å‹
graph TD A[BaseMessage] --> B[HumanMessage] A --> C[AIMessage] A --> D[SystemMessage] A --> E[ToolMessage] A --> F[FunctionMessage] style A fill:#E3F2FD style B fill:#C8E6C9 style C fill:#FFF9C4 style D fill:#FFCCBC style E fill:#E1BEE7 style F fill:#B2DFDB1. HumanMessage - ç”¨æˆ·æ¶ˆæ¯"><meta itemprop=wordCount content="6377"><title>ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜ | LordFoxFairyçš„ç¬”è®°æœ¬</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairyçš„ç¬”è®°æœ¬</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChainç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>ç¬¬ä¸€ç¯‡ åŸºç¡€è®¤çŸ¥</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/ class=active>ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>ç¬¬ä¸‰ç¯‡ LangGraph æ·±å…¥</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>ç¬¬å››ç¯‡ RAGåŸºç¡€ç¯‡(LangChainç¯‡)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>ç¬¬å››ç¯‡ RAGåŸºç¡€ç¯‡(LlamaIndexç¯‡)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>ç¬¬äº”ç¯‡ RAGé«˜çº§ç¯‡(LangChainç¯‡)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>ç¬¬äº”ç¯‡ RAGé«˜çº§ç¯‡(LlamaIndexç¯‡)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>ç¬¬å…­ç¯‡ æ–‡æ¡£å¤„ç†ä¸æ•°æ®æ¸…æ´—</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>ç¬¬ä¸ƒç¯‡ Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>ç¬¬å…«ç¯‡ Middleware å·¥ç¨‹åŒ–</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>ç¬¬ä¹ç¯‡ Agent æ¶æ„è®¾è®¡</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>ç¬¬åç¯‡ ç”Ÿäº§å®è·µä¸ç›‘æ§è¯„ä¼°</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>å›¾åƒç®—æ³•ç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>ç¬¬ä¸€ç¯‡ æœºå™¨å­¦ä¹ åŸºç¡€</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>ç¬¬äºŒç¯‡ æ·±åº¦å­¦ä¹ åŸºç¡€</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>ç¬¬ä¸‰ç¯‡ è®¡ç®—æœºè§†è§‰æ ¸å¿ƒæŠ€æœ¯</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>ç¬¬å››ç¯‡ ç›®æ ‡æ£€æµ‹ä¸YOLOç³»åˆ—</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>ç¬¬äº”ç¯‡ å›¾åƒåˆ†å‰²</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>ç¬¬å…­ç¯‡ ç”Ÿæˆæ¨¡å‹</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>ç¬¬ä¸ƒç¯‡ è§†è§‰å¤§æ¨¡å‹</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>ç¬¬å…«ç¯‡ ç”Ÿäº§å®è·µ</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>å¤§æ¨¡å‹ç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>ç¬¬ä¸€éƒ¨åˆ†ï¼šå¤§è¯­è¨€æ¨¡å‹åŸºç¡€</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>ç¬¬1ç«  åˆè¯†å¤§è¯­è¨€æ¨¡å‹</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>ç¬¬2ç«  ä¸æ¨¡å‹å¯¹è¯ï¼šæç¤ºå·¥ç¨‹åŸºç¡€</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>ç¬¬3ç«  è¯­è¨€çš„åŸºçŸ³ï¼šåˆ†è¯ä¸åµŒå…¥</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>ç¬¬äºŒéƒ¨åˆ†ï¼šTransformeræ¶æ„æ­ç§˜</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>ç¬¬1ç«  Transformeræ ¸å¿ƒæ­ç§˜</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>ç¬¬2ç«  æ¨¡å‹å®¶æ—è°±ç³»ï¼šä»ç¼–ç å™¨åˆ°è§£ç å™¨</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>ç¬¬3ç«  é¢„è®­ç»ƒçš„å¥¥ç§˜ï¼šä»æ•°æ®åˆ°æ™ºèƒ½</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®å·¥ç¨‹ä¸å®šåˆ¶åŒ–</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>ç¬¬1ç«  æ•°æ®å·¥ç¨‹åŸºç¡€</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>ç¬¬2ç«  å¾®è°ƒä½ çš„ä¸“å±æ¨¡å‹</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>ç¬¬3ç«  ä¸äººç±»å¯¹é½ï¼šåå¥½ä¼˜åŒ–</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>ç¬¬4ç«  åˆ›å»ºæ›´ä¼˜çš„åµŒå…¥æ¨¡å‹</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>ç¬¬å››éƒ¨åˆ†ï¼šå¤§æ¨¡å‹åº”ç”¨å¼€å‘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>ç¬¬1ç«  æç¤ºå·¥ç¨‹ä¸ä¸Šä¸‹æ–‡å­¦ä¹ </a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>ç¬¬2ç«  æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰åŸç†</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>ç¬¬3ç«  æ™ºèƒ½ä½“ï¼ˆAgentï¼‰æ ¸å¿ƒæœºåˆ¶</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>ç¬¬4ç«  å¤šæ¨¡æ€å¤§æ¨¡å‹åŸç†</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>ç¬¬äº”éƒ¨åˆ†ï¼šå·¥ç¨‹å®æˆ˜å·¥å…·æ ˆ</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>ç¬¬1ç«  Hugging Faceç”Ÿæ€å…¨æ™¯</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>ç¬¬2ç«  LLaMA-Factoryå¾®è°ƒå·¥å‚</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>ç¬¬3ç«  TRLä¸å¼ºåŒ–å­¦ä¹ å®æˆ˜</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>ç¬¬4ç«  DeepSpeedåˆ†å¸ƒå¼è®­ç»ƒ</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>ç¬¬5ç«  ç«¯åˆ°ç«¯LLMé¡¹ç›®å®æˆ˜</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>ç¬¬å…­éƒ¨åˆ†ï¼šç”Ÿäº§éƒ¨ç½²ä¸è¯„ä¼°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>ç¬¬1ç«  æ¨¡å‹å‹ç¼©ä¸æ¨ç†åŠ é€Ÿ</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>ç¬¬2ç«  vLLMé«˜æ€§èƒ½æ¨ç†</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>ç¬¬3ç«  æ¨¡å‹è¯„ä¼°ä½“ç³»</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé«˜çº§æŠ€æœ¯ä¸“é¢˜</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>ç¬¬1ç«  é•¿ä¸Šä¸‹æ–‡æŠ€æœ¯</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>ç¬¬2ç«  æ–°å‹æ¶æ„æ¢ç´¢</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>ç¬¬3ç«  æ¨ç†åŠ é€Ÿé»‘ç§‘æŠ€</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>ç¬¬4ç«  æ¨ç†æ¨¡å‹ä¸“é¢˜</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>ç¬¬5ç«  æ¨¡å‹å®‰å…¨ä¸å¯è§£é‡Šæ€§</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>å®Œç»“æŠ¥å‘Š</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>å®è·µç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>æ·±å…¥ç†è§£ FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agentæœ€ä½³è®¾è®¡æ¨¡å¼</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>æœºå™¨å­¦ä¹ ç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>ç¬¬01ç«  æœºå™¨å­¦ä¹ æ¦‚è§ˆ</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>ç¬¬02ç«  çŸ©é˜µè¿ç®—ä¸å¾®ç§¯åˆ†</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>ç¬¬03ç«  SVDä¸çŸ©é˜µåˆ†è§£</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>ç¬¬04ç«  æ¦‚ç‡åˆ†å¸ƒ æŒ‡æ•°æ—ä¸å…±è½­å…ˆéªŒ</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>ç¬¬05ç«  çº¿æ€§å›å½’</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>ç¬¬06ç«  æ„ŸçŸ¥æœº</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>ç¬¬07ç«  æ”¯æŒå‘é‡æœº(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>ç¬¬08ç«  æ ¸æ–¹æ³•</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>ç¬¬09ç«  å†³ç­–æ ‘ä¸é›†æˆå­¦ä¹ </a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>ç¬¬10ç«  é€»è¾‘å›å½’ä¸æœ€å¤§ç†µæ¨¡å‹</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>ç¬¬11ç«  å¹¿ä¹‰çº¿æ€§æ¨¡å‹(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>ç¬¬13ç«  æ¦‚ç‡å›¾æ¨¡å‹ è¡¨ç¤º</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>ç¬¬14ç«  æ¦‚ç‡å›¾æ¨¡å‹ æ¨æ–­</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>æ·±åº¦å­¦ä¹ ç¬”è®°</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>ç¬¬1ç«  æ·±åº¦å­¦ä¹ åŸºç¡€</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#-å‰ç½®çŸ¥è¯†è¯´æ˜>ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜</a></li><li><a href=#ç¬¬1ç« message-ä¸-tools-åŸºç¡€>ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€</a><ul><li><a href=#11-message-æ¶ˆæ¯ç³»ç»Ÿ>1.1 Message æ¶ˆæ¯ç³»ç»Ÿ</a><ul><li><a href=#111-æ¶ˆæ¯ç±»å‹humanmessageaimessagesystemmessagetoolmessage>1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage</a></li><li><a href=#112-content-blocks-æ ¸å¿ƒåˆ›æ–°texttool-usethinkingimage>1.1.2 Content Blocks æ ¸å¿ƒåˆ›æ–°ï¼ˆTextã€Tool Useã€Thinkingã€Imageï¼‰</a></li><li><a href=#113-è·¨-provider-ç»Ÿä¸€å¤„ç†>1.1.3 è·¨ Provider ç»Ÿä¸€å¤„ç†</a></li><li><a href=#114-å¤šæ¨¡æ€æ”¯æŒ>1.1.4 å¤šæ¨¡æ€æ”¯æŒ</a></li></ul></li><li><a href=#12-tools-å·¥å…·ä½“ç³»>1.2 Tools å·¥å…·ä½“ç³»</a><ul><li><a href=#121-å·¥å…·å®šä¹‰æ–¹å¼toolstructuredtoolbasetool>1.2.1 å·¥å…·å®šä¹‰æ–¹å¼ï¼š@toolã€StructuredToolã€BaseTool</a></li><li><a href=#122-å‚æ•°-schemapydantic>1.2.2 å‚æ•° Schemaï¼ˆPydanticï¼‰</a></li><li><a href=#123-å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨>1.2.3 å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨</a></li><li><a href=#124-é”™è¯¯å¤„ç†ç­–ç•¥>1.2.4 é”™è¯¯å¤„ç†ç­–ç•¥</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ >æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬2ç« create_agent-å¿«é€Ÿæ„å»º>ç¬¬2ç« ï¼šcreate_agent å¿«é€Ÿæ„å»º</a><ul><li><a href=#21-agent-åŸºæœ¬æ¦‚å¿µ>2.1 Agent åŸºæœ¬æ¦‚å¿µ</a><ul><li><a href=#211-agent-å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯>2.1.1 Agent å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯</a></li><li><a href=#212-agent-ä¸-chain-çš„æœ¬è´¨åŒºåˆ«>2.1.2 Agent ä¸ Chain çš„æœ¬è´¨åŒºåˆ«</a></li><li><a href=#213-é€‚ç”¨åœºæ™¯åˆ†æ>2.1.3 é€‚ç”¨åœºæ™¯åˆ†æ</a></li></ul></li><li><a href=#22-æ ¸å¿ƒå‚æ•°è¯¦è§£>2.2 æ ¸å¿ƒå‚æ•°è¯¦è§£</a><ul><li><a href=#221-modeltoolssystem_prompt>2.2.1 modelã€toolsã€system_prompt</a></li><li><a href=#222-è¿›é˜¶é…ç½®middleware-ç®€ä»‹>2.2.2 è¿›é˜¶é…ç½®ï¼šMiddleware ç®€ä»‹</a></li><li><a href=#223-response_format-ç»“æ„åŒ–è¾“å‡º>2.2.3 response_format ç»“æ„åŒ–è¾“å‡º</a></li></ul></li><li><a href=#23-ç¬¬ä¸€ä¸ª-agent-å®æˆ˜>2.3 ç¬¬ä¸€ä¸ª Agent å®æˆ˜</a><ul><li><a href=#231-ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰>2.3.1 ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰</a></li><li><a href=#232-åˆ›å»º-agent-ä¸è¿è¡Œè°ƒè¯•>2.3.2 åˆ›å»º Agent ä¸è¿è¡Œè°ƒè¯•</a></li><li><a href=#233-ç»“æ„åŒ–è¾“å‡ºpydantic-schema>2.3.3 ç»“æ„åŒ–è¾“å‡ºï¼ˆPydantic Schemaï¼‰</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-1>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -1>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬3ç« å®æˆ˜æ¡ˆä¾‹rag-agent>ç¬¬3ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šRAG Agent</a><ul><li><a href=#31-rag-åŸºç¡€æ¦‚å¿µ>3.1 RAG åŸºç¡€æ¦‚å¿µ</a><ul><li><a href=#311-æ–‡æ¡£å¤„ç†æµç¨‹>3.1.1 æ–‡æ¡£å¤„ç†æµç¨‹</a></li><li><a href=#312-å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥>3.1.2 å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥</a></li></ul></li><li><a href=#32-rag-agent-å®ç°>3.2 RAG Agent å®ç°</a><ul><li><a href=#321-æ„å»ºæ£€ç´¢å·¥å…·>3.2.1 æ„å»ºæ£€ç´¢å·¥å…·</a></li><li><a href=#322-ç³»ç»Ÿæç¤ºè¯è®¾è®¡>3.2.2 ç³»ç»Ÿæç¤ºè¯è®¾è®¡</a></li><li><a href=#323-è¿è¡Œä¸ä¼˜åŒ–æŸ¥è¯¢é‡å†™ç›¸å…³æ€§è¯„åˆ†>3.2.3 è¿è¡Œä¸ä¼˜åŒ–ï¼ˆæŸ¥è¯¢é‡å†™ã€ç›¸å…³æ€§è¯„åˆ†ï¼‰</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-2>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -2>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬4ç« å®æˆ˜æ¡ˆä¾‹sql-agent>ç¬¬4ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šSQL Agent</a><ul><li><a href=#41-sql-agent-æ¶æ„>4.1 SQL Agent æ¶æ„</a><ul><li><a href=#411-æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–>4.1.1 æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–</a></li><li><a href=#412-sql-å·¥å…·å¼€å‘æŸ¥è¯¢å®‰å…¨é™åˆ¶>4.1.2 SQL å·¥å…·å¼€å‘ï¼ˆæŸ¥è¯¢ã€å®‰å…¨é™åˆ¶ï¼‰</a></li></ul></li><li><a href=#42-sql-agent-å®ç°>4.2 SQL Agent å®ç°</a><ul><li><a href=#421-ç³»ç»Ÿæç¤ºè¯ä¸-agent-åˆ›å»º>4.2.1 ç³»ç»Ÿæç¤ºè¯ä¸ Agent åˆ›å»º</a></li><li><a href=#422-human-in-the-loop-å®¡æ‰¹æœºåˆ¶>4.2.2 Human-in-the-Loop å®¡æ‰¹æœºåˆ¶</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-3>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -3>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬5ç« memory-ä¸ä¸Šä¸‹æ–‡ç®¡ç†>ç¬¬5ç« ï¼šMemory ä¸ä¸Šä¸‹æ–‡ç®¡ç†</a><ul><li><a href=#51-ä¸ºä»€ä¹ˆéœ€è¦-memory>5.1 ä¸ºä»€ä¹ˆéœ€è¦ Memory</a><ul><li><a href=#511-æ— è®°å¿†-agent-çš„é—®é¢˜>5.1.1 æ— è®°å¿† Agent çš„é—®é¢˜</a></li></ul></li><li><a href=#52-ä½¿ç”¨-langgraph-checkpointer-å®ç°è®°å¿†>5.2 ä½¿ç”¨ LangGraph Checkpointer å®ç°è®°å¿†</a><ul><li><a href=#521-åŸºç¡€è®°å¿†å®ç°>5.2.1 åŸºç¡€è®°å¿†å®ç°</a></li><li><a href=#522-æŒä¹…åŒ–è®°å¿†sqlite>5.2.2 æŒä¹…åŒ–è®°å¿†ï¼ˆSQLiteï¼‰</a></li><li><a href=#523-ç”Ÿäº§çº§è®°å¿†postgresql>5.2.3 ç”Ÿäº§çº§è®°å¿†ï¼ˆPostgreSQLï¼‰</a></li></ul></li><li><a href=#53-è®°å¿†ç®¡ç†æœ€ä½³å®è·µ>5.3 è®°å¿†ç®¡ç†æœ€ä½³å®è·µ</a><ul><li><a href=#531-ä¼šè¯éš”ç¦»>5.3.1 ä¼šè¯éš”ç¦»</a></li><li><a href=#532-æŸ¥çœ‹å¯¹è¯å†å²>5.3.2 æŸ¥çœ‹å¯¹è¯å†å²</a></li><li><a href=#533-æ¸…é™¤è®°å¿†>5.3.3 æ¸…é™¤è®°å¿†</a></li></ul></li><li><a href=#54-æˆæœ¬ä¼˜åŒ–ç­–ç•¥>5.4 æˆæœ¬ä¼˜åŒ–ç­–ç•¥</a><ul><li><a href=#541-é™åˆ¶å†å²é•¿åº¦>5.4.1 é™åˆ¶å†å²é•¿åº¦</a></li><li><a href=#542-ä½¿ç”¨æ€»ç»“ç­–ç•¥>5.4.2 ä½¿ç”¨æ€»ç»“ç­–ç•¥</a></li></ul></li><li><a href=#55-ç»¼åˆå®æˆ˜å®¢æœæœºå™¨äºº>5.5 ç»¼åˆå®æˆ˜ï¼šå®¢æœæœºå™¨äºº</a></li><li><a href=#56-æœ¬ç« å°ç»“>5.6 æœ¬ç« å°ç»“</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=ç¬¬äºŒç¯‡-å¿«é€Ÿä¸Šæ‰‹å®æˆ˜>ç¬¬äºŒç¯‡ å¿«é€Ÿä¸Šæ‰‹å®æˆ˜<a class=anchor href=#%e7%ac%ac%e4%ba%8c%e7%af%87-%e5%bf%ab%e9%80%9f%e4%b8%8a%e6%89%8b%e5%ae%9e%e6%88%98>#</a></h1><hr><h2 id=-å‰ç½®çŸ¥è¯†è¯´æ˜>ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜<a class=anchor href=#-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86%e8%af%b4%e6%98%8e>#</a></h2><p>æœ¬ç¯‡å°†ä½¿ç”¨ä»¥ä¸‹æ ¸å¿ƒæ¦‚å¿µï¼Œå¦‚éœ€æ·±å…¥ç†è§£è¯·å‚è€ƒç›¸å…³ç« èŠ‚ï¼š</p><ul><li><strong>StateGraph</strong>: LangGraphçš„çŠ¶æ€å›¾ï¼Œç”¨äºç¼–æ’å¤æ‚æµç¨‹ â†’ æœ¬ç¯‡ä»…ä½¿ç”¨åŸºç¡€åŠŸèƒ½ï¼Œé«˜çº§ç”¨æ³•è¯¦è§<strong>ç¬¬ä¸‰ç¯‡ç¬¬7ç« </strong></li><li><strong>Runnable Protocol</strong>: ç»Ÿä¸€æ‰§è¡Œæ¥å£ï¼ˆinvoke/stream/batchï¼‰ â†’ å·²åœ¨<strong>ç¬¬ä¸€ç¯‡ç¬¬2ç« </strong>è®²è§£</li><li><strong>LCELè¯­æ³•</strong>: ç®¡é“æ“ä½œç¬¦<code>|</code>å’Œå¹¶è¡Œ<code>{}</code> â†’ å·²åœ¨<strong>ç¬¬ä¸€ç¯‡ç¬¬2.2èŠ‚</strong>è®²è§£</li></ul><blockquote class=book-hint><p>ğŸ’¡ <strong>å­¦ä¹ å»ºè®®</strong>: åˆå­¦è€…å¯ä»¥å…ˆè·Ÿç€æœ¬ç¯‡ä»£ç å®è·µï¼Œé‡åˆ°ä¸ç†è§£çš„æ¦‚å¿µå†å›çœ‹ç›¸å…³ç« èŠ‚ã€‚</p></blockquote><hr><h2 id=ç¬¬1ç« message-ä¸-tools-åŸºç¡€>ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€<a class=anchor href=#%e7%ac%ac1%e7%ab%a0message-%e4%b8%8e-tools-%e5%9f%ba%e7%a1%80>#</a></h2><h3 id=11-message-æ¶ˆæ¯ç³»ç»Ÿ>1.1 Message æ¶ˆæ¯ç³»ç»Ÿ<a class=anchor href=#11-message-%e6%b6%88%e6%81%af%e7%b3%bb%e7%bb%9f>#</a></h3><h4 id=111-æ¶ˆæ¯ç±»å‹humanmessageaimessagesystemmessagetoolmessage>1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage<a class=anchor href=#111-%e6%b6%88%e6%81%af%e7%b1%bb%e5%9e%8bhumanmessageaimessagesystemmessagetoolmessage>#</a></h4><p>LangChain 1.0 å¼•å…¥äº†ç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹ç³»ç»Ÿï¼Œç”¨äºè¡¨ç¤ºäººæœºå¯¹è¯ä¸­çš„ä¸åŒè§’è‰²å’Œå†…å®¹ã€‚</p><p><strong>æ ¸å¿ƒæ¶ˆæ¯ç±»å‹</strong></p><pre class=mermaid>graph TD
    A[BaseMessage] --&gt; B[HumanMessage]
    A --&gt; C[AIMessage]
    A --&gt; D[SystemMessage]
    A --&gt; E[ToolMessage]
    A --&gt; F[FunctionMessage]

    style A fill:#E3F2FD
    style B fill:#C8E6C9
    style C fill:#FFF9C4
    style D fill:#FFCCBC
    style E fill:#E1BEE7
    style F fill:#B2DFDB</pre><script src=/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"default"})</script><p><strong>1. HumanMessage - ç”¨æˆ·æ¶ˆæ¯</strong></p><p>è¡¨ç¤ºç”¨æˆ·è¾“å…¥ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–‡æœ¬æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;What is LangChain?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¸¦å…ƒæ•°æ®</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=s2>&#34;Analyze this image&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;123&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>2. AIMessage - AI å“åº”</strong></p><p>è¡¨ç¤º AI æ¨¡å‹çš„å›å¤ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç®€å•æ–‡æœ¬å›å¤</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;LangChain is a framework...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¸¦å·¥å…·è°ƒç”¨ï¼ˆLangChain 1.0 æ ¼å¼ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_calls</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;call_123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;args&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain&#34;</span><span class=p>}</span>  <span class=c1># ç›´æ¥æ˜¯å­—å…¸ï¼Œä¸æ˜¯ JSON å­—ç¬¦ä¸²</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>3. SystemMessage - ç³»ç»Ÿæ¶ˆæ¯</strong></p><p>å®šä¹‰ AI è¡Œä¸ºå’Œè§’è‰²ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>SystemMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>system</span> <span class=o>=</span> <span class=n>SystemMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;You are a helpful AI assistant.
</span></span></span><span class=line><span class=cl><span class=s2>    Always be concise and accurate.
</span></span></span><span class=line><span class=cl><span class=s2>    Use tools when necessary.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>4. ToolMessage - å·¥å…·ç»“æœ</strong></p><p>è¡¨ç¤ºå·¥å…·æ‰§è¡Œçš„è¿”å›ç»“æœï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>ToolMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tool_result</span> <span class=o>=</span> <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=s2>&#34;Search results: ...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_call_id</span><span class=o>=</span><span class=s2>&#34;call_123&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>æ¶ˆæ¯å¯¹è¯æµç¨‹</strong></p><pre class=mermaid>sequenceDiagram
    participant User
    participant System
    participant AI
    participant Tool

    System-&gt;&gt;AI: SystemMessage (è§’è‰²å®šä¹‰)
    User-&gt;&gt;AI: HumanMessage (ç”¨æˆ·é—®é¢˜)
    AI-&gt;&gt;AI: å†³ç­–ï¼šéœ€è¦å·¥å…·?
    AI-&gt;&gt;Tool: AIMessage (tool_calls)
    Tool-&gt;&gt;AI: ToolMessage (å·¥å…·ç»“æœ)
    AI-&gt;&gt;User: AIMessage (æœ€ç»ˆå›ç­”)</pre><p><strong>å®Œæ•´å¯¹è¯ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>SystemMessage</span><span class=p>,</span> <span class=n>HumanMessage</span><span class=p>,</span> <span class=n>AIMessage</span><span class=p>,</span> <span class=n>ToolMessage</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ„å»ºå®Œæ•´çš„å¯¹è¯å†å²ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl><span class=c1># è¿™å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„ Agent å¯¹è¯æµç¨‹ï¼šç³»ç»Ÿæ¶ˆæ¯ â†’ ç”¨æˆ·é—®é¢˜ â†’ AI å·¥å…·è°ƒç”¨ â†’ å·¥å…·ç»“æœ â†’ AI æœ€ç»ˆå›ç­”</span>
</span></span><span class=line><span class=cl><span class=n>conversation</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. ç³»ç»Ÿæ¶ˆæ¯ï¼šå®šä¹‰ AI çš„è§’è‰²å’Œè¡Œä¸º</span>
</span></span><span class=line><span class=cl>    <span class=n>SystemMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;You are a helpful assistant.&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. ç”¨æˆ·æ¶ˆæ¯ï¼šç”¨æˆ·æå‡ºé—®é¢˜</span>
</span></span><span class=line><span class=cl>    <span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;What&#39;s the weather in Beijing?&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. AI æ¶ˆæ¯ï¼šAI å†³å®šè°ƒç”¨å·¥å…·</span>
</span></span><span class=line><span class=cl>    <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>,</span>  <span class=c1># å·¥å…·è°ƒç”¨æ—¶ content ä¸ºç©º</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_calls</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;call_123&#34;</span><span class=p>,</span>  <span class=c1># å·¥å…·è°ƒç”¨çš„å”¯ä¸€ ID</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;get_weather&#34;</span><span class=p>,</span>  <span class=c1># å·¥å…·åç§°</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;args&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;city&#34;</span><span class=p>:</span> <span class=s2>&#34;Beijing&#34;</span><span class=p>}</span>  <span class=c1># å·¥å…·å‚æ•°ï¼ˆå­—å…¸æ ¼å¼ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=p>}]</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. å·¥å…·æ¶ˆæ¯ï¼šå·¥å…·æ‰§è¡Œç»“æœ</span>
</span></span><span class=line><span class=cl>    <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span><span class=o>=</span><span class=s2>&#34;Temperature: 20Â°C, Sunny&#34;</span><span class=p>,</span>  <span class=c1># å·¥å…·è¿”å›çš„ç»“æœ</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_call_id</span><span class=o>=</span><span class=s2>&#34;call_123&#34;</span>  <span class=c1># å¯¹åº”ä¸Šé¢çš„å·¥å…·è°ƒç”¨ ID</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 5. AI æ¶ˆæ¯ï¼šåŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›ç­”</span>
</span></span><span class=line><span class=cl>    <span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;The weather in Beijing is 20Â°C and sunny.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><hr><h4 id=112-content-blocks-æ ¸å¿ƒåˆ›æ–°texttool-usethinkingimage>1.1.2 Content Blocks æ ¸å¿ƒåˆ›æ–°ï¼ˆTextã€Tool Useã€Thinkingã€Imageï¼‰<a class=anchor href=#112-content-blocks-%e6%a0%b8%e5%bf%83%e5%88%9b%e6%96%b0texttool-usethinkingimage>#</a></h4><p><strong>Content Blocks</strong> æ˜¯ LangChain 1.0 çš„é‡å¤§åˆ›æ–°ï¼Œæä¾›äº†è·¨ Provider çš„ç»Ÿä¸€å†…å®¹è¡¨ç¤ºã€‚</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦ Content Blocksï¼Ÿ</strong></p><p>åœ¨ LangChain 1.0 ä¹‹å‰ï¼š</p><ul><li>âŒ ä¸åŒæ¨¡å‹çš„è¾“å‡ºæ ¼å¼ä¸ä¸€è‡´</li><li>âŒ æ— æ³•ç»Ÿä¸€å¤„ç†å·¥å…·è°ƒç”¨ã€æ€è€ƒè¿‡ç¨‹ã€å¤šæ¨¡æ€å†…å®¹</li><li>âŒ Provider åˆ‡æ¢éœ€è¦é‡å†™ä»£ç </li></ul><p><strong>Content Blocks è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p><pre class=mermaid>graph LR
    A[AIMessage] --&gt; B[Content Blocks]
    B --&gt; C[Text Block]
    B --&gt; D[Tool Use Block]
    B --&gt; E[Thinking Block]
    B --&gt; F[Image Block]
    B --&gt; G[Citation Block]

    style B fill:#FFF9C4
    style C fill:#E8F5E9
    style D fill:#E3F2FD
    style E fill:#F3E5F5
    style F fill:#FFF3E0
    style G fill:#FCE4EC</pre><p><strong>1. Text Block - æ–‡æœ¬å†…å®¹</strong></p><p>æœ€åŸºç¡€çš„æ–‡æœ¬å†…å®¹ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;Here&#39;s the answer...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¿é—® content blocks</span>
</span></span><span class=line><span class=cl><span class=c1># æ³¨æ„: content æ˜¯åˆ—è¡¨æ—¶ç›´æ¥è¿­ä»£</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>])</span></span></span></code></pre></div><p><strong>2. Tool Use Block - å·¥å…·è°ƒç”¨</strong></p><p>ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æ ¼å¼ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;call_123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æå–å·¥å…·è°ƒç”¨</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Tool: </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Input: </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;input&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>3. Thinking Block - æ€è€ƒè¿‡ç¨‹ï¼ˆClaudeï¼‰</strong></p><p>Claude æ¨¡å‹çš„æ€è€ƒè¿‡ç¨‹ï¼ˆExtended Thinkingï¼‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Claude è¿”å›çš„æ€è€ƒè¿‡ç¨‹</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;thinking&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;thinking&#34;</span><span class=p>:</span> <span class=s2>&#34;Let me analyze this step by step...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;Based on my analysis...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¿é—®æ€è€ƒè¿‡ç¨‹</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;thinking&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Thinking: </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;thinking&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>4. Image Block - å›¾åƒå†…å®¹</strong></p><p>å¤šæ¨¡æ€å›¾åƒæ”¯æŒï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å‘é€å›¾åƒ</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;What&#39;s in this image?&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image_url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;image_url&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://example.com/image.jpg&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>5. Citation Block - å¼•ç”¨æ¥æºï¼ˆGeminiï¼‰</strong></p><p>Gemini æ¨¡å‹çš„å¼•ç”¨æ¥æºï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain is a framework...&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;citation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;citation&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;https://docs.langchain.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;start_index&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;end_index&#34;</span><span class=p>:</span> <span class=mi>50</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h4 id=113-è·¨-provider-ç»Ÿä¸€å¤„ç†>1.1.3 è·¨ Provider ç»Ÿä¸€å¤„ç†<a class=anchor href=#113-%e8%b7%a8-provider-%e7%bb%9f%e4%b8%80%e5%a4%84%e7%90%86>#</a></h4><p><strong>ç»Ÿä¸€çš„ content_blocks æ¥å£</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_anthropic</span> <span class=kn>import</span> <span class=n>ChatAnthropic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. åˆ›å»ºä¸åŒ Provider çš„æ¨¡å‹å®ä¾‹</span>
</span></span><span class=line><span class=cl><span class=c1># OpenAI æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>openai_model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response1</span> <span class=o>=</span> <span class=n>openai_model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Anthropic Claude æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>claude_model</span> <span class=o>=</span> <span class=n>ChatAnthropic</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-3-sonnet&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>response2</span> <span class=o>=</span> <span class=n>claude_model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. ç»Ÿä¸€è®¿é—®æ–¹å¼ - æ— éœ€å…³å¿ƒåº•å±‚ Provider</span>
</span></span><span class=line><span class=cl><span class=c1># Content Blocks æä¾›äº†è·¨ Provider çš„ç»Ÿä¸€æ¥å£</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>response</span> <span class=ow>in</span> <span class=p>[</span><span class=n>response1</span><span class=p>,</span> <span class=n>response2</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=c1># éå† content blocksï¼ˆå¯èƒ½æ˜¯åˆ—è¡¨æˆ–å­—ç¬¦ä¸²ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç®€å•æ–‡æœ¬å“åº”</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Content blocks åˆ—è¡¨</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=n>block</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;thinking&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Claude ç‰¹æœ‰çš„æ€è€ƒè¿‡ç¨‹</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Thinking] </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;thinking&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>Provider å·®å¼‚è‡ªåŠ¨å¤„ç†</strong></p><pre class=mermaid>graph TD
    A[User Input] --&gt; B{Provider Type}
    B --&gt;|OpenAI| C[OpenAI Format]
    B --&gt;|Anthropic| D[Anthropic Format]
    B --&gt;|Google| E[Google Format]

    C --&gt; F[Unified Content Blocks]
    D --&gt; F
    E --&gt; F

    F --&gt; G[Application Code]

    style F fill:#C8E6C9</pre><hr><h4 id=114-å¤šæ¨¡æ€æ”¯æŒ>1.1.4 å¤šæ¨¡æ€æ”¯æŒ<a class=anchor href=#114-%e5%a4%9a%e6%a8%a1%e6%80%81%e6%94%af%e6%8c%81>#</a></h4><p><strong>å›¾åƒè¾“å…¥</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–¹å¼1ï¼šURL</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;Describe this image&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image_url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;image_url&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://example.com/image.jpg&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–¹å¼2ï¼šBase64 ç¼–ç </span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&#34;image.jpg&#34;</span><span class=p>,</span> <span class=s2>&#34;rb&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>image_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>())</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;What&#39;s in this image?&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image_url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;image_url&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;data:image/jpeg;base64,</span><span class=si>{</span><span class=n>image_data</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>éŸ³é¢‘å¤„ç†</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># éŸ³é¢‘è¾“å…¥ï¼ˆæŸäº›æ¨¡å‹æ”¯æŒï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;audio_url&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;audio_url&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;https://example.com/audio.mp3&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>æ··åˆå†…å®¹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. åˆ›å»ºæ”¯æŒå¤šæ¨¡æ€çš„æ¨¡å‹å®ä¾‹</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span>  <span class=c1># GPT-4o æ”¯æŒè§†è§‰è¾“å…¥</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. æ„å»ºæ··åˆå†…å®¹æ¶ˆæ¯ï¼šæ–‡æœ¬ + å›¾åƒ</span>
</span></span><span class=line><span class=cl><span class=n>message</span> <span class=o>=</span> <span class=n>HumanMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=s2>&#34;Analyze this chart and search for related data&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image_url&#34;</span><span class=p>,</span> <span class=s2>&#34;image_url&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;url&#34;</span><span class=p>:</span> <span class=s2>&#34;chart.png&#34;</span><span class=p>}},</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. è°ƒç”¨æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. å¤„ç†å¤šæ¨¡æ€å“åº”</span>
</span></span><span class=line><span class=cl><span class=c1># response.content å¯èƒ½åŒ…å«å¤šç§ç±»å‹çš„ content blocks</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>block</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Text: </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;text&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>block</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;tool_use&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Tool Call: </span><span class=si>{</span><span class=n>block</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=12-tools-å·¥å…·ä½“ç³»>1.2 Tools å·¥å…·ä½“ç³»<a class=anchor href=#12-tools-%e5%b7%a5%e5%85%b7%e4%bd%93%e7%b3%bb>#</a></h3><h4 id=121-å·¥å…·å®šä¹‰æ–¹å¼toolstructuredtoolbasetool>1.2.1 å·¥å…·å®šä¹‰æ–¹å¼ï¼š@toolã€StructuredToolã€BaseTool<a class=anchor href=#121-%e5%b7%a5%e5%85%b7%e5%ae%9a%e4%b9%89%e6%96%b9%e5%bc%8ftoolstructuredtoolbasetool>#</a></h4><p><strong>æ–¹å¼ 1ï¼š@tool è£…é¥°å™¨ï¼ˆæ¨èï¼‰</strong></p><p>æœ€ç®€å•å¿«é€Ÿçš„æ–¹å¼ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search the web for information.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: The search query string
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># å®ç°æœç´¢é€»è¾‘</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Search results for: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è‡ªåŠ¨æå–ï¼š</span>
</span></span><span class=line><span class=cl><span class=c1># - å‡½æ•°å -&gt; å·¥å…·å</span>
</span></span><span class=line><span class=cl><span class=c1># - æ–‡æ¡£å­—ç¬¦ä¸² -&gt; å·¥å…·æè¿°</span>
</span></span><span class=line><span class=cl><span class=c1># - å‚æ•°ç±»å‹æ³¨è§£ -&gt; Schema</span></span></span></code></pre></div><p><strong>å¸¦å¤æ‚å‚æ•°</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æœç´¢æŸ¥è¯¢&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æœ€å¤§ç»“æœæ•°&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>language</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=s2>&#34;en&#34;</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;è¯­è¨€&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Advanced search with filters.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Found </span><span class=si>{</span><span class=n>max_results</span><span class=si>}</span><span class=s2> results for &#39;</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#39; in </span><span class=si>{</span><span class=n>language</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>æ–¹å¼ 2ï¼šStructuredTool ç±»</strong></p><p>æ›´çµæ´»çš„å®šä¹‰æ–¹å¼ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>StructuredTool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_func</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Found </span><span class=si>{</span><span class=n>max_results</span><span class=si>}</span><span class=s2> results for </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>search_tool</span> <span class=o>=</span> <span class=n>StructuredTool</span><span class=o>.</span><span class=n>from_function</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>func</span><span class=o>=</span><span class=n>search_func</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;web_search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;Search the web for information&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>args_schema</span><span class=o>=</span><span class=n>SearchInput</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>æ–¹å¼ 3ï¼šBaseTool ç»§æ‰¿</strong></p><p>å®Œå…¨è‡ªå®šä¹‰æ§åˆ¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>BaseTool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Type</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æŸ¥è¯¢å­—ç¬¦ä¸²&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æœ€å¤§ç»“æœæ•°&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CustomSearchTool</span><span class=p>(</span><span class=n>BaseTool</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;custom_search&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;è‡ªå®šä¹‰æœç´¢å·¥å…·&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>args_schema</span><span class=p>:</span> <span class=n>Type</span><span class=p>[</span><span class=n>BaseModel</span><span class=p>]</span> <span class=o>=</span> <span class=n>SearchInput</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åŒæ­¥æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Search: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>, Max: </span><span class=si>{</span><span class=n>max_results</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_arun</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¼‚æ­¥æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Async Search: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>tool</span> <span class=o>=</span> <span class=n>CustomSearchTool</span><span class=p>()</span></span></span></code></pre></div><p><strong>ä¸‰ç§æ–¹å¼å¯¹æ¯”</strong></p><table><thead><tr><th>æ–¹å¼</th><th>é€‚ç”¨åœºæ™¯</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>@tool</td><td>ç®€å•å·¥å…·</td><td>å¿«é€Ÿã€ç®€æ´</td><td>çµæ´»æ€§ä½</td></tr><tr><td>StructuredTool</td><td>ä¸­ç­‰å¤æ‚åº¦</td><td>å¹³è¡¡</td><td>éœ€è¦é¢å¤–ç±»</td></tr><tr><td>BaseTool</td><td>å¤æ‚å·¥å…·</td><td>å®Œå…¨æ§åˆ¶</td><td>ä»£ç é‡å¤š</td></tr></tbody></table><hr><h4 id=122-å‚æ•°-schemapydantic>1.2.2 å‚æ•° Schemaï¼ˆPydanticï¼‰<a class=anchor href=#122-%e5%8f%82%e6%95%b0-schemapydantic>#</a></h4><p><strong>åŸºç¡€ Schema å®šä¹‰</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WeatherInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¤©æ°”æŸ¥è¯¢å‚æ•°&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>city</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;åŸå¸‚åç§°&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>units</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>default</span><span class=o>=</span><span class=s2>&#34;celsius&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ¸©åº¦å•ä½&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>enum</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;celsius&#34;</span><span class=p>,</span> <span class=s2>&#34;fahrenheit&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span><span class=p>(</span><span class=n>args_schema</span><span class=o>=</span><span class=n>WeatherInput</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_weather</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>units</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;celsius&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Get weather information for a city.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Weather in </span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2>: 20Â°</span><span class=si>{</span><span class=n>units</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>å¤æ‚åµŒå¥— Schema</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Location</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>city</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>country</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SearchFilters</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>locations</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Location</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>date_range</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>categories</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span><span class=p>(</span><span class=n>args_schema</span><span class=o>=</span><span class=n>SearchFilters</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>filtered_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>locations</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Location</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>date_range</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>tuple</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>categories</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search with complex filters.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Searching in </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>locations</span><span class=p>)</span><span class=si>}</span><span class=s2> locations&#34;</span></span></span></code></pre></div><p><strong>Schema éªŒè¯</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>field_validator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EmailInput</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;é‚®ç®±åœ°å€&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_email</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;@&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>v</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;Invalid email address&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span><span class=p>(</span><span class=n>args_schema</span><span class=o>=</span><span class=n>EmailInput</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_email</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Send an email.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Email sent to </span><span class=si>{</span><span class=n>email</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><hr><h4 id=123-å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨>1.2.3 å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨<a class=anchor href=#123-%e5%b7%a5%e5%85%b7%e8%b0%83%e7%94%a8%e6%9c%ba%e5%88%b6%e4%b8%8e%e5%b9%b6%e8%a1%8c%e8%b0%83%e7%94%a8>#</a></h4><p><strong>å•å·¥å…·è°ƒç”¨æµç¨‹</strong></p><pre class=mermaid>sequenceDiagram
    participant Agent
    participant LLM
    participant Tool

    Agent-&gt;&gt;LLM: ç”¨æˆ·é—®é¢˜
    LLM-&gt;&gt;LLM: åˆ†æï¼šéœ€è¦å·¥å…·?
    LLM-&gt;&gt;Agent: tool_calls
    Agent-&gt;&gt;Tool: æ‰§è¡Œå·¥å…·
    Tool--&gt;&gt;Agent: å·¥å…·ç»“æœ
    Agent-&gt;&gt;LLM: ToolMessage
    LLM--&gt;&gt;Agent: æœ€ç»ˆç­”æ¡ˆ</pre><p><strong>å¹¶è¡Œå·¥å…·è°ƒç”¨</strong></p><p>LangChain 1.0 è‡ªåŠ¨æ”¯æŒå¹¶è¡Œå·¥å…·è°ƒç”¨ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. å®šä¹‰å¤šä¸ªå·¥å…·</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_weather</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Get weather for a city.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        city: The name of the city
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Weather in </span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2>: Sunny&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_time</span><span class=p>(</span><span class=n>city</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Get current time in a city.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        city: The name of the city
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Time in </span><span class=si>{</span><span class=n>city</span><span class=si>}</span><span class=s2>: 10:00 AM&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºæ¨¡å‹å®ä¾‹</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ç»‘å®šå·¥å…·åˆ°æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>get_weather</span><span class=p>,</span> <span class=n>get_time</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>model_with_tools</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>bind_tools</span><span class=p>(</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. è°ƒç”¨æ¨¡å‹ï¼ˆLLM å¯èƒ½ä¼šå¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>response</span> <span class=o>=</span> <span class=n>model_with_tools</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=s2>&#34;What&#39;s the weather and time in Beijing?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. æŸ¥çœ‹å·¥å…·è°ƒç”¨</span>
</span></span><span class=line><span class=cl><span class=c1># response.tool_calls ä¼šåŒ…å«å¤šä¸ªå·¥å…·è°ƒç”¨ï¼ˆå¦‚æœ LLM å†³å®šå¹¶è¡Œè°ƒç”¨ï¼‰</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·è°ƒç”¨æ•°é‡: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>tool_call</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>tool_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·: </span><span class=si>{</span><span class=n>tool_call</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>, å‚æ•°: </span><span class=si>{</span><span class=n>tool_call</span><span class=p>[</span><span class=s1>&#39;args&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>å¹¶è¡Œæ‰§è¡Œæµç¨‹</strong>ï¼š</p><pre class=mermaid>graph TD
    A[LLM Decision] --&gt; B[Tool Call 1: get_weather]
    A --&gt; C[Tool Call 2: get_time]
    A --&gt; D[Tool Call 3: search]

    B --&gt; E[Parallel Execution]
    C --&gt; E
    D --&gt; E

    E --&gt; F[Aggregate Results]
    F --&gt; G[Final Response]

    style E fill:#C8E6C9</pre><hr><h4 id=124-é”™è¯¯å¤„ç†ç­–ç•¥>1.2.4 é”™è¯¯å¤„ç†ç­–ç•¥<a class=anchor href=#124-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e7%ad%96%e7%95%a5>#</a></h4><p><strong>åŸºç¡€é”™è¯¯å¤„ç†</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>divide</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Divide two numbers.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>a</span> <span class=o>/</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ZeroDivisionError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Error: Division by zero&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>è¿”å›ç»“æ„åŒ–é”™è¯¯</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Union</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®šä¹‰ç»“æ„åŒ–çš„å·¥å…·ç»“æœç±»å‹</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToolResult</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å·¥å…·æ‰§è¡Œç»“æœçš„ç»“æ„åŒ–è¡¨ç¤º&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ‰§è¡Œæ˜¯å¦æˆåŠŸ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>dict</span><span class=p>]]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æˆåŠŸæ—¶çš„æ•°æ®&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>default</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Safe search with error handling.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: The search query string
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        JSON string of ToolResult
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ‰§è¡Œæœç´¢ï¼ˆç¤ºä¾‹ï¼šå‡è®¾æœ‰ä¸€ä¸ª perform_search å‡½æ•°ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=c1># results = perform_search(query)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Search results for: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1># ç¤ºä¾‹å®ç°</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>ToolResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>data</span><span class=o>=</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>ToolResult</span><span class=p>(</span><span class=n>success</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>error</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span></span></span></code></pre></div><p><strong>é‡è¯•æœºåˆ¶</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tenacity</span> <span class=kn>import</span> <span class=n>retry</span><span class=p>,</span> <span class=n>stop_after_attempt</span><span class=p>,</span> <span class=n>wait_exponential</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=nd>@retry</span><span class=p>(</span><span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span> <span class=n>wait</span><span class=o>=</span><span class=n>wait_exponential</span><span class=p>(</span><span class=n>multiplier</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reliable_api_call</span><span class=p>(</span><span class=n>endpoint</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;API call with automatic retry.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ä¼šè‡ªåŠ¨é‡è¯•æœ€å¤š3æ¬¡</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>call_api</span><span class=p>(</span><span class=n>endpoint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span></span></span></code></pre></div><p><strong>è¶…æ—¶æ§åˆ¶</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>async_search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search with timeout.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>search_async</span><span class=p>(</span><span class=n>query</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span><span class=o>=</span><span class=mf>5.0</span>  <span class=c1># 5ç§’è¶…æ—¶</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Search timeout after 5 seconds&#34;</span></span></span></code></pre></div><p><strong>Agent çº§åˆ«é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</strong></p><p>åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒAgent è°ƒç”¨å¯èƒ½ä¼šé‡åˆ°å„ç§é”™è¯¯ï¼Œéœ€è¦å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.exceptions</span> <span class=kn>import</span> <span class=n>OutputParserException</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableConfig</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é…ç½®æ—¥å¿—</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_agent_invoke</span><span class=p>(</span><span class=n>agent</span><span class=p>,</span> <span class=n>input_data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¸¦é‡è¯•å’Œé”™è¯¯å¤„ç†çš„ Agent è°ƒç”¨
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        agent: LangGraph Agent å®ä¾‹
</span></span></span><span class=line><span class=cl><span class=s2>        input_data: è¾“å…¥æ•°æ®å­—å…¸ï¼Œå¦‚ {&#34;messages&#34;: [HumanMessage(...)]}
</span></span></span><span class=line><span class=cl><span class=s2>        max_retries: æœ€å¤§é‡è¯•æ¬¡æ•°
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        Agent è¾“å‡ºç»“æœæˆ–é”™è¯¯ä¿¡æ¯
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è°ƒç”¨ Agent</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>input_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Agent è°ƒç”¨æˆåŠŸ (å°è¯• </span><span class=si>{</span><span class=n>attempt</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>OutputParserException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è¾“å‡ºè§£æé”™è¯¯ï¼ˆLLM è¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼‰</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;è¾“å‡ºè§£æå¤±è´¥: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;å°è¯•ä½¿ç”¨é™çº§æç¤ºè¯é‡è¯•...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># å¯ä»¥åœ¨è¿™é‡Œè°ƒæ•´æç¤ºè¯ï¼Œè¦æ±‚ LLM è¾“å‡ºæ›´ç®€å•çš„æ ¼å¼</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;response_parse_failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;AI è¿”å›æ ¼å¼æ— æ³•è§£æï¼Œè¯·é‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error_type</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># é€Ÿç‡é™åˆ¶é”™è¯¯ - ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s2>&#34;RateLimitError&#34;</span> <span class=ow>in</span> <span class=n>error_type</span> <span class=ow>or</span> <span class=s2>&#34;rate_limit&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>wait_time</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span>  <span class=c1># æŒ‡æ•°é€€é¿: 1s, 2s, 4s</span>
</span></span><span class=line><span class=cl>                    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;é‡åˆ°é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾… </span><span class=si>{</span><span class=n>wait_time</span><span class=si>}</span><span class=s2>ç§’åé‡è¯•...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>wait_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;rate_limit_exceeded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;API è°ƒç”¨é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># API å¯†é’¥é”™è¯¯ - ä¸é‡è¯•</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=s2>&#34;authentication&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>or</span> <span class=s2>&#34;api_key&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;è®¤è¯å¤±è´¥: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;authentication_failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;API å¯†é’¥é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒå˜é‡&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># ç½‘ç»œé”™è¯¯ - é‡è¯•</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=s2>&#34;connection&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>or</span> <span class=s2>&#34;timeout&#34;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•ä¸­... (</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;network_error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># å…¶ä»–æœªçŸ¥é”™è¯¯</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;æœªçŸ¥é”™è¯¯ (</span><span class=si>{</span><span class=n>error_type</span><span class=si>}</span><span class=s2>): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;unknown_error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;å‘ç”ŸæœªçŸ¥é”™è¯¯: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)[:</span><span class=mi>100</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;max_retries_exceeded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° (</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>safe_agent_invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span><span class=o>=</span><span class=n>my_agent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>input_data</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;å¸®æˆ‘æŸ¥è¯¢å¤©æ°”&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ£€æŸ¥ç»“æœ</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=nb>dict</span><span class=p>)</span> <span class=ow>and</span> <span class=s2>&#34;error&#34;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;âŒ è°ƒç”¨å¤±è´¥: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;message&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;âœ… è°ƒç”¨æˆåŠŸ: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>é”™è¯¯å¤„ç†æœ€ä½³å®è·µæ€»ç»“</strong>ï¼š</p><table><thead><tr><th>é”™è¯¯ç±»å‹</th><th>æ˜¯å¦é‡è¯•</th><th>ç­–ç•¥</th></tr></thead><tbody><tr><td><strong>é€Ÿç‡é™åˆ¶</strong></td><td>âœ… æ˜¯</td><td>æŒ‡æ•°é€€é¿é‡è¯• (1s â†’ 2s â†’ 4s)</td></tr><tr><td><strong>ç½‘ç»œè¶…æ—¶</strong></td><td>âœ… æ˜¯</td><td>å›ºå®šé—´éš”é‡è¯• (1s)</td></tr><tr><td><strong>è¾“å‡ºè§£æå¤±è´¥</strong></td><td>âœ… æ˜¯</td><td>è°ƒæ•´æç¤ºè¯åé‡è¯•</td></tr><tr><td><strong>API å¯†é’¥é”™è¯¯</strong></td><td>âŒ å¦</td><td>ç«‹å³è¿”å›ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥é…ç½®</td></tr><tr><td><strong>å‚æ•°éªŒè¯é”™è¯¯</strong></td><td>âŒ å¦</td><td>ç«‹å³è¿”å›ï¼Œæç¤ºç”¨æˆ·ä¿®æ­£è¾“å…¥</td></tr></tbody></table><blockquote class=book-hint><p>ğŸ’¡ <strong>æç¤º</strong>: æ›´å¤šç”Ÿäº§çº§é”™è¯¯å¤„ç†ã€ç›‘æ§å‘Šè­¦ã€æ•…éšœæ¢å¤ç­–ç•¥ï¼Œè¯¦è§ <strong>ç¬¬åç¯‡ã€Šç”Ÿäº§å®è·µä¸ç›‘æ§è¯„ä¼°ã€‹</strong>ã€‚</p></blockquote><hr><h3 id=æœ¬ç« å°ç»“>æœ¬ç« å°ç»“<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h3><p><strong>Message ç³»ç»Ÿæ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p><ul><li>âœ… ç»Ÿä¸€æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage</li><li>âœ… Content Blocksï¼šè·¨ Provider çš„ç»Ÿä¸€å†…å®¹è¡¨ç¤º</li><li>âœ… å¤šæ¨¡æ€æ”¯æŒï¼šæ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘æ··åˆå¤„ç†</li></ul><p><strong>Tools å·¥å…·ä½“ç³»æ ¸å¿ƒè¦ç‚¹</strong>ï¼š</p><ul><li>âœ… ä¸‰ç§å®šä¹‰æ–¹å¼ï¼š@toolã€StructuredToolã€BaseTool</li><li>âœ… Pydantic Schemaï¼šç±»å‹å®‰å…¨çš„å‚æ•°å®šä¹‰</li><li>âœ… å¹¶è¡Œè°ƒç”¨ï¼šè‡ªåŠ¨ä¼˜åŒ–å·¥å…·æ‰§è¡Œ</li><li>âœ… é”™è¯¯å¤„ç†ï¼šé‡è¯•ã€è¶…æ—¶ã€ç»“æ„åŒ–é”™è¯¯</li></ul><p><strong>è®¾è®¡å“²å­¦</strong>ï¼š</p><blockquote class=book-hint><p>ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ + ç±»å‹å®‰å…¨çš„å·¥å…·å®šä¹‰ = å¯é çš„ Agent ç³»ç»Ÿ</p></blockquote><hr><h3 id=æ€è€ƒä¸ç»ƒä¹ >æ€è€ƒä¸ç»ƒä¹ <a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0>#</a></h3><ol><li><p><strong>ç»ƒä¹  1ï¼šæ¶ˆæ¯ç±»å‹</strong>
æ„å»ºä¸€ä¸ªå®Œæ•´çš„å¯¹è¯æµç¨‹ï¼ŒåŒ…å« SystemMessageã€HumanMessageã€AIMessageï¼ˆå¸¦å·¥å…·è°ƒç”¨ï¼‰ã€ToolMessageã€‚</p></li><li><p><strong>ç»ƒä¹  2ï¼šå·¥å…·å®šä¹‰</strong>
ä½¿ç”¨ä¸‰ç§æ–¹å¼åˆ†åˆ«å®šä¹‰ä¸€ä¸ªè®¡ç®—å™¨å·¥å…·ï¼Œå¯¹æ¯”ä»£ç é‡å’Œçµæ´»æ€§ã€‚</p></li><li><p><strong>ç»ƒä¹  3ï¼šContent Blocks</strong>
ç¼–å†™ä»£ç æå– AIMessage ä¸­çš„æ‰€æœ‰ text block å’Œ tool_use blockã€‚</p></li><li><p><strong>ç»ƒä¹  4ï¼šé”™è¯¯å¤„ç†</strong>
å®ç°ä¸€ä¸ªå¸¦é‡è¯•å’Œè¶…æ—¶çš„ç½‘ç»œè¯·æ±‚å·¥å…·ã€‚</p></li><li><p><strong>æ€è€ƒé¢˜ï¼š</strong></p><ul><li>Content Blocks ç›¸æ¯”ä¼ ç»Ÿå­—ç¬¦ä¸² content æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ</li><li>ä»€ä¹ˆåœºæ™¯ä¸‹åº”è¯¥ä½¿ç”¨ BaseTool è€Œä¸æ˜¯ @toolï¼Ÿ</li><li>å¹¶è¡Œå·¥å…·è°ƒç”¨åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¤±æ•ˆï¼Ÿ</li></ul></li></ol><hr><h2 id=ç¬¬2ç« create_agent-å¿«é€Ÿæ„å»º>ç¬¬2ç« ï¼šcreate_agent å¿«é€Ÿæ„å»º<a class=anchor href=#%e7%ac%ac2%e7%ab%a0create_agent-%e5%bf%ab%e9%80%9f%e6%9e%84%e5%bb%ba>#</a></h2><h3 id=21-agent-åŸºæœ¬æ¦‚å¿µ>2.1 Agent åŸºæœ¬æ¦‚å¿µ<a class=anchor href=#21-agent-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5>#</a></h3><h4 id=211-agent-å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯>2.1.1 Agent å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯<a class=anchor href=#211-agent-%e5%ae%9a%e4%b9%89%e4%b8%8e%e6%89%a7%e8%a1%8c%e5%be%aa%e7%8e%af>#</a></h4><p><strong>ä»€ä¹ˆæ˜¯ Agentï¼Ÿ</strong></p><p>Agent æ˜¯ä¸€ä¸ªå¯ä»¥<strong>è‡ªä¸»å†³ç­–ã€è°ƒç”¨å·¥å…·ã€è¿­ä»£æ±‚è§£</strong>çš„ AI ç³»ç»Ÿã€‚</p><p><strong>æ ¸å¿ƒç‰¹å¾</strong>ï¼š</p><ul><li>ğŸ¤– <strong>è‡ªä¸»æ€§</strong>ï¼šæ ¹æ®ç¯å¢ƒåŠ¨æ€å†³ç­–</li><li>ğŸ”§ <strong>å·¥å…·ä½¿ç”¨</strong>ï¼šè°ƒç”¨å¤–éƒ¨å·¥å…·è·å–ä¿¡æ¯</li><li>ğŸ”„ <strong>è¿­ä»£æ‰§è¡Œ</strong>ï¼šå¤šè½®æ¨ç†ç›´åˆ°è§£å†³é—®é¢˜</li><li>ğŸ¯ <strong>ç›®æ ‡å¯¼å‘</strong>ï¼šæœç€ç›®æ ‡æŒç»­è¡ŒåŠ¨</li></ul><pre class=mermaid>graph LR
    A[ç”¨æˆ·é—®é¢˜] --&gt; B[Agent]
    B --&gt; C{éœ€è¦å·¥å…·?}
    C --&gt;|æ˜¯| D[è°ƒç”¨å·¥å…·]
    C --&gt;|å¦| E[ç›´æ¥å›ç­”]
    D --&gt; F[è·å–ç»“æœ]
    F --&gt; B
    E --&gt; G[è¿”å›ç­”æ¡ˆ]

    style B fill:#FFF9C4
    style D fill:#E3F2FD</pre><p><strong>Agent æ‰§è¡Œå¾ªç¯</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Agent æ‰§è¡Œå¾ªç¯ä¼ªä»£ç </span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=ow>not</span> <span class=n>solved</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. æ€è€ƒï¼šåˆ†æå½“å‰æƒ…å†µ</span>
</span></span><span class=line><span class=cl>    <span class=n>thought</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>think</span><span class=p>(</span><span class=n>current_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. å†³ç­–ï¼šé€‰æ‹©è¡ŒåŠ¨</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>need_more_info</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è°ƒç”¨å·¥å…·</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span> <span class=o>=</span> <span class=n>select_tool</span><span class=p>(</span><span class=n>available_tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>execute_tool</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>current_state</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç»™å‡ºç­”æ¡ˆ</span>
</span></span><span class=line><span class=cl>        <span class=n>final_answer</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>generate</span><span class=p>(</span><span class=n>current_state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=n>final_answer</span></span></span></code></pre></div><p><strong>æ‰§è¡Œæµç¨‹å›¾</strong>ï¼š</p><pre class=mermaid>sequenceDiagram
    participant U as User
    participant A as Agent
    participant L as LLM
    participant T as Tools

    U-&gt;&gt;A: è¾“å…¥é—®é¢˜
    loop è¿­ä»£å¾ªç¯
        A-&gt;&gt;L: å½“å‰çŠ¶æ€ + å†å²
        L-&gt;&gt;A: å†³ç­–ï¼šå·¥å…·è°ƒç”¨ / æœ€ç»ˆç­”æ¡ˆ
        alt éœ€è¦å·¥å…·
            A-&gt;&gt;T: æ‰§è¡Œå·¥å…·
            T--&gt;&gt;A: å·¥å…·ç»“æœ
        else å¾—åˆ°ç­”æ¡ˆ
            A-&gt;&gt;U: è¿”å›æœ€ç»ˆç­”æ¡ˆ
        end
    end</pre><hr><h4 id=212-agent-ä¸-chain-çš„æœ¬è´¨åŒºåˆ«>2.1.2 Agent ä¸ Chain çš„æœ¬è´¨åŒºåˆ«<a class=anchor href=#212-agent-%e4%b8%8e-chain-%e7%9a%84%e6%9c%ac%e8%b4%a8%e5%8c%ba%e5%88%ab>#</a></h4><p><strong>Chainï¼ˆé“¾ï¼‰- é¢„å®šä¹‰æµç¨‹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. å®šä¹‰ç»„ä»¶</span>
</span></span><span class=line><span class=cl><span class=n>prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;Tell me a joke about </span><span class=si>{topic}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>parser</span> <span class=o>=</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Chain: å›ºå®šçš„çº¿æ€§æµç¨‹ï¼ˆä½¿ç”¨ LCEL ç®¡é“æ“ä½œç¬¦ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=n>prompt</span> <span class=o>|</span> <span class=n>model</span> <span class=o>|</span> <span class=n>parser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. æ‰§è¡Œï¼ˆæµç¨‹å›ºå®šï¼šprompt â†’ model â†’ parserï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;topic&#34;</span><span class=p>:</span> <span class=s2>&#34;programming&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>  <span class=c1># ç›´æ¥è¾“å‡ºç¬‘è¯æ–‡æœ¬</span></span></span></code></pre></div><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>âœ… æµç¨‹å›ºå®šï¼Œå¯é¢„æµ‹</li><li>âœ… æ€§èƒ½ç¨³å®š</li><li>âŒ ç¼ºä¹çµæ´»æ€§</li><li>âŒ æ— æ³•åŠ¨æ€è°ƒæ•´</li></ul><p><strong>Agentï¼ˆä»£ç†ï¼‰- åŠ¨æ€å†³ç­–</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. å®šä¹‰å·¥å…·</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search for information.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Results for: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºæ¨¡å‹å’Œå·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>search</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Agent: åŠ¨æ€å†³ç­–æµç¨‹</span>
</span></span><span class=line><span class=cl><span class=c1># create_agent ä¼šè‡ªåŠ¨æ„å»ºä¸€ä¸ªå¯ä»¥å†³ç­–ã€è°ƒç”¨å·¥å…·ã€è¿­ä»£æ‰§è¡Œçš„ Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. æ‰§è¡Œï¼ˆAgent å†…éƒ¨ä¼šè‡ªåŠ¨å¾ªç¯ï¼šæ€è€ƒ â†’ å†³ç­– â†’ æ‰§è¡Œå·¥å…· â†’ å†æ€è€ƒ...ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Search for LangChain documentation&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. è·å–æœ€ç»ˆç»“æœ</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><p><strong>ç‰¹ç‚¹</strong>ï¼š</p><ul><li>âœ… åŠ¨æ€å†³ç­–ï¼Œçµæ´»</li><li>âœ… å¯ä»¥ä½¿ç”¨å·¥å…·</li><li>âŒ è¡Œä¸ºä¸å¯é¢„æµ‹</li><li>âŒ Token æ¶ˆè€—å¯èƒ½è¾ƒé«˜</li></ul><p><strong>å¯¹æ¯”è¡¨</strong></p><table><thead><tr><th>ç»´åº¦</th><th>Chain</th><th>Agent</th></tr></thead><tbody><tr><td>æ‰§è¡Œæµç¨‹</td><td>å›ºå®šçº¿æ€§</td><td>åŠ¨æ€å¾ªç¯</td></tr><tr><td>å†³ç­–èƒ½åŠ›</td><td>æ— å†³ç­–</td><td>LLM è‡ªä¸»å†³ç­–</td></tr><tr><td>å·¥å…·ä½¿ç”¨</td><td>æ— ï¼ˆæˆ–å›ºå®šï¼‰</td><td>åŠ¨æ€é€‰æ‹©å·¥å…·</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>ç®€å•ã€ç¡®å®šæ€§ä»»åŠ¡</td><td>å¤æ‚ã€éœ€è¦æ¨ç†çš„ä»»åŠ¡</td></tr><tr><td>Token æ¶ˆè€—</td><td>å¯é¢„æµ‹</td><td>ä¸å¯é¢„æµ‹</td></tr><tr><td>å¯é æ€§</td><td>é«˜</td><td>ä¸­ï¼ˆä¾èµ– LLMï¼‰</td></tr></tbody></table><pre class=mermaid>graph TD
    A[ä»»åŠ¡] --&gt; B{æ˜¯å¦éœ€è¦æ¨ç†?}
    B --&gt;|å¦| C[ä½¿ç”¨ Chain]
    B --&gt;|æ˜¯| D{æ˜¯å¦éœ€è¦å·¥å…·?}
    D --&gt;|å¦| C
    D --&gt;|æ˜¯| E[ä½¿ç”¨ Agent]

    style C fill:#C8E6C9
    style E fill:#FFF9C4</pre><hr><h4 id=213-é€‚ç”¨åœºæ™¯åˆ†æ>2.1.3 é€‚ç”¨åœºæ™¯åˆ†æ<a class=anchor href=#213-%e9%80%82%e7%94%a8%e5%9c%ba%e6%99%af%e5%88%86%e6%9e%90>#</a></h4><p><strong>ä½¿ç”¨ Agent çš„åœºæ™¯</strong></p><p>âœ… <strong>ä¿¡æ¯æ£€ç´¢</strong>ï¼šéœ€è¦æœç´¢ã€æŸ¥è¯¢æ•°æ®åº“
âœ… <strong>å¤šæ­¥éª¤æ¨ç†</strong>ï¼šéœ€è¦åˆ†è§£ä»»åŠ¡ã€é€æ­¥æ±‚è§£
âœ… <strong>åŠ¨æ€å†³ç­–</strong>ï¼šæ ¹æ®ä¸­é—´ç»“æœè°ƒæ•´ç­–ç•¥
âœ… <strong>å·¥å…·ç»„åˆ</strong>ï¼šéœ€è¦ç»„åˆä½¿ç”¨å¤šä¸ªå·¥å…·</p><p><strong>ç¤ºä¾‹åœºæ™¯</strong>ï¼š</p><ul><li>ğŸ“Š æ•°æ®åˆ†æï¼šæŸ¥è¯¢æ•°æ®åº“ â†’ åˆ†æ â†’ ç”ŸæˆæŠ¥å‘Š</li><li>ğŸ” ç ”ç©¶åŠ©æ‰‹ï¼šæœç´¢ â†’ æ€»ç»“ â†’ å¼•ç”¨æ¥æº</li><li>ğŸ’¼ å®¢æœæœºå™¨äººï¼šæŸ¥è¯¢è®¢å• â†’ æ£€æŸ¥åº“å­˜ â†’ æ¨èè§£å†³æ–¹æ¡ˆ</li></ul><p><strong>ä¸é€‚åˆä½¿ç”¨ Agent çš„åœºæ™¯</strong></p><p>âŒ <strong>ç®€å•è½¬æ¢</strong>ï¼šæ–‡æœ¬ç¿»è¯‘ã€æ‘˜è¦ï¼ˆç”¨ Chainï¼‰
âŒ <strong>ç¡®å®šæ€§æµç¨‹</strong>ï¼šå·²çŸ¥æ­¥éª¤çš„å·¥ä½œæµï¼ˆç”¨ LangGraphï¼‰
âŒ <strong>ä½å»¶è¿Ÿè¦æ±‚</strong>ï¼šå®æ—¶å“åº”ï¼ˆChain æ›´å¿«ï¼‰
âŒ <strong>æˆæœ¬æ•æ„Ÿ</strong>ï¼šToken é¢„ç®—æœ‰é™</p><hr><h3 id=22-æ ¸å¿ƒå‚æ•°è¯¦è§£>2.2 æ ¸å¿ƒå‚æ•°è¯¦è§£<a class=anchor href=#22-%e6%a0%b8%e5%bf%83%e5%8f%82%e6%95%b0%e8%af%a6%e8%a7%a3>#</a></h3><h4 id=221-modeltoolssystem_prompt>2.2.1 modelã€toolsã€system_prompt<a class=anchor href=#221-modeltoolssystem_prompt>#</a></h4><p><strong>model - é€‰æ‹© LLM</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_anthropic</span> <span class=kn>import</span> <span class=n>ChatAnthropic</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OpenAI</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Anthropic</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatAnthropic</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;claude-sonnet-4-5-20250929&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span></span></span></code></pre></div><p><strong>æ¨¡å‹é€‰æ‹©å»ºè®®</strong>ï¼š</p><ul><li><strong>GPT-4</strong>ï¼šæ¨ç†èƒ½åŠ›å¼ºï¼Œé€‚åˆå¤æ‚ä»»åŠ¡</li><li><strong>GPT-3.5-Turbo</strong>ï¼šé€Ÿåº¦å¿«ï¼Œæˆæœ¬ä½ï¼Œé€‚åˆç®€å•ä»»åŠ¡</li><li><strong>Claude 3 Sonnet</strong>ï¼šå¹³è¡¡æ€§èƒ½å’Œæˆæœ¬</li><li><strong>Claude 3 Opus</strong>ï¼šæœ€å¼ºæ¨ç†èƒ½åŠ›</li></ul><p><strong>tools - å®šä¹‰å·¥å…·åˆ—è¡¨</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search the web.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Results for: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Calculate mathematical expression.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>expression</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>search</span><span class=p>,</span> <span class=n>calculate</span><span class=p>]</span></span></span></code></pre></div><p><strong>system_prompt - å®šä¹‰ Agent è¡Œä¸º</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a helpful research assistant.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Your capabilities:
</span></span></span><span class=line><span class=cl><span class=s2>- Search the web for information
</span></span></span><span class=line><span class=cl><span class=s2>- Perform calculations
</span></span></span><span class=line><span class=cl><span class=s2>- Provide accurate citations
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Guidelines:
</span></span></span><span class=line><span class=cl><span class=s2>1. Always verify information before answering
</span></span></span><span class=line><span class=cl><span class=s2>2. Use tools when necessary
</span></span></span><span class=line><span class=cl><span class=s2>3. Be concise and accurate
</span></span></span><span class=line><span class=cl><span class=s2>4. Cite your sources
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><p><strong>æç¤ºè¯è®¾è®¡åŸåˆ™</strong>ï¼š</p><ul><li>âœ… æ˜ç¡®è§’è‰²å’Œèƒ½åŠ›</li><li>âœ… æä¾›æ¸…æ™°çš„æŒ‡å¯¼</li><li>âœ… è¯´æ˜å·¥å…·ä½¿ç”¨åœºæ™¯</li><li>âœ… å®šä¹‰è¾“å‡ºæ ¼å¼è¦æ±‚</li></ul><hr><h4 id=222-è¿›é˜¶é…ç½®middleware-ç®€ä»‹>2.2.2 è¿›é˜¶é…ç½®ï¼šMiddleware ç®€ä»‹<a class=anchor href=#222-%e8%bf%9b%e9%98%b6%e9%85%8d%e7%bd%aemiddleware-%e7%ae%80%e4%bb%8b>#</a></h4><p><strong>æ ¸å¿ƒé—®é¢˜</strong>ï¼š<code>create_agent</code> å·²ç»å¾ˆå¥½ç”¨äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ Middlewareï¼Ÿ</p><p><strong>çœŸå®åœºæ™¯</strong>ï¼š</p><ol><li>ğŸ“ <strong>å¯¹è¯å¤ªé•¿ï¼ŒToken è¶…é™</strong> â†’ éœ€è¦è‡ªåŠ¨æ‘˜è¦å†å²æ¶ˆæ¯</li><li>ğŸ”’ <strong>ç”¨æˆ·è¾“å…¥åŒ…å«æ•æ„Ÿä¿¡æ¯</strong> â†’ éœ€è¦è„±æ•åå†å‘é€ç»™ LLM</li><li>ğŸ”„ <strong>å·¥å…·è°ƒç”¨å¤±è´¥</strong> â†’ éœ€è¦è‡ªåŠ¨é‡è¯•</li><li>ğŸ’° <strong>æˆæœ¬æ§åˆ¶</strong> â†’ ç®€å•é—®é¢˜ç”¨ä¾¿å®œæ¨¡å‹ï¼Œå¤æ‚é—®é¢˜ç”¨é«˜çº§æ¨¡å‹</li></ol><p><strong>Middleware æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>Middleware æ˜¯ LangChain 1.0 å¼•å…¥çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç”¨äºåœ¨ Agent æ‰§è¡Œè¿‡ç¨‹ä¸­æ³¨å…¥è‡ªå®šä¹‰é€»è¾‘å’Œæ§åˆ¶æµç¨‹ã€‚</p><p><strong>å¸¸è§ Middleware ç±»å‹</strong>ï¼š</p><table><thead><tr><th>Middleware</th><th>åŠŸèƒ½</th><th>ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td><code>SummarizationMiddleware</code></td><td>è‡ªåŠ¨æ‘˜è¦é•¿å¯¹è¯</td><td>Token è¶…é™é£é™©</td></tr><tr><td><code>PIIMiddleware</code></td><td>æ•æ„Ÿä¿¡æ¯è„±æ•</td><td>å¤„ç†ç”¨æˆ·éšç§æ•°æ®</td></tr><tr><td><code>ToolRetryMiddleware</code></td><td>å·¥å…·è°ƒç”¨é‡è¯•</td><td>æé«˜å·¥å…·è°ƒç”¨å¯é æ€§</td></tr><tr><td><code>LLMToolSelectorMiddleware</code></td><td>åŠ¨æ€ç­›é€‰å·¥å…·</td><td>å·¥å…·å¤ªå¤šå¯¼è‡´æ··ä¹±</td></tr></tbody></table><blockquote class=book-hint><p>ğŸ’¡ <strong>æ·±å…¥å­¦ä¹ </strong>ï¼šMiddleware çš„å®Œæ•´ç”¨æ³•ã€Hook ä½“ç³»ã€è‡ªå®šä¹‰ç­–ç•¥ç­‰å†…å®¹ï¼Œè¯·å‚è§ <strong>ç¬¬å…«ç¯‡ã€ŠMiddleware å·¥ç¨‹åŒ–ã€‹</strong>ã€‚</p></blockquote><hr><p><strong>recursion_limit - é˜²æ­¢æ— é™å¾ªç¯</strong></p><p>é€šè¿‡ <code>config</code> æ§åˆ¶æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.errors</span> <span class=kn>import</span> <span class=n>GraphRecursionError</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;å¤æ‚é—®é¢˜&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;recursion_limit&#34;</span><span class=p>:</span> <span class=mi>11</span><span class=p>}</span>  <span class=c1># æœ€å¤š 5 æ¬¡è¿­ä»£</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=n>GraphRecursionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼š</span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>è®¡ç®—å…¬å¼</strong>ï¼š<code>recursion_limit = 2 Ã— æœŸæœ›è¿­ä»£æ¬¡æ•° + 1</code></p><table><thead><tr><th>æœŸæœ›è¿­ä»£æ¬¡æ•°</th><th>recursion_limit</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>3</td><td>7</td><td>æŸ¥å¤©æ°”ç­‰ç®€å•ä»»åŠ¡</td></tr><tr><td>5</td><td>11</td><td>å¤šæ­¥æœç´¢</td></tr><tr><td>10</td><td>21</td><td>ç ”ç©¶æŠ¥å‘Šç­‰å¤æ‚ä»»åŠ¡</td></tr></tbody></table><blockquote class=book-hint><p>ğŸ’¡ é»˜è®¤å€¼ 10000ï¼Œå¼€å‘æ—¶åŸºæœ¬ä¸ä¼šè§¦å‘</p></blockquote><hr><p><strong>Callback Handler - ç®€å•æ—¥å¿—ï¼ˆé€‰å­¦ï¼‰</strong></p><p><strong>ç”¨é€”</strong>ï¼šè§‚å¯Ÿ Agent æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸ä¿®æ”¹è¡Œä¸º</p><p><strong>æœ€ç®€ç¤ºä¾‹</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.callbacks</span> <span class=kn>import</span> <span class=n>BaseCallbackHandler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SimpleLogger</span><span class=p>(</span><span class=n>BaseCallbackHandler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;ç®€å•çš„æ—¥å¿—å›è°ƒ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_tool_start</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serialized</span><span class=p>,</span> <span class=n>input_str</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ğŸ”§ è°ƒç”¨å·¥å…·: </span><span class=si>{</span><span class=n>serialized</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_tool_end</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>preview</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>output</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>preview</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=n>preview</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>text</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>preview</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;âœ… å·¥å…·ç»“æœ: </span><span class=si>{</span><span class=n>text</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;å¤©æ°”å¦‚ä½•ï¼Ÿ&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;callbacks&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>SimpleLogger</span><span class=p>()]}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>è¾“å‡ºç¤ºä¾‹</strong>ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ğŸ”§ è°ƒç”¨å·¥å…·: get_weather
</span></span><span class=line><span class=cl>âœ… å·¥å…·ç»“æœ: Weather in Beijing: Sunny, 20Â°C...</span></span></code></pre></div><blockquote class=book-hint><p>ğŸ’¡ <strong>æç¤º</strong>ï¼šCallback ä¸»è¦ç”¨äºç›‘æ§å’Œè°ƒè¯•ã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ LangSmithï¼ˆç¬¬13ç« è¯¦è§£ï¼‰ã€‚</p></blockquote><hr><h4 id=223-response_format-ç»“æ„åŒ–è¾“å‡º>2.2.3 response_format ç»“æ„åŒ–è¾“å‡º<a class=anchor href=#223-response_format-%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%ba>#</a></h4><blockquote class=book-hint><p>âš ï¸ <strong>é‡è¦è¯´æ˜</strong>ï¼š<code>create_agent</code> æ”¯æŒ <code>response_format</code> å‚æ•°ç”¨äºç»“æ„åŒ–è¾“å‡ºã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>model.with_structured_output()</code> æ–¹æ³•ã€‚</p></blockquote><p><strong>Pydantic Schema å®šä¹‰</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResearchReport</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;ç ”ç©¶æŠ¥å‘Šæ ¼å¼&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>title</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æŠ¥å‘Šæ ‡é¢˜&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ‰§è¡Œæ‘˜è¦&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>findings</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;ä¸»è¦å‘ç°&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sources</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;å¼•ç”¨æ¥æº&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç½®ä¿¡åº¦ 0-1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># âœ… æ­£ç¡®æ–¹æ³•ï¼šä½¿ç”¨ with_structured_output</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>structured_model</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>with_structured_output</span><span class=p>(</span><span class=n>ResearchReport</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»º Agentï¼ˆä¸ä½¿ç”¨ response_formatï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>structured_model</span><span class=p>,</span>  <span class=c1># ä½¿ç”¨ç»“æ„åŒ–æ¨¡å‹</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿”å›ç»“æ„åŒ–å¯¹è±¡</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Research about LangChain&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># ä»æœ€åä¸€æ¡ AI æ¶ˆæ¯ä¸­æå–ç»“æ„åŒ–è¾“å‡º</span>
</span></span><span class=line><span class=cl><span class=n>last_message</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=c1># æ³¨æ„ï¼šå…·ä½“æå–æ–¹å¼å–å†³äºæ¨¡å‹è¿”å›æ ¼å¼</span></span></span></code></pre></div><p><strong>JSON Schema</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ä½¿ç”¨ JSON Schema å®šä¹‰è¾“å‡ºæ ¼å¼</span>
</span></span><span class=line><span class=cl><span class=n>response_schema</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;SearchResponse&#34;</span><span class=p>,</span>  <span class=c1># âš ï¸ å¿…é¡»åŒ…å« title</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;confidence&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;number&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;array&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;items&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>,</span> <span class=s2>&#34;confidence&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># âœ… æ­£ç¡®æ–¹æ³•ï¼šä½¿ç”¨ with_structured_output</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>structured_model</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>with_structured_output</span><span class=p>(</span><span class=n>response_schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>structured_model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h3 id=23-ç¬¬ä¸€ä¸ª-agent-å®æˆ˜>2.3 ç¬¬ä¸€ä¸ª Agent å®æˆ˜<a class=anchor href=#23-%e7%ac%ac%e4%b8%80%e4%b8%aa-agent-%e5%ae%9e%e6%88%98>#</a></h3><h4 id=231-ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰>2.3.1 ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰<a class=anchor href=#231-%e7%8e%af%e5%a2%83%e5%87%86%e5%a4%87%e4%b8%8e%e5%b7%a5%e5%85%b7%e5%ae%9a%e4%b9%89>#</a></h4><p><strong>å®‰è£…ä¾èµ–</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install langchain langchain-openai langchain-core python-dotenv</span></span></code></pre></div><p><strong>ç¯å¢ƒé…ç½®</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># .env æ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=n>OPENAI_API_KEY</span><span class=o>=</span><span class=n>sk</span><span class=o>-...</span>
</span></span><span class=line><span class=cl><span class=n>LANGSMITH_API_KEY</span><span class=o>=</span><span class=n>ls</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>LANGSMITH_TRACING</span><span class=o>=</span><span class=n>true</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dotenv</span> <span class=kn>import</span> <span class=n>load_dotenv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡</span>
</span></span><span class=line><span class=cl><span class=c1># è¿™ä¼šè¯»å–é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ .env æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸­çš„å˜é‡åŠ è½½åˆ°ç¯å¢ƒä¸­</span>
</span></span><span class=line><span class=cl><span class=n>load_dotenv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># éªŒè¯ç¯å¢ƒå˜é‡å·²åŠ è½½</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;OPENAI_API_KEY not found in environment variables&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>å®šä¹‰å·¥å…·</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_wikipedia</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search Wikipedia for information.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: The search query string
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        str: Search result snippet or error message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. æ„å»º Wikipedia API è¯·æ±‚</span>
</span></span><span class=line><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://en.wikipedia.org/w/api.php&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;query&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;list&#34;</span><span class=p>:</span> <span class=s2>&#34;search&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;srsearch&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. å‘é€ HTTP è¯·æ±‚</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. è§£æå¹¶è¿”å›ç»“æœ</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>][</span><span class=s2>&#34;search&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¿”å›ç¬¬ä¸€ä¸ªæœç´¢ç»“æœçš„æ‘˜è¦</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>][</span><span class=s2>&#34;search&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=s2>&#34;snippet&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;No results found&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate</span><span class=p>(</span><span class=n>expression</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Calculate a mathematical expression.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        expression: Math expression like &#34;2+2&#34; or &#34;sqrt(16)&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        str: Calculation result or error message
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># å®‰å…¨çš„ evalï¼ˆä»…æ”¯æŒæ•°å­¦å‡½æ•°ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=c1># é€šè¿‡é™åˆ¶ __builtins__ å’Œæä¾›ç™½åå•å‡½æ•°ï¼Œé˜²æ­¢ä»£ç æ³¨å…¥</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=nb>eval</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>expression</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=s2>&#34;__builtins__&#34;</span><span class=p>:</span> <span class=kc>None</span><span class=p>},</span>  <span class=c1># ç¦ç”¨å†…ç½®å‡½æ•°</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1># åªå…è®¸è¿™äº›å®‰å…¨çš„æ•°å­¦å‡½æ•°</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;sqrt&#34;</span><span class=p>:</span> <span class=n>math</span><span class=o>.</span><span class=n>sqrt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;sin&#34;</span><span class=p>:</span> <span class=n>math</span><span class=o>.</span><span class=n>sin</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;cos&#34;</span><span class=p>:</span> <span class=n>math</span><span class=o>.</span><span class=n>cos</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;pi&#34;</span><span class=p>:</span> <span class=n>math</span><span class=o>.</span><span class=n>pi</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºå·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>search_wikipedia</span><span class=p>,</span> <span class=n>calculate</span><span class=p>]</span></span></span></code></pre></div><hr><h4 id=232-åˆ›å»º-agent-ä¸è¿è¡Œè°ƒè¯•>2.3.2 åˆ›å»º Agent ä¸è¿è¡Œè°ƒè¯•<a class=anchor href=#232-%e5%88%9b%e5%bb%ba-agent-%e4%b8%8e%e8%bf%90%e8%a1%8c%e8%b0%83%e8%af%95>#</a></h4><p><strong>åˆ›å»º Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>BaseTool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. é…ç½® LLM æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span>  <span class=c1># æ¨¡å‹åç§°</span>
</span></span><span class=line><span class=cl>    <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span>  <span class=c1># æ¸©åº¦è®¾ä¸º 0ï¼Œç¡®ä¿è¾“å‡ºç¨³å®š</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. å®šä¹‰ç³»ç»Ÿæç¤ºè¯</span>
</span></span><span class=line><span class=cl><span class=c1># ç³»ç»Ÿæç¤ºè¯ç”¨äºæŒ‡å¯¼ Agent çš„è¡Œä¸ºå’Œå†³ç­–é€»è¾‘</span>
</span></span><span class=line><span class=cl><span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a helpful research assistant.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>You have access to:
</span></span></span><span class=line><span class=cl><span class=s2>1. Wikipedia search - for factual information
</span></span></span><span class=line><span class=cl><span class=s2>2. Calculator - for mathematical calculations
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>When answering:
</span></span></span><span class=line><span class=cl><span class=s2>- Use tools to verify facts
</span></span></span><span class=line><span class=cl><span class=s2>- Show your reasoning
</span></span></span><span class=line><span class=cl><span class=s2>- Cite sources when applicable
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. åˆ›å»º Agent</span>
</span></span><span class=line><span class=cl><span class=c1># create_agent æ¥æ”¶æ¨¡å‹ã€å·¥å…·åˆ—è¡¨ã€ç³»ç»Ÿæç¤ºè¯ï¼Œè¿”å›ä¸€ä¸ªå¯æ‰§è¡Œçš„ Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>  <span class=c1># LLM æ¨¡å‹å®ä¾‹</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span>  <span class=c1># å·¥å…·åˆ—è¡¨ï¼š[search_wikipedia, calculate]</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>system_prompt</span>  <span class=c1># ç³»ç»Ÿæç¤ºè¯</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Agent ç°åœ¨å·²å‡†å¤‡å¥½å¤„ç†ç”¨æˆ·è¯·æ±‚</span>
</span></span><span class=line><span class=cl><span class=c1># å®ƒä¼šè‡ªåŠ¨å†³ç­–æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ï¼Œå¹¶è¿›è¡Œå¤šè½®è¿­ä»£ç›´åˆ°å¾—å‡ºç­”æ¡ˆ</span></span></span></code></pre></div><p><strong>è¿è¡Œ Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>BaseMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. ç®€å•é—®é¢˜ï¼ˆå¯èƒ½ä¸éœ€è¦å·¥å…·ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;What is the capital of France?&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1># è·å–æœ€åä¸€æ¡ AI æ¶ˆæ¯çš„å†…å®¹</span>
</span></span><span class=line><span class=cl><span class=n>final_answer</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>final_answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. éœ€è¦è®¡ç®—çš„é—®é¢˜ï¼ˆAgent ä¼šè°ƒç”¨ calculate å·¥å…·ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;What is the square root of 144?&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šThe square root of 144 is 12.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. éœ€è¦æœç´¢ + è®¡ç®—ï¼ˆAgent ä¼šè°ƒç”¨å¤šä¸ªå·¥å…·ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Search for the population of Tokyo and calculate its square root&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. æŸ¥çœ‹å®Œæ•´çš„æ¶ˆæ¯å†å²ï¼ˆåŒ…æ‹¬å·¥å…·è°ƒç”¨ï¼‰</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>msg</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>] </span><span class=si>{</span><span class=n>msg</span><span class=o>.</span><span class=n>type</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>msg</span><span class=o>.</span><span class=n>content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span> <span class=k>if</span> <span class=n>msg</span><span class=o>.</span><span class=n>content</span> <span class=k>else</span> <span class=s1>&#39;(tool call)&#39;</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>è°ƒè¯•è¾“å‡º</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># å¯ç”¨è¯¦ç»†æ—¥å¿—</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>langchain</span>
</span></span><span class=line><span class=cl><span class=n>langchain</span><span class=o>.</span><span class=n>debug</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹æ‰§è¡Œè¿‡ç¨‹</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Complex question&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºä¼šæ˜¾ç¤ºï¼š</span>
</span></span><span class=line><span class=cl><span class=c1># - LLM æ€è€ƒè¿‡ç¨‹</span>
</span></span><span class=line><span class=cl><span class=c1># - å·¥å…·è°ƒç”¨å†³ç­–</span>
</span></span><span class=line><span class=cl><span class=c1># - å·¥å…·æ‰§è¡Œç»“æœ</span>
</span></span><span class=line><span class=cl><span class=c1># - æœ€ç»ˆç­”æ¡ˆç”Ÿæˆ</span></span></span></code></pre></div><hr><h4 id=233-ç»“æ„åŒ–è¾“å‡ºpydantic-schema>2.3.3 ç»“æ„åŒ–è¾“å‡ºï¼ˆPydantic Schemaï¼‰<a class=anchor href=#233-%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%bapydantic-schema>#</a></h4><p><strong>å®šä¹‰è¾“å‡ºæ ¼å¼</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FactCheckResult</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;äº‹å®æ ¸æŸ¥ç»“æœ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>claim</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;åŸå§‹å£°æ˜&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>verdict</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;åˆ¤å®šç»“æœ: True/False/Uncertain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>explanation</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;è¯¦ç»†è§£é‡Š&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sources</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;éªŒè¯æ¥æº&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç½®ä¿¡åº¦ 0-1&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>åˆ›å»ºç»“æ„åŒ– Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>fact_checker</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_format</span><span class=o>=</span><span class=n>FactCheckResult</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;You are a fact-checking assistant.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>For each claim:
</span></span></span><span class=line><span class=cl><span class=s2>1. Search for credible sources
</span></span></span><span class=line><span class=cl><span class=s2>2. Verify the information
</span></span></span><span class=line><span class=cl><span class=s2>3. Provide verdict and explanation
</span></span></span><span class=line><span class=cl><span class=s2>4. List all sources used
</span></span></span><span class=line><span class=cl><span class=s2>5. Assign confidence score
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>ä½¿ç”¨ç»“æ„åŒ–è¾“å‡º</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è¾“å…¥å£°æ˜</span>
</span></span><span class=line><span class=cl><span class=n>claim</span> <span class=o>=</span> <span class=s2>&#34;The Earth is the third planet from the Sun&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·å–ç»“æ„åŒ–ç»“æœ</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>fact_checker</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>claim</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¿é—®ç»“æ„åŒ–å­—æ®µï¼ˆä» structured_response ä¸­è·å–ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>fact_result</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;structured_response&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Claim: </span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>claim</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Verdict: </span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>verdict</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Explanation: </span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>explanation</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Sources: </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>fact_result</span><span class=o>.</span><span class=n>sources</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Confidence: </span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>confidence</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼š</span>
</span></span><span class=line><span class=cl><span class=c1># Claim: The Earth is the third planet from the Sun</span>
</span></span><span class=line><span class=cl><span class=c1># Verdict: True</span>
</span></span><span class=line><span class=cl><span class=c1># Explanation: According to astronomical data, Earth orbits the Sun...</span>
</span></span><span class=line><span class=cl><span class=c1># Sources: Wikipedia - Solar System, NASA</span>
</span></span><span class=line><span class=cl><span class=c1># Confidence: 95.00%</span></span></span></code></pre></div><p><strong>æ‰¹é‡å¤„ç†</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>claims</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Water boils at 100Â°C&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;The Great Wall is visible from space&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Humans use only 10</span><span class=si>% o</span><span class=s2>f their brain&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ‰¹é‡æ ¸æŸ¥</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>fact_checker</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>claim</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>claim</span> <span class=ow>in</span> <span class=n>claims</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç”ŸæˆæŠ¥å‘Š</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>fact_result</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;structured_response&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>verdict</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>claim</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>fact_result</span><span class=o>.</span><span class=n>confidence</span><span class=si>:</span><span class=s2>.0%</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=æœ¬ç« å°ç»“-1>æœ¬ç« å°ç»“<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1>#</a></h3><p><strong>Agent æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p><ul><li>âœ… Agent = è‡ªä¸»å†³ç­– + å·¥å…·ä½¿ç”¨ + è¿­ä»£æ‰§è¡Œ</li><li>âœ… Agent ä¸ Chain çš„æœ¬è´¨åŒºåˆ«ï¼šåŠ¨æ€ vs å›ºå®š</li><li>âœ… é€‚ç”¨åœºæ™¯ï¼šä¿¡æ¯æ£€ç´¢ã€å¤šæ­¥æ¨ç†ã€åŠ¨æ€å†³ç­–</li></ul><p><strong>create_agent æ ¸å¿ƒå‚æ•°</strong>ï¼š</p><ul><li>âœ… modelï¼šé€‰æ‹©åˆé€‚çš„ LLM</li><li>âœ… toolsï¼šå®šä¹‰å¯ç”¨å·¥å…·åˆ—è¡¨</li><li>âœ… system_promptï¼šæŒ‡å¯¼ Agent è¡Œä¸º</li><li>âœ… recursion_limitï¼šé˜²æ­¢æ— é™å¾ªç¯ï¼ˆé€šè¿‡ config ä¼ å…¥ï¼‰</li><li>âœ… response_formatï¼šç»“æ„åŒ–è¾“å‡º</li></ul><p><strong>å®æˆ˜è¦ç‚¹</strong>ï¼š</p><ul><li>âœ… å·¥å…·è®¾è®¡ï¼šæ¸…æ™°çš„æè¿°å’Œå‚æ•°å®šä¹‰</li><li>âœ… æç¤ºè¯å·¥ç¨‹ï¼šæ˜ç¡®è§’è‰²ã€èƒ½åŠ›ã€æŒ‡å¯¼åŸåˆ™</li><li>âœ… ç»“æ„åŒ–è¾“å‡ºï¼šPydantic Schema ä¿è¯ç±»å‹å®‰å…¨</li></ul><p><strong>è®¾è®¡å“²å­¦</strong>ï¼š</p><blockquote class=book-hint><p>ç®€å•çš„ API + å¼ºå¤§çš„ LLM + å®ç”¨çš„å·¥å…· = æ™ºèƒ½çš„ Agent</p></blockquote><hr><h3 id=æ€è€ƒä¸ç»ƒä¹ -1>æ€è€ƒä¸ç»ƒä¹ <a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0-1>#</a></h3><ol><li><p><strong>ç»ƒä¹  1ï¼šåŸºç¡€ Agent</strong>
åˆ›å»ºä¸€ä¸ªç®€å•çš„å¤©æ°”æŸ¥è¯¢ Agentï¼Œèƒ½å¤ŸæŸ¥è¯¢åŸå¸‚å¤©æ°”å¹¶è¿›è¡Œæ¸©åº¦å•ä½è½¬æ¢ã€‚</p></li><li><p><strong>ç»ƒä¹  2ï¼šå·¥å…·ç»„åˆ</strong>
å®ç°ä¸€ä¸ªæ•°å­¦æ•™å¸ˆ Agentï¼Œèƒ½å¤Ÿï¼š</p><ul><li>è§£ç­”æ•°å­¦é—®é¢˜</li><li>éªŒè¯ç­”æ¡ˆ</li><li>ç»™å‡ºè¯¦ç»†æ­¥éª¤</li></ul></li><li><p><strong>ç»ƒä¹  3ï¼šç»“æ„åŒ–è¾“å‡º</strong>
åˆ›å»ºä¸€ä¸ªæ–°é—»æ‘˜è¦ Agentï¼Œè¾“å‡ºåŒ…å«ï¼šæ ‡é¢˜ã€æ‘˜è¦ã€å…³é”®è¯ã€æƒ…æ„Ÿåˆ†æã€‚</p></li><li><p><strong>ç»ƒä¹  4ï¼šé”™è¯¯å¤„ç†</strong>
å®ç°ä¸€ä¸ªå¥å£®çš„ Agentï¼Œèƒ½å¤Ÿå¤„ç†ï¼š</p><ul><li>å·¥å…·è°ƒç”¨å¤±è´¥</li><li>è¶…è¿‡æœ€å¤§è¿­ä»£æ¬¡æ•°</li><li>æ— æ•ˆè¾“å…¥</li></ul></li><li><p><strong>æ€è€ƒé¢˜ï¼š</strong></p><ul><li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªä»»åŠ¡åº”è¯¥ä½¿ç”¨ Agent è¿˜æ˜¯ Chainï¼Ÿ</li><li>recursion_limit è®¾ç½®è¿‡å°æˆ–è¿‡å¤§ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªå¥½çš„ system_promptï¼Ÿ</li></ul></li></ol><hr><h2 id=ç¬¬3ç« å®æˆ˜æ¡ˆä¾‹rag-agent>ç¬¬3ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šRAG Agent<a class=anchor href=#%e7%ac%ac3%e7%ab%a0%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8brag-agent>#</a></h2><h3 id=31-rag-åŸºç¡€æ¦‚å¿µ>3.1 RAG åŸºç¡€æ¦‚å¿µ<a class=anchor href=#31-rag-%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5>#</a></h3><h4 id=311-æ–‡æ¡£å¤„ç†æµç¨‹>3.1.1 æ–‡æ¡£å¤„ç†æµç¨‹<a class=anchor href=#311-%e6%96%87%e6%a1%a3%e5%a4%84%e7%90%86%e6%b5%81%e7%a8%8b>#</a></h4><p><strong>ä»€ä¹ˆæ˜¯ RAGï¼Ÿ</strong></p><p>RAGï¼ˆRetrieval-Augmented Generationï¼‰æ˜¯ä¸€ç§ç»“åˆ<strong>æ£€ç´¢</strong>å’Œ<strong>ç”Ÿæˆ</strong>çš„æŠ€æœ¯ï¼Œé€šè¿‡ä»å¤–éƒ¨çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥å¢å¼º LLM çš„å›ç­”èƒ½åŠ›ã€‚</p><p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong>ï¼š</p><ul><li>âœ… è§£å†³ LLM çŸ¥è¯†æˆªæ­¢æ—¥æœŸé—®é¢˜</li><li>âœ… æä¾›å¯éªŒè¯çš„ä¿¡æ¯æ¥æº</li><li>âœ… é™ä½å¹»è§‰ï¼ˆHallucinationï¼‰</li><li>âœ… æ”¯æŒç§æœ‰çŸ¥è¯†åº“</li></ul><pre class=mermaid>graph LR
    A[ç”¨æˆ·é—®é¢˜] --&gt; B[æ£€ç´¢ç›¸å…³æ–‡æ¡£]
    B --&gt; C[å‘é‡æ•°æ®åº“]
    C --&gt; D[è¿”å› Top-K æ–‡æ¡£]
    D --&gt; E[æ„å»º Context]
    E --&gt; F[LLM ç”Ÿæˆç­”æ¡ˆ]
    F --&gt; G[è¿”å›ç­”æ¡ˆ + æ¥æº]

    style B fill:#E3F2FD
    style C fill:#FFF9C4
    style F fill:#C8E6C9</pre><p><strong>RAG å®Œæ•´æµç¨‹</strong></p><pre class=mermaid>flowchart TD
    A[ç¦»çº¿ï¼šæ–‡æ¡£å¤„ç†] --&gt; B[æ–‡æ¡£åŠ è½½]
    B --&gt; C[æ–‡æ¡£åˆ†å— Chunking]
    C --&gt; D[å‘é‡åŒ– Embedding]
    D --&gt; E[å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“]

    F[åœ¨çº¿ï¼šæŸ¥è¯¢å¤„ç†] --&gt; G[ç”¨æˆ·é—®é¢˜]
    G --&gt; H[é—®é¢˜å‘é‡åŒ–]
    H --&gt; I[ç›¸ä¼¼åº¦æ£€ç´¢]
    I --&gt; E
    E --&gt; J[è¿”å› Top-K æ–‡æ¡£]
    J --&gt; K[LLM ç”Ÿæˆç­”æ¡ˆ]

    style A fill:#FFE0B2
    style F fill:#C5E1A5</pre><p><strong>æ–‡æ¡£åˆ†å—ç­–ç•¥</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºåˆ†å—å™¨</span>
</span></span><span class=line><span class=cl><span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>        <span class=c1># æ¯å—å¤§å°</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span><span class=p>,</span>      <span class=c1># å—ä¹‹é—´çš„é‡å </span>
</span></span><span class=line><span class=cl>    <span class=n>length_function</span><span class=o>=</span><span class=nb>len</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>separators</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>]</span>  <span class=c1># åˆ†å‰²ä¼˜å…ˆçº§</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ†å—æ–‡æ¡£</span>
</span></span><span class=line><span class=cl><span class=n>chunks</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_text</span><span class=p>(</span><span class=n>long_document</span><span class=p>)</span></span></span></code></pre></div><p><strong>åˆ†å—ç­–ç•¥å¯¹æ¯”</strong>ï¼š</p><table><thead><tr><th>ç­–ç•¥</th><th>chunk_size</th><th>chunk_overlap</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>å°å—</td><td>200-500</td><td>50-100</td><td>ç²¾ç¡®æ£€ç´¢</td></tr><tr><td>ä¸­å—</td><td>500-1000</td><td>100-200</td><td>å¹³è¡¡æ€§èƒ½</td></tr><tr><td>å¤§å—</td><td>1000-2000</td><td>200-400</td><td>ä¿æŒä¸Šä¸‹æ–‡</td></tr></tbody></table><hr><h4 id=312-å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥>3.1.2 å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥<a class=anchor href=#312-%e5%90%91%e9%87%8f%e5%8c%96%e4%b8%8e%e6%a3%80%e7%b4%a2%e7%ad%96%e7%95%a5>#</a></h4><p><strong>å‘é‡åŒ–ï¼ˆEmbeddingï¼‰</strong></p><p>å°†æ–‡æœ¬è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»º Embedding æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-small&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å‘é‡åŒ–æ–‡æœ¬</span>
</span></span><span class=line><span class=cl><span class=n>vector</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=s2>&#34;What is LangChain?&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>vector</span><span class=p>))</span>  <span class=c1># 1536 ç»´åº¦</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ‰¹é‡å‘é‡åŒ–</span>
</span></span><span class=line><span class=cl><span class=n>vectors</span> <span class=o>=</span> <span class=n>embeddings</span><span class=o>.</span><span class=n>embed_documents</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Document 1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Document 2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Document 3&#34;</span>
</span></span><span class=line><span class=cl><span class=p>])</span></span></span></code></pre></div><p><strong>å‘é‡æ•°æ®åº“</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>  <span class=c1># âœ… æ–°ç‰ˆï¼šä½¿ç”¨ langchain_chroma åŒ…</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºå‘é‡æ•°æ®åº“ï¼ˆè‡ªåŠ¨æŒä¹…åŒ–ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>chunks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./chroma_db&#34;</span>  <span class=c1># æŒ‡å®šç›®å½•å³è‡ªåŠ¨æŒä¹…åŒ–</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># âš ï¸ æ³¨æ„ï¼šChroma 0.4.x+ å·²åºŸå¼ƒ .persist() æ–¹æ³•</span>
</span></span><span class=line><span class=cl><span class=c1># ç°åœ¨åªéœ€æŒ‡å®š persist_directory å‚æ•°å³å¯è‡ªåŠ¨æŒä¹…åŒ–</span></span></span></code></pre></div><p><strong>æ£€ç´¢ç­–ç•¥</strong></p><p><strong>1. ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆSimilarity Searchï¼‰</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># åŸºç¡€ç›¸ä¼¼åº¦æ£€ç´¢</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;What is LangChain?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=o>=</span><span class=mi>4</span>  <span class=c1># è¿”å› Top-4</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=p>)</span></span></span></code></pre></div><p><strong>2. MMRï¼ˆæœ€å¤§è¾¹é™…ç›¸å…³æ€§ï¼‰</strong></p><p>å¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># MMR æ£€ç´¢</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>max_marginal_relevance_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;What is LangChain?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=o>=</span><span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fetch_k</span><span class=o>=</span><span class=mi>20</span><span class=p>,</span>  <span class=c1># å…ˆæ£€ç´¢20ä¸ª</span>
</span></span><span class=line><span class=cl>    <span class=n>lambda_mult</span><span class=o>=</span><span class=mf>0.5</span>  <span class=c1># 0=å¤šæ ·æ€§, 1=ç›¸å…³æ€§</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>3. å¸¦åˆ†æ•°çš„æ£€ç´¢</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è·å–ç›¸ä¼¼åº¦åˆ†æ•°</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search_with_score</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=s2>&#34;What is LangChain?&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=o>=</span><span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Score: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=32-rag-agent-å®ç°>3.2 RAG Agent å®ç°<a class=anchor href=#32-rag-agent-%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=321-æ„å»ºæ£€ç´¢å·¥å…·>3.2.1 æ„å»ºæ£€ç´¢å·¥å…·<a class=anchor href=#321-%e6%9e%84%e5%bb%ba%e6%a3%80%e7%b4%a2%e5%b7%a5%e5%85%b7>#</a></h4><p><strong>å®Œæ•´ RAG å·¥å…·å®ç°</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.document_loaders</span> <span class=kn>import</span> <span class=n>TextLoader</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_text_splitters</span> <span class=kn>import</span> <span class=n>RecursiveCharacterTextSplitter</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ­¥éª¤1ï¼šåŠ è½½æ–‡æ¡£</span>
</span></span><span class=line><span class=cl><span class=c1># TextLoader ç”¨äºåŠ è½½çº¯æ–‡æœ¬æ–‡ä»¶</span>
</span></span><span class=line><span class=cl><span class=n>loader</span> <span class=o>=</span> <span class=n>TextLoader</span><span class=p>(</span><span class=s2>&#34;knowledge_base.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>documents</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]</span> <span class=o>=</span> <span class=n>loader</span><span class=o>.</span><span class=n>load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ­¥éª¤2ï¼šæ–‡æ¡£åˆ†å—</span>
</span></span><span class=line><span class=cl><span class=c1># RecursiveCharacterTextSplitter é€’å½’åœ°æŒ‰å­—ç¬¦åˆ†å‰²æ–‡æ¡£</span>
</span></span><span class=line><span class=cl><span class=n>text_splitter</span> <span class=o>=</span> <span class=n>RecursiveCharacterTextSplitter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>  <span class=c1># æ¯ä¸ªå—çš„ç›®æ ‡å¤§å°ï¼ˆå­—ç¬¦æ•°ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>chunk_overlap</span><span class=o>=</span><span class=mi>200</span>  <span class=c1># å—ä¹‹é—´çš„é‡å ï¼ˆä¿æŒä¸Šä¸‹æ–‡è¿ç»­æ€§ï¼‰</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>chunks</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]</span> <span class=o>=</span> <span class=n>text_splitter</span><span class=o>.</span><span class=n>split_documents</span><span class=p>(</span><span class=n>documents</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ­¥éª¤3ï¼šåˆ›å»ºå‘é‡æ•°æ®åº“ï¼ˆè‡ªåŠ¨æŒä¹…åŒ–ï¼‰</span>
</span></span><span class=line><span class=cl><span class=c1># Embeddings æ¨¡å‹å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡</span>
</span></span><span class=line><span class=cl><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-small&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chroma æ˜¯å‘é‡æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨å’Œæ£€ç´¢æ–‡æ¡£å‘é‡</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=n>chunks</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>persist_directory</span><span class=o>=</span><span class=s2>&#34;./db&#34;</span>  <span class=c1># æŒ‡å®šç›®å½•å³è‡ªåŠ¨æŒä¹…åŒ–</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ­¥éª¤4ï¼šåˆ›å»ºæ£€ç´¢å·¥å…·</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_knowledge_base</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search the knowledge base for relevant information.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: The search query string
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        str: Formatted search results with document numbers
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ£€ç´¢ Top-3 ç›¸å…³æ–‡æ¡£ï¼ˆåŸºäºä½™å¼¦ç›¸ä¼¼åº¦ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ ¼å¼åŒ–ç»“æœï¼Œæ·»åŠ æ–‡æ¡£ç¼–å·</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>docs</span><span class=p>,</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Document </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>]</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>results</span><span class=p>)</span></span></span></code></pre></div><p><strong>é«˜çº§æ£€ç´¢å·¥å…·</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>advanced_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>filter_metadata</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_results</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Advanced search with metadata filters.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: The search query string
</span></span></span><span class=line><span class=cl><span class=s2>        filter_metadata: Optional filter in format &#39;key:value&#39; (e.g., &#39;source:api&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>        max_results: Maximum number of results to return
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        str: JSON string of search results with metadata
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. æ„å»ºè¿‡æ»¤å™¨å­—å…¸</span>
</span></span><span class=line><span class=cl>    <span class=n>filter_dict</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>filter_metadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è§£æ &#39;key:value&#39; æ ¼å¼çš„è¿‡æ»¤å™¨</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>filter_metadata</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>filter_dict</span> <span class=o>=</span> <span class=p>{</span><span class=n>key</span><span class=p>:</span> <span class=n>value</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. æ‰§è¡Œæ£€ç´¢ï¼ˆå¸¦è¿‡æ»¤å™¨ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>k</span><span class=o>=</span><span class=n>max_results</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nb>filter</span><span class=o>=</span><span class=n>filter_dict</span>  <span class=c1># Chroma æ”¯æŒçš„å…ƒæ•°æ®è¿‡æ»¤</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. æ ¼å¼åŒ–è¾“å‡ºï¼ˆåŒ…å«å…ƒæ•°æ®ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;source&#34;</span><span class=p>,</span> <span class=s2>&#34;unknown&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;page&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;page&#34;</span><span class=p>,</span> <span class=s2>&#34;N/A&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>results</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=322-ç³»ç»Ÿæç¤ºè¯è®¾è®¡>3.2.2 ç³»ç»Ÿæç¤ºè¯è®¾è®¡<a class=anchor href=#322-%e7%b3%bb%e7%bb%9f%e6%8f%90%e7%a4%ba%e8%af%8d%e8%ae%be%e8%ae%a1>#</a></h4><p><strong>RAG Agent æç¤ºè¯æ¨¡æ¿</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a helpful AI assistant with access to a knowledge base.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Your capabilities:
</span></span></span><span class=line><span class=cl><span class=s2>- Search the knowledge base for accurate information
</span></span></span><span class=line><span class=cl><span class=s2>- Provide detailed answers based on retrieved documents
</span></span></span><span class=line><span class=cl><span class=s2>- Cite sources for all factual claims
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Guidelines:
</span></span></span><span class=line><span class=cl><span class=s2>1. ALWAYS search the knowledge base before answering factual questions
</span></span></span><span class=line><span class=cl><span class=s2>2. Quote relevant passages from the documents
</span></span></span><span class=line><span class=cl><span class=s2>3. If information is not in the knowledge base, clearly state that
</span></span></span><span class=line><span class=cl><span class=s2>4. Cite document numbers when referencing information
</span></span></span><span class=line><span class=cl><span class=s2>5. Be concise but thorough
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Response format:
</span></span></span><span class=line><span class=cl><span class=s2>- Answer the question directly
</span></span></span><span class=line><span class=cl><span class=s2>- Include relevant quotes in &#34;quotation marks&#34;
</span></span></span><span class=line><span class=cl><span class=s2>- List sources at the end: [Document 1], [Document 2], etc.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Example:
</span></span></span><span class=line><span class=cl><span class=s2>Question: What is LangChain?
</span></span></span><span class=line><span class=cl><span class=s2>Answer: LangChain is &#34;a framework for developing applications powered by
</span></span></span><span class=line><span class=cl><span class=s2>language models&#34; [Document 1]. It provides tools for &#34;building applications
</span></span></span><span class=line><span class=cl><span class=s2>that combine LLMs with other sources of knowledge&#34; [Document 2].
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Sources: [Document 1], [Document 2]
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><hr><h4 id=323-è¿è¡Œä¸ä¼˜åŒ–æŸ¥è¯¢é‡å†™ç›¸å…³æ€§è¯„åˆ†>3.2.3 è¿è¡Œä¸ä¼˜åŒ–ï¼ˆæŸ¥è¯¢é‡å†™ã€ç›¸å…³æ€§è¯„åˆ†ï¼‰<a class=anchor href=#323-%e8%bf%90%e8%a1%8c%e4%b8%8e%e4%bc%98%e5%8c%96%e6%9f%a5%e8%af%a2%e9%87%8d%e5%86%99%e7%9b%b8%e5%85%b3%e6%80%a7%e8%af%84%e5%88%86>#</a></h4><p><strong>åˆ›å»º RAG Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># é…ç½®æ¨¡å‹</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºå·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>search_knowledge_base</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»º RAG Agent</span>
</span></span><span class=line><span class=cl><span class=n>rag_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>system_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>åŸºç¡€ä½¿ç”¨</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ç®€å•é—®ç­”</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;What is LangChain?&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºç¤ºä¾‹ï¼š</span>
</span></span><span class=line><span class=cl><span class=c1># LangChain is &#34;a framework for developing applications powered by language</span>
</span></span><span class=line><span class=cl><span class=c1># models&#34; [Document 1]. It enables developers to &#34;combine LLMs with external</span>
</span></span><span class=line><span class=cl><span class=c1># data sources and APIs&#34; [Document 2].</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># Sources: [Document 1], [Document 2]</span></span></span></code></pre></div><p><strong>æŸ¥è¯¢é‡å†™ï¼ˆQuery Rewritingï¼‰</strong></p><p>æå‡æ£€ç´¢è´¨é‡ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>rewrite_and_search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Rewrite query for better retrieval, then search.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: Original user query
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ä½¿ç”¨ LLM é‡å†™æŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>    <span class=n>rewrite_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Rewrite this query to be more specific and
</span></span></span><span class=line><span class=cl><span class=s2>    search-friendly. Only output the rewritten query.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Original: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Rewritten:&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>rewritten</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>rewrite_prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># ä½¿ç”¨é‡å†™åçš„æŸ¥è¯¢æ£€ç´¢</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>rewritten</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>format_docs</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ·»åŠ åˆ°å·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>search_knowledge_base</span><span class=p>,</span> <span class=n>rewrite_and_search</span><span class=p>]</span></span></span></code></pre></div><p><strong>ç›¸å…³æ€§è¯„åˆ†ä¸è¿‡æ»¤</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>scored_search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>min_score</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.7</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Search with relevance score filtering.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: Search query
</span></span></span><span class=line><span class=cl><span class=s2>        min_score: Minimum relevance score (0-1)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># è·å–å¸¦åˆ†æ•°çš„ç»“æœ</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search_with_score</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¿‡æ»¤ä½åˆ†ç»“æœ</span>
</span></span><span class=line><span class=cl>    <span class=n>filtered_results</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>doc</span><span class=p>,</span> <span class=n>score</span><span class=p>)</span> <span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=n>min_score</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ ¼å¼åŒ–è¾“å‡º</span>
</span></span><span class=line><span class=cl>    <span class=n>output</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=ow>in</span> <span class=n>filtered_results</span><span class=p>[:</span><span class=mi>3</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[Score: </span><span class=si>{</span><span class=n>score</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>]</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>output</span><span class=p>)</span> <span class=k>if</span> <span class=n>output</span> <span class=k>else</span> <span class=s2>&#34;No relevant results found&#34;</span></span></span></code></pre></div><p><strong>å¤šæŸ¥è¯¢æ£€ç´¢</strong></p><p>å¢åŠ å¬å›ç‡ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multi_query_search</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Generate multiple queries and aggregate results.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: Original query
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># ç”Ÿæˆå¤šä¸ªæŸ¥è¯¢å˜ä½“</span>
</span></span><span class=line><span class=cl>    <span class=n>multi_query_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Generate 3 different versions of this query:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Original: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Output format (one per line):
</span></span></span><span class=line><span class=cl><span class=s2>    1. ...
</span></span></span><span class=line><span class=cl><span class=s2>    2. ...
</span></span></span><span class=line><span class=cl><span class=s2>    3. ...&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>variants</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>multi_query_prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å¯¹æ¯ä¸ªå˜ä½“æ£€ç´¢</span>
</span></span><span class=line><span class=cl>    <span class=n>all_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>variant</span> <span class=ow>in</span> <span class=n>variants</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>variant</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=n>k</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>all_docs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å»é‡å¹¶è¿”å›</span>
</span></span><span class=line><span class=cl>    <span class=n>unique_docs</span> <span class=o>=</span> <span class=nb>list</span><span class=p>({</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>:</span> <span class=n>doc</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>all_docs</span><span class=p>}</span><span class=o>.</span><span class=n>values</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>format_docs</span><span class=p>(</span><span class=n>unique_docs</span><span class=p>[:</span><span class=mi>5</span><span class=p>])</span></span></span></code></pre></div><p><strong>å®Œæ•´ RAG Agent ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å®šä¹‰ç»“æ„åŒ–è¾“å‡º</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RAGResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;RAG å“åº”æ ¼å¼&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>answer</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;å›ç­”å†…å®¹&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>quotes</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;å¼•ç”¨ç‰‡æ®µ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>sources</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ¥æºåˆ—è¡¨&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>confidence</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>ge</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span> <span class=n>le</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç½®ä¿¡åº¦&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºç»“æ„åŒ– RAG Agent</span>
</span></span><span class=line><span class=cl><span class=n>rag_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>search_knowledge_base</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>rewrite_and_search</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>scored_search</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>multi_query_search</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>response_format</span><span class=o>=</span><span class=n>RAGResponse</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>system_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Explain LangChain&#39;s architecture&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç»“æ„åŒ–è®¿é—®</span>
</span></span><span class=line><span class=cl><span class=n>rag_result</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;structured_response&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Answer: </span><span class=si>{</span><span class=n>rag_result</span><span class=o>.</span><span class=n>answer</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Quotes: </span><span class=si>{</span><span class=n>rag_result</span><span class=o>.</span><span class=n>quotes</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Sources: </span><span class=si>{</span><span class=n>rag_result</span><span class=o>.</span><span class=n>sources</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Confidence: </span><span class=si>{</span><span class=n>rag_result</span><span class=o>.</span><span class=n>confidence</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=æœ¬ç« å°ç»“-2>æœ¬ç« å°ç»“<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2>#</a></h3><p><strong>RAG æ ¸å¿ƒæµç¨‹</strong>ï¼š</p><ul><li>âœ… æ–‡æ¡£å¤„ç†ï¼šåŠ è½½ â†’ åˆ†å— â†’ å‘é‡åŒ– â†’ å­˜å‚¨</li><li>âœ… æ£€ç´¢ç­–ç•¥ï¼šç›¸ä¼¼åº¦æ£€ç´¢ã€MMRã€å¸¦åˆ†æ•°æ£€ç´¢</li><li>âœ… å·¥å…·æ„å»ºï¼šåŸºç¡€æ£€ç´¢ã€é«˜çº§è¿‡æ»¤ã€å¤šæŸ¥è¯¢</li></ul><p><strong>ä¼˜åŒ–æŠ€å·§</strong>ï¼š</p><ul><li>âœ… æŸ¥è¯¢é‡å†™ï¼šæå‡æ£€ç´¢è´¨é‡</li><li>âœ… ç›¸å…³æ€§è¯„åˆ†ï¼šè¿‡æ»¤ä½è´¨é‡ç»“æœ</li><li>âœ… å¤šæŸ¥è¯¢æ£€ç´¢ï¼šå¢åŠ å¬å›ç‡</li><li>âœ… ç»“æ„åŒ–è¾“å‡ºï¼šä¿è¯ç­”æ¡ˆè´¨é‡</li></ul><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>âœ… åˆé€‚çš„åˆ†å—å¤§å°ï¼ˆ500-1000ï¼‰</li><li>âœ… é€‚å½“çš„é‡å ï¼ˆ100-200ï¼‰</li><li>âœ… æ˜ç¡®çš„ç³»ç»Ÿæç¤ºè¯</li><li>âœ… å¼•ç”¨æ¥æºçš„éªŒè¯</li></ul><p><strong>è®¾è®¡å“²å­¦</strong>ï¼š</p><blockquote class=book-hint><p>æ£€ç´¢æ˜¯ä¸ºäº†å¢å¼ºï¼Œè€Œéæ›¿ä»£ LLM çš„æ¨ç†èƒ½åŠ›</p></blockquote><hr><h3 id=æ€è€ƒä¸ç»ƒä¹ -2>æ€è€ƒä¸ç»ƒä¹ <a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0-2>#</a></h3><ol><li><p><strong>ç»ƒä¹  1ï¼šåŸºç¡€ RAG</strong>
å®ç°ä¸€ä¸ªç®€å•çš„ RAG Agentï¼Œèƒ½å¤Ÿä»æœ¬åœ°æ–‡æ¡£ä¸­æ£€ç´¢å¹¶å›ç­”é—®é¢˜ã€‚</p></li><li><p><strong>ç»ƒä¹  2ï¼šæŸ¥è¯¢ä¼˜åŒ–</strong>
å®ç°æŸ¥è¯¢é‡å†™åŠŸèƒ½ï¼Œå¯¹æ¯”é‡å†™å‰åçš„æ£€ç´¢è´¨é‡ã€‚</p></li><li><p><strong>ç»ƒä¹  3ï¼šå¤šæ•°æ®æº</strong>
æ„å»ºä¸€ä¸ªæ”¯æŒå¤šä¸ªçŸ¥è¯†åº“çš„ RAG Agentï¼ˆå¦‚ï¼šæŠ€æœ¯æ–‡æ¡£ + API æ–‡æ¡£ï¼‰ã€‚</p></li><li><p><strong>ç»ƒä¹  4ï¼šå¼•ç”¨éªŒè¯</strong>
å®ç°ä¸€ä¸ªéªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ Agent çš„å¼•ç”¨ç¡®å®æ¥è‡ªæ£€ç´¢åˆ°çš„æ–‡æ¡£ã€‚</p></li><li><p><strong>æ€è€ƒé¢˜ï¼š</strong></p><ul><li>chunk_size å¤§å°å¦‚ä½•å½±å“æ£€ç´¢è´¨é‡ï¼Ÿ</li><li>MMR å’Œç›¸ä¼¼åº¦æ£€ç´¢æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li><li>å¦‚ä½•è¯„ä¼° RAG ç³»ç»Ÿçš„è´¨é‡ï¼Ÿ</li></ul></li></ol><hr><h2 id=ç¬¬4ç« å®æˆ˜æ¡ˆä¾‹sql-agent>ç¬¬4ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šSQL Agent<a class=anchor href=#%e7%ac%ac4%e7%ab%a0%e5%ae%9e%e6%88%98%e6%a1%88%e4%be%8bsql-agent>#</a></h2><h3 id=41-sql-agent-æ¶æ„>4.1 SQL Agent æ¶æ„<a class=anchor href=#41-sql-agent-%e6%9e%b6%e6%9e%84>#</a></h3><h4 id=411-æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–>4.1.1 æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–<a class=anchor href=#411-%e6%95%b0%e6%8d%ae%e5%ba%93%e8%bf%9e%e6%8e%a5%e4%b8%8e%e8%a1%a8%e7%bb%93%e6%9e%84%e8%8e%b7%e5%8f%96>#</a></h4><p><strong>æ•°æ®åº“è¿æ¥</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>create_engine</span><span class=p>,</span> <span class=n>inspect</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è¿æ¥æ•°æ®åº“ï¼ˆSQLite ç¤ºä¾‹ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>database_uri</span> <span class=o>=</span> <span class=s2>&#34;sqlite:///example.db&#34;</span>
</span></span><span class=line><span class=cl><span class=n>engine</span> <span class=o>=</span> <span class=n>create_engine</span><span class=p>(</span><span class=n>database_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æµ‹è¯•è¿æ¥</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>engine</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;SELECT 1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Database connected!&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>æ”¯æŒçš„æ•°æ®åº“ç±»å‹</strong>ï¼š</p><ul><li>SQLiteï¼š<code>sqlite:///database.db</code></li><li>PostgreSQLï¼š<code>postgresql://user:pass@localhost/db</code></li><li>MySQLï¼š<code>mysql://user:pass@localhost/db</code></li><li>SQL Serverï¼š<code>mssql://user:pass@localhost/db</code></li></ul><p><strong>è¡¨ç»“æ„è·å–å·¥å…·</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_table_schema</span><span class=p>(</span><span class=n>table_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Get database table schema information.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        table_name: Specific table name, or None for all tables
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>inspector</span> <span class=o>=</span> <span class=n>inspect</span><span class=p>(</span><span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>table_name</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è·å–ç‰¹å®šè¡¨çš„ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>        <span class=n>columns</span> <span class=o>=</span> <span class=n>inspector</span><span class=o>.</span><span class=n>get_columns</span><span class=p>(</span><span class=n>table_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>schema</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;Table: </span><span class=si>{</span><span class=n>table_name</span><span class=si>}</span><span class=se>\n</span><span class=s2>Columns:</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>col</span> <span class=ow>in</span> <span class=n>columns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>schema</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&#34;  - </span><span class=si>{</span><span class=n>col</span><span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> (</span><span class=si>{</span><span class=n>col</span><span class=p>[</span><span class=s1>&#39;type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>)</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>schema</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># è·å–æ‰€æœ‰è¡¨</span>
</span></span><span class=line><span class=cl>        <span class=n>table_names</span> <span class=o>=</span> <span class=n>inspector</span><span class=o>.</span><span class=n>get_table_names</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Available tables: </span><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>table_names</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_sample_data</span><span class=p>(</span><span class=n>table_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Get sample data from a table.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        table_name: Table name
</span></span></span><span class=line><span class=cl><span class=s2>        limit: Number of rows to return
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;SELECT * FROM </span><span class=si>{</span><span class=n>table_name</span><span class=si>}</span><span class=s2> LIMIT </span><span class=si>{</span><span class=n>limit</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_sql</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>df</span><span class=o>.</span><span class=n>to_string</span><span class=p>()</span></span></span></code></pre></div><hr><h4 id=412-sql-å·¥å…·å¼€å‘æŸ¥è¯¢å®‰å…¨é™åˆ¶>4.1.2 SQL å·¥å…·å¼€å‘ï¼ˆæŸ¥è¯¢ã€å®‰å…¨é™åˆ¶ï¼‰<a class=anchor href=#412-sql-%e5%b7%a5%e5%85%b7%e5%bc%80%e5%8f%91%e6%9f%a5%e8%af%a2%e5%ae%89%e5%85%a8%e9%99%90%e5%88%b6>#</a></h4><p><strong>SQL æŸ¥è¯¢å·¥å…·</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>execute_sql_query</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute a SQL SELECT query and return results.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: SQL SELECT query (READ ONLY)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸ SELECT</span>
</span></span><span class=line><span class=cl>    <span class=n>query_upper</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>query_upper</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;SELECT&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Error: Only SELECT queries are allowed&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å±é™©å…³é”®è¯æ£€æŸ¥</span>
</span></span><span class=line><span class=cl>    <span class=n>dangerous_keywords</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;DROP&#34;</span><span class=p>,</span> <span class=s2>&#34;DELETE&#34;</span><span class=p>,</span> <span class=s2>&#34;UPDATE&#34;</span><span class=p>,</span> <span class=s2>&#34;INSERT&#34;</span><span class=p>,</span> <span class=s2>&#34;ALTER&#34;</span><span class=p>,</span> <span class=s2>&#34;TRUNCATE&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>keyword</span> <span class=ow>in</span> <span class=n>dangerous_keywords</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>keyword</span> <span class=ow>in</span> <span class=n>query_upper</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>keyword</span><span class=si>}</span><span class=s2> operations are not allowed&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ‰§è¡ŒæŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>        <span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_sql</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>engine</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># é™åˆ¶è¿”å›è¡Œæ•°</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Warning: Result has </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>df</span><span class=p>)</span><span class=si>}</span><span class=s2> rows. Showing first 100:</span><span class=se>\n</span><span class=si>{</span><span class=n>df</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span><span class=o>.</span><span class=n>to_string</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>df</span><span class=o>.</span><span class=n>to_string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Error executing query: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>SQL æŸ¥è¯¢éªŒè¯å·¥å…·</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>validate_sql_query</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Validate SQL query syntax without executing.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: SQL query to validate
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># ä½¿ç”¨ EXPLAIN éªŒè¯æŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>engine</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;EXPLAIN </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Query syntax is valid&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Query validation failed: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>å®‰å…¨æ²™ç®±é…ç½®</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>event</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.pool</span> <span class=kn>import</span> <span class=n>Pool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®æŸ¥è¯¢è¶…æ—¶ï¼ˆ5ç§’ï¼‰</span>
</span></span><span class=line><span class=cl><span class=nd>@event.listens_for</span><span class=p>(</span><span class=n>Pool</span><span class=p>,</span> <span class=s2>&#34;connect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_timeout</span><span class=p>(</span><span class=n>dbapi_conn</span><span class=p>,</span> <span class=n>connection_record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>dbapi_conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;PRAGMA busy_timeout = 5000&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è®¾ç½®åªè¯»æ¨¡å¼</span>
</span></span><span class=line><span class=cl><span class=nd>@event.listens_for</span><span class=p>(</span><span class=n>Pool</span><span class=p>,</span> <span class=s2>&#34;connect&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>set_readonly</span><span class=p>(</span><span class=n>dbapi_conn</span><span class=p>,</span> <span class=n>connection_record</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>dbapi_conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;PRAGMA query_only = ON&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=42-sql-agent-å®ç°>4.2 SQL Agent å®ç°<a class=anchor href=#42-sql-agent-%e5%ae%9e%e7%8e%b0>#</a></h3><h4 id=421-ç³»ç»Ÿæç¤ºè¯ä¸-agent-åˆ›å»º>4.2.1 ç³»ç»Ÿæç¤ºè¯ä¸ Agent åˆ›å»º<a class=anchor href=#421-%e7%b3%bb%e7%bb%9f%e6%8f%90%e7%a4%ba%e8%af%8d%e4%b8%8e-agent-%e5%88%9b%e5%bb%ba>#</a></h4><p><strong>SQL Agent æç¤ºè¯</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>system_prompt</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;You are a SQL expert assistant with access to a database.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Your capabilities:
</span></span></span><span class=line><span class=cl><span class=s2>- Get table schemas and sample data
</span></span></span><span class=line><span class=cl><span class=s2>- Write and execute SQL SELECT queries
</span></span></span><span class=line><span class=cl><span class=s2>- Analyze query results and provide insights
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Guidelines:
</span></span></span><span class=line><span class=cl><span class=s2>1. ALWAYS check table schema before writing queries
</span></span></span><span class=line><span class=cl><span class=s2>2. Use get_sample_data to understand data format
</span></span></span><span class=line><span class=cl><span class=s2>3. Write clear, optimized SQL queries
</span></span></span><span class=line><span class=cl><span class=s2>4. Only use SELECT statements (no modifications)
</span></span></span><span class=line><span class=cl><span class=s2>5. Explain your query logic
</span></span></span><span class=line><span class=cl><span class=s2>6. Validate queries before execution
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Workflow:
</span></span></span><span class=line><span class=cl><span class=s2>1. User asks a question about data
</span></span></span><span class=line><span class=cl><span class=s2>2. Check relevant table schemas
</span></span></span><span class=line><span class=cl><span class=s2>3. (Optional) Get sample data to understand format
</span></span></span><span class=line><span class=cl><span class=s2>4. Write SQL query
</span></span></span><span class=line><span class=cl><span class=s2>5. Execute and analyze results
</span></span></span><span class=line><span class=cl><span class=s2>6. Provide clear answer with data
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Example:
</span></span></span><span class=line><span class=cl><span class=s2>User: &#34;How many users registered last month?&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Steps:
</span></span></span><span class=line><span class=cl><span class=s2>1. get_table_schema(&#34;users&#34;) â†’ check columns
</span></span></span><span class=line><span class=cl><span class=s2>2. execute_sql_query(&#34;SELECT COUNT(*) FROM users WHERE created_at &gt;= date(&#39;now&#39;, &#39;-1 month&#39;)&#34;)
</span></span></span><span class=line><span class=cl><span class=s2>3. Return: &#34;There were 150 new users registered last month.&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><p><strong>åˆ›å»º SQL Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ¨¡å‹é…ç½®</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å·¥å…·åˆ—è¡¨</span>
</span></span><span class=line><span class=cl><span class=n>sql_tools</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>get_table_schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>get_sample_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>execute_sql_query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>validate_sql_query</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»º SQL Agent</span>
</span></span><span class=line><span class=cl><span class=n>sql_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>sql_tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>system_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>åŸºç¡€ä½¿ç”¨</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ç®€å•æŸ¥è¯¢</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;How many products are in stock?&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¤æ‚åˆ†æ</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;What are the top 5 customers by total purchase amount?&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ—¶é—´åºåˆ—åˆ†æ</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Show monthly sales trend for the last 6 months&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span></span></span></code></pre></div><hr><h4 id=422-human-in-the-loop-å®¡æ‰¹æœºåˆ¶>4.2.2 Human-in-the-Loop å®¡æ‰¹æœºåˆ¶<a class=anchor href=#422-human-in-the-loop-%e5%ae%a1%e6%89%b9%e6%9c%ba%e5%88%b6>#</a></h4><p><strong>å®¡æ‰¹å·¥å…·å®ç°</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å…¨å±€å˜é‡å­˜å‚¨å¾…å®¡æ‰¹æŸ¥è¯¢</span>
</span></span><span class=line><span class=cl><span class=n>pending_approval</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>request_query_approval</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Request human approval for a SQL query.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: SQL query to approve
</span></span></span><span class=line><span class=cl><span class=s2>        reason: Reason for the query
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>approval_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;approval_</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>pending_approval</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>pending_approval</span><span class=p>[</span><span class=n>approval_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=n>reason</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;pending&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;Query requires approval: </span><span class=si>{</span><span class=n>approval_id</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Query: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Reason: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Status: Waiting for approval...
</span></span></span><span class=line><span class=cl><span class=s2>(Use approve_query(&#39;</span><span class=si>{</span><span class=n>approval_id</span><span class=si>}</span><span class=s2>&#39;) or reject_query(&#39;</span><span class=si>{</span><span class=n>approval_id</span><span class=si>}</span><span class=s2>&#39;))
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>approve_query</span><span class=p>(</span><span class=n>approval_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Approve a pending query (called by human).&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>approval_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>pending_approval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Approval ID not found&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>query</span> <span class=o>=</span> <span class=n>pending_approval</span><span class=p>[</span><span class=n>approval_id</span><span class=p>][</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>pending_approval</span><span class=p>[</span><span class=n>approval_id</span><span class=p>][</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;approved&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ‰§è¡ŒæŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>execute_sql_query</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Query approved and executed:</span><span class=se>\n</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>reject_query</span><span class=p>(</span><span class=n>approval_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Reject a pending query (called by human).&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>approval_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>pending_approval</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;Approval ID not found&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>pending_approval</span><span class=p>[</span><span class=n>approval_id</span><span class=p>][</span><span class=s2>&#34;status&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;rejected&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;Query rejected. Reason: </span><span class=si>{</span><span class=n>reason</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></div><p><strong>æ•æ„Ÿæ“ä½œæ£€æµ‹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>smart_sql_query</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Execute SQL query with automatic approval for sensitive operations.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: SQL query to execute
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>query_upper</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># å®šä¹‰éœ€è¦å®¡æ‰¹çš„æ“ä½œ</span>
</span></span><span class=line><span class=cl>    <span class=n>sensitive_patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;DELETE&#34;</span><span class=p>,</span> <span class=s2>&#34;Deleting data&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;UPDATE&#34;</span><span class=p>,</span> <span class=s2>&#34;Modifying data&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;DROP&#34;</span><span class=p>,</span> <span class=s2>&#34;Dropping tables&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;ALTER&#34;</span><span class=p>,</span> <span class=s2>&#34;Altering table structure&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;TRUNCATE&#34;</span><span class=p>,</span> <span class=s2>&#34;Truncating table&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ£€æŸ¥æ˜¯å¦æ˜¯æ•æ„Ÿæ“ä½œ</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>pattern</span><span class=p>,</span> <span class=n>reason</span> <span class=ow>in</span> <span class=n>sensitive_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>query_upper</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>request_query_approval</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=n>reason</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># éæ•æ„Ÿæ“ä½œç›´æ¥æ‰§è¡Œ</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>execute_sql_query</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>query</span><span class=p>)</span></span></span></code></pre></div><p><strong>å¸¦å®¡æ‰¹çš„ SQL Agent</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># æ›´æ–°ç³»ç»Ÿæç¤ºè¯</span>
</span></span><span class=line><span class=cl><span class=n>approval_system_prompt</span> <span class=o>=</span> <span class=n>system_prompt</span> <span class=o>+</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>IMPORTANT - Approval Policy:
</span></span></span><span class=line><span class=cl><span class=s2>- For SELECT queries on single tables: Execute directly
</span></span></span><span class=line><span class=cl><span class=s2>- For JOIN queries on multiple tables: Request approval
</span></span></span><span class=line><span class=cl><span class=s2>- For queries affecting &gt;1000 rows: Request approval
</span></span></span><span class=line><span class=cl><span class=s2>- For DELETE/UPDATE/DROP: ALWAYS request approval
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Use smart_sql_query() which handles approval automatically.
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºå¸¦å®¡æ‰¹çš„ Agent</span>
</span></span><span class=line><span class=cl><span class=n>sql_agent_with_approval</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>get_table_schema</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>get_sample_data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>smart_sql_query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>request_query_approval</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>approval_system_prompt</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ç®€å•æŸ¥è¯¢ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent_with_approval</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Count total orders&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1># ç›´æ¥è¿”å›ç»“æœ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ•æ„ŸæŸ¥è¯¢ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent_with_approval</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Delete all orders from last year&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1># è¿”å›: Query requires approval: approval_1</span>
</span></span><span class=line><span class=cl><span class=c1>#       Query: DELETE FROM orders WHERE year = 2024</span>
</span></span><span class=line><span class=cl><span class=c1>#       Status: Waiting for approval...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># äººå·¥å®¡æ‰¹</span>
</span></span><span class=line><span class=cl><span class=n>approval_result</span> <span class=o>=</span> <span class=n>approve_query</span><span class=p>(</span><span class=s2>&#34;approval_1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># æˆ–</span>
</span></span><span class=line><span class=cl><span class=n>rejection_result</span> <span class=o>=</span> <span class=n>reject_query</span><span class=p>(</span><span class=s2>&#34;approval_1&#34;</span><span class=p>,</span> <span class=s2>&#34;Not authorized&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>ç»“æ„åŒ– SQL å“åº”</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SQLQueryResult</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;SQL æŸ¥è¯¢ç»“æœ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ‰§è¡Œçš„ SQL æŸ¥è¯¢&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result_summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç»“æœæ‘˜è¦&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ•°æ®è¡¨æ ¼ï¼ˆå¦‚æœæœ‰ï¼‰&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>row_count</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;è¿”å›è¡Œæ•°&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>insights</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ•°æ®æ´å¯Ÿ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åˆ›å»ºç»“æ„åŒ– SQL Agent</span>
</span></span><span class=line><span class=cl><span class=n>sql_agent_structured</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>sql_tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>response_format</span><span class=o>=</span><span class=n>SQLQueryResult</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=n>system_prompt</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>sql_agent_structured</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;Top 5 products by sales&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sql_result</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s1>&#39;structured_response&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Query: </span><span class=si>{</span><span class=n>sql_result</span><span class=o>.</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Summary: </span><span class=si>{</span><span class=n>sql_result</span><span class=o>.</span><span class=n>result_summary</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Rows: </span><span class=si>{</span><span class=n>sql_result</span><span class=o>.</span><span class=n>row_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Insights: </span><span class=si>{</span><span class=n>sql_result</span><span class=o>.</span><span class=n>insights</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=æœ¬ç« å°ç»“-3>æœ¬ç« å°ç»“<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-3>#</a></h3><p><strong>SQL Agent æ ¸å¿ƒç»„ä»¶</strong>ï¼š</p><ul><li>âœ… æ•°æ®åº“è¿æ¥ï¼šSQLAlchemy ç»Ÿä¸€æ¥å£</li><li>âœ… è¡¨ç»“æ„å·¥å…·ï¼šè‡ªåŠ¨è·å– Schema å’Œæ ·æœ¬æ•°æ®</li><li>âœ… æŸ¥è¯¢å·¥å…·ï¼šå®‰å…¨çš„ SQL æ‰§è¡Œï¼ˆåªè¯»ï¼‰</li><li>âœ… å®¡æ‰¹æœºåˆ¶ï¼šHuman-in-the-Loop ä¿æŠ¤æ•æ„Ÿæ“ä½œ</li></ul><p><strong>å®‰å…¨æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>âœ… åªå…è®¸ SELECT æŸ¥è¯¢</li><li>âœ… å…³é”®è¯é»‘åå•ï¼ˆDROPã€DELETE ç­‰ï¼‰</li><li>âœ… æŸ¥è¯¢è¶…æ—¶æ§åˆ¶ï¼ˆ5ç§’ï¼‰</li><li>âœ… ç»“æœè¡Œæ•°é™åˆ¶ï¼ˆ100è¡Œï¼‰</li><li>âœ… æ•æ„Ÿæ“ä½œå®¡æ‰¹</li></ul><p><strong>ç³»ç»Ÿæç¤ºè¯è¦ç‚¹</strong>ï¼š</p><ul><li>âœ… æ˜ç¡®å·¥ä½œæµç¨‹</li><li>âœ… å¼ºè°ƒå®‰å…¨è§„åˆ™</li><li>âœ… æä¾›æŸ¥è¯¢ç¤ºä¾‹</li><li>âœ… è¯´æ˜å®¡æ‰¹ç­–ç•¥</li></ul><p><strong>è®¾è®¡å“²å­¦</strong>ï¼š</p><blockquote class=book-hint><p>ä¾¿åˆ©æ€§ä¸å®‰å…¨æ€§çš„å¹³è¡¡ï¼šç®€å•æŸ¥è¯¢å¿«é€Ÿæ‰§è¡Œï¼Œæ•æ„Ÿæ“ä½œäººå·¥å®¡æ‰¹</p></blockquote><hr><h3 id=æ€è€ƒä¸ç»ƒä¹ -3>æ€è€ƒä¸ç»ƒä¹ <a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0-3>#</a></h3><ol><li><p><strong>ç»ƒä¹  1ï¼šåŸºç¡€ SQL Agent</strong>
åˆ›å»ºä¸€ä¸ªç®€å•çš„ SQL Agentï¼Œèƒ½å¤ŸæŸ¥è¯¢ SQLite æ•°æ®åº“å¹¶å›ç­”é—®é¢˜ã€‚</p></li><li><p><strong>ç»ƒä¹  2ï¼šæŸ¥è¯¢ä¼˜åŒ–</strong>
å®ç°ä¸€ä¸ªæŸ¥è¯¢ä¼˜åŒ–å·¥å…·ï¼Œèƒ½å¤Ÿï¼š</p><ul><li>æ£€æµ‹æ…¢æŸ¥è¯¢</li><li>å»ºè®®ç´¢å¼•</li><li>ä¼˜åŒ– JOIN è¯­å¥</li></ul></li><li><p><strong>ç»ƒä¹  3ï¼šå¤šè¡¨åˆ†æ</strong>
æ„å»ºä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«è¡¨å…³ç³»å¹¶æ‰§è¡Œ JOIN æŸ¥è¯¢çš„ Agentã€‚</p></li><li><p><strong>ç»ƒä¹  4ï¼šå®¡æ‰¹ç³»ç»Ÿ</strong>
å®ç°ä¸€ä¸ªå®Œæ•´çš„å®¡æ‰¹å·¥ä½œæµï¼š</p><ul><li>è¯·æ±‚å®¡æ‰¹</li><li>é‚®ä»¶é€šçŸ¥</li><li>å®¡æ‰¹è®°å½•</li><li>è¶…æ—¶å¤„ç†</li></ul></li><li><p><strong>æ€è€ƒé¢˜ï¼š</strong></p><ul><li>å¦‚ä½•é˜²æ­¢ SQL æ³¨å…¥æ”»å‡»ï¼Ÿ</li><li>ä»€ä¹ˆæ ·çš„æŸ¥è¯¢åº”è¯¥éœ€è¦å®¡æ‰¹ï¼Ÿ</li><li>å¦‚ä½•å¤„ç†å¤§ç»“æœé›†ï¼ˆ>10000è¡Œï¼‰ï¼Ÿ</li><li>SQL Agent ä¸ RAG Agent æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ</li></ul></li></ol><hr><hr><h2 id=ç¬¬5ç« memory-ä¸ä¸Šä¸‹æ–‡ç®¡ç†>ç¬¬5ç« ï¼šMemory ä¸ä¸Šä¸‹æ–‡ç®¡ç†<a class=anchor href=#%e7%ac%ac5%e7%ab%a0memory-%e4%b8%8e%e4%b8%8a%e4%b8%8b%e6%96%87%e7%ae%a1%e7%90%86>#</a></h2><blockquote class=book-hint><p><strong>ç›®æ ‡</strong>: è®© Agent æ‹¥æœ‰è®°å¿†èƒ½åŠ›ï¼Œæ„å»ºæœ‰è¿ç»­æ€§çš„å¯¹è¯ç³»ç»Ÿ</p></blockquote><p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ„å»ºçš„ Agent éƒ½æ˜¯<strong>æ— è®°å¿†çš„</strong>â€”â€”æ¯æ¬¡å¯¹è¯éƒ½æ˜¯ç‹¬ç«‹çš„ï¼ŒAgent æ— æ³•è®°ä½ä¹‹å‰çš„äº¤äº’ã€‚æœ¬ç« å°†æ•™ä½ å¦‚ä½•è®© Agent æ‹¥æœ‰è®°å¿†ã€‚</p><h3 id=51-ä¸ºä»€ä¹ˆéœ€è¦-memory>5.1 ä¸ºä»€ä¹ˆéœ€è¦ Memory<a class=anchor href=#51-%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81-memory>#</a></h3><h4 id=511-æ— è®°å¿†-agent-çš„é—®é¢˜>5.1.1 æ— è®°å¿† Agent çš„é—®é¢˜<a class=anchor href=#511-%e6%97%a0%e8%ae%b0%e5%bf%86-agent-%e7%9a%84%e9%97%ae%e9%a2%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>BaseMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. åˆ›å»ºæ— è®°å¿† Agentï¼ˆæ²¡æœ‰ checkpointerï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[]</span>  <span class=c1># ç®€å•ç¤ºä¾‹ï¼Œä¸ä½¿ç”¨å·¥å…·</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. ç¬¬ä¸€è½®å¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=n>result1</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘å«å¼ ä¸‰&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result1</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ç¬¬äºŒè½®å¯¹è¯ï¼ˆæ–°çš„ invoke è°ƒç”¨ï¼ŒçŠ¶æ€è¢«é‡ç½®ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result2</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result2</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šæŠ±æ­‰ï¼Œæˆ‘ä¸çŸ¥é“ä½ çš„åå­—</span>
</span></span><span class=line><span class=cl><span class=c1># âŒ Agent å¿˜è®°äº†ç¬¬ä¸€è½®å¯¹è¯ï¼å› ä¸ºæ¯æ¬¡ invoke éƒ½æ˜¯å…¨æ–°çš„çŠ¶æ€</span></span></span></code></pre></div><h3 id=52-ä½¿ç”¨-langgraph-checkpointer-å®ç°è®°å¿†>5.2 ä½¿ç”¨ LangGraph Checkpointer å®ç°è®°å¿†<a class=anchor href=#52-%e4%bd%bf%e7%94%a8-langgraph-checkpointer-%e5%ae%9e%e7%8e%b0%e8%ae%b0%e5%bf%86>#</a></h3><p>LangChain 1.0 æ¨èä½¿ç”¨ <strong>LangGraph çš„ Checkpointer æœºåˆ¶</strong>æ¥å®ç°å¯¹è¯è®°å¿†ã€‚</p><h4 id=521-åŸºç¡€è®°å¿†å®ç°>5.2.1 åŸºç¡€è®°å¿†å®ç°<a class=anchor href=#521-%e5%9f%ba%e7%a1%80%e8%ae%b0%e5%bf%86%e5%ae%9e%e7%8e%b0>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.memory</span> <span class=kn>import</span> <span class=n>InMemorySaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. åˆ›å»º Checkpointerï¼ˆå†…å­˜å­˜å‚¨ï¼‰</span>
</span></span><span class=line><span class=cl><span class=c1># InMemorySaver ä¼šåœ¨å†…å­˜ä¸­ä¿å­˜å¯¹è¯å†å²</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>InMemorySaver</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºå¸¦è®°å¿†çš„ Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>  <span class=c1># ç®€å•ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span>  <span class=c1># å…³é”®ï¼ä¼ å…¥ checkpointer å¯ç”¨è®°å¿†</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ä½¿ç”¨ thread_id å®ç°ä¼šè¯éš”ç¦»</span>
</span></span><span class=line><span class=cl><span class=c1># thread_id ç”¨äºåŒºåˆ†ä¸åŒçš„å¯¹è¯ä¼šè¯</span>
</span></span><span class=line><span class=cl><span class=n>config</span><span class=p>:</span> <span class=n>RunnableConfig</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. ç¬¬ä¸€è½®å¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=n>result1</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘å«å¼ ä¸‰&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>  <span class=c1># ä¼ å…¥ configï¼ŒæŒ‡å®šä¼šè¯ ID</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result1</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šä½ å¥½å¼ ä¸‰ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. ç¬¬äºŒè½®å¯¹è¯ï¼ˆä½¿ç”¨åŒä¸€ä¸ª thread_idï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>result2</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>  <span class=c1># ä½¿ç”¨ç›¸åŒçš„ thread_id</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result2</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># âœ… è¾“å‡ºï¼šä½ å«å¼ ä¸‰</span>
</span></span><span class=line><span class=cl><span class=c1># æˆåŠŸè®°ä½äº†ä¹‹å‰çš„å¯¹è¯ï¼Checkpointer ä¿å­˜äº†å†å²æ¶ˆæ¯</span></span></span></code></pre></div><h4 id=522-æŒä¹…åŒ–è®°å¿†sqlite>5.2.2 æŒä¹…åŒ–è®°å¿†ï¼ˆSQLiteï¼‰<a class=anchor href=#522-%e6%8c%81%e4%b9%85%e5%8c%96%e8%ae%b0%e5%bf%86sqlite>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.sqlite</span> <span class=kn>import</span> <span class=n>SqliteSaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnableConfig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. ä½¿ç”¨ SQLite æŒä¹…åŒ–è®°å¿†</span>
</span></span><span class=line><span class=cl><span class=c1># è®°å¿†ä¼šä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ï¼Œé‡å¯ç¨‹åºåä»ç„¶å­˜åœ¨</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>SqliteSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=s2>&#34;./checkpoints.db&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºå¸¦æŒä¹…åŒ–è®°å¿†çš„ Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span>  <span class=c1># ä½¿ç”¨ SQLite checkpointer</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ä½¿ç”¨ä¼šè¯ ID</span>
</span></span><span class=line><span class=cl><span class=n>config</span><span class=p>:</span> <span class=n>RunnableConfig</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. æŸ¥è¯¢ä¹‹å‰çš„å¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=c1># å³ä½¿é‡å¯ç¨‹åºï¼Œä¹Ÿèƒ½è®°ä½ä¹‹å‰çš„å¯¹è¯å†…å®¹</span>
</span></span><span class=line><span class=cl><span class=n>result</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘ä¹‹å‰å‘Šè¯‰è¿‡ä½ ä»€ä¹ˆï¼Ÿ&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># å¦‚æœä¹‹å‰æœ‰å¯¹è¯ï¼ŒAgent ä¼šè®°å¾—</span></span></span></code></pre></div><h4 id=523-ç”Ÿäº§çº§è®°å¿†postgresql>5.2.3 ç”Ÿäº§çº§è®°å¿†ï¼ˆPostgreSQLï¼‰<a class=anchor href=#523-%e7%94%9f%e4%ba%a7%e7%ba%a7%e8%ae%b0%e5%bf%86postgresql>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.postgres</span> <span class=kn>import</span> <span class=n>PostgresSaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. ä½¿ç”¨ PostgreSQLï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰</span>
</span></span><span class=line><span class=cl><span class=c1># PostgreSQL æä¾›æ›´å¥½çš„æ€§èƒ½ã€å¹¶å‘æ”¯æŒå’Œæ•°æ®æŒä¹…æ€§</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>PostgresSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;postgresql://user:pass@localhost/chatdb&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºç”Ÿäº§çº§ Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ç”Ÿäº§ç¯å¢ƒä¼˜åŠ¿ï¼š</span>
</span></span><span class=line><span class=cl><span class=c1># - æ”¯æŒé«˜å¹¶å‘è®¿é—®</span>
</span></span><span class=line><span class=cl><span class=c1># - æ•°æ®å¤‡ä»½å’Œæ¢å¤</span>
</span></span><span class=line><span class=cl><span class=c1># - è·¨æœåŠ¡å™¨å…±äº«è®°å¿†</span>
</span></span><span class=line><span class=cl><span class=c1># - æ›´å¥½çš„æŸ¥è¯¢æ€§èƒ½</span></span></span></code></pre></div><h3 id=53-è®°å¿†ç®¡ç†æœ€ä½³å®è·µ>5.3 è®°å¿†ç®¡ç†æœ€ä½³å®è·µ<a class=anchor href=#53-%e8%ae%b0%e5%bf%86%e7%ae%a1%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><h4 id=531-ä¼šè¯éš”ç¦»>5.3.1 ä¼šè¯éš”ç¦»<a class=anchor href=#531-%e4%bc%9a%e8%af%9d%e9%9a%94%e7%a6%bb>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ä¸åŒç”¨æˆ·ä½¿ç”¨ä¸åŒçš„ thread_id</span>
</span></span><span class=line><span class=cl><span class=n>user1_config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-001&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=n>user2_config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-002&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç”¨æˆ·1çš„å¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘æ˜¯ç”¨æˆ·1&#34;</span><span class=p>)]},</span> <span class=n>config</span><span class=o>=</span><span class=n>user1_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç”¨æˆ·2çš„å¯¹è¯ï¼ˆå®Œå…¨ç‹¬ç«‹ï¼‰</span>
</span></span><span class=line><span class=cl><span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘æ˜¯ç”¨æˆ·2&#34;</span><span class=p>)]},</span> <span class=n>config</span><span class=o>=</span><span class=n>user2_config</span><span class=p>)</span></span></span></code></pre></div><h4 id=532-æŸ¥çœ‹å¯¹è¯å†å²>5.3.2 æŸ¥çœ‹å¯¹è¯å†å²<a class=anchor href=#532-%e6%9f%a5%e7%9c%8b%e5%af%b9%e8%af%9d%e5%8e%86%e5%8f%b2>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># è·å–æŸä¸ªä¼šè¯çš„å®Œæ•´å†å²</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.base</span> <span class=kn>import</span> <span class=n>Checkpoint</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=n>state</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>get_state</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æŸ¥çœ‹æ‰€æœ‰æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>msg</span> <span class=ow>in</span> <span class=n>state</span><span class=o>.</span><span class=n>values</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>msg</span><span class=o>.</span><span class=n>type</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>msg</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=533-æ¸…é™¤è®°å¿†>5.3.3 æ¸…é™¤è®°å¿†<a class=anchor href=#533-%e6%b8%85%e9%99%a4%e8%ae%b0%e5%bf%86>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># æ–¹æ³•1ï¼šä½¿ç”¨æ–°çš„ thread_id å¼€å§‹æ–°å¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=n>new_config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123-new-session&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æ–¹æ³•2ï¼šæ‰‹åŠ¨æ¸…é™¤ checkpointer ä¸­çš„æ•°æ®</span>
</span></span><span class=line><span class=cl><span class=c1># å…·ä½“æ–¹æ³•å–å†³äºä½¿ç”¨çš„ checkpointer ç±»å‹</span></span></span></code></pre></div><h3 id=54-æˆæœ¬ä¼˜åŒ–ç­–ç•¥>5.4 æˆæœ¬ä¼˜åŒ–ç­–ç•¥<a class=anchor href=#54-%e6%88%90%e6%9c%ac%e4%bc%98%e5%8c%96%e7%ad%96%e7%95%a5>#</a></h3><p>é•¿å¯¹è¯ä¼šå¯¼è‡´ token æ¶ˆè€—å¿«é€Ÿå¢é•¿ã€‚ä»¥ä¸‹æ˜¯ä¼˜åŒ–ç­–ç•¥ï¼š</p><h4 id=541-é™åˆ¶å†å²é•¿åº¦>5.4.1 é™åˆ¶å†å²é•¿åº¦<a class=anchor href=#541-%e9%99%90%e5%88%b6%e5%8e%86%e5%8f%b2%e9%95%bf%e5%ba%a6>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>trim_messages</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># åªä¿ç•™æœ€è¿‘çš„ 10 æ¡æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>limit_history</span><span class=p>(</span><span class=n>state</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯ + æœ€è¿‘10æ¡</span>
</span></span><span class=line><span class=cl>    <span class=n>trimmed</span> <span class=o>=</span> <span class=n>trim_messages</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>max_tokens</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;last&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>token_counter</span><span class=o>=</span><span class=nb>len</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>trimmed</span><span class=p>}</span></span></span></code></pre></div><h4 id=542-ä½¿ç”¨æ€»ç»“ç­–ç•¥>5.4.2 ä½¿ç”¨æ€»ç»“ç­–ç•¥<a class=anchor href=#542-%e4%bd%bf%e7%94%a8%e6%80%bb%e7%bb%93%e7%ad%96%e7%95%a5>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>summarizer</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>  <span class=c1># ä½¿ç”¨ä¾¿å®œæ¨¡å‹</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>summarize_history</span><span class=p>(</span><span class=n>messages</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¯¹å†å²å¯¹è¯è¿›è¡Œæ€»ç»“&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>messages</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># æ€»ç»“å‰é¢çš„æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl>    <span class=n>old_messages</span> <span class=o>=</span> <span class=n>messages</span><span class=p>[:</span><span class=o>-</span><span class=mi>5</span><span class=p>]</span>  <span class=c1># ä¿ç•™æœ€è¿‘5æ¡</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>summary_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;è¯·ç®€è¦æ€»ç»“ä»¥ä¸‹å¯¹è¯ï¼š
</span></span></span><span class=line><span class=cl><span class=s2>    </span><span class=si>{</span><span class=n>old_messages</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    æ€»ç»“ï¼š&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>summary</span> <span class=o>=</span> <span class=n>summarizer</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>summary_prompt</span><span class=p>)</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># è¿”å›æ€»ç»“ + æœ€è¿‘æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;ä¹‹å‰çš„å¯¹è¯æ€»ç»“ï¼š</span><span class=si>{</span><span class=n>summary</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>5</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span></span></span></code></pre></div><h3 id=55-ç»¼åˆå®æˆ˜å®¢æœæœºå™¨äºº>5.5 ç»¼åˆå®æˆ˜ï¼šå®¢æœæœºå™¨äºº<a class=anchor href=#55-%e7%bb%bc%e5%90%88%e5%ae%9e%e6%88%98%e5%ae%a2%e6%9c%8d%e6%9c%ba%e5%99%a8%e4%ba%ba>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.postgres</span> <span class=kn>import</span> <span class=n>PostgresSaver</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. å®šä¹‰å·¥å…·</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>query_order</span><span class=p>(</span><span class=n>order_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æŸ¥è¯¢è®¢å•çŠ¶æ€&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># æ¨¡æ‹ŸæŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;è®¢å• </span><span class=si>{</span><span class=n>order_id</span><span class=si>}</span><span class=s2> å·²å‘è´§ï¼Œé¢„è®¡æ˜å¤©é€è¾¾&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. åˆ›å»ºæŒä¹…åŒ– checkpointer</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>PostgresSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;postgresql://localhost/customer_service&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. åˆ›å»º Agent</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>query_order</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. å®¢æœå¯¹è¯</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>chat_with_customer</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;customer-</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>message</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl><span class=n>chat_with_customer</span><span class=p>(</span><span class=s2>&#34;user-456&#34;</span><span class=p>,</span> <span class=s2>&#34;ä½ å¥½ï¼Œæˆ‘å«æå››&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šä½ å¥½æå››ï¼</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>chat_with_customer</span><span class=p>(</span><span class=s2>&#34;user-456&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘çš„è®¢å•å·æ˜¯ 12345&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šå¥½çš„ï¼Œè®©æˆ‘æŸ¥ä¸€ä¸‹... è®¢å• 12345 å·²å‘è´§ï¼Œé¢„è®¡æ˜å¤©é€è¾¾</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç¬¬äºŒå¤©å®¢æˆ·å†æ¬¡å’¨è¯¢</span>
</span></span><span class=line><span class=cl><span class=n>chat_with_customer</span><span class=p>(</span><span class=s2>&#34;user-456&#34;</span><span class=p>,</span> <span class=s2>&#34;æˆ‘æ˜¨å¤©é—®çš„è®¢å•åˆ°äº†å—ï¼Ÿ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># è¾“å‡ºï¼šæ‚¨æ˜¨å¤©å’¨è¯¢çš„è®¢å• 12345 åº”è¯¥ä»Šå¤©é€è¾¾</span>
</span></span><span class=line><span class=cl><span class=c1># âœ… Agent è®°ä½äº†ä¹‹å‰çš„è®¢å•å·ï¼</span></span></span></code></pre></div><h3 id=56-æœ¬ç« å°ç»“>5.6 æœ¬ç« å°ç»“<a class=anchor href=#56-%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h3><p><strong>LangChain 1.0 è®°å¿†æœºåˆ¶</strong>ï¼š</p><ul><li>âœ… ä½¿ç”¨ <strong>Checkpointer</strong> è€Œéæ—§çš„ Memory ç±»</li><li>âœ… ä¸‰ç§ Checkpointerï¼šInMemorySaverã€SqliteSaverã€PostgresSaver</li><li>âœ… é€šè¿‡ <strong>thread_id</strong> å®ç°ä¼šè¯éš”ç¦»</li><li>âœ… æ”¯æŒæŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±</li></ul><p><strong>æœ€ä½³å®è·µ</strong>ï¼š</p><ul><li>âœ… å¼€å‘æµ‹è¯•ï¼šInMemorySaver</li><li>âœ… å•æœºéƒ¨ç½²ï¼šSqliteSaver</li><li>âœ… ç”Ÿäº§ç¯å¢ƒï¼šPostgresSaver</li><li>âœ… æˆæœ¬æ§åˆ¶ï¼šé™åˆ¶å†å²é•¿åº¦æˆ–æ€»ç»“ç­–ç•¥</li></ul><p><strong>ä¸‹ä¸€æ­¥</strong>ï¼šç¬¬ä¸‰ç¯‡å°†æ·±å…¥ LangGraphï¼Œæ•™ä½ å®Œå…¨è‡ªå®šä¹‰ Agent çš„æ‰§è¡Œæµç¨‹å’ŒçŠ¶æ€ç®¡ç†ã€‚</p><hr><p><strong>ç¬¬äºŒç¯‡å®Œç»“</strong></p><p>æ­å–œï¼ä½ å·²ç»å®Œæˆäº†ã€Šå¿«é€Ÿä¸Šæ‰‹å®æˆ˜ã€‹ç¯‡çš„å­¦ä¹ ï¼š</p><ul><li>âœ… ç¬¬3ç« ï¼šMessage ä¸ Tools åŸºç¡€</li><li>âœ… ç¬¬4ç« ï¼šcreate_agent å¿«é€Ÿæ„å»º</li><li>âœ… ç¬¬5ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šRAG Agent</li><li>âœ… ç¬¬6ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šSQL Agent</li><li>âœ… ç¬¬7ç« ï¼šMemory ä¸ä¸Šä¸‹æ–‡ç®¡ç†</li></ul><p><strong>ä¸‹ä¸€æ­¥</strong>ï¼šç¬¬ä¸‰ç¯‡ã€ŠLangGraph æ·±å…¥ã€‹å°†å¸¦ä½ ç†è§£ create_agent èƒŒåçš„æœºåˆ¶ï¼ŒæŒæ¡å®Œå…¨è‡ªå®šä¹‰èƒ½åŠ›ã€‚</p></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[ç»Ÿè®¡ç»„ä»¶ä»…åœ¨ç”Ÿäº§ç¯å¢ƒæ˜¾ç¤º]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>ç¬¬ä¸€ç¯‡ åŸºç¡€è®¤çŸ¥</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/ class="flex align-center"><span>ç¬¬ä¸‰ç¯‡ LangGraph æ·±å…¥</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#-å‰ç½®çŸ¥è¯†è¯´æ˜>ğŸ“Œ å‰ç½®çŸ¥è¯†è¯´æ˜</a></li><li><a href=#ç¬¬1ç« message-ä¸-tools-åŸºç¡€>ç¬¬1ç« ï¼šMessage ä¸ Tools åŸºç¡€</a><ul><li><a href=#11-message-æ¶ˆæ¯ç³»ç»Ÿ>1.1 Message æ¶ˆæ¯ç³»ç»Ÿ</a><ul><li><a href=#111-æ¶ˆæ¯ç±»å‹humanmessageaimessagesystemmessagetoolmessage>1.1.1 æ¶ˆæ¯ç±»å‹ï¼šHumanMessageã€AIMessageã€SystemMessageã€ToolMessage</a></li><li><a href=#112-content-blocks-æ ¸å¿ƒåˆ›æ–°texttool-usethinkingimage>1.1.2 Content Blocks æ ¸å¿ƒåˆ›æ–°ï¼ˆTextã€Tool Useã€Thinkingã€Imageï¼‰</a></li><li><a href=#113-è·¨-provider-ç»Ÿä¸€å¤„ç†>1.1.3 è·¨ Provider ç»Ÿä¸€å¤„ç†</a></li><li><a href=#114-å¤šæ¨¡æ€æ”¯æŒ>1.1.4 å¤šæ¨¡æ€æ”¯æŒ</a></li></ul></li><li><a href=#12-tools-å·¥å…·ä½“ç³»>1.2 Tools å·¥å…·ä½“ç³»</a><ul><li><a href=#121-å·¥å…·å®šä¹‰æ–¹å¼toolstructuredtoolbasetool>1.2.1 å·¥å…·å®šä¹‰æ–¹å¼ï¼š@toolã€StructuredToolã€BaseTool</a></li><li><a href=#122-å‚æ•°-schemapydantic>1.2.2 å‚æ•° Schemaï¼ˆPydanticï¼‰</a></li><li><a href=#123-å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨>1.2.3 å·¥å…·è°ƒç”¨æœºåˆ¶ä¸å¹¶è¡Œè°ƒç”¨</a></li><li><a href=#124-é”™è¯¯å¤„ç†ç­–ç•¥>1.2.4 é”™è¯¯å¤„ç†ç­–ç•¥</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ >æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬2ç« create_agent-å¿«é€Ÿæ„å»º>ç¬¬2ç« ï¼šcreate_agent å¿«é€Ÿæ„å»º</a><ul><li><a href=#21-agent-åŸºæœ¬æ¦‚å¿µ>2.1 Agent åŸºæœ¬æ¦‚å¿µ</a><ul><li><a href=#211-agent-å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯>2.1.1 Agent å®šä¹‰ä¸æ‰§è¡Œå¾ªç¯</a></li><li><a href=#212-agent-ä¸-chain-çš„æœ¬è´¨åŒºåˆ«>2.1.2 Agent ä¸ Chain çš„æœ¬è´¨åŒºåˆ«</a></li><li><a href=#213-é€‚ç”¨åœºæ™¯åˆ†æ>2.1.3 é€‚ç”¨åœºæ™¯åˆ†æ</a></li></ul></li><li><a href=#22-æ ¸å¿ƒå‚æ•°è¯¦è§£>2.2 æ ¸å¿ƒå‚æ•°è¯¦è§£</a><ul><li><a href=#221-modeltoolssystem_prompt>2.2.1 modelã€toolsã€system_prompt</a></li><li><a href=#222-è¿›é˜¶é…ç½®middleware-ç®€ä»‹>2.2.2 è¿›é˜¶é…ç½®ï¼šMiddleware ç®€ä»‹</a></li><li><a href=#223-response_format-ç»“æ„åŒ–è¾“å‡º>2.2.3 response_format ç»“æ„åŒ–è¾“å‡º</a></li></ul></li><li><a href=#23-ç¬¬ä¸€ä¸ª-agent-å®æˆ˜>2.3 ç¬¬ä¸€ä¸ª Agent å®æˆ˜</a><ul><li><a href=#231-ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰>2.3.1 ç¯å¢ƒå‡†å¤‡ä¸å·¥å…·å®šä¹‰</a></li><li><a href=#232-åˆ›å»º-agent-ä¸è¿è¡Œè°ƒè¯•>2.3.2 åˆ›å»º Agent ä¸è¿è¡Œè°ƒè¯•</a></li><li><a href=#233-ç»“æ„åŒ–è¾“å‡ºpydantic-schema>2.3.3 ç»“æ„åŒ–è¾“å‡ºï¼ˆPydantic Schemaï¼‰</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-1>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -1>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬3ç« å®æˆ˜æ¡ˆä¾‹rag-agent>ç¬¬3ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šRAG Agent</a><ul><li><a href=#31-rag-åŸºç¡€æ¦‚å¿µ>3.1 RAG åŸºç¡€æ¦‚å¿µ</a><ul><li><a href=#311-æ–‡æ¡£å¤„ç†æµç¨‹>3.1.1 æ–‡æ¡£å¤„ç†æµç¨‹</a></li><li><a href=#312-å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥>3.1.2 å‘é‡åŒ–ä¸æ£€ç´¢ç­–ç•¥</a></li></ul></li><li><a href=#32-rag-agent-å®ç°>3.2 RAG Agent å®ç°</a><ul><li><a href=#321-æ„å»ºæ£€ç´¢å·¥å…·>3.2.1 æ„å»ºæ£€ç´¢å·¥å…·</a></li><li><a href=#322-ç³»ç»Ÿæç¤ºè¯è®¾è®¡>3.2.2 ç³»ç»Ÿæç¤ºè¯è®¾è®¡</a></li><li><a href=#323-è¿è¡Œä¸ä¼˜åŒ–æŸ¥è¯¢é‡å†™ç›¸å…³æ€§è¯„åˆ†>3.2.3 è¿è¡Œä¸ä¼˜åŒ–ï¼ˆæŸ¥è¯¢é‡å†™ã€ç›¸å…³æ€§è¯„åˆ†ï¼‰</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-2>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -2>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬4ç« å®æˆ˜æ¡ˆä¾‹sql-agent>ç¬¬4ç« ï¼šå®æˆ˜æ¡ˆä¾‹ï¼šSQL Agent</a><ul><li><a href=#41-sql-agent-æ¶æ„>4.1 SQL Agent æ¶æ„</a><ul><li><a href=#411-æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–>4.1.1 æ•°æ®åº“è¿æ¥ä¸è¡¨ç»“æ„è·å–</a></li><li><a href=#412-sql-å·¥å…·å¼€å‘æŸ¥è¯¢å®‰å…¨é™åˆ¶>4.1.2 SQL å·¥å…·å¼€å‘ï¼ˆæŸ¥è¯¢ã€å®‰å…¨é™åˆ¶ï¼‰</a></li></ul></li><li><a href=#42-sql-agent-å®ç°>4.2 SQL Agent å®ç°</a><ul><li><a href=#421-ç³»ç»Ÿæç¤ºè¯ä¸-agent-åˆ›å»º>4.2.1 ç³»ç»Ÿæç¤ºè¯ä¸ Agent åˆ›å»º</a></li><li><a href=#422-human-in-the-loop-å®¡æ‰¹æœºåˆ¶>4.2.2 Human-in-the-Loop å®¡æ‰¹æœºåˆ¶</a></li></ul></li><li><a href=#æœ¬ç« å°ç»“-3>æœ¬ç« å°ç»“</a></li><li><a href=#æ€è€ƒä¸ç»ƒä¹ -3>æ€è€ƒä¸ç»ƒä¹ </a></li></ul></li><li><a href=#ç¬¬5ç« memory-ä¸ä¸Šä¸‹æ–‡ç®¡ç†>ç¬¬5ç« ï¼šMemory ä¸ä¸Šä¸‹æ–‡ç®¡ç†</a><ul><li><a href=#51-ä¸ºä»€ä¹ˆéœ€è¦-memory>5.1 ä¸ºä»€ä¹ˆéœ€è¦ Memory</a><ul><li><a href=#511-æ— è®°å¿†-agent-çš„é—®é¢˜>5.1.1 æ— è®°å¿† Agent çš„é—®é¢˜</a></li></ul></li><li><a href=#52-ä½¿ç”¨-langgraph-checkpointer-å®ç°è®°å¿†>5.2 ä½¿ç”¨ LangGraph Checkpointer å®ç°è®°å¿†</a><ul><li><a href=#521-åŸºç¡€è®°å¿†å®ç°>5.2.1 åŸºç¡€è®°å¿†å®ç°</a></li><li><a href=#522-æŒä¹…åŒ–è®°å¿†sqlite>5.2.2 æŒä¹…åŒ–è®°å¿†ï¼ˆSQLiteï¼‰</a></li><li><a href=#523-ç”Ÿäº§çº§è®°å¿†postgresql>5.2.3 ç”Ÿäº§çº§è®°å¿†ï¼ˆPostgreSQLï¼‰</a></li></ul></li><li><a href=#53-è®°å¿†ç®¡ç†æœ€ä½³å®è·µ>5.3 è®°å¿†ç®¡ç†æœ€ä½³å®è·µ</a><ul><li><a href=#531-ä¼šè¯éš”ç¦»>5.3.1 ä¼šè¯éš”ç¦»</a></li><li><a href=#532-æŸ¥çœ‹å¯¹è¯å†å²>5.3.2 æŸ¥çœ‹å¯¹è¯å†å²</a></li><li><a href=#533-æ¸…é™¤è®°å¿†>5.3.3 æ¸…é™¤è®°å¿†</a></li></ul></li><li><a href=#54-æˆæœ¬ä¼˜åŒ–ç­–ç•¥>5.4 æˆæœ¬ä¼˜åŒ–ç­–ç•¥</a><ul><li><a href=#541-é™åˆ¶å†å²é•¿åº¦>5.4.1 é™åˆ¶å†å²é•¿åº¦</a></li><li><a href=#542-ä½¿ç”¨æ€»ç»“ç­–ç•¥>5.4.2 ä½¿ç”¨æ€»ç»“ç­–ç•¥</a></li></ul></li><li><a href=#55-ç»¼åˆå®æˆ˜å®¢æœæœºå™¨äºº>5.5 ç»¼åˆå®æˆ˜ï¼šå®¢æœæœºå™¨äºº</a></li><li><a href=#56-æœ¬ç« å°ç»“>5.6 æœ¬ç« å°ç»“</a></li></ul></li></ul></nav></div></aside></main></body></html>