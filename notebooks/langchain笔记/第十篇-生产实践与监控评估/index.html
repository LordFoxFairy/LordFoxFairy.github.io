<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第十篇 生产实践与监控评估# 目标: 构建生产级LLM应用的完整体系
从监控追踪到架构设计,从性能优化到安全防护,从部署运维到故障排查,全面掌握生产环境的关键要素。
第1章：LangSmith Tracing 与 Evaluation# 关注点：掌握 Agent 执行的全链路可观测性，建立科学的评估框架。
1.1 追踪体系# 1.1.1 追踪原理与数据模型# 什么是追踪（Tracing）？
追踪是记录和分析 Agent 执行过程的完整链路，从用户输入开始，记录每一个中间步骤（模型调用、工具执行、状态变化），最终得到输出。LangSmith 追踪形成一棵执行树：
root_run (Agent 执行) ├── before_model_hook (Middleware) ├── model_call (模型调用) │ ├── system_prompt │ ├── messages │ └── tools ├── tool_run (工具执行) │ ├── search_tool │ └── get_weather_tool └── after_model_hook (后处理)追踪的核心作用：
调试：看到完整的执行链，快速定位问题 监控：追踪延迟、Token 成本、错误率等指标 优化：识别瓶颈，比较不同版本的性能差异 审计：记录谁做了什么，满足合规要求 数据模型：
class Run: id: str # 唯一 ID name: str # 运行名称 run_type: str # "agent", "model", "tool", "chain" 等 parent_run_id: Optional[str] # 父 Run ID（形成树关系） # 输入输出 inputs: dict[str, Any] # 输入参数 outputs: dict[str, Any] # 输出结果 # 时间和成本 start_time: datetime # 开始时间 end_time: datetime # 结束时间 duration: float # 执行耗时（秒） # Token 和成本 token_usage: Optional[TokenUsage] cost: Optional[float] # 美元成本 # 状态和错误 status: str # "success", "error" error: Optional[str] # 错误信息 # 元数据 metadata: dict[str, Any] # 自定义元数据 tags: list[str] # 标签（用于筛选） # 反馈 feedback_records: list[Feedback] # 用户反馈1.1.2 自动追踪：环境变量配置# 最简单的开启方式：
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第十篇 生产实践与监控评估"><meta property="og:description" content='第十篇 生产实践与监控评估# 目标: 构建生产级LLM应用的完整体系
从监控追踪到架构设计,从性能优化到安全防护,从部署运维到故障排查,全面掌握生产环境的关键要素。
第1章：LangSmith Tracing 与 Evaluation# 关注点：掌握 Agent 执行的全链路可观测性，建立科学的评估框架。
1.1 追踪体系# 1.1.1 追踪原理与数据模型# 什么是追踪（Tracing）？
追踪是记录和分析 Agent 执行过程的完整链路，从用户输入开始，记录每一个中间步骤（模型调用、工具执行、状态变化），最终得到输出。LangSmith 追踪形成一棵执行树：
root_run (Agent 执行) ├── before_model_hook (Middleware) ├── model_call (模型调用) │ ├── system_prompt │ ├── messages │ └── tools ├── tool_run (工具执行) │ ├── search_tool │ └── get_weather_tool └── after_model_hook (后处理)追踪的核心作用：
调试：看到完整的执行链，快速定位问题 监控：追踪延迟、Token 成本、错误率等指标 优化：识别瓶颈，比较不同版本的性能差异 审计：记录谁做了什么，满足合规要求 数据模型：
class Run: id: str # 唯一 ID name: str # 运行名称 run_type: str # "agent", "model", "tool", "chain" 等 parent_run_id: Optional[str] # 父 Run ID（形成树关系） # 输入输出 inputs: dict[str, Any] # 输入参数 outputs: dict[str, Any] # 输出结果 # 时间和成本 start_time: datetime # 开始时间 end_time: datetime # 结束时间 duration: float # 执行耗时（秒） # Token 和成本 token_usage: Optional[TokenUsage] cost: Optional[float] # 美元成本 # 状态和错误 status: str # "success", "error" error: Optional[str] # 错误信息 # 元数据 metadata: dict[str, Any] # 自定义元数据 tags: list[str] # 标签（用于筛选） # 反馈 feedback_records: list[Feedback] # 用户反馈1.1.2 自动追踪：环境变量配置# 最简单的开启方式：'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第十篇 生产实践与监控评估"><meta itemprop=description content='第十篇 生产实践与监控评估# 目标: 构建生产级LLM应用的完整体系
从监控追踪到架构设计,从性能优化到安全防护,从部署运维到故障排查,全面掌握生产环境的关键要素。
第1章：LangSmith Tracing 与 Evaluation# 关注点：掌握 Agent 执行的全链路可观测性，建立科学的评估框架。
1.1 追踪体系# 1.1.1 追踪原理与数据模型# 什么是追踪（Tracing）？
追踪是记录和分析 Agent 执行过程的完整链路，从用户输入开始，记录每一个中间步骤（模型调用、工具执行、状态变化），最终得到输出。LangSmith 追踪形成一棵执行树：
root_run (Agent 执行) ├── before_model_hook (Middleware) ├── model_call (模型调用) │ ├── system_prompt │ ├── messages │ └── tools ├── tool_run (工具执行) │ ├── search_tool │ └── get_weather_tool └── after_model_hook (后处理)追踪的核心作用：
调试：看到完整的执行链，快速定位问题 监控：追踪延迟、Token 成本、错误率等指标 优化：识别瓶颈，比较不同版本的性能差异 审计：记录谁做了什么，满足合规要求 数据模型：
class Run: id: str # 唯一 ID name: str # 运行名称 run_type: str # "agent", "model", "tool", "chain" 等 parent_run_id: Optional[str] # 父 Run ID（形成树关系） # 输入输出 inputs: dict[str, Any] # 输入参数 outputs: dict[str, Any] # 输出结果 # 时间和成本 start_time: datetime # 开始时间 end_time: datetime # 结束时间 duration: float # 执行耗时（秒） # Token 和成本 token_usage: Optional[TokenUsage] cost: Optional[float] # 美元成本 # 状态和错误 status: str # "success", "error" error: Optional[str] # 错误信息 # 元数据 metadata: dict[str, Any] # 自定义元数据 tags: list[str] # 标签（用于筛选） # 反馈 feedback_records: list[Feedback] # 用户反馈1.1.2 自动追踪：环境变量配置# 最简单的开启方式：'><meta itemprop=wordCount content="10876"><title>第十篇 生产实践与监控评估 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/ class=active>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第十篇 生产实践与监控评估</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#第1章langsmith-tracing-与-evaluation>第1章：LangSmith Tracing 与 Evaluation</a><ul><li><a href=#11-追踪体系>1.1 追踪体系</a><ul><li><a href=#111-追踪原理与数据模型>1.1.1 追踪原理与数据模型</a></li><li><a href=#112-自动追踪环境变量配置>1.1.2 自动追踪：环境变量配置</a></li><li><a href=#113-手动追踪traceable-装饰器>1.1.3 手动追踪：@traceable 装饰器</a></li><li><a href=#114-追踪信息分析>1.1.4 追踪信息分析</a></li></ul></li><li><a href=#12-evaluation-评估框架>1.2 Evaluation 评估框架</a><ul><li><a href=#121-dataset-管理与测试集设计>1.2.1 Dataset 管理与测试集设计</a></li><li><a href=#122-评估指标准确率相关性一致性延迟成本>1.2.2 评估指标：准确率、相关性、一致性、延迟、成本</a></li><li><a href=#123-evaluate-批量测试>1.2.3 evaluate() 批量测试</a></li><li><a href=#124-人工标注与反馈收集>1.2.4 人工标注与反馈收集</a></li></ul></li><li><a href=#13-持续优化>1.3 持续优化</a><ul><li><a href=#131-prompt-hub-版本控制>1.3.1 Prompt Hub 版本控制</a></li><li><a href=#132-ab-测试>1.3.2 A/B 测试</a></li><li><a href=#133-监控指标与问题发现>1.3.3 监控指标与问题发现</a></li><li><a href=#134-优化迭代流程>1.3.4 优化迭代流程</a></li></ul></li><li><a href=#本章小结>本章小结</a></li><li><a href=#思考与练习>思考与练习</a></li><li><a href=#总结与展望>总结与展望</a></li></ul></li><li><a href=#第2章-架构设计模式>第2章： 架构设计模式</a><ul><li><a href=#21-rag-架构设计>2.1 RAG 架构设计</a></li><li><a href=#22-multi-agent-架构选择>2.2 Multi-Agent 架构选择</a></li><li><a href=#23-workflow-架构模式>2.3 Workflow 架构模式</a></li></ul></li><li><a href=#第3章-性能与成本优化>第3章： 性能与成本优化</a><ul><li><a href=#31-延迟优化>3.1 延迟优化</a></li><li><a href=#32-吞吐量优化>3.2 吞吐量优化</a></li><li><a href=#33-token-管理与成本控制>3.3 Token 管理与成本控制</a></li><li><a href=#34-缓存复用策略>3.4 缓存复用策略</a></li><li><a href=#35-自适应模型选择>3.5 自适应模型选择</a></li><li><a href=#36-批处理优化>3.6 批处理优化</a></li><li><a href=#37-成本监控与优化清单>3.7 成本监控与优化清单</a></li></ul></li><li><a href=#第4章-安全合规与防护>第4章： 安全合规与防护</a><ul><li><a href=#41-guardrails-防护体系>4.1 Guardrails 防护体系</a></li><li><a href=#42-pii-检测策略>4.2 PII 检测策略</a></li><li><a href=#43-分层防护组合>4.3 分层防护组合</a></li><li><a href=#44-自定义-guardrails-开发>4.4 自定义 Guardrails 开发</a></li><li><a href=#45-输入输出安全>4.5 输入输出安全</a></li><li><a href=#46-数据合规>4.6 数据合规</a></li><li><a href=#47-审计日志>4.7 审计日志</a></li></ul></li><li><a href=#第5章-部署与运维>第5章： 部署与运维</a><ul><li><a href=#51-部署策略>5.1 部署策略</a></li><li><a href=#52-监控告警>5.2 监控告警</a><ul><li><a href=#521-prometheus监控集成>5.2.1 Prometheus监控集成</a></li><li><a href=#522-监控系统实现>5.2.2 监控系统实现</a></li></ul></li><li><a href=#53-故障处理>5.3 故障处理</a></li><li><a href=#54-生产部署检查清单>5.4 生产部署检查清单</a><ul><li><a href=#541-安全检查清单>5.4.1 安全检查清单</a></li><li><a href=#542-性能检查清单>5.4.2 性能检查清单</a></li><li><a href=#543-可靠性检查清单>5.4.3 可靠性检查清单</a></li><li><a href=#544-监控检查清单>5.4.4 监控检查清单</a></li><li><a href=#545-成本检查清单>5.4.5 成本检查清单</a></li><li><a href=#546-数据合规检查清单>5.4.6 数据合规检查清单</a></li><li><a href=#547-部署前最终检查>5.4.7 部署前最终检查</a></li></ul></li><li><a href=#本章小结-1>本章小结</a></li></ul></li><li><a href=#第6章测试与质量保障>第6章：测试与质量保障</a><ul><li><a href=#61-测试金字塔>6.1 测试金字塔</a></li><li><a href=#62-单元测试实践>6.2 单元测试实践</a><ul><li><a href=#621-tool函数测试>6.2.1 Tool函数测试</a></li><li><a href=#622-agent工作流集成测试>6.2.2 Agent工作流集成测试</a></li></ul></li><li><a href=#63-langsmith自动化评估>6.3 LangSmith自动化评估</a><ul><li><a href=#631-创建评估dataset>6.3.1 创建评估Dataset</a></li><li><a href=#632-定义evaluators>6.3.2 定义Evaluators</a></li><li><a href=#633-运行评估与ab测试>6.3.3 运行评估与A/B测试</a></li></ul></li><li><a href=#64-cicd集成>6.4 CI/CD集成</a><ul><li><a href=#641-github-actions配置>6.4.1 GitHub Actions配置</a></li><li><a href=#642-质量门禁>6.4.2 质量门禁</a></li></ul></li><li><a href=#65-测试最佳实践>6.5 测试最佳实践</a></li></ul></li><li><a href=#第7章错误处理与降级策略>第7章：错误处理与降级策略</a><ul><li><a href=#71-错误处理层次>7.1 错误处理层次</a></li><li><a href=#72-输入验证>7.2 输入验证</a></li><li><a href=#73-智能重试机制>7.3 智能重试机制</a></li><li><a href=#74-多级降级策略>7.4 多级降级策略</a></li><li><a href=#75-熔断器模式>7.5 熔断器模式</a></li><li><a href=#76-监控与告警>7.6 监控与告警</a></li><li><a href=#77-错误处理最佳实践>7.7 错误处理最佳实践</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第十篇-生产实践与监控评估>第十篇 生产实践与监控评估<a class=anchor href=#%e7%ac%ac%e5%8d%81%e7%af%87-%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5%e4%b8%8e%e7%9b%91%e6%8e%a7%e8%af%84%e4%bc%b0>#</a></h1><blockquote class=book-hint><p><strong>目标</strong>: 构建生产级LLM应用的完整体系</p></blockquote><p>从监控追踪到架构设计,从性能优化到安全防护,从部署运维到故障排查,全面掌握生产环境的关键要素。</p><hr><h2 id=第1章langsmith-tracing-与-evaluation>第1章：LangSmith Tracing 与 Evaluation<a class=anchor href=#%e7%ac%ac1%e7%ab%a0langsmith-tracing-%e4%b8%8e-evaluation>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>：掌握 Agent 执行的全链路可观测性，建立科学的评估框架。</p></blockquote><h3 id=11-追踪体系>1.1 追踪体系<a class=anchor href=#11-%e8%bf%bd%e8%b8%aa%e4%bd%93%e7%b3%bb>#</a></h3><h4 id=111-追踪原理与数据模型>1.1.1 追踪原理与数据模型<a class=anchor href=#111-%e8%bf%bd%e8%b8%aa%e5%8e%9f%e7%90%86%e4%b8%8e%e6%95%b0%e6%8d%ae%e6%a8%a1%e5%9e%8b>#</a></h4><p><strong>什么是追踪（Tracing）？</strong></p><p>追踪是记录和分析 Agent 执行过程的完整链路，从用户输入开始，记录每一个中间步骤（模型调用、工具执行、状态变化），最终得到输出。LangSmith 追踪形成一棵执行树：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>root_run</span> <span class=p>(</span><span class=n>Agent</span> <span class=err>执行</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>before_model_hook</span> <span class=p>(</span><span class=n>Middleware</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>model_call</span> <span class=p>(</span><span class=err>模型调用</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>system_prompt</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>tools</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>tool_run</span> <span class=p>(</span><span class=err>工具执行</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>search_tool</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>get_weather_tool</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=n>after_model_hook</span> <span class=p>(</span><span class=err>后处理</span><span class=p>)</span></span></span></code></pre></div><p><strong>追踪的核心作用</strong>：</p><ol><li><strong>调试</strong>：看到完整的执行链，快速定位问题</li><li><strong>监控</strong>：追踪延迟、Token 成本、错误率等指标</li><li><strong>优化</strong>：识别瓶颈，比较不同版本的性能差异</li><li><strong>审计</strong>：记录谁做了什么，满足合规要求</li></ol><p><strong>数据模型</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Run</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span><span class=p>:</span> <span class=nb>str</span>                          <span class=c1># 唯一 ID</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>                        <span class=c1># 运行名称</span>
</span></span><span class=line><span class=cl>    <span class=n>run_type</span><span class=p>:</span> <span class=nb>str</span>                    <span class=c1># &#34;agent&#34;, &#34;model&#34;, &#34;tool&#34;, &#34;chain&#34; 等</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_run_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>     <span class=c1># 父 Run ID（形成树关系）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 输入输出</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>           <span class=c1># 输入参数</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>          <span class=c1># 输出结果</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 时间和成本</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span><span class=p>:</span> <span class=n>datetime</span>             <span class=c1># 开始时间</span>
</span></span><span class=line><span class=cl>    <span class=n>end_time</span><span class=p>:</span> <span class=n>datetime</span>               <span class=c1># 结束时间</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span>                  <span class=c1># 执行耗时（秒）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Token 和成本</span>
</span></span><span class=line><span class=cl>    <span class=n>token_usage</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>TokenUsage</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cost</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>float</span><span class=p>]</span>            <span class=c1># 美元成本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 状态和错误</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>                      <span class=c1># &#34;success&#34;, &#34;error&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>             <span class=c1># 错误信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 元数据</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>         <span class=c1># 自定义元数据</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>                  <span class=c1># 标签（用于筛选）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 反馈</span>
</span></span><span class=line><span class=cl>    <span class=n>feedback_records</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>Feedback</span><span class=p>]</span> <span class=c1># 用户反馈</span></span></span></code></pre></div><h4 id=112-自动追踪环境变量配置>1.1.2 自动追踪：环境变量配置<a class=anchor href=#112-%e8%87%aa%e5%8a%a8%e8%bf%bd%e8%b8%aa%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e9%85%8d%e7%bd%ae>#</a></h4><p><strong>最简单的开启方式</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 设置环境变量（LangSmith 1.0+ 最新命名）</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LANGSMITH_API_KEY</span><span class=o>=</span><span class=s2>&#34;lsv2_...&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LANGCHAIN_PROJECT</span><span class=o>=</span><span class=s2>&#34;my_project&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LANGSMITH_TRACING</span><span class=o>=</span><span class=s2>&#34;true&#34;</span></span></span></code></pre></div><blockquote class=book-hint><p><strong>向后兼容说明</strong>:</p><ul><li>旧版环境变量 <code>LANGCHAIN_API_KEY</code> 和 <code>LANGCHAIN_TRACING_V2</code> 仍然支持，但建议迁移到新命名</li><li>API Key 格式从 <code>sk-...</code> 变更为 <code>lsv2_...</code>（LangSmith v2）</li><li><code>LANGCHAIN_PROJECT</code> 保持不变（生态通用变量）</li></ul></blockquote><p><strong>Python 代码中配置</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 LangSmith（最新命名）</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;lsv2_...&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_PROJECT&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;my_project&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TRACING&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 Agent</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search</span><span class=p>,</span> <span class=n>weather</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是一个助手&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 自动追踪：所有调用都会被记录到 LangSmith</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;今天天气如何&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看追踪：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 打开 https://smith.langchain.com</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 选择项目 &#34;my_project&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 查看实时追踪树</span></span></span></code></pre></div><p><strong>环境变量选项</strong>：</p><table><thead><tr><th>变量</th><th>说明</th><th>示例</th><th>状态</th></tr></thead><tbody><tr><td><code>LANGSMITH_API_KEY</code></td><td>LangSmith API 密钥（必需）</td><td><code>lsv2_...</code></td><td>✅ 推荐</td></tr><tr><td><code>LANGCHAIN_PROJECT</code></td><td>项目名称（用于分组）</td><td><code>my_agent</code></td><td>✅ 通用</td></tr><tr><td><code>LANGSMITH_TRACING</code></td><td>启用追踪（必需）</td><td><code>true</code></td><td>✅ 推荐</td></tr><tr><td><code>LANGSMITH_WORKSPACE_ID</code></td><td>工作区 ID（团队使用）</td><td><code>ws-...</code></td><td>✅ 新增</td></tr><tr><td><code>LANGCHAIN_ENDPOINT</code></td><td>LangSmith API 端点</td><td><code>https://api.smith.langchain.com</code></td><td>✅ 可选</td></tr><tr><td><code>LANGCHAIN_SESSION</code></td><td>会话名称（可选，用于子分组）</td><td><code>session-123</code></td><td>✅ 可选</td></tr><tr><td><code>LANGCHAIN_CALLBACKS_BACKGROUND</code></td><td>后台异步发送追踪数据</td><td><code>true</code></td><td>✅ 可选</td></tr><tr><td><code>LANGCHAIN_TRACING_SAMPLING_RATE</code></td><td>采样率（0.0-1.0，用于生产环境）</td><td><code>0.1</code></td><td>✅ 可选</td></tr><tr><td><code>LANGSMITH_TEST_CACHE</code></td><td>缓存 API 调用（加速评估）</td><td><code>true</code></td><td>✅ 可选</td></tr><tr><td><code>LANGCHAIN_API_KEY</code></td><td>（旧）API 密钥</td><td><code>sk-...</code></td><td>⚠️ 已弃用</td></tr><tr><td><code>LANGCHAIN_TRACING_V2</code></td><td>（旧）启用追踪</td><td><code>true</code></td><td>⚠️ 已弃用</td></tr></tbody></table><p><strong>完整环境变量配置示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础配置（必需）- LangSmith 1.0+ 最新命名</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_API_KEY&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;lsv2_...&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TRACING&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_PROJECT&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;my_project&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 团队协作配置（可选）</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_WORKSPACE_ID&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;ws-...&#34;</span>  <span class=c1># 工作区 ID（团队共享）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 可选配置</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_ENDPOINT&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;https://api.smith.langchain.com&#34;</span>  <span class=c1># 自定义端点</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_SESSION&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;user-session-123&#34;</span>  <span class=c1># 会话分组</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_CALLBACKS_BACKGROUND&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>  <span class=c1># 后台发送，不阻塞主程序</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGCHAIN_TRACING_SAMPLING_RATE&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;0.1&#34;</span>  <span class=c1># 生产环境采样 10%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 开发/测试环境配置</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;LANGSMITH_TEST_CACHE&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span>  <span class=c1># 缓存 API 调用以加速测试</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 向后兼容（不推荐，仍然支持）</span>
</span></span><span class=line><span class=cl><span class=c1># os.environ[&#34;LANGCHAIN_API_KEY&#34;] = &#34;sk-...&#34;  # 已弃用，使用 LANGSMITH_API_KEY</span>
</span></span><span class=line><span class=cl><span class=c1># os.environ[&#34;LANGCHAIN_TRACING_V2&#34;] = &#34;true&#34;  # 已弃用，使用 LANGSMITH_TRACING</span></span></span></code></pre></div><p><strong>环境变量说明</strong>：</p><ol><li><p><strong>必需变量</strong>（LangSmith 1.0+）：</p><ul><li><code>LANGSMITH_API_KEY</code>：从 <a href=https://smith.langchain.com>https://smith.langchain.com</a> 获取，格式为 <code>lsv2_...</code></li><li><code>LANGSMITH_TRACING</code>：必须设为 <code>"true"</code> 启用追踪</li></ul></li><li><p><strong>项目组织</strong>：</p><ul><li><code>LANGCHAIN_PROJECT</code>：项目名称，用于分组追踪（生态通用变量，保持不变）</li><li><code>LANGCHAIN_SESSION</code>：会话名称，用于更细粒度的分组（如按用户或任务分组）</li><li><code>LANGSMITH_WORKSPACE_ID</code>：工作区 ID，用于团队协作（格式为 <code>ws-...</code>）</li></ul></li><li><p><strong>性能优化</strong>：</p><ul><li><code>LANGCHAIN_CALLBACKS_BACKGROUND</code>：设为 <code>"true"</code> 后，追踪数据异步发送，不阻塞主程序</li><li><code>LANGCHAIN_TRACING_SAMPLING_RATE</code>：生产环境建议设置采样率（如 <code>"0.1"</code> 表示 10%），降低追踪成本</li></ul></li><li><p><strong>测试加速</strong>：</p><ul><li><code>LANGSMITH_TEST_CACHE</code>：在测试/评估时缓存 API 响应，避免重复调用</li></ul></li><li><p><strong>向后兼容</strong>（已弃用）：</p><ul><li><code>LANGCHAIN_API_KEY</code>（旧格式 <code>sk-...</code>）→ 迁移到 <code>LANGSMITH_API_KEY</code>（新格式 <code>lsv2_...</code>）</li><li><code>LANGCHAIN_TRACING_V2</code> → 迁移到 <code>LANGSMITH_TRACING</code></li></ul></li></ol><h4 id=113-手动追踪traceable-装饰器>1.1.3 手动追踪：@traceable 装饰器<a class=anchor href=#113-%e6%89%8b%e5%8a%a8%e8%bf%bd%e8%b8%aatraceable-%e8%a3%85%e9%a5%b0%e5%99%a8>#</a></h4><p><strong>场景</strong>：追踪非 LangChain 代码（自定义函数、数据库操作等）。</p><p><strong>基础用法</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.run_helpers</span> <span class=kn>import</span> <span class=n>traceable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;my_function&#34;</span><span class=p>,</span> <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;chain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>my_custom_function</span><span class=p>(</span><span class=n>input_text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自定义函数会自动被追踪&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 处理输入</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>input_text</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用时自动记录到 LangSmith</span>
</span></span><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=n>my_custom_function</span><span class=p>(</span><span class=s2>&#34;hello&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>完整参数说明</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>traceable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1># 基础参数</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;custom_processing&#34;</span><span class=p>,</span>              <span class=c1># 运行名称（默认：函数名）</span>
</span></span><span class=line><span class=cl>    <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;tool&#34;</span><span class=p>,</span>                       <span class=c1># 运行类型：llm/chain/tool/retriever/prompt（默认：chain）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 组织和标记</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span>                             <span class=c1># 元数据（任意键值对）</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;author&#34;</span><span class=p>:</span> <span class=s2>&#34;alice&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;module&#34;</span><span class=p>:</span> <span class=s2>&#34;data_processing&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;production&#34;</span><span class=p>,</span> <span class=s2>&#34;v1&#34;</span><span class=p>],</span>             <span class=c1># 标签列表（用于筛选）</span>
</span></span><span class=line><span class=cl>    <span class=n>project_name</span><span class=o>=</span><span class=s2>&#34;my_project&#34;</span><span class=p>,</span>             <span class=c1># 项目名称（覆盖环境变量）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 高级参数</span>
</span></span><span class=line><span class=cl>    <span class=n>reduce_fn</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>                        <span class=c1># 聚合函数（用于生成器/流式输出）</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>                           <span class=c1># 自定义 LangSmith Client</span>
</span></span><span class=line><span class=cl>    <span class=n>process_inputs</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>                   <span class=c1># 输入预处理函数</span>
</span></span><span class=line><span class=cl>    <span class=n>process_outputs</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>                  <span class=c1># 输出后处理函数</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;处理数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=n>data</span><span class=p>,</span> <span class=s2>&#34;processed&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span></span></span></code></pre></div><p><strong>参数详细说明</strong>：</p><table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>name</code></td><td><code>str</code></td><td>追踪运行的显示名称</td><td>函数名</td></tr><tr><td><code>run_type</code></td><td><code>str</code></td><td>运行类型（<code>llm</code>/<code>chain</code>/<code>tool</code>/<code>retriever</code>/<code>prompt</code>）</td><td><code>"chain"</code></td></tr><tr><td><code>metadata</code></td><td><code>dict</code></td><td>自定义元数据（键值对）</td><td><code>None</code></td></tr><tr><td><code>tags</code></td><td><code>list[str]</code></td><td>标签列表，用于过滤和分组</td><td><code>None</code></td></tr><tr><td><code>project_name</code></td><td><code>str</code></td><td>项目名称（覆盖 <code>LANGCHAIN_PROJECT</code> 环境变量）</td><td><code>None</code></td></tr><tr><td><code>reduce_fn</code></td><td><code>Callable</code></td><td>聚合函数，用于处理生成器/流式输出</td><td><code>None</code></td></tr><tr><td><code>client</code></td><td><code>Client</code></td><td>自定义 LangSmith Client 实例</td><td><code>None</code></td></tr><tr><td><code>process_inputs</code></td><td><code>Callable</code></td><td>输入序列化函数（用于自定义输入格式）</td><td><code>None</code></td></tr><tr><td><code>process_outputs</code></td><td><code>Callable</code></td><td>输出序列化函数（用于自定义输出格式）</td><td><code>None</code></td></tr></tbody></table><p><strong>run_type 类型说明</strong>：</p><ul><li><code>"llm"</code>：LLM 模型调用</li><li><code>"chain"</code>：链式调用（默认）</li><li><code>"tool"</code>：工具执行</li><li><code>"retriever"</code>：检索操作</li><li><code>"prompt"</code>：提示词模板</li><li>也可以使用自定义类型（如 <code>"database"</code>, <code>"api_call"</code>）</li></ul><p><strong>高级用法示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 1. 处理生成器输出</span>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s2>&#34;stream_processor&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>reduce_fn</span><span class=o>=</span><span class=k>lambda</span> <span class=n>outputs</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>outputs</span><span class=p>)</span>  <span class=c1># 将流式输出合并为字符串</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stream_data</span><span class=p>(</span><span class=n>n</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成器函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=sa>f</span><span class=s2>&#34;chunk-</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 自定义输入/输出处理</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>serialize_inputs</span><span class=p>(</span><span class=n>inputs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自定义输入序列化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>v</span><span class=p>)[:</span><span class=mi>100</span><span class=p>]</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>inputs</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>  <span class=c1># 截断长文本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>process_inputs</span><span class=o>=</span><span class=n>serialize_inputs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>process_outputs</span><span class=o>=</span><span class=k>lambda</span> <span class=n>o</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>o</span><span class=p>)[:</span><span class=mi>200</span><span class=p>]}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>process_large_data</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 处理大量数据，但只记录摘要</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>data</span><span class=p>}</span></span></span></code></pre></div><p><strong>嵌套追踪</strong>（自动形成树关系）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;parent_task&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>parent_task</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 调用子任务</span>
</span></span><span class=line><span class=cl>    <span class=n>result1</span> <span class=o>=</span> <span class=n>search_task</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result2</span> <span class=o>=</span> <span class=n>analyze_task</span><span class=p>(</span><span class=n>result1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;search_task&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>search_task</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 子任务 1</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;搜索结果: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;analyze_task&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>analyze_task</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 子任务 2</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;分析: </span><span class=si>{</span><span class=n>text</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用时自动形成树：</span>
</span></span><span class=line><span class=cl><span class=c1># parent_task</span>
</span></span><span class=line><span class=cl><span class=c1># ├── search_task</span>
</span></span><span class=line><span class=cl><span class=c1># └── analyze_task</span>
</span></span><span class=line><span class=cl><span class=n>parent_task</span><span class=p>(</span><span class=s2>&#34;LangChain&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>访问当前运行信息</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.run_helpers</span> <span class=kn>import</span> <span class=n>traceable</span><span class=p>,</span> <span class=n>get_current_run_tree</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>my_function</span><span class=p>(</span><span class=n>x</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取当前运行</span>
</span></span><span class=line><span class=cl>    <span class=n>run</span> <span class=o>=</span> <span class=n>get_current_run_tree</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>run</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;当前运行 ID: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;运行名称: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加自定义元数据</span>
</span></span><span class=line><span class=cl>        <span class=n>run</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=o>*</span> <span class=mi>2</span></span></span></code></pre></div><p><strong>异步追踪示例</strong>：</p><p><code>@traceable</code> 装饰器完全支持异步函数，自动追踪异步操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>traceable</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>httpx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;fetch_data&#34;</span><span class=p>,</span> <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;retriever&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>fetch_user_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;异步获取用户数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>()</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;https://api.example.com/users/</span><span class=si>{</span><span class=n>user_id</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;process_user&#34;</span><span class=p>,</span> <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;chain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>process_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;异步处理用户信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 异步调用会自动追踪</span>
</span></span><span class=line><span class=cl>    <span class=n>user_data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>fetch_user_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 处理数据</span>
</span></span><span class=line><span class=cl>    <span class=n>processed</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=n>user_data</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>user_data</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>upper</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;processed_at&#34;</span><span class=p>:</span> <span class=s2>&#34;2025-01-15&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>processed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用异步追踪</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>process_user</span><span class=p>(</span><span class=s2>&#34;user-123&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行</span>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 追踪树会显示：</span>
</span></span><span class=line><span class=cl><span class=c1># process_user (async)</span>
</span></span><span class=line><span class=cl><span class=c1># └── fetch_user_data (async)</span></span></span></code></pre></div><p><strong>异步批量操作追踪</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;batch_fetch&#34;</span><span class=p>,</span> <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;chain&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>fetch_multiple_users</span><span class=p>(</span><span class=n>user_ids</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;并发获取多个用户数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 所有异步调用都会被追踪</span>
</span></span><span class=line><span class=cl>    <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=n>fetch_user_data</span><span class=p>(</span><span class=n>uid</span><span class=p>)</span> <span class=k>for</span> <span class=n>uid</span> <span class=ow>in</span> <span class=n>user_ids</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>users</span> <span class=o>=</span> <span class=k>await</span> <span class=n>fetch_multiple_users</span><span class=p>([</span><span class=s2>&#34;user-1&#34;</span><span class=p>,</span> <span class=s2>&#34;user-2&#34;</span><span class=p>,</span> <span class=s2>&#34;user-3&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 追踪树会显示：</span>
</span></span><span class=line><span class=cl><span class=c1># batch_fetch</span>
</span></span><span class=line><span class=cl><span class=c1># ├── fetch_user_data (user-1)</span>
</span></span><span class=line><span class=cl><span class=c1># ├── fetch_user_data (user-2)</span>
</span></span><span class=line><span class=cl><span class=c1># └── fetch_user_data (user-3)</span></span></span></code></pre></div><p><strong>错误处理与追踪</strong>：</p><p>异常会自动记录到 LangSmith，无需额外配置：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;safe_operation&#34;</span><span class=p>,</span> <span class=n>run_type</span><span class=o>=</span><span class=s2>&#34;tool&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>safe_operation</span><span class=p>(</span><span class=n>value</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带错误处理的操作&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;Value must be non-negative&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=mi>100</span> <span class=o>/</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 异常会自动记录到 LangSmith</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Validation error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>  <span class=c1># 重新抛出以标记为失败</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>ZeroDivisionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 除零错误也会被记录</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Division error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用失败的函数</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>safe_operation</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>  <span class=c1># 会在 LangSmith 中标记为 error</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>ZeroDivisionError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># LangSmith 中会显示：</span>
</span></span><span class=line><span class=cl><span class=c1># - 运行状态: error</span>
</span></span><span class=line><span class=cl><span class=c1># - 错误类型: ZeroDivisionError</span>
</span></span><span class=line><span class=cl><span class=c1># - 错误消息: division by zero</span>
</span></span><span class=line><span class=cl><span class=c1># - 完整堆栈跟踪</span></span></span></code></pre></div><p><strong>异步错误处理示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@traceable</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&#34;async_safe_fetch&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>async_safe_fetch</span><span class=p>(</span><span class=n>url</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带错误处理的异步请求&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=n>httpx</span><span class=o>.</span><span class=n>AsyncClient</span><span class=p>()</span> <span class=k>as</span> <span class=n>client</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mf>5.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span><span class=o>.</span><span class=n>raise_for_status</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>httpx</span><span class=o>.</span><span class=n>TimeoutException</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 超时错误会被记录</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Request timeout: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>httpx</span><span class=o>.</span><span class=n>HTTPStatusError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># HTTP 错误会被记录</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;HTTP error: </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 所有其他错误也会被记录</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unexpected error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>async_safe_fetch</span><span class=p>(</span><span class=s2>&#34;https://invalid-url.example.com&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># LangSmith 会记录完整的错误信息</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span></span></span></code></pre></div><h4 id=114-追踪信息分析>1.1.4 追踪信息分析<a class=anchor href=#114-%e8%bf%bd%e8%b8%aa%e4%bf%a1%e6%81%af%e5%88%86%e6%9e%90>#</a></h4><p><strong>在 LangSmith UI 中查看追踪</strong>：</p><ol><li><p><strong>Trace 树视图</strong>：查看完整的执行链路</p><ul><li>每个节点显示运行名称、状态、耗时</li><li>点击节点查看详细信息（输入、输出、错误）</li></ul></li><li><p><strong>输入输出对比</strong>：</p><ul><li>左侧：输入参数</li><li>右侧：输出结果</li><li>快速定位数据变化</li></ul></li><li><p><strong>Token 成本分析</strong>：</p><ul><li>显示每次模型调用的 Token 使用量</li><li>计算累计成本（美元）</li><li>识别成本最高的操作</li></ul></li><li><p><strong>延迟分析</strong>：</p><ul><li>显示每个操作的耗时</li><li>识别性能瓶颈</li><li>比较不同版本的性能</li></ul></li></ol><p><strong>编程方式分析追踪</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取最近的追踪</span>
</span></span><span class=line><span class=cl><span class=n>runs</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_runs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>project_name</span><span class=o>=</span><span class=s2>&#34;my_project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span><span class=o>=</span><span class=mi>10</span>  <span class=c1># 获取最近 10 条</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;运行: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;状态: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;耗时: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>run</span><span class=o>.</span><span class=n>start_time</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>token_usage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Tokens: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>token_usage</span><span class=o>.</span><span class=n>completion_tokens</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成本: $</span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>cost</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取子运行</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>child_runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>run</span><span class=o>.</span><span class=n>child_runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  └─ </span><span class=si>{</span><span class=n>child</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>child</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>筛选和统计</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 筛选条件</span>
</span></span><span class=line><span class=cl><span class=n>yesterday</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取特定标签的运行</span>
</span></span><span class=line><span class=cl><span class=n>production_runs</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_runs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>project_name</span><span class=o>=</span><span class=s2>&#34;my_project&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>filter</span><span class=o>=</span><span class=s1>&#39;tags:production&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>start_time</span><span class=o>=</span><span class=n>yesterday</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计</span>
</span></span><span class=line><span class=cl><span class=n>total_cost</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>run</span><span class=o>.</span><span class=n>cost</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>production_runs</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>cost</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>avg_duration</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>run</span><span class=o>.</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>run</span><span class=o>.</span><span class=n>start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>production_runs</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>production_runs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>error_count</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>production_runs</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总成本: $</span><span class=si>{</span><span class=n>total_cost</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均耗时: </span><span class=si>{</span><span class=n>avg_duration</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> 秒&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;错误数: </span><span class=si>{</span><span class=n>error_count</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>反馈收集</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 在应用中收集用户反馈</span>
</span></span><span class=line><span class=cl><span class=n>run_id</span> <span class=o>=</span> <span class=s2>&#34;run-123&#34;</span>  <span class=c1># 从追踪中获取</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用户点赞</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_feedback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_id</span><span class=o>=</span><span class=n>run_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;user_rating&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>  <span class=c1># 1.0 = 好, 0.0 = 不好</span>
</span></span><span class=line><span class=cl>    <span class=n>comment</span><span class=o>=</span><span class=s2>&#34;很有用！&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 专家标注</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_feedback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_id</span><span class=o>=</span><span class=n>run_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;expert_evaluation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>comment</span><span class=o>=</span><span class=s2>&#34;大部分正确，但有一处错误&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看反馈</span>
</span></span><span class=line><span class=cl><span class=n>feedbacks</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_feedbacks</span><span class=p>(</span><span class=n>run_id</span><span class=o>=</span><span class=n>run_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>feedback</span> <span class=ow>in</span> <span class=n>feedbacks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>score</span><span class=si>}</span><span class=s2> - </span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>comment</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=12-evaluation-评估框架>1.2 Evaluation 评估框架<a class=anchor href=#12-evaluation-%e8%af%84%e4%bc%b0%e6%a1%86%e6%9e%b6>#</a></h3><h4 id=121-dataset-管理与测试集设计>1.2.1 Dataset 管理与测试集设计<a class=anchor href=#121-dataset-%e7%ae%a1%e7%90%86%e4%b8%8e%e6%b5%8b%e8%af%95%e9%9b%86%e8%ae%be%e8%ae%a1>#</a></h4><p><strong>什么是 Dataset？</strong></p><p>Dataset 是评估所需的测试数据集合，每个 Example 包含：</p><ul><li><strong>input</strong>：输入参数</li><li><strong>output</strong>（可选）：参考输出（用于对比）</li><li><strong>metadata</strong>（可选）：补充信息</li></ul><p><strong>创建 Dataset</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 1：手动创建</span>
</span></span><span class=line><span class=cl><span class=n>dataset</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;QA 任务基准数据集&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加示例</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain 是什么？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain 是一个构建 LLM 应用的框架&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;Python 3.13 的主要特性？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;Python 3.13 引入了 JIT 编译器...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 2：从 CSV 导入</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>read_csv</span><span class=p>(</span><span class=s2>&#34;qa_examples.csv&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 假设 CSV 有 &#34;question&#34; 和 &#34;answer&#34; 列</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dataset</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=o>=</span><span class=s2>&#34;qa_from_csv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;从 CSV 导入的 QA 数据集&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>df</span><span class=o>.</span><span class=n>iterrows</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]},</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>row</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 3：从生产追踪创建（最推荐）</span>
</span></span><span class=line><span class=cl><span class=c1># 在生产环境运行一段时间后，筛选高质量的追踪</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=o>=</span><span class=s2>&#34;production_examples&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;从生产环境采集的真实用户查询&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手动筛选好的追踪并添加</span>
</span></span><span class=line><span class=cl><span class=c1># （通常通过 LangSmith UI 完成，支持批量导入）</span></span></span></code></pre></div><p><strong>测试集设计最佳实践</strong>：</p><p><strong>1. 覆盖代表场景</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ✅ 好：覆盖多种场景</span>
</span></span><span class=line><span class=cl><span class=n>examples</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># 简单查询</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;天气如何？&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 复杂查询</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;比较 LangChain 和 Langraph 的优缺点&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 边界情况</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;请输入有效问题&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;???.|||&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;请输入有效问题&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 多轮对话</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;什么是 RAG？&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;能给个例子吗？&#34;</span><span class=p>,</span> <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p><strong>2. 足够的数据量</strong></p><ul><li>初期：10-20 个高质量样例（手工精选）</li><li>中期：50-100 个样例（包括覆盖各种场景）</li><li>成熟期：1000+ 个样例（从生产环境采集）</li></ul><p><strong>3. 包含元数据</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain 是什么？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain 是...&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;difficulty&#34;</span><span class=p>:</span> <span class=s2>&#34;easy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;framework&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;user_feedback&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;language&#34;</span><span class=p>:</span> <span class=s2>&#34;chinese&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=122-评估指标准确率相关性一致性延迟成本>1.2.2 评估指标：准确率、相关性、一致性、延迟、成本<a class=anchor href=#122-%e8%af%84%e4%bc%b0%e6%8c%87%e6%a0%87%e5%87%86%e7%a1%ae%e7%8e%87%e7%9b%b8%e5%85%b3%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%bb%b6%e8%bf%9f%e6%88%90%e6%9c%ac>#</a></h4><p><strong>评估器返回格式详解</strong>：</p><p>评估器必须返回一个字典，包含以下字段：</p><table><thead><tr><th>字段</th><th>必需</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>key</code></td><td>是</td><td><code>str</code></td><td>评估指标的名称（如 <code>"accuracy"</code>, <code>"relevance"</code>)</td></tr><tr><td><code>score</code></td><td>是</td><td><code>float/int/bool</code></td><td>评估分数（通常 0-1，也可以是任意数值或布尔值）</td></tr><tr><td><code>value</code></td><td>否</td><td><code>Any</code></td><td>实际值（通常与 score 相同，用于记录原始值）</td></tr><tr><td><code>comment</code></td><td>否</td><td><code>str</code></td><td>评论或解释（用于调试和分析）</td></tr><tr><td><code>correction</code></td><td>否</td><td><code>dict</code></td><td>修正建议（用于标注正确答案）</td></tr></tbody></table><p><strong>完整返回格式示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 最简格式（只包含必需字段）</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;accuracy&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 完整格式（包含所有字段）</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;accuracy&#34;</span><span class=p>,</span>           <span class=c1># 指标名称</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.85</span><span class=p>,</span>                <span class=c1># 分数（0-1 或任意数值）</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=mf>0.85</span><span class=p>,</span>                <span class=c1># 实际值（可选，通常与 score 相同）</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;Good answer!&#34;</span><span class=p>,</span>    <span class=c1># 评论（可选，用于解释）</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;correction&#34;</span><span class=p>:</span> <span class=p>{</span>               <span class=c1># 修正建议（可选）</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;expected&#34;</span><span class=p>:</span> <span class=s2>&#34;Paris&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;actual&#34;</span><span class=p>:</span> <span class=s2>&#34;paris&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 布尔分数</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;is_correct&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=kc>True</span>  <span class=c1># 布尔值也可以</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多个评估结果（返回列表）</span>
</span></span><span class=line><span class=cl><span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;accuracy&#34;</span><span class=p>,</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.9</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;latency&#34;</span><span class=p>,</span> <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.5</span><span class=p>,</span> <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;1.5 seconds&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div><p><strong>评估器类型</strong>：</p><ol><li><strong>启发式评估器</strong>（Heuristic Evaluator）：确定性规则</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>is_valid_code</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查输出是否是有效的 Python 代码&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>code</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;code&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>compile</span><span class=p>(</span><span class=n>code</span><span class=p>,</span> <span class=s2>&#34;&lt;string&gt;&#34;</span><span class=p>,</span> <span class=s2>&#34;exec&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;valid_code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;Valid Python code&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>SyntaxError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;valid_code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Syntax error: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;correction&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exact_match</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;精确匹配评估器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>actual</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>expected</span> <span class=o>=</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>is_match</span> <span class=o>=</span> <span class=n>actual</span> <span class=o>==</span> <span class=n>expected</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;exact_match&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span> <span class=k>if</span> <span class=n>is_match</span> <span class=k>else</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=n>is_match</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=s2>&#34;Match!&#34;</span> <span class=k>if</span> <span class=n>is_match</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;Expected: </span><span class=si>{</span><span class=n>expected</span><span class=si>}</span><span class=s2>, Got: </span><span class=si>{</span><span class=n>actual</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;correction&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;expected&#34;</span><span class=p>:</span> <span class=n>expected</span><span class=p>}</span> <span class=k>if</span> <span class=ow>not</span> <span class=n>is_match</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>length_check</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查输出长度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>answer</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>answer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;answer_length&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>length</span><span class=p>,</span>  <span class=c1># 分数可以是任意数值</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;value&#34;</span><span class=p>:</span> <span class=n>length</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Answer has </span><span class=si>{</span><span class=n>length</span><span class=si>}</span><span class=s2> characters&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><p><strong>2. LLM 作为评估器</strong>（LLM-as-Judge）：使用 LLM 打分</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>LangChainStringEvaluator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用官方提供的 LLM 评估器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>EvaluateStrings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluate_strings</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义 LLM 评估器</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>llm_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;使用 LLM 评估相关性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>evaluation_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    问题：</span><span class=si>{</span><span class=n>example</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;question&#34;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    参考答案：</span><span class=si>{</span><span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    实际答案：</span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    请评估实际答案与参考答案的相似度（0-1）。
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>evaluation_prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 解析响应</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;relevance&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span></span></span></code></pre></div><p><strong>3. 人工评估</strong>：通过 UI 手动标注</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># LangSmith UI 中可以：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 在 Annotation Queue 中标注</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 为每条结果打分或写评论</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 导出评估结果供统计</span></span></span></code></pre></div><p><strong>常见评估指标</strong>：</p><table><thead><tr><th>指标</th><th>实现方式</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Accuracy</strong></td><td>精确匹配或 LLM</td><td>分类任务</td></tr><tr><td><strong>BLEU/ROUGE</strong></td><td>文本相似度</td><td>文本生成</td></tr><tr><td><strong>Precision/Recall</strong></td><td>集合操作</td><td>检索任务</td></tr><tr><td><strong>Relevance</strong></td><td>LLM 评估</td><td>QA 任务</td></tr><tr><td><strong>Consistency</strong></td><td>多次运行对比</td><td>非确定性任务</td></tr><tr><td><strong>Latency</strong></td><td>时间戳计算</td><td>性能分析</td></tr><tr><td><strong>Cost</strong></td><td>Token 使用量</td><td>成本控制</td></tr></tbody></table><h4 id=123-evaluate-批量测试>1.2.3 evaluate() 批量测试<a class=anchor href=#123-evaluate-%e6%89%b9%e9%87%8f%e6%b5%8b%e8%af%95>#</a></h4><blockquote class=book-hint><p><strong>注意</strong>：LangSmith 1.0+ 中 <code>run_on_dataset()</code> 已重命名为 <code>evaluate()</code>，推荐使用新 API</p></blockquote><p><strong>evaluate() 函数的 data 参数支持的类型</strong>：</p><p><code>evaluate()</code> 函数的 <code>data</code> 参数非常灵活，支持多种数据源：</p><table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>str</code> (数据集名称)</td><td>LangSmith 平台上的数据集名称</td><td><code>"qa_benchmark"</code></td></tr><tr><td><code>str</code> (UUID)</td><td>LangSmith 数据集的 UUID</td><td><code>"a3d2f1b8-..."</code></td></tr><tr><td><code>list[dict]</code></td><td>直接传入示例列表</td><td><code>[{"inputs": {...}, "outputs": {...}}, ...]</code></td></tr><tr><td><code>Iterator[dict]</code></td><td>示例迭代器（用于大数据集）</td><td><code>iter([{...}, {...}])</code></td></tr><tr><td><code>Iterator[Example]</code></td><td>LangSmith Example 对象迭代器</td><td><code>client.list_examples(dataset_name="...")</code></td></tr></tbody></table><p><strong>使用不同类型的示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 使用数据集名称（最常用）</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>  <span class=c1># 数据集名称</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 使用数据集 UUID</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;a3d2f1b8-1234-5678-90ab-cdef12345678&#34;</span><span class=p>,</span>  <span class=c1># UUID</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 直接传入示例列表（快速测试）</span>
</span></span><span class=line><span class=cl><span class=n>examples</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is LangChain?&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain is a framework...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;What is Python?&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=s2>&#34;Python is a programming language...&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>examples</span><span class=p>,</span>  <span class=c1># 列表</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 使用迭代器（大数据集，节省内存）</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>example_generator</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生成器函数，逐个产生示例&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Question </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Answer </span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>example_generator</span><span class=p>(),</span>  <span class=c1># 迭代器</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 使用 LangSmith Example 对象迭代器</span>
</span></span><span class=line><span class=cl><span class=n>examples_iter</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_examples</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span><span class=o>=</span><span class=mi>100</span>  <span class=c1># 只测试前 100 个</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=n>examples_iter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>基本用法</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义预测函数</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict</span><span class=p>(</span><span class=n>input_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;应用的预测函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>question</span> <span class=o>=</span> <span class=n>input_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;question&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调用 Agent</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span> <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=o>...</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>question</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义评估器</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exact_match</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;精确匹配评估&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=k>else</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;exact_match&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>relevance</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;相关性评估&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;问题: </span><span class=si>{</span><span class=n>example</span><span class=o>.</span><span class=n>inputs</span><span class=p>[</span><span class=s1>&#39;question&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>答案: </span><span class=si>{</span><span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s1>&#39;answer&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;评估相关性(0-1):&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=nb>float</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span> <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;relevance&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行评估</span>
</span></span><span class=line><span class=cl><span class=n>experiment_results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>                                    <span class=c1># 预测函数</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>                       <span class=c1># 数据集名称</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>,</span> <span class=n>relevance</span><span class=p>],</span>       <span class=c1># 行级评估器</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Model v1&#34;</span><span class=p>,</span>              <span class=c1># 实验名称前缀</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;测试新模型版本&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>num_repetitions</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>                         <span class=c1># 运行 2 次（处理 LLM 非确定性）</span>
</span></span><span class=line><span class=cl>    <span class=n>max_concurrency</span><span class=o>=</span><span class=mi>10</span>                         <span class=c1># 并发数</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看结果</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;实验名: </span><span class=si>{</span><span class=n>experiment_results</span><span class=o>.</span><span class=n>experiment_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总样例数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>experiment_results</span><span class=o>.</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计指标</span>
</span></span><span class=line><span class=cl><span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>score</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>experiment_results</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均准确率: </span><span class=si>{</span><span class=nb>sum</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>高级用法：Summary Evaluator</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>accuracy_summary</span><span class=p>(</span><span class=n>runs</span><span class=p>,</span> <span class=n>examples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;实验级评估器（在所有运行上计算）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>correct</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>run</span><span class=p>,</span> <span class=n>example</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>runs</span><span class=p>,</span> <span class=n>examples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>correct</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>accuracy</span> <span class=o>=</span> <span class=n>correct</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>runs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>accuracy</span><span class=p>,</span> <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;accuracy&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>precision_recall_summary</span><span class=p>(</span><span class=n>runs</span><span class=p>,</span> <span class=n>examples</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;计算 Precision 和 Recall&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>predictions</span> <span class=o>=</span> <span class=p>[</span><span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>references</span> <span class=o>=</span> <span class=p>[</span><span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>example</span> <span class=ow>in</span> <span class=n>examples</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 假设输出是分类标签列表</span>
</span></span><span class=line><span class=cl>    <span class=n>tp</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>p</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>predictions</span><span class=p>,</span> <span class=n>references</span><span class=p>)</span> <span class=k>if</span> <span class=n>p</span> <span class=o>==</span> <span class=n>r</span> <span class=ow>and</span> <span class=n>p</span> <span class=o>==</span> <span class=s2>&#34;positive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>p</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>predictions</span><span class=p>,</span> <span class=n>references</span><span class=p>)</span> <span class=k>if</span> <span class=n>p</span> <span class=o>!=</span> <span class=n>r</span> <span class=ow>and</span> <span class=n>p</span> <span class=o>==</span> <span class=s2>&#34;positive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fn</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>p</span><span class=p>,</span> <span class=n>r</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>predictions</span><span class=p>,</span> <span class=n>references</span><span class=p>)</span> <span class=k>if</span> <span class=n>p</span> <span class=o>!=</span> <span class=n>r</span> <span class=ow>and</span> <span class=n>r</span> <span class=o>==</span> <span class=s2>&#34;positive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>precision</span> <span class=o>=</span> <span class=n>tp</span> <span class=o>/</span> <span class=p>(</span><span class=n>tp</span> <span class=o>+</span> <span class=n>fp</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>tp</span> <span class=o>+</span> <span class=n>fp</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=n>recall</span> <span class=o>=</span> <span class=n>tp</span> <span class=o>/</span> <span class=p>(</span><span class=n>tp</span> <span class=o>+</span> <span class=n>fn</span><span class=p>)</span> <span class=k>if</span> <span class=p>(</span><span class=n>tp</span> <span class=o>+</span> <span class=n>fn</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>precision</span><span class=p>,</span> <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;precision&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>recall</span><span class=p>,</span> <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;recall&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用 Summary Evaluator</span>
</span></span><span class=line><span class=cl><span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;classification_dataset&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>summary_evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>accuracy_summary</span><span class=p>,</span> <span class=n>precision_recall_summary</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Classification v1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>异步评估（处理大规模数据集）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>aevaluate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=c1># 异步预测函数</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>async_predict</span><span class=p>(</span><span class=n>input_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 异步 Agent 调用</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>async_agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>input_dict</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 运行异步评估</span>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>aevaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>async_predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=s2>&#34;large_dataset&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>,</span> <span class=n>relevance</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Async Model v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>max_concurrency</span><span class=o>=</span><span class=mi>50</span>  <span class=c1># 并发 50 个请求</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span></span></span></code></pre></div><h4 id=124-人工标注与反馈收集>1.2.4 人工标注与反馈收集<a class=anchor href=#124-%e4%ba%ba%e5%b7%a5%e6%a0%87%e6%b3%a8%e4%b8%8e%e5%8f%8d%e9%a6%88%e6%94%b6%e9%9b%86>#</a></h4><p><strong>通过 LangSmith UI 标注</strong>：</p><ol><li><p><strong>创建 Annotation Queue</strong></p><ul><li>在项目中点击 &ldquo;Create Annotation Queue&rdquo;</li><li>选择数据集和要标注的字段</li></ul></li><li><p><strong>标注流程</strong></p><ul><li>逐条查看例子</li><li>给每条结果评分或写评论</li><li>导出标注结果</li></ul></li></ol><p><strong>编程方式收集反馈</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用中收集用户反馈</span>
</span></span><span class=line><span class=cl><span class=n>run_id</span> <span class=o>=</span> <span class=s2>&#34;run-123&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用户点赞/点踩</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_feedback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_id</span><span class=o>=</span><span class=n>run_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;user_rating&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>  <span class=c1># 1.0 = 好, 0.0 = 不好</span>
</span></span><span class=line><span class=cl>    <span class=n>comment</span><span class=o>=</span><span class=s2>&#34;回答很准确！&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 专家标注</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>create_feedback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_id</span><span class=o>=</span><span class=n>run_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span><span class=o>=</span><span class=s2>&#34;expert_annotation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span><span class=o>=</span><span class=mf>0.8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>comment</span><span class=o>=</span><span class=s2>&#34;大部分正确，但第二点不够准确&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 导出所有反馈用于分析</span>
</span></span><span class=line><span class=cl><span class=n>feedbacks</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_feedbacks</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>run_ids</span><span class=o>=</span><span class=p>[</span><span class=n>run_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>feedback</span> <span class=ow>in</span> <span class=n>feedbacks</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>key</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>score</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>feedback</span><span class=o>.</span><span class=n>comment</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=13-持续优化>1.3 持续优化<a class=anchor href=#13-%e6%8c%81%e7%bb%ad%e4%bc%98%e5%8c%96>#</a></h3><h4 id=131-prompt-hub-版本控制>1.3.1 Prompt Hub 版本控制<a class=anchor href=#131-prompt-hub-%e7%89%88%e6%9c%ac%e6%8e%a7%e5%88%b6>#</a></h4><p><strong>场景</strong>：系统提示词需要版本管理和对比。</p><p><strong>使用 LangSmith Prompt Hub</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 1：将提示词推送到 Hub</span>
</span></span><span class=line><span class=cl><span class=n>system_prompt_v1</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个专业的编程助手。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>能力：
</span></span></span><span class=line><span class=cl><span class=s2>1. 回答编程问题
</span></span></span><span class=line><span class=cl><span class=s2>2. 生成代码
</span></span></span><span class=line><span class=cl><span class=s2>3. 调试错误
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>约束：
</span></span></span><span class=line><span class=cl><span class=s2>- 只讨论编程相关话题
</span></span></span><span class=line><span class=cl><span class=s2>- 生成的代码要有注释
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建提示词模板</span>
</span></span><span class=line><span class=cl><span class=n>prompt_template</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_messages</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=n>system_prompt_v1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>{input}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推送到 Hub（需要 API 权限）</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>push_prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt_identifier</span><span class=o>=</span><span class=s2>&#34;programming_assistant_system_prompt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>object</span><span class=o>=</span><span class=n>prompt_template</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;编程助手的系统提示词&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 2：从 Hub 拉取提示词</span>
</span></span><span class=line><span class=cl><span class=n>system_prompt</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>pull_prompt</span><span class=p>(</span><span class=s2>&#34;programming_assistant_system_prompt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法 3：版本管理</span>
</span></span><span class=line><span class=cl><span class=c1># 每次推送自动创建新版本，可以：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 查看历史版本</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 对比版本差异</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 拉取特定版本</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>updated_prompt_v2</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;你是一个专业的编程助手。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>增强能力：
</span></span></span><span class=line><span class=cl><span class=s2>1. 回答编程问题
</span></span></span><span class=line><span class=cl><span class=s2>2. 生成代码
</span></span></span><span class=line><span class=cl><span class=s2>3. 调试错误
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>约束：
</span></span></span><span class=line><span class=cl><span class=s2>- 只讨论编程相关话题
</span></span></span><span class=line><span class=cl><span class=s2>- 生成的代码要有注释
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 推送新版本（自动创建版本 2）</span>
</span></span><span class=line><span class=cl><span class=n>updated_template</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_messages</span><span class=p>([</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;system&#34;</span><span class=p>,</span> <span class=n>updated_prompt_v2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;</span><span class=si>{input}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>push_prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt_identifier</span><span class=o>=</span><span class=s2>&#34;programming_assistant_system_prompt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>object</span><span class=o>=</span><span class=n>updated_template</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;添加 &#39;增强&#39; 前缀以强调能力&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>版本对比</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 在 LangSmith UI 中：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 打开 Prompt Hub</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 选择提示词</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 点击 &#34;Compare Versions&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 4. 查看变化和对比结果</span></span></span></code></pre></div><h4 id=132-ab-测试>1.3.2 A/B 测试<a class=anchor href=#132-ab-%e6%b5%8b%e8%af%95>#</a></h4><p><strong>完整的 A/B 测试流程</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 版本 A：原始模型和提示词</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict_v_a</span><span class=p>(</span><span class=n>input_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=o>...</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是一个助手&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>input_dict</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 版本 B：改进的提示词</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict_v_b</span><span class=p>(</span><span class=n>input_dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=o>...</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个专业的助手。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>在回答前：
</span></span></span><span class=line><span class=cl><span class=s2>1. 理解问题的关键信息
</span></span></span><span class=line><span class=cl><span class=s2>2. 分解复杂问题为子问题
</span></span></span><span class=line><span class=cl><span class=s2>3. 使用工具获取必要信息
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>最后提供清晰、准确的答案。&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>input_dict</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义评估器</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exact_match</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=mf>1.0</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=p>[</span><span class=s2>&#34;answer&#34;</span><span class=p>]</span> <span class=k>else</span> <span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;exact_match&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行版本 A</span>
</span></span><span class=line><span class=cl><span class=n>experiment_a</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict_v_a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Version A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;基准版本&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行版本 B</span>
</span></span><span class=line><span class=cl><span class=n>experiment_b</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict_v_b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Version B&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;改进的提示词&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对比结果</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 版本对比 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;版本 A 准确率: </span><span class=si>{</span><span class=n>calculate_accuracy</span><span class=p>(</span><span class=n>experiment_a</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;版本 B 准确率: </span><span class=si>{</span><span class=n>calculate_accuracy</span><span class=p>(</span><span class=n>experiment_b</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>calculate_accuracy</span><span class=p>(</span><span class=n>experiment</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>score</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>experiment</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span></span></span></code></pre></div><p><strong>统计显著性检验</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取两个版本的评分</span>
</span></span><span class=line><span class=cl><span class=n>scores_a</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>score</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>experiment_a</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>scores_b</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>score</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>experiment_b</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># T 检验</span>
</span></span><span class=line><span class=cl><span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>scores_a</span><span class=p>,</span> <span class=n>scores_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;T 统计量: </span><span class=si>{</span><span class=n>t_stat</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;P 值: </span><span class=si>{</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>sum</span><span class=p>(</span><span class=n>scores_b</span><span class=p>)</span> <span class=o>&gt;</span> <span class=nb>sum</span><span class=p>(</span><span class=n>scores_a</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 版本 B 显著更好（p &lt; 0.05）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 版本 A 显著更好（p &lt; 0.05）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;⚠️  差异不显著（p &gt;= 0.05）&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=133-监控指标与问题发现>1.3.3 监控指标与问题发现<a class=anchor href=#133-%e7%9b%91%e6%8e%a7%e6%8c%87%e6%a0%87%e4%b8%8e%e9%97%ae%e9%a2%98%e5%8f%91%e7%8e%b0>#</a></h4><p><strong>关键监控指标</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 监控指标收集</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>monitor_agent_health</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent 健康监测&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取最近 24 小时的运行</span>
</span></span><span class=line><span class=cl>    <span class=n>yesterday</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>runs</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_runs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>project_name</span><span class=o>=</span><span class=s2>&#34;my_agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span><span class=o>=</span><span class=n>yesterday</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算关键指标</span>
</span></span><span class=line><span class=cl>    <span class=n>total_runs</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>runs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>successful_runs</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>error_runs</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=mi>1</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>avg_duration</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>run</span><span class=o>.</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>run</span><span class=o>.</span><span class=n>start_time</span><span class=p>)</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>/</span> <span class=n>total_runs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>total_cost</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>run</span><span class=o>.</span><span class=n>cost</span> <span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>runs</span> <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>cost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算错误率</span>
</span></span><span class=line><span class=cl>    <span class=n>error_rate</span> <span class=o>=</span> <span class=n>error_runs</span> <span class=o>/</span> <span class=n>total_runs</span> <span class=k>if</span> <span class=n>total_runs</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 计算成本效率</span>
</span></span><span class=line><span class=cl>    <span class=n>cost_per_success</span> <span class=o>=</span> <span class=n>total_cost</span> <span class=o>/</span> <span class=n>successful_runs</span> <span class=k>if</span> <span class=n>successful_runs</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 返回指标</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;total_runs&#34;</span><span class=p>:</span> <span class=n>total_runs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;success_rate&#34;</span><span class=p>:</span> <span class=n>successful_runs</span> <span class=o>/</span> <span class=n>total_runs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;error_rate&#34;</span><span class=p>:</span> <span class=n>error_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;avg_duration&#34;</span><span class=p>:</span> <span class=n>avg_duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;total_cost&#34;</span><span class=p>:</span> <span class=n>total_cost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;cost_per_success&#34;</span><span class=p>:</span> <span class=n>cost_per_success</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>metrics</span> <span class=o>=</span> <span class=n>monitor_agent_health</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== Agent 健康监测 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总请求: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_runs&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成功率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;success_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;错误率: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均耗时: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;总成本: $</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;total_cost&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;成本/成功: $</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;cost_per_success&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>问题自动告警</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_health_alerts</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查是否有告警条件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics</span> <span class=o>=</span> <span class=n>monitor_agent_health</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 错误率过高</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;error_rate&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># &gt; 10%</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  错误率过高: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 响应时间过长</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;avg_duration&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>30</span><span class=p>:</span>  <span class=c1># &gt; 30秒</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  平均响应时间过长: </span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;avg_duration&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 成本突增</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>metrics</span><span class=p>[</span><span class=s2>&#34;cost_per_success&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mf>0.01</span><span class=p>:</span>  <span class=c1># &gt; $0.01 per success</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  成本过高: $</span><span class=si>{</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;cost_per_success&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>alerts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=== 告警 ===&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>alert</span> <span class=ow>in</span> <span class=n>alerts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=n>alert</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 系统健康&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>反馈驱动的问题发现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 查找用户标记为&#34;不好&#34;的运行</span>
</span></span><span class=line><span class=cl><span class=n>bad_runs</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>list_runs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>project_name</span><span class=o>=</span><span class=s2>&#34;my_agent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nb>filter</span><span class=o>=</span><span class=s1>&#39;feedback_key:&#34;user_rating&#34; AND feedback_score:0&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;找到 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>bad_runs</span><span class=p>)</span><span class=si>}</span><span class=s2> 条差评运行&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分析失败原因</span>
</span></span><span class=line><span class=cl><span class=n>failure_patterns</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>run</span> <span class=ow>in</span> <span class=n>bad_runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取失败的工具调用</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>run</span><span class=o>.</span><span class=n>child_runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>run</span><span class=o>.</span><span class=n>child_runs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>child</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=s2>&#34;error&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>tool_name</span> <span class=o>=</span> <span class=n>child</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>tool_name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>failure_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>failure_patterns</span><span class=p>[</span><span class=n>tool_name</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=n>failure_patterns</span><span class=p>[</span><span class=n>tool_name</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 排序并显示</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>tool</span><span class=p>,</span> <span class=n>count</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>failure_patterns</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>tool</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2> 次失败&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=134-优化迭代流程>1.3.4 优化迭代流程<a class=anchor href=#134-%e4%bc%98%e5%8c%96%e8%bf%ad%e4%bb%a3%e6%b5%81%e7%a8%8b>#</a></h4><p><strong>完整的优化循环</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 基准测试 → 获得当前性能基线
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>2. 假设提出 → 例如&#34;改进提示词可以提高准确率 5%&#34;
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>3. 制定对策 → 编写新的提示词或改进模型选择
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>4. 运行 A/B 测试 → 对比新旧版本
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>5. 分析结果 → 是否满足假设？
</span></span><span class=line><span class=cl>   ├─ 是 → 更新版本到生产
</span></span><span class=line><span class=cl>   └─ 否 → 返回步骤 2，尝试新假设
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>6. 监控上线 → 持续监控生产指标
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>7. 收集反馈 → 用户标注、问题报告
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>8. 返回步骤 1 → 开始新一轮优化</span></span></code></pre></div><p><strong>实现优化循环的代码框架</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ContinuousOptimization</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>project_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>project_name</span> <span class=o>=</span> <span class=n>project_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iteration</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>baseline</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获得基准测试结果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>,</span> <span class=n>relevance</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>experiment_prefix</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Baseline_</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=s2>&#34;基准版本&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>accuracy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_accuracy</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📊 基线准确率: </span><span class=si>{</span><span class=n>accuracy</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>propose_hypothesis</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>hypothesis</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提出假设&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>hypothesis</span> <span class=o>=</span> <span class=n>hypothesis</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;💡 假设: </span><span class=si>{</span><span class=n>hypothesis</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>implement_changes</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>changes</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;实现改进&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>changes</span> <span class=o>=</span> <span class=n>changes</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚙️  改进: </span><span class=si>{</span><span class=n>changes</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run_experiment</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;运行实验&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>iteration</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 这里调用改进后的预测函数</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>predict_improved</span><span class=p>,</span>  <span class=c1># 改进后的版本</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=o>=</span><span class=s2>&#34;qa_benchmark&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>exact_match</span><span class=p>,</span> <span class=n>relevance</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>experiment_prefix</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;Iteration_</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>iteration</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>description</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;改进: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>hypothesis</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>new_accuracy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_accuracy</span><span class=p>(</span><span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>new_accuracy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>compare_with_baseline</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>baseline_acc</span><span class=p>,</span> <span class=n>new_acc</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;对比改进效果&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>improvement</span> <span class=o>=</span> <span class=p>(</span><span class=n>new_acc</span> <span class=o>-</span> <span class=n>baseline_acc</span><span class=p>)</span> <span class=o>/</span> <span class=n>baseline_acc</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>improvement</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 改进成功! 提升 </span><span class=si>{</span><span class=n>improvement</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;❌ 未达到预期，下降 </span><span class=si>{</span><span class=nb>abs</span><span class=p>(</span><span class=n>improvement</span><span class=p>)</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>deploy_to_production</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;部署到生产环境&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🚀 部署新版本到生产&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 更新生产 Agent 的配置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_accuracy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>scores</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>score</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>sum</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>scores</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>optimization</span> <span class=o>=</span> <span class=n>ContinuousOptimization</span><span class=p>(</span><span class=s2>&#34;my_agent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 1 轮：基准</span>
</span></span><span class=line><span class=cl><span class=n>baseline_results</span> <span class=o>=</span> <span class=n>optimization</span><span class=o>.</span><span class=n>baseline</span><span class=p>()</span>  <span class=c1># 准确率: 75%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 2 轮：改进提示词</span>
</span></span><span class=line><span class=cl><span class=n>optimization</span><span class=o>.</span><span class=n>propose_hypothesis</span><span class=p>(</span><span class=s2>&#34;详细的系统提示词能提高准确率&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>optimization</span><span class=o>.</span><span class=n>implement_changes</span><span class=p>({</span><span class=s2>&#34;system_prompt&#34;</span><span class=p>:</span> <span class=s2>&#34;新提示词...&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>acc_v2</span> <span class=o>=</span> <span class=n>optimization</span><span class=o>.</span><span class=n>run_experiment</span><span class=p>()</span>  <span class=c1># 准确率: 78%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>optimization</span><span class=o>.</span><span class=n>compare_with_baseline</span><span class=p>(</span><span class=mf>0.75</span><span class=p>,</span> <span class=n>acc_v2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>optimization</span><span class=o>.</span><span class=n>deploy_to_production</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第 3 轮：切换模型</span>
</span></span><span class=line><span class=cl><span class=n>optimization</span><span class=o>.</span><span class=n>propose_hypothesis</span><span class=p>(</span><span class=s2>&#34;使用更强的模型能进一步提高准确率&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>optimization</span><span class=o>.</span><span class=n>implement_changes</span><span class=p>({</span><span class=s2>&#34;model&#34;</span><span class=p>:</span> <span class=s2>&#34;gpt-4o&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>acc_v3</span> <span class=o>=</span> <span class=n>optimization</span><span class=o>.</span><span class=n>run_experiment</span><span class=p>()</span>  <span class=c1># 准确率: 82%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>optimization</span><span class=o>.</span><span class=n>compare_with_baseline</span><span class=p>(</span><span class=mf>0.75</span><span class=p>,</span> <span class=n>acc_v3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>optimization</span><span class=o>.</span><span class=n>deploy_to_production</span><span class=p>()</span></span></span></code></pre></div><hr><h3 id=本章小结>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h3><ol><li><strong>追踪体系</strong>：自动和手动追踪，形成完整的执行树，用于调试和分析</li><li><strong>Evaluation 框架</strong>：Dataset + Evaluator 的组合，支持启发式、LLM、人工评估</li><li><strong>批量测试</strong>：<code>evaluate()</code> 和 <code>aevaluate()</code> 函数，支持行级和实验级评估</li><li><strong>持续优化</strong>：A/B 测试、版本控制、监控告警、迭代流程</li></ol><hr><h3 id=思考与练习>思考与练习<a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0>#</a></h3><ol><li><p><strong>思考</strong>：为什么需要 <code>num_repetitions > 1</code> 在 <code>evaluate()</code> 中？</p><details><summary>答案</summary><p>LLM 的输出有随机性（由 temperature 参数控制）。运行多次可以：</p><ol><li>评估模型的稳定性</li><li>获得更准确的平均指标</li><li>检测随机导致的偶然好/坏结果</li></ol></details></li><li><p><strong>练习</strong>：实现一个 <code>f1_score_summary()</code> 评估器，计算 F1 分数。</p></li><li><p><strong>思考</strong>：如何设计一个反馈循环，自动识别失败模式并提出改进建议？</p></li></ol><hr><h3 id=总结与展望>总结与展望<a class=anchor href=#%e6%80%bb%e7%bb%93%e4%b8%8e%e5%b1%95%e6%9c%9b>#</a></h3><p>通过 LangSmith 的追踪和评估体系，我们已经掌握了：</p><ul><li><strong>可观测性</strong>：完整的执行链路可见</li><li><strong>可测试性</strong>：科学的评估框架</li><li><strong>可优化性</strong>：数据驱动的迭代</li></ul><p>这些能力为后续的高级应用（多 Agent、MCP 集成）和生产实践提供了坚实的基础。</p><hr><p><strong>参考资源</strong>：</p><ul><li><a href=https://docs.langchain.com/langsmith>LangSmith 官方文档</a></li><li><a href=https://langsmith-sdk.readthedocs.io>LangSmith Python SDK</a></li><li><a href=https://blog.langchain.com>LangSmith 最佳实践</a></li></ul><hr><h2 id=第2章-架构设计模式>第2章： 架构设计模式<a class=anchor href=#%e7%ac%ac2%e7%ab%a0-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>：掌握生产级 LangChain 应用的架构设计。</p></blockquote><h3 id=21-rag-架构设计>2.1 RAG 架构设计<a class=anchor href=#21-rag-%e6%9e%b6%e6%9e%84%e8%ae%be%e8%ae%a1>#</a></h3><p><strong>生产级 RAG 系统架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                         用户接口层                             │
</span></span><span class=line><span class=cl>│                    (Web/API/Chat Interface)                   │
</span></span><span class=line><span class=cl>└─────────────┬───────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>              │
</span></span><span class=line><span class=cl>┌─────────────▼───────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                        应用服务层                              │
</span></span><span class=line><span class=cl>│   ┌─────────────┐  ┌──────────────┐  ┌─────────────┐       │
</span></span><span class=line><span class=cl>│   │ 查询处理器   │  │  Agent 引擎   │  │ 结果后处理   │       │
</span></span><span class=line><span class=cl>│   └─────────────┘  └──────────────┘  └─────────────┘       │
</span></span><span class=line><span class=cl>└─────────────┬───────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>              │
</span></span><span class=line><span class=cl>┌─────────────▼───────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                         核心层                                │
</span></span><span class=line><span class=cl>│   ┌────────────┐  ┌────────────┐  ┌─────────────┐          │
</span></span><span class=line><span class=cl>│   │ 向量检索器  │  │ 重排序器    │  │  LLM 网关    │          │
</span></span><span class=line><span class=cl>│   └────────────┘  └────────────┘  └─────────────┘          │
</span></span><span class=line><span class=cl>└─────────────┬───────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>              │
</span></span><span class=line><span class=cl>┌─────────────▼───────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                        数据层                                 │
</span></span><span class=line><span class=cl>│   ┌────────────┐  ┌────────────┐  ┌─────────────┐          │
</span></span><span class=line><span class=cl>│   │ 向量数据库  │  │ 文档存储    │  │  缓存层     │          │
</span></span><span class=line><span class=cl>│   └────────────┘  └────────────┘  └─────────────┘          │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘</span></span></code></pre></div><p><strong>实现代码</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span><span class=p>,</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.vectorstores</span> <span class=kn>import</span> <span class=n>Pinecone</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers</span> <span class=kn>import</span> <span class=n>ContextualCompressionRetriever</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_community.retrievers.document_compressors</span> <span class=kn>import</span> <span class=n>CohereRerank</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.documents</span> <span class=kn>import</span> <span class=n>Document</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionRAGSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生产级 RAG 系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>config</span> <span class=o>=</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;text-embedding-3-large&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_init_vector_store</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_init_cache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>llm</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_init_llm</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_init_retriever</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_init_vector_store</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化向量数据库&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Pinecone</span><span class=o>.</span><span class=n>from_existing_index</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>index_name</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;pinecone_index&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>embedding</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>namespace</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;namespace&#34;</span><span class=p>,</span> <span class=s2>&#34;default&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_init_cache</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化缓存层&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>host</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;redis_host&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;redis_port&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>db</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>decode_responses</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_init_llm</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化 LLM 网关&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ChatOpenAI</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;llm_model&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>temperature</span><span class=o>=</span><span class=mf>0.7</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>request_timeout</span><span class=o>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_init_retriever</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化检索器（带重排序）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>base_retriever</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>as_retriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>search_kwargs</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;k&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;retrieve_k&#34;</span><span class=p>,</span> <span class=mi>10</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加压缩/重排序（使用 CohereRerank）</span>
</span></span><span class=line><span class=cl>        <span class=n>compressor</span> <span class=o>=</span> <span class=n>CohereRerank</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;rerank-multilingual-v3.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>top_n</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;top_k&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ContextualCompressionRetriever</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>base_compressor</span><span class=o>=</span><span class=n>compressor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>base_retriever</span><span class=o>=</span><span class=n>base_retriever</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_cache_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成缓存键&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;rag:</span><span class=si>{</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>retrieve</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检索相关文档&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 查询改写</span>
</span></span><span class=line><span class=cl>        <span class=n>rewritten_query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rewrite_query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检索</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=o>.</span><span class=n>get_relevant_documents</span><span class=p>(</span><span class=n>rewritten_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 后处理</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_post_process_docs</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_rewrite_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;查询改写（提高检索质量）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;请改写以下查询，使其更适合向量检索：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>原始查询：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>改写后的查询（保持语义，优化关键词）：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_post_process_docs</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;文档后处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 去重</span>
</span></span><span class=line><span class=cl>        <span class=n>seen</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>unique_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>doc_hash</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>doc_hash</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>seen</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>seen</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>doc_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>unique_docs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>doc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 按相关性重新排序</span>
</span></span><span class=line><span class=cl>        <span class=n>unique_docs</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=o>.</span><span class=n>metadata</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;score&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>),</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>unique_docs</span><span class=p>[:</span><span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;top_k&#34;</span><span class=p>,</span> <span class=mi>5</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_answer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>docs</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成答案&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;基于以下上下文回答问题：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文：
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题：</span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>答案：&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>llm</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>use_cache</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;完整查询流程&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>use_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_key</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_cache_key</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>cached</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检索</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retrieve</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 生成答案</span>
</span></span><span class=line><span class=cl>        <span class=n>answer</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_answer</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>answer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sources&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=p>[:</span><span class=mi>200</span><span class=p>]</span> <span class=o>+</span> <span class=s2>&#34;...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 写入缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>use_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>cache_key</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;cache_ttl&#34;</span><span class=p>,</span> <span class=mi>3600</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span></span></span></code></pre></div><p><strong>RAG Agent 实现（推荐）</strong>：</p><p>使用 <code>@tool(response_format="content_and_artifact")</code> 是构建 RAG Agent 的官方推荐方式，允许工具同时返回内容和原始数据：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span><span class=p>,</span> <span class=n>OpenAIEmbeddings</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_chroma</span> <span class=kn>import</span> <span class=n>Chroma</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建向量存储</span>
</span></span><span class=line><span class=cl><span class=n>vectorstore</span> <span class=o>=</span> <span class=n>Chroma</span><span class=o>.</span><span class=n>from_documents</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>documents</span><span class=o>=</span><span class=p>[</span><span class=o>...</span><span class=p>],</span>  <span class=c1># 你的文档</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding</span><span class=o>=</span><span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义检索工具（使用 content_and_artifact 格式）</span>
</span></span><span class=line><span class=cl><span class=nd>@tool</span><span class=p>(</span><span class=n>response_format</span><span class=o>=</span><span class=s2>&#34;content_and_artifact&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retrieve_docs</span><span class=p>(</span><span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检索相关文档
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        query: 用户查询
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        (content, artifact): 内容摘要和原始文档列表
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 检索文档</span>
</span></span><span class=line><span class=cl>    <span class=n>docs</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 构造返回内容</span>
</span></span><span class=line><span class=cl>    <span class=n>content</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;找到 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span><span class=si>}</span><span class=s2> 个相关文档&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>artifact</span> <span class=o>=</span> <span class=p>[</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>]</span>  <span class=c1># 原始文档</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>content</span><span class=p>,</span> <span class=n>artifact</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 RAG Agent</span>
</span></span><span class=line><span class=cl><span class=n>rag_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>retrieve_docs</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是一个 RAG 助手。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>使用 retrieve_docs 工具获取相关文档，然后基于文档内容回答问题。
</span></span></span><span class=line><span class=cl><span class=s2>如果文档中没有相关信息，明确告诉用户。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;LangChain 1.0 有哪些新特性？&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># Agent 会自动：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 调用 retrieve_docs 工具</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 访问 artifact 中的原始文档</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 基于文档内容生成答案</span></span></span></code></pre></div><p><strong>使用 RunnablePassthrough.assign() 的 LCEL 方式</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.runnables</span> <span class=kn>import</span> <span class=n>RunnablePassthrough</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.prompts</span> <span class=kn>import</span> <span class=n>ChatPromptTemplate</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义 RAG 提示词</span>
</span></span><span class=line><span class=cl><span class=n>rag_prompt</span> <span class=o>=</span> <span class=n>ChatPromptTemplate</span><span class=o>.</span><span class=n>from_template</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>基于以下上下文回答问题：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>上下文:
</span></span></span><span class=line><span class=cl><span class=si>{context}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>问题: </span><span class=si>{question}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答:
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建 RAG 链（使用 assign 添加检索结果）</span>
</span></span><span class=line><span class=cl><span class=n>rag_chain</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>RunnablePassthrough</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>],</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>RunnablePassthrough</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span> <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;context&#34;</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>rag_prompt</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>answer</span> <span class=o>=</span> <span class=n>rag_chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain 1.0 有哪些新特性？&#34;</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div><p><strong>使用 @dynamic_prompt 的 Middleware 方式（推荐）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>dynamic_prompt</span><span class=p>,</span> <span class=n>ModelRequest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dynamic_prompt</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>prompt_with_context</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=n>ModelRequest</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;动态注入检索上下文&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 获取最后一条用户消息</span>
</span></span><span class=line><span class=cl>    <span class=n>last_query</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 执行检索</span>
</span></span><span class=line><span class=cl>    <span class=n>retrieved_docs</span> <span class=o>=</span> <span class=n>vectorstore</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>last_query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 格式化文档内容</span>
</span></span><span class=line><span class=cl>    <span class=n>docs_content</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;文档 </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>:</span><span class=se>\n</span><span class=si>{</span><span class=n>doc</span><span class=o>.</span><span class=n>page_content</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>retrieved_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 返回系统消息（会自动注入到请求中）</span>
</span></span><span class=line><span class=cl>    <span class=n>system_message</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;你是一个 RAG 助手。使用以下上下文回答用户问题:</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>docs_content</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;如果上下文中没有相关信息，请明确告知用户。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>system_message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建 Agent（传入 middleware）</span>
</span></span><span class=line><span class=cl><span class=n>rag_agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>  <span class=c1># 不需要工具，检索在 middleware 中完成</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>prompt_with_context</span><span class=p>]</span>  <span class=c1># ✅ 关键：传入 dynamic_prompt</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用（自动在每次请求前检索）</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>rag_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;LangChain 1.0 有哪些新特性？&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span></span></span></code></pre></div><p><strong>@dynamic_prompt 的优势</strong>：</p><ol><li><strong>自动执行</strong>：每次模型调用前自动检索，无需手动调用工具</li><li><strong>单次推理</strong>：只需 1 次 LLM 调用（vs Agent 工具模式需要 2 次）</li><li><strong>透明注入</strong>：上下文自动添加到系统消息，模型无感知</li><li><strong>适合简单场景</strong>：固定的检索-回答流程，性能最优</li></ol><p><strong>三种 RAG 实现方式对比</strong>：</p><table><thead><tr><th>特性</th><th>Agent + Tool</th><th>@dynamic_prompt</th><th>LCEL Chain</th></tr></thead><tbody><tr><td><strong>LLM 调用次数</strong></td><td>2 次（决策+回答）</td><td>1 次</td><td>1 次</td></tr><tr><td><strong>灵活性</strong></td><td>高（自主决策）</td><td>中（固定检索）</td><td>低（固定流程）</td></tr><tr><td><strong>复杂度</strong></td><td>低（自动推理）</td><td>低（Middleware）</td><td>中（需设计链）</td></tr><tr><td><strong>成本</strong></td><td>较高</td><td>中等</td><td>较低</td></tr><tr><td><strong>可控性</strong></td><td>低</td><td>中</td><td>高</td></tr><tr><td><strong>适用场景</strong></td><td>复杂查询、多步推理</td><td>简单 RAG、性能优化</td><td>完全自定义流程</td></tr></tbody></table><p><strong>推荐实践</strong>：</p><ol><li><strong>简单 RAG（单次检索）</strong>：使用 <code>@dynamic_prompt</code>（性能最优）</li><li><strong>复杂查询（多次检索）</strong>：使用 Agent + Tool（自动决策）</li><li><strong>完全自定义流程</strong>：使用 LCEL Chain（最大控制）</li><li><strong>混合方案</strong>：Agent + dynamic_prompt（灵活性与效率兼顾）</li></ol><hr><p><strong>RAG 优化策略</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>OptimizedRAGPipeline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;优化的 RAG 流水线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>strategies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;hybrid_search&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>hybrid_search</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;multi_query&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>multi_query_retrieval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;iterative&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>iterative_retrieval</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ensemble&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>ensemble_retrieval</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>hybrid_search</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;混合搜索（向量 + 关键词）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 向量搜索</span>
</span></span><span class=line><span class=cl>        <span class=n>vector_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>similarity_search</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># BM25 关键词搜索</span>
</span></span><span class=line><span class=cl>        <span class=n>keyword_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>bm25_retriever</span><span class=o>.</span><span class=n>get_relevant_documents</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 合并结果</span>
</span></span><span class=line><span class=cl>        <span class=n>all_docs</span> <span class=o>=</span> <span class=n>vector_results</span> <span class=o>+</span> <span class=n>keyword_results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 使用 RRF (Reciprocal Rank Fusion) 重排序</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_reciprocal_rank_fusion</span><span class=p>(</span><span class=n>all_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>multi_query_retrieval</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;多查询检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 生成多个查询变体</span>
</span></span><span class=line><span class=cl>        <span class=n>queries</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_query_variants</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>all_docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=o>.</span><span class=n>get_relevant_documents</span><span class=p>(</span><span class=n>q</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>all_docs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 去重并重排序</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_deduplicate_and_rank</span><span class=p>(</span><span class=n>all_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>iterative_retrieval</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_iterations</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;迭代检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>docs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>current_query</span> <span class=o>=</span> <span class=n>query</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_iterations</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检索</span>
</span></span><span class=line><span class=cl>            <span class=n>new_docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retriever</span><span class=o>.</span><span class=n>get_relevant_documents</span><span class=p>(</span><span class=n>current_query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>docs</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>new_docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 判断是否需要继续</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_is_sufficient</span><span class=p>(</span><span class=n>docs</span><span class=p>,</span> <span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 基于已有结果生成新查询</span>
</span></span><span class=line><span class=cl>            <span class=n>current_query</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_followup_query</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>docs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>ensemble_retrieval</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Document</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;集成检索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>retrievers</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>dense_retriever</span><span class=p>,</span>    <span class=c1># 密集向量</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>sparse_retriever</span><span class=p>,</span>   <span class=c1># 稀疏向量</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cross_encoder</span>      <span class=c1># 交叉编码器</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>all_results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>weights</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>]</span>  <span class=c1># 权重</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>retriever</span><span class=p>,</span> <span class=n>weight</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>retrievers</span><span class=p>,</span> <span class=n>weights</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>docs</span> <span class=o>=</span> <span class=n>retriever</span><span class=o>.</span><span class=n>get_relevant_documents</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>doc</span> <span class=ow>in</span> <span class=n>docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=s2>&#34;weight&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>weight</span>
</span></span><span class=line><span class=cl>            <span class=n>all_results</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>docs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_weighted_merge</span><span class=p>(</span><span class=n>all_results</span><span class=p>)</span></span></span></code></pre></div><h3 id=22-multi-agent-架构选择>2.2 Multi-Agent 架构选择<a class=anchor href=#22-multi-agent-%e6%9e%b6%e6%9e%84%e9%80%89%e6%8b%a9>#</a></h3><p><strong>生产环境多 Agent 架构决策</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentArchitecture</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent 架构类型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>MONOLITHIC</span> <span class=o>=</span> <span class=s2>&#34;monolithic&#34;</span>           <span class=c1># 单体 Agent</span>
</span></span><span class=line><span class=cl>    <span class=n>SUPERVISOR_WORKER</span> <span class=o>=</span> <span class=s2>&#34;supervisor&#34;</span>     <span class=c1># 监督者-工作者</span>
</span></span><span class=line><span class=cl>    <span class=n>PIPELINE</span> <span class=o>=</span> <span class=s2>&#34;pipeline&#34;</span>                <span class=c1># 流水线</span>
</span></span><span class=line><span class=cl>    <span class=n>HIERARCHICAL</span> <span class=o>=</span> <span class=s2>&#34;hierarchical&#34;</span>       <span class=c1># 层级</span>
</span></span><span class=line><span class=cl>    <span class=n>MESH</span> <span class=o>=</span> <span class=s2>&#34;mesh&#34;</span>                       <span class=c1># 网状</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ArchitectureDecision</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;架构决策&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>architecture</span><span class=p>:</span> <span class=n>AgentArchitecture</span>
</span></span><span class=line><span class=cl>    <span class=n>reason</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>pros</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>cons</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>implementation_complexity</span><span class=p>:</span> <span class=nb>int</span>  <span class=c1># 1-10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ArchitectureSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;架构选择器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>task_complexity</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>      <span class=c1># 1-10</span>
</span></span><span class=line><span class=cl>        <span class=n>team_size</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>            <span class=c1># Agent 数量</span>
</span></span><span class=line><span class=cl>        <span class=n>coordination_level</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>    <span class=c1># low/medium/high</span>
</span></span><span class=line><span class=cl>        <span class=n>latency_requirement</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>   <span class=c1># low/medium/high</span>
</span></span><span class=line><span class=cl>        <span class=n>scalability_need</span><span class=p>:</span> <span class=nb>str</span>       <span class=c1># low/medium/high</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ArchitectureDecision</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;选择合适的架构&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 简单任务</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>task_complexity</span> <span class=o>&lt;=</span> <span class=mi>3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>team_size</span> <span class=o>&lt;=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ArchitectureDecision</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>architecture</span><span class=o>=</span><span class=n>AgentArchitecture</span><span class=o>.</span><span class=n>MONOLITHIC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;简单任务使用单体 Agent 即可&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>pros</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;简单&#34;</span><span class=p>,</span> <span class=s2>&#34;低延迟&#34;</span><span class=p>,</span> <span class=s2>&#34;易调试&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>cons</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;扩展性差&#34;</span><span class=p>,</span> <span class=s2>&#34;功能受限&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>implementation_complexity</span><span class=o>=</span><span class=mi>2</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 中等复杂度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>task_complexity</span> <span class=o>&lt;=</span> <span class=mi>6</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>coordination_level</span> <span class=o>==</span> <span class=s2>&#34;high&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ArchitectureDecision</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>architecture</span><span class=o>=</span><span class=n>AgentArchitecture</span><span class=o>.</span><span class=n>SUPERVISOR_WORKER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;需要高度协调，使用监督者模式&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>pros</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;控制清晰&#34;</span><span class=p>,</span> <span class=s2>&#34;易于管理&#34;</span><span class=p>,</span> <span class=s2>&#34;责任明确&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>cons</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;中央瓶颈&#34;</span><span class=p>,</span> <span class=s2>&#34;监督者复杂&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>implementation_complexity</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ArchitectureDecision</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>architecture</span><span class=o>=</span><span class=n>AgentArchitecture</span><span class=o>.</span><span class=n>PIPELINE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;顺序处理任务，使用流水线&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>pros</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;流程清晰&#34;</span><span class=p>,</span> <span class=s2>&#34;易于扩展&#34;</span><span class=p>,</span> <span class=s2>&#34;可并行&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>cons</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;灵活性差&#34;</span><span class=p>,</span> <span class=s2>&#34;错误传播&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>implementation_complexity</span><span class=o>=</span><span class=mi>4</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 高复杂度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>team_size</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ArchitectureDecision</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>architecture</span><span class=o>=</span><span class=n>AgentArchitecture</span><span class=o>.</span><span class=n>HIERARCHICAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;大规模团队需要层级管理&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>pros</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;可扩展&#34;</span><span class=p>,</span> <span class=s2>&#34;职责清晰&#34;</span><span class=p>,</span> <span class=s2>&#34;易于管理大团队&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>cons</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;复杂&#34;</span><span class=p>,</span> <span class=s2>&#34;调试困难&#34;</span><span class=p>,</span> <span class=s2>&#34;层级延迟&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>implementation_complexity</span><span class=o>=</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 默认</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ArchitectureDecision</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>architecture</span><span class=o>=</span><span class=n>AgentArchitecture</span><span class=o>.</span><span class=n>SUPERVISOR_WORKER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>reason</span><span class=o>=</span><span class=s2>&#34;通用架构，适合大多数场景&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pros</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;平衡&#34;</span><span class=p>,</span> <span class=s2>&#34;成熟&#34;</span><span class=p>,</span> <span class=s2>&#34;灵活&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>cons</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;可能过度设计&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>implementation_complexity</span><span class=o>=</span><span class=mi>5</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生产级多 Agent 实现</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionMultiAgentSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生产级多 Agent 系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>architecture</span><span class=p>:</span> <span class=n>AgentArchitecture</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>architecture</span> <span class=o>=</span> <span class=n>architecture</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agents</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>agent</span><span class=p>:</span> <span class=n>Any</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册 Agent（带健康检查）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agents</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>agent</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>failure_threshold</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>recovery_timeout</span><span class=o>=</span><span class=mi>60</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>execute_with_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>agent_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带降级的执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>breaker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>[</span><span class=n>agent_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=c1># 熔断器打开，使用降级策略</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_fallback_strategy</span><span class=p>(</span><span class=n>agent_name</span><span class=p>,</span> <span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 正常执行</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>agents</span><span class=p>[</span><span class=n>agent_name</span><span class=p>]</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=c1># 刚刚熔断</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_alert_circuit_open</span><span class=p>(</span><span class=n>agent_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 使用降级策略</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_fallback_strategy</span><span class=p>(</span><span class=n>agent_name</span><span class=p>,</span> <span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_fallback_strategy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>agent_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;降级策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 策略 1：使用备用 Agent</span>
</span></span><span class=line><span class=cl>        <span class=n>backup_agent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>agents</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>agent_name</span><span class=si>}</span><span class=s2>_backup&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>backup_agent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>backup_agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 策略 2：返回缓存结果</span>
</span></span><span class=line><span class=cl>        <span class=n>cached</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_cached_result</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cached</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 策略 3：返回默认响应</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;degraded&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>agent_name</span><span class=si>}</span><span class=s2> 暂时不可用，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span></span></span></code></pre></div><h3 id=23-workflow-架构模式>2.3 Workflow 架构模式<a class=anchor href=#23-workflow-%e6%9e%b6%e6%9e%84%e6%a8%a1%e5%bc%8f>#</a></h3><p><strong>工作流编排架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.graph</span> <span class=kn>import</span> <span class=n>StateGraph</span><span class=p>,</span> <span class=n>END</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>TypedDict</span><span class=p>,</span> <span class=n>Annotated</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>operator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>WorkflowOrchestrator</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工作流编排器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>workflows</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>templates</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_templates</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_load_templates</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载工作流模板&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;approval_flow&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_approval_workflow</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;data_pipeline&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_data_pipeline</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;customer_service&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_cs_workflow</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_create_approval_workflow</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建审批工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>class</span> <span class=nc>ApprovalState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span><span class=p>:</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>            <span class=n>approvals</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>dict</span><span class=p>],</span> <span class=n>operator</span><span class=o>.</span><span class=n>add</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>            <span class=n>level</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=n>ApprovalState</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 节点</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;validate&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>validate_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;level1_approval&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>level1_approval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;level2_approval&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>level2_approval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;execute&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>execute_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=s2>&#34;notify&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>notify_result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 边</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;validate&#34;</span><span class=p>,</span> <span class=s2>&#34;level1_approval&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 条件边</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;level1_approval&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=s2>&#34;level2&#34;</span> <span class=k>if</span> <span class=n>x</span><span class=p>[</span><span class=s2>&#34;request&#34;</span><span class=p>][</span><span class=s2>&#34;amount&#34;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>10000</span> <span class=k>else</span> <span class=s2>&#34;execute&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;level2&#34;</span><span class=p>:</span> <span class=s2>&#34;level2_approval&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;execute&#34;</span><span class=p>:</span> <span class=s2>&#34;execute&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;level2_approval&#34;</span><span class=p>,</span> <span class=s2>&#34;execute&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;execute&#34;</span><span class=p>,</span> <span class=s2>&#34;notify&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=s2>&#34;notify&#34;</span><span class=p>,</span> <span class=n>END</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=s2>&#34;validate&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_dynamic_workflow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;动态创建工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span> <span class=o>=</span> <span class=n>StateGraph</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 动态添加节点</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>node_config</span> <span class=ow>in</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;nodes&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>node_func</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_create_node_function</span><span class=p>(</span><span class=n>node_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>workflow</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=n>node_config</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>],</span> <span class=n>node_func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 动态添加边</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>edge_config</span> <span class=ow>in</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;edges&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;direct&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>workflow</span><span class=o>.</span><span class=n>add_edge</span><span class=p>(</span><span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;from&#34;</span><span class=p>],</span> <span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;to&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;conditional&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>workflow</span><span class=o>.</span><span class=n>add_conditional_edges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;from&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>_create_condition_function</span><span class=p>(</span><span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;condition&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                    <span class=n>edge_config</span><span class=p>[</span><span class=s2>&#34;branches&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>workflow</span><span class=o>.</span><span class=n>set_entry_point</span><span class=p>(</span><span class=n>config</span><span class=p>[</span><span class=s2>&#34;entry&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>workflow</span><span class=o>.</span><span class=n>compile</span><span class=p>()</span></span></span></code></pre></div><hr><h2 id=第3章-性能与成本优化>第3章： 性能与成本优化<a class=anchor href=#%e7%ac%ac3%e7%ab%a0-%e6%80%a7%e8%83%bd%e4%b8%8e%e6%88%90%e6%9c%ac%e4%bc%98%e5%8c%96>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>：掌握生产环境的性能调优和成本控制。</p></blockquote><h3 id=31-延迟优化>3.1 延迟优化<a class=anchor href=#31-%e5%bb%b6%e8%bf%9f%e4%bc%98%e5%8c%96>#</a></h3><p><strong>综合延迟优化策略</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>concurrent.futures</span> <span class=kn>import</span> <span class=n>ThreadPoolExecutor</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LatencyOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;延迟优化器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>executor</span> <span class=o>=</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span><span class=n>max_workers</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model_latencies</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 记录模型延迟</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_optimal_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_latency</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据延迟要求选择模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>model_configs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=mf>2.5</span><span class=p>,</span> <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=mf>0.95</span><span class=p>,</span> <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=mf>0.03</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=mf>0.8</span><span class=p>,</span> <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=mf>0.85</span><span class=p>,</span> <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=mf>0.001</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=mf>0.5</span><span class=p>,</span> <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=mf>0.80</span><span class=p>,</span> <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=mf>0.0005</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;claude-3-haiku&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;latency&#34;</span><span class=p>:</span> <span class=mf>0.3</span><span class=p>,</span> <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=mf>0.82</span><span class=p>,</span> <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=mf>0.0003</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 筛选满足延迟要求的模型</span>
</span></span><span class=line><span class=cl>        <span class=n>eligible_models</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span> <span class=k>for</span> <span class=n>model</span><span class=p>,</span> <span class=n>config</span> <span class=ow>in</span> <span class=n>model_configs</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;latency&#34;</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>max_latency</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>eligible_models</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;没有模型满足 </span><span class=si>{</span><span class=n>max_latency</span><span class=si>}</span><span class=s2>s 延迟要求&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 选择质量最高的</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=n>eligible_models</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>model_configs</span><span class=p>[</span><span class=n>x</span><span class=p>][</span><span class=s2>&#34;quality&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>parallel_execution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tasks</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;并行执行多个任务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_task</span><span class=p>(</span><span class=n>task</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;&#34;&#34;执行单个任务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 异步执行</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_async_invoke</span><span class=p>(</span><span class=n>task</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 记录延迟</span>
</span></span><span class=line><span class=cl>            <span class=n>latency</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_record_latency</span><span class=p>(</span><span class=n>task</span><span class=p>[</span><span class=s2>&#34;model&#34;</span><span class=p>],</span> <span class=n>latency</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 并行执行所有任务</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>execute_task</span><span class=p>(</span><span class=n>task</span><span class=p>)</span> <span class=k>for</span> <span class=n>task</span> <span class=ow>in</span> <span class=n>tasks</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cached_inference</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt_hash</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;缓存的推理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 缓存会自动处理</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invoke_llm</span><span class=p>(</span><span class=n>prompt_hash</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize_prompt_batching</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompts</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;优化提示词批处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 批处理大小优化</span>
</span></span><span class=line><span class=cl>        <span class=n>optimal_batch_size</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_optimal_batch_size</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>prompts</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>prompts</span><span class=p>),</span> <span class=n>optimal_batch_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>batch</span> <span class=o>=</span> <span class=n>prompts</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span> <span class=o>+</span> <span class=n>optimal_batch_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 批量处理</span>
</span></span><span class=line><span class=cl>            <span class=n>batch_results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_batch_inference</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>batch_results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_calculate_optimal_batch_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>total_count</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算最优批处理大小&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 基于经验公式</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>total_count</span> <span class=o>&lt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>total_count</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>total_count</span> <span class=o>&lt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=mi>50</span><span class=p>,</span> <span class=n>total_count</span> <span class=o>//</span> <span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pipeline_optimization</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;流水线优化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>class</span> <span class=nc>Pipeline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>stages</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=nf>add_stage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=n>parallel</span><span class=o>=</span><span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>stages</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>func</span><span class=p>,</span> <span class=n>parallel</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_data</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>current</span> <span class=o>=</span> <span class=n>input_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>func</span><span class=p>,</span> <span class=n>parallel</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>stages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>parallel</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 并行处理列表</span>
</span></span><span class=line><span class=cl>                        <span class=n>current</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>func</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>current</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 串行处理</span>
</span></span><span class=line><span class=cl>                        <span class=n>current</span> <span class=o>=</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=n>current</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>current</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Pipeline</span><span class=p>()</span></span></span></code></pre></div><h3 id=32-吞吐量优化>3.2 吞吐量优化<a class=anchor href=#32-%e5%90%9e%e5%90%90%e9%87%8f%e4%bc%98%e5%8c%96>#</a></h3><p><strong>吞吐量优化实现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>asyncio</span> <span class=kn>import</span> <span class=n>Queue</span><span class=p>,</span> <span class=n>Semaphore</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>aiohttp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ThroughputOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;吞吐量优化器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_concurrent</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>semaphore</span> <span class=o>=</span> <span class=n>Semaphore</span><span class=p>(</span><span class=n>max_concurrent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_queue</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>init_connection_pool</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化连接池&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>connector</span> <span class=o>=</span> <span class=n>aiohttp</span><span class=o>.</span><span class=n>TCPConnector</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>limit</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>  <span class=c1># 总连接数</span>
</span></span><span class=line><span class=cl>            <span class=n>limit_per_host</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span>  <span class=c1># 每个主机的连接数</span>
</span></span><span class=line><span class=cl>            <span class=n>ttl_dns_cache</span><span class=o>=</span><span class=mi>300</span>  <span class=c1># DNS 缓存时间</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span> <span class=o>=</span> <span class=n>aiohttp</span><span class=o>.</span><span class=n>ClientTimeout</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>total</span><span class=o>=</span><span class=mi>300</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>connect</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>sock_read</span><span class=o>=</span><span class=mi>30</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=n>aiohttp</span><span class=o>.</span><span class=n>ClientSession</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>connector</span><span class=o>=</span><span class=n>connector</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span><span class=o>=</span><span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>batch_processor</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批处理处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 收集批次</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>batch_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>item</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>request_queue</span><span class=o>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                        <span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span>  <span class=c1># 1秒超时</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>batch</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 超时但有数据，处理现有批次</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_process_batch</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 批次满，处理</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>batch_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_process_batch</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>batch</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_process_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>batch</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>dict</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理一个批次&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>semaphore</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 批量 API 调用</span>
</span></span><span class=line><span class=cl>            <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>_make_request</span><span class=p>(</span><span class=n>item</span><span class=p>)</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>batch</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>,</span> <span class=n>return_exceptions</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 处理结果</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>item</span><span class=p>,</span> <span class=n>result</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>batch</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=ne>Exception</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_error</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_success</span><span class=p>(</span><span class=n>item</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>adaptive_concurrency</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;自适应并发控制&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>class</span> <span class=nc>AdaptiveLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>current_limit</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>min_limit</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>max_limit</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>success_rate</span> <span class=o>=</span> <span class=mf>1.0</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>adjustment_interval</span> <span class=o>=</span> <span class=mi>10</span>  <span class=c1># 秒</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>def</span> <span class=nf>adjust</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;&#34;&#34;调整并发限制&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>adjustment_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>success_rate</span> <span class=o>&gt;</span> <span class=mf>0.95</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 成功率高，增加并发</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>current_limit</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>current_limit</span> <span class=o>*</span> <span class=mf>1.2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>max_limit</span>
</span></span><span class=line><span class=cl>                        <span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>success_rate</span> <span class=o>&lt;</span> <span class=mf>0.8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1># 成功率低，减少并发</span>
</span></span><span class=line><span class=cl>                        <span class=bp>self</span><span class=o>.</span><span class=n>current_limit</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>current_limit</span> <span class=o>*</span> <span class=mf>0.8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=bp>self</span><span class=o>.</span><span class=n>min_limit</span>
</span></span><span class=line><span class=cl>                        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>AdaptiveLimiter</span><span class=p>()</span></span></span></code></pre></div><h3 id=33-token-管理与成本控制>3.3 Token 管理与成本控制<a class=anchor href=#33-token-%e7%ae%a1%e7%90%86%e4%b8%8e%e6%88%90%e6%9c%ac%e6%8e%a7%e5%88%b6>#</a></h3><p><strong>Token 成本优化系统</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tiktoken</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TokenBudget</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Token 预算&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>total_budget</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>used</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>remaining</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_budget</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>used</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>can_afford</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>remaining</span> <span class=o>&gt;=</span> <span class=n>tokens</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TokenOptimizer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Token 优化器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>encoding</span> <span class=o>=</span> <span class=n>tiktoken</span><span class=o>.</span><span class=n>encoding_for_model</span><span class=p>(</span><span class=s2>&#34;gpt-4&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.0025</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.01</span><span class=p>},</span>  <span class=c1># per 1K tokens (2024年最新价格)</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.00015</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.0006</span><span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.0005</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.0015</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>count_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算 Token 数量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>encoding</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>text</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>optimize_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;优化提示词长度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>count_tokens</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tokens</span> <span class=o>&lt;=</span> <span class=n>max_tokens</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>prompt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 策略 1：截断</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tokens</span> <span class=o>&lt;</span> <span class=n>max_tokens</span> <span class=o>*</span> <span class=mf>1.5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_truncate_prompt</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>max_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 策略 2：摘要</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_summarize_prompt</span><span class=p>(</span><span class=n>prompt</span><span class=p>,</span> <span class=n>max_tokens</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_truncate_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;截断提示词&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>encoding</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 保留开头和结尾</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>max_tokens</span> <span class=o>&gt;</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>start_tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[:</span><span class=n>max_tokens</span><span class=o>//</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>end_tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[</span><span class=o>-</span><span class=p>(</span><span class=n>max_tokens</span><span class=o>//</span><span class=mi>2</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>truncated</span> <span class=o>=</span> <span class=n>start_tokens</span> <span class=o>+</span> <span class=n>end_tokens</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>encoding</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>truncated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 只保留开头</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>encoding</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>tokens</span><span class=p>[:</span><span class=n>max_tokens</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_summarize_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>prompt</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>max_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;摘要提示词&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用便宜的模型进行摘要</span>
</span></span><span class=line><span class=cl>        <span class=n>summary_prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;将以下内容摘要到 </span><span class=si>{</span><span class=n>max_tokens</span><span class=si>}</span><span class=s2> tokens 以内：</span><span class=se>\n\n</span><span class=si>{</span><span class=n>prompt</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 调用 gpt-3.5-turbo 进行摘要</span>
</span></span><span class=line><span class=cl>        <span class=c1># ... 实现略</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>calculate_cost</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>input_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>output_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算成本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>model</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown model: </span><span class=si>{</span><span class=n>model</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pricing</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span><span class=p>[</span><span class=n>model</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>input_cost</span> <span class=o>=</span> <span class=p>(</span><span class=n>input_tokens</span> <span class=o>/</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>output_cost</span> <span class=o>=</span> <span class=p>(</span><span class=n>output_tokens</span> <span class=o>/</span> <span class=mi>1000</span><span class=p>)</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>input_cost</span> <span class=o>+</span> <span class=n>output_cost</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cost_aware_routing</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>task</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>budget</span><span class=p>:</span> <span class=n>TokenBudget</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;成本感知路由&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 估算不同模型的成本</span>
</span></span><span class=line><span class=cl>        <span class=n>estimates</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>model</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>pricing</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=n>estimated_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_estimate_tokens</span><span class=p>(</span><span class=n>task</span><span class=p>,</span> <span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>estimated_cost</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>calculate_cost</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>estimated_tokens</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=n>estimated_tokens</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>budget</span><span class=o>.</span><span class=n>can_afford</span><span class=p>(</span><span class=n>estimated_cost</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>):</span>  <span class=c1># 转换为 token 单位</span>
</span></span><span class=line><span class=cl>                <span class=n>estimates</span><span class=p>[</span><span class=n>model</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=n>estimated_cost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;quality&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_model_quality</span><span class=p>(</span><span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>estimates</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;预算不足&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 在预算内选择质量最好的</span>
</span></span><span class=line><span class=cl>        <span class=n>best_model</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>estimates</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=s2>&#34;quality&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>best_model</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span></span></span></code></pre></div><h3 id=34-缓存复用策略>3.4 缓存复用策略<a class=anchor href=#34-%e7%bc%93%e5%ad%98%e5%a4%8d%e7%94%a8%e7%ad%96%e7%95%a5>#</a></h3><p><strong>多层缓存架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiLevelCache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多层缓存系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 内存缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l2_cache</span> <span class=o>=</span> <span class=n>Redis</span><span class=p>()</span>  <span class=c1># Redis 缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l3_cache</span> <span class=o>=</span> <span class=n>S3Cache</span><span class=p>()</span>  <span class=c1># S3 长期缓存</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取缓存（逐层查找）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># L1 缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_promote_to_l1</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># L2 缓存</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>l2_cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_promote_to_l1</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># L3 缓存</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>l3_cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_promote_to_l2</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>_promote_to_l1</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ttl_l1</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>300</span><span class=p>,</span>  <span class=c1># 5 分钟</span>
</span></span><span class=line><span class=cl>        <span class=n>ttl_l2</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3600</span><span class=p>,</span>  <span class=c1># 1 小时</span>
</span></span><span class=line><span class=cl>        <span class=n>ttl_l3</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>86400</span>  <span class=c1># 1 天</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置缓存（写入所有层）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 写入 L1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_schedule_l1_eviction</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl_l1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 写入 L2</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l2_cache</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl_l2</span><span class=p>,</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 写入 L3</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l3_cache</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>ttl_l3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_promote_to_l1</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提升到 L1 缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l1_cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_promote_to_l2</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;提升到 L2 缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>l2_cache</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=mi>3600</span><span class=p>,</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SemanticCache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;语义缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>similarity_threshold</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.95</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span> <span class=o>=</span> <span class=n>OpenAIEmbeddings</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span> <span class=o>=</span> <span class=n>FAISS</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>similarity_threshold</span> <span class=o>=</span> <span class=n>similarity_threshold</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;基于语义相似度获取缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取查询向量</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>embeddings</span><span class=o>.</span><span class=n>embed_query</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 搜索相似查询</span>
</span></span><span class=line><span class=cl>        <span class=n>similar_docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>similarity_search_with_score</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>k</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>similar_docs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>doc</span><span class=p>,</span> <span class=n>score</span> <span class=o>=</span> <span class=n>similar_docs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>score</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>similarity_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 找到相似查询，返回缓存结果</span>
</span></span><span class=line><span class=cl>                <span class=n>cache_key</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>metadata</span><span class=p>[</span><span class=s2>&#34;cache_key&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>result</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置语义缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 生成缓存键</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>query</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 存储结果</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 存储查询向量</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>vector_store</span><span class=o>.</span><span class=n>add_texts</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=n>query</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>metadatas</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;cache_key&#34;</span><span class=p>:</span> <span class=n>cache_key</span><span class=p>,</span> <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()}]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span></span></span></code></pre></div><h3 id=35-自适应模型选择>3.5 自适应模型选择<a class=anchor href=#35-%e8%87%aa%e9%80%82%e5%ba%94%e6%a8%a1%e5%9e%8b%e9%80%89%e6%8b%a9>#</a></h3><p><strong>根据查询复杂度自动选择模型</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdaptiveModelSelector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自适应模型选择器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;根据查询复杂度选择模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>complexity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_estimate_complexity</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>complexity</span> <span class=o>&lt;</span> <span class=mf>0.3</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;gpt-3.5-turbo&#34;</span>  <span class=c1># 简单查询，节省成本</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>complexity</span> <span class=o>&lt;</span> <span class=mf>0.7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;gpt-4o-mini&#34;</span>    <span class=c1># 中等查询</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;gpt-4o&#34;</span>         <span class=c1># 复杂查询，确保质量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_estimate_complexity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;估算查询复杂度（0-1）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>score</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 查询长度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>query</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>+=</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 是否需要多步推理</span>
</span></span><span class=line><span class=cl>        <span class=n>reasoning_keywords</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;为什么&#34;</span><span class=p>,</span> <span class=s2>&#34;如何&#34;</span><span class=p>,</span> <span class=s2>&#34;分析&#34;</span><span class=p>,</span> <span class=s2>&#34;对比&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>query</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>reasoning_keywords</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>+=</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 是否需要工具</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;tools_required&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>+=</span> <span class=mf>0.2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 上下文长度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;history&#34;</span><span class=p>,</span> <span class=p>[]))</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>score</span> <span class=o>+=</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>min</span><span class=p>(</span><span class=n>score</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>selector</span> <span class=o>=</span> <span class=n>AdaptiveModelSelector</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>queries</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;你好&#34;</span><span class=p>,</span>  <span class=c1># 简单 → gpt-3.5-turbo</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;如何优化Python代码性能？&#34;</span><span class=p>,</span>  <span class=c1># 中等 → gpt-4o-mini</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;分析这段代码的时间复杂度并提出优化方案&#34;</span><span class=p>,</span>  <span class=c1># 复杂 → gpt-4o</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=n>queries</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span> <span class=o>=</span> <span class=n>selector</span><span class=o>.</span><span class=n>select_model</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;查询: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=se>\n</span><span class=s2>选择模型: </span><span class=si>{</span><span class=n>model</span><span class=si>}</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 成本节省：</span>
</span></span><span class=line><span class=cl><span class=c1># 假设100次查询：</span>
</span></span><span class=line><span class=cl><span class=c1># - 60%简单（gpt-3.5-turbo: $0.001/次） = $0.06</span>
</span></span><span class=line><span class=cl><span class=c1># - 30%中等（gpt-4o-mini: $0.005/次） = $0.15</span>
</span></span><span class=line><span class=cl><span class=c1># - 10%复杂（gpt-4o: $0.01/次） = $0.10</span>
</span></span><span class=line><span class=cl><span class=c1># 总成本 = $0.31</span>
</span></span><span class=line><span class=cl><span class=c1># vs 全用gpt-4o = $1.00</span>
</span></span><span class=line><span class=cl><span class=c1># 节省69%</span></span></span></code></pre></div><hr><h3 id=36-批处理优化>3.6 批处理优化<a class=anchor href=#36-%e6%89%b9%e5%a4%84%e7%90%86%e4%bc%98%e5%8c%96>#</a></h3><p><strong>批量处理减少网络开销</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>batch_process</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>queries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;批量处理查询（减少overhead）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>queries</span><span class=p>),</span> <span class=n>batch_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>batch</span> <span class=o>=</span> <span class=n>queries</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=n>batch_size</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 并发处理batch内的查询</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=n>agent</span><span class=o>.</span><span class=n>ainvoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>q</span><span class=p>)]}))</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>q</span> <span class=ow>in</span> <span class=n>batch</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>batch_results</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>batch_results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>queries</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;查询</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&#34;</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=n>results</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>batch_process</span><span class=p>(</span><span class=n>queries</span><span class=p>,</span> <span class=n>batch_size</span><span class=o>=</span><span class=mi>10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 优势：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 减少网络overhead（连接复用）</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 可以利用批量定价（某些API提供商）</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 提高整体吞吐量</span></span></span></code></pre></div><hr><h3 id=37-成本监控与优化清单>3.7 成本监控与优化清单<a class=anchor href=#37-%e6%88%90%e6%9c%ac%e7%9b%91%e6%8e%a7%e4%b8%8e%e4%bc%98%e5%8c%96%e6%b8%85%e5%8d%95>#</a></h3><p><strong>实时成本追踪系统</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CostMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;成本指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>input_tokens</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>output_tokens</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>cost_usd</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CostMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;成本监控器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 模型价格（$/1M tokens，2025年11月）</span>
</span></span><span class=line><span class=cl>    <span class=n>PRICING</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gpt-4o&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>2.50</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>10.00</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.15</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.60</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.50</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>1.50</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>CostMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>output_tokens</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录一次调用的成本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>pricing</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>PRICING</span><span class=p>[</span><span class=n>model</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>cost</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>1_000_000</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>output_tokens</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>]</span> <span class=o>/</span> <span class=mi>1_000_000</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>CostMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span><span class=o>=</span><span class=n>input_tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>output_tokens</span><span class=o>=</span><span class=n>output_tokens</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>cost_usd</span><span class=o>=</span><span class=n>cost</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_total_cost</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>hours</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>24</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取总成本统计&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cutoff</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=n>hours</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recent</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=n>cutoff</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_cost_usd&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>cost_usd</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_requests&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;avg_cost_per_request&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>cost_usd</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent</span><span class=p>)</span> <span class=k>if</span> <span class=n>recent</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;by_model&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>model</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;requests&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>([</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>model</span> <span class=o>==</span> <span class=n>model</span><span class=p>]),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;cost&#34;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>cost_usd</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>model</span> <span class=o>==</span> <span class=n>model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>model</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>PRICING</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>monitor</span> <span class=o>=</span> <span class=n>CostMonitor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 记录调用</span>
</span></span><span class=line><span class=cl><span class=n>monitor</span><span class=o>.</span><span class=n>record</span><span class=p>(</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=n>input_tokens</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span> <span class=n>output_tokens</span><span class=o>=</span><span class=mi>500</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>monitor</span><span class=o>.</span><span class=n>record</span><span class=p>(</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>input_tokens</span><span class=o>=</span><span class=mi>1500</span><span class=p>,</span> <span class=n>output_tokens</span><span class=o>=</span><span class=mi>300</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看成本</span>
</span></span><span class=line><span class=cl><span class=n>stats</span> <span class=o>=</span> <span class=n>monitor</span><span class=o>.</span><span class=n>get_total_cost</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>24</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;24小时总成本: $</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;total_cost_usd&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;平均每次请求: $</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;avg_cost_per_request&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;按模型分组: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;by_model&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>成本优化清单</strong>：</p><ul><li><p><input disabled type=checkbox> <strong>Prompt优化</strong></p><ul><li><input disabled type=checkbox> 精简系统提示词（避免冗余描述）</li><li><input disabled type=checkbox> 移除无关信息</li><li><input disabled type=checkbox> 使用简洁表达</li></ul></li><li><p><input disabled type=checkbox> <strong>上下文管理</strong></p><ul><li><input disabled type=checkbox> 限制历史消息数量（trim_messages）</li><li><input disabled type=checkbox> 压缩旧消息为摘要</li><li><input disabled type=checkbox> 智能裁剪上下文窗口</li></ul></li><li><p><input disabled type=checkbox> <strong>缓存策略</strong></p><ul><li><input disabled type=checkbox> 精确缓存（相同查询）</li><li><input disabled type=checkbox> 语义缓存（相似查询）</li><li><input disabled type=checkbox> 设置合理TTL</li></ul></li><li><p><input disabled type=checkbox> <strong>模型选择</strong></p><ul><li><input disabled type=checkbox> 根据复杂度自适应选择</li><li><input disabled type=checkbox> 简单任务用gpt-3.5-turbo</li><li><input disabled type=checkbox> 工具调用优先用mini模型</li></ul></li><li><p><input disabled type=checkbox> <strong>批处理</strong></p><ul><li><input disabled type=checkbox> 合并相似请求</li><li><input disabled type=checkbox> 批量处理降低overhead</li><li><input disabled type=checkbox> 并发执行提高效率</li></ul></li></ul><p><strong>成本目标</strong>：</p><table><thead><tr><th>场景</th><th>优化前</th><th>优化后</th><th>节省</th></tr></thead><tbody><tr><td>简单问答</td><td>$0.01/次</td><td>$0.001/次</td><td>90%</td></tr><tr><td>复杂推理</td><td>$0.05/次</td><td>$0.02/次</td><td>60%</td></tr><tr><td>多轮对话</td><td>$0.10/次</td><td>$0.04/次</td><td>60%</td></tr></tbody></table><p><strong>监控指标</strong>：</p><ul><li>平均每次请求成本</li><li>每日/每月总成本</li><li>各模型成本占比</li><li>Token使用效率（输出/输入比）</li></ul><hr><h2 id=第4章-安全合规与防护>第4章： 安全合规与防护<a class=anchor href=#%e7%ac%ac4%e7%ab%a0-%e5%ae%89%e5%85%a8%e5%90%88%e8%a7%84%e4%b8%8e%e9%98%b2%e6%8a%a4>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>：掌握生产环境的安全防护和合规要求。</p></blockquote><h3 id=41-guardrails-防护体系>4.1 Guardrails 防护体系<a class=anchor href=#41-guardrails-%e9%98%b2%e6%8a%a4%e4%bd%93%e7%b3%bb>#</a></h3><p><strong>双层防护架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Guardrail</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;防护栏基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查内容&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DeterministicGuardrail</span><span class=p>(</span><span class=n>Guardrail</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;确定性防护（基于规则）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rules</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_rules</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_load_rules</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加载规则&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sql_injection&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s2>&#34;(\bSELECT\b.*\bFROM\b|\bDROP\b|\bDELETE\b.*\bFROM\b)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;xss&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s2>&#34;(&lt;script|javascript:|onerror=|onclick=)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_email&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s2>&#34;[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_phone&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s2>&#34;\b\d</span><span class=si>{3}</span><span class=s2>[-.]?\d</span><span class=si>{3}</span><span class=s2>[-.]?\d</span><span class=si>{4}</span><span class=s2>\b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_ssn&#34;</span><span class=p>:</span> <span class=sa>r</span><span class=s2>&#34;\b\d</span><span class=si>{3}</span><span class=s2>-\d</span><span class=si>{2}</span><span class=s2>-\d</span><span class=si>{4}</span><span class=s2>\b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;profanity&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_profanity_list</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;规则检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>violations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>rule_name</span><span class=p>,</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>rules</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>content</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>violations</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;rule&#34;</span><span class=p>:</span> <span class=n>rule_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;severity&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_severity</span><span class=p>(</span><span class=n>rule_name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_action</span><span class=p>(</span><span class=n>rule_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>violations</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;violations&#34;</span><span class=p>:</span> <span class=n>violations</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_severity</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rule</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取严重程度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>severity_map</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sql_injection&#34;</span><span class=p>:</span> <span class=s2>&#34;critical&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;xss&#34;</span><span class=p>:</span> <span class=s2>&#34;critical&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_ssn&#34;</span><span class=p>:</span> <span class=s2>&#34;high&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_email&#34;</span><span class=p>:</span> <span class=s2>&#34;medium&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;profanity&#34;</span><span class=p>:</span> <span class=s2>&#34;low&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>severity_map</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>rule</span><span class=p>,</span> <span class=s2>&#34;medium&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_action</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>rule</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取处理动作&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>action_map</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;sql_injection&#34;</span><span class=p>:</span> <span class=s2>&#34;block&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;xss&#34;</span><span class=p>:</span> <span class=s2>&#34;block&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_ssn&#34;</span><span class=p>:</span> <span class=s2>&#34;redact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;pii_email&#34;</span><span class=p>:</span> <span class=s2>&#34;mask&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;profanity&#34;</span><span class=p>:</span> <span class=s2>&#34;warn&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>action_map</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>rule</span><span class=p>,</span> <span class=s2>&#34;warn&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelBasedGuardrail</span><span class=p>(</span><span class=n>Guardrail</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;基于模型的防护&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>model</span><span class=p>:</span> <span class=n>ChatOpenAI</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>model</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>categories</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;harmful_content&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;bias&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;misinformation&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;inappropriate&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;off_topic&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;模型检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;分析以下内容是否存在问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>内容：</span><span class=si>{</span><span class=n>content</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>检查类别：
</span></span></span><span class=line><span class=cl><span class=si>{</span><span class=s1>&#39;, &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>categories</span><span class=p>)</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>返回 JSON 格式：
</span></span></span><span class=line><span class=cl><span class=se>{{</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;passed&#34;: true/false,
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;violations&#34;: [
</span></span></span><span class=line><span class=cl><span class=s2>        </span><span class=se>{{</span><span class=s2>&#34;category&#34;: &#34;...&#34;, &#34;confidence&#34;: 0.0-1.0, &#34;reason&#34;: &#34;...&#34;</span><span class=se>}}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    ]
</span></span></span><span class=line><span class=cl><span class=se>}}</span><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>prompt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 解析响应</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 解析失败，保守处理</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;violations&#34;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;category&#34;</span><span class=p>:</span> <span class=s2>&#34;parse_error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;confidence&#34;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;无法解析检查结果&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HybridGuardrailSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;混合防护系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>deterministic</span> <span class=o>=</span> <span class=n>DeterministicGuardrail</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>model_based</span> <span class=o>=</span> <span class=n>ModelBasedGuardrail</span><span class=p>(</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>content</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>use_cache</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;综合检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>use_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_key</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>content</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第一层：确定性检查（快速）</span>
</span></span><span class=line><span class=cl>        <span class=n>deterministic_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>deterministic</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 如果确定性检查发现严重问题，直接返回</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>deterministic_result</span><span class=p>[</span><span class=s2>&#34;passed&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>critical_violations</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>v</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>deterministic_result</span><span class=p>[</span><span class=s2>&#34;violations&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>v</span><span class=p>[</span><span class=s2>&#34;severity&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;critical&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>critical_violations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;stage&#34;</span><span class=p>:</span> <span class=s2>&#34;deterministic&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;violations&#34;</span><span class=p>:</span> <span class=n>critical_violations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=s2>&#34;block&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>use_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 第二层：模型检查（更全面但较慢）</span>
</span></span><span class=line><span class=cl>        <span class=n>model_result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model_based</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 合并结果</span>
</span></span><span class=line><span class=cl>        <span class=n>all_violations</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>deterministic_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;violations&#34;</span><span class=p>,</span> <span class=p>[])</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>model_result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;violations&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>all_violations</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;stage&#34;</span><span class=p>:</span> <span class=s2>&#34;hybrid&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;violations&#34;</span><span class=p>:</span> <span class=n>all_violations</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_determine_action</span><span class=p>(</span><span class=n>all_violations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>use_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_determine_action</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>violations</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;确定处理动作&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>violations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;pass&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 根据最严重的违规确定动作</span>
</span></span><span class=line><span class=cl>        <span class=n>severities</span> <span class=o>=</span> <span class=p>[</span><span class=n>v</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;severity&#34;</span><span class=p>,</span> <span class=s2>&#34;medium&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>violations</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;critical&#34;</span> <span class=ow>in</span> <span class=n>severities</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;block&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=s2>&#34;high&#34;</span> <span class=ow>in</span> <span class=n>severities</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;review&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;warn&#34;</span></span></span></code></pre></div><h3 id=42-pii-检测策略>4.2 PII 检测策略<a class=anchor href=#42-pii-%e6%a3%80%e6%b5%8b%e7%ad%96%e7%95%a5>#</a></h3><p><strong>PII 检测与处理</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PIIType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;PII 类型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>EMAIL</span> <span class=o>=</span> <span class=s2>&#34;email&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>PHONE</span> <span class=o>=</span> <span class=s2>&#34;phone&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>SSN</span> <span class=o>=</span> <span class=s2>&#34;ssn&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CREDIT_CARD</span> <span class=o>=</span> <span class=s2>&#34;credit_card&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>IP_ADDRESS</span> <span class=o>=</span> <span class=s2>&#34;ip&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>NAME</span> <span class=o>=</span> <span class=s2>&#34;name&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>ADDRESS</span> <span class=o>=</span> <span class=s2>&#34;address&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PIIStrategy</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;PII 处理策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>REDACT</span> <span class=o>=</span> <span class=s2>&#34;redact&#34;</span>      <span class=c1># 完全删除</span>
</span></span><span class=line><span class=cl>    <span class=n>MASK</span> <span class=o>=</span> <span class=s2>&#34;mask&#34;</span>          <span class=c1># 部分遮蔽</span>
</span></span><span class=line><span class=cl>    <span class=n>HASH</span> <span class=o>=</span> <span class=s2>&#34;hash&#34;</span>          <span class=c1># 哈希替换</span>
</span></span><span class=line><span class=cl>    <span class=n>ENCRYPT</span> <span class=o>=</span> <span class=s2>&#34;encrypt&#34;</span>    <span class=c1># 加密</span>
</span></span><span class=line><span class=cl>    <span class=n>TOKENIZE</span> <span class=o>=</span> <span class=s2>&#34;tokenize&#34;</span>  <span class=c1># 令牌化</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PIIDetector</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;PII 检测器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>patterns</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIType</span><span class=o>.</span><span class=n>EMAIL</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIType</span><span class=o>.</span><span class=n>PHONE</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;(\+\d{1,3}[-.\s]?)?\(?\d{1,4}\)?[-.\s]?\d{1,4}[-.\s]?\d{1,9}&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIType</span><span class=o>.</span><span class=n>SSN</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;\b\d</span><span class=si>{3}</span><span class=s1>-\d</span><span class=si>{2}</span><span class=s1>-\d</span><span class=si>{4}</span><span class=s1>\b&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIType</span><span class=o>.</span><span class=n>CREDIT_CARD</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;\b\d</span><span class=si>{4}</span><span class=s1>[\s-]?\d</span><span class=si>{4}</span><span class=s1>[\s-]?\d</span><span class=si>{4}</span><span class=s1>[\s-]?\d</span><span class=si>{4}</span><span class=s1>\b&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIType</span><span class=o>.</span><span class=n>IP_ADDRESS</span><span class=p>:</span> <span class=sa>r</span><span class=s1>&#39;\b(?:\d{1,3}\.)</span><span class=si>{3}</span><span class=s1>\d{1,3}\b&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 名称检测需要 NER 模型</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>ner_model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_load_ner_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>detect</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Tuple</span><span class=p>[</span><span class=n>PIIType</span><span class=p>,</span> <span class=nb>str</span><span class=p>,</span> <span class=nb>int</span><span class=p>,</span> <span class=nb>int</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检测 PII&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>detections</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 正则检测</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pii_type</span><span class=p>,</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>patterns</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=k>match</span> <span class=ow>in</span> <span class=n>re</span><span class=o>.</span><span class=n>finditer</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>detections</span><span class=o>.</span><span class=n>append</span><span class=p>((</span>
</span></span><span class=line><span class=cl>                    <span class=n>pii_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=k>match</span><span class=o>.</span><span class=n>start</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                    <span class=k>match</span><span class=o>.</span><span class=n>end</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># NER 检测（名称、地址）</span>
</span></span><span class=line><span class=cl>        <span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ner_model</span><span class=o>.</span><span class=n>extract_entities</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>entities</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;PERSON&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>detections</span><span class=o>.</span><span class=n>append</span><span class=p>((</span>
</span></span><span class=line><span class=cl>                    <span class=n>PIIType</span><span class=o>.</span><span class=n>NAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;start&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;end&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;type&#34;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&#34;LOCATION&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>detections</span><span class=o>.</span><span class=n>append</span><span class=p>((</span>
</span></span><span class=line><span class=cl>                    <span class=n>PIIType</span><span class=o>.</span><span class=n>ADDRESS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;text&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;start&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>entity</span><span class=p>[</span><span class=s2>&#34;end&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>detections</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=n>PIIStrategy</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理 PII&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>detections</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>detect</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 按位置倒序处理（避免索引偏移）</span>
</span></span><span class=line><span class=cl>        <span class=n>detections</span><span class=o>.</span><span class=n>sort</span><span class=p>(</span><span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>processed_text</span> <span class=o>=</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pii_type</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=ow>in</span> <span class=n>detections</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>replacement</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_replacement</span><span class=p>(</span><span class=n>pii_type</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>strategy</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>processed_text</span> <span class=o>=</span> <span class=n>processed_text</span><span class=p>[:</span><span class=n>start</span><span class=p>]</span> <span class=o>+</span> <span class=n>replacement</span> <span class=o>+</span> <span class=n>processed_text</span><span class=p>[</span><span class=n>end</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>processed_text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_replacement</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pii_type</span><span class=p>:</span> <span class=n>PIIType</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=n>PIIStrategy</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取替换文本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>PIIStrategy</span><span class=o>.</span><span class=n>REDACT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;[</span><span class=si>{</span><span class=n>pii_type</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span><span class=si>}</span><span class=s2>_REDACTED]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>PIIStrategy</span><span class=o>.</span><span class=n>MASK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>pii_type</span> <span class=o>==</span> <span class=n>PIIType</span><span class=o>.</span><span class=n>EMAIL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 保留域名</span>
</span></span><span class=line><span class=cl>                <span class=n>parts</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>parts</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>masked_local</span> <span class=o>=</span> <span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=o>+</span> <span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>masked_local</span><span class=si>}</span><span class=s2>@</span><span class=si>{</span><span class=n>parts</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=n>pii_type</span> <span class=o>==</span> <span class=n>PIIType</span><span class=o>.</span><span class=n>PHONE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 保留前3位和后2位</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>5</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>value</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>-</span> <span class=mi>5</span><span class=p>)</span> <span class=o>+</span> <span class=n>value</span><span class=p>[</span><span class=o>-</span><span class=mi>2</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 默认遮蔽</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>PIIStrategy</span><span class=o>.</span><span class=n>HASH</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;[HASH:</span><span class=si>{</span><span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>value</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=mi>8</span><span class=p>]</span><span class=si>}</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>PIIStrategy</span><span class=o>.</span><span class=n>ENCRYPT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 实际加密实现</span>
</span></span><span class=line><span class=cl>            <span class=n>encrypted</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_encrypt</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;[ENC:</span><span class=si>{</span><span class=n>encrypted</span><span class=si>}</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>PIIStrategy</span><span class=o>.</span><span class=n>TOKENIZE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 生成唯一令牌</span>
</span></span><span class=line><span class=cl>            <span class=n>token</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_token</span><span class=p>(</span><span class=n>pii_type</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;[TOKEN:</span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>]&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>value</span></span></span></code></pre></div><h3 id=43-分层防护组合>4.3 分层防护组合<a class=anchor href=#43-%e5%88%86%e5%b1%82%e9%98%b2%e6%8a%a4%e7%bb%84%e5%90%88>#</a></h3><p><strong>多层防护架构</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>LayeredDefenseSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分层防护系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>layers</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>InputValidationLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>RateLimitLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>AuthenticationLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>PIIProtectionLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>ContentModerationLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>OutputSanitizationLayer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>AuditLoggingLayer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求（通过所有防护层）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;request&#34;</span><span class=p>:</span> <span class=n>request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user&#34;</span><span class=p>:</span> <span class=n>request</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;trace_id&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 逐层处理</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>layer</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>layers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>layer</span><span class=o>.</span><span class=n>process</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=ow>not</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;passed&#34;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 某层未通过，记录并返回</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>_log_rejection</span><span class=p>(</span><span class=n>layer</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;rejected&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;layer&#34;</span><span class=p>:</span> <span class=n>layer</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;reason&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;trace_id&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>[</span><span class=s2>&#34;trace_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 更新上下文</span>
</span></span><span class=line><span class=cl>                <span class=n>context</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;context_updates&#34;</span><span class=p>,</span> <span class=p>{}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 层处理异常</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_log_error</span><span class=p>(</span><span class=n>layer</span><span class=p>,</span> <span class=n>context</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 根据层的重要性决定是否继续</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>layer</span><span class=o>.</span><span class=n>is_critical</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;layer&#34;</span><span class=p>:</span> <span class=n>layer</span><span class=o>.</span><span class=vm>__class__</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;trace_id&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>[</span><span class=s2>&#34;trace_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 所有层都通过</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;approved&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;trace_id&#34;</span><span class=p>:</span> <span class=n>context</span><span class=p>[</span><span class=s2>&#34;trace_id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DefenseLayer</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;防护层基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_critical</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;是否关键层（失败时必须停止）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>InputValidationLayer</span><span class=p>(</span><span class=n>DefenseLayer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;输入验证层&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span> <span class=o>=</span> <span class=n>context</span><span class=p>[</span><span class=s2>&#34;request&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证必填字段</span>
</span></span><span class=line><span class=cl>        <span class=n>required_fields</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;user_id&#34;</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=s2>&#34;timestamp&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>required_fields</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>field</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>request</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;Missing required field: </span><span class=si>{</span><span class=n>field</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证输入长度</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;content&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>))</span> <span class=o>&gt;</span> <span class=mi>10000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Content too long (max 10000 chars)&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证输入格式</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>_validate_format</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Invalid input format&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_critical</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitLayer</span><span class=p>(</span><span class=n>DefenseLayer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;速率限制层&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>limits</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># user_id -&gt; requests</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span> <span class=o>=</span> <span class=n>context</span><span class=p>[</span><span class=s2>&#34;user&#34;</span><span class=p>][</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查速率限制</span>
</span></span><span class=line><span class=cl>        <span class=n>current_count</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>limits</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_count</span> <span class=o>&gt;=</span> <span class=mi>100</span><span class=p>:</span>  <span class=c1># 每分钟 100 个请求</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Rate limit exceeded&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 更新计数</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>limits</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_count</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 异步重置计数器</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_reset_counter</span><span class=p>(</span><span class=n>user_id</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;passed&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_reset_counter</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;60秒后重置计数器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>limits</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span></span></span></code></pre></div><h3 id=44-自定义-guardrails-开发>4.4 自定义 Guardrails 开发<a class=anchor href=#44-%e8%87%aa%e5%ae%9a%e4%b9%89-guardrails-%e5%bc%80%e5%8f%91>#</a></h3><p><strong>自定义防护栏框架</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>inspect</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>GuardrailFramework</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;防护栏框架&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pre_processors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>validators</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>post_processors</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>pre_process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Callable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册预处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>pre_processors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Callable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册验证器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>validators</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>post_process</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Callable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册后处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>post_processors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>input_data</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行防护流程&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 预处理</span>
</span></span><span class=line><span class=cl>        <span class=n>processed_data</span> <span class=o>=</span> <span class=n>input_data</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>processor</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>pre_processors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>inspect</span><span class=o>.</span><span class=n>iscoroutinefunction</span><span class=p>(</span><span class=n>processor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>processor</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_data</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>validator</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>validators</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>inspect</span><span class=o>.</span><span class=n>iscoroutinefunction</span><span class=p>(</span><span class=n>validator</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>is_valid</span> <span class=o>=</span> <span class=k>await</span> <span class=n>validator</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>is_valid</span> <span class=o>=</span> <span class=n>validator</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>is_valid</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>ValidationError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Validation failed: </span><span class=si>{</span><span class=n>validator</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 后处理</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>processor</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>post_processors</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>inspect</span><span class=o>.</span><span class=n>iscoroutinefunction</span><span class=p>(</span><span class=n>processor</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_data</span> <span class=o>=</span> <span class=k>await</span> <span class=n>processor</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>processed_data</span> <span class=o>=</span> <span class=n>processor</span><span class=p>(</span><span class=n>processed_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>processed_data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>guardrail</span> <span class=o>=</span> <span class=n>GuardrailFramework</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@guardrail.pre_process</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sanitize_input</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;清理输入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@guardrail.validate</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>check_content_length</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查内容长度&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>])</span> <span class=o>&lt;=</span> <span class=mi>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@guardrail.validate</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>check_toxicity</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检查毒性（使用外部 API）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 调用毒性检测 API</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>toxicity_api</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;content&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;toxicity_score&#34;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=mf>0.7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@guardrail.post_process</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_metadata</span><span class=p>(</span><span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;添加元数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>[</span><span class=s2>&#34;processed_at&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>[</span><span class=s2>&#34;guardrail_version&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;1.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>guardrail</span><span class=o>.</span><span class=n>execute</span><span class=p>({</span><span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=s2>&#34;用户输入&#34;</span><span class=p>})</span></span></span></code></pre></div><hr><h3 id=45-输入输出安全>4.5 输入输出安全<a class=anchor href=#45-%e8%be%93%e5%85%a5%e8%be%93%e5%87%ba%e5%ae%89%e5%85%a8>#</a></h3><p><strong>安全处理框架</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>html</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecurityFramework</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;安全框架&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>input_sanitizer</span> <span class=o>=</span> <span class=n>InputSanitizer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>output_validator</span> <span class=o>=</span> <span class=n>OutputValidator</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>encryption</span> <span class=o>=</span> <span class=n>EncryptionService</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>secure_input</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>raw_input</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;安全化输入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. HTML 实体编码</span>
</span></span><span class=line><span class=cl>        <span class=n>sanitized</span> <span class=o>=</span> <span class=n>html</span><span class=o>.</span><span class=n>escape</span><span class=p>(</span><span class=n>raw_input</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. SQL 注入防护</span>
</span></span><span class=line><span class=cl>        <span class=n>sanitized</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prevent_sql_injection</span><span class=p>(</span><span class=n>sanitized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 命令注入防护</span>
</span></span><span class=line><span class=cl>        <span class=n>sanitized</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prevent_command_injection</span><span class=p>(</span><span class=n>sanitized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 路径遍历防护</span>
</span></span><span class=line><span class=cl>        <span class=n>sanitized</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prevent_path_traversal</span><span class=p>(</span><span class=n>sanitized</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>sanitized</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_prevent_sql_injection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;防止 SQL 注入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用参数化查询，这里只是示例</span>
</span></span><span class=line><span class=cl>        <span class=n>dangerous_patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s2>&#34;(&#39;\s*OR\s*&#39;)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s2>&#34;(;\s*DROP\s+TABLE)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s2>&#34;(UNION\s+SELECT)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s2>&#34;(INSERT\s+INTO)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s2>&#34;(UPDATE\s+.*\s+SET)&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>dangerous_patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 记录并清理</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>_log_security_event</span><span class=p>(</span><span class=s2>&#34;sql_injection_attempt&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>secure_output</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>output</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;安全化输出&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 敏感信息脱敏</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_redact_sensitive_info</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. XSS 防护</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prevent_xss</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 信息泄露防护</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_prevent_info_disclosure</span><span class=p>(</span><span class=n>output</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_redact_sensitive_info</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;脱敏敏感信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># API 密钥</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(api[_-]?key[\s:=]+)[\w-]+&#39;</span><span class=p>,</span> <span class=sa>r</span><span class=s1>&#39;\1[REDACTED]&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 密码</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(password[\s:=]+)\S+&#39;</span><span class=p>,</span> <span class=sa>r</span><span class=s1>&#39;\1[REDACTED]&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Token</span>
</span></span><span class=line><span class=cl>        <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;(token[\s:=]+)[\w-]+&#39;</span><span class=p>,</span> <span class=sa>r</span><span class=s1>&#39;\1[REDACTED]&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>text</span></span></span></code></pre></div><h3 id=46-数据合规>4.6 数据合规<a class=anchor href=#46-%e6%95%b0%e6%8d%ae%e5%90%88%e8%a7%84>#</a></h3><p><strong>GDPR 合规实现</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GDPRCompliance</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;GDPR 合规管理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>consent_manager</span> <span class=o>=</span> <span class=n>ConsentManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_processor</span> <span class=o>=</span> <span class=n>DataProcessor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>audit_logger</span> <span class=o>=</span> <span class=n>AuditLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>process_personal_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理个人数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 检查同意</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>consent_manager</span><span class=o>.</span><span class=n>has_consent</span><span class=p>(</span><span class=n>user_id</span><span class=p>,</span> <span class=s2>&#34;data_processing&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>PermissionError</span><span class=p>(</span><span class=s2>&#34;No consent for data processing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 数据最小化</span>
</span></span><span class=line><span class=cl>        <span class=n>minimal_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_minimize_data</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 假名化</span>
</span></span><span class=line><span class=cl>        <span class=n>pseudonymized</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pseudonymize</span><span class=p>(</span><span class=n>minimal_data</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 记录处理活动</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>audit_logger</span><span class=o>.</span><span class=n>log_processing_activity</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>user_id</span><span class=o>=</span><span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>purpose</span><span class=o>=</span><span class=s2>&#34;service_provision&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>legal_basis</span><span class=o>=</span><span class=s2>&#34;consent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>data_categories</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_get_data_categories</span><span class=p>(</span><span class=n>minimal_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>pseudonymized</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_minimize_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;数据最小化&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 只保留必要字段</span>
</span></span><span class=line><span class=cl>        <span class=n>required_fields</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>,</span> <span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>minimal</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>required_fields</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>field</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>minimal</span><span class=p>[</span><span class=n>field</span><span class=p>]</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=n>field</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>minimal</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_pseudonymize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;假名化处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 生成假名</span>
</span></span><span class=line><span class=cl>        <span class=n>pseudo_id</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>user_id</span><span class=si>}{</span><span class=n>SECRET_SALT</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()[:</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 替换标识符</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=p>[</span><span class=s2>&#34;user_id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pseudo_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 加密敏感字段</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;email&#34;</span> <span class=ow>in</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>data</span><span class=p>[</span><span class=s2>&#34;email_encrypted&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>encryption</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>data</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=n>data</span><span class=p>[</span><span class=s2>&#34;email&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handle_data_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理数据请求（GDPR 权利）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>request_type</span> <span class=o>==</span> <span class=s2>&#34;access&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 数据访问权</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_export_user_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>request_type</span> <span class=o>==</span> <span class=s2>&#34;portability&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 数据可携带权</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_export_portable_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>request_type</span> <span class=o>==</span> <span class=s2>&#34;erasure&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 被遗忘权</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_erase_user_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>request_type</span> <span class=o>==</span> <span class=s2>&#34;rectification&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 数据更正权</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rectify_user_data</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Unknown request type: </span><span class=si>{</span><span class=n>request_type</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h3 id=47-审计日志>4.7 审计日志<a class=anchor href=#47-%e5%ae%a1%e8%ae%a1%e6%97%a5%e5%bf%97>#</a></h3><p><strong>完整审计系统</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AuditSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;审计系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>storage</span> <span class=o>=</span> <span class=n>AuditStorage</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>analyzer</span> <span class=o>=</span> <span class=n>AuditAnalyzer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>log_event</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>action</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>resource</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>metadata</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录审计事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;id&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;event_type&#34;</span><span class=p>:</span> <span class=n>event_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=n>user_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;action&#34;</span><span class=p>:</span> <span class=n>action</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;resource&#34;</span><span class=p>:</span> <span class=n>resource</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;result&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;metadata&#34;</span><span class=p>:</span> <span class=n>metadata</span> <span class=ow>or</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;ip_address&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_client_ip</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;user_agent&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_user_agent</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;session_id&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_session_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 存储</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>storage</span><span class=o>.</span><span class=n>store</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 实时分析</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>analyzer</span><span class=o>.</span><span class=n>analyze</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>event</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query_logs</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>filters</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span><span class=p>:</span> <span class=n>datetime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>end_time</span><span class=p>:</span> <span class=n>datetime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;查询审计日志&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>storage</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>filters</span><span class=p>,</span> <span class=n>start_time</span><span class=p>,</span> <span class=n>end_time</span><span class=p>,</span> <span class=n>limit</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_compliance_report</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>period</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成合规报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;period&#34;</span><span class=p>:</span> <span class=n>period</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;generated_at&#34;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;statistics&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_statistics</span><span class=p>(</span><span class=n>period</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;anomalies&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_detect_anomalies</span><span class=p>(</span><span class=n>period</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;compliance_status&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>_check_compliance</span><span class=p>(</span><span class=n>period</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>report</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AuditStorage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;审计存储&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用不可变存储</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>immutable_store</span> <span class=o>=</span> <span class=n>ImmutableLogStore</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>store</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;存储审计事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 添加完整性校验</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span><span class=p>[</span><span class=s2>&#34;hash&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_calculate_hash</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 签名</span>
</span></span><span class=line><span class=cl>        <span class=n>event</span><span class=p>[</span><span class=s2>&#34;signature&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_sign_event</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 存储到不可变存储</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>immutable_store</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 异步复制到长期存储</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_replicate_to_cold_storage</span><span class=p>(</span><span class=n>event</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_calculate_hash</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;计算事件哈希&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 确保顺序一致</span>
</span></span><span class=line><span class=cl>        <span class=n>canonical</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>sort_keys</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>sha256</span><span class=p>(</span><span class=n>canonical</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_sign_event</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;数字签名&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 使用私钥签名</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>cryptography.hazmat.primitives</span> <span class=kn>import</span> <span class=n>hashes</span>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>cryptography.hazmat.primitives.asymmetric</span> <span class=kn>import</span> <span class=n>padding</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>event</span><span class=p>,</span> <span class=n>sort_keys</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>signature</span> <span class=o>=</span> <span class=n>PRIVATE_KEY</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>padding</span><span class=o>.</span><span class=n>PSS</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>mgf</span><span class=o>=</span><span class=n>padding</span><span class=o>.</span><span class=n>MGF1</span><span class=p>(</span><span class=n>hashes</span><span class=o>.</span><span class=n>SHA256</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                <span class=n>salt_length</span><span class=o>=</span><span class=n>padding</span><span class=o>.</span><span class=n>PSS</span><span class=o>.</span><span class=n>MAX_LENGTH</span>
</span></span><span class=line><span class=cl>            <span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>hashes</span><span class=o>.</span><span class=n>SHA256</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>signature</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span></span></span></code></pre></div><hr><h2 id=第5章-部署与运维>第5章： 部署与运维<a class=anchor href=#%e7%ac%ac5%e7%ab%a0-%e9%83%a8%e7%bd%b2%e4%b8%8e%e8%bf%90%e7%bb%b4>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>：掌握生产环境的部署策略和运维实践。</p></blockquote><h3 id=51-部署策略>5.1 部署策略<a class=anchor href=#51-%e9%83%a8%e7%bd%b2%e7%ad%96%e7%95%a5>#</a></h3><p><strong>容器化部署</strong>：</p><p><strong>生产级Dockerfile</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>python:3.11-slim</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 设置环境变量</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>ENV</span> <span class=nv>PYTHONUNBUFFERED</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=nv>PYTHONDONTWRITEBYTECODE</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=nv>PIP_NO_CACHE_DIR</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=nv>PIP_DISABLE_PIP_VERSION_CHECK</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 安全：非 root 用户</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> useradd -m -u <span class=m>1000</span> langchain <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    mkdir -p /app <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl>    chown -R langchain:langchain /app<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>WORKDIR</span><span class=w> </span><span class=s>/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 安装系统依赖</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> apt-get install -y --no-install-recommends <span class=se>\
</span></span></span><span class=line><span class=cl>    gcc <span class=se>\
</span></span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 依赖（分层缓存优化）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> requirements.txt .<span class=err>
</span></span></span><span class=line><span class=cl><span class=k>RUN</span> pip install --no-cache-dir -r requirements.txt<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 应用代码</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>COPY</span> --chown<span class=o>=</span>langchain:langchain . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 切换用户</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>USER</span><span class=w> </span><span class=s>langchain</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 暴露端口</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>EXPOSE</span><span class=w> </span><span class=s>8000</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 健康检查</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>HEALTHCHECK</span> --interval<span class=o>=</span>30s --timeout<span class=o>=</span>3s --retries<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl>  <span class=k>CMD</span> python -c <span class=s2>&#34;import urllib.request; urllib.request.urlopen(&#39;http://localhost:8000/health&#39;, timeout=2)&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=c># 启动（使用生产级配置）</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;uvicorn&#34;</span><span class=p>,</span> <span class=s2>&#34;main:app&#34;</span><span class=p>,</span> <span class=s2>&#34;--host&#34;</span><span class=p>,</span> <span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=s2>&#34;--port&#34;</span><span class=p>,</span> <span class=s2>&#34;8000&#34;</span><span class=p>,</span> <span class=s2>&#34;--workers&#34;</span><span class=p>,</span> <span class=s2>&#34;4&#34;</span><span class=p>]</span></span></span></code></pre></div><p><strong>完整docker-compose.yml</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>langchain-app</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>context</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dockerfile</span><span class=p>:</span><span class=w> </span><span class=l>Dockerfile</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8000:8000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 从.env文件或环境变量加载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>OPENAI_API_KEY=${OPENAI_API_KEY}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>REDIS_HOST=redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>REDIS_PORT=6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./data:/app/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./logs:/app/logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>langchain-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>healthcheck</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>test</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;CMD&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;curl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;http://localhost:8000/health&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=l>30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>retries</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>start_period</span><span class=p>:</span><span class=w> </span><span class=l>40s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:7-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;6379:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis-data:/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>langchain-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>redis-server --appendonly yes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>prom/prometheus:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;9090:9090&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./prometheus.yml:/etc/prometheus/prometheus.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./prometheus_alerts.yml:/etc/prometheus/prometheus_alerts.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus-data:/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>langchain-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s1>&#39;--storage.tsdb.path=/prometheus&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>grafana/grafana:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;3000:3000&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>GF_USERS_ALLOW_SIGN_UP=false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>grafana-data:/var/lib/grafana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restart</span><span class=p>:</span><span class=w> </span><span class=l>unless-stopped</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>langchain-network</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>prometheus-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>grafana-data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>networks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>langchain-network</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>driver</span><span class=p>:</span><span class=w> </span><span class=l>bridge</span></span></span></code></pre></div><p><strong>requirements.txt示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl># requirements.txt
</span></span><span class=line><span class=cl>langchain&gt;=1.0.7
</span></span><span class=line><span class=cl>langchain-openai&gt;=1.0.3
</span></span><span class=line><span class=cl>langchain-core&gt;=1.0.7
</span></span><span class=line><span class=cl>langchain-community&gt;=1.0.7
</span></span><span class=line><span class=cl>langgraph&gt;=1.0.3
</span></span><span class=line><span class=cl>langsmith&gt;=0.4.43
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># Web框架
</span></span><span class=line><span class=cl>fastapi==0.115.6
</span></span><span class=line><span class=cl>uvicorn[standard]==0.34.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 监控
</span></span><span class=line><span class=cl>prometheus-client==0.21.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 缓存
</span></span><span class=line><span class=cl>redis==5.2.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 工具
</span></span><span class=line><span class=cl>python-dotenv==1.0.1
</span></span><span class=line><span class=cl>pydantic==2.10.4
</span></span><span class=line><span class=cl>pydantic-settings==2.7.0</span></span></code></pre></div><p><strong>.env示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># .env</span>
</span></span><span class=line><span class=cl><span class=nv>LANGCHAIN_TRACING_V2</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=nv>LANGCHAIN_API_KEY</span><span class=o>=</span>your_langsmith_key
</span></span><span class=line><span class=cl><span class=nv>OPENAI_API_KEY</span><span class=o>=</span>your_openai_key
</span></span><span class=line><span class=cl><span class=nv>GRAFANA_PASSWORD</span><span class=o>=</span>your_grafana_password</span></span></code></pre></div><p><strong>.dockerignore</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># .dockerignore
</span></span><span class=line><span class=cl>__pycache__/
</span></span><span class=line><span class=cl>*.py[cod]
</span></span><span class=line><span class=cl>*$py.class
</span></span><span class=line><span class=cl>*.so
</span></span><span class=line><span class=cl>.env
</span></span><span class=line><span class=cl>.venv/
</span></span><span class=line><span class=cl>venv/
</span></span><span class=line><span class=cl>*.log
</span></span><span class=line><span class=cl>.git/
</span></span><span class=line><span class=cl>.gitignore
</span></span><span class=line><span class=cl>.pytest_cache/
</span></span><span class=line><span class=cl>.coverage
</span></span><span class=line><span class=cl>htmlcov/
</span></span><span class=line><span class=cl>dist/
</span></span><span class=line><span class=cl>build/
</span></span><span class=line><span class=cl>*.egg-info/
</span></span><span class=line><span class=cl>.DS_Store</span></span></code></pre></div><p><strong>部署命令</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 构建镜像</span>
</span></span><span class=line><span class=cl>docker-compose build
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动服务</span>
</span></span><span class=line><span class=cl>docker-compose up -d
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看日志</span>
</span></span><span class=line><span class=cl>docker-compose logs -f langchain-app
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 停止服务</span>
</span></span><span class=line><span class=cl>docker-compose down
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 完全清理（包括数据卷）</span>
</span></span><span class=line><span class=cl>docker-compose down -v</span></span></code></pre></div><p><strong>Kubernetes 部署配置</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>langchain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>langchain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>langchain-app:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>OPENAI_API_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>openai-api-key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>langchain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain-hpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>80</span></span></span></code></pre></div><p><strong>Serverless 部署（AWS Lambda）</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># handler.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mangum</span> <span class=kn>import</span> <span class=n>Mangum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化（冷启动优化）</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_agent</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>agent</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>agent</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是一个助手&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@app.post</span><span class=p>(</span><span class=s2>&#34;/chat&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>chat</span><span class=p>(</span><span class=n>request</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>get_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Lambda handler</span>
</span></span><span class=line><span class=cl><span class=n>handler</span> <span class=o>=</span> <span class=n>Mangum</span><span class=p>(</span><span class=n>app</span><span class=p>)</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># serverless.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>service</span><span class=p>:</span><span class=w> </span><span class=l>langchain-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>provider</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aws</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runtime</span><span class=p>:</span><span class=w> </span><span class=l>python3.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>region</span><span class=p>:</span><span class=w> </span><span class=l>us-east-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>memorySize</span><span class=p>:</span><span class=w> </span><span class=m>1024</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>OPENAI_API_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${ssm:/langchain/openai_api_key}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>functions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>chat</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>handler</span><span class=p>:</span><span class=w> </span><span class=l>handler.handler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>events</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/chat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>method</span><span class=p>:</span><span class=w> </span><span class=l>post</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>cors</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>reservedConcurrency</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>provisionedConcurrency</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=c># 减少冷启动</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>serverless-python-requirements</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pythonRequirements</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>dockerizePip</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>slim</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>strip</span><span class=p>:</span><span class=w> </span><span class=kc>false</span></span></span></code></pre></div><h3 id=52-监控告警>5.2 监控告警<a class=anchor href=#52-%e7%9b%91%e6%8e%a7%e5%91%8a%e8%ad%a6>#</a></h3><h4 id=521-prometheus监控集成>5.2.1 Prometheus监控集成<a class=anchor href=#521-prometheus%e7%9b%91%e6%8e%a7%e9%9b%86%e6%88%90>#</a></h4><p><strong>1. 安装依赖</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install prometheus-client</span></span></code></pre></div><p><strong>2. 完整示例</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span><span class=p>,</span> <span class=n>start_http_server</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.callbacks</span> <span class=kn>import</span> <span class=n>BaseCallbackHandler</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.output_parsers</span> <span class=kn>import</span> <span class=n>StrOutputParser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 定义Prometheus指标</span>
</span></span><span class=line><span class=cl><span class=n>llm_requests</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;langchain_llm_requests_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total LLM requests&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm_latency</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;langchain_llm_latency_seconds&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;LLM request latency&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>buckets</span><span class=o>=</span><span class=p>[</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.5</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>,</span> <span class=mf>10.0</span><span class=p>,</span> <span class=mf>30.0</span><span class=p>,</span> <span class=mf>60.0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm_tokens</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;langchain_llm_tokens_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total tokens used&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;type&#39;</span><span class=p>]</span>  <span class=c1># type: prompt/completion</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm_errors</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;langchain_llm_errors_total&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;Total LLM errors&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>,</span> <span class=s1>&#39;error_type&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 集成到LangChain回调</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PrometheusCallback</span><span class=p>(</span><span class=n>BaseCallbackHandler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Prometheus监控回调&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_llm_start</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>serialized</span><span class=p>,</span> <span class=n>prompts</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;LLM开始时记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_llm_end</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>response</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;LLM结束时记录指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 获取模型信息</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>llm_output</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;model_name&#34;</span><span class=p>,</span> <span class=s2>&#34;unknown&#34;</span><span class=p>)</span> <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>llm_output</span> <span class=k>else</span> <span class=s2>&#34;unknown&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录成功指标</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_requests</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&#34;success&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_latency</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>)</span><span class=o>.</span><span class=n>observe</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录token使用</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>response</span><span class=o>.</span><span class=n>llm_output</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>token_usage</span> <span class=o>=</span> <span class=n>response</span><span class=o>.</span><span class=n>llm_output</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;token_usage&#34;</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>            <span class=n>llm_tokens</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;prompt&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>token_usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;prompt_tokens&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>llm_tokens</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span> <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;completion&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>token_usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;completion_tokens&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>on_llm_error</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;LLM错误时记录&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>error_type</span> <span class=o>=</span> <span class=nb>type</span><span class=p>(</span><span class=n>error</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_requests</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=p>,</span> <span class=n>status</span><span class=o>=</span><span class=s2>&#34;error&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>llm_errors</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=p>,</span> <span class=n>error_type</span><span class=o>=</span><span class=n>error_type</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动Prometheus HTTP服务器（暴露指标）</span>
</span></span><span class=line><span class=cl><span class=n>start_http_server</span><span class=p>(</span><span class=mi>8001</span><span class=p>)</span>  <span class=c1># 在独立端口暴露指标(避免与应用端口8000冲突)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用示例</span>
</span></span><span class=line><span class=cl><span class=n>chain</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span> <span class=o>|</span> <span class=n>StrOutputParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>chain</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;你好，介绍一下LangChain&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;callbacks&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>PrometheusCallback</span><span class=p>()]}</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;访问 http://localhost:8001/metrics 查看指标&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>3. Grafana可视化配置</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;dashboard&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;LangChain监控面板&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;panels&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;LLM请求速率（每秒）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;rate(langchain_llm_requests_total[5m])&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;{{model}} - {{status}}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;graph&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;LLM延迟分布（P50/P95/P99）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;histogram_quantile(0.50, rate(langchain_llm_latency_seconds_bucket[5m]))&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;P50 - {{model}}&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;histogram_quantile(0.95, rate(langchain_llm_latency_seconds_bucket[5m]))&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;P95 - {{model}}&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;histogram_quantile(0.99, rate(langchain_llm_latency_seconds_bucket[5m]))&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;P99 - {{model}}&#34;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;graph&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;Token使用量（每分钟）&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;rate(langchain_llm_tokens_total[1m])&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;{{model}} - {{type}}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;graph&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;title&#34;</span><span class=p>:</span> <span class=s2>&#34;错误率&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;targets&#34;</span><span class=p>:</span> <span class=p>[{</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;expr&#34;</span><span class=p>:</span> <span class=s2>&#34;rate(langchain_llm_errors_total[5m])&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nt>&#34;legendFormat&#34;</span><span class=p>:</span> <span class=s2>&#34;{{model}} - {{error_type}}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}],</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;graph&#34;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p><strong>4. Prometheus告警规则</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># prometheus_alerts.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>groups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>langchain_alerts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>HighLLMLatency</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>histogram_quantile(0.95, rate(langchain_llm_latency_seconds_bucket[5m])) &gt; 5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>warning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;LLM延迟过高&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;P95延迟超过5秒: {{ $value }}s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>CriticalLLMLatency</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>histogram_quantile(0.95, rate(langchain_llm_latency_seconds_bucket[5m])) &gt; 10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;LLM延迟严重过高&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;P95延迟超过10秒: {{ $value }}s&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>HighErrorRate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>rate(langchain_llm_requests_total{status=&#34;error&#34;}[5m]) / rate(langchain_llm_requests_total[5m]) &gt; 0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>critical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;LLM错误率过高&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;错误率超过10%: {{ $value | humanizePercentage }}&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>TokenBudgetExceeded</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>increase(langchain_llm_tokens_total[1h]) &gt; 1000000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>warning</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Token预算超限&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;过去1小时使用了{{ $value }}个tokens&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>alert</span><span class=p>:</span><span class=w> </span><span class=l>NoRecentRequests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>expr</span><span class=p>:</span><span class=w> </span><span class=l>rate(langchain_llm_requests_total[10m]) == 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>for</span><span class=p>:</span><span class=w> </span><span class=l>15m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>severity</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>summary</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;无LLM请求&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;过去15分钟无LLM请求，可能服务异常&#34;</span></span></span></code></pre></div><p><strong>5. Prometheus配置文件</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># prometheus.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>global</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>evaluation_interval</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>alerting</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>alertmanagers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;alertmanager:9093&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>rule_files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;prometheus_alerts.yml&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;langchain_app&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;localhost:8001&#39;</span><span class=p>]</span><span class=w>  </span><span class=c># LangChain应用的metrics端口</span></span></span></code></pre></div><h4 id=522-监控系统实现>5.2.2 监控系统实现<a class=anchor href=#522-%e7%9b%91%e6%8e%a7%e7%b3%bb%e7%bb%9f%e5%ae%9e%e7%8e%b0>#</a></h4><p><strong>监控中间件</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>prometheus_client</span> <span class=kn>import</span> <span class=n>Counter</span><span class=p>,</span> <span class=n>Histogram</span><span class=p>,</span> <span class=n>Gauge</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prometheus 指标</span>
</span></span><span class=line><span class=cl><span class=n>request_count</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=s1>&#39;langchain_requests_total&#39;</span><span class=p>,</span> <span class=s1>&#39;Total requests&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;endpoint&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>request_duration</span> <span class=o>=</span> <span class=n>Histogram</span><span class=p>(</span><span class=s1>&#39;langchain_request_duration_seconds&#39;</span><span class=p>,</span> <span class=s1>&#39;Request duration&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;endpoint&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>active_requests</span> <span class=o>=</span> <span class=n>Gauge</span><span class=p>(</span><span class=s1>&#39;langchain_active_requests&#39;</span><span class=p>,</span> <span class=s1>&#39;Active requests&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model_tokens</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=s1>&#39;langchain_model_tokens_total&#39;</span><span class=p>,</span> <span class=s1>&#39;Total tokens used&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;model&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>error_count</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>(</span><span class=s1>&#39;langchain_errors_total&#39;</span><span class=p>,</span> <span class=s1>&#39;Total errors&#39;</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;error_type&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoringMiddleware</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;监控中间件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>call_next</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>endpoint</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>url</span><span class=o>.</span><span class=n>path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录活跃请求</span>
</span></span><span class=line><span class=cl>        <span class=n>active_requests</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录请求时间</span>
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>request_duration</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>endpoint</span><span class=o>=</span><span class=n>endpoint</span><span class=p>)</span><span class=o>.</span><span class=n>time</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=n>call_next</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># 记录请求数</span>
</span></span><span class=line><span class=cl>                <span class=n>request_count</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>endpoint</span><span class=o>=</span><span class=n>endpoint</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>status</span><span class=o>=</span><span class=n>response</span><span class=o>.</span><span class=n>status_code</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 记录错误</span>
</span></span><span class=line><span class=cl>                <span class=n>error_count</span><span class=o>.</span><span class=n>labels</span><span class=p>(</span><span class=n>error_type</span><span class=o>=</span><span class=nb>type</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>)</span><span class=o>.</span><span class=n>inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>active_requests</span><span class=o>.</span><span class=n>dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 告警规则（Prometheus AlertManager）</span>
</span></span><span class=line><span class=cl><span class=n>ALERT_RULES</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>groups:
</span></span></span><span class=line><span class=cl><span class=s2>- name: langchain_alerts
</span></span></span><span class=line><span class=cl><span class=s2>  interval: 30s
</span></span></span><span class=line><span class=cl><span class=s2>  rules:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  - alert: HighErrorRate
</span></span></span><span class=line><span class=cl><span class=s2>    expr: rate(langchain_errors_total[5m]) &gt; 0.05
</span></span></span><span class=line><span class=cl><span class=s2>    for: 5m
</span></span></span><span class=line><span class=cl><span class=s2>    labels:
</span></span></span><span class=line><span class=cl><span class=s2>      severity: critical
</span></span></span><span class=line><span class=cl><span class=s2>    annotations:
</span></span></span><span class=line><span class=cl><span class=s2>      summary: High error rate detected
</span></span></span><span class=line><span class=cl><span class=s2>      description: &#34;Error rate is {{ $value }} errors per second&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  - alert: HighLatency
</span></span></span><span class=line><span class=cl><span class=s2>    expr: histogram_quantile(0.95, langchain_request_duration_seconds) &gt; 5
</span></span></span><span class=line><span class=cl><span class=s2>    for: 5m
</span></span></span><span class=line><span class=cl><span class=s2>    labels:
</span></span></span><span class=line><span class=cl><span class=s2>      severity: warning
</span></span></span><span class=line><span class=cl><span class=s2>    annotations:
</span></span></span><span class=line><span class=cl><span class=s2>      summary: High latency detected
</span></span></span><span class=line><span class=cl><span class=s2>      description: &#34;95th percentile latency is {{ $value }} seconds&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>  - alert: TokenBudgetExceeded
</span></span></span><span class=line><span class=cl><span class=s2>    expr: increase(langchain_model_tokens_total[1h]) &gt; 1000000
</span></span></span><span class=line><span class=cl><span class=s2>    labels:
</span></span></span><span class=line><span class=cl><span class=s2>      severity: warning
</span></span></span><span class=line><span class=cl><span class=s2>    annotations:
</span></span></span><span class=line><span class=cl><span class=s2>      summary: Token budget exceeded
</span></span></span><span class=line><span class=cl><span class=s2>      description: &#34;Used {{ $value }} tokens in the last hour&#34;
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span></span></span></code></pre></div><h3 id=53-故障处理>5.3 故障处理<a class=anchor href=#53-%e6%95%85%e9%9a%9c%e5%a4%84%e7%90%86>#</a></h3><p><strong>故障恢复系统</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FaultToleranceSystem</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;故障容错系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>health_checker</span> <span class=o>=</span> <span class=n>HealthChecker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handler</span> <span class=o>=</span> <span class=n>FallbackHandler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求（带故障容错）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 健康检查</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>health_checker</span><span class=o>.</span><span class=n>is_healthy</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handler</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 熔断器</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handler</span><span class=o>.</span><span class=n>handle</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 正常处理</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 故障分类处理</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>RateLimitError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 速率限制：等待后重试</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>e</span><span class=o>.</span><span class=n>retry_after</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>ModelError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 模型错误：切换备用模型</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_to_backup_model</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>elif</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=ne>TimeoutError</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 超时：返回缓存或默认响应</span>
</span></span><span class=line><span class=cl>                <span class=n>cached</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_cached_response</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>cached</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_default_response</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 未知错误：记录并返回错误响应</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_error</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;error&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;服务暂时不可用，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DisasterRecovery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;灾难恢复&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>backup_regions</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;us-west-2&#34;</span><span class=p>,</span> <span class=s2>&#34;eu-west-1&#34;</span><span class=p>,</span> <span class=s2>&#34;ap-northeast-1&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>primary_region</span> <span class=o>=</span> <span class=s2>&#34;us-east-1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>check_region_health</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>region</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查区域健康状态&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>ping_region</span><span class=p>(</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>failover</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;故障转移&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查主区域</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_region_health</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>primary_region</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>primary_region</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 主区域故障，切换到备用区域</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>region</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>backup_regions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_region_health</span><span class=p>(</span><span class=n>region</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>switch_traffic</span><span class=p>(</span><span class=n>region</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>notify_ops_team</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Failover to </span><span class=si>{</span><span class=n>region</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>region</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 所有区域都故障</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>CriticalError</span><span class=p>(</span><span class=s2>&#34;All regions are down&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><hr><h3 id=54-生产部署检查清单>5.4 生产部署检查清单<a class=anchor href=#54-%e7%94%9f%e4%ba%a7%e9%83%a8%e7%bd%b2%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h3><h4 id=541-安全检查清单>5.4.1 安全检查清单<a class=anchor href=#541-%e5%ae%89%e5%85%a8%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>API密钥与凭证管理</strong>：</p><ul><li><input disabled type=checkbox> <strong>环境变量管理</strong>：所有API密钥通过环境变量注入，禁止硬编码</li><li><input disabled type=checkbox> <strong>密钥管理服务</strong>：使用AWS Secrets Manager、HashiCorp Vault等密钥管理服务</li><li><input disabled type=checkbox> <strong>密钥轮换</strong>：定期轮换API密钥和访问令牌</li><li><input disabled type=checkbox> <strong>最小权限原则</strong>：为不同环境配置不同权限级别的密钥</li></ul><p><strong>网络安全</strong>：</p><ul><li><input disabled type=checkbox> <strong>启用HTTPS/TLS</strong>：所有外部通信强制使用HTTPS</li><li><input disabled type=checkbox> <strong>TLS版本</strong>：使用TLS 1.2或更高版本</li><li><input disabled type=checkbox> <strong>证书验证</strong>：验证SSL证书有效性</li><li><input disabled type=checkbox> <strong>API网关</strong>：通过API网关统一管理和保护API端点</li></ul><p><strong>速率限制与防护</strong>：</p><ul><li><input disabled type=checkbox> <strong>全局速率限制</strong>：限制每个用户/IP的请求频率</li><li><input disabled type=checkbox> <strong>端点级限制</strong>：为不同端点设置不同速率限制</li><li><input disabled type=checkbox> <strong>DDoS防护</strong>：配置CloudFlare或AWS Shield等防护服务</li><li><input disabled type=checkbox> <strong>请求大小限制</strong>：限制请求payload大小</li></ul><p><strong>输入验证与清洗</strong>：</p><ul><li><input disabled type=checkbox> <strong>输入长度验证</strong>：限制提示词和输入数据长度</li><li><input disabled type=checkbox> <strong>SQL注入防护</strong>：使用参数化查询，禁止拼接SQL</li><li><input disabled type=checkbox> <strong>XSS防护</strong>：对所有用户输入进行HTML实体编码</li><li><input disabled type=checkbox> <strong>命令注入防护</strong>：禁止直接执行用户输入的命令</li><li><input disabled type=checkbox> <strong>路径遍历防护</strong>：验证和清洗文件路径</li></ul><p><strong>敏感信息脱敏</strong>：</p><ul><li><input disabled type=checkbox> <strong>PII检测</strong>：自动检测和脱敏个人身份信息</li><li><input disabled type=checkbox> <strong>输出过滤</strong>：过滤API密钥、密码、Token等敏感信息</li><li><input disabled type=checkbox> <strong>日志脱敏</strong>：确保日志中不包含敏感信息</li><li><input disabled type=checkbox> <strong>错误信息处理</strong>：避免泄露系统内部信息</li></ul><h4 id=542-性能检查清单>5.4.2 性能检查清单<a class=anchor href=#542-%e6%80%a7%e8%83%bd%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>连接池配置</strong>：</p><ul><li><input disabled type=checkbox> <strong>HTTP连接池</strong>：配置合理的连接池大小（建议：每个主机10-30个连接）</li><li><input disabled type=checkbox> <strong>数据库连接池</strong>：配置数据库连接池（建议：最小5个，最大20个）</li><li><input disabled type=checkbox> <strong>Redis连接池</strong>：配置Redis连接池参数</li><li><input disabled type=checkbox> <strong>连接超时</strong>：设置合理的连接超时时间（建议：10秒）</li><li><input disabled type=checkbox> <strong>读取超时</strong>：设置读取超时时间（建议：30秒）</li></ul><p><strong>缓存策略</strong>：</p><ul><li><input disabled type=checkbox> <strong>LLM响应缓存</strong>：启用语义缓存或精确匹配缓存</li><li><input disabled type=checkbox> <strong>缓存层级</strong>：配置L1（内存）、L2（Redis）、L3（S3）多层缓存</li><li><input disabled type=checkbox> <strong>TTL配置</strong>：为不同数据类型设置合理的过期时间</li><li><input disabled type=checkbox> <strong>缓存预热</strong>：在启动时预加载热点数据</li><li><input disabled type=checkbox> <strong>缓存失效</strong>：实现缓存失效和更新策略</li></ul><p><strong>超时控制</strong>：</p><ul><li><input disabled type=checkbox> <strong>LLM调用超时</strong>：设置LLM API调用超时（建议：30-60秒）</li><li><input disabled type=checkbox> <strong>工具执行超时</strong>：为每个工具设置独立超时时间</li><li><input disabled type=checkbox> <strong>总体超时</strong>：设置请求总超时时间</li><li><input disabled type=checkbox> <strong>流式响应超时</strong>：配置流式响应的超时策略</li></ul><p><strong>批处理优化</strong>：</p><ul><li><input disabled type=checkbox> <strong>批量推理</strong>：支持批量处理多个请求</li><li><input disabled type=checkbox> <strong>批次大小</strong>：根据模型和硬件优化批次大小</li><li><input disabled type=checkbox> <strong>异步处理</strong>：使用异步I/O提升并发能力</li><li><input disabled type=checkbox> <strong>并行执行</strong>：支持并行调用多个工具或LLM</li></ul><h4 id=543-可靠性检查清单>5.4.3 可靠性检查清单<a class=anchor href=#543-%e5%8f%af%e9%9d%a0%e6%80%a7%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>重试策略</strong>：</p><ul><li><input disabled type=checkbox> <strong>指数退避</strong>：实现指数退避重试策略</li><li><input disabled type=checkbox> <strong>重试次数</strong>：设置合理的最大重试次数（建议：3次）</li><li><input disabled type=checkbox> <strong>重试条件</strong>：仅对可恢复的错误（429、500、503）进行重试</li><li><input disabled type=checkbox> <strong>幂等性</strong>：确保重试操作是幂等的</li><li><input disabled type=checkbox> <strong>超时重试</strong>：对超时请求进行重试</li></ul><p><strong>熔断器</strong>：</p><ul><li><input disabled type=checkbox> <strong>熔断阈值</strong>：设置失败率阈值（建议：50%）</li><li><input disabled type=checkbox> <strong>恢复时间</strong>：配置熔断器自动恢复时间（建议：60秒）</li><li><input disabled type=checkbox> <strong>半开状态</strong>：实现半开状态探测服务恢复</li><li><input disabled type=checkbox> <strong>熔断告警</strong>：熔断器打开时发送告警</li></ul><p><strong>降级方案</strong>：</p><ul><li><input disabled type=checkbox> <strong>备用模型</strong>：配置备用LLM模型</li><li><input disabled type=checkbox> <strong>缓存降级</strong>：服务不可用时返回缓存结果</li><li><input disabled type=checkbox> <strong>默认响应</strong>：提供友好的默认响应</li><li><input disabled type=checkbox> <strong>功能降级</strong>：关键路径失败时降级到简化功能</li></ul><p><strong>健康检查</strong>：</p><ul><li><input disabled type=checkbox> <strong>就绪检查</strong>：实现<code>/ready</code>端点检查依赖服务</li><li><input disabled type=checkbox> <strong>存活检查</strong>：实现<code>/health</code>端点检查应用状态</li><li><input disabled type=checkbox> <strong>深度检查</strong>：可选的深度健康检查（验证LLM连接等）</li><li><input disabled type=checkbox> <strong>检查间隔</strong>：配置合理的健康检查间隔（建议：30秒）</li></ul><h4 id=544-监控检查清单>5.4.4 监控检查清单<a class=anchor href=#544-%e7%9b%91%e6%8e%a7%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>LangSmith追踪</strong>：</p><ul><li><input disabled type=checkbox> <strong>启用追踪</strong>：设置<code>LANGCHAIN_TRACING_V2=true</code></li><li><input disabled type=checkbox> <strong>项目配置</strong>：为不同环境配置不同项目</li><li><input disabled type=checkbox> <strong>采样率</strong>：生产环境配置合理的采样率（建议：10%）</li><li><input disabled type=checkbox> <strong>敏感信息过滤</strong>：过滤追踪数据中的敏感信息</li></ul><p><strong>Prometheus指标</strong>：</p><ul><li><input disabled type=checkbox> <strong>请求指标</strong>：记录请求总数、成功率、失败率</li><li><input disabled type=checkbox> <strong>延迟指标</strong>：记录P50、P95、P99延迟</li><li><input disabled type=checkbox> <strong>Token指标</strong>：记录输入/输出token使用量</li><li><input disabled type=checkbox> <strong>错误指标</strong>：记录不同类型的错误数量</li><li><input disabled type=checkbox> <strong>自定义指标</strong>：根据业务需求添加自定义指标</li></ul><p><strong>日志聚合</strong>：</p><ul><li><input disabled type=checkbox> <strong>结构化日志</strong>：使用JSON格式记录结构化日志</li><li><input disabled type=checkbox> <strong>日志级别</strong>：生产环境使用INFO级别，开发环境使用DEBUG</li><li><input disabled type=checkbox> <strong>日志聚合</strong>：配置ELK、Loki或CloudWatch日志聚合</li><li><input disabled type=checkbox> <strong>日志保留</strong>：设置日志保留策略（建议：30-90天）</li><li><input disabled type=checkbox> <strong>请求ID</strong>：为每个请求生成唯一ID用于追踪</li></ul><p><strong>告警规则</strong>：</p><ul><li><input disabled type=checkbox> <strong>延迟告警</strong>：P95延迟超过阈值时告警</li><li><input disabled type=checkbox> <strong>错误率告警</strong>：错误率超过阈值时告警</li><li><input disabled type=checkbox> <strong>成本告警</strong>：Token使用量超过预算时告警</li><li><input disabled type=checkbox> <strong>可用性告警</strong>：服务不可用时立即告警</li><li><input disabled type=checkbox> <strong>告警通道</strong>：配置PagerDuty、Slack、邮件等告警通道</li></ul><h4 id=545-成本检查清单>5.4.5 成本检查清单<a class=anchor href=#545-%e6%88%90%e6%9c%ac%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>Token使用监控</strong>：</p><ul><li><input disabled type=checkbox> <strong>实时监控</strong>：实时监控token使用量</li><li><input disabled type=checkbox> <strong>用户级统计</strong>：按用户统计token使用量</li><li><input disabled type=checkbox> <strong>模型级统计</strong>：按模型统计成本</li><li><input disabled type=checkbox> <strong>成本分析</strong>：定期分析成本构成</li></ul><p><strong>成本预算控制</strong>：</p><ul><li><input disabled type=checkbox> <strong>预算告警</strong>：设置每日/每月预算告警</li><li><input disabled type=checkbox> <strong>用户配额</strong>：为每个用户设置token配额</li><li><input disabled type=checkbox> <strong>速率限制</strong>：通过速率限制控制成本</li><li><input disabled type=checkbox> <strong>自动熔断</strong>：超出预算时自动停止服务</li></ul><p><strong>缓存命中率优化</strong>：</p><ul><li><input disabled type=checkbox> <strong>缓存命中率监控</strong>：监控缓存命中率（目标：>80%）</li><li><input disabled type=checkbox> <strong>缓存预热</strong>：预加载常用查询</li><li><input disabled type=checkbox> <strong>语义缓存</strong>：使用语义相似度缓存提升命中率</li><li><input disabled type=checkbox> <strong>缓存分析</strong>：定期分析缓存效果</li></ul><p><strong>模型选择策略</strong>：</p><ul><li><input disabled type=checkbox> <strong>智能路由</strong>：根据任务复杂度选择合适模型</li><li><input disabled type=checkbox> <strong>成本优化</strong>：优先使用便宜模型（如gpt-4o-mini）</li><li><input disabled type=checkbox> <strong>质量平衡</strong>：在成本和质量间找到平衡点</li><li><input disabled type=checkbox> <strong>A/B测试</strong>：对比不同模型的成本效益</li></ul><h4 id=546-数据合规检查清单>5.4.6 数据合规检查清单<a class=anchor href=#546-%e6%95%b0%e6%8d%ae%e5%90%88%e8%a7%84%e6%a3%80%e6%9f%a5%e6%b8%85%e5%8d%95>#</a></h4><p><strong>GDPR合规</strong>：</p><ul><li><input disabled type=checkbox> <strong>用户同意</strong>：收集用户数据处理同意</li><li><input disabled type=checkbox> <strong>数据最小化</strong>：仅收集必要的个人数据</li><li><input disabled type=checkbox> <strong>访问权</strong>：实现用户数据访问接口</li><li><input disabled type=checkbox> <strong>删除权</strong>：实现用户数据删除功能（被遗忘权）</li><li><input disabled type=checkbox> <strong>可携带权</strong>：支持导出用户数据</li><li><input disabled type=checkbox> <strong>数据假名化</strong>：对个人数据进行假名化处理</li></ul><p><strong>数据加密</strong>：</p><ul><li><input disabled type=checkbox> <strong>传输加密</strong>：使用TLS加密所有网络传输</li><li><input disabled type=checkbox> <strong>存储加密</strong>：加密存储敏感数据</li><li><input disabled type=checkbox> <strong>密钥管理</strong>：使用KMS管理加密密钥</li><li><input disabled type=checkbox> <strong>加密算法</strong>：使用AES-256等强加密算法</li></ul><p><strong>审计日志</strong>：</p><ul><li><input disabled type=checkbox> <strong>完整记录</strong>：记录所有数据访问和修改操作</li><li><input disabled type=checkbox> <strong>不可篡改</strong>：使用只追加存储或区块链技术</li><li><input disabled type=checkbox> <strong>日志签名</strong>：对审计日志进行数字签名</li><li><input disabled type=checkbox> <strong>定期审计</strong>：定期审查审计日志</li><li><input disabled type=checkbox> <strong>合规报告</strong>：生成合规审计报告</li></ul><h4 id=547-部署前最终检查>5.4.7 部署前最终检查<a class=anchor href=#547-%e9%83%a8%e7%bd%b2%e5%89%8d%e6%9c%80%e7%bb%88%e6%a3%80%e6%9f%a5>#</a></h4><p><strong>代码检查</strong>：</p><ul><li><input disabled type=checkbox> <strong>单元测试</strong>：单元测试覆盖率>80%</li><li><input disabled type=checkbox> <strong>集成测试</strong>：所有关键路径有集成测试</li><li><input disabled type=checkbox> <strong>性能测试</strong>：通过负载测试和压力测试</li><li><input disabled type=checkbox> <strong>安全扫描</strong>：通过安全漏洞扫描</li></ul><p><strong>配置检查</strong>：</p><ul><li><input disabled type=checkbox> <strong>环境变量</strong>：所有环境变量正确配置</li><li><input disabled type=checkbox> <strong>资源限制</strong>：配置CPU、内存限制</li><li><input disabled type=checkbox> <strong>副本数</strong>：配置合理的副本数量（建议：>=2）</li><li><input disabled type=checkbox> <strong>自动扩缩容</strong>：配置HPA自动扩缩容策略</li></ul><p><strong>文档检查</strong>：</p><ul><li><input disabled type=checkbox> <strong>部署文档</strong>：完整的部署操作文档</li><li><input disabled type=checkbox> <strong>运维手册</strong>：故障排查和应急响应手册</li><li><input disabled type=checkbox> <strong>API文档</strong>：完整的API接口文档</li><li><input disabled type=checkbox> <strong>变更记录</strong>：记录所有重要变更</li></ul><p><strong>演练检查</strong>：</p><ul><li><input disabled type=checkbox> <strong>灰度发布</strong>：先在小范围用户测试</li><li><input disabled type=checkbox> <strong>回滚计划</strong>：准备快速回滚方案</li><li><input disabled type=checkbox> <strong>故障演练</strong>：进行故障注入和恢复演练</li><li><input disabled type=checkbox> <strong>应急响应</strong>：明确应急响应流程和人员</li></ul><hr><h3 id=本章小结-1>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1>#</a></h3><ol><li><strong>架构设计</strong>：RAG、Multi-Agent、Workflow 三种核心架构模式</li><li><strong>性能优化</strong>：延迟优化、吞吐量提升、Token 成本控制、多层缓存</li><li><strong>安全防护</strong>：Guardrails 体系、PII 保护、分层防护</li><li><strong>合规要求</strong>：输入输出安全、GDPR 合规、审计日志</li><li><strong>部署运维</strong>：容器化、Serverless、监控告警、故障恢复</li><li><strong>生产清单</strong>：全面的安全、性能、可靠性、监控、成本、合规检查清单</li></ol><hr><h2 id=第6章测试与质量保障>第6章：测试与质量保障<a class=anchor href=#%e7%ac%ac6%e7%ab%a0%e6%b5%8b%e8%af%95%e4%b8%8e%e8%b4%a8%e9%87%8f%e4%bf%9d%e9%9a%9c>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>: 构建Agent的完整测试体系</p></blockquote><h3 id=61-测试金字塔>6.1 测试金字塔<a class=anchor href=#61-%e6%b5%8b%e8%af%95%e9%87%91%e5%ad%97%e5%a1%94>#</a></h3><p>Agent测试不同于传统软件测试，需要处理LLM的不确定性：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>         /\
</span></span><span class=line><span class=cl>        /  \     E2E评估（少量、慢、贵）
</span></span><span class=line><span class=cl>       /____\    - LangSmith Evaluation
</span></span><span class=line><span class=cl>      /      \   - 真实场景回归
</span></span><span class=line><span class=cl>     /        \
</span></span><span class=line><span class=cl>    /          \ 集成测试（中等）
</span></span><span class=line><span class=cl>   /____________\  - Agent工作流测试
</span></span><span class=line><span class=cl>  /              \ - 工具调用链路测试
</span></span><span class=line><span class=cl> /                \
</span></span><span class=line><span class=cl>/__________________\ 单元测试（大量、快、便宜）
</span></span><span class=line><span class=cl>                     - Tool函数测试
</span></span><span class=line><span class=cl>                     - Prompt模板测试
</span></span><span class=line><span class=cl>                     - 输出解析器测试</span></span></code></pre></div><p><strong>原则</strong>：70%单元测试 + 20%集成测试 + 10%E2E评估</p><hr><h3 id=62-单元测试实践>6.2 单元测试实践<a class=anchor href=#62-%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95%e5%ae%9e%e8%b7%b5>#</a></h3><h4 id=621-tool函数测试>6.2.1 Tool函数测试<a class=anchor href=#621-tool%e5%87%bd%e6%95%b0%e6%b5%8b%e8%af%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># test_tools.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.tools</span> <span class=kn>import</span> <span class=n>tool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@tool</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>extract_order_id</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;从文本中提取订单号&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;订单号[：:]\s*(\w+)&#39;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=k>if</span> <span class=k>match</span> <span class=k>else</span> <span class=s2>&#34;未找到订单号&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestTools</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Tool函数单元测试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@pytest.mark.parametrize</span><span class=p>(</span><span class=s2>&#34;text,expected&#34;</span><span class=p>,</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;您的订单号：ABC123已确认&#34;</span><span class=p>,</span> <span class=s2>&#34;ABC123&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;订单号:XYZ789&#34;</span><span class=p>,</span> <span class=s2>&#34;XYZ789&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=s2>&#34;这是一段没有订单号的文本&#34;</span><span class=p>,</span> <span class=s2>&#34;未找到订单号&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_extract_order_id</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>text</span><span class=p>,</span> <span class=n>expected</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;参数化测试多种格式&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>extract_order_id</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=n>text</span><span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>result</span> <span class=o>==</span> <span class=n>expected</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_tool_metadata</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试Tool元数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>extract_order_id</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;extract_order_id&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;订单号&#34;</span> <span class=ow>in</span> <span class=n>extract_order_id</span><span class=o>.</span><span class=n>description</span></span></span></code></pre></div><p><strong>运行</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pytest test_tools.py -v
</span></span><span class=line><span class=cl><span class=c1># ✅ test_extract_order_id[...] PASSED</span>
</span></span><span class=line><span class=cl><span class=c1># ✅ test_tool_metadata PASSED</span></span></span></code></pre></div><hr><h4 id=622-agent工作流集成测试>6.2.2 Agent工作流集成测试<a class=anchor href=#622-agent%e5%b7%a5%e4%bd%9c%e6%b5%81%e9%9b%86%e6%88%90%e6%b5%8b%e8%af%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># test_agent_workflow.py</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span><span class=p>,</span> <span class=n>patch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TestAgentWorkflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent集成测试&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@pytest.fixture</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>agent</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建测试用Agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>calculator_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是助手&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_tool_selection</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>agent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测试工具选择正确性&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;搜索Python&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>messages</span> <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=s1>&#39;name&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 验证调用了search_tool</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=nb>any</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;search_tool&#34;</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>tool_calls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@patch</span><span class=p>(</span><span class=s1>&#39;langchain_openai.ChatOpenAI&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>test_with_mocked_llm</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_llm_class</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Mock LLM避免真实API调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_llm</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_llm_class</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mock_llm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl>        <span class=n>mock_llm</span><span class=o>.</span><span class=n>invoke</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;模拟回复&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>mock_llm</span><span class=p>,</span> <span class=n>tools</span><span class=o>=</span><span class=p>[],</span> <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;测试&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;测试&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=s2>&#34;模拟回复&#34;</span> <span class=ow>in</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=n>mock_llm</span><span class=o>.</span><span class=n>invoke</span><span class=o>.</span><span class=n>called</span></span></span></code></pre></div><hr><h3 id=63-langsmith自动化评估>6.3 LangSmith自动化评估<a class=anchor href=#63-langsmith%e8%87%aa%e5%8a%a8%e5%8c%96%e8%af%84%e4%bc%b0>#</a></h3><h4 id=631-创建评估dataset>6.3.1 创建评估Dataset<a class=anchor href=#631-%e5%88%9b%e5%bb%ba%e8%af%84%e4%bc%b0dataset>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith</span> <span class=kn>import</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>client</span> <span class=o>=</span> <span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建Dataset</span>
</span></span><span class=line><span class=cl><span class=n>dataset</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_dataset</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>dataset_name</span><span class=o>=</span><span class=s2>&#34;customer_support_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=s2>&#34;客服问答评估数据集&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加测试用例</span>
</span></span><span class=line><span class=cl><span class=n>test_cases</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;inputs&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;question&#34;</span><span class=p>:</span> <span class=s2>&#34;如何退款？&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;outputs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;expected_keywords&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;订单详情&#34;</span><span class=p>,</span> <span class=s2>&#34;申请退款&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;relevance_score&#34;</span><span class=p>:</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1># ... 更多用例</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=k>case</span> <span class=ow>in</span> <span class=n>test_cases</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span><span class=o>.</span><span class=n>create_example</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>dataset_id</span><span class=o>=</span><span class=n>dataset</span><span class=o>.</span><span class=n>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>inputs</span><span class=o>=</span><span class=k>case</span><span class=p>[</span><span class=s2>&#34;inputs&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>outputs</span><span class=o>=</span><span class=k>case</span><span class=p>[</span><span class=s2>&#34;outputs&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span></span></span></code></pre></div><hr><h4 id=632-定义evaluators>6.3.2 定义Evaluators<a class=anchor href=#632-%e5%ae%9a%e4%b9%89evaluators>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@evaluator</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>keyword_coverage_evaluator</span><span class=p>(</span><span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;关键词覆盖率评估&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>answer</span> <span class=o>=</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>expected_keywords</span> <span class=o>=</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_keywords&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>found</span> <span class=o>=</span> <span class=p>[</span><span class=n>kw</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>expected_keywords</span> <span class=k>if</span> <span class=n>kw</span> <span class=ow>in</span> <span class=n>answer</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>score</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>found</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>expected_keywords</span><span class=p>)</span> <span class=k>if</span> <span class=n>expected_keywords</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;key&#34;</span><span class=p>:</span> <span class=s2>&#34;keyword_coverage&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;score&#34;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;comment&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;覆盖 </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>found</span><span class=p>)</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>expected_keywords</span><span class=p>)</span><span class=si>}</span><span class=s2> 个关键词&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># LLM-as-Judge评估器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>LangChainStringEvaluator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>llm_evaluator</span> <span class=o>=</span> <span class=n>LangChainStringEvaluator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;cot_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>prepare_data</span><span class=o>=</span><span class=k>lambda</span> <span class=n>run</span><span class=p>,</span> <span class=n>example</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;prediction&#34;</span><span class=p>:</span> <span class=n>run</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;answer&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;reference&#34;</span><span class=p>:</span> <span class=n>example</span><span class=o>.</span><span class=n>outputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;expected_answer&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=n>example</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;question&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h4 id=633-运行评估与ab测试>6.3.3 运行评估与A/B测试<a class=anchor href=#633-%e8%bf%90%e8%a1%8c%e8%af%84%e4%bc%b0%e4%b8%8eab%e6%b5%8b%e8%af%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 版本A</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict_v_a</span><span class=p>(</span><span class=n>inputs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是客服助手&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 版本B（改进的Prompt）</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>predict_v_b</span><span class=p>(</span><span class=n>inputs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;&#34;&#34;你是专业的客服助手。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>回答要求：
</span></span></span><span class=line><span class=cl><span class=s2>1. 准确理解用户问题
</span></span></span><span class=line><span class=cl><span class=s2>2. 提供清晰的步骤说明
</span></span></span><span class=line><span class=cl><span class=s2>3. 使用友好的语气&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>])]})</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;answer&#34;</span><span class=p>:</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># A/B测试</span>
</span></span><span class=line><span class=cl><span class=n>results_a</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict_v_a</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;customer_support_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>keyword_coverage_evaluator</span><span class=p>,</span> <span class=n>llm_evaluator</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Version_A&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>results_b</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>predict_v_b</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=o>=</span><span class=s2>&#34;customer_support_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>keyword_coverage_evaluator</span><span class=p>,</span> <span class=n>llm_evaluator</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>experiment_prefix</span><span class=o>=</span><span class=s2>&#34;Version_B&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对比</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;版本A关键词覆盖率: </span><span class=si>{</span><span class=n>results_a</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;版本B关键词覆盖率: </span><span class=si>{</span><span class=n>results_b</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>improvement</span> <span class=o>=</span> <span class=p>((</span><span class=n>results_b</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>]</span> <span class=o>-</span> <span class=n>results_a</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>])</span> <span class=o>/</span>
</span></span><span class=line><span class=cl>               <span class=n>results_a</span><span class=p>[</span><span class=s1>&#39;keyword_coverage_avg&#39;</span><span class=p>]</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;改进幅度: </span><span class=si>{</span><span class=n>improvement</span><span class=si>:</span><span class=s2>+.1f</span><span class=si>}</span><span class=s2>%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计显著性检验</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy</span> <span class=kn>import</span> <span class=n>stats</span>
</span></span><span class=line><span class=cl><span class=n>scores_a</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=s2>&#34;keyword_coverage&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results_a</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>scores_b</span> <span class=o>=</span> <span class=p>[</span><span class=n>r</span><span class=o>.</span><span class=n>evaluation_results</span><span class=p>[</span><span class=s2>&#34;keyword_coverage&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results_b</span><span class=o>.</span><span class=n>results</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>t_stat</span><span class=p>,</span> <span class=n>p_value</span> <span class=o>=</span> <span class=n>stats</span><span class=o>.</span><span class=n>ttest_ind</span><span class=p>(</span><span class=n>scores_a</span><span class=p>,</span> <span class=n>scores_b</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;显著性: </span><span class=si>{</span><span class=s1>&#39;✅ 显著&#39;</span> <span class=k>if</span> <span class=n>p_value</span> <span class=o>&lt;</span> <span class=mf>0.05</span> <span class=k>else</span> <span class=s1>&#39;⚠️ 不显著&#39;</span><span class=si>}</span><span class=s2> (p=</span><span class=si>{</span><span class=n>p_value</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=64-cicd集成>6.4 CI/CD集成<a class=anchor href=#64-cicd%e9%9b%86%e6%88%90>#</a></h3><h4 id=641-github-actions配置>6.4.1 GitHub Actions配置<a class=anchor href=#641-github-actions%e9%85%8d%e7%bd%ae>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># .github/workflows/test.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Test Suite</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>push</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>main, dev]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pull_request</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>branches</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=nt>jobs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>unit-tests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-python@v4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>python-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.11&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install dependencies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          pip install -r requirements.txt
</span></span></span><span class=line><span class=cl><span class=sd>          pip install pytest pytest-cov</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Run Unit Tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          pytest tests/unit -v --cov=src --cov-report=xml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Upload coverage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>codecov/codecov-action@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=l>./coverage.xml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>integration-tests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>needs</span><span class=p>:</span><span class=w> </span><span class=l>unit-tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-python@v4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>python-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.11&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install dependencies</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>pip install -r requirements.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Run Integration Tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>OPENAI_API_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.OPENAI_API_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          pytest tests/integration -v</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>langsmith-evaluation</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>runs-on</span><span class=p>:</span><span class=w> </span><span class=l>ubuntu-latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>needs</span><span class=p>:</span><span class=w> </span><span class=l>integration-tests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>steps</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/checkout@v3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>uses</span><span class=p>:</span><span class=w> </span><span class=l>actions/setup-python@v4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>with</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>python-version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.11&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Run LangSmith Evaluation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>LANGSMITH_API_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.LANGSMITH_API_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>OPENAI_API_KEY</span><span class=p>:</span><span class=w> </span><span class=l>${{ secrets.OPENAI_API_KEY }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          python scripts/run_evaluation.py</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Quality Gate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>          python scripts/quality_gate.py</span></span></span></code></pre></div><hr><h4 id=642-质量门禁>6.4.2 质量门禁<a class=anchor href=#642-%e8%b4%a8%e9%87%8f%e9%97%a8%e7%a6%81>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># scripts/quality_gate.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langsmith.evaluation</span> <span class=kn>import</span> <span class=n>evaluate</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>run_quality_gate</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;质量门禁检查&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🚦 运行质量门禁检查...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>results</span> <span class=o>=</span> <span class=n>evaluate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>predict</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span><span class=o>=</span><span class=s2>&#34;customer_support_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>evaluators</span><span class=o>=</span><span class=p>[</span><span class=n>keyword_coverage_evaluator</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 质量标准</span>
</span></span><span class=line><span class=cl>    <span class=n>quality_standards</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;keyword_coverage_avg&#34;</span><span class=p>:</span> <span class=mf>0.80</span><span class=p>,</span>  <span class=c1># &gt;= 80%</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;pass_rate&#34;</span><span class=p>:</span> <span class=mf>0.90</span>  <span class=c1># &gt;= 90%</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>all_passed</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>metric</span><span class=p>,</span> <span class=n>threshold</span> <span class=ow>in</span> <span class=n>quality_standards</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>actual</span> <span class=o>=</span> <span class=n>results</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>metric</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>passed</span> <span class=o>=</span> <span class=n>actual</span> <span class=o>&gt;=</span> <span class=n>threshold</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=s2>&#34;✅ PASS&#34;</span> <span class=k>if</span> <span class=n>passed</span> <span class=k>else</span> <span class=s2>&#34;❌ FAIL&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>metric</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>actual</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2> (阈值: </span><span class=si>{</span><span class=n>threshold</span><span class=si>:</span><span class=s2>.2%</span><span class=si>}</span><span class=s2>) - </span><span class=si>{</span><span class=n>status</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>passed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>all_passed</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>all_passed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>✅ 质量门禁通过，允许部署&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>❌ 质量门禁失败，禁止部署&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=n>run_quality_gate</span><span class=p>())</span></span></span></code></pre></div><hr><h3 id=65-测试最佳实践>6.5 测试最佳实践<a class=anchor href=#65-%e6%b5%8b%e8%af%95%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><p><strong>测试覆盖率目标</strong>：</p><table><thead><tr><th>测试类型</th><th>比例</th><th>速度</th><th>成本</th><th>何时运行</th></tr></thead><tbody><tr><td>单元测试</td><td>70%</td><td>快（秒级）</td><td>低</td><td>每次commit</td></tr><tr><td>集成测试</td><td>20%</td><td>中（分钟级）</td><td>中</td><td>每次PR</td></tr><tr><td>LangSmith评估</td><td>10%</td><td>慢（小时级）</td><td>高</td><td>发布前</td></tr></tbody></table><p><strong>关键原则</strong>：</p><ol><li>✅ 单元测试覆盖所有Tool函数</li><li>✅ 集成测试覆盖关键工作流</li><li>✅ Mock外部依赖（LLM、API）降低成本</li><li>✅ LangSmith评估用于质量对比</li><li>✅ 质量门禁确保生产标准</li><li>✅ CI/CD自动化运行</li></ol><hr><h2 id=第7章错误处理与降级策略>第7章：错误处理与降级策略<a class=anchor href=#%e7%ac%ac7%e7%ab%a0%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e4%b8%8e%e9%99%8d%e7%ba%a7%e7%ad%96%e7%95%a5>#</a></h2><blockquote class=book-hint><p><strong>关注点</strong>: 生产环境的容错与高可用</p></blockquote><h3 id=71-错误处理层次>7.1 错误处理层次<a class=anchor href=#71-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e5%b1%82%e6%ac%a1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户请求
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>┌─────────────────────────────┐
</span></span><span class=line><span class=cl>│ 1. 输入验证                  │ ← 防止无效输入
</span></span><span class=line><span class=cl>└─────────┬───────────────────┘
</span></span><span class=line><span class=cl>          ↓
</span></span><span class=line><span class=cl>┌─────────────────────────────┐
</span></span><span class=line><span class=cl>│ 2. 重试机制                  │ ← 处理临时故障
</span></span><span class=line><span class=cl>└─────────┬───────────────────┘
</span></span><span class=line><span class=cl>          ↓
</span></span><span class=line><span class=cl>┌─────────────────────────────┐
</span></span><span class=line><span class=cl>│ 3. 降级策略                  │ ← 保证基本服务
</span></span><span class=line><span class=cl>└─────────┬───────────────────┘
</span></span><span class=line><span class=cl>          ↓
</span></span><span class=line><span class=cl>┌─────────────────────────────┐
</span></span><span class=line><span class=cl>│ 4. 兜底响应                  │ ← 优雅失败
</span></span><span class=line><span class=cl>└─────────┬───────────────────┘
</span></span><span class=line><span class=cl>          ↓
</span></span><span class=line><span class=cl>    返回结果</span></span></code></pre></div><hr><h3 id=72-输入验证>7.2 输入验证<a class=anchor href=#72-%e8%be%93%e5%85%a5%e9%aa%8c%e8%af%81>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>validator</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentRequest</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Agent请求验证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>min_length</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>max_length</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>pattern</span><span class=o>=</span><span class=sa>r</span><span class=s1>&#39;^[a-zA-Z0-9_-]+$&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>context</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>dict</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;query&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_query</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证查询内容&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检测恶意输入</span>
</span></span><span class=line><span class=cl>        <span class=n>malicious_patterns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;&lt;script&gt;&#39;</span><span class=p>,</span> <span class=s1>&#39;DROP TABLE&#39;</span><span class=p>,</span> <span class=s1>&#39;rm -rf&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>any</span><span class=p>(</span><span class=n>pattern</span> <span class=ow>in</span> <span class=n>v</span> <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>malicious_patterns</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;检测到恶意输入&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检测敏感信息</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;\d{15,19}&#39;</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>  <span class=c1># 信用卡号模式</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&#34;请勿输入敏感信息&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=n>AgentRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span><span class=o>=</span><span class=s2>&#34;帮我查询订单&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span><span class=o>=</span><span class=s2>&#34;user_123&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=n>request</span><span class=o>.</span><span class=n>query</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>),</span> <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;INVALID_INPUT&#34;</span><span class=p>}</span></span></span></code></pre></div><hr><h3 id=73-智能重试机制>7.3 智能重试机制<a class=anchor href=#73-%e6%99%ba%e8%83%bd%e9%87%8d%e8%af%95%e6%9c%ba%e5%88%b6>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tenacity</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>retry</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>stop_after_attempt</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>wait_exponential</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_if_exception_type</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RetryableAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带重试的Agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是助手&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@retry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>stop</span><span class=o>=</span><span class=n>stop_after_attempt</span><span class=p>(</span><span class=mi>3</span><span class=p>),</span>  <span class=c1># 最多重试3次</span>
</span></span><span class=line><span class=cl>        <span class=n>wait</span><span class=o>=</span><span class=n>wait_exponential</span><span class=p>(</span><span class=n>multiplier</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>min</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=nb>max</span><span class=o>=</span><span class=mi>10</span><span class=p>),</span>  <span class=c1># 指数退避</span>
</span></span><span class=line><span class=cl>        <span class=n>retry</span><span class=o>=</span><span class=n>retry_if_exception_type</span><span class=p>((</span><span class=ne>TimeoutError</span><span class=p>,</span> <span class=ne>ConnectionError</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>        <span class=n>before_sleep</span><span class=o>=</span><span class=k>lambda</span> <span class=n>retry_state</span><span class=p>:</span> <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>f</span><span class=s2>&#34;重试 </span><span class=si>{</span><span class=n>retry_state</span><span class=o>.</span><span class=n>attempt_number</span><span class=si>}</span><span class=s2>/3: </span><span class=si>{</span><span class=n>retry_state</span><span class=o>.</span><span class=n>outcome</span><span class=o>.</span><span class=n>exception</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>invoke_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带重试的调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Agent调用失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>RetryableAgent</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke_with_retry</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;测试&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 重试3次后仍失败</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;服务暂时不可用，请稍后重试&#34;</span><span class=p>}</span></span></span></code></pre></div><hr><h3 id=74-多级降级策略>7.4 多级降级策略<a class=anchor href=#74-%e5%a4%9a%e7%ba%a7%e9%99%8d%e7%ba%a7%e7%ad%96%e7%95%a5>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FallbackLevel</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;降级级别&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>PRIMARY</span> <span class=o>=</span> <span class=mi>1</span>      <span class=c1># GPT-4o（最优）</span>
</span></span><span class=line><span class=cl>    <span class=n>SECONDARY</span> <span class=o>=</span> <span class=mi>2</span>    <span class=c1># GPT-4o-mini（次优）</span>
</span></span><span class=line><span class=cl>    <span class=n>TERTIARY</span> <span class=o>=</span> <span class=mi>3</span>     <span class=c1># GPT-3.5-turbo（保底）</span>
</span></span><span class=line><span class=cl>    <span class=n>CACHE</span> <span class=o>=</span> <span class=mi>4</span>        <span class=c1># 缓存结果</span>
</span></span><span class=line><span class=cl>    <span class=n>STATIC</span> <span class=o>=</span> <span class=mi>5</span>       <span class=c1># 静态回复</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FallbackAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多级降级Agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 简单缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_responses</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;default&#34;</span><span class=p>:</span> <span class=s2>&#34;抱歉，服务暂时不可用，请稍后重试。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timeout&#34;</span><span class=p>:</span> <span class=s2>&#34;请求超时，请稍后重试。&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;rate_limit&#34;</span><span class=p>:</span> <span class=s2>&#34;请求过于频繁，请稍后重试。&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>invoke</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;多级降级调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>query</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 级别1：GPT-4o</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invoke_primary</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Primary失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 级别2：GPT-4o-mini</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invoke_secondary</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Secondary失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 级别3：GPT-3.5-turbo</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_invoke_tertiary</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Tertiary失败: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 级别4：缓存</span>
</span></span><span class=line><span class=cl>        <span class=n>cached</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;使用缓存结果&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>cached</span><span class=p>],</span> <span class=s2>&#34;fallback_level&#34;</span><span class=p>:</span> <span class=n>FallbackLevel</span><span class=o>.</span><span class=n>CACHE</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 级别5：静态回复</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=s2>&#34;所有降级策略失败，使用静态回复&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;assistant&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_responses</span><span class=p>[</span><span class=s2>&#34;default&#34;</span><span class=p>])],</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;fallback_level&#34;</span><span class=p>:</span> <span class=n>FallbackLevel</span><span class=o>.</span><span class=n>STATIC</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_invoke_primary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;主要模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>5</span><span class=p>),</span> <span class=n>tools</span><span class=o>=</span><span class=p>[],</span> <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是助手&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=o>**</span><span class=n>result</span><span class=p>,</span> <span class=s2>&#34;fallback_level&#34;</span><span class=p>:</span> <span class=n>FallbackLevel</span><span class=o>.</span><span class=n>PRIMARY</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_invoke_secondary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;次优模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>),</span> <span class=n>tools</span><span class=o>=</span><span class=p>[],</span> <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是助手&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=o>**</span><span class=n>result</span><span class=p>,</span> <span class=s2>&#34;fallback_level&#34;</span><span class=p>:</span> <span class=n>FallbackLevel</span><span class=o>.</span><span class=n>SECONDARY</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_invoke_tertiary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>inputs</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;保底模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>),</span> <span class=n>tools</span><span class=o>=</span><span class=p>[],</span> <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是助手&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=o>**</span><span class=n>result</span><span class=p>,</span> <span class=s2>&#34;fallback_level&#34;</span><span class=p>:</span> <span class=n>FallbackLevel</span><span class=o>.</span><span class=n>TERTIARY</span><span class=p>}</span></span></span></code></pre></div><p><strong>使用示例</strong>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>FallbackAgent</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;你好&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;响应: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;降级级别: </span><span class=si>{</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;fallback_level&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 监控降级率</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>Counter</span>
</span></span><span class=line><span class=cl><span class=n>fallback_counter</span> <span class=o>=</span> <span class=n>Counter</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>100</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;测试&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>    <span class=n>fallback_counter</span><span class=p>[</span><span class=n>result</span><span class=p>[</span><span class=s1>&#39;fallback_level&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>降级统计:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>level</span><span class=p>,</span> <span class=n>count</span> <span class=ow>in</span> <span class=n>fallback_counter</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>level</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>count</span><span class=si>}</span><span class=s2>次 (</span><span class=si>{</span><span class=n>count</span><span class=o>/</span><span class=mi>100</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出:</span>
</span></span><span class=line><span class=cl><span class=c1># PRIMARY: 85次 (85.0%)</span>
</span></span><span class=line><span class=cl><span class=c1># SECONDARY: 10次 (10.0%)</span>
</span></span><span class=line><span class=cl><span class=c1># TERTIARY: 3次 (3.0%)</span>
</span></span><span class=line><span class=cl><span class=c1># CACHE: 2次 (2.0%)</span></span></span></code></pre></div><hr><h3 id=75-熔断器模式>7.5 熔断器模式<a class=anchor href=#75-%e7%86%94%e6%96%ad%e5%99%a8%e6%a8%a1%e5%bc%8f>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitState</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;熔断器状态&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CLOSED</span> <span class=o>=</span> <span class=s2>&#34;closed&#34;</span>      <span class=c1># 正常</span>
</span></span><span class=line><span class=cl>    <span class=n>OPEN</span> <span class=o>=</span> <span class=s2>&#34;open&#34;</span>          <span class=c1># 熔断（拒绝请求）</span>
</span></span><span class=line><span class=cl>    <span class=n>HALF_OPEN</span> <span class=o>=</span> <span class=s2>&#34;half_open&#34;</span>  <span class=c1># 半开（尝试恢复）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitBreaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;熔断器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>failure_threshold</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>  <span class=c1># 失败阈值</span>
</span></span><span class=line><span class=cl>        <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>,</span>  <span class=c1># 熔断超时(秒)</span>
</span></span><span class=line><span class=cl>        <span class=n>half_open_max_calls</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span>  <span class=c1># 半开状态最大尝试次数</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span> <span class=o>=</span> <span class=n>failure_threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>half_open_max_calls</span> <span class=o>=</span> <span class=n>half_open_max_calls</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>CLOSED</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>half_open_calls</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>OPEN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检查是否可以转为半开状态</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>&gt;</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>HALF_OPEN</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>half_open_calls</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;熔断器转为半开状态&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;熔断器开启，拒绝请求&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 成功</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>HALF_OPEN</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>half_open_calls</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>half_open_calls</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>half_open_max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>CLOSED</span>
</span></span><span class=line><span class=cl>                    <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;熔断器恢复正常&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 失败</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=n>CircuitState</span><span class=o>.</span><span class=n>OPEN</span>
</span></span><span class=line><span class=cl>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;熔断器开启（失败</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span><span class=si>}</span><span class=s2>次）&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>circuit_breaker</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>(</span><span class=n>failure_threshold</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>invoke_agent</span><span class=p>(</span><span class=n>inputs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;调用Agent（可能失败）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=k>lambda</span><span class=p>:</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>invoke_agent</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;测试&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;请求</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>: ✅ 成功&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;请求</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>: ❌ </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=76-监控与告警>7.6 监控与告警<a class=anchor href=#76-%e7%9b%91%e6%8e%a7%e4%b8%8e%e5%91%8a%e8%ad%a6>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;错误指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>    <span class=n>error_type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>error_message</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>fallback_level</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;错误监控&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>errors</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>ErrorMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_error</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>error_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>error_message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>fallback_level</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>errors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ErrorMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>error_type</span><span class=o>=</span><span class=n>error_type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>error_message</span><span class=o>=</span><span class=n>error_message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_level</span><span class=o>=</span><span class=n>fallback_level</span>
</span></span><span class=line><span class=cl>        <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_error_rate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>window_minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取错误率&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cutoff_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=n>window_minutes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_errors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>errors</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=n>cutoff_time</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># 假设总请求数</span>
</span></span><span class=line><span class=cl>        <span class=n>total_requests</span> <span class=o>=</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_errors</span><span class=p>)</span> <span class=o>/</span> <span class=n>total_requests</span> <span class=k>if</span> <span class=n>total_requests</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_alerts</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查告警&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 错误率告警</span>
</span></span><span class=line><span class=cl>        <span class=n>error_rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_error_rate</span><span class=p>(</span><span class=n>window_minutes</span><span class=o>=</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>error_rate</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># 10%</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  错误率过高: </span><span class=si>{</span><span class=n>error_rate</span><span class=si>:</span><span class=s2>.1%</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 降级告警</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_fallbacks</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>errors</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>fallback_level</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;TERTIARY&#34;</span><span class=p>,</span> <span class=s2>&#34;CACHE&#34;</span><span class=p>,</span> <span class=s2>&#34;STATIC&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_fallbacks</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>20</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;⚠️  频繁降级: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>recent_fallbacks</span><span class=p>)</span><span class=si>}</span><span class=s2>次&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>alerts</span></span></span></code></pre></div><hr><h3 id=77-错误处理最佳实践>7.7 错误处理最佳实践<a class=anchor href=#77-%e9%94%99%e8%af%af%e5%a4%84%e7%90%86%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><p><strong>生产环境检查清单</strong>：</p><ul><li><p><input disabled type=checkbox> <strong>输入验证</strong></p><ul><li><input disabled type=checkbox> 长度限制</li><li><input disabled type=checkbox> 格式验证</li><li><input disabled type=checkbox> 恶意输入检测</li><li><input disabled type=checkbox> 敏感信息过滤</li></ul></li><li><p><input disabled type=checkbox> <strong>重试机制</strong></p><ul><li><input disabled type=checkbox> 指数退避</li><li><input disabled type=checkbox> 最大重试次数</li><li><input disabled type=checkbox> 可重试异常类型</li></ul></li><li><p><input disabled type=checkbox> <strong>降级策略</strong></p><ul><li><input disabled type=checkbox> 多级模型降级</li><li><input disabled type=checkbox> 缓存降级</li><li><input disabled type=checkbox> 静态响应兜底</li></ul></li><li><p><input disabled type=checkbox> <strong>熔断保护</strong></p><ul><li><input disabled type=checkbox> 失败阈值配置</li><li><input disabled type=checkbox> 熔断超时配置</li><li><input disabled type=checkbox> 半开状态尝试</li></ul></li><li><p><input disabled type=checkbox> <strong>监控告警</strong></p><ul><li><input disabled type=checkbox> 错误率监控</li><li><input disabled type=checkbox> 降级率监控</li><li><input disabled type=checkbox> 告警规则配置</li></ul></li></ul><p><strong>关键指标</strong>：</p><table><thead><tr><th>指标</th><th>目标值</th><th>告警阈值</th></tr></thead><tbody><tr><td>错误率</td><td>&lt; 1%</td><td>> 5%</td></tr><tr><td>降级率</td><td>&lt; 5%</td><td>> 20%</td></tr><tr><td>重试成功率</td><td>> 80%</td><td>&lt; 50%</td></tr><tr><td>熔断触发次数</td><td>0</td><td>> 3次/小时</td></tr></tbody></table><hr></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第九篇 Agent 架构设计</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/ class="flex align-center"><span>fasta2a</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#第1章langsmith-tracing-与-evaluation>第1章：LangSmith Tracing 与 Evaluation</a><ul><li><a href=#11-追踪体系>1.1 追踪体系</a><ul><li><a href=#111-追踪原理与数据模型>1.1.1 追踪原理与数据模型</a></li><li><a href=#112-自动追踪环境变量配置>1.1.2 自动追踪：环境变量配置</a></li><li><a href=#113-手动追踪traceable-装饰器>1.1.3 手动追踪：@traceable 装饰器</a></li><li><a href=#114-追踪信息分析>1.1.4 追踪信息分析</a></li></ul></li><li><a href=#12-evaluation-评估框架>1.2 Evaluation 评估框架</a><ul><li><a href=#121-dataset-管理与测试集设计>1.2.1 Dataset 管理与测试集设计</a></li><li><a href=#122-评估指标准确率相关性一致性延迟成本>1.2.2 评估指标：准确率、相关性、一致性、延迟、成本</a></li><li><a href=#123-evaluate-批量测试>1.2.3 evaluate() 批量测试</a></li><li><a href=#124-人工标注与反馈收集>1.2.4 人工标注与反馈收集</a></li></ul></li><li><a href=#13-持续优化>1.3 持续优化</a><ul><li><a href=#131-prompt-hub-版本控制>1.3.1 Prompt Hub 版本控制</a></li><li><a href=#132-ab-测试>1.3.2 A/B 测试</a></li><li><a href=#133-监控指标与问题发现>1.3.3 监控指标与问题发现</a></li><li><a href=#134-优化迭代流程>1.3.4 优化迭代流程</a></li></ul></li><li><a href=#本章小结>本章小结</a></li><li><a href=#思考与练习>思考与练习</a></li><li><a href=#总结与展望>总结与展望</a></li></ul></li><li><a href=#第2章-架构设计模式>第2章： 架构设计模式</a><ul><li><a href=#21-rag-架构设计>2.1 RAG 架构设计</a></li><li><a href=#22-multi-agent-架构选择>2.2 Multi-Agent 架构选择</a></li><li><a href=#23-workflow-架构模式>2.3 Workflow 架构模式</a></li></ul></li><li><a href=#第3章-性能与成本优化>第3章： 性能与成本优化</a><ul><li><a href=#31-延迟优化>3.1 延迟优化</a></li><li><a href=#32-吞吐量优化>3.2 吞吐量优化</a></li><li><a href=#33-token-管理与成本控制>3.3 Token 管理与成本控制</a></li><li><a href=#34-缓存复用策略>3.4 缓存复用策略</a></li><li><a href=#35-自适应模型选择>3.5 自适应模型选择</a></li><li><a href=#36-批处理优化>3.6 批处理优化</a></li><li><a href=#37-成本监控与优化清单>3.7 成本监控与优化清单</a></li></ul></li><li><a href=#第4章-安全合规与防护>第4章： 安全合规与防护</a><ul><li><a href=#41-guardrails-防护体系>4.1 Guardrails 防护体系</a></li><li><a href=#42-pii-检测策略>4.2 PII 检测策略</a></li><li><a href=#43-分层防护组合>4.3 分层防护组合</a></li><li><a href=#44-自定义-guardrails-开发>4.4 自定义 Guardrails 开发</a></li><li><a href=#45-输入输出安全>4.5 输入输出安全</a></li><li><a href=#46-数据合规>4.6 数据合规</a></li><li><a href=#47-审计日志>4.7 审计日志</a></li></ul></li><li><a href=#第5章-部署与运维>第5章： 部署与运维</a><ul><li><a href=#51-部署策略>5.1 部署策略</a></li><li><a href=#52-监控告警>5.2 监控告警</a><ul><li><a href=#521-prometheus监控集成>5.2.1 Prometheus监控集成</a></li><li><a href=#522-监控系统实现>5.2.2 监控系统实现</a></li></ul></li><li><a href=#53-故障处理>5.3 故障处理</a></li><li><a href=#54-生产部署检查清单>5.4 生产部署检查清单</a><ul><li><a href=#541-安全检查清单>5.4.1 安全检查清单</a></li><li><a href=#542-性能检查清单>5.4.2 性能检查清单</a></li><li><a href=#543-可靠性检查清单>5.4.3 可靠性检查清单</a></li><li><a href=#544-监控检查清单>5.4.4 监控检查清单</a></li><li><a href=#545-成本检查清单>5.4.5 成本检查清单</a></li><li><a href=#546-数据合规检查清单>5.4.6 数据合规检查清单</a></li><li><a href=#547-部署前最终检查>5.4.7 部署前最终检查</a></li></ul></li><li><a href=#本章小结-1>本章小结</a></li></ul></li><li><a href=#第6章测试与质量保障>第6章：测试与质量保障</a><ul><li><a href=#61-测试金字塔>6.1 测试金字塔</a></li><li><a href=#62-单元测试实践>6.2 单元测试实践</a><ul><li><a href=#621-tool函数测试>6.2.1 Tool函数测试</a></li><li><a href=#622-agent工作流集成测试>6.2.2 Agent工作流集成测试</a></li></ul></li><li><a href=#63-langsmith自动化评估>6.3 LangSmith自动化评估</a><ul><li><a href=#631-创建评估dataset>6.3.1 创建评估Dataset</a></li><li><a href=#632-定义evaluators>6.3.2 定义Evaluators</a></li><li><a href=#633-运行评估与ab测试>6.3.3 运行评估与A/B测试</a></li></ul></li><li><a href=#64-cicd集成>6.4 CI/CD集成</a><ul><li><a href=#641-github-actions配置>6.4.1 GitHub Actions配置</a></li><li><a href=#642-质量门禁>6.4.2 质量门禁</a></li></ul></li><li><a href=#65-测试最佳实践>6.5 测试最佳实践</a></li></ul></li><li><a href=#第7章错误处理与降级策略>第7章：错误处理与降级策略</a><ul><li><a href=#71-错误处理层次>7.1 错误处理层次</a></li><li><a href=#72-输入验证>7.2 输入验证</a></li><li><a href=#73-智能重试机制>7.3 智能重试机制</a></li><li><a href=#74-多级降级策略>7.4 多级降级策略</a></li><li><a href=#75-熔断器模式>7.5 熔断器模式</a></li><li><a href=#76-监控与告警>7.6 监控与告警</a></li><li><a href=#77-错误处理最佳实践>7.7 错误处理最佳实践</a></li></ul></li></ul></nav></div></aside></main></body></html>