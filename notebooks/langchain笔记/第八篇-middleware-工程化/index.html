<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='第八篇 Middleware 工程化# 目标: 掌握 LangChain Middleware 机制,实现对 Agent 行为的精准控制
在前面的篇章中,我们学会了如何创建Agent(create_agent)、构建复杂工作流(LangGraph)、处理复杂任务(Deep Agents)。但这些都是"功能实现"层面,本篇进入工程化阶段:如何让Agent在生产环境中安全、可靠、可控地运行。
核心问题:
如何防止Agent泄露敏感信息? 如何限制Agent的调用成本? 如何在关键操作前要求人工审批? 如何在对话过长时自动摘要? 解决方案: Middleware - LangChain 1.0的核心机制,允许你在Agent执行的各个阶段精准干预。
第1章：Middleware 核心机制# 本章目标: 理解Middleware的本质、运行原理和基本用法
1.1 什么是 Middleware# 1.1.1 Agent执行流程回顾# 首先回顾create_agent创建的Agent是如何工作的:
from langchain.agents import create_agent from langchain_openai import ChatOpenAI agent = create_agent( model=ChatOpenAI(model="gpt-4o"), tools=[search_tool, calculator_tool] ) result = agent.invoke({"messages": [("user", "搜索最新新闻")]})内部执行流程：
问题: 这个流程是"黑盒",我们无法干预中间步骤。而 Middleware 正是解决这个问题的关键机制。
1.1.2 Middleware的切入点与生命周期# Middleware在Agent执行的关键节点提供Hook(钩子),允许你精准干预。下图展示了 Agent Loop 与 Middleware Hooks 的交互流程,清晰呈现每个 Hook 的触发时机:
Middleware Lifecycle (生命周期)
核心流程说明:
用户请求 → before_agent Hook: 权限检查、输入验证、初始化 before_model Hook → 模型推理前: 修改提示词、检查 Token、条件跳转 wrap_model_call Hook → 包装模型调用: 缓存、重试、降级、成本控制 模型响应 → after_model Hook: 审核输出、记录日志、质量评分 如需工具 → wrap_tool_call Hook → 工具执行: 重试、限流、审批、模拟执行 → 返回循环 无需工具 → after_agent Hook → Agent 结束: 保存结果、计费、清理资源 Hook 快速参考
'><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/"><meta property="og:site_name" content="LordFoxFairy的笔记本"><meta property="og:title" content="第八篇 Middleware 工程化"><meta property="og:description" content='第八篇 Middleware 工程化# 目标: 掌握 LangChain Middleware 机制,实现对 Agent 行为的精准控制
在前面的篇章中,我们学会了如何创建Agent(create_agent)、构建复杂工作流(LangGraph)、处理复杂任务(Deep Agents)。但这些都是"功能实现"层面,本篇进入工程化阶段:如何让Agent在生产环境中安全、可靠、可控地运行。
核心问题:
如何防止Agent泄露敏感信息? 如何限制Agent的调用成本? 如何在关键操作前要求人工审批? 如何在对话过长时自动摘要? 解决方案: Middleware - LangChain 1.0的核心机制,允许你在Agent执行的各个阶段精准干预。
第1章：Middleware 核心机制# 本章目标: 理解Middleware的本质、运行原理和基本用法
1.1 什么是 Middleware# 1.1.1 Agent执行流程回顾# 首先回顾create_agent创建的Agent是如何工作的:
from langchain.agents import create_agent from langchain_openai import ChatOpenAI agent = create_agent( model=ChatOpenAI(model="gpt-4o"), tools=[search_tool, calculator_tool] ) result = agent.invoke({"messages": [("user", "搜索最新新闻")]})内部执行流程：
问题: 这个流程是"黑盒",我们无法干预中间步骤。而 Middleware 正是解决这个问题的关键机制。
1.1.2 Middleware的切入点与生命周期# Middleware在Agent执行的关键节点提供Hook(钩子),允许你精准干预。下图展示了 Agent Loop 与 Middleware Hooks 的交互流程,清晰呈现每个 Hook 的触发时机:
Middleware Lifecycle (生命周期)
核心流程说明:
用户请求 → before_agent Hook: 权限检查、输入验证、初始化 before_model Hook → 模型推理前: 修改提示词、检查 Token、条件跳转 wrap_model_call Hook → 包装模型调用: 缓存、重试、降级、成本控制 模型响应 → after_model Hook: 审核输出、记录日志、质量评分 如需工具 → wrap_tool_call Hook → 工具执行: 重试、限流、审批、模拟执行 → 返回循环 无需工具 → after_agent Hook → Agent 结束: 保存结果、计费、清理资源 Hook 快速参考'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="notebooks"><meta itemprop=name content="第八篇 Middleware 工程化"><meta itemprop=description content='第八篇 Middleware 工程化# 目标: 掌握 LangChain Middleware 机制,实现对 Agent 行为的精准控制
在前面的篇章中,我们学会了如何创建Agent(create_agent)、构建复杂工作流(LangGraph)、处理复杂任务(Deep Agents)。但这些都是"功能实现"层面,本篇进入工程化阶段:如何让Agent在生产环境中安全、可靠、可控地运行。
核心问题:
如何防止Agent泄露敏感信息? 如何限制Agent的调用成本? 如何在关键操作前要求人工审批? 如何在对话过长时自动摘要? 解决方案: Middleware - LangChain 1.0的核心机制,允许你在Agent执行的各个阶段精准干预。
第1章：Middleware 核心机制# 本章目标: 理解Middleware的本质、运行原理和基本用法
1.1 什么是 Middleware# 1.1.1 Agent执行流程回顾# 首先回顾create_agent创建的Agent是如何工作的:
from langchain.agents import create_agent from langchain_openai import ChatOpenAI agent = create_agent( model=ChatOpenAI(model="gpt-4o"), tools=[search_tool, calculator_tool] ) result = agent.invoke({"messages": [("user", "搜索最新新闻")]})内部执行流程：
问题: 这个流程是"黑盒",我们无法干预中间步骤。而 Middleware 正是解决这个问题的关键机制。
1.1.2 Middleware的切入点与生命周期# Middleware在Agent执行的关键节点提供Hook(钩子),允许你精准干预。下图展示了 Agent Loop 与 Middleware Hooks 的交互流程,清晰呈现每个 Hook 的触发时机:
Middleware Lifecycle (生命周期)
核心流程说明:
用户请求 → before_agent Hook: 权限检查、输入验证、初始化 before_model Hook → 模型推理前: 修改提示词、检查 Token、条件跳转 wrap_model_call Hook → 包装模型调用: 缓存、重试、降级、成本控制 模型响应 → after_model Hook: 审核输出、记录日志、质量评分 如需工具 → wrap_tool_call Hook → 工具执行: 重试、限流、审批、模拟执行 → 返回循环 无需工具 → after_agent Hook → Agent 结束: 保存结果、计费、清理资源 Hook 快速参考'><meta itemprop=wordCount content="3684"><title>第八篇 Middleware 工程化 | LordFoxFairy的笔记本</title><link rel=icon href=/favicon.png><link rel=manifest href=/manifest.json><link rel=canonical href=https://LordFoxFairy.github.io/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/><link rel=stylesheet href=/book.min.6970156cec683193d93c9c4edaf0d56574e4361df2e0c1be4f697ae81c3ba55f.css integrity="sha256-aXAVbOxoMZPZPJxO2vDVZXTkNh3y4MG+T2l66Bw7pV8=" crossorigin=anonymous><script defer src=/fuse.min.js></script><script defer src=/en.search.min.a7a11a812549b6c20d4eeaf4a5a8317847527505f7a0ad3e6824fb320b3128a8.js integrity="sha256-p6EagSVJtsINTur0pagxeEdSdQX3oK0+aCT7MgsxKKg=" crossorigin=anonymous></script></head><body dir=ltr class="book-kind-page book-type-notebooks"><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>LordFoxFairy的笔记本</span></a></h2><div class="book-search hidden"><input id=book-search-input type=text placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><script>document.querySelector(".book-search").classList.remove("hidden")</script><ul><li><input type=checkbox id=section-8410cdd8ef137d6cb143c08e6db6ba10 class=toggle checked>
<label for=section-8410cdd8ef137d6cb143c08e6db6ba10 class=flex><a role=button>LangChain笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87-%E5%9F%BA%E7%A1%80%E8%AE%A4%E7%9F%A5/>第一篇 基础认知</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B%E5%AE%9E%E6%88%98/>第二篇 快速上手实战</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87-langgraph-%E6%B7%B1%E5%85%A5/>第三篇 LangGraph 深入</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87langchain%E7%AF%87/>第四篇 RAG基础篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87-rag%E5%9F%BA%E7%A1%80%E7%AF%87llamaindex%E7%AF%87/>第四篇 RAG基础篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87langchain%E7%AF%87/>第五篇 RAG高级篇(LangChain篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87-rag%E9%AB%98%E7%BA%A7%E7%AF%87llamaindex%E7%AF%87/>第五篇 RAG高级篇(LlamaIndex篇)</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87-%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97/>第六篇 文档处理与数据清洗</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/>第七篇 Deep Agents</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87-middleware-%E5%B7%A5%E7%A8%8B%E5%8C%96/ class=active>第八篇 Middleware 工程化</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/>第九篇 Agent 架构设计</a></li><li><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%8D%81%E7%AF%87-%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5%E4%B8%8E%E7%9B%91%E6%8E%A7%E8%AF%84%E4%BC%B0/>第十篇 生产实践与监控评估</a></li><li><input type=checkbox id=section-a3e9b1811e5a21dbfddb0753f565cedb class=toggle>
<label for=section-a3e9b1811e5a21dbfddb0753f565cedb class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><input type=checkbox id=section-9a64553a000534ad3c81a611c6c29ec2 class=toggle>
<label for=section-9a64553a000534ad3c81a611c6c29ec2 class=flex><a role=button>code</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-6fad2589acfdd5d6a1fb55beb392fb77 class=toggle>
<label for=section-6fad2589acfdd5d6a1fb55beb392fb77 class=flex><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/code/fasta2a/>fasta2a</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li></ul></li></ul></li><li><input type=checkbox id=section-ce33306d44f9ed4d296b9a79329bed1c class=toggle>
<label for=section-ce33306d44f9ed4d296b9a79329bed1c class=flex><a role=button>图像算法笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E7%AF%87_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第一篇 机器学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E7%AF%87_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第二篇 深度学习基础</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E7%AF%87_%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF/>第三篇 计算机视觉核心技术</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E7%AF%87_%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E4%B8%8Eyolo%E7%B3%BB%E5%88%97/>第四篇 目标检测与YOLO系列</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E7%AF%87_%E5%9B%BE%E5%83%8F%E5%88%86%E5%89%B2/>第五篇 图像分割</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E7%AF%87_%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B/>第六篇 生成模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87_%E8%A7%86%E8%A7%89%E5%A4%A7%E6%A8%A1%E5%9E%8B/>第七篇 视觉大模型</a></li><li><a href=/notebooks/%E5%9B%BE%E5%83%8F%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AB%E7%AF%87_%E7%94%9F%E4%BA%A7%E5%AE%9E%E8%B7%B5/>第八篇 生产实践</a></li></ul></li><li><input type=checkbox id=section-77f5db9e44a9af6dab4403b49a65334f class=toggle>
<label for=section-77f5db9e44a9af6dab4403b49a65334f class=flex><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/>大模型笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><input type=checkbox id=section-db59738de306cbbe384ad7fbd5cf11b5 class=toggle>
<label for=section-db59738de306cbbe384ad7fbd5cf11b5 class=flex><a role=button>第一部分：大语言模型基础</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC1%E7%AB%A0_%E5%88%9D%E8%AF%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/>第1章 初识大语言模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC2%E7%AB%A0_%E4%B8%8E%E6%A8%A1%E5%9E%8B%E5%AF%B9%E8%AF%9D%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第2章 与模型对话：提示工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80/%E7%AC%AC3%E7%AB%A0_%E8%AF%AD%E8%A8%80%E7%9A%84%E5%9F%BA%E7%9F%B3%E5%88%86%E8%AF%8D%E4%B8%8E%E5%B5%8C%E5%85%A5/>第3章 语言的基石：分词与嵌入</a></li></ul></li><li><input type=checkbox id=section-30b17899e420f6a53aa6e578440dd132 class=toggle>
<label for=section-30b17899e420f6a53aa6e578440dd132 class=flex><a role=button>第二部分：Transformer架构揭秘</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC1%E7%AB%A0_transformer%E6%A0%B8%E5%BF%83%E6%8F%AD%E7%A7%98/>第1章 Transformer核心揭秘</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC2%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%B6%E6%97%8F%E8%B0%B1%E7%B3%BB%E4%BB%8E%E7%BC%96%E7%A0%81%E5%99%A8%E5%88%B0%E8%A7%A3%E7%A0%81%E5%99%A8/>第2章 模型家族谱系：从编码器到解码器</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86transformer%E6%9E%B6%E6%9E%84%E6%8F%AD%E7%A7%98/%E7%AC%AC3%E7%AB%A0_%E9%A2%84%E8%AE%AD%E7%BB%83%E7%9A%84%E5%A5%A5%E7%A7%98%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%88%B0%E6%99%BA%E8%83%BD/>第3章 预训练的奥秘：从数据到智能</a></li></ul></li><li><input type=checkbox id=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=toggle>
<label for=section-da88ac5e3d01ea6f4b2996cb87ecf19f class=flex><a role=button>第三部分：数据工程与定制化</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC1%E7%AB%A0_%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E5%9F%BA%E7%A1%80/>第1章 数据工程基础</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC2%E7%AB%A0_%E5%BE%AE%E8%B0%83%E4%BD%A0%E7%9A%84%E4%B8%93%E5%B1%9E%E6%A8%A1%E5%9E%8B/>第2章 微调你的专属模型</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC3%E7%AB%A0_%E4%B8%8E%E4%BA%BA%E7%B1%BB%E5%AF%B9%E9%BD%90%E5%81%8F%E5%A5%BD%E4%BC%98%E5%8C%96/>第3章 与人类对齐：偏好优化</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%E5%B7%A5%E7%A8%8B%E4%B8%8E%E5%AE%9A%E5%88%B6%E5%8C%96/%E7%AC%AC4%E7%AB%A0_%E5%88%9B%E5%BB%BA%E6%9B%B4%E4%BC%98%E7%9A%84%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B/>第4章 创建更优的嵌入模型</a></li></ul></li><li><input type=checkbox id=section-81f0a7a10bc544ea0e1fd883e2a436eb class=toggle>
<label for=section-81f0a7a10bc544ea0e1fd883e2a436eb class=flex><a role=button>第四部分：大模型应用开发</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC1%E7%AB%A0_%E6%8F%90%E7%A4%BA%E5%B7%A5%E7%A8%8B%E4%B8%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AD%A6%E4%B9%A0/>第1章 提示工程与上下文学习</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC2%E7%AB%A0_%E6%A3%80%E7%B4%A2%E5%A2%9E%E5%BC%BA%E7%94%9F%E6%88%90rag%E5%8E%9F%E7%90%86/>第2章 检索增强生成（RAG）原理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC3%E7%AB%A0_%E6%99%BA%E8%83%BD%E4%BD%93agent%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6/>第3章 智能体（Agent）核心机制</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E7%AC%AC4%E7%AB%A0_%E5%A4%9A%E6%A8%A1%E6%80%81%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86/>第4章 多模态大模型原理</a></li></ul></li><li><input type=checkbox id=section-0509decfe880d3d2074947902aea8022 class=toggle>
<label for=section-0509decfe880d3d2074947902aea8022 class=flex><a role=button>第五部分：工程实战工具栈</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC1%E7%AB%A0_hugging_face%E7%94%9F%E6%80%81%E5%85%A8%E6%99%AF/>第1章 Hugging Face生态全景</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC2%E7%AB%A0_llama-factory%E5%BE%AE%E8%B0%83%E5%B7%A5%E5%8E%82/>第2章 LLaMA-Factory微调工厂</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC3%E7%AB%A0_trl%E4%B8%8E%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/>第3章 TRL与强化学习实战</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC4%E7%AB%A0_deepspeed%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%AD%E7%BB%83/>第4章 DeepSpeed分布式训练</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86%E5%B7%A5%E7%A8%8B%E5%AE%9E%E6%88%98%E5%B7%A5%E5%85%B7%E6%A0%88/%E7%AC%AC5%E7%AB%A0_%E7%AB%AF%E5%88%B0%E7%AB%AFllm%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/>第5章 端到端LLM项目实战</a></li></ul></li><li><input type=checkbox id=section-dc465ed94a0f7fb78440cab8a8a2a28b class=toggle>
<label for=section-dc465ed94a0f7fb78440cab8a8a2a28b class=flex><a role=button>第六部分：生产部署与评估</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC1%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%8E%8B%E7%BC%A9%E4%B8%8E%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F/>第1章 模型压缩与推理加速</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC2%E7%AB%A0_vllm%E9%AB%98%E6%80%A7%E8%83%BD%E6%8E%A8%E7%90%86/>第2章 vLLM高性能推理</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86%E7%94%9F%E4%BA%A7%E9%83%A8%E7%BD%B2%E4%B8%8E%E8%AF%84%E4%BC%B0/%E7%AC%AC3%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E8%AF%84%E4%BC%B0%E4%BD%93%E7%B3%BB/>第3章 模型评估体系</a></li></ul></li><li><input type=checkbox id=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=toggle>
<label for=section-54ec04ac2cdda7238de2ed38f0bcb7b1 class=flex><a role=button>第七部分：高级技术专题</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC1%E7%AB%A0_%E9%95%BF%E4%B8%8A%E4%B8%8B%E6%96%87%E6%8A%80%E6%9C%AF/>第1章 长上下文技术</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC2%E7%AB%A0_%E6%96%B0%E5%9E%8B%E6%9E%B6%E6%9E%84%E6%8E%A2%E7%B4%A2/>第2章 新型架构探索</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC3%E7%AB%A0_%E6%8E%A8%E7%90%86%E5%8A%A0%E9%80%9F%E9%BB%91%E7%A7%91%E6%8A%80/>第3章 推理加速黑科技</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC4%E7%AB%A0_%E6%8E%A8%E7%90%86%E6%A8%A1%E5%9E%8B%E4%B8%93%E9%A2%98/>第4章 推理模型专题</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86%E9%AB%98%E7%BA%A7%E6%8A%80%E6%9C%AF%E4%B8%93%E9%A2%98/%E7%AC%AC5%E7%AB%A0_%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B8%8E%E5%8F%AF%E8%A7%A3%E9%87%8A%E6%80%A7/>第5章 模型安全与可解释性</a></li></ul></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/glossary/>GLOSSARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/roadmap/>ROADMAP</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/summary/>SUMMARY</a></li><li><a href=/notebooks/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%AC%94%E8%AE%B0/%E5%AE%8C%E7%BB%93%E6%8A%A5%E5%91%8A/>完结报告</a></li></ul></li><li><input type=checkbox id=section-7177254393287994b491879262a62a06 class=toggle>
<label for=section-7177254393287994b491879262a62a06 class=flex><a role=button>实践笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/2.-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-fastapi/>深入理解 FastAPI</a></li><li><a href=/notebooks/%E5%AE%9E%E8%B7%B5%E7%AC%94%E8%AE%B0/4.-agent%E6%9C%80%E4%BD%B3%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/>Agent最佳设计模式</a></li></ul></li><li><input type=checkbox id=section-0172eb8516eeb7b4e657f3949a135c25 class=toggle>
<label for=section-0172eb8516eeb7b4e657f3949a135c25 class=flex><a role=button>机器学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC01%E7%AB%A0_%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E6%A6%82%E8%A7%88/>第01章 机器学习概览</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC02%E7%AB%A0_%E7%9F%A9%E9%98%B5%E8%BF%90%E7%AE%97%E4%B8%8E%E5%BE%AE%E7%A7%AF%E5%88%86/>第02章 矩阵运算与微积分</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC03%E7%AB%A0_svd%E4%B8%8E%E7%9F%A9%E9%98%B5%E5%88%86%E8%A7%A3/>第03章 SVD与矩阵分解</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC04%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%88%86%E5%B8%83_%E6%8C%87%E6%95%B0%E6%97%8F%E4%B8%8E%E5%85%B1%E8%BD%AD%E5%85%88%E9%AA%8C/>第04章 概率分布 指数族与共轭先验</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC05%E7%AB%A0_%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/>第05章 线性回归</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC06%E7%AB%A0_%E6%84%9F%E7%9F%A5%E6%9C%BA/>第06章 感知机</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC07%E7%AB%A0_%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E6%9C%BAsvm/>第07章 支持向量机(SVM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC08%E7%AB%A0_%E6%A0%B8%E6%96%B9%E6%B3%95/>第08章 核方法</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC09%E7%AB%A0_%E5%86%B3%E7%AD%96%E6%A0%91%E4%B8%8E%E9%9B%86%E6%88%90%E5%AD%A6%E4%B9%A0/>第09章 决策树与集成学习</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC10%E7%AB%A0_%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E4%B8%8E%E6%9C%80%E5%A4%A7%E7%86%B5%E6%A8%A1%E5%9E%8B/>第10章 逻辑回归与最大熵模型</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC11%E7%AB%A0_%E5%B9%BF%E4%B9%89%E7%BA%BF%E6%80%A7%E6%A8%A1%E5%9E%8Bglm/>第11章 广义线性模型(GLM)</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC13%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E8%A1%A8%E7%A4%BA/>第13章 概率图模型 表示</a></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC14%E7%AB%A0_%E6%A6%82%E7%8E%87%E5%9B%BE%E6%A8%A1%E5%9E%8B_%E6%8E%A8%E6%96%AD/>第14章 概率图模型 推断</a></li><li><input type=checkbox id=section-b17efd79c46843a887113a063f929150 class=toggle>
<label for=section-b17efd79c46843a887113a063f929150 class=flex><a role=button>assets</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul></ul></li><li><a href=/notebooks/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/skills/>skills</a></li></ul></li><li><input type=checkbox id=section-29762f225235d2ac19b613cc28b093c8 class=toggle>
<label for=section-29762f225235d2ac19b613cc28b093c8 class=flex><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>深度学习笔记</a>
<img src=/icons/chevron-right.svg class=book-icon alt=Expand></label><ul><li><a href=/notebooks/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%AC%AC1%E7%AB%A0_%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/>第1章 深度学习基础</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class="book-header hidden"><div class="flex align-center justify-between"><label for=menu-control><img src=/icons/menu.svg class=book-icon alt=Menu></label><h3>第八篇 Middleware 工程化</h3><label for=toc-control><img src=/icons/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class=hidden><nav id=TableOfContents><ul><li><a href=#第1章middleware-核心机制>第1章：Middleware 核心机制</a><ul><li><a href=#11-什么是-middleware>1.1 什么是 Middleware</a><ul><li><a href=#111-agent执行流程回顾>1.1.1 Agent执行流程回顾</a></li><li><a href=#112-middleware的切入点与生命周期>1.1.2 Middleware的切入点与生命周期</a></li><li><a href=#113-核心价值>1.1.3 核心价值</a></li></ul></li><li><a href=#12-创建第一个middleware>1.2 创建第一个Middleware</a><ul><li><a href=#121-方式1-使用decorator>1.2.1 方式1: 使用Decorator</a></li><li><a href=#122-方式2-继承agentmiddleware>1.2.2 方式2: 继承AgentMiddleware</a></li><li><a href=#123-实战-wrap_model_call实现缓存>1.2.3 实战: wrap_model_call实现缓存</a></li><li><a href=#124-实战-wrap_tool_call实现重试>1.2.4 实战: wrap_tool_call实现重试</a></li></ul></li><li><a href=#13-hook体系深入理解>1.3 Hook体系深入理解</a><ul><li><a href=#131-hook分类>1.3.1 Hook分类</a></li><li><a href=#132-hook签名详解>1.3.2 Hook签名详解</a></li><li><a href=#133-核心类型>1.3.3 核心类型</a></li></ul></li><li><a href=#14-jump_to-条件跳转>1.4 jump_to: 条件跳转</a><ul><li><a href=#141-什么是jump_to>1.4.1 什么是jump_to</a></li><li><a href=#142-实战-早退出middleware>1.4.2 实战: 早退出Middleware</a></li></ul></li><li><a href=#本章小结>本章小结</a></li></ul></li><li><a href=#第2章内置middleware与自定义开发>第2章：内置Middleware与自定义开发</a><ul><li><a href=#21-安全类middleware>2.1 安全类Middleware</a><ul><li><a href=#211-piimiddleware---敏感信息脱敏>2.1.1 PIIMiddleware - 敏感信息脱敏</a></li><li><a href=#212-humanintheloopmiddleware---人工审批>2.1.2 HumanInTheLoopMiddleware - 人工审批</a></li></ul></li><li><a href=#22-可靠性类middleware>2.2 可靠性类Middleware</a><ul><li><a href=#221-modelcalllimitmiddleware---防止死循环>2.2.1 ModelCallLimitMiddleware - 防止死循环</a></li><li><a href=#222-toolcalllimitmiddleware---工具调用限制>2.2.2 ToolCallLimitMiddleware - 工具调用限制</a></li><li><a href=#223-toolretrymiddleware---自动重试>2.2.3 ToolRetryMiddleware - 自动重试</a></li><li><a href=#224-modelfallbackmiddleware---模型降级>2.2.4 ModelFallbackMiddleware - 模型降级</a></li></ul></li><li><a href=#23-性能优化类middleware>2.3 性能优化类Middleware</a><ul><li><a href=#231-summarizationmiddleware---对话摘要>2.3.1 SummarizationMiddleware - 对话摘要</a></li><li><a href=#232-contexteditingmiddleware---上下文裁剪>2.3.2 ContextEditingMiddleware - 上下文裁剪</a></li></ul></li><li><a href=#24-能力增强类middleware>2.4 能力增强类Middleware</a><ul><li><a href=#241-todolistmiddleware---任务规划>2.4.1 TodoListMiddleware - 任务规划</a></li><li><a href=#242-llmtoolselectormiddleware---智能工具筛选>2.4.2 LLMToolSelectorMiddleware - 智能工具筛选</a></li><li><a href=#243-llmtoolemulator---工具模拟>2.4.3 LLMToolEmulator - 工具模拟</a></li></ul></li><li><a href=#25-自定义middleware开发>2.5 自定义Middleware开发</a><ul><li><a href=#251-开发规范>2.5.1 开发规范</a></li><li><a href=#252-实战-成本追踪middleware>2.5.2 实战: 成本追踪Middleware</a></li><li><a href=#253-实战-动态模型路由middleware>2.5.3 实战: 动态模型路由Middleware</a></li></ul></li><li><a href=#本章小结-1>本章小结</a></li></ul></li><li><a href=#第3章组合策略与生产实践>第3章：组合策略与生产实践</a><ul><li><a href=#31-middleware组合策略>3.1 Middleware组合策略</a><ul><li><a href=#311-执行顺序规则重要>3.1.1 执行顺序规则(重要!)</a></li><li><a href=#312-分层组合策略>3.1.2 分层组合策略</a></li><li><a href=#313-冲突处理>3.1.3 冲突处理</a></li></ul></li><li><a href=#32-测试策略>3.2 测试策略</a><ul><li><a href=#321-单元测试-测试单个middleware>3.2.1 单元测试: 测试单个Middleware</a></li><li><a href=#322-集成测试-测试完整agent>3.2.2 集成测试: 测试完整Agent</a></li></ul></li><li><a href=#33-生产级middleware-stack>3.3 生产级Middleware Stack</a><ul><li><a href=#331-企业级配置示例>3.3.1 企业级配置示例</a></li><li><a href=#332-环境区分配置>3.3.2 环境区分配置</a></li><li><a href=#333-feature-flags配置>3.3.3 Feature Flags配置</a></li></ul></li><li><a href=#34-性能考量与最佳实践>3.4 性能考量与最佳实践</a><ul><li><a href=#341-避免阻塞io>3.4.1 避免阻塞I/O</a></li><li><a href=#342-控制附加模型调用>3.4.2 控制附加模型调用</a></li><li><a href=#343-指标收集>3.4.3 指标收集</a></li></ul></li><li><a href=#本章小结-2>本章小结</a></li><li><a href=#本篇总结>本篇总结</a></li><li><a href=#思考与练习>思考与练习</a></li></ul></li><li><a href=#深入阅读-additional-resources>深入阅读 (Additional Resources)</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#设计模式与最佳实践>设计模式与最佳实践</a></li><li><a href=#相关技术文章>相关技术文章</a></li><li><a href=#工具与库>工具与库</a></li><li><a href=#学习路径建议>学习路径建议</a></li><li><a href=#常见问题解答>常见问题解答</a></li><li><a href=#视频教程推荐>视频教程推荐</a></li><li><a href=#持续更新>持续更新</a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=第八篇-middleware-工程化>第八篇 Middleware 工程化<a class=anchor href=#%e7%ac%ac%e5%85%ab%e7%af%87-middleware-%e5%b7%a5%e7%a8%8b%e5%8c%96>#</a></h1><blockquote class=book-hint><p><strong>目标</strong>: 掌握 LangChain Middleware 机制,实现对 Agent 行为的精准控制</p></blockquote><p>在前面的篇章中,我们学会了如何创建Agent(<code>create_agent</code>)、构建复杂工作流(<code>LangGraph</code>)、处理复杂任务(<code>Deep Agents</code>)。但这些都是"功能实现"层面,本篇进入<strong>工程化阶段</strong>:如何让Agent在生产环境中<strong>安全、可靠、可控</strong>地运行。</p><p><strong>核心问题</strong>:</p><ul><li>如何防止Agent泄露敏感信息?</li><li>如何限制Agent的调用成本?</li><li>如何在关键操作前要求人工审批?</li><li>如何在对话过长时自动摘要?</li></ul><p><strong>解决方案</strong>: <strong>Middleware</strong> - LangChain 1.0的核心机制,允许你在Agent执行的各个阶段精准干预。</p><hr><h2 id=第1章middleware-核心机制>第1章：Middleware 核心机制<a class=anchor href=#%e7%ac%ac1%e7%ab%a0middleware-%e6%a0%b8%e5%bf%83%e6%9c%ba%e5%88%b6>#</a></h2><blockquote class=book-hint><p><strong>本章目标</strong>: 理解Middleware的本质、运行原理和基本用法</p></blockquote><h3 id=11-什么是-middleware>1.1 什么是 Middleware<a class=anchor href=#11-%e4%bb%80%e4%b9%88%e6%98%af-middleware>#</a></h3><h4 id=111-agent执行流程回顾>1.1.1 Agent执行流程回顾<a class=anchor href=#111-agent%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b%e5%9b%9e%e9%a1%be>#</a></h4><p>首先回顾<code>create_agent</code>创建的Agent是如何工作的:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>calculator_tool</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;搜索最新新闻&#34;</span><span class=p>)]})</span></span></span></code></pre></div><p><strong>内部执行流程</strong>：</p><img src=./assets/image-20260122210222416.png alt=image-20260122210222416 style=zoom:50%><p><strong>问题</strong>: 这个流程是"黑盒",我们无法干预中间步骤。而 Middleware 正是解决这个问题的关键机制。</p><h4 id=112-middleware的切入点与生命周期>1.1.2 Middleware的切入点与生命周期<a class=anchor href=#112-middleware%e7%9a%84%e5%88%87%e5%85%a5%e7%82%b9%e4%b8%8e%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f>#</a></h4><p><strong>Middleware</strong>在Agent执行的关键节点提供<strong>Hook(钩子)</strong>,允许你精准干预。下图展示了 Agent Loop 与 Middleware Hooks 的交互流程,清晰呈现每个 Hook 的触发时机:</p><p><strong>Middleware Lifecycle (生命周期)</strong></p><img src=./assets/image-20260122205654033.png alt=image-20260122205654033 style=zoom:50%><p><strong>核心流程说明</strong>:</p><ol><li><strong>用户请求</strong> → <code>before_agent</code> Hook: 权限检查、输入验证、初始化</li><li><code>before_model</code> Hook → <strong>模型推理前</strong>: 修改提示词、检查 Token、条件跳转</li><li><code>wrap_model_call</code> Hook → <strong>包装模型调用</strong>: 缓存、重试、降级、成本控制</li><li><strong>模型响应</strong> → <code>after_model</code> Hook: 审核输出、记录日志、质量评分</li><li>如需工具 → <code>wrap_tool_call</code> Hook → <strong>工具执行</strong>: 重试、限流、审批、模拟执行 → 返回循环</li><li>无需工具 → <code>after_agent</code> Hook → <strong>Agent 结束</strong>: 保存结果、计费、清理资源</li></ol><p><strong>Hook 快速参考</strong></p><table><thead><tr><th>Hook 名称</th><th>类型</th><th>签名</th><th>典型用途</th></tr></thead><tbody><tr><td><code>before_agent</code></td><td>Node-Style</td><td><code>(state, runtime) -> dict|None</code></td><td>权限检查、输入验证、初始化</td></tr><tr><td><code>before_model</code></td><td>Node-Style</td><td><code>(state, runtime) -> dict|None</code></td><td>修改提示词、检查 Token、条件跳转</td></tr><tr><td><code>wrap_model_call</code></td><td>Wrap-Style</td><td><code>(request, handler) -> ModelResponse</code></td><td>缓存、重试、降级、成本控制</td></tr><tr><td><code>after_model</code></td><td>Node-Style</td><td><code>(state, runtime) -> dict|None</code></td><td>审核输出、记录日志、质量评分</td></tr><tr><td><code>wrap_tool_call</code></td><td>Wrap-Style</td><td><code>(request, handler) -> ToolMessage</code></td><td>重试、限流、审批、模拟执行</td></tr><tr><td><code>after_agent</code></td><td>Node-Style</td><td><code>(state, runtime) -> dict|None</code></td><td>保存结果、计费、清理资源</td></tr></tbody></table><blockquote class=book-hint><p><strong>类型说明</strong>:</p><ul><li><strong>Node-Style</strong>: 顺序执行,返回 <code>dict</code> 修改 state,返回 <code>None</code> 沿用原值</li><li><strong>Wrap-Style</strong>: 嵌套执行(洋葱模型),完全控制调用流程,可短路返回</li></ul></blockquote><h4 id=113-核心价值>1.1.3 核心价值<a class=anchor href=#113-%e6%a0%b8%e5%bf%83%e4%bb%b7%e5%80%bc>#</a></h4><table><thead><tr><th>维度</th><th>没有Middleware</th><th>使用Middleware</th></tr></thead><tbody><tr><td><strong>安全</strong></td><td>可能泄露PII</td><td>PIIMiddleware自动脱敏</td></tr><tr><td><strong>成本</strong></td><td>无限制调用</td><td>ModelCallLimitMiddleware限制次数</td></tr><tr><td><strong>可靠性</strong></td><td>工具失败直接报错</td><td>ToolRetryMiddleware自动重试</td></tr><tr><td><strong>可观测</strong></td><td>黑盒执行</td><td>LoggingMiddleware记录所有步骤</td></tr><tr><td><strong>合规</strong></td><td>无人工审批</td><td>HumanInTheLoopMiddleware强制审批</td></tr></tbody></table><p><strong>小节总结</strong>:</p><p>通过上面的流程图和说明,我们理解了:</p><ol><li><strong>Agent 的执行流程</strong>: 从用户输入到模型推理,再到工具调用,最后返回结果</li><li><strong>Middleware 的介入点</strong>: 在执行流程的每个关键节点(before/after/wrap)提供 Hook</li><li><strong>六大 Hook</strong>: 从 before_agent 到 after_agent,覆盖整个生命周期,分为 Node-Style 和 Wrap-Style 两类</li><li><strong>实际价值</strong>: 安全、成本、可靠性、可观测、合规等多个维度的精准控制</li></ol><p>接下来我们将先创建第一个 Middleware 上手实践,然后深入学习 Hook 体系的技术细节。</p><hr><h3 id=12-创建第一个middleware>1.2 创建第一个Middleware<a class=anchor href=#12-%e5%88%9b%e5%bb%ba%e7%ac%ac%e4%b8%80%e4%b8%aamiddleware>#</a></h3><h4 id=121-方式1-使用decorator>1.2.1 方式1: 使用Decorator<a class=anchor href=#121-%e6%96%b9%e5%bc%8f1-%e4%bd%bf%e7%94%a8decorator>#</a></h4><p><strong>最简单的方式</strong> - 使用decorator快速创建middleware:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>before_model</span><span class=p>,</span> <span class=n>after_model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_before_model</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模型调用前打印日志&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[LOG] 准备调用模型,当前消息数: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s1>&#39;messages&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>  <span class=c1># 不修改state</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@after_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log_after_model</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;模型调用后打印日志&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>last_msg</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[LOG] 模型返回: </span><span class=si>{</span><span class=n>last_msg</span><span class=o>.</span><span class=n>content</span><span class=p>[:</span><span class=mi>50</span><span class=p>]</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>log_before_model</span><span class=p>,</span> <span class=n>log_after_model</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>支持的decorators</strong>:</p><ul><li><code>@before_agent</code></li><li><code>@before_model(can_jump_to=["end"])</code> # 可指定允许跳转的目标</li><li><code>@after_model</code></li><li><code>@after_agent</code></li><li><code>@wrap_model_call</code></li><li><code>@wrap_tool_call</code></li><li><code>@dynamic_prompt</code> # 动态生成system prompt</li></ul><h4 id=122-方式2-继承agentmiddleware>1.2.2 方式2: 继承AgentMiddleware<a class=anchor href=#122-%e6%96%b9%e5%bc%8f2-%e7%bb%a7%e6%89%bfagentmiddleware>#</a></h4><p><strong>更灵活的方式</strong> - 继承<code>AgentMiddleware</code>类:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>AgentMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TokenCounterMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;统计Token使用量&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化计数器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 注意: 不能在state中添加自定义字段,因为AgentState是固定的</span>
</span></span><span class=line><span class=cl>        <span class=c1># 可以使用runtime.context存储自定义数据</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;模型调用前统计&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简单估算: 每个message约100 tokens</span>
</span></span><span class=line><span class=cl>        <span class=n>approx_tokens</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>])</span> <span class=o>*</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📊 预估输入Token: </span><span class=si>{</span><span class=n>approx_tokens</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;模型调用后统计&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 真实环境可以从response.usage中获取</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📊 模型调用完成&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>TokenCounterMiddleware</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=123-实战-wrap_model_call实现缓存>1.2.3 实战: wrap_model_call实现缓存<a class=anchor href=#123-%e5%ae%9e%e6%88%98-wrap_model_call%e5%ae%9e%e7%8e%b0%e7%bc%93%e5%ad%98>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>wrap_model_call</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 简单的内存缓存</span>
</span></span><span class=line><span class=cl><span class=n>_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@wrap_model_call</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>cache_middleware</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;缓存模型响应&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 计算缓存键(基于messages内容)</span>
</span></span><span class=line><span class=cl>    <span class=n>messages_str</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>([</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=s2>&#34;role&#34;</span><span class=p>:</span> <span class=n>m</span><span class=o>.</span><span class=n>type</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>content</span><span class=p>)}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>request</span><span class=o>.</span><span class=n>messages</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span> <span class=n>sort_keys</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>cache_key</span> <span class=o>=</span> <span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>messages_str</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 检查缓存</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=n>_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 缓存命中!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 3. 缓存未命中,调用模型</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;❌ 缓存未命中,调用模型...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 4. 保存到缓存</span>
</span></span><span class=line><span class=cl>    <span class=n>_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>  <span class=c1># 使用mini测试</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>cache_middleware</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一次调用</span>
</span></span><span class=line><span class=cl><span class=n>result1</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: ❌ 缓存未命中,调用模型...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第二次相同输入</span>
</span></span><span class=line><span class=cl><span class=n>result2</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: ✅ 缓存命中!</span></span></span></code></pre></div><h4 id=124-实战-wrap_tool_call实现重试>1.2.4 实战: wrap_tool_call实现重试<a class=anchor href=#124-%e5%ae%9e%e6%88%98-wrap_tool_call%e5%ae%9e%e7%8e%b0%e9%87%8d%e8%af%95>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>wrap_tool_call</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>ToolMessage</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@wrap_tool_call</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>retry_on_error</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工具调用失败时重试3次&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span> <span class=o>=</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;✅ 工具调用成功 (尝试 </span><span class=si>{</span><span class=n>attempt</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;❌ 工具调用失败 (尝试 </span><span class=si>{</span><span class=n>attempt</span> <span class=o>+</span> <span class=mi>1</span><span class=si>}</span><span class=s2>): </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>attempt</span> <span class=o>==</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 最后一次仍失败,返回错误消息</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>ToolMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>content</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具调用失败(重试</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>次): </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>tool_call_id</span><span class=o>=</span><span class=n>request</span><span class=o>.</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;id&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 指数退避</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=13-hook体系深入理解>1.3 Hook体系深入理解<a class=anchor href=#13-hook%e4%bd%93%e7%b3%bb%e6%b7%b1%e5%85%a5%e7%90%86%e8%a7%a3>#</a></h3><h4 id=131-hook分类>1.3.1 Hook分类<a class=anchor href=#131-hook%e5%88%86%e7%b1%bb>#</a></h4><p>LangChain Middleware提供<strong>6个Hook</strong>,分为两类:</p><p><strong>Node-Style Hooks</strong> (节点型):</p><ul><li>顺序执行</li><li>返回<code>dict</code>修改state,返回<code>None</code>沿用原值</li><li>Hooks: <code>before_agent</code>, <code>before_model</code>, <code>after_model</code>, <code>after_agent</code></li></ul><p><strong>Wrap-Style Hooks</strong> (包装型):</p><ul><li>嵌套执行(洋葱模型)</li><li>完全控制调用流程,可短路返回</li><li>Hooks: <code>wrap_model_call</code>, <code>wrap_tool_call</code></li></ul><h4 id=132-hook签名详解>1.3.2 Hook签名详解<a class=anchor href=#132-hook%e7%ad%be%e5%90%8d%e8%af%a6%e8%a7%a3>#</a></h4><p><strong>Node-Style Hook签名</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>before_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span><span class=p>,</span>      <span class=c1># 当前状态</span>
</span></span><span class=line><span class=cl>    <span class=n>runtime</span><span class=p>:</span> <span class=n>Runtime</span>        <span class=c1># 运行时上下文</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Agent执行前的Hook
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        dict: 返回字典会merge到state
</span></span></span><span class=line><span class=cl><span class=s2>        None: 沿用原state
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></div><p><strong>Wrap-Style Hook签名</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>wrap_model_call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span><span class=p>:</span> <span class=n>ModelRequest</span><span class=p>,</span>         <span class=c1># 模型请求</span>
</span></span><span class=line><span class=cl>    <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>[[</span><span class=n>ModelRequest</span><span class=p>],</span> <span class=n>ModelResponse</span><span class=p>]</span>  <span class=c1># 执行器</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelResponse</span> <span class=o>|</span> <span class=n>AIMessage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    包装模型调用
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Args:
</span></span></span><span class=line><span class=cl><span class=s2>        request: 包含model, messages, tools等的请求对象
</span></span></span><span class=line><span class=cl><span class=s2>        handler: 实际执行模型调用的函数
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        ModelResponse 或 AIMessage
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 可以修改request</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>override</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>different_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调用实际模型(可多次调用/不调用)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 可以修改response</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span></span></span></code></pre></div><h4 id=133-核心类型>1.3.3 核心类型<a class=anchor href=#133-%e6%a0%b8%e5%bf%83%e7%b1%bb%e5%9e%8b>#</a></h4><p><strong>1. AgentState</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>AgentState</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AgentState</span><span class=p>(</span><span class=n>TypedDict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=n>Required</span><span class=p>[</span><span class=n>Annotated</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=n>AnyMessage</span><span class=p>],</span> <span class=n>add_messages</span><span class=p>]]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 必需字段,消息列表(使用add_messages reducer)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>jump_to</span><span class=p>:</span> <span class=n>NotRequired</span><span class=p>[</span><span class=n>JumpTo</span> <span class=o>|</span> <span class=kc>None</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 可选,跳转目标: &#34;tools&#34; | &#34;model&#34; | &#34;end&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>structured_response</span><span class=p>:</span> <span class=n>NotRequired</span><span class=p>[</span><span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># 可选,结构化输出</span></span></span></code></pre></div><p><strong>2. Runtime[ContextT]</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Runtime来自langgraph.runtime</span>
</span></span><span class=line><span class=cl><span class=c1># 包含运行时上下文和工具</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>runtime</span><span class=o>.</span><span class=n>context</span>  <span class=c1># 用户自定义上下文(如user_id, tenant等)</span>
</span></span><span class=line><span class=cl><span class=n>runtime</span><span class=o>.</span><span class=n>store</span>    <span class=c1># BaseStore实例,持久化存储</span></span></span></code></pre></div><p><strong>3. ModelRequest</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=n>BaseChatModel</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>AnyMessage</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_choice</span><span class=p>:</span> <span class=n>Any</span> <span class=o>|</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>BaseTool</span> <span class=o>|</span> <span class=nb>dict</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>response_format</span><span class=p>:</span> <span class=n>ResponseFormat</span> <span class=o>|</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>:</span> <span class=n>AgentState</span>              <span class=c1># 当前状态</span>
</span></span><span class=line><span class=cl>    <span class=n>runtime</span><span class=p>:</span> <span class=n>Runtime</span><span class=p>[</span><span class=n>ContextT</span><span class=p>]</span>     <span class=c1># 运行时上下文</span>
</span></span><span class=line><span class=cl>    <span class=n>model_settings</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>override</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>**</span><span class=n>overrides</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ModelRequest</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;不可变替换,返回新的ModelRequest&#34;&#34;&#34;</span></span></span></code></pre></div><p><strong>4. ModelResponse</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ModelResponse</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>BaseMessage</span><span class=p>]</span>       <span class=c1># 通常包含1个AIMessage</span>
</span></span><span class=line><span class=cl>    <span class=n>structured_response</span><span class=p>:</span> <span class=n>Any</span> <span class=o>=</span> <span class=kc>None</span> <span class=c1># 结构化输出(如果指定)</span></span></span></code></pre></div><hr><h3 id=14-jump_to-条件跳转>1.4 jump_to: 条件跳转<a class=anchor href=#14-jump_to-%e6%9d%a1%e4%bb%b6%e8%b7%b3%e8%bd%ac>#</a></h3><h4 id=141-什么是jump_to>1.4.1 什么是jump_to<a class=anchor href=#141-%e4%bb%80%e4%b9%88%e6%98%afjump_to>#</a></h4><p>在<code>before_model</code>或<code>after_model</code> hook中,可以返回<code>{"jump_to": "end"}</code>来提前结束Agent执行:</p><p><strong>允许的跳转目标</strong>:</p><ul><li><code>"end"</code>: 结束Agent执行</li><li><code>"tools"</code>: 跳到工具执行节点</li><li><code>"model"</code>: 跳回模型节点(重新调用模型)</li></ul><p><strong>使用场景</strong>:</p><ul><li>检测到"再见"等结束词,直接结束对话</li><li>检测到特定条件,跳过模型调用</li><li>实现自定义的路由逻辑</li></ul><h4 id=142-实战-早退出middleware>1.4.2 实战: 早退出Middleware<a class=anchor href=#142-%e5%ae%9e%e6%88%98-%e6%97%a9%e9%80%80%e5%87%bamiddleware>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>before_model</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>AIMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@before_model</span><span class=p>(</span><span class=n>can_jump_to</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;end&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>early_exit_on_goodbye</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;检测到&#39;再见&#39;直接结束&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 获取最后一条用户消息</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>messages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>last_msg</span> <span class=o>=</span> <span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>last_msg</span><span class=p>,</span> <span class=s2>&#34;content&#34;</span><span class=p>)</span> <span class=ow>and</span> <span class=s2>&#34;再见&#34;</span> <span class=ow>in</span> <span class=n>last_msg</span><span class=o>.</span><span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🚪 检测到&#39;再见&#39;,直接结束对话&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 添加一条AI消息,然后跳转到end</span>
</span></span><span class=line><span class=cl>        <span class=n>new_messages</span> <span class=o>=</span> <span class=n>messages</span> <span class=o>+</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;再见!很高兴为您服务。&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>new_messages</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;jump_to&#34;</span><span class=p>:</span> <span class=s2>&#34;end&#34;</span>  <span class=c1># 跳转到结束节点</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>early_exit_on_goodbye</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;再见&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: 🚪 检测到&#39;再见&#39;,直接结束对话</span>
</span></span><span class=line><span class=cl><span class=c1># 不会调用模型,直接返回预设的回复</span></span></span></code></pre></div><p><strong>注意</strong>: 必须使用<code>@before_model(can_jump_to=["end"])</code>声明允许的跳转目标,否则会报错。</p><hr><h3 id=本章小结>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93>#</a></h3><ol><li><strong>Middleware是什么</strong>: Agent执行流程中的Hook点,允许精准干预</li><li><strong>六大Hook</strong>:<ul><li>Node-Style: <code>before_agent</code>, <code>before_model</code>, <code>after_model</code>, <code>after_agent</code></li><li>Wrap-Style: <code>wrap_model_call</code>, <code>wrap_tool_call</code></li></ul></li><li><strong>核心类型</strong>: <code>AgentState</code>, <code>Runtime</code>, <code>ModelRequest</code>, <code>ModelResponse</code></li><li><strong>创建方式</strong>: Decorator(快速) vs 继承AgentMiddleware(灵活)</li><li><strong>执行顺序</strong>: before顺序, wrap嵌套(洋葱), after逆序</li><li><strong>jump_to</strong>: 条件跳转,提前结束或路由</li></ol><p><strong>下一章预告</strong>: 学习LangChain提供的所有内置Middleware,以及如何自定义开发。</p><hr><p>(第1章完成,字数约4500字)</p><p>&lt;待续&mldr;></p><h2 id=第2章内置middleware与自定义开发>第2章：内置Middleware与自定义开发<a class=anchor href=#%e7%ac%ac2%e7%ab%a0%e5%86%85%e7%bd%aemiddleware%e4%b8%8e%e8%87%aa%e5%ae%9a%e4%b9%89%e5%bc%80%e5%8f%91>#</a></h2><blockquote class=book-hint><p><strong>本章目标</strong>: 掌握所有内置Middleware的使用,以及自定义开发方法</p></blockquote><p>LangChain提供了11个内置Middleware,覆盖安全、可靠性、性能等场景。本章按功能分类讲解。</p><p><strong>内置 Middleware 总览表</strong>:</p><table><thead><tr><th>类别</th><th>Middleware 名称</th><th>核心功能</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>安全</strong></td><td><code>PIIMiddleware</code></td><td>敏感信息检测与脱敏</td><td>保护邮箱、手机号、信用卡等隐私</td></tr><tr><td></td><td><code>HumanInTheLoopMiddleware</code></td><td>人工介入审批</td><td>敏感操作(支付、删除)需人工确认</td></tr><tr><td><strong>可靠性</strong></td><td><code>ModelCallLimitMiddleware</code></td><td>限制模型调用次数</td><td>防止死循环、控制成本</td></tr><tr><td></td><td><code>ToolCallLimitMiddleware</code></td><td>限制工具调用次数</td><td>防止单一工具过度调用</td></tr><tr><td></td><td><code>ToolRetryMiddleware</code></td><td>失败自动重试</td><td>处理网络波动、临时故障</td></tr><tr><td></td><td><code>ModelFallbackMiddleware</code></td><td>模型降级</td><td>主模型挂掉时切换备用模型</td></tr><tr><td><strong>性能</strong></td><td><code>SummarizationMiddleware</code></td><td>自动对话摘要</td><td>避免 Context Window 超限</td></tr><tr><td></td><td><code>ContextEditingMiddleware</code></td><td>上下文裁剪</td><td>清理不需要的历史信息</td></tr><tr><td><strong>增强</strong></td><td><code>TodoListMiddleware</code></td><td>任务规划与追踪</td><td>为 Agent 增加长任务管理能力</td></tr><tr><td></td><td><code>LLMToolSelectorMiddleware</code></td><td>智能工具筛选</td><td>解决工具过多(50+)导致模型困惑的问题</td></tr><tr><td></td><td><code>LLMToolEmulator</code></td><td>工具模拟</td><td>测试/开发阶段模拟昂贵工具</td></tr></tbody></table><h3 id=21-安全类middleware>2.1 安全类Middleware<a class=anchor href=#21-%e5%ae%89%e5%85%a8%e7%b1%bbmiddleware>#</a></h3><h4 id=211-piimiddleware---敏感信息脱敏>2.1.1 PIIMiddleware - 敏感信息脱敏<a class=anchor href=#211-piimiddleware---%e6%95%8f%e6%84%9f%e4%bf%a1%e6%81%af%e8%84%b1%e6%95%8f>#</a></h4><p><strong>场景</strong>: 防止Agent在输入/输出中泄露个人信息(邮箱、信用卡号、IP地址等)</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>PIIMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PIIMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>pii_type</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>,</span> <span class=s1>&#39;credit_card&#39;</span><span class=p>,</span> <span class=s1>&#39;ip&#39;</span><span class=p>,</span> <span class=s1>&#39;mac_address&#39;</span><span class=p>,</span> <span class=s1>&#39;url&#39;</span><span class=p>],</span>  <span class=c1># PII类型</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>strategy</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;block&#39;</span><span class=p>,</span> <span class=s1>&#39;redact&#39;</span><span class=p>,</span> <span class=s1>&#39;mask&#39;</span><span class=p>,</span> <span class=s1>&#39;hash&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;redact&#39;</span><span class=p>,</span>  <span class=c1># 处理策略</span>
</span></span><span class=line><span class=cl>    <span class=n>detector</span><span class=p>:</span> <span class=n>Callable</span> <span class=o>|</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>    <span class=c1># 自定义检测器</span>
</span></span><span class=line><span class=cl>    <span class=n>apply_to_input</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>              <span class=c1># 应用到用户输入</span>
</span></span><span class=line><span class=cl>    <span class=n>apply_to_output</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>            <span class=c1># 应用到AI输出</span>
</span></span><span class=line><span class=cl>    <span class=n>apply_to_tool_results</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span>       <span class=c1># 应用到工具结果</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>策略说明</strong>:</p><ul><li><code>block</code>: 直接拒绝包含PII的请求</li><li><code>redact</code>: 替换为<code>[REDACTED_EMAIL]</code>等</li><li><code>mask</code>: 部分遮蔽 (如<code>a***e@example.com</code>)</li><li><code>hash</code>: SHA-256哈希</li></ul><p><strong>示例1: 脱敏用户输入中的邮箱</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>PIIMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;email&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>apply_to_input</span><span class=o>=</span><span class=kc>True</span>  <span class=c1># 检测输入</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;我的邮箱是 alice@example.com&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实际发送给模型的消息:</span>
</span></span><span class=line><span class=cl><span class=c1># &#34;我的邮箱是 [REDACTED_EMAIL]&#34;</span></span></span></code></pre></div><p><strong>示例2: 检测多种PII类型</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 每个PIIMiddleware只能检测一种类型</span>
</span></span><span class=line><span class=cl><span class=c1># 需要多个实例来检测多种PII</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;mask&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;ip&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;hash&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例3: block策略 - 直接拒绝</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;block&#34;</span>  <span class=c1># 检测到信用卡号直接拒绝</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输入包含信用卡号会直接抛异常</span>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;我的卡号是 4532-1234-5678-9010&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;被拦截: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span></span></span></code></pre></div><h4 id=212-humanintheloopmiddleware---人工审批>2.1.2 HumanInTheLoopMiddleware - 人工审批<a class=anchor href=#212-humanintheloopmiddleware---%e4%ba%ba%e5%b7%a5%e5%ae%a1%e6%89%b9>#</a></h4><p><strong>场景</strong>: 关键操作(如发送邮件、删除数据)需要人工确认</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>HumanInTheLoopMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>HumanInTheLoopMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>interrupt_on</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bool</span> <span class=o>|</span> <span class=n>InterruptOnConfig</span><span class=p>],</span>  <span class=c1># 中断配置</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>description_prefix</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;Tool execution requires approval&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>interrupt_on配置</strong>:</p><ul><li><code>"tool_start": True</code> - 工具调用前中断</li><li><code>"tool_end": True</code> - 工具调用后中断</li></ul><p><strong>示例: 工具调用前要求审批</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>HumanInTheLoopMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.memory</span> <span class=kn>import</span> <span class=n>MemorySaver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注意: HumanInTheLoopMiddleware需要配合Checkpointer使用</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>MemorySaver</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>send_email_tool</span><span class=p>,</span> <span class=n>search_tool</span><span class=p>],</span>  <span class=c1># 假设有这两个工具</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>HumanInTheLoopMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>interrupt_on</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;tool_start&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第一次调用:会在工具调用前中断</span>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;thread_id&#34;</span><span class=p>:</span> <span class=s2>&#34;thread-001&#34;</span><span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;发送邮件给alice@example.com&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=n>config</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 此时Agent中断,等待审批</span>
</span></span><span class=line><span class=cl><span class=c1># 需要人工检查,然后恢复执行:</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.types</span> <span class=kn>import</span> <span class=n>Command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批准执行</span>
</span></span><span class=line><span class=cl><span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>Command</span><span class=p>(</span><span class=n>resume</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或拒绝执行</span>
</span></span><span class=line><span class=cl><span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>Command</span><span class=p>(</span><span class=n>resume</span><span class=o>=</span><span class=kc>False</span><span class=p>),</span> <span class=n>config</span><span class=o>=</span><span class=n>config</span><span class=p>)</span></span></span></code></pre></div><hr><h3 id=22-可靠性类middleware>2.2 可靠性类Middleware<a class=anchor href=#22-%e5%8f%af%e9%9d%a0%e6%80%a7%e7%b1%bbmiddleware>#</a></h3><h4 id=221-modelcalllimitmiddleware---防止死循环>2.2.1 ModelCallLimitMiddleware - 防止死循环<a class=anchor href=#221-modelcalllimitmiddleware---%e9%98%b2%e6%ad%a2%e6%ad%bb%e5%be%aa%e7%8e%af>#</a></h4><p><strong>场景</strong>: 限制模型调用次数,防止无限循环、控制成本</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ModelCallLimitMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ModelCallLimitMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>thread_limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># 单个thread总限制</span>
</span></span><span class=line><span class=cl>    <span class=n>run_limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>     <span class=c1># 单次run限制</span>
</span></span><span class=line><span class=cl>    <span class=n>exit_behavior</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;end&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;end&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>exit_behavior</strong>:</p><ul><li><code>'end'</code>: 优雅结束,返回当前状态</li><li><code>'error'</code>: 抛出异常</li></ul><p><strong>示例: 限制单次调用最多10次模型</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ModelCallLimitMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>ModelCallLimitMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>run_limit</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span>             <span class=c1># 单次最多10次</span>
</span></span><span class=line><span class=cl>            <span class=n>exit_behavior</span><span class=o>=</span><span class=s2>&#34;end&#34;</span>       <span class=c1># 超限后优雅结束</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 如果Agent陷入循环,到第10次会自动停止</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;帮我循环搜索100次新闻&#34;</span><span class=p>)]})</span></span></span></code></pre></div><h4 id=222-toolcalllimitmiddleware---工具调用限制>2.2.2 ToolCallLimitMiddleware - 工具调用限制<a class=anchor href=#222-toolcalllimitmiddleware---%e5%b7%a5%e5%85%b7%e8%b0%83%e7%94%a8%e9%99%90%e5%88%b6>#</a></h4><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ToolCallLimitMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ToolCallLimitMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>     <span class=c1># 指定工具名(None=所有工具)</span>
</span></span><span class=line><span class=cl>    <span class=n>thread_limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>run_limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>exit_behavior</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;continue&#39;</span><span class=p>,</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;end&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;continue&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>exit_behavior</strong>:</p><ul><li><code>'continue'</code>: 继续执行但不再调用工具</li><li><code>'error'</code>: 抛出异常</li><li><code>'end'</code>: 结束执行</li></ul><p><strong>示例: 限制昂贵API的调用次数</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ToolCallLimitMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>expensive_api_tool</span><span class=p>,</span> <span class=n>search_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=c1># 限制expensive_api_tool单次最多调用3次</span>
</span></span><span class=line><span class=cl>        <span class=n>ToolCallLimitMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>tool_name</span><span class=o>=</span><span class=s2>&#34;expensive_api&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>run_limit</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>exit_behavior</span><span class=o>=</span><span class=s2>&#34;continue&#34;</span>  <span class=c1># 超限后继续,但不再调用此工具</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=223-toolretrymiddleware---自动重试>2.2.3 ToolRetryMiddleware - 自动重试<a class=anchor href=#223-toolretrymiddleware---%e8%87%aa%e5%8a%a8%e9%87%8d%e8%af%95>#</a></h4><p><strong>场景</strong>: 工具调用失败时自动重试(网络抖动、临时故障)</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ToolRetryMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ToolRetryMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2</span><span class=p>,</span>                    <span class=c1># 最多重试2次</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>BaseTool</span> <span class=o>|</span> <span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># 指定工具(None=所有)</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_on</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>type</span><span class=p>[</span><span class=ne>Exception</span><span class=p>],</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=ne>Exception</span><span class=p>,),</span>  <span class=c1># 重试的异常类型</span>
</span></span><span class=line><span class=cl>    <span class=n>on_failure</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;raise&#39;</span><span class=p>,</span> <span class=s1>&#39;return_message&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;return_message&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>backoff_factor</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>2.0</span><span class=p>,</span>             <span class=c1># 指数退避因子</span>
</span></span><span class=line><span class=cl>    <span class=n>initial_delay</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>1.0</span><span class=p>,</span>              <span class=c1># 初始延迟(秒)</span>
</span></span><span class=line><span class=cl>    <span class=n>max_delay</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>60.0</span><span class=p>,</span>                 <span class=c1># 最大延迟(秒)</span>
</span></span><span class=line><span class=cl>    <span class=n>jitter</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>                      <span class=c1># 随机抖动</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>重试延迟计算</strong>: <code>min(initial_delay * (backoff_factor ^ retry_count), max_delay) + jitter</code></p><p><strong>示例: 网络请求工具自动重试</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ToolRetryMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>api_call_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>ToolRetryMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>          <span class=c1># 最多重试3次</span>
</span></span><span class=line><span class=cl>            <span class=n>initial_delay</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>      <span class=c1># 第1次重试等1秒</span>
</span></span><span class=line><span class=cl>            <span class=n>backoff_factor</span><span class=o>=</span><span class=mf>2.0</span><span class=p>,</span>     <span class=c1># 第2次等2秒,第3次等4秒</span>
</span></span><span class=line><span class=cl>            <span class=n>jitter</span><span class=o>=</span><span class=kc>True</span>            <span class=c1># 添加随机抖动避免雷鸣羊群</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 如果api_call_tool失败,会自动重试3次</span>
</span></span><span class=line><span class=cl><span class=c1># 延迟: 1s → 2s → 4s (加上随机抖动)</span></span></span></code></pre></div><h4 id=224-modelfallbackmiddleware---模型降级>2.2.4 ModelFallbackMiddleware - 模型降级<a class=anchor href=#224-modelfallbackmiddleware---%e6%a8%a1%e5%9e%8b%e9%99%8d%e7%ba%a7>#</a></h4><p><strong>场景</strong>: 主模型失败时自动切换到备用模型</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ModelFallbackMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ModelFallbackMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>fallback_models</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=n>BaseChatModel</span><span class=p>],</span>  <span class=c1># 降级模型列表</span>
</span></span><span class=line><span class=cl>    <span class=n>retry_on</span><span class=p>:</span> <span class=nb>tuple</span><span class=p>[</span><span class=nb>type</span><span class=p>[</span><span class=ne>Exception</span><span class=p>],</span> <span class=o>...</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=ne>Exception</span><span class=p>,)</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例: GPT-4o失败时降级到GPT-4o-mini</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ModelFallbackMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>),</span>  <span class=c1># 主模型</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>ModelFallbackMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_models</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>  <span class=c1># 第1个备用</span>
</span></span><span class=line><span class=cl>                <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-3.5-turbo&#34;</span><span class=p>)</span>  <span class=c1># 第2个备用</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 如果gpt-4o调用失败,会依次尝试gpt-4o-mini和gpt-3.5-turbo</span></span></span></code></pre></div><hr><h3 id=23-性能优化类middleware>2.3 性能优化类Middleware<a class=anchor href=#23-%e6%80%a7%e8%83%bd%e4%bc%98%e5%8c%96%e7%b1%bbmiddleware>#</a></h3><h4 id=231-summarizationmiddleware---对话摘要>2.3.1 SummarizationMiddleware - 对话摘要<a class=anchor href=#231-summarizationmiddleware---%e5%af%b9%e8%af%9d%e6%91%98%e8%a6%81>#</a></h4><p><strong>场景</strong>: 长对话导致Token超限,自动摘要旧消息</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>SummarizationMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SummarizationMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=n>BaseChatModel</span><span class=p>,</span>                    <span class=c1># 用于摘要的模型</span>
</span></span><span class=line><span class=cl>    <span class=n>max_tokens_before_summary</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># Token阈值</span>
</span></span><span class=line><span class=cl>    <span class=n>messages_to_keep</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span>                    <span class=c1># 保留最近N条消息</span>
</span></span><span class=line><span class=cl>    <span class=n>token_counter</span><span class=p>:</span> <span class=n>Callable</span> <span class=o>=</span> <span class=n>count_tokens_approximately</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>summary_prompt</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&lt;默认提示词&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>summary_prefix</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;## Previous conversation summary:&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例: 超过2000 tokens时摘要</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>SummarizationMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>model</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>SummarizationMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>  <span class=c1># 用便宜的模型摘要</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens_before_summary</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span>        <span class=c1># 超过2000 tokens触发</span>
</span></span><span class=line><span class=cl>            <span class=n>messages_to_keep</span><span class=o>=</span><span class=mi>6</span><span class=p>,</span>                    <span class=c1># 保留最近6条</span>
</span></span><span class=line><span class=cl>            <span class=n>summary_prefix</span><span class=o>=</span><span class=s2>&#34;## 对话历史摘要:&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当对话超过2000 tokens时:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 保留最近6条消息</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 其余消息用gpt-4o-mini摘要</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 摘要作为SystemMessage插入到开头</span></span></span></code></pre></div><h4 id=232-contexteditingmiddleware---上下文裁剪>2.3.2 ContextEditingMiddleware - 上下文裁剪<a class=anchor href=#232-contexteditingmiddleware---%e4%b8%8a%e4%b8%8b%e6%96%87%e8%a3%81%e5%89%aa>#</a></h4><p><strong>场景</strong>: 自动清理工具调用历史,减少Token消耗</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ContextEditingMiddleware</span><span class=p>,</span> <span class=n>ClearToolUsesEdit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ContextEditingMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>edits</span><span class=p>:</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>ContextEdit</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>token_count_method</span><span class=p>:</span> <span class=n>Literal</span><span class=p>[</span><span class=s1>&#39;approximate&#39;</span><span class=p>,</span> <span class=s1>&#39;model&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;approximate&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例: 超过阈值时清理工具调用</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ContextEditingMiddleware</span><span class=p>,</span> <span class=n>ClearToolUsesEdit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>calculator_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>ContextEditingMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>edits</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>ClearToolUsesEdit</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>trigger</span><span class=o>=</span><span class=p>(</span><span class=s2>&#34;tokens&#34;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>)</span>  <span class=c1># 超过1000 tokens时触发</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 当消息中的ToolMessage过多时,会自动清理</span>
</span></span><span class=line><span class=cl><span class=c1># 保留ToolCall但移除ToolMessage的content</span></span></span></code></pre></div><hr><h3 id=24-能力增强类middleware>2.4 能力增强类Middleware<a class=anchor href=#24-%e8%83%bd%e5%8a%9b%e5%a2%9e%e5%bc%ba%e7%b1%bbmiddleware>#</a></h3><h4 id=241-todolistmiddleware---任务规划>2.4.1 TodoListMiddleware - 任务规划<a class=anchor href=#241-todolistmiddleware---%e4%bb%bb%e5%8a%a1%e8%a7%84%e5%88%92>#</a></h4><p><strong>功能</strong>: 为Agent添加<code>write_todos</code>工具,支持任务分解和进度追踪</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>TodoListMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TodoListMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&lt;默认提示词&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tool_description</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;&lt;默认描述&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>TodoListMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>write_file_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>TodoListMiddleware</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Agent现在可以使用write_todos工具来规划任务</span>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;研究AI的最新进展并写成报告&#34;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Agent会自动创建todo list:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 搜索AI最新论文</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 总结关键发现</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 撰写报告</span>
</span></span><span class=line><span class=cl><span class=c1># 4. 保存到文件</span></span></span></code></pre></div><h4 id=242-llmtoolselectormiddleware---智能工具筛选>2.4.2 LLMToolSelectorMiddleware - 智能工具筛选<a class=anchor href=#242-llmtoolselectormiddleware---%e6%99%ba%e8%83%bd%e5%b7%a5%e5%85%b7%e7%ad%9b%e9%80%89>#</a></h4><p><strong>场景</strong>: 工具太多(50+)导致模型混乱,动态筛选相关工具</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>LLMToolSelectorMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LLMToolSelectorMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=n>BaseChatModel</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># 筛选模型(None=主模型)</span>
</span></span><span class=line><span class=cl>    <span class=n>system_prompt</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;Your goal is to select the most relevant tools...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_tools</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>              <span class=c1># 最多选N个工具</span>
</span></span><span class=line><span class=cl>    <span class=n>always_include</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>    <span class=c1># 始终包含的工具</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例: 从50个工具中筛选5个</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>LLMToolSelectorMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 假设有50个工具</span>
</span></span><span class=line><span class=cl><span class=n>all_tools</span> <span class=o>=</span> <span class=p>[</span><span class=n>tool1</span><span class=p>,</span> <span class=n>tool2</span><span class=p>,</span> <span class=o>...</span><span class=p>,</span> <span class=n>tool50</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>all_tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>LLMToolSelectorMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>    <span class=c1># 用便宜模型筛选</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tools</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>            <span class=c1># 最多选5个</span>
</span></span><span class=line><span class=cl>            <span class=n>always_include</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;search&#34;</span><span class=p>]</span>  <span class=c1># search工具始终包含</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Agent在调用前会先用LLM筛选出最相关的5个工具</span></span></span></code></pre></div><h4 id=243-llmtoolemulator---工具模拟>2.4.3 LLMToolEmulator - 工具模拟<a class=anchor href=#243-llmtoolemulator---%e5%b7%a5%e5%85%b7%e6%a8%a1%e6%8b%9f>#</a></h4><p><strong>场景</strong>: 测试时模拟工具执行,不实际调用外部API</p><p><strong>API</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>LLMToolEmulator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LLMToolEmulator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span> <span class=o>|</span> <span class=n>BaseTool</span><span class=p>]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>  <span class=c1># 要模拟的工具(None=所有)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=n>BaseChatModel</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>示例: 模拟昂贵的API调用</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>LLMToolEmulator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>expensive_api_tool</span><span class=p>,</span> <span class=n>local_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>LLMToolEmulator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;expensive_api&#34;</span><span class=p>],</span>  <span class=c1># 只模拟这个工具</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># expensive_api_tool不会实际调用,由LLM模拟返回结果</span>
</span></span><span class=line><span class=cl><span class=c1># local_tool正常执行</span></span></span></code></pre></div><hr><h3 id=25-自定义middleware开发>2.5 自定义Middleware开发<a class=anchor href=#25-%e8%87%aa%e5%ae%9a%e4%b9%89middleware%e5%bc%80%e5%8f%91>#</a></h3><h4 id=251-开发规范>2.5.1 开发规范<a class=anchor href=#251-%e5%bc%80%e5%8f%91%e8%a7%84%e8%8c%83>#</a></h4><p><strong>最佳实践</strong>:</p><ol><li><strong>继承AgentMiddleware</strong>: 覆盖需要的Hook</li><li><strong>返回值规则</strong>:<ul><li>Node-Style: 返回<code>dict</code>修改state,<code>None</code>沿用原值</li><li>Wrap-Style: 必须返回<code>ModelResponse</code>或<code>ToolMessage</code></li></ul></li><li><strong>避免阻塞I/O</strong>: 不要在Hook中做同步数据库查询</li><li><strong>幂等设计</strong>: 避免重复执行产生副作用</li></ol><h4 id=252-实战-成本追踪middleware>2.5.2 实战: 成本追踪Middleware<a class=anchor href=#252-%e5%ae%9e%e6%88%98-%e6%88%90%e6%9c%ac%e8%bf%bd%e8%b8%aamiddleware>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>AgentMiddleware</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CostTrackingMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;追踪模型调用成本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 价格(美元/1K tokens)</span>
</span></span><span class=line><span class=cl>    <span class=n>PRICING</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gpt-4o&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.005</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.015</span><span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;input&#34;</span><span class=p>:</span> <span class=mf>0.00015</span><span class=p>,</span> <span class=s2>&#34;output&#34;</span><span class=p>:</span> <span class=mf>0.0006</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_cost</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>call_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;模型调用后计算成本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>call_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 简化: 估算token数(实际应从response.usage获取)</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>input_tokens</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>content</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>())</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>messages</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=o>*</span> <span class=mf>1.3</span>
</span></span><span class=line><span class=cl>        <span class=n>output_tokens</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>)</span><span class=o>.</span><span class=n>split</span><span class=p>())</span> <span class=o>*</span> <span class=mf>1.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 从runtime.context获取模型名称</span>
</span></span><span class=line><span class=cl>        <span class=n>model_name</span> <span class=o>=</span> <span class=s2>&#34;gpt-4o-mini&#34;</span>  <span class=c1># 简化,实际应从request获取</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 计算成本</span>
</span></span><span class=line><span class=cl>        <span class=n>pricing</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>PRICING</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>model_name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>PRICING</span><span class=p>[</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=n>cost</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>input_tokens</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;input&#34;</span><span class=p>]</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>            <span class=n>output_tokens</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>*</span> <span class=n>pricing</span><span class=p>[</span><span class=s2>&#34;output&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>total_cost</span> <span class=o>+=</span> <span class=n>cost</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;💰 本次调用: $</span><span class=si>{</span><span class=n>cost</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>, 累计: $</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>total_cost</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Agent结束后输出总成本&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;📊 总计: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>call_count</span><span class=si>}</span><span class=s2>次调用, 成本$</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>total_cost</span><span class=si>:</span><span class=s2>.4f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>cost_tracker</span> <span class=o>=</span> <span class=n>CostTrackingMiddleware</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>cost_tracker</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;讲个笑话&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出:</span>
</span></span><span class=line><span class=cl><span class=c1># 💰 本次调用: $0.000123, 累计: $0.000123</span>
</span></span><span class=line><span class=cl><span class=c1># 📊 总计: 1次调用, 成本$0.0001</span></span></span></code></pre></div><h4 id=253-实战-动态模型路由middleware>2.5.3 实战: 动态模型路由Middleware<a class=anchor href=#253-%e5%ae%9e%e6%88%98-%e5%8a%a8%e6%80%81%e6%a8%a1%e5%9e%8b%e8%b7%af%e7%94%b1middleware>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>AgentMiddleware</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DynamicModelRouter</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;根据任务复杂度选择模型&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fast_model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>smart_model</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrap_model_call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;模型调用前路由&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 分析任务复杂度</span>
</span></span><span class=line><span class=cl>        <span class=n>last_msg</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>messages</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span> <span class=k>if</span> <span class=n>request</span><span class=o>.</span><span class=n>messages</span> <span class=k>else</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 简单规则: 长文本或包含&#34;复杂&#34;关键词用高级模型</span>
</span></span><span class=line><span class=cl>        <span class=n>is_complex</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>len</span><span class=p>(</span><span class=n>last_msg</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>500</span> <span class=ow>or</span>
</span></span><span class=line><span class=cl>            <span class=nb>any</span><span class=p>(</span><span class=n>kw</span> <span class=ow>in</span> <span class=n>last_msg</span> <span class=k>for</span> <span class=n>kw</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&#34;复杂&#34;</span><span class=p>,</span> <span class=s2>&#34;详细&#34;</span><span class=p>,</span> <span class=s2>&#34;深入&#34;</span><span class=p>,</span> <span class=s2>&#34;分析&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 路由到不同模型</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>is_complex</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;🧠 使用高级模型(gpt-4o)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>override</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>smart_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;⚡ 使用快速模型(gpt-4o-mini)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>request</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>override</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>fast_model</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>  <span class=c1># 默认模型(会被middleware覆盖)</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>DynamicModelRouter</span><span class=p>()]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 简单问题 → gpt-4o-mini</span>
</span></span><span class=line><span class=cl><span class=n>result1</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: ⚡ 使用快速模型(gpt-4o-mini)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复杂问题 → gpt-4o</span>
</span></span><span class=line><span class=cl><span class=n>result2</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;请详细分析量子计算的原理&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl><span class=c1># 输出: 🧠 使用高级模型(gpt-4o)</span></span></span></code></pre></div><hr><h3 id=本章小结-1>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-1>#</a></h3><p><strong>内置Middleware分类</strong>:</p><table><thead><tr><th>类别</th><th>Middleware</th><th>核心功能</th></tr></thead><tbody><tr><td><strong>安全</strong></td><td>PIIMiddleware</td><td>PII检测与脱敏</td></tr><tr><td></td><td>HumanInTheLoopMiddleware</td><td>人工审批</td></tr><tr><td><strong>可靠性</strong></td><td>ModelCallLimitMiddleware</td><td>限制模型调用</td></tr><tr><td></td><td>ToolCallLimitMiddleware</td><td>限制工具调用</td></tr><tr><td></td><td>ToolRetryMiddleware</td><td>自动重试</td></tr><tr><td></td><td>ModelFallbackMiddleware</td><td>模型降级</td></tr><tr><td><strong>性能</strong></td><td>SummarizationMiddleware</td><td>对话摘要</td></tr><tr><td></td><td>ContextEditingMiddleware</td><td>上下文裁剪</td></tr><tr><td><strong>能力增强</strong></td><td>TodoListMiddleware</td><td>任务规划</td></tr><tr><td></td><td>LLMToolSelectorMiddleware</td><td>工具筛选</td></tr><tr><td></td><td>LLMToolEmulator</td><td>工具模拟</td></tr></tbody></table><p><strong>自定义开发</strong>:</p><ol><li>继承<code>AgentMiddleware</code></li><li>覆盖需要的Hook</li><li>遵循最佳实践(避免阻塞I/O、幂等设计)</li></ol><p><strong>下一章预告</strong>: 学习如何组合多个Middleware、测试策略和生产级配置。</p><hr><p>(第2章完成,累计约12000字)</p><p>&lt;待续&mldr;></p><h2 id=第3章组合策略与生产实践>第3章：组合策略与生产实践<a class=anchor href=#%e7%ac%ac3%e7%ab%a0%e7%bb%84%e5%90%88%e7%ad%96%e7%95%a5%e4%b8%8e%e7%94%9f%e4%ba%a7%e5%ae%9e%e8%b7%b5>#</a></h2><blockquote class=book-hint><p><strong>本章目标</strong>: 将Multiple Middleware组合使用,掌握测试方法和生产级配置</p></blockquote><h3 id=31-middleware组合策略>3.1 Middleware组合策略<a class=anchor href=#31-middleware%e7%bb%84%e5%90%88%e7%ad%96%e7%95%a5>#</a></h3><h4 id=311-执行顺序规则重要>3.1.1 执行顺序规则(重要!)<a class=anchor href=#311-%e6%89%a7%e8%a1%8c%e9%a1%ba%e5%ba%8f%e8%a7%84%e5%88%99%e9%87%8d%e8%a6%81>#</a></h4><p>当传入多个middleware时,执行顺序规则:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>middleware</span> <span class=o>=</span> <span class=p>[</span><span class=n>A</span><span class=p>,</span> <span class=n>B</span><span class=p>,</span> <span class=n>C</span><span class=p>]</span></span></span></code></pre></div><p><strong>规则</strong>:</p><ol><li><em><em>before_</em> hooks</em>*: 顺序执行 A → B → C</li><li><em><em>wrap_</em> hooks</em>*: 嵌套执行(洋葱模型) A包装B包装C</li><li><em><em>after_</em> hooks</em>*: 逆序执行 C → B → A</li></ol><p><strong>示例验证</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>before_model</span><span class=p>,</span> <span class=n>after_model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mw_a</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;A: before_model&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mw_b</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;B: before_model&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@after_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mw_c</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;C: after_model&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@after_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mw_d</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;D: after_model&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>mw_a</span><span class=p>,</span> <span class=n>mw_b</span><span class=p>,</span> <span class=n>mw_c</span><span class=p>,</span> <span class=n>mw_d</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出顺序:</span>
</span></span><span class=line><span class=cl><span class=c1># A: before_model</span>
</span></span><span class=line><span class=cl><span class=c1># B: before_model</span>
</span></span><span class=line><span class=cl><span class=c1># (模型调用)</span>
</span></span><span class=line><span class=cl><span class=c1># D: after_model  ← 注意:after hooks是逆序!</span>
</span></span><span class=line><span class=cl><span class=c1># C: after_model</span></span></span></code></pre></div><p><em><em>wrap_</em> hooks的洋葱模型</em>*:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@wrap_model_call</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>outer</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Outer: before&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Outer: after&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@wrap_model_call</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>inner</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Inner: before&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Inner: after&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>outer</span><span class=p>,</span> <span class=n>inner</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输出:</span>
</span></span><span class=line><span class=cl><span class=c1># Outer: before</span>
</span></span><span class=line><span class=cl><span class=c1># Inner: before</span>
</span></span><span class=line><span class=cl><span class=c1># (模型调用)</span>
</span></span><span class=line><span class=cl><span class=c1># Inner: after</span>
</span></span><span class=line><span class=cl><span class=c1># Outer: after</span></span></span></code></pre></div><h4 id=312-分层组合策略>3.1.2 分层组合策略<a class=anchor href=#312-%e5%88%86%e5%b1%82%e7%bb%84%e5%90%88%e7%ad%96%e7%95%a5>#</a></h4><p><strong>最佳实践</strong>: 按功能分层组合,确保优先级</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第1层: 安全与合规(最先执行)</span>
</span></span><span class=line><span class=cl><span class=n>security_layer</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;block&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第2层: 可靠性保障</span>
</span></span><span class=line><span class=cl><span class=n>reliability_layer</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelCallLimitMiddleware</span><span class=p>(</span><span class=n>run_limit</span><span class=o>=</span><span class=mi>20</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ToolRetryMiddleware</span><span class=p>(</span><span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第3层: 性能优化</span>
</span></span><span class=line><span class=cl><span class=n>performance_layer</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>SummarizationMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>max_tokens_before_summary</span><span class=o>=</span><span class=mi>2000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>messages_to_keep</span><span class=o>=</span><span class=mi>6</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 第4层: 观测与监控</span>
</span></span><span class=line><span class=cl><span class=n>observability_layer</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>cost_tracker</span><span class=p>,</span>  <span class=c1># 自定义成本追踪</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合(顺序很重要!)</span>
</span></span><span class=line><span class=cl><span class=n>middleware</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>security_layer</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>reliability_layer</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>performance_layer</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=n>observability_layer</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>database_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=n>middleware</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><p><strong>为什么这个顺序?</strong></p><ol><li><strong>安全层在最前</strong>: 确保所有请求/响应都经过PII检查</li><li><strong>可靠性层在中间</strong>: 限制调用次数,防止资源浪费</li><li><strong>性能层在后</strong>: 在安全和可靠性保障后再做优化</li><li><strong>观测层在最后</strong>: 记录最终状态</li></ol><h4 id=313-冲突处理>3.1.3 冲突处理<a class=anchor href=#313-%e5%86%b2%e7%aa%81%e5%a4%84%e7%90%86>#</a></h4><p><strong>问题</strong>: 多个middleware同时修改state</p><p><strong>示例冲突场景</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_context_a</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>SystemMessage</span><span class=p>(</span><span class=s2>&#34;来自A的上下文&#34;</span><span class=p>)]</span> <span class=o>+</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>add_context_b</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>SystemMessage</span><span class=p>(</span><span class=s2>&#34;来自B的上下文&#34;</span><span class=p>)]</span> <span class=o>+</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 问题: B会覆盖A添加的SystemMessage吗?</span></span></span></code></pre></div><p><strong>答案</strong>: 不会!state updates是<strong>merge</strong>的,不是replace。但需要注意:</p><ul><li>对于<code>messages</code>字段,使用<code>add_messages</code> reducer,会追加而不是替换</li><li>其他字段默认是替换</li></ul><p><strong>解决方案1: 幂等设计</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>idempotent_system_prompt</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;幂等的system prompt注入&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 检查是否已存在system message</span>
</span></span><span class=line><span class=cl>    <span class=n>has_system</span> <span class=o>=</span> <span class=nb>any</span><span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>SystemMessage</span><span class=p>)</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>has_system</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>SystemMessage</span><span class=p>(</span><span class=s2>&#34;你是一个助手&#34;</span><span class=p>)]</span> <span class=o>+</span> <span class=n>messages</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span>  <span class=c1># 已存在,跳过</span></span></span></code></pre></div><p><strong>解决方案2: 合并而非替换</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@before_model</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>merge_system_prompts</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;合并多个system prompts&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 提取所有system messages</span>
</span></span><span class=line><span class=cl>    <span class=n>system_msgs</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>messages</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>SystemMessage</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=n>other_msgs</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>messages</span> <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>SystemMessage</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 合并system messages</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>system_msgs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>combined_content</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=se>\n\n</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>content</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>system_msgs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>new_messages</span> <span class=o>=</span> <span class=p>[</span><span class=n>SystemMessage</span><span class=p>(</span><span class=n>combined_content</span><span class=p>)]</span> <span class=o>+</span> <span class=n>other_msgs</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=n>new_messages</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>None</span></span></span></code></pre></div><hr><h3 id=32-测试策略>3.2 测试策略<a class=anchor href=#32-%e6%b5%8b%e8%af%95%e7%ad%96%e7%95%a5>#</a></h3><h4 id=321-单元测试-测试单个middleware>3.2.1 单元测试: 测试单个Middleware<a class=anchor href=#321-%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95-%e6%b5%8b%e8%af%95%e5%8d%95%e4%b8%aamiddleware>#</a></h4><p><strong>策略</strong>: Mock state和runtime,验证middleware行为</p><p><strong>示例: 测试TokenCounterMiddleware</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_core.messages</span> <span class=kn>import</span> <span class=n>HumanMessage</span><span class=p>,</span> <span class=n>AIMessage</span><span class=p>,</span> <span class=n>SystemMessage</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_token_counter_before_model</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试before_model hook&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建middleware实例</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span> <span class=o>=</span> <span class=n>TokenCounterMiddleware</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Mock state</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;测试消息1&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;测试回复1&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;测试消息2&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Mock runtime</span>
</span></span><span class=line><span class=cl>    <span class=k>class</span> <span class=nc>MockRuntime</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>runtime</span> <span class=o>=</span> <span class=n>MockRuntime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 调用hook</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>middleware</span><span class=o>.</span><span class=n>before_model</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 验证: 应该返回None(不修改state)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>result</span> <span class=ow>is</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 运行测试</span>
</span></span><span class=line><span class=cl><span class=n>test_token_counter_before_model</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 测试通过&#34;</span><span class=p>)</span></span></span></code></pre></div><p><strong>示例: 测试wrap_model_call</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_cache_middleware</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;测试缓存middleware&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建middleware</span>
</span></span><span class=line><span class=cl>    <span class=nd>@wrap_model_call</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cache_mw</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 简化版缓存逻辑</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>request</span><span class=o>.</span><span class=n>messages</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=n>cache_mw</span><span class=o>.</span><span class=n>_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cache_mw</span><span class=o>.</span><span class=n>_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_mw</span><span class=o>.</span><span class=n>_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>cache_mw</span><span class=o>.</span><span class=n>_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Mock handler</span>
</span></span><span class=line><span class=cl>    <span class=n>call_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mock_handler</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>nonlocal</span> <span class=n>call_count</span>
</span></span><span class=line><span class=cl>        <span class=n>call_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ModelResponse</span><span class=p>(</span><span class=n>result</span><span class=o>=</span><span class=p>[</span><span class=n>AIMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;测试响应&#34;</span><span class=p>)])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Mock request</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=n>ModelRequest</span>
</span></span><span class=line><span class=cl>    <span class=n>request</span> <span class=o>=</span> <span class=n>ModelRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span><span class=n>HumanMessage</span><span class=p>(</span><span class=n>content</span><span class=o>=</span><span class=s2>&#34;测试&#34;</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_choice</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=n>response_format</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[]},</span>
</span></span><span class=line><span class=cl>        <span class=n>runtime</span><span class=o>=</span><span class=n>MockRuntime</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第一次调用 - 缓存miss</span>
</span></span><span class=line><span class=cl>    <span class=n>response1</span> <span class=o>=</span> <span class=n>cache_mw</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>mock_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>call_count</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 第二次调用 - 缓存hit</span>
</span></span><span class=line><span class=cl>    <span class=n>response2</span> <span class=o>=</span> <span class=n>cache_mw</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>mock_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>call_count</span> <span class=o>==</span> <span class=mi>1</span>  <span class=c1># handler没有被再次调用</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>response1</span> <span class=o>==</span> <span class=n>response2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 缓存middleware测试通过&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test_cache_middleware</span><span class=p>()</span></span></span></code></pre></div><h4 id=322-集成测试-测试完整agent>3.2.2 集成测试: 测试完整Agent<a class=anchor href=#322-%e9%9b%86%e6%88%90%e6%b5%8b%e8%af%95-%e6%b5%8b%e8%af%95%e5%ae%8c%e6%95%b4agent>#</a></h4><p><strong>策略</strong>: 使用真实模型(gpt-4o-mini)测试,验证middleware组合</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>test_middleware_integration</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;集成测试: 多个middleware组合&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 创建agent</span>
</span></span><span class=line><span class=cl>    <span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>ModelCallLimitMiddleware</span><span class=p>(</span><span class=n>run_limit</span><span class=o>=</span><span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>cost_tracker</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 测试正常流程</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>({</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;hi&#34;</span><span class=p>)]})</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>result</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>  <span class=c1># 应该有响应</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 测试限制生效</span>
</span></span><span class=line><span class=cl>    <span class=c1># (这里省略,实际需要触发循环场景)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;✅ 集成测试通过&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>test_middleware_integration</span><span class=p>()</span></span></span></code></pre></div><hr><h3 id=33-生产级middleware-stack>3.3 生产级Middleware Stack<a class=anchor href=#33-%e7%94%9f%e4%ba%a7%e7%ba%a7middleware-stack>#</a></h3><h4 id=331-企业级配置示例>3.3.1 企业级配置示例<a class=anchor href=#331-%e4%bc%81%e4%b8%9a%e7%ba%a7%e9%85%8d%e7%bd%ae%e7%a4%ba%e4%be%8b>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents</span> <span class=kn>import</span> <span class=n>create_agent</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain.agents.middleware</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelCallLimitMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>ToolRetryMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>SummarizationMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>HumanInTheLoopMiddleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langchain_openai</span> <span class=kn>import</span> <span class=n>ChatOpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.checkpoint.postgres</span> <span class=kn>import</span> <span class=n>PostgresSaver</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义middleware</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ProductionMonitoringMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;生产环境监控&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metrics_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>metrics_client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=s2>&#34;agent.requests&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=s2>&#34;agent.success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=s2>&#34;model.calls&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>create_production_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model_name</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics_client</span><span class=o>=</span><span class=kc>None</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;创建生产环境agent&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 安全层</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>,</span> <span class=n>apply_to_input</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;block&#34;</span><span class=p>,</span> <span class=n>apply_to_input</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 2. 监控层</span>
</span></span><span class=line><span class=cl>        <span class=n>ProductionMonitoringMiddleware</span><span class=p>(</span><span class=n>metrics_client</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 3. 可靠性层</span>
</span></span><span class=line><span class=cl>        <span class=n>ModelCallLimitMiddleware</span><span class=p>(</span><span class=n>run_limit</span><span class=o>=</span><span class=mi>30</span><span class=p>,</span> <span class=n>thread_limit</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>exit_behavior</span><span class=o>=</span><span class=s2>&#34;end&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>ToolRetryMiddleware</span><span class=p>(</span><span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=n>backoff_factor</span><span class=o>=</span><span class=mf>2.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 4. 性能层</span>
</span></span><span class=line><span class=cl>        <span class=n>SummarizationMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>max_tokens_before_summary</span><span class=o>=</span><span class=mi>3000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>messages_to_keep</span><span class=o>=</span><span class=mi>8</span>
</span></span><span class=line><span class=cl>        <span class=p>),</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 5. 审批层(危险工具)</span>
</span></span><span class=line><span class=cl>        <span class=n>HumanInTheLoopMiddleware</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>interrupt_on</span><span class=o>=</span><span class=p>{</span><span class=s2>&#34;tool_start&#34;</span><span class=p>:</span> <span class=kc>True</span><span class=p>}</span>  <span class=c1># 所有工具都需要审批</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> <span class=k>if</span> <span class=n>checkpointer</span> <span class=k>else</span> <span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 过滤None</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>middleware</span> <span class=k>if</span> <span class=n>m</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>model_name</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=n>search_tool</span><span class=p>,</span> <span class=n>database_tool</span><span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>middleware</span><span class=o>=</span><span class=n>middleware</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>system_prompt</span><span class=o>=</span><span class=s2>&#34;你是企业级AI助手,请谨慎处理敏感信息。&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>checkpointer</span> <span class=o>=</span> <span class=n>PostgresSaver</span><span class=o>.</span><span class=n>from_conn_string</span><span class=p>(</span><span class=s2>&#34;postgresql://...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>metrics</span> <span class=o>=</span> <span class=n>MyMetricsClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_production_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model_name</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>checkpointer</span><span class=o>=</span><span class=n>checkpointer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>metrics_client</span><span class=o>=</span><span class=n>metrics</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=332-环境区分配置>3.3.2 环境区分配置<a class=anchor href=#332-%e7%8e%af%e5%a2%83%e5%8c%ba%e5%88%86%e9%85%8d%e7%bd%ae>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基础配置</span>
</span></span><span class=line><span class=cl><span class=n>BASE_MIDDLEWARE</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>ModelCallLimitMiddleware</span><span class=p>(</span><span class=n>run_limit</span><span class=o>=</span><span class=mi>30</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 开发环境</span>
</span></span><span class=line><span class=cl><span class=n>DEV_MIDDLEWARE</span> <span class=o>=</span> <span class=n>BASE_MIDDLEWARE</span> <span class=o>+</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># 开发环境不限制,方便调试</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试环境</span>
</span></span><span class=line><span class=cl><span class=n>TEST_MIDDLEWARE</span> <span class=o>=</span> <span class=n>BASE_MIDDLEWARE</span> <span class=o>+</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># 使用工具模拟,不实际调用外部API</span>
</span></span><span class=line><span class=cl>    <span class=n>LLMToolEmulator</span><span class=p>(</span><span class=n>tools</span><span class=o>=</span><span class=p>[</span><span class=s2>&#34;expensive_api&#34;</span><span class=p>]),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生产环境</span>
</span></span><span class=line><span class=cl><span class=n>PROD_MIDDLEWARE</span> <span class=o>=</span> <span class=n>BASE_MIDDLEWARE</span> <span class=o>+</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=n>pii_type</span><span class=o>=</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;block&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ToolRetryMiddleware</span><span class=p>(</span><span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>ProductionMonitoringMiddleware</span><span class=p>(</span><span class=n>metrics_client</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 根据环境选择</span>
</span></span><span class=line><span class=cl><span class=n>env</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;ENV&#34;</span><span class=p>,</span> <span class=s2>&#34;dev&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>middleware</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;dev&#34;</span><span class=p>:</span> <span class=n>DEV_MIDDLEWARE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;test&#34;</span><span class=p>:</span> <span class=n>TEST_MIDDLEWARE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;prod&#34;</span><span class=p>:</span> <span class=n>PROD_MIDDLEWARE</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}[</span><span class=n>env</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=n>all_tools</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=n>middleware</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><h4 id=333-feature-flags配置>3.3.3 Feature Flags配置<a class=anchor href=#333-feature-flags%e9%85%8d%e7%bd%ae>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>FeatureFlagMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;根据feature flags控制功能&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>flags</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>flags</span> <span class=o>=</span> <span class=n>flags</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 从runtime.context读取用户信息</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span> <span class=o>=</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>)</span> <span class=k>if</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否启用实验性功能</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>flags</span><span class=o>.</span><span class=n>is_enabled</span><span class=p>(</span><span class=s2>&#34;experimental_prompt&#34;</span><span class=p>,</span> <span class=n>user_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>messages</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>experimental_prompt</span> <span class=o>=</span> <span class=n>SystemMessage</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;使用实验性推理模式(CoT)进行回答&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[</span><span class=n>experimental_prompt</span><span class=p>]</span> <span class=o>+</span> <span class=n>messages</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用</span>
</span></span><span class=line><span class=cl><span class=n>flags</span> <span class=o>=</span> <span class=n>FeatureFlagClient</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>agent</span> <span class=o>=</span> <span class=n>create_agent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tools</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=n>middleware</span><span class=o>=</span><span class=p>[</span><span class=n>FeatureFlagMiddleware</span><span class=p>(</span><span class=n>flags</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用时传入user_id</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>langgraph.runtime</span> <span class=kn>import</span> <span class=n>Runtime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>result</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>invoke</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=s2>&#34;messages&#34;</span><span class=p>:</span> <span class=p>[(</span><span class=s2>&#34;user&#34;</span><span class=p>,</span> <span class=s2>&#34;测试&#34;</span><span class=p>)]},</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;configurable&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;context&#34;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&#34;user_id&#34;</span><span class=p>:</span> <span class=s2>&#34;user-123&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></div><hr><h3 id=34-性能考量与最佳实践>3.4 性能考量与最佳实践<a class=anchor href=#34-%e6%80%a7%e8%83%bd%e8%80%83%e9%87%8f%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><h4 id=341-避免阻塞io>3.4.1 避免阻塞I/O<a class=anchor href=#341-%e9%81%bf%e5%85%8d%e9%98%bb%e5%a1%9eio>#</a></h4><p><strong>❌ 不好的做法</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>BadMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 同步数据库查询会阻塞!</span>
</span></span><span class=line><span class=cl>        <span class=n>user</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=s2>&#34;SELECT * FROM users WHERE id = ?&#34;</span><span class=p>,</span> <span class=n>user_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;user_info&#34;</span><span class=p>:</span> <span class=n>user</span><span class=p>}</span></span></span></code></pre></div><p><strong>✅ 好的做法</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>GoodMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span> <span class=o>=</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>)</span> <span class=k>if</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span> <span class=k>else</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 从缓存读取</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>user_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{</span><span class=s2>&#34;user_info&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>user_id</span><span class=p>]}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 缓存未命中: 使用异步查询或跳过</span>
</span></span><span class=line><span class=cl>        <span class=c1># 或者在agent创建时预加载数据</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span></span></span></code></pre></div><h4 id=342-控制附加模型调用>3.4.2 控制附加模型调用<a class=anchor href=#342-%e6%8e%a7%e5%88%b6%e9%99%84%e5%8a%a0%e6%a8%a1%e5%9e%8b%e8%b0%83%e7%94%a8>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># ❌ 每次都调用LLM做安全检测 - 成本高</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExpensiveSafetyMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>        <span class=c1># 调用另一个LLM做安全检测</span>
</span></span><span class=line><span class=cl>        <span class=n>is_safe</span> <span class=o>=</span> <span class=n>safety_llm</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>  <span class=c1># 额外成本!</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✅ 使用规则或便宜模型</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CheapSafetyMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>after_model</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=n>state</span><span class=p>[</span><span class=s2>&#34;messages&#34;</span><span class=p>][</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 先用正则快速检测</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>regex_check</span><span class=p>(</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 只有可疑时才用便宜的LLM</span>
</span></span><span class=line><span class=cl>        <span class=n>is_safe</span> <span class=o>=</span> <span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o-mini&#34;</span><span class=p>)</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span></span></span></code></pre></div><h4 id=343-指标收集>3.4.3 指标收集<a class=anchor href=#343-%e6%8c%87%e6%a0%87%e6%94%b6%e9%9b%86>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MetricsMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;收集性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metrics_client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=n>metrics_client</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrap_model_call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测量模型调用耗时&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>response</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 记录成功调用的耗时</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>histogram</span><span class=p>(</span><span class=s2>&#34;model.call.duration&#34;</span><span class=p>,</span> <span class=n>elapsed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=s2>&#34;model.call.success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 记录失败</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=s2>&#34;model.call.error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>histogram</span><span class=p>(</span><span class=s2>&#34;model.call.duration&#34;</span><span class=p>,</span> <span class=n>elapsed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrap_tool_call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;测量工具调用耗时&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_name</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>tool_call</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>histogram</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;tool.</span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2>.duration&#34;</span><span class=p>,</span> <span class=n>elapsed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;tool.</span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2>.success&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>increment</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;tool.</span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2>.error&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span></span></span></code></pre></div><hr><h3 id=本章小结-2>本章小结<a class=anchor href=#%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%bb%93-2>#</a></h3><ol><li><p><strong>执行顺序</strong>:</p><ul><li>before_* hooks: 顺序执行</li><li>wrap_* hooks: 洋葱模型(嵌套)</li><li>after_* hooks: 逆序执行</li></ul></li><li><p><strong>组合策略</strong>:</p><ul><li>分层组合: 安全 → 可靠性 → 性能 → 观测</li><li>环境区分: dev / test / prod</li><li>Feature flags: 灵活控制功能开关</li></ul></li><li><p><strong>测试</strong>:</p><ul><li>单元测试: mock state和runtime</li><li>集成测试: 真实模型测试</li></ul></li><li><p><strong>性能最佳实践</strong>:</p><ul><li>避免阻塞I/O</li><li>控制附加模型调用</li><li>收集性能指标</li></ul></li></ol><hr><h3 id=本篇总结>本篇总结<a class=anchor href=#%e6%9c%ac%e7%af%87%e6%80%bb%e7%bb%93>#</a></h3><p><strong>核心要点</strong>:</p><ol><li><strong>Middleware是什么</strong>: Agent执行流程中的Hook,实现精准控制</li><li><strong>六大Hook</strong>: before_agent, before_model, after_model, after_agent, wrap_model_call, wrap_tool_call</li><li><strong>内置组件</strong>: 11个middleware覆盖安全/可靠性/性能/能力增强</li><li><strong>自定义开发</strong>: 继承AgentMiddleware,覆盖需要的Hook</li><li><strong>生产实践</strong>: 分层组合、环境区分、测试策略</li></ol><p><strong>与其他篇章的联系</strong>:</p><ul><li><strong>第三篇(LangGraph)</strong>: Middleware运行在LangGraph之上</li><li><strong>第七篇(Deep Agents)</strong>: deepagents内置了TodoList等middleware</li><li><strong>第十篇(生产实践与监控评估)</strong>: Middleware可输出指标给LangSmith</li></ul><p><strong>下一步</strong>: 学习如何使用LangSmith追踪和评估Agent质量。</p><hr><h3 id=思考与练习>思考与练习<a class=anchor href=#%e6%80%9d%e8%80%83%e4%b8%8e%e7%bb%83%e4%b9%a0>#</a></h3><ol><li><p><strong>思考</strong>: 如果要实现"高价值用户自动升级到GPT-4o"的功能,应该用哪个Hook?</p><details><summary>答案</summary><p>使用<code>wrap_model_call</code>,根据runtime.context中的user_id判断:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@wrap_model_call</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>premium_user_upgrade</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>user_id</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>runtime</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>user_id</span> <span class=ow>in</span> <span class=n>premium_users</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>request</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>override</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=n>ChatOpenAI</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s2>&#34;gpt-4o&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>handler</span><span class=p>(</span><span class=n>request</span><span class=p>)</span></span></span></code></pre></div></details></li><li><p><strong>练习</strong>: 实现一个<code>RateLimitMiddleware</code>,限制单个用户每分钟最多调用10次Agent。</p><details><summary>参考答案</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitMiddleware</span><span class=p>(</span><span class=n>AgentMiddleware</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_calls</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>window</span><span class=o>=</span><span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span> <span class=o>=</span> <span class=n>max_calls</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window</span> <span class=o>=</span> <span class=n>window</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>  <span class=c1># user_id -&gt; [timestamps]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>before_agent</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>state</span><span class=p>,</span> <span class=n>runtime</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>user_id</span> <span class=o>=</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;user_id&#34;</span><span class=p>,</span> <span class=s2>&#34;anonymous&#34;</span><span class=p>)</span> <span class=k>if</span> <span class=n>runtime</span><span class=o>.</span><span class=n>context</span> <span class=k>else</span> <span class=s2>&#34;anonymous&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 清理过期记录</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>now</span> <span class=o>-</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>window</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 检查速率限制</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=n>user_id</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=sa>f</span><span class=s2>&#34;速率限制: 每</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>window</span><span class=si>}</span><span class=s2>秒最多</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>max_calls</span><span class=si>}</span><span class=s2>次请求&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 记录本次调用</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>calls</span><span class=p>[</span><span class=n>user_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span></span></span></code></pre></div></details></li><li><p><strong>思考</strong>: 为什么PIIMiddleware要分多个实例(每个检测一种类型),而不是一个实例检测所有类型?</p><details><summary>答案</summary><p>设计考量:</p><ul><li><strong>单一职责</strong>: 每个实例只做一件事,代码更清晰</li><li><strong>灵活配置</strong>: 不同PII类型可以用不同策略(email用redact, credit_card用block)</li><li><strong>性能</strong>: 可以并行检测多种类型</li><li><strong>扩展性</strong>: 方便添加自定义检测器</li></ul><p>如果需要检测多种类型,组合多个实例即可:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>middleware</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=s2>&#34;email&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;redact&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>PIIMiddleware</span><span class=p>(</span><span class=s2>&#34;credit_card&#34;</span><span class=p>,</span> <span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;block&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>]</span></span></span></code></pre></div></details></li><li><p><strong>练习</strong>: 设计一个"对话质量评分"的Middleware,在每次对话结束后给出1-5分的评分。</p></li></ol><hr><hr><h2 id=深入阅读-additional-resources>深入阅读 (Additional Resources)<a class=anchor href=#%e6%b7%b1%e5%85%a5%e9%98%85%e8%af%bb-additional-resources>#</a></h2><h3 id=官方文档>官方文档<a class=anchor href=#%e5%ae%98%e6%96%b9%e6%96%87%e6%a1%a3>#</a></h3><p><strong>LangChain Agents 与 Middleware</strong>:</p><ul><li><a href=https://docs.langchain.com/oss/python/langchain/agents>LangChain Agents 核心文档</a> - Agents 的完整介绍</li><li><a href=https://docs.langchain.com/oss/python/langchain/middleware>Middleware 概念指南</a> - Middleware 的设计理念和使用场景</li><li><a href=https://reference.langchain.com/python/langchain/middleware/>Middleware API Reference</a> - 完整的 API 参考文档</li><li><a href=https://docs.langchain.com/oss/python/langchain/middleware#built-in-middleware>内置 Middleware 列表</a> - 所有内置 Middleware 的详细说明</li></ul><p><strong>LangGraph Runtime</strong>:</p><ul><li><a href=https://langchain-ai.github.io/langgraph/reference/runtime/>Runtime 文档</a> - Runtime 和 Context 的使用</li><li><a href=https://langchain-ai.github.io/langgraph/how-tos/persistence/>Checkpointer 机制</a> - 持久化与断点续传</li><li><a href=https://langchain-ai.github.io/langgraph/how-tos/human_in_the_loop/>Human-in-the-Loop</a> - 人工介入的最佳实践</li></ul><h3 id=设计模式与最佳实践>设计模式与最佳实践<a class=anchor href=#%e8%ae%be%e8%ae%a1%e6%a8%a1%e5%bc%8f%e4%b8%8e%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5>#</a></h3><p><strong>Middleware 设计模式</strong>:</p><ul><li><a href=https://en.wikipedia.org/wiki/Middleware_%28distributed_applications%29>Middleware Pattern in Software Engineering</a> - 软件工程中的 Middleware 模式</li><li><a href=https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/>Onion Architecture</a> - 洋葱架构(wrap_* hooks 的设计思想)</li><li><a href=https://refactoring.guru/design-patterns/chain-of-responsibility>Chain of Responsibility Pattern</a> - 责任链模式</li></ul><p><strong>Agent 工程化</strong>:</p><ul><li><a href=https://docs.smith.langchain.com/>LangSmith 追踪与监控</a> - 生产环境的可观测性</li><li><a href=https://docs.langchain.com/security>Agent 安全最佳实践</a> - PII 保护、输入验证、工具安全</li><li><a href=https://docs.langchain.com/optimization/cost>成本优化指南</a> - Token 管理、缓存策略、模型选择</li></ul><h3 id=相关技术文章>相关技术文章<a class=anchor href=#%e7%9b%b8%e5%85%b3%e6%8a%80%e6%9c%af%e6%96%87%e7%ab%a0>#</a></h3><p><strong>官方博客</strong>:</p><ul><li><a href=https://blog.langchain.dev/middleware>Introducing LangChain Middleware</a> - Middleware 的发布公告</li><li><a href=https://blog.langchain.dev/production-agents>Building Production-Ready Agents</a> - 生产级 Agent 的构建经验</li><li><a href=https://blog.langchain.dev/reliability>Agent Reliability Patterns</a> - 可靠性模式详解</li></ul><p><strong>社区实践</strong>:</p><ul><li><a href=https://github.com/langchain-ai/langchain/tree/master/cookbook/middleware>Real-World Middleware Examples</a> - LangChain Cookbook 中的 Middleware 示例</li><li><a href=https://github.com/langchain-ai/langgraph/tree/main/examples>Advanced Agent Architectures</a> - LangGraph 官方示例仓库</li></ul><h3 id=工具与库>工具与库<a class=anchor href=#%e5%b7%a5%e5%85%b7%e4%b8%8e%e5%ba%93>#</a></h3><p><strong>相关工具</strong>:</p><ul><li><a href=https://smith.langchain.com>LangSmith</a> - Agent 追踪、评估和监控平台</li><li><a href=https://github.com/langchain-ai/langserve>LangServe</a> - Agent 部署工具</li><li><a href=https://github.com/langchain-ai/langchain/tree/master/templates>LangChain Templates</a> - 预构建的 Agent 模板</li></ul><p><strong>开源项目参考</strong>:</p><ul><li><a href=https://github.com/Significant-Gravitas/AutoGPT>AutoGPT</a> - 使用 Middleware 实现复杂 Agent</li><li><a href=https://github.com/yoheinakajima/babyagi>BabyAGI</a> - 任务规划型 Agent 的参考实现</li></ul><h3 id=学习路径建议>学习路径建议<a class=anchor href=#%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84%e5%bb%ba%e8%ae%ae>#</a></h3><p><strong>初学者</strong>:</p><ol><li>先学习第1章的核心概念和基础 Hook</li><li>动手实践第1章的所有代码示例</li><li>尝试自定义一个简单的 LoggingMiddleware</li><li>阅读官方文档的 &ldquo;Getting Started&rdquo; 部分</li></ol><p><strong>进阶开发者</strong>:</p><ol><li>深入理解第2章的所有内置 Middleware</li><li>学习第3章的组合策略和测试方法</li><li>构建生产级 Middleware Stack</li><li>阅读 LangChain 源码中的 Middleware 实现</li></ol><p><strong>架构师</strong>:</p><ol><li>研究 Middleware 与 LangGraph 的集成机制</li><li>设计企业级 Middleware 框架</li><li>制定团队的 Middleware 开发规范</li><li>探索高级话题(性能优化、安全加固、成本控制)</li></ol><h3 id=常见问题解答>常见问题解答<a class=anchor href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98%e8%a7%a3%e7%ad%94>#</a></h3><p><strong>问: Middleware 和 LangGraph 的 Edge/Node 有什么区别?</strong></p><p>答:</p><ul><li><strong>Middleware</strong>: 横切关注点(cross-cutting concerns),如日志、安全、限流,作用于整个 Agent 生命周期</li><li><strong>LangGraph Node/Edge</strong>: 业务逻辑的流程控制,定义 Agent 的具体行为</li></ul><p>两者配合使用:Middleware 提供通用能力,LangGraph 定义业务流程。</p><p><strong>问: 可以在 Middleware 中修改 tools 列表吗?</strong></p><p>答: 可以!在 <code>wrap_model_call</code> 中可以通过 <code>request.override(tools=new_tools)</code> 修改工具列表,这正是 <code>LLMToolSelectorMiddleware</code> 的实现原理。</p><p><strong>问: Middleware 会影响性能吗?</strong></p><p>答:</p><ul><li><strong>轻量级 Middleware</strong>(如日志、计数): 影响微乎其微(&lt;1ms)</li><li><strong>包含 LLM 调用的 Middleware</strong>(如 LLMToolSelector): 会增加延迟,需权衡利弊</li><li><strong>最佳实践</strong>: 使用性能分析工具(如第3章的 MetricsMiddleware)量化影响</li></ul><p><strong>问: 如何调试 Middleware?</strong></p><p>答:</p><ol><li>使用 <code>print</code> 或 logging 输出关键信息</li><li>使用 LangSmith 追踪完整执行流程</li><li>编写单元测试(参考第3章)</li><li>使用 <code>wrap_model_call</code> 打印 request/response</li></ol><h3 id=视频教程推荐>视频教程推荐<a class=anchor href=#%e8%a7%86%e9%a2%91%e6%95%99%e7%a8%8b%e6%8e%a8%e8%8d%90>#</a></h3><ul><li><a href="https://www.youtube.com/watch?v=xxx">LangChain Agents Tutorial (YouTube)</a> - 官方视频教程</li><li><a href="https://www.youtube.com/watch?v=yyy">Building Production Agents (YouTube)</a> - 生产实践分享</li></ul><h3 id=持续更新>持续更新<a class=anchor href=#%e6%8c%81%e7%bb%ad%e6%9b%b4%e6%96%b0>#</a></h3><p>LangChain 和 LangGraph 在快速迭代中,建议关注:</p><ul><li><a href=https://github.com/langchain-ai/langchain/releases>LangChain GitHub Releases</a> - 版本更新日志</li><li><a href=https://discord.gg/langchain>LangChain Discord</a> - 社区讨论</li><li><a href=https://twitter.com/langchainai>LangChain Twitter</a> - 官方动态</li></ul><hr><p><strong>与其他篇章的联系</strong>:</p><ul><li><strong>第三篇(LangGraph 深入)</strong>: Middleware 运行在 LangGraph 构建的 Agent 之上</li><li><strong>第七篇(Deep Agents)</strong>: deepagents 内置了 TodoList 等 Middleware</li><li><strong>第十篇(生产实践与监控评估)</strong>: Middleware 可输出指标给 LangSmith</li></ul></article><div style="margin-top:2rem;border-top:1px solid #e5e7eb;padding-top:1rem;font-size:.85rem;color:#6b7280;text-align:center">[统计组件仅在生产环境显示]</div><div class=giscus style=margin-top:2rem></div><script src=https://giscus.app/client.js data-repo=LordFoxFairy/LordFoxFairy.github.io data-repo-id=R_kgDOQ-JRGA data-category=Announcements data-category-id=DIC_kwDOQ-JRGM4C1PDC data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script><footer class=book-footer><div class="flex flex-wrap justify-between"><div></div><div></div></div><div class="flex flex-wrap justify-between"><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B8%83%E7%AF%87-deep-agents/ class="flex align-center"><img src=/icons/backward.svg class=book-icon alt=Backward>
<span>第七篇 Deep Agents</span>
</a></span><span><a href=/notebooks/langchain%E7%AC%94%E8%AE%B0/%E7%AC%AC%E4%B9%9D%E7%AF%87-agent-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/ class="flex align-center"><span>第九篇 Agent 架构设计</span>
<img src=/icons/forward.svg class=book-icon alt=Forward></a></span></div><div class=book-comments></div><script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#第1章middleware-核心机制>第1章：Middleware 核心机制</a><ul><li><a href=#11-什么是-middleware>1.1 什么是 Middleware</a><ul><li><a href=#111-agent执行流程回顾>1.1.1 Agent执行流程回顾</a></li><li><a href=#112-middleware的切入点与生命周期>1.1.2 Middleware的切入点与生命周期</a></li><li><a href=#113-核心价值>1.1.3 核心价值</a></li></ul></li><li><a href=#12-创建第一个middleware>1.2 创建第一个Middleware</a><ul><li><a href=#121-方式1-使用decorator>1.2.1 方式1: 使用Decorator</a></li><li><a href=#122-方式2-继承agentmiddleware>1.2.2 方式2: 继承AgentMiddleware</a></li><li><a href=#123-实战-wrap_model_call实现缓存>1.2.3 实战: wrap_model_call实现缓存</a></li><li><a href=#124-实战-wrap_tool_call实现重试>1.2.4 实战: wrap_tool_call实现重试</a></li></ul></li><li><a href=#13-hook体系深入理解>1.3 Hook体系深入理解</a><ul><li><a href=#131-hook分类>1.3.1 Hook分类</a></li><li><a href=#132-hook签名详解>1.3.2 Hook签名详解</a></li><li><a href=#133-核心类型>1.3.3 核心类型</a></li></ul></li><li><a href=#14-jump_to-条件跳转>1.4 jump_to: 条件跳转</a><ul><li><a href=#141-什么是jump_to>1.4.1 什么是jump_to</a></li><li><a href=#142-实战-早退出middleware>1.4.2 实战: 早退出Middleware</a></li></ul></li><li><a href=#本章小结>本章小结</a></li></ul></li><li><a href=#第2章内置middleware与自定义开发>第2章：内置Middleware与自定义开发</a><ul><li><a href=#21-安全类middleware>2.1 安全类Middleware</a><ul><li><a href=#211-piimiddleware---敏感信息脱敏>2.1.1 PIIMiddleware - 敏感信息脱敏</a></li><li><a href=#212-humanintheloopmiddleware---人工审批>2.1.2 HumanInTheLoopMiddleware - 人工审批</a></li></ul></li><li><a href=#22-可靠性类middleware>2.2 可靠性类Middleware</a><ul><li><a href=#221-modelcalllimitmiddleware---防止死循环>2.2.1 ModelCallLimitMiddleware - 防止死循环</a></li><li><a href=#222-toolcalllimitmiddleware---工具调用限制>2.2.2 ToolCallLimitMiddleware - 工具调用限制</a></li><li><a href=#223-toolretrymiddleware---自动重试>2.2.3 ToolRetryMiddleware - 自动重试</a></li><li><a href=#224-modelfallbackmiddleware---模型降级>2.2.4 ModelFallbackMiddleware - 模型降级</a></li></ul></li><li><a href=#23-性能优化类middleware>2.3 性能优化类Middleware</a><ul><li><a href=#231-summarizationmiddleware---对话摘要>2.3.1 SummarizationMiddleware - 对话摘要</a></li><li><a href=#232-contexteditingmiddleware---上下文裁剪>2.3.2 ContextEditingMiddleware - 上下文裁剪</a></li></ul></li><li><a href=#24-能力增强类middleware>2.4 能力增强类Middleware</a><ul><li><a href=#241-todolistmiddleware---任务规划>2.4.1 TodoListMiddleware - 任务规划</a></li><li><a href=#242-llmtoolselectormiddleware---智能工具筛选>2.4.2 LLMToolSelectorMiddleware - 智能工具筛选</a></li><li><a href=#243-llmtoolemulator---工具模拟>2.4.3 LLMToolEmulator - 工具模拟</a></li></ul></li><li><a href=#25-自定义middleware开发>2.5 自定义Middleware开发</a><ul><li><a href=#251-开发规范>2.5.1 开发规范</a></li><li><a href=#252-实战-成本追踪middleware>2.5.2 实战: 成本追踪Middleware</a></li><li><a href=#253-实战-动态模型路由middleware>2.5.3 实战: 动态模型路由Middleware</a></li></ul></li><li><a href=#本章小结-1>本章小结</a></li></ul></li><li><a href=#第3章组合策略与生产实践>第3章：组合策略与生产实践</a><ul><li><a href=#31-middleware组合策略>3.1 Middleware组合策略</a><ul><li><a href=#311-执行顺序规则重要>3.1.1 执行顺序规则(重要!)</a></li><li><a href=#312-分层组合策略>3.1.2 分层组合策略</a></li><li><a href=#313-冲突处理>3.1.3 冲突处理</a></li></ul></li><li><a href=#32-测试策略>3.2 测试策略</a><ul><li><a href=#321-单元测试-测试单个middleware>3.2.1 单元测试: 测试单个Middleware</a></li><li><a href=#322-集成测试-测试完整agent>3.2.2 集成测试: 测试完整Agent</a></li></ul></li><li><a href=#33-生产级middleware-stack>3.3 生产级Middleware Stack</a><ul><li><a href=#331-企业级配置示例>3.3.1 企业级配置示例</a></li><li><a href=#332-环境区分配置>3.3.2 环境区分配置</a></li><li><a href=#333-feature-flags配置>3.3.3 Feature Flags配置</a></li></ul></li><li><a href=#34-性能考量与最佳实践>3.4 性能考量与最佳实践</a><ul><li><a href=#341-避免阻塞io>3.4.1 避免阻塞I/O</a></li><li><a href=#342-控制附加模型调用>3.4.2 控制附加模型调用</a></li><li><a href=#343-指标收集>3.4.3 指标收集</a></li></ul></li><li><a href=#本章小结-2>本章小结</a></li><li><a href=#本篇总结>本篇总结</a></li><li><a href=#思考与练习>思考与练习</a></li></ul></li><li><a href=#深入阅读-additional-resources>深入阅读 (Additional Resources)</a><ul><li><a href=#官方文档>官方文档</a></li><li><a href=#设计模式与最佳实践>设计模式与最佳实践</a></li><li><a href=#相关技术文章>相关技术文章</a></li><li><a href=#工具与库>工具与库</a></li><li><a href=#学习路径建议>学习路径建议</a></li><li><a href=#常见问题解答>常见问题解答</a></li><li><a href=#视频教程推荐>视频教程推荐</a></li><li><a href=#持续更新>持续更新</a></li></ul></li></ul></nav></div></aside></main></body></html>